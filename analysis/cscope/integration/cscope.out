cscope 15 $HOME/Development/3com-packet-driver/analysis/cscope/integration -q 0000001791 0000228117
	@/Users/jvindahl/Development/3com-packet-driver/include/cache_coherency.h

15 #iâdeà
CACHE_COHERENCY_H


16 
	#CACHE_COHERENCY_H


	)

18 
	~<¡dšt.h
>

19 
	~<¡dboŞ.h
>

20 
	~"ıu_d‘eù.h
"

23 
deviû_ÿps
 
	tdeviû_ÿps_t
;

27 
	mCACHE_TIER_1_CLFLUSH
 = 1,

28 
	mCACHE_TIER_2_WBINVD
 = 2,

29 
	mCACHE_TIER_3_SOFTWARE
 = 3,

30 
	mCACHE_TIER_4_FALLBACK
 = 4,

31 
	mTIER_DISABLE_BUS_MASTER
 = 0

32 } 
	tÿche_t›r_t
;

36 
	mBUS_MASTER_OK
,

37 
	mBUS_MASTER_PARTIAL
,

38 
	mBUS_MASTER_BROKEN


39 } 
	tbus_ma¡”_»suÉ_t
;

43 
	mCOHERENCY_OK
,

44 
	mCOHERENCY_PROBLEM
,

45 
	mCOHERENCY_UNKNOWN


46 } 
	tcoh”’cy_»suÉ_t
;

50 
	mSNOOPING_NONE
,

51 
	mSNOOPING_PARTIAL
,

52 
	mSNOOPING_FULL
,

53 
	mSNOOPING_UNKNOWN


54 } 
	t¢oİšg_»suÉ_t
;

58 
	mCACHE_DISABLED
,

59 
	mCACHE_WRITE_THROUGH
,

60 
	mCACHE_WRITE_BACK


61 } 
	tÿche_mode_t
;

66 
bus_ma¡”_»suÉ_t
 
	mbus_ma¡”
;

67 
coh”’cy_»suÉ_t
 
	mcoh”’cy
;

68 
¢oİšg_»suÉ_t
 
	m¢oİšg
;

71 
boŞ
 
	mÿche_’abËd
;

72 
boŞ
 
	mwr™e_back_ÿche
;

73 
ıu_šfo_t
 
	mıu
;

76 
ÿche_t›r_t
 
	m£Ëùed_t›r
;

77 
ušt8_t
 
	mcÚfid’û
;

78 
	mex¶ª©iÚ
[256];

79 } 
	tcoh”’cy_ª®ysis_t
;

83 
coh”’cy_ª®ysis_t
 
	mba£_ª®ysis
;

86 
boŞ
 
	mvds_avaabË
;

87 
boŞ
 
	mvds_»quœed_fÜ_deviû
;

88 
boŞ
 
	mvds_suµÜts_sÿ‰”_g©h”
;

89 
boŞ
 
	mvds_suµÜts_ÿche_coh”’cy
;

90 
ušt8_t
 
	mvds_v”siÚ_majÜ
;

91 
ušt8_t
 
	mvds_v”siÚ_mšÜ
;

94 
boŞ
 
	mruÂšg_š_v86_mode
;

95 
boŞ
 
	memm386_d‘eùed
;

96 
boŞ
 
	mqemm_d‘eùed
;

97 
boŞ
 
	mwšdows_’hªûd_mode
;

100 
ÿche_t›r_t
 
	mrx_ÿche_t›r
;

101 
ÿche_t›r_t
 
	mtx_ÿche_t›r
;

104 
boŞ
 
	m»quœes_¡agšg
;

105 
boŞ
 
	m´e_lock_rx_bufãrs
;

106 
ušt16_t
 
	m»comm’ded_rx_cİyb»ak
;

107 
ušt16_t
 
	m»comm’ded_tx_cİyb»ak
;

110 
ušt8_t
 
	mdma_»lŸb™y_scÜe
;

111 
ušt8_t
 
	mÿche_³rfÜmªû_scÜe
;

112 
	md‘aed_»comm’d©iÚ
[512];

113 } 
	t’hªûd_coh”’cy_ª®ysis_t
;

117 
	mPERFORMANCE_OPPORTUNITY_NONE
,

118 
	mPERFORMANCE_OPPORTUNITY_ENABLE_WB
,

119 
	mPERFORMANCE_OPPORTUNITY_OPTIMIZE_WB
,

120 
	mPERFORMANCE_OPPORTUNITY_OPTIMAL


121 } 
	t³rfÜmªû_İpÜtun™y_t
;

125 
	mCACHE_RECOMMENDATION_NONE
,

126 
	mCACHE_RECOMMENDATION_ENABLE_WB
,

127 
	mCACHE_RECOMMENDATION_OPTIMIZE_WB
,

128 
	mCACHE_RECOMMENDATION_CHECK_BIOS


129 } 
	tÿche_»comm’d©iÚ_t
;

134 
bus_ma¡”_»suÉ_t
 
‹¡_basic_bus_ma¡”
();

135 
coh”’cy_»suÉ_t
 
‹¡_ÿche_coh”’cy
();

136 
¢oİšg_»suÉ_t
 
‹¡_h¬dw¬e_¢oİšg
();

139 
coh”’cy_ª®ysis_t
 
³rfÜm_com¶‘e_coh”’cy_ª®ysis
();

142 
’hªûd_coh”’cy_ª®ysis_t
 
³rfÜm_’hªûd_coh”’cy_ª®ysis
(
deviû_ÿps_t
* 
deviû_ÿps
);

145 
boŞ
 
‹¡_vds_avaab™y
();

146 
¢oİšg_»suÉ_t
 
‹¡_vds_funùiÚ®™y
();

147 
boŞ
 
d‘eù_v86_’vœÚm’t
();

148 
boŞ
 
d‘eù_memÜy_mªag”_ty³
(* 
mªag”_Çme
, 
size_t
 
Çme_Ën
);

151 
boŞ
 
v®id©e_coh”’cy_‹¡_»suÉs
(cÚ¡ 
coh”’cy_ª®ysis_t
 *
ª®ysis
);

152 cÚ¡ * 
g‘_ÿche_t›r_desütiÚ
(
ÿche_t›r_t
 
t›r
);

153 
´št_d‘aed_coh”’cy_»suÉs
(cÚ¡ 
coh”’cy_ª®ysis_t
 *
ª®ysis
);

156 
ÿche_mode_t
 
d‘eù_ÿche_mode
();

157 
boŞ
 
is_ÿche_’abËd
();

160 
³rfÜmªû_İpÜtun™y_t
 
ª®yze_³rfÜmªû_İpÜtun™y
(cÚ¡ 
coh”’cy_ª®ysis_t
 *
coh”’cy
);

161 
ÿche_»comm’d©iÚ_t
 
g’”©e_ÿche_»comm’d©iÚ
(cÚ¡ 
coh”’cy_ª®ysis_t
 *
coh”’cy
,

162 
³rfÜmªû_İpÜtun™y_t
 
İpÜtun™y
);

165 cÚ¡ * 
g‘_bus_ma¡”_»suÉ_desütiÚ
(
bus_ma¡”_»suÉ_t
 
»suÉ
);

166 cÚ¡ * 
g‘_coh”’cy_»suÉ_desütiÚ
(
coh”’cy_»suÉ_t
 
»suÉ
);

167 cÚ¡ * 
g‘_¢oİšg_»suÉ_desütiÚ
(
¢oİšg_»suÉ_t
 
»suÉ
);

168 cÚ¡ * 
g‘_ÿche_mode_desütiÚ
(
ÿche_mode_t
 
mode
);

171 
	#COHERENCY_TEST_TIMEOUT_MS
 5000

	)

172 
	#COHERENCY_MIN_CONFIDENCE
 70

	)

173 
	#COHERENCY_HIGH_CONFIDENCE
 90

	)

176 
	#IS_COHERENCY_SAFE
(
ª®ysis
) \

177 ((
ª®ysis
)->
coh”’cy
 =ğ
COHERENCY_OK
 || \

178 (
ª®ysis
)->
£Ëùed_t›r
 !ğ
CACHE_TIER_4_FALLBACK
)

	)

180 
	#REQUIRES_CACHE_MANAGEMENT
(
ª®ysis
) \

181 ((
ª®ysis
)->
coh”’cy
 =ğ
COHERENCY_PROBLEM
)

	)

183 
	#HAS_HARDWARE_SNOOPING
(
ª®ysis
) \

184 ((
ª®ysis
)->
¢oİšg
 =ğ
SNOOPING_FULL
)

	)

	@/Users/jvindahl/Development/3com-packet-driver/include/dma.h

21 #iâdeà
_DMA_H_


22 
	#_DMA_H_


	)

24 #ifdeà
__ılu¥lus


28 
	~"commÚ.h
"

29 
	~"memÜy.h
"

30 
	~"xms_d‘eù.h
"

31 
	~"3c515.h
"

32 
	~"’hªûd_ršg_cÚ‹xt.h
"

35 
	#DMA_CAP_NONE
 0x0000

	)

36 
	#DMA_CAP_BASIC_BUSMASTER
 0x0001

	)

37 
	#DMA_CAP_SCATTER_GATHER
 0x0002

	)

38 
	#DMA_CAP_64BIT_ADDRESSING
 0x0004

	)

39 
	#DMA_CAP_COHERENT_MEMORY
 0x0008

	)

40 
	#DMA_CAP_STREAMING_MAPPING
 0x0010

	)

43 
	#DMA_DIRECTION_TO_DEVICE
 0x01

	)

44 
	#DMA_DIRECTION_FROM_DEVICE
 0x02

	)

45 
	#DMA_DIRECTION_BIDIRECTIONAL
 0x03

	)

49 
DMA_MEMORY_CONVENTIONAL
 = 0,

50 
DMA_MEMORY_XMS
,

51 
DMA_MEMORY_EMS
,

52 
DMA_MEMORY_LOCKED_CONVENTIONAL
,

53 
DMA_MEMORY_DEVICE_COHERENT


54 } 
	tdma_memÜy_ty³_t
;

57 
	sdma_äagm’t
 {

58 
ušt32_t
 
physiÿl_addr
;

59 
ušt32_t
 
Ëngth
;

60 
ušt32_t
 
æags
;

61 
dma_äagm’t
 *
Ãxt
;

62 } 
	tdma_äagm’t_t
;

65 
	#DMA_FRAG_FIRST
 0x0001

	)

66 
	#DMA_FRAG_LAST
 0x0002

	)

67 
	#DMA_FRAG_SINGLE
 0x0003

	)

68 
	#DMA_FRAG_COHERENT
 0x0004

	)

69 
	#DMA_FRAG_CACHED
 0x0008

	)

72 
	sdma_sg_li¡
 {

73 
dma_äagm’t_t
 *
äagm’ts
;

74 
ušt16_t
 
äagm’t_couÁ
;

75 
ušt16_t
 
max_äagm’ts
;

76 
ušt32_t
 
tÙ®_Ëngth
;

77 
ušt32_t
 
æags
;

78 *
´iv©e_d©a
;

79 } 
	tdma_sg_li¡_t
;

82 
	#DMA_SG_CONSOLIDATED
 0x0001

	)

83 
	#DMA_SG_MAPPED
 0x0002

	)

84 
	#DMA_SG_COHERENT
 0x0004

	)

85 
	#DMA_SG_ZERO_COPY
 0x0008

	)

88 
	sdma_m­pšg
 {

89 *
vœtu®_addr
;

90 
ušt32_t
 
physiÿl_addr
;

91 
ušt32_t
 
size
;

92 
dma_memÜy_ty³_t
 
memÜy_ty³
;

93 
ušt16_t
 
xms_hªdË
;

94 
ušt32_t
 
xms_off£t
;

95 
ušt32_t
 
æags
;

96 
ušt32_t
 
»f_couÁ
;

97 } 
	tdma_m­pšg_t
;

100 
	#DMA_MAP_COHERENT
 0x0001

	)

101 
	#DMA_MAP_STREAMING
 0x0002

	)

102 
	#DMA_MAP_LOCKED
 0x0004

	)

103 
	#DMA_MAP_XMS_LOCKED
 0x0008

	)

104 
	#DMA_MAP_CACHED
 0x0010

	)

107 
	sdma_bufãr_poŞ
 {

108 
ušt8_t
 *
ba£_addr
;

109 
ušt32_t
 
poŞ_size
;

110 
ušt32_t
 
bufãr_size
;

111 
ušt16_t
 
bufãr_couÁ
;

112 
ušt16_t
 
ä“_couÁ
;

113 
ušt32_t
 *
ä“_b™m­
;

114 
dma_m­pšg_t
 *
m­pšgs
;

115 
ušt32_t
 
®loÿtiÚ_æags
;

116 
dma_memÜy_ty³_t
 
memÜy_ty³
;

117 } 
	tdma_bufãr_poŞ_t
;

120 
	sdma_coh”’cy_mgr
 {

121 
boŞ
 
coh”’t_memÜy_avaabË
;

122 
boŞ
 
ÿche_coh”’t_dma
;

123 
ušt32_t
 
ÿche_lše_size
;

124 
ušt32_t
 
dma_®ignm’t
;

125 (*
sync_fÜ_ıu
)(*
addr
, 
ušt32_t
 
size
);

126 (*
sync_fÜ_deviû
)(*
addr
, 
ušt32_t
 
size
);

127 } 
	tdma_coh”’cy_mgr_t
;

130 
	sdma_nic_cÚ‹xt
 {

131 
ušt16_t
 
nic_ty³
;

132 
ušt32_t
 
dma_ÿ·b™›s
;

133 
ušt16_t
 
max_dma_add»ss
;

134 
ušt16_t
 
max_sg_äagm’ts
;

135 
ušt32_t
 
mš_®ignm’t
;

136 
ušt32_t
 
max_Œªsãr_size
;

139 (*
£tup_dma_Œªsãr
)(
dma_nic_cÚ‹xt
 *
ùx
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 
dœeùiÚ
);

140 (*
¡¬t_dma_Œªsãr
)(
dma_nic_cÚ‹xt
 *
ùx
);

141 (*
¡İ_dma_Œªsãr
)(
dma_nic_cÚ‹xt
 *
ùx
);

142 (*
g‘_dma_¡©us
)(
dma_nic_cÚ‹xt
 *
ùx
);

145 
dma_bufãr_poŞ_t
 
tx_poŞ
;

146 
dma_bufãr_poŞ_t
 
rx_poŞ
;

149 
ušt32_t
 
sg_cÚsŞid©iÚs
;

150 
ušt32_t
 
z”o_cİy_Œªsãrs
;

151 
ušt32_t
 
çÎback_Œªsãrs
;

152 
ušt32_t
 
dma_”rÜs
;

155 
ušt16_t
 
io_ba£
;

156 
’hªûd_ršg_cÚ‹xt_t
 *
ršg_cÚ‹xt
;

157 *
´iv©e_d©a
;

158 } 
	tdma_nic_cÚ‹xt_t
;

161 
	sdma_mªag”
 {

162 
boŞ
 
š™Ÿlized
;

163 
dma_coh”’cy_mgr_t
 
coh”’cy
;

166 
ušt32_t
 (*
vœt_to_phys
)(*
vœt_addr
);

167 * (*
phys_to_vœt
)(
ušt32_t
 
phys_addr
);

170 
boŞ
 
xms_avaabË
;

171 
ušt32_t
 
xms_dma_ba£
;

172 
ušt16_t
 
xms_dma_hªdË
;

175 
dma_bufãr_poŞ_t
 *
coh”’t_poŞ
;

176 
dma_bufãr_poŞ_t
 *
¡»amšg_poŞ
;

179 
dma_nic_cÚ‹xt_t
 
nic_cÚ‹xts
[
MAX_NICS
];

182 
ušt32_t
 
tÙ®_m­pšgs
;

183 
ušt32_t
 
aùive_m­pšgs
;

184 
ušt32_t
 
m­pšg_çu»s
;

185 
ušt32_t
 
coh”’cy_viŞ©iÚs
;

186 } 
	tdma_mªag”_t
;

189 
dma_mªag”_t
 
g_dma_mªag”
;

197 
dma_š™
();

202 
dma_ş—nup
();

212 
dma_š™_nic_cÚ‹xt
(
ušt8_t
 
nic_šdex
, 
ušt16_t
 
nic_ty³
, ušt16_ˆ
io_ba£
,

213 
’hªûd_ršg_cÚ‹xt_t
 *
ršg_cÚ‹xt
);

219 
dma_ş—nup_nic_cÚ‹xt
(
ušt8_t
 
nic_šdex
);

228 
ušt32_t
 
dma_vœt_to_phys
(*
vœt_addr
);

235 * 
dma_phys_to_vœt
(
ušt32_t
 
phys_addr
);

245 
dma_m­_memÜy
(*
vœt_addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
, 
dma_m­pšg_t
 *
m­pšg
);

251 
dma_unm­_memÜy
(
dma_m­pšg_t
 *
m­pšg
);

260 
dma_š™_xms_»giÚ
(
ušt32_t
 
size_kb
);

268 
dma_®loc_xms
(
ušt32_t
 
size
, 
dma_m­pšg_t
 *
m­pšg
);

274 
dma_ä“_xms
(
dma_m­pšg_t
 *
m­pšg
);

284 
dma_cİy_to_xms
(
dma_m­pšg_t
 *
xms_m­pšg
, 
ušt32_t
 
off£t
, cÚ¡ *
¤c_d©a
, ušt32_ˆ
size
);

294 
dma_cİy_äom_xms
(*
de¡_d©a
, 
dma_m­pšg_t
 *
xms_m­pšg
, 
ušt32_t
 
off£t
, ušt32_ˆ
size
);

303 
dma_sg_li¡_t
* 
dma_sg_®loc
(
ušt16_t
 
max_äagm’ts
);

309 
dma_sg_ä“
(
dma_sg_li¡_t
 *
sg_li¡
);

319 
dma_sg_add_äagm’t
(
dma_sg_li¡_t
 *
sg_li¡
, *
vœt_addr
, 
ušt32_t
 
Ëngth
, ušt32_ˆ
æags
);

328 
dma_sg_cÚsŞid©e
(
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 *
cÚsŞid©ed_bufãr
, 
ušt32_t
 
bufãr_size
);

337 
dma_sg_m­
(
ušt8_t
 
nic_šdex
, 
dma_sg_li¡_t
 *
sg_li¡
, ušt8_ˆ
dœeùiÚ
);

344 
dma_sg_unm­
(
ušt8_t
 
nic_šdex
, 
dma_sg_li¡_t
 *
sg_li¡
);

357 
dma_poŞ_š™
(
dma_bufãr_poŞ_t
 *
poŞ
, 
ušt16_t
 
bufãr_couÁ
, 
ušt32_t
 
bufãr_size
,

358 
dma_memÜy_ty³_t
 
memÜy_ty³
, 
ušt32_t
 
®ignm’t
);

364 
dma_poŞ_ş—nup
(
dma_bufãr_poŞ_t
 *
poŞ
);

372 
dma_poŞ_®loc
(
dma_bufãr_poŞ_t
 *
poŞ
, 
dma_m­pšg_t
 *
m­pšg
);

379 
dma_poŞ_ä“
(
dma_bufãr_poŞ_t
 *
poŞ
, 
dma_m­pšg_t
 *
m­pšg
);

390 
dma_3c515_£tup_Œªsãr
(
dma_nic_cÚ‹xt_t
 *
ùx
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 
dœeùiÚ
);

399 
dma_3c509b_çÎback_Œªsãr
(
dma_nic_cÚ‹xt_t
 *
ùx
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 
dœeùiÚ
);

408 
dma_g‘_Œªsãr_¡©us
(
ušt8_t
 
nic_šdex
, 
ušt32_t
 *
by‹s_Œªsã¼ed
, 
boŞ
 *
Œªsãr_com¶‘e
);

416 
dma_coh”’cy_š™
();

424 
dma_sync_fÜ_ıu
(*
addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
);

432 
dma_sync_fÜ_deviû
(*
addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
);

440 
boŞ
 
dma_is_coh”’t
(*
addr
, 
ušt32_t
 
size
);

453 
dma_g‘_¡©i¡ics
(
ušt8_t
 
nic_šdex
, 
ušt32_t
 *
sg_İs
, ušt32_ˆ*
cÚsŞid©iÚs
,

454 
ušt32_t
 *
z”o_cİy
, ušt32_ˆ*
”rÜs
);

460 
dma_»£t_¡©i¡ics
(
ušt8_t
 
nic_šdex
);

466 
dma_dump_¡©us
(
ušt8_t
 
nic_šdex
);

471 
	gDMA_ERROR_NONE
 = 0,

472 
	gDMA_ERROR_INVALID_PARAM
,

473 
	gDMA_ERROR_OUT_OF_MEMORY
,

474 
	gDMA_ERROR_MAPPING_FAILED
,

475 
	gDMA_ERROR_XMS_UNAVAILABLE
,

476 
	gDMA_ERROR_ALIGNMENT_ERROR
,

477 
	gDMA_ERROR_TRANSFER_TIMEOUT
,

478 
	gDMA_ERROR_HARDWARE_ERROR
,

479 
	gDMA_ERROR_COHERENCY_VIOLATION
,

480 
	gDMA_ERROR_FRAGMENT_TOO_LARGE
,

481 
	gDMA_ERROR_TOO_MANY_FRAGMENTS
,

482 
	gDMA_ERROR_UNSUPPORTED_OPERATION


483 } 
	tdma_”rÜ_t
;

490 
dma_”rÜ_t
 
dma_g‘_Ï¡_”rÜ
(
ušt8_t
 
nic_šdex
);

497 cÚ¡ * 
dma_”rÜ_to_¡ršg
(
dma_”rÜ_t
 
”rÜ
);

508 
dma_£nd_·ck‘_sg
(
ušt8_t
 
nic_šdex
, 
dma_äagm’t_t
 *
·ck‘_äagm’ts
, 
ušt16_t
 
äagm’t_couÁ
);

517 
dma_»ûive_·ck‘_sg
(
ušt8_t
 
nic_šdex
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt32_t
 
max_·ck‘_size
);

524 
dma_£lf_‹¡
(
ušt8_t
 
nic_šdex
);

529 
	#DMA_MAX_FRAGMENTS_3C515
 4

	)

530 
	#DMA_MAX_FRAGMENTS_3C509B
 1

	)

531 
	#DMA_MAX_TRANSFER_SIZE
 1600

	)

532 
	#DMA_MIN_ALIGNMENT
 4

	)

533 
	#DMA_ISA_ADDRESS_LIMIT
 0xFFFF

	)

536 
	#DMA_DEFAULT_TX_POOL_SIZE
 16

	)

537 
	#DMA_DEFAULT_RX_POOL_SIZE
 16

	)

538 
	#DMA_COHERENT_POOL_SIZE
 32

	)

541 
	#DMA_CONSOLIDATION_THRESHOLD
 256

	)

542 
	#DMA_ZERO_COPY_THRESHOLD
 512

	)

544 #ifdeà
__ılu¥lus


	@/Users/jvindahl/Development/3com-packet-driver/include/dma_safety.h

18 #iâdeà
DMA_SAFETY_H


19 
	#DMA_SAFETY_H


	)

21 
	~<¡dšt.h
>

22 
	~<¡dboŞ.h
>

24 #ifdeà
__ılu¥lus


30 
DMA_BUFFER_TYPE_TX
,

31 
DMA_BUFFER_TYPE_RX
,

32 
DMA_BUFFER_TYPE_DESCRIPTOR
,

33 
DMA_BUFFER_TYPE_GENERAL
,

34 
DMA_BUFFER_TYPE_COUNT


35 } 
	tdma_bufãr_ty³_t
;

39 
DMA_TO_DEVICE
 = 1,

40 
DMA_FROM_DEVICE
 = 2,

41 
DMA_BIDIRECTIONAL
 = 3

42 } 
	tdma_dœeùiÚ_t
;

46 
ušt8_t
 
dma_addr_b™s
;

47 
ušt16_t
 
max_sg_’Œ›s
;

48 
ušt16_t
 
sg_bound¬y
;

49 
ušt16_t
 
®ignm’t
;

50 
ušt16_t
 
desütÜ_®ignm’t
;

51 
boŞ
 
Ãeds_vds
;

52 
ušt16_t
 
rx_cİyb»ak
;

53 
ušt16_t
 
tx_cİyb»ak
;

54 
boŞ
 
ÿche_coh”’t
;

55 
boŞ
 
suµÜts_sg
;

57 
boŞ
 
no_64k_üoss
;

58 
ušt32_t
 
max_£gm’t_size
;

59 
deviû_Çme
[32];

60 } 
	tdeviû_ÿps_t
;

64 
ušt16_t
 
£gm’t_couÁ
;

66 * 
vœt_addr
;

67 
ušt32_t
 
phys_addr
;

68 
ušt16_t
 
Ëngth
;

69 } 
£gm’ts
[8];

70 
ušt32_t
 
tÙ®_Ëngth
;

71 
boŞ
 
Ãeds_bounû
;

72 } 
	tdma_sg_li¡_t
;

75 
dma_bufãr_desütÜ
 
	tdma_bufãr_desütÜ_t
;

78 
dma_§ãty_š™
();

79 
dma_§ãty_shutdown
();

80 
»gi¡”_3com_deviû_cÚ¡¿šts
();

83 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_bufãr
(
ušt32_t
 
size
, ušt32_ˆ
®ignm’t
,

84 
dma_bufãr_ty³_t
 
ty³
, cÚ¡ * 
deviû_Çme
);

85 
dma_ä“_bufãr
(
dma_bufãr_desütÜ_t
* 
desc
);

88 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_hybrid_bufãr
(
ušt32_t
 
size
, 
deviû_ÿps_t
* 
ÿps
,

89 
dma_dœeùiÚ_t
 
dœeùiÚ
,

90 cÚ¡ * 
deviû_Çme
);

93 
dma_sg_li¡_t
* 
dma_bud_§ã_sg
(* 
buf
, 
ušt32_t
 
Ën
, 
deviû_ÿps_t
* 
ÿps
);

94 
dma_ä“_sg_li¡
(
dma_sg_li¡_t
* 
sg_li¡
);

97 * 
dma_g‘_vœtu®_add»ss
(cÚ¡ 
dma_bufãr_desütÜ_t
* 
desc
);

98 
ušt32_t
 
dma_g‘_physiÿl_add»ss
(cÚ¡ 
dma_bufãr_desütÜ_t
* 
desc
);

99 
ušt32_t
 
dma_g‘_bufãr_size
(cÚ¡ 
dma_bufãr_desütÜ_t
* 
desc
);

100 
boŞ
 
dma_is_bounû_bufãr
(cÚ¡ 
dma_bufãr_desütÜ_t
* 
desc
);

103 
dma_sync_fÜ_deviû
(
dma_bufãr_desütÜ_t
* 
desc
, 
dma_dœeùiÚ_t
 
dœeùiÚ
);

104 
dma_sync_fÜ_ıu
(
dma_bufãr_desütÜ_t
* 
desc
, 
dma_dœeùiÚ_t
 
dœeùiÚ
);

107 
dma_sync_fÜ_deviû_Ëgacy
(
dma_bufãr_desütÜ_t
* 
desc
);

108 
dma_sync_fÜ_ıu_Ëgacy
(
dma_bufãr_desütÜ_t
* 
desc
);

111 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_tx_bufãr
(
ušt32_t
 
size
, cÚ¡ * 
deviû_Çme
);

112 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_rx_bufãr
(
ušt32_t
 
size
, cÚ¡ * 
deviû_Çme
);

113 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_desütÜ_ršg
(
ušt32_t
 
couÁ
, ušt32_ˆ
’Œy_size
, cÚ¡ * 
deviû_Çme
);

116 
boŞ
 
dma_v®id©e_add»ss_¿nge
(
ušt32_t
 
physiÿl_addr
, ušt32_ˆ
size
, cÚ¡ * 
deviû_Çme
);

117 
boŞ
 
dma_check_64kb_bound¬y
(
ušt32_t
 
physiÿl_addr
, ušt32_ˆ
size
);

118 
boŞ
 
dma_check_16mb_lim™
(
ušt32_t
 
physiÿl_addr
, ušt32_ˆ
size
);

119 
boŞ
 
dma_check_®ignm’t
(
ušt32_t
 
physiÿl_addr
, ušt32_ˆ
»quœed_®ignm’t
);

122 
dma_´št_¡©i¡ics
();

123 
dma_´št_bufãr_šfo
(cÚ¡ 
dma_bufãr_desütÜ_t
* 
desc
);

124 
ušt32_t
 
dma_g‘_bounû_bufãr_u§ge
();

125 
ušt32_t
 
dma_g‘_tÙ®_®loÿtiÚs
();

128 
dma_check_š‹gr™y
();

129 
dma_em”g’cy_»cov”y
();

130 
boŞ
 
dma_³riodic_v®id©iÚ
();

133 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_3c509b_bufãr
(
ušt32_t
 
size
, 
dma_bufãr_ty³_t
 
ty³
);

134 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_3c589_bufãr
(
ušt32_t
 
size
, 
dma_bufãr_ty³_t
 
ty³
);

135 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_3c905_bufãr
(
ušt32_t
 
size
, 
dma_bufãr_ty³_t
 
ty³
);

136 
dma_bufãr_desütÜ_t
* 
dma_®loÿ‹_3c515tx_bufãr
(
ušt32_t
 
size
, 
dma_bufãr_ty³_t
 
ty³
);

139 
	#DMA_MAX_ETHERNET_FRAME
 1518

	)

140 
	#DMA_DESCRIPTOR_ALIGNMENT
 16

	)

141 
	#DMA_BUFFER_ALIGNMENT
 8

	)

142 
	#DMA_ISA_LIMIT
 0x1000000

	)

145 
	#ERROR_DMA_64KB_BOUNDARY
 -1001

	)

146 
	#ERROR_DMA_16MB_LIMIT
 -1002

	)

147 
	#ERROR_DMA_ALIGNMENT
 -1003

	)

148 
	#ERROR_DMA_NOT_CONTIGUOUS
 -1004

	)

149 
	#ERROR_DMA_BOUNCE_FAILED
 -1005

	)

150 
	#ERROR_DMA_SYNC_FAILED
 -1006

	)

157 
šlše
 
boŞ
 
dma_is_š™Ÿlized
() {

158 
boŞ
 
g_dma_äamewÜk_š™Ÿlized
;

159  
	gg_dma_äamewÜk_š™Ÿlized
;

165 
šlše
 
ušt32_t
 
dma_g‘_»comm’ded_bufãr_size
(
dma_bufãr_ty³_t
 
ty³
) {

166 
	gty³
) {

167 
	gDMA_BUFFER_TYPE_TX
:

168 
DMA_BUFFER_TYPE_RX
:

169  
DMA_MAX_ETHERNET_FRAME
;

170 
	gDMA_BUFFER_TYPE_DESCRIPTOR
:

180 
šlše
 
ušt32_t
 
dma_g‘_»comm’ded_®ignm’t
(cÚ¡ * 
deviû_Çme
) {

181 ià(
¡r¡r
(
deviû_Çme
, "3C509") || strstr(device_name, "3C589")) {

191 
šlše
 
boŞ
 
dma_deviû_Ãeds_bounû_bufãrs
(cÚ¡ * 
deviû_Çme
) {

193  (
¡r¡r
(
deviû_Çme
, "3C509"è!ğ
NULL
) ||

194 (
¡r¡r
(
deviû_Çme
, "3C589"è!ğ
NULL
) ||

195 (
¡r¡r
(
deviû_Çme
, "3C515"è!ğ
NULL
);

203 
	#DMA_ALLOC_ETHERNET_FRAME
(
deviû
) \

204 
	`dma_®loÿ‹_bufãr
(
DMA_MAX_ETHERNET_FRAME
, \

205 
	`dma_g‘_»comm’ded_®ignm’t
(
deviû
), \

206 
DMA_BUFFER_TYPE_GENERAL
, 
deviû
)

	)

211 
	#DMA_ALLOC_DESCRIPTOR_RING
(
couÁ
, 
’Œy_size
, 
deviû
) \

212 
	`dma_®loÿ‹_bufãr
((
couÁ
è* (
’Œy_size
), \

213 
DMA_DESCRIPTOR_ALIGNMENT
, \

214 
DMA_BUFFER_TYPE_DESCRIPTOR
, 
deviû
)

	)

219 
	#DMA_SAFE_MEMCPY
(
desc
, 
off£t
, 
¤c
, 
size
) \

221 ià((
off£t
è+ (
size
è<ğ
	`dma_g‘_bufãr_size
(
desc
)) { \

222 
	`memıy
((*)
	`dma_g‘_vœtu®_add»ss
(
desc
è+ (
off£t
), (
¤c
), (
size
)); \

224 } 0)

	)

231 
	#DMA_VALIDATE_ISA_SAFE
(
physiÿl_addr
, 
size
) \

232 (
	`dma_check_64kb_bound¬y
(
physiÿl_addr
, 
size
) && \

233 
	`dma_check_16mb_lim™
(
physiÿl_addr
, 
size
))

	)

238 
	#DMA_VALIDATE_PCI_SAFE
(
physiÿl_addr
, 
size
) \

239 (
	`dma_check_®ignm’t
(
physiÿl_addr
, 16) && \

240 (
physiÿl_addr
 + 
size
è<ğ0xFFFFFFFF)

	)

245 
	#DMA_ENSURE_SYNC
(
desc
, 
fÜ_deviû
) \

247 ià(
	`dma_is_bounû_bufãr
(
desc
)) { \

248 ià(
fÜ_deviû
è
	`dma_sync_fÜ_deviû_Ëgacy
(
desc
); \

249 
	`dma_sync_fÜ_ıu_Ëgacy
(
desc
); \

251 } 0)

	)

254 
	#DMA_ENSURE_SYNC_DIRECTION
(
desc
, 
dœeùiÚ
, 
fÜ_deviû
) \

256 ià(
	`dma_is_bounû_bufãr
(
desc
)) { \

257 ià(
fÜ_deviû
è
	`dma_sync_fÜ_deviû
(
desc
, 
dœeùiÚ
); \

258 
	`dma_sync_fÜ_ıu
(
desc
, 
dœeùiÚ
); \

260 } 0)

	)

267 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c509b
;

268 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c515tx
;

269 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c589
;

270 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c590
;

271 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c595
;

272 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c900
;

273 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c905
;

274 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c905b
;

275 cÚ¡ 
deviû_ÿps_t
 
ÿps_3c905c
;

278 cÚ¡ 
deviû_ÿps_t
* 
dma_g‘_deviû_ÿps
(cÚ¡ * 
deviû_Çme
);

279 
dma_»gi¡”_deviû_ÿps
(cÚ¡ * 
deviû_Çme
, cÚ¡ 
deviû_ÿps_t
* 
ÿps
);

282 
boŞ
 
v®id©e_deviû_ÿps
(cÚ¡ 
deviû_ÿps_t
* 
ÿps
, cÚ¡ * 
deviû_Çme
);

283 
boŞ
 
v®id©e_®l_deviû_ÿps
();

285 #ifdeà
__ılu¥lus


	@/Users/jvindahl/Development/3com-packet-driver/include/handle_compact.h

11 #iâdeà
HANDLE_COMPACT_H


12 
	#HANDLE_COMPACT_H


	)

14 
	~<¡dšt.h
>

16 
	~"commÚ.h
"

19 
	#HANDLE_FLAG_ACTIVE
 0x01

	)

20 
	#HANDLE_FLAG_PROMISCUOUS
 0x02

	)

21 
	#HANDLE_FLAG_PRIORITY
 0x04

	)

22 
	#HANDLE_FLAG_XMS_BUFFER
 0x08

	)

23 
	#HANDLE_FLAG_MULTICAST
 0x10

	)

24 
	#HANDLE_FLAG_ERROR
 0x20

	)

25 
	#HANDLE_FLAG_SUSPENDED
 0x40

	)

26 
	#HANDLE_FLAG_RESERVED
 0x80

	)

29 
	#HANDLE_TYPE_MASK
 0xF0

	)

30 
	#HANDLE_TYPE_ETHERNET
 0x00

	)

31 
	#HANDLE_TYPE_IEEE8023
 0x10

	)

32 
	#HANDLE_TYPE_IEEE8025
 0x20

	)

33 
	#HANDLE_TYPE_ARCNET
 0x30

	)

36 
	#HANDLE_NIC_MASK
 0x0F

	)

37 
	#HANDLE_MAX_NICS
 16

	)

49 
ušt8_t
 
	mæags
;

50 
ušt8_t
 
	mš‹rçû
;

53 
ušt16_t
 
	m¡©s_šdex
;

56 (
FAR
 
CDECL
 *
	mÿÎback
)(
ušt8_t
 FAR *
	m·ck‘
, 
ušt16_t
 
	mËngth
);

60 
ušt32_t
 
	mcombšed_couÁ
;

62 
ušt16_t
 
	mrx_couÁ
;

63 
ušt16_t
 
	mtx_couÁ
;

64 } 
	mcouÁs
;

65 } 
	m·ck‘s
;

68 
FAR
 *
	mcÚ‹xt
;

70 } 
	thªdË_com·ù_t
;

73 
	thªdË_com·ù_size_check
[((
hªdË_com·ù_t
) == 16) ? 1 : -1];

82 
ušt32_t
 
	mrx_·ck‘s
;

83 
ušt32_t
 
	mtx_·ck‘s
;

84 
ušt32_t
 
	mrx_by‹s
;

85 
ušt32_t
 
	mtx_by‹s
;

86 
ušt32_t
 
	mrx_”rÜs
;

87 
ušt32_t
 
	mtx_”rÜs
;

88 
ušt32_t
 
	mrx_drİ³d
;

89 
ušt32_t
 
	mtx_drİ³d
;

90 
ušt32_t
 
	mmuÉiÿ¡
;

91 
ušt32_t
 
	mcŞlisiÚs
;

92 
ušt32_t
 
	mrx_Ëngth_”rÜs
;

93 
ušt32_t
 
	mrx_ov”_”rÜs
;

94 
ušt32_t
 
	mrx_üc_”rÜs
;

95 
ušt32_t
 
	mrx_äame_”rÜs
;

96 
ušt32_t
 
	mrx_fifo_”rÜs
;

97 
ušt32_t
 
	mrx_mis£d_”rÜs
;

98 
ušt32_t
 
	mtx_abÜ‹d_”rÜs
;

99 
ušt32_t
 
	mtx_ÿ¼›r_”rÜs
;

100 
ušt32_t
 
	mtx_fifo_”rÜs
;

101 
ušt32_t
 
	mtx_h—¹b—t_”rÜs
;

102 
ušt32_t
 
	mtx_wšdow_”rÜs
;

103 } 
	thªdË_¡©s_t
;

109 
hªdË_com·ù_t
 
	mhªdËs
[
MAX_HANDLES
];

110 
hªdË_¡©s_t
 *
	m¡©s_bË
;

111 
ušt16_t
 
	m¡©s_bË_size
;

112 
ušt16_t
 
	mÃxt_¡©s_šdex
;

113 
ušt32_t
 
	maùive_hªdËs
;

114 
ušt32_t
 
	mtÙ®_hªdËs_ü—‹d
;

115 
ušt32_t
 
	mmemÜy_§ved
;

116 } 
	thªdË_mªag”_t
;

119 
hªdË_com·ù_š™
();

120 
hªdË_com·ù_ş—nup
();

121 
hªdË_com·ù_t
* 
hªdË_com·ù_®loÿ‹
(
ušt8_t
 
nic_šdex
, ušt8_ˆ
ty³
);

122 
hªdË_com·ù_ä“
(
hªdË_com·ù_t
 *
hªdË
);

123 
hªdË_¡©s_t
* 
hªdË_com·ù_g‘_¡©s
(
hªdË_com·ù_t
 *
hªdË
);

124 
hªdË_com·ù_£t_ÿÎback
(
hªdË_com·ù_t
 *
hªdË
, (
FAR
 
CDECL
 *
ÿÎback
)(
ušt8_t
 FAR*, 
ušt16_t
));

125 
	`hªdË_com·ù_£t_æags
(
hªdË_com·ù_t
 *
hªdË
, 
ušt8_t
 
æags
);

126 
ušt8_t
 
	`hªdË_com·ù_g‘_nic_šdex
(
hªdË_com·ù_t
 *
hªdË
);

127 
ušt8_t
 
	`hªdË_com·ù_g‘_ty³
(
hªdË_com·ù_t
 *
hªdË
);

128 
	`hªdË_com·ù_is_aùive
(
hªdË_com·ù_t
 *
hªdË
);

129 
	`hªdË_com·ù_upd©e_couÁ”s
(
hªdË_com·ù_t
 *
hªdË
, 
is_rx
, 
ušt16_t
 
couÁ
);

130 
	`hªdË_com·ù_mig¿‹_äom_Ëgacy
(*
Ëgacy_hªdË
);

131 
	`hªdË_com·ù_dump_¡©s
();

134 
šlše
 
	$hªdË_is_aùive
(
hªdË_com·ù_t
 *
h
) {

135  (
h
->
æags
 & 
HANDLE_FLAG_ACTIVE
) != 0;

136 
	}
}

138 
šlše
 
	$hªdË_is_´omiscuous
(
hªdË_com·ù_t
 *
h
) {

139  (
h
->
æags
 & 
HANDLE_FLAG_PROMISCUOUS
) != 0;

140 
	}
}

142 
šlše
 
ušt8_t
 
	$hªdË_g‘_nic
(
hªdË_com·ù_t
 *
h
) {

143  
h
->
š‹rçû
 & 
HANDLE_NIC_MASK
;

144 
	}
}

146 
šlše
 
ušt8_t
 
	$hªdË_g‘_ty³
(
hªdË_com·ù_t
 *
h
) {

147  
h
->
š‹rçû
 & 
HANDLE_TYPE_MASK
;

148 
	}
}

150 
šlše
 
	$hªdË_šüem’t_rx
(
hªdË_com·ù_t
 *
h
) {

151 ià(
h
->
·ck‘s
.
couÁs
.
rx_couÁ
 < 0xFFFF) h->packets.counts.rx_count++;

152 
	}
}

154 
šlše
 
	$hªdË_šüem’t_tx
(
hªdË_com·ù_t
 *
h
) {

155 ià(
h
->
·ck‘s
.
couÁs
.
tx_couÁ
 < 0xFFFF) h->packets.counts.tx_count++;

156 
	}
}

158 #ifdeà
__ılu¥lus


	@/Users/jvindahl/Development/3com-packet-driver/include/multi_nic_coord.h

11 #iâdeà
MULTI_NIC_COORD_H


12 
	#MULTI_NIC_COORD_H


	)

14 
	~<¡dšt.h
>

16 
	~"commÚ.h
"

19 
	#MAX_MULTI_NICS
 8

	)

20 
	#MAX_NIC_GROUPS
 4

	)

21 
	#MAX_FLOWS
 1024

	)

24 
	#NIC_STATE_UNKNOWN
 0x00

	)

25 
	#NIC_STATE_DOWN
 0x01

	)

26 
	#NIC_STATE_UP
 0x02

	)

27 
	#NIC_STATE_ERROR
 0x03

	)

28 
	#NIC_STATE_TESTING
 0x04

	)

31 
	#NIC_ROLE_PRIMARY
 0x00

	)

32 
	#NIC_ROLE_STANDBY
 0x01

	)

33 
	#NIC_ROLE_ACTIVE
 0x02

	)

34 
	#NIC_ROLE_PASSIVE
 0x03

	)

37 
	#MULTI_NIC_MODE_ACTIVE_STANDBY
 0x00

	)

38 
	#MULTI_NIC_MODE_ACTIVE_ACTIVE
 0x01

	)

39 
	#MULTI_NIC_MODE_LOAD_BALANCE
 0x02

	)

40 
	#MULTI_NIC_MODE_LACP
 0x03

	)

43 
	#LB_ALGO_ROUND_ROBIN
 0x00

	)

44 
	#LB_ALGO_WEIGHTED
 0x01

	)

45 
	#LB_ALGO_LEAST_LOADED
 0x02

	)

46 
	#LB_ALGO_HASH_BASED
 0x03

	)

47 
	#LB_ALGO_ADAPTIVE
 0x04

	)

48 
	#LB_ALGO_COUNT
 5

	)

51 
	#MULTI_NIC_FLAG_ENABLED
 0x01

	)

52 
	#MULTI_NIC_FLAG_AUTO_FAILBACK
 0x02

	)

53 
	#MULTI_NIC_FLAG_HEALTH_CHECK
 0x04

	)

54 
	#MULTI_NIC_FLAG_FLOW_TRACKING
 0x08

	)

55 
	#MULTI_NIC_FLAG_STATS_ENABLED
 0x10

	)

58 
	#GROUP_TYPE_FAILOVER
 0x00

	)

59 
	#GROUP_TYPE_LOAD_BALANCE
 0x01

	)

60 
	#GROUP_TYPE_AGGREGATE
 0x02

	)

66 
ušt32_t
 
	m¥“d
;

67 
ušt16_t
 
	mmtu
;

68 
ušt16_t
 
	mmax_queue_size
;

69 
ušt8_t
 
	mdu¶ex
;

70 
ušt8_t
 
	mã©u»s
;

71 
ušt8_t
 
	mofæßd_ÿps
;

72 
ušt8_t
 
	m»£rved
;

73 } 
	tnic_ÿ·b™›s_t
;

79 
ušt32_t
 
	m·ck‘s_£Á
;

80 
ušt32_t
 
	m·ck‘s_»ûived
;

81 
ušt32_t
 
	mby‹s_£Á
;

82 
ušt32_t
 
	mby‹s_»ûived
;

83 
ušt32_t
 
	m”rÜs
;

84 
ušt32_t
 
	mdrİs
;

85 
ušt32_t
 
	m·ck‘s_queued
;

86 
ušt32_t
 
	mqueue_ov”æows
;

87 } 
	tnic_¡©s_t
;

93 
ušt8_t
 
	mnic_šdex
;

94 
ušt8_t
 
	m¡©e
;

95 
ušt8_t
 
	mrŞe
;

96 
ušt8_t
 
	m´iÜ™y
;

97 
ušt8_t
 
	mweight
;

98 
ušt8_t
 
	mcÚ£cutive_çu»s
;

99 
ušt16_t
 
	m»£rved
;

100 
ušt32_t
 
	mÏ¡_¡©e_chªge
;

101 
nic_ÿ·b™›s_t
 
	mÿ·b™›s
;

102 
nic_¡©s_t
 
	m¡©s
;

103 } 
	tnic_’Œy_t
;

109 
ušt32_t
 
	mæow_id
;

110 
ušt32_t
 
	mæow_hash
;

111 
ušt32_t
 
	m¤c_
;

112 
ušt32_t
 
	md¡_
;

113 
ušt16_t
 
	m¤c_pÜt
;

114 
ušt16_t
 
	md¡_pÜt
;

115 
ušt8_t
 
	m´ÙocŞ
;

116 
ušt8_t
 
	mnic_šdex
;

117 
ušt32_t
 
	mü—‹d
;

118 
ušt32_t
 
	mÏ¡_aùiv™y
;

119 
ušt32_t
 
	m·ck‘_couÁ
;

120 } 
	tæow_’Œy_t
;

126 
ušt8_t
 
	mgroup_id
;

127 
	mÇme
[16];

128 
ušt8_t
 
	mty³
;

129 
ušt8_t
 
	mmemb”_couÁ
;

130 
ušt8_t
 
	maùive_memb”s
;

131 
ušt8_t
 *
	mmemb”s
;

132 
ušt32_t
 
	mtÙ®_bªdwidth
;

133 } 
	tnic_group_t
;

139 
ušt8_t
 
	mmode
;

140 
ušt8_t
 
	mlßd_b®ªû_®go
;

141 
ušt8_t
 
	mçov”_th»shŞd
;

142 
ušt8_t
 
	mçback_d–ay
;

143 
ušt16_t
 
	mh—Éh_check_š‹rv®
;

144 
ušt16_t
 
	mæow_timeout
;

145 
ušt16_t
 
	mmax_æows
;

146 
ušt8_t
 
	mæags
;

147 } 
	tmuÉi_nic_cÚfig_t
;

153 
ušt32_t
 
	m·ck‘s_rou‹d
;

154 
ušt32_t
 
	mæow_h™s
;

155 
ušt32_t
 
	mæow_mis£s
;

156 
ušt32_t
 
	mçov”s
;

157 
ušt32_t
 
	mçbacks
;

158 
ušt32_t
 
	mroutšg_çu»s
;

159 
ušt32_t
 
	mh—Éh_checks
;

160 
ušt32_t
 
	m¡©e_chªges
;

161 } 
	tmuÉi_nic_¡©s_t
;

167 
ušt32_t
 
	m¤c_
;

168 
ušt32_t
 
	md¡_
;

169 
ušt16_t
 
	m¤c_pÜt
;

170 
ušt16_t
 
	md¡_pÜt
;

171 
ušt8_t
 
	m´ÙocŞ
;

172 
ušt8_t
 
	m´iÜ™y
;

173 
ušt16_t
 
	m·ck‘_size
;

174 
ušt8_t
 
	m£Ëùed_nic
;

175 } 
	t·ck‘_cÚ‹xt_t
;

181 
nic_’Œy_t
 
	mnics
[
MAX_MULTI_NICS
];

182 
nic_group_t
 
	mgroups
[
MAX_NIC_GROUPS
];

183 
æow_’Œy_t
 *
	mæow_bË
;

184 
muÉi_nic_cÚfig_t
 
	mcÚfig
;

185 
muÉi_nic_¡©s_t
 
	m¡©s
;

186 
ušt8_t
 
	mnic_couÁ
;

187 
ušt8_t
 
	maùive_nic_couÁ
;

188 
ušt8_t
 
	mgroup_couÁ
;

189 
ušt16_t
 
	mæow_couÁ
;

190 
ušt32_t
 
	mÏ¡_h—Éh_check
;

191 
ušt32_t
 
	mÃxt_æow_id
;

192 } 
	tmuÉi_nic_coÜdš©Ü_t
;

195 (*
	tlßd_b®ªû_func_t
)(
	t·ck‘_cÚ‹xt_t
 *
	tcÚ‹xt
, 
	tušt8_t
 *
	t£Ëùed_nic
);

196 (*
	tçov”_ÿÎback_t
)(
	tušt8_t
 
	tŞd_nic
, ušt8_ˆ
	tÃw_nic
);

199 
	`muÉi_nic_š™
();

200 
	`muÉi_nic_ş—nup
();

201 
	`muÉi_nic_cÚfigu»
(cÚ¡ 
muÉi_nic_cÚfig_t
 *
cÚfig
);

204 
	`muÉi_nic_»gi¡”
(
ušt8_t
 
nic_šdex
, cÚ¡ 
nic_ÿ·b™›s_t
 *
ÿps
);

205 
	`muÉi_nic_uÄegi¡”
(
ušt8_t
 
nic_šdex
);

206 
	`muÉi_nic_upd©e_¡©e
(
ušt8_t
 
nic_šdex
, ušt8_ˆ
Ãw_¡©e
);

207 
	`muÉi_nic_£t_´iÜ™y
(
ušt8_t
 
nic_šdex
, ušt8_ˆ
´iÜ™y
);

208 
	`muÉi_nic_£t_weight
(
ušt8_t
 
nic_šdex
, ušt8_ˆ
weight
);

211 
	`muÉi_nic_£Ëù_tx
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

212 
	`muÉi_nic_rou‹_·ck‘
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
, ušt8_ˆ*
£Ëùed_nic
);

215 
	`muÉi_nic_hªdË_çu»
(
ušt8_t
 
çed_nic
);

216 
	`muÉi_nic_š™Ÿ‹_çback
(
ušt8_t
 
´im¬y_nic
);

217 
	`muÉi_nic_»gi¡”_çov”_ÿÎback
(
çov”_ÿÎback_t
 
ÿÎback
);

220 
	`muÉi_nic_h—Éh_check
();

221 
	`muÉi_nic_g‘_nic_h—Éh
(
ušt8_t
 
nic_šdex
, 
boŞ
 *
h—Éhy
);

222 
	`muÉi_nic_£t_h—Éh_·¿ms
(
ušt8_t
 
th»shŞd
, 
ušt16_t
 
š‹rv®
);

225 
	`muÉi_nic_ü—‹_group
(
ušt8_t
 
group_id
, cÚ¡ *
Çme
, ušt8_ˆ
ty³
);

226 
	`muÉi_nic_d–‘e_group
(
ušt8_t
 
group_id
);

227 
	`muÉi_nic_add_to_group
(
ušt8_t
 
group_id
, ušt8_ˆ
nic_šdex
);

228 
	`muÉi_nic_»move_äom_group
(
ušt8_t
 
group_id
, ušt8_ˆ
nic_šdex
);

231 
	`muÉi_nic_Œack_æow
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
);

232 
	`muÉi_nic_expœe_æows
();

233 
	`muÉi_nic_g‘_æow_¡©s
(
ušt32_t
 
æow_id
, 
æow_’Œy_t
 *
æow
);

236 
	`muÉi_nic_g‘_¡©s
(
muÉi_nic_¡©s_t
 *
¡©s
);

237 
	`muÉi_nic_»£t_¡©s
();

238 
	`muÉi_nic_g‘_nic_¡©s
(
ušt8_t
 
nic_šdex
, 
nic_¡©s_t
 *
¡©s
);

239 
	`muÉi_nic_dump_¡©us
();

242 
	`muÉi_nic_£t_mode
(
ušt8_t
 
mode
);

243 
	`muÉi_nic_£t_lßd_b®ªû_®go
(
ušt8_t
 
®go
);

244 
	`muÉi_nic_’abË_ã©u»
(
ušt8_t
 
ã©u»
);

245 
	`muÉi_nic_di§bË_ã©u»
(
ušt8_t
 
ã©u»
);

248 
nic_’Œy_t
* 
	`muÉi_nic_fšd_’Œy
(
ušt8_t
 
nic_šdex
);

249 
æow_’Œy_t
* 
	`muÉi_nic_fšd_æow
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
);

250 
	`muÉi_nic_ü—‹_æow
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 
nic_šdex
);

251 
	`muÉi_nic_mig¿‹_æows
(
ušt8_t
 
äom_nic
, ušt8_ˆ
to_nic
);

252 
	`muÉi_nic_ş—nup_æows
();

253 
boŞ
 
	`muÉi_nic_check_nic_h—Éh
(
nic_’Œy_t
 *
nic
);

254 
	`muÉi_nic_£Ëù_aùive_¡ªdby
(
ušt8_t
 *
£Ëùed_nic
);

255 
	`muÉi_nic_£Ëù_aùive_aùive
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

256 
	`muÉi_nic_£Ëù_lßd_b®ªû
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

257 
	`muÉi_nic_£Ëù_Ïı
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

258 
	`muÉi_nic_scheduË_çback
(
ušt8_t
 
nic_šdex
);

259 
ušt32_t
 
	`muÉi_nic_hash_æow
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
);

260 cÚ¡ * 
	`muÉi_nic_¡©e_Çme
(
ušt8_t
 
¡©e
);

261 cÚ¡ * 
	`muÉi_nic_rŞe_Çme
(
ušt8_t
 
rŞe
);

264 
ušt32_t
 
	`g‘_sy¡em_time
();

265 
	`log_£t_Ëv–
(
ušt8_t
 
Ëv–
);

	@/Users/jvindahl/Development/3com-packet-driver/include/runtime_config.h

11 #iâdeà
RUNTIME_CONFIG_H


12 
	#RUNTIME_CONFIG_H


	)

14 
	~<¡dšt.h
>

15 
	~<¡dboŞ.h
>

16 
	~"commÚ.h
"

19 
	#CONFIG_CAT_GENERAL
 0x00

	)

20 
	#CONFIG_CAT_MEMORY
 0x01

	)

21 
	#CONFIG_CAT_NETWORK
 0x02

	)

22 
	#CONFIG_CAT_PERFORMANCE
 0x03

	)

23 
	#CONFIG_CAT_ROUTING
 0x04

	)

24 
	#CONFIG_CAT_LOGGING
 0x05

	)

25 
	#CONFIG_CAT_DIAGNOSTICS
 0x06

	)

26 
	#CONFIG_CAT_COUNT
 7

	)

29 
	#CONFIG_PARAM_LOG_LEVEL
 0x0100

	)

30 
	#CONFIG_PARAM_LOG_DESTINATION
 0x0101

	)

31 
	#CONFIG_PARAM_BUFFER_SIZE
 0x0200

	)

32 
	#CONFIG_PARAM_BUFFER_COUNT
 0x0201

	)

33 
	#CONFIG_PARAM_XMS_ENABLE
 0x0202

	)

34 
	#CONFIG_PARAM_XMS_THRESHOLD
 0x0203

	)

35 
	#CONFIG_PARAM_PROMISCUOUS
 0x0300

	)

36 
	#CONFIG_PARAM_MULTICAST
 0x0301

	)

37 
	#CONFIG_PARAM_MTU
 0x0302

	)

38 
	#CONFIG_PARAM_IRQ_COALESCE
 0x0400

	)

39 
	#CONFIG_PARAM_TX_QUEUE_SIZE
 0x0401

	)

40 
	#CONFIG_PARAM_RX_QUEUE_SIZE
 0x0402

	)

41 
	#CONFIG_PARAM_ROUTING_MODE
 0x0500

	)

42 
	#CONFIG_PARAM_DEFAULT_ROUTE
 0x0501

	)

43 
	#CONFIG_PARAM_STATS_INTERVAL
 0x0600

	)

44 
	#CONFIG_PARAM_DIAG_MODE
 0x0601

	)

47 
	#CONFIG_TYPE_BOOL
 0x01

	)

48 
	#CONFIG_TYPE_UINT8
 0x02

	)

49 
	#CONFIG_TYPE_UINT16
 0x03

	)

50 
	#CONFIG_TYPE_UINT32
 0x04

	)

51 
	#CONFIG_TYPE_STRING
 0x05

	)

54 
	#CONFIG_FLAG_DYNAMIC
 0x01

	)

55 
	#CONFIG_FLAG_REQUIRES_RESET
 0x02

	)

56 
	#CONFIG_FLAG_PER_NIC
 0x04

	)

57 
	#CONFIG_FLAG_READONLY
 0x08

	)

58 
	#CONFIG_FLAG_ADVANCED
 0x10

	)

59 
	#CONFIG_FLAG_INITIALIZED
 0x20

	)

62 
	#CONFIG_EXPORT_MAGIC
 0x43464758

	)

63 
	#CONFIG_EXPORT_VERSION
 1

	)

69 
ušt16_t
 
	m·¿m_id
;

70 
ušt8_t
 
	mty³
;

71 
ušt8_t
 
	mÿ‹gÜy
;

72 cÚ¡ *
	mÇme
;

73 cÚ¡ *
	mdesütiÚ
;

74 
ušt32_t
 
	mmš_v®ue
;

75 
ušt32_t
 
	mmax_v®ue
;

76 
ušt32_t
 
	mdeçuÉ_v®ue
;

77 
ušt8_t
 
	mæags
;

78 } 
	tcÚfig_·¿m_def_t
;

84 
ušt16_t
 
	m·¿m_id
;

85 
ušt32_t
 
	mcu¼’t_v®ue
;

86 
ušt32_t
 
	m³ndšg_v®ue
;

87 
	mhas_³ndšg
;

88 
ušt8_t
 
	mnic_šdex
;

89 } 
	tcÚfig_·¿m_v®ue_t
;

94 (*
	tcÚfig_ÿÎback_func_t
)(
	tušt16_t
 
	t·¿m_id
,

95 
	tušt32_t
 
	tŞd_v®ue
,

96 
	tušt32_t
 
	tÃw_v®ue
,

97 
	tušt8_t
 
	tnic_šdex
,

98 *
	tcÚ‹xt
);

103 
	scÚfig_ÿÎback_s
 {

104 
cÚfig_ÿÎback_func_t
 
ÿÎback
;

105 
ušt16_t
 
·¿m_id
;

106 *
cÚ‹xt
;

107 
cÚfig_ÿÎback_s
 *
Ãxt
;

108 } 
	tcÚfig_ÿÎback_t
;

114 
ušt32_t
 
magic
;

115 
ušt16_t
 
v”siÚ
;

116 
ušt16_t
 
·¿m_couÁ
;

117 
ušt16_t
 
checksum
;

118 
ušt16_t
 
»£rved
;

119 } 
	tcÚfig_expÜt_t
;

125 
ušt16_t
 
·¿m_id
;

126 
ušt32_t
 
v®ue
;

127 
ušt8_t
 
nic_šdex
;

128 
ušt8_t
 
»£rved
;

129 } 
	tcÚfig_·¿m_expÜt_t
;

135 
ušt32_t
 
tÙ®_chªges
;

136 
ušt32_t
 
immedŸ‹_chªges
;

137 
ušt32_t
 
»£t_­¶›d_chªges
;

138 
ušt32_t
 
çed_chªges
;

139 
ušt32_t
 
expÜts
;

140 
ušt32_t
 
impÜts
;

141 } 
	tcÚfig_¡©s_t
;

147 
cÚfig_·¿m_v®ue_t
 *
·¿m_v®ues
;

148 
ušt16_t
 
·¿m_couÁ
;

149 
ušt16_t
 
³ndšg_chªges
;

150 
cÚfig_ÿÎback_t
 *
ÿÎbacks
;

151 
cÚfig_¡©s_t
 
¡©s
;

152 
ušt8_t
 
æags
;

153 } 
	truÁime_cÚfig_mªag”_t
;

156 
	`ruÁime_cÚfig_š™
();

157 
	`ruÁime_cÚfig_ş—nup
();

160 
	`ruÁime_cÚfig_£t_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 
v®ue
, 
ušt8_t
 
nic_šdex
);

161 
	`ruÁime_cÚfig_g‘_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 *
v®ue
, 
ušt8_t
 
nic_šdex
);

162 
	`ruÁime_cÚfig_»£t_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt8_t
 
nic_šdex
);

163 
	`ruÁime_cÚfig_­¶y_³ndšg
();

166 
	`ruÁime_cÚfig_»gi¡”_ÿÎback
(
cÚfig_ÿÎback_func_t
 
ÿÎback
,

167 
ušt16_t
 
·¿m_id
,

168 *
cÚ‹xt
);

169 
	`ruÁime_cÚfig_uÄegi¡”_ÿÎback
(
cÚfig_ÿÎback_func_t
 
ÿÎback
);

172 
	`ruÁime_cÚfig_expÜt
(*
bufãr
, 
ušt16_t
 *
size
);

173 
	`ruÁime_cÚfig_impÜt
(cÚ¡ *
bufãr
, 
ušt16_t
 
size
);

174 
	`ruÁime_cÚfig_§ve_to_fe
(cÚ¡ *
f’ame
);

175 
	`ruÁime_cÚfig_lßd_äom_fe
(cÚ¡ *
f’ame
);

178 
	`ruÁime_cÚfig_£t_deçuÉs
();

179 
	`ruÁime_cÚfig_dump
();

180 cÚ¡ 
cÚfig_·¿m_def_t
* 
	`ruÁime_cÚfig_g‘_·¿m_šfo
(
ušt16_t
 
·¿m_id
);

181 
	`ruÁime_cÚfig_v®id©e_v®ue
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 
v®ue
);

184 cÚ¡ 
cÚfig_·¿m_def_t
* 
	`ruÁime_cÚfig_g‘_defš™iÚ
(
ušt16_t
 
·¿m_id
);

185 
cÚfig_·¿m_v®ue_t
* 
	`ruÁime_cÚfig_fšd_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt8_t
 
nic_šdex
);

186 
	`ruÁime_cÚfig_­¶y_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 
v®ue
, 
ušt8_t
 
nic_šdex
);

187 
	`ruÁime_cÚfig_nÙify_ÿÎbacks
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 
Şd_v®ue
,

188 
ušt32_t
 
Ãw_v®ue
, 
ušt8_t
 
nic_šdex
);

189 
ušt16_t
 
	`ruÁime_cÚfig_ÿlcuÏ‹_checksum
(cÚ¡ *
d©a
, ušt16_ˆ
size
);

192 
šlše
 
boŞ
 
	$ruÁime_cÚfig_is_dyÇmic
(
ušt16_t
 
·¿m_id
) {

193 cÚ¡ 
cÚfig_·¿m_def_t
 *
def
 = 
	`ruÁime_cÚfig_g‘_·¿m_šfo
(
·¿m_id
);

194  
def
 && (def->
æags
 & 
CONFIG_FLAG_DYNAMIC
);

195 
	}
}

197 
šlše
 
	$ruÁime_cÚfig_has_³ndšg
() {

198 
ruÁime_cÚfig_mªag”_t
 
g_cÚfig_mªag”
;

199  
g_cÚfig_mªag”
.
³ndšg_chªges
 > 0;

200 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/include/xms_buffer_migration.h

11 #iâdeà
XMS_BUFFER_MIGRATION_H


12 
	#XMS_BUFFER_MIGRATION_H


	)

14 
	~<¡dšt.h
>

16 
	~"commÚ.h
"

17 
	~"xms.h
"

20 
	#XMS_MIGRATION_CACHE_SIZE
 4096

	)

21 
	#XMS_MIGRATION_PACKET_SIZE
 1518

	)

22 
	#XMS_MIGRATION_CACHE_SLOTS
 2

	)

23 
	#XMS_MIGRATION_THRESHOLD
 8192

	)

24 
	#XMS_MIGRATION_BATCH_SIZE
 16

	)

27 
	#XMS_MIG_FLAG_ENABLED
 0x01

	)

28 
	#XMS_MIG_FLAG_ACTIVE
 0x02

	)

29 
	#XMS_MIG_FLAG_CACHE_FULL
 0x04

	)

30 
	#XMS_MIG_FLAG_XMS_AVAILABLE
 0x08

	)

31 
	#XMS_MIG_FLAG_ERROR
 0x10

	)

32 
	#XMS_MIG_FLAG_SUSPENDED
 0x20

	)

35 
	#XMS_BUFFER_STATE_FREE
 0x00

	)

36 
	#XMS_BUFFER_STATE_CONV
 0x01

	)

37 
	#XMS_BUFFER_STATE_XMS
 0x02

	)

38 
	#XMS_BUFFER_STATE_MIGRATING
 0x03

	)

39 
	#XMS_BUFFER_STATE_CACHED
 0x04

	)

45 
ušt32_t
 
	mxms_add»ss
;

46 
ušt16_t
 
	mcÚv_£gm’t
;

47 
ušt16_t
 
	mcÚv_off£t
;

48 
ušt16_t
 
	mbufãr_size
;

49 
ušt8_t
 
	m¡©e
;

50 
ušt8_t
 
	mæags
;

51 
ušt32_t
 
	macûss_couÁ
;

52 
ušt32_t
 
	mÏ¡_acûss
;

53 
ušt16_t
 
	m·ck‘_Ëngth
;

54 
ušt16_t
 
	m»£rved
;

55 } 
	txms_bufãr_t
;

61 
ušt8_t
 *
	md©a
;

62 
ušt16_t
 
	mbufãr_šdex
;

63 
ušt32_t
 
	mÏ¡_acûss
;

64 
boŞ
 
	mš_u£
;

65 } 
	tÿche_¦Ù_t
;

71 
ušt32_t
 
	mtÙ®_mig¿tiÚs
;

72 
ušt32_t
 
	mÿche_h™s
;

73 
ušt32_t
 
	mÿche_mis£s
;

74 
ušt32_t
 
	mxms_Œªsãrs
;

75 
ušt32_t
 
	mçed_mig¿tiÚs
;

76 
ušt32_t
 
	mby‹s_mig¿‹d
;

77 
ušt32_t
 
	mby‹s_ÿched
;

78 
ušt32_t
 
	meviùiÚs
;

79 
ušt32_t
 
	m³ak_xms_u§ge
;

80 
ušt32_t
 
	mcu¼’t_xms_u§ge
;

81 } 
	txms_mig¿tiÚ_¡©s_t
;

88 
ušt16_t
 
	mxms_hªdË
;

89 
ušt32_t
 
	mxms_size
;

90 
ušt32_t
 
	mxms_ä“_off£t
;

93 
xms_bufãr_t
 *
	mbufãrs
;

94 
ušt16_t
 
	mbufãr_couÁ
;

95 
ušt16_t
 
	mbufãrs_š_xms
;

96 
ušt16_t
 
	mbufãrs_š_cÚv
;

99 
ÿche_¦Ù_t
 
	mÿche
[
XMS_MIGRATION_CACHE_SLOTS
];

100 
ušt8_t
 
	mÿche_d©a
[
XMS_MIGRATION_CACHE_SIZE
];

101 
ušt32_t
 
	mÿche_acûss_couÁ”
;

104 
ušt32_t
 
	mmig¿tiÚ_th»shŞd
;

105 
ušt16_t
 
	mb©ch_size
;

106 
ušt8_t
 
	mæags
;

107 
ušt8_t
 
	m»£rved
;

110 
xms_mig¿tiÚ_¡©s_t
 
	m¡©s
;

113 (*
	mxms_cİy
)(
ušt32_t
 
	m¤c
, ušt32_ˆ
	md¡
, ušt32_ˆ
	msize
);

114 (*
	mnÙify_ÿÎback
)(
ušt16_t
 
	mbufãr_šdex
, 
ušt8_t
 
	mÃw_¡©e
);

116 } 
	txms_mig¿tiÚ_mªag”_t
;

119 
xms_mig¿tiÚ_š™
(
ušt32_t
 
xms_size
, ušt32_ˆ
th»shŞd
);

120 
xms_mig¿tiÚ_ş—nup
();

121 
xms_mig¿tiÚ_’abË
();

122 
xms_mig¿tiÚ_di§bË
();

125 
xms_mig¿tiÚ_®loÿ‹_bufãr
(
ušt16_t
 
size
, ušt16_ˆ*
bufãr_šdex
);

126 
xms_mig¿tiÚ_ä“_bufãr
(
ušt16_t
 
bufãr_šdex
);

127 
xms_mig¿tiÚ_mig¿‹_bufãr
(
ušt16_t
 
bufãr_šdex
);

128 
xms_mig¿tiÚ_mig¿‹_b©ch
();

131 * 
xms_mig¿tiÚ_g‘_bufãr
(
ušt16_t
 
bufãr_šdex
);

132 
xms_mig¿tiÚ_ÿche_bufãr
(
ušt16_t
 
bufãr_šdex
);

133 
xms_mig¿tiÚ_eviù_Ìu
();

134 
xms_mig¿tiÚ_upd©e_Ìu
(
ušt16_t
 
bufãr_šdex
);

137 
xms_mig¿tiÚ_»ad_·ck‘
(
ušt16_t
 
bufãr_šdex
, *
de¡
, ušt16_ˆ
Ëngth
);

138 
xms_mig¿tiÚ_wr™e_·ck‘
(
ušt16_t
 
bufãr_šdex
, cÚ¡ *
¤c
, ušt16_ˆ
Ëngth
);

139 
xms_mig¿tiÚ_cİy_·ck‘
(
ušt16_t
 
¤c_šdex
, ušt16_ˆ
d¡_šdex
);

142 
xms_mig¿tiÚ_g‘_¡©s
(
xms_mig¿tiÚ_¡©s_t
 *
¡©s
);

143 
xms_mig¿tiÚ_»£t_¡©s
();

144 
xms_mig¿tiÚ_dump_¡©s
();

147 
xms_mig¿tiÚ_£t_th»shŞd
(
ušt32_t
 
th»shŞd
);

148 
xms_mig¿tiÚ_£t_b©ch_size
(
ušt16_t
 
b©ch_size
);

149 
xms_mig¿tiÚ_£t_ÿÎback
((*
ÿÎback
)(
ušt16_t
, 
ušt8_t
));

152 
	`xms_mig¿tiÚ_is_’abËd
();

153 
	`xms_mig¿tiÚ_is_bufãr_š_xms
(
ušt16_t
 
bufãr_šdex
);

154 
ušt32_t
 
	`xms_mig¿tiÚ_g‘_ä“_xms
();

155 
ušt16_t
 
	`xms_mig¿tiÚ_g‘_bufãr_couÁ
();

158 
šlše
 
	$xms_mig¿tiÚ_should_mig¿‹
(
ušt32_t
 
cÚv_u§ge
) {

159 
xms_mig¿tiÚ_mªag”_t
 
g_xms_mªag”
;

160  (
cÚv_u§ge
 >ğ
g_xms_mªag”
.
mig¿tiÚ_th»shŞd
) &&

161 (
g_xms_mªag”
.
æags
 & 
XMS_MIG_FLAG_ENABLED
) &&

162 (
g_xms_mªag”
.
æags
 & 
XMS_MIG_FLAG_XMS_AVAILABLE
);

163 
	}
}

165 
šlše
 
	$xms_mig¿tiÚ_is_ÿched
(
ušt16_t
 
bufãr_šdex
) {

166 
xms_mig¿tiÚ_mªag”_t
 
g_xms_mªag”
;

167 
i
 = 0; i < 
XMS_MIGRATION_CACHE_SLOTS
; i++) {

168 ià(
g_xms_mªag”
.
ÿche
[
i
].
š_u£
 &&

169 
g_xms_mªag”
.
ÿche
[
i
].
bufãr_šdex
 == buffer_index) {

174 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/asm/cache_ops.asm

1 ; 3C
om
 
Pack‘
 
	gDriv”
 - 
Cache
 
O³¿tiÚs
 
As£mbly
 
	gModuË


3 ; 
This
 
moduË
 
´ovides
 
	glow
-
Ëv–
 
ÿche
 
mªagem’t
 
İ”©iÚs
 
	gthe
 4-
	gt›r


4 ; 
ÿche
 
coh”’cy
 
	gsy¡em
. 
It
 
šşudes
 
	gCPU
-
¥ecific
 cach
š¡ruùiÚs
 
	gªd


5 ; 
acûss
 
	gfunùiÚs
.

7 ; 
This
 
fe
 
is
 
·¹
 
of
 
	gthe
 3C
om
 
Pack‘
 
Driv”
 
	g´ojeù
.

9 .
mod–
 
	gsm®l


12 .
code


14 
public
 
ÿche_şæush_lše


15 
public
 
ÿche_şæush_§ã


16 
public
 
ÿche_wbšvd


17 
public
 
ÿche_wbšvd_§ã


18 
public
 
ÿche_švd


19 
public
 
»ad_ü0_»gi¡”


20 
public
 
wr™e_ü0_»gi¡”


21 
public
 
memÜy_ãnû


22 
public
 
memÜy_ãnû_aá”_şæush


23 
public
 
¡Üe_ãnû


24 
public
 
lßd_ãnû


25 
public
 
d‘eù_ÿche_mode


26 
public
 
	gg‘_cu¼’t_time¡amp


29 ; 
	gÿche_şæush_lše
 - 
Flush
 
¥ecific
 
ÿche
 
lše
 (
P’tium
 4+)

31 ; 
	gIÅut
: 
Sck
 
·¿m‘”
 - 
add»ss
 
to
 
æush


32 ; 
	gOuut
: 
NÚe


33 ; 
	gRegi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


34 ; 
	gNÙe
: 
C®Ër
 
mu¡
 
’su»
 
CLFLUSH
 
is
 
suµÜ‹d


36 
ÿche_şæush_lše
 
´oc


37 
push
 
bp


38 
mov
 
	gbp
, 
¥


39 
push
 
	g—x


41 ; 
G‘
 
add»ss
 
·¿m‘”
 (
çr
 
poš‹r
 
š
 16-
b™
 
mode
)

42 
mov
 
	g—x
, [
bp
+4]

44 ; 
Execu‹
 
CLFLUSH
 
š¡ruùiÚ
 
the
 
	gadd»ss


45 ; 
Prİ”
 
	g’codšg
: 
CLFLUSH
 [
—x
]

46 
db
 0x0F, 0xAE

47 
	gdb
 0x38 ; 
	gModR
/
M
 
by‹
 [
—x
]

49 
pİ
 
—x


50 
pİ
 
bp


51 
»t


52 
ÿche_şæush_lše
 
	g’dp


55 ; 
	gÿche_şæush_bufãr
 - 
Flush
 
’tœe
 
bufãr
 
by
 
ÿche
 
	glšes


57 ; 
	gIÅut
: 
Sck
 
·¿m‘”s
 - 
bufãr
 
add»ss
 (
off£t
 4), 
size
 (offset 8)

58 ; 
	gOuut
: 
AX
 = 0 
sucûssful
, 1 
CLFLUSH
 
nÙ
 
	gavaabË


59 ; 
	gRegi¡”s
: 
Modif›s
 
AX


61 
ÿche_şæush_bufãr
 
´oc


62 
push
 
bp


63 
mov
 
	gbp
, 
¥


64 
push
 
ebx


65 
push
 
ecx


66 
push
 
edx


67 
push
 
	gesi


69 ; 
Check
 
CLFLUSH
 
is
 
	$suµÜ‹d
 (
äom
 
ÿched
 
æag
)

70 
ıuid_avaabË
:
by‹


71 
ıu_ã©u»s
:
dwÜd


73 
cmp
 
by‹
 
±r
 [
ıuid_avaabË
], 0

74 
je
 .
no_şæush


76 
‹¡
 
dwÜd
 
±r
 [
ıu_ã©u»s
], 
FEATURE_CLFLUSH


77 
jz
 .
no_şæush


79 ; 
G‘
 
·¿m‘”s


80 
mov
 
esi
, [
bp
+4] ; 
Bufãr
 
add»ss


81 
mov
 
ecx
, [
bp
+8] ; 
Bufãr
 
size


83 ; 
G‘
 
ÿche
 
lše
 
	$size
 ( 64 
nÙ
 
d‘eùed
)

84 
ÿche_lše_size
:
by‹


85 
movzx
 
ebx
, 
by‹
 
±r
 [
ÿche_lše_size
]

86 
‹¡
 
ebx
,ƒbx

87 
jnz
 .
has_lše_size


88 
mov
 
ebx
, 64 ; 
DeçuÉ
 
ÿche
 
lše
 
size


90 .
has_lše_size
:

91 ; 
Flush
 
loİ
 - 
™”©e
 
through
 
bufãr
 
by
 
ÿche
 
lše


92 .
æush_loİ
:

93 
cmp
 
ecx
, 0

94 
jË
 .
æush_dÚe


96 ; 
CLFLUSH
 
cu¼’t
 
ÿche
 
lše


97 
mov
 
—x
, 
esi


98 
db
 0x0F, 0xAE

99 
db
 0x38 ; 
CLFLUSH
 [
—x
]

101 ; 
Advªû
 
to
 
Ãxt
 
ÿche
 
lše


102 
add
 
esi
, 
ebx
 ; 
Next
 
ÿche
 
lše


103 
sub
 
ecx
, 
ebx
 ; 
Deü—£
 
»maššg
 
size


104 
jmp
 .
æush_loİ


106 .
æush_dÚe
:

107 ; 
Cr™iÿl
: 
MemÜy
 
ãnû
 
aá”
 
®l
 
CLFLUSHes


108 
ÿÎ
 
memÜy_ãnû_aá”_şæush


109 
xÜ
 
ax
,‡x ; 
Sucûss


110 
jmp
 .
dÚe


112 .
no_şæush
:

113 
mov
 
ax
, 1 ; 
CLFLUSH
 
nÙ
 
avaabË


115 .
dÚe
:

116 
pİ
 
esi


117 
pİ
 
edx


118 
pİ
 
ecx


119 
pİ
 
ebx


120 
pİ
 
bp


121 
»t


122 
ÿche_şæush_bufãr
 
’dp


125 ; 
ÿche_şæush_§ã
 - 
Saã
 
w¿µ”
 
CLFLUSH
 
w™h
 
ã©u»
 
d‘eùiÚ


127 ; 
IÅut
: 
Sck
 
·¿m‘”s
 - 
	`add»ss
 (
off£t
 4), 
	`size
 (offset 8)

128 ; 
Ouut
: 
AX
 = 0 
sucûssful
, 1 
CLFLUSH
 
nÙ
 
avaabË


129 ; 
Regi¡”s
: 
Modif›s
 
AX
 
Úly


131 
ÿche_şæush_§ã
 
´oc


132 ; 
Sim¶y
 
ÿÎ
 
the
 
bufãr
 
funùiÚ
 
which
 
has
 
®l
 
§ãty
 
checks


133 
jmp
 
ÿche_şæush_bufãr


134 
ÿche_şæush_§ã
 
’dp


137 ; 
ÿche_wbšvd
 - 
Wr™e
-
back
 
ªd
 
šv®id©e
 
	`ÿche
 (486+)

139 ; 
IÅut
: 
NÚe


140 ; 
Ouut
: 
NÚe


141 ; 
Regi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


143 
ÿche_wbšvd
 
´oc


144 
push
 
—x


146 ; 
Check
 
CPU
 
	`ÿ·b™y
 (
sim¶if›d
)

147 ; 
R—l
 
im¶em’tiÚ
 
would
 
v”ify
 486+ 
CPU


149 ; 
Execu‹
 
WBINVD
 
š¡ruùiÚ


150 
db
 0x0F, 0x09 ; 
WBINVD


152 
pİ
 
—x


153 
»t


154 
ÿche_wbšvd
 
’dp


157 ; 
ÿche_wbšvd_§ã
 - 
Saã
 
w¿µ”
 
WBINVD
 
w™h
 
V86
 
mode
 
check


159 ; 
IÅut
: 
NÚe


160 ; 
Ouut
: 
AX
 = 0 
sucûssful
, 1 
ÿÂÙ
 
execu‹
 
§ãly


161 ; 
Regi¡”s
: 
Modif›s
 
AX
 
Úly


163 ; 
NÙe
: 
WBINVD
 
wl
 
Œ­
 
š
 
V86
 
mode
, 
so
 
we
 
mu¡
 
check
 
fœ¡


165 
ÿche_wbšvd_§ã
 
´oc


166 ; 
Check
 
we
'» 486+ (WBINVD dÛ¢'
t
 
exi¡
 
befÜe
 486)

167 
ıu_is_486_¶us
:
by‹


168 
cmp
 
by‹
 
±r
 [
ıu_is_486_¶us
], 0

169 
je
 .
nÙ_§ã


171 ; 
Check
 
we
're in V86 mode (cached from detection)

172 
is_v86_mode
:
by‹


173 
cmp
 
by‹
 
±r
 [
is_v86_mode
], 0

174 
jÃ
 .
nÙ_§ã
 ; 
CªnÙ
 
u£
 
WBINVD
 
š
 
V86
 
mode


176 ; 
Saã
 
to
 
execu‹
 
WBINVD


177 
ÿÎ
 
ÿche_wbšvd


178 
xÜ
 
ax
,‡x ; 
R‘uº
 
sucûss


179 
jmp
 .
dÚe


181 .
nÙ_§ã
:

182 ; 
CªnÙ
 
§ãly
 
u£
 
WBINVD


183 
mov
 
ax
, 1 ; 
R‘uº
 
çu»


185 .
dÚe
:

186 
»t


187 
ÿche_wbšvd_§ã
 
’dp


190 ; 
ÿche_švd
 - 
Inv®id©e
 
ÿche
 
w™hout
 
wr™e
-
	`back
 (486+)

192 ; 
IÅut
: 
NÚe


193 ; 
Ouut
: 
NÚe


194 ; 
Regi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


195 ; 
NÙe
: 
U£
 
w™h
 
exŒeme
 
ÿutiÚ
 - 
ÿn
 
ÿu£
 
d©a
 
loss


197 
ÿche_švd
 
´oc


198 
push
 
—x


200 ; 
Execu‹
 
INVD
 
š¡ruùiÚ


201 
db
 0x0F, 0x08 ; 
INVD


203 
pİ
 
—x


204 
»t


205 
ÿche_švd
 
’dp


208 ; 
»ad_ü0_»gi¡”
 - 
R—d
 
CR0
 
cÚŒŞ
 (386+)

210 ; 
IÅut
: 
NÚe


211 ; 
Ouut
: 
EAX
 = 
CR0
 
v®ue


212 ; 
Regi¡”s
: 
Modif›s
 
EAX
 
Úly


214 
»ad_ü0_»gi¡”
 
´oc


215 ; 
R—d
 
CR0
 

216 
mov
 
—x
, 
ü0


217 
»t


218 
»ad_ü0_»gi¡”
 
’dp


221 ; 
wr™e_ü0_»gi¡”
 - 
Wr™e
 
CR0
 
cÚŒŞ
 (386+)

223 ; 
IÅut
: 
Sck
 
·¿m‘”
 - 
Ãw
 
CR0
 
v®ue


224 ; 
Ouut
: 
NÚe


225 ; 
Regi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


227 
wr™e_ü0_»gi¡”
 
´oc


228 
push
 
bp


229 
mov
 
bp
, 
¥


230 
push
 
—x


232 ; 
G‘
 
Ãw
 
CR0
 
v®ue


233 
mov
 
—x
, [
bp
+4]

235 ; 
Wr™e
 
CR0
 

236 
mov
 
ü0
, 
—x


238 ; 
S”Ÿlizšg
 
š¡ruùiÚ
 
to
 
’su»
 
chªges
 
ke
 
efãù


239 
jmp
 
$
+2

241 
pİ
 
—x


242 
pİ
 
bp


243 
»t


244 
wr™e_ü0_»gi¡”
 
’dp


247 ; 
memÜy_ãnû
 - 
MemÜy
 
ãnû
/
b¬r›r
 
İ”©iÚs


249 ; 
IÅut
: 
NÚe


250 ; 
Ouut
: 
NÚe


251 ; 
Regi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


253 
memÜy_ãnû
 
´oc


254 
push
 
—x


256 ; 
FÜ
 386/486: 
U£
 
£rŸlizšg
 
š¡ruùiÚ


257 
mov
 
—x
, 
ü0


258 
mov
 
ü0
, 
—x


260 ; 
FÜ
 
P’tium
+: 
Could
 
u£
 
CPUID
 
as
 
£rŸlizšg
 
š¡ruùiÚ


261 ; 
FÜ
 
mod”n
 
CPUs
: 
Would
 
u£
 
MFENCE
, 
LFENCE
, 
SFENCE


263 
pİ
 
—x


264 
»t


265 
memÜy_ãnû
 
’dp


268 ; 
memÜy_ãnû_aá”_şæush
 - 
MemÜy
 
ãnû
 
¥ecifiÿÎy
 
aá”
 
CLFLUSH


270 ; 
IÅut
: 
NÚe


271 ; 
Ouut
: 
NÚe


272 ; 
Regi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


273 ; 
NÙe
: 
Cr™iÿl
 
DMA
 
§ãty
 - 
’su»s
 
CLFLUSH
 
com¶‘es
 
befÜe
 DMA

275 
memÜy_ãnû_aá”_şæush
 
´oc


276 
push
 
—x


278 ; 
Check
 
SSE2
 
is
 
avaabË
 
MFENCE


279 
s£2_avaabË
:
by‹


280 
ıuid_avaabË
:
by‹


282 
cmp
 
by‹
 
±r
 [
s£2_avaabË
], 1

283 
je
 .
u£_mãnû


285 ; 
No
 
SSE2
 - 
check
 
CPUID
 
is
 
avaabË
 
£rŸliz©iÚ


286 
cmp
 
by‹
 
±r
 [
ıuid_avaabË
], 1

287 
je
 .
u£_ıuid


289 ; 
No
 
CPUID
 - 
u£
 
CR0
 
	`£rŸliz©iÚ
 (
wÜks
 
Ú
 386+)

290 
mov
 
—x
, 
ü0


291 
mov
 
ü0
, 
—x


292 
jmp
 .
dÚe


294 .
u£_mãnû
:

295 ; 
U£
 
MFENCE
 
	`š¡ruùiÚ
 (
ç¡e¡
 
Ú
 
P4
+)

296 
db
 0x0F, 0xAE, 0xF0 ; 
MFENCE


297 
jmp
 .
dÚe


299 .
u£_ıuid
:

300 ; 
U£
 
CPUID
 
as
 
£rŸlizšg
 
š¡ruùiÚ


301 
push
 
ebx


302 
push
 
ecx


303 
push
 
edx


304 
mov
 
—x
, 0

305 
ıuid
 ; 
This
 
£rŸlizes
 
the
 
CPU


306 
pİ
 
edx


307 
pİ
 
ecx


308 
pİ
 
ebx


310 .
dÚe
:

311 
pİ
 
—x


312 
»t


313 
memÜy_ãnû_aá”_şæush
 
’dp


316 ; 
¡Üe_ãnû
 - 
StÜe
 
	`ãnû
 (
wr™e
 
b¬r›r
)

318 ; 
IÅut
: 
NÚe


319 ; 
Ouut
: 
NÚe


320 ; 
Regi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


322 
¡Üe_ãnû
 
´oc


323 
push
 
—x


325 ; 
Ensu»
 
®l
 
´evious
 
¡Ües
 
com¶‘e
 
befÜe
 
cÚtšušg


326 ; 
On
 
Şd”
 
CPUs
, 
u£
 
£rŸlizšg
 
š¡ruùiÚ


327 
mov
 
—x
, 
ü0


328 
mov
 
ü0
, 
—x


330 
pİ
 
—x


331 
»t


332 
¡Üe_ãnû
 
’dp


335 ; 
lßd_ãnû
 - 
Lßd
 
	`ãnû
 (
»ad
 
b¬r›r
)

337 ; 
IÅut
: 
NÚe


338 ; 
Ouut
: 
NÚe


339 ; 
Regi¡”s
: 
P»£rves
 
®l
 
»gi¡”s


341 
lßd_ãnû
 
´oc


342 
push
 
—x


344 ; 
Ensu»
 
®l
 
´evious
 
lßds
 
com¶‘e
 
befÜe
 
cÚtšušg


345 
mov
 
—x
, 
ü0


346 
mov
 
ü0
, 
—x


348 
pİ
 
—x


349 
»t


350 
lßd_ãnû
 
’dp


353 ; 
d‘eù_ÿche_mode
 - 
D‘eù
 
cu¼’t
 
ÿche
 
mode
 
äom
 
CR0


355 ; 
IÅut
: 
NÚe


356 ; 
Ouut
: 
AX
 = 
ÿche
 
	`mode
 (0=
di§bËd
, 1=
wr™e
-
through
, 2=wr™e-
back
)

357 ; 
Regi¡”s
: 
Modif›s
 
AX
 
Úly


359 
d‘eù_ÿche_mode
 
´oc


360 
push
 
bx


362 ; 
R—d
 
CR0
 

363 
mov
 
—x
, 
ü0


365 ; 
Check
 
	$CD
 (
Cache
 
Di§bË
è
	$b™
 (
b™
 30)

366 
‹¡
 
—x
, 40000000
h


367 
jnz
 
ÿche_di§bËd


369 ; 
Check
 
	`NW
 (
NÙ
 
Wr™e
-
through
è
	$b™
 (
b™
 29)

370 
‹¡
 
—x
, 20000000
h


371 
jnz
 
wr™e_back_mode


373 ; 
CD
=0, 
NW
=0 = 
Wr™e
-
through
 
mode


374 
mov
 
ax
, 1

375 
jmp
 
d‘eù_dÚe


377 
wr™e_back_mode
:

378 ; 
CD
=0, 
NW
=1 = 
Wr™e
-
back
 
mode


379 
mov
 
ax
, 2

380 
jmp
 
d‘eù_dÚe


382 
ÿche_di§bËd
:

383 ; 
CD
=1 = 
Cache
 
di§bËd


384 
mov
 
ax
, 0

386 
d‘eù_dÚe
:

387 
pİ
 
bx


388 
»t


389 
d‘eù_ÿche_mode
 
’dp


392 ; 
g‘_cu¼’t_time¡amp
 - 
G‘
 
cu¼’t
 
time¡amp
 
³rfÜmªû
 
m—su»m’t


394 ; 
IÅut
: 
NÚe


395 ; 
Ouut
: 
EAX
 = 
time¡amp
 
š
 
	`miüo£cÚds
 (
sim¶if›d
)

396 ; 
Regi¡”s
: 
Modif›s
 
EAX
, 
EDX


398 
g‘_cu¼’t_time¡amp
 
´oc


399 
push
 
ecx


401 ; 
FÜ
 
»®
 
im¶em’tiÚ
, 
this
 
would
 
u£
:

402 ; - 
	$TSC
 (
Time
 
Smp
 
CouÁ”
è
Ú
 
P’tium
+

403 ; - 
	$PIT
 (
Prog¿mmabË
 
IÁ”v®
 
Tim”
è
Ú
 
Şd”
 
CPUs


404 ; - 
	$RTC
 (
R—l
 
Time
 
Clock
è
as
 
çÎback


406 ; 
Sim¶if›d
 
im¶em’tiÚ
 
usšg
 
PIT
 
chªÃl
 0

407 ; 
R—d
 
cu¼’t
 
PIT
 
couÁ”


408 
mov
 
®
, 0 ; 
L©ch
 
couÁ”
 0

409 
out
 43
h
, 
®
 ; 
Commªd
 

411 
š
 
®
, 40
h
 ; 
R—d
 
low
 
by‹


412 
mov
 
ah
, 
®


413 
š
 
®
, 40
h
 ; 
R—d
 
high
 
by‹


414 
xchg
 
ah
, 
®
 ; 
AX
 = 
couÁ”
 
v®ue


416 ; 
CÚv”t
 
to
 
	$miüo£cÚds
 (
v”y
 
sim¶if›d
)

417 
movzx
 
—x
, 
ax


418 
imul
 
—x
, 838 ; 
Aµroxim©e
 
cÚv”siÚ
 
çùÜ


419 
shr
 
—x
, 10 ; 
Divide
 
by
 1024

421 
pİ
 
ecx


422 
»t


423 
g‘_cu¼’t_time¡amp
 
’dp


426 ; 
CPU
-
¥ecific
 
ÿche
 
lše
 
size
 
d‘eùiÚ
 
h–³r


428 ; 
IÅut
: 
NÚe


429 ; 
Ouut
: 
EAX
 = 
ÿche
 
lše
 
size
 
š
 
by‹s


430 ; 
Regi¡”s
: 
Modif›s
 
EAX
, 
EBX
, 
ECX
, 
EDX


432 
d‘eù_ÿche_lše_size_asm
 
´oc


433 
push
 
ebx


434 
push
 
ecx


435 
push
 
edx


437 ; 
Try
 
CPUID
 
	`avaabË
 (
P’tium
+)

438 
pushfd


439 
pİ
 
—x


440 
mov
 
ecx
, 
—x


441 
xÜ
 
—x
, 200000
h
 ; 
Fl
 
ID
 
b™


442 
push
 
—x


443 
pİfd


444 
pushfd


445 
pİ
 
—x


446 
cmp
 
—x
, 
ecx


447 
je
 
no_ıuid
 ; 
CPUID
 
nÙ
 
suµÜ‹d


449 ; 
CPUID
 
avaabË
 - 
g‘
 
ÿche
 
šfo


450 
mov
 
—x
, 1

451 
ıuid


453 ; 
ExŒaù
 
ÿche
 
lše
 
size
 
äom
 
EBX
[15:8]

454 
mov
 
—x
, 
ebx


455 
shr
 
—x
, 8

456 
ªd
 
—x
, 0FF
h


457 
shl
 
—x
, 3 ; 
CÚv”t
 
to
 
	`by‹s
 (
muÉly
 
by
 8)

459 ; 
V®id©e
 
»suÉ


460 
cmp
 
—x
, 16

461 
jb
 
u£_deçuÉ


462 
cmp
 
—x
, 128

463 
ja
 
u£_deçuÉ


464 
jmp
 
size_dÚe


466 
no_ıuid
:

467 
u£_deçuÉ
:

468 ; 
DeçuÉ
 
ÿche
 
lše
 
size
 
ba£d
 
Ú
 
CPU
 
g’”©iÚ


469 ; 
This
 
is
 
a
 
sim¶if›d
 
­´ßch


470 
mov
 
—x
, 32 ; 
CÚ£rv©ive
 

472 
size_dÚe
:

473 
pİ
 
edx


474 
pİ
 
ecx


475 
pİ
 
ebx


476 
»t


477 
d‘eù_ÿche_lše_size_asm
 
’dp


480 ; 
Te¡
 
ÿche
 
coh”’cy
 
w™h
 
as£mbly
-
Ëv–
 
´ecisiÚ


482 ; 
IÅut
: 
Sck
 
·¿m‘”s
 - 
bufãr
 
add»ss
, 
‹¡
 
·‰”n


483 ; 
Ouut
: 
AX
 = 1 
coh”’t
, 0 
cÜru±ed


484 ; 
Regi¡”s
: 
Modif›s
 
AX
, 
BX


486 
‹¡_ÿche_coh”’cy_asm
 
´oc


487 
push
 
bp


488 
mov
 
bp
, 
¥


489 
push
 
bx


490 
push
 
cx


491 
push
 
dx


493 ; 
G‘
 
·¿m‘”s


494 
mov
 
bx
, [
bp
+4] ; 
Bufãr
 
add»ss


495 
mov
 
cx
, [
bp
+6] ; 
Te¡
 
·‰”n


497 ; 
Wr™e
 
·‰”n
 
to
 
memÜy


498 
mov
 [
bx
], 
cx


500 ; 
FÜû
 
što
 
ÿche
 
by
 
»adšg


501 
mov
 
dx
, [
bx
]

503 ; 
SimuÏ‹
 
DMA
 
wr™e
 
w™h
 
difã»Á
 
·‰”n


504 
nÙ
 
cx
 ; 
Inv”t
 
·‰”n


505 
mov
 [
bx
], 
cx


507 ; 
R—d
 
back
 - 
ÿche
 
is
 
coh”’t
, 
should
 
g‘
 
Ãw
 
·‰”n


508 
mov
 
dx
, [
bx
]

509 
cmp
 
dx
, 
cx


510 
je
 
coh”’t


512 ; 
Incoh”’t


513 
mov
 
ax
, 0

514 
jmp
 
‹¡_dÚe


516 
coh”’t
:

517 
mov
 
ax
, 1

519 
‹¡_dÚe
:

520 
pİ
 
dx


521 
pİ
 
cx


522 
pİ
 
bx


523 
pİ
 
bp


524 
»t


525 
‹¡_ÿche_coh”’cy_asm
 
’dp


	@/Users/jvindahl/Development/3com-packet-driver/src/c/cache_coherency.c

15 
	~"../šşude/ÿche_coh”’cy.h
"

16 
	~"../šşude/h¬dw¬e.h
"

17 
	~"../šşude/loggšg.h
"

18 
	~"../šşude/memÜy.h
"

19 
	~"../šşude/commÚ.h
"

20 
	~"../šşude/ıu_d‘eù.h
"

21 
	~<¡ršg.h
>

22 
	~<¡dšt.h
>

23 
	~<¡dboŞ.h
>

26 cÚ¡ 
ušt32_t
 
	g‹¡_·‰”ns
[] = {

33 
	#COHERENCY_TEST_BUFFER_SIZE
 4096

	)

34 
	#NUM_TEST_PATTERNS
 ((
‹¡_·‰”ns
è/ Ñe¡_·‰”ns[0]))

	)

37 cÚ¡ 
size_t
 
	gÿche_lše_sizes
[] = {16, 32, 64, 128};

38 
	#NUM_CACHE_LINE_SIZES
 ((
ÿche_lše_sizes
è/ (ÿche_lše_sizes[0]))

	)

41 
boŞ
 
‹¡_dma_loİback
(*
bufãr
, 
ušt32_t
 
·‰”n
);

42 
boŞ
 
‹¡_ÿche_wr™e_back_d‘eùiÚ
(*
bufãr
, 
size_t
 
size
);

43 
boŞ
 
‹¡_ÿche_šv®id©iÚ_d‘eùiÚ
(*
bufãr
, 
size_t
 
size
);

44 
boŞ
 
‹¡_timšg_ba£d_¢oİšg
(*
bufãr
, 
size_t
 
size
);

45 
fÜû_ÿche_lßd
(vŞ©*
bufãr
, 
size_t
 
size
);

46 
ušt32_t
 
g‘_time¡amp_miüo£cÚds
();

54 
bus_ma¡”_»suÉ_t
 
	$‹¡_basic_bus_ma¡”
() {

55 
ušt8_t
 *
‹¡_bufãr
;

56 
sucûss_couÁ
 = 0;

57 
tÙ®_‹¡s
 = 
NUM_TEST_PATTERNS
 * 2;

59 
	`log_šfo
("Stage 1: Testing basic bus master functionality...");

62 
‹¡_bufãr
 = (
ušt8_t
*)
	`mem_®loc_®igÃd
(
COHERENCY_TEST_BUFFER_SIZE
, 16);

63 ià(!
‹¡_bufãr
) {

64 
	`log_”rÜ
("Cannot‡llocateest buffer for bus masteresting");

65  
BUS_MASTER_BROKEN
;

69 
i
 = 0; i < 
NUM_TEST_PATTERNS
; i++) {

70 
ušt32_t
 
·‰”n
 = 
‹¡_·‰”ns
[
i
];

73 ià(
	`‹¡_dma_loİback
(
‹¡_bufãr
, 
·‰”n
)) {

74 
sucûss_couÁ
++;

78 *((
ušt32_t
*)
‹¡_bufãr
èğ
·‰”n
;

79 ià(
	`‹¡_dma_loİback
(
‹¡_bufãr
, 
·‰”n
)) {

80 
sucûss_couÁ
++;

84 
	`mem_ä“
(
‹¡_bufãr
);

87 ià(
sucûss_couÁ
 =ğ
tÙ®_‹¡s
) {

88 
	`log_šfo
("Bus master functionality: PASSED (100%%)");

89  
BUS_MASTER_OK
;

90 } ià(
sucûss_couÁ
 > 
tÙ®_‹¡s
 / 2) {

91 
	`log_w¬nšg
("Bus master functionality: PARTIAL (%d/%dests…assed)",

92 
sucûss_couÁ
, 
tÙ®_‹¡s
);

93  
BUS_MASTER_PARTIAL
;

95 
	`log_”rÜ
("Bus master functionality: FAILED (%d/%dests…assed)",

96 
sucûss_couÁ
, 
tÙ®_‹¡s
);

97  
BUS_MASTER_BROKEN
;

99 
	}
}

107 
coh”’cy_»suÉ_t
 
	$‹¡_ÿche_coh”’cy
() {

108 
ušt32_t
 *
‹¡_bufãr
;

109 
cÜru±iÚ_d‘eùed
 = 0;

110 
ÿche_mode_t
 
ÿche_mode
;

112 
	`log_šfo
("Stage 2: Testing cache coherency...");

115 
ÿche_mode
 = 
	`d‘eù_ÿche_mode
();

116 ià(
ÿche_mode
 !ğ
CACHE_WRITE_BACK
) {

117 
	`log_šfo
("Cache is‚ot in write-back mode - coherency OK by design");

118  
COHERENCY_OK
;

122 
‹¡_bufãr
 = (
ušt32_t
*)
	`mem_®loc_®igÃd
(
COHERENCY_TEST_BUFFER_SIZE
, 64);

123 ià(!
‹¡_bufãr
) {

124 
	`log_”rÜ
("Cannot‡llocateest buffer for coherencyesting");

125  
COHERENCY_UNKNOWN
;

129 ià(!
	`‹¡_ÿche_wr™e_back_d‘eùiÚ
(
‹¡_bufãr
, 
COHERENCY_TEST_BUFFER_SIZE
)) {

130 
cÜru±iÚ_d‘eùed
++;

131 
	`log_w¬nšg
("Write-back cache coherency issue detected");

135 ià(!
	`‹¡_ÿche_šv®id©iÚ_d‘eùiÚ
(
‹¡_bufãr
, 
COHERENCY_TEST_BUFFER_SIZE
)) {

136 
cÜru±iÚ_d‘eùed
++;

137 
	`log_w¬nšg
("Cache invalidation coherency issue detected");

140 
	`mem_ä“
(
‹¡_bufãr
);

142 ià(
cÜru±iÚ_d‘eùed
 == 0) {

143 
	`log_šfo
("Cache coherency: OK (no issues detected)");

144  
COHERENCY_OK
;

146 
	`log_w¬nšg
("Cachcoh”’cy: PROBLEMS DETECTED (%d issues)", 
cÜru±iÚ_d‘eùed
);

147  
COHERENCY_PROBLEM
;

149 
	}
}

157 
¢oİšg_»suÉ_t
 
	$‹¡_h¬dw¬e_¢oİšg
() {

158 
ušt32_t
 *
‹¡_bufãr
;

159 
¢oİšg_‹¡s_·s£d
 = 0;

160 
tÙ®_¢oİšg_‹¡s
 = 4;

161 
ÿche_mode_t
 
ÿche_mode
;

163 
	`log_šfo
("Stage 3: Testing hardware snooping capabilities...");

166 
ÿche_mode
 = 
	`d‘eù_ÿche_mode
();

167 ià(
ÿche_mode
 !ğ
CACHE_WRITE_BACK
) {

168 
	`log_šfo
("Cache‚ot in write-back mode - snoopingest‚ot‡pplicable");

169  
SNOOPING_UNKNOWN
;

173 
‹¡_bufãr
 = (
ušt32_t
*)
	`mem_®loc_®igÃd
(
COHERENCY_TEST_BUFFER_SIZE
, 128);

174 ià(!
‹¡_bufãr
) {

175 
	`log_”rÜ
("Cannot‡llocateest buffer for snoopingesting");

176  
SNOOPING_UNKNOWN
;

180 ià(
	`‹¡_timšg_ba£d_¢oİšg
(
‹¡_bufãr
, 64)) {

181 
¢oİšg_‹¡s_·s£d
++;

182 
	`log_debug
("Single cache†ine snooping: DETECTED");

186 ià(
	`‹¡_timšg_ba£d_¢oİšg
(
‹¡_bufãr
 + 64, 256)) {

187 
¢oİšg_‹¡s_·s£d
++;

188 
	`log_debug
("Multi-line cache snooping: DETECTED");

192 ià(
	`‹¡_timšg_ba£d_¢oİšg
(
‹¡_bufãr
 + 320, 1024)) {

193 
¢oİšg_‹¡s_·s£d
++;

194 
	`log_debug
("Largeransfer snooping: DETECTED");

198 ià(
	`‹¡_timšg_ba£d_¢oİšg
(
‹¡_bufãr
 + 1024, 2048)) {

199 
¢oİšg_‹¡s_·s£d
++;

200 
	`log_debug
("Cross-page snooping: DETECTED");

203 
	`mem_ä“
(
‹¡_bufãr
);

206 ià(
¢oİšg_‹¡s_·s£d
 =ğ
tÙ®_¢oİšg_‹¡s
) {

207 
	`log_šfo
("Hardware snooping: FULL (allests…assed)");

208  
SNOOPING_FULL
;

209 } ià(
¢oİšg_‹¡s_·s£d
 > 0) {

210 
	`log_w¬nšg
("Hardware snooping: PARTIAL (%d/%dests…assed)",

211 
¢oİšg_‹¡s_·s£d
, 
tÙ®_¢oİšg_‹¡s
);

212  
SNOOPING_PARTIAL
;

214 
	`log_šfo
("Hardware snooping: NONE (no snooping detected)");

215  
SNOOPING_NONE
;

217 
	}
}

225 
coh”’cy_ª®ysis_t
 
	$³rfÜm_com¶‘e_coh”’cy_ª®ysis
() {

226 
coh”’cy_ª®ysis_t
 
ª®ysis
 = {0};

227 
ıu_šfo_t
 
ıu_šfo
;

229 
	`log_šfo
("3Com Packet Driver - Cache Coherency Analysis");

230 
	`log_šfo
("==============================================");

233 
ıu_šfo
 = 
	`d‘eù_ıu_šfo
();

234 
ª®ysis
.
ıu
 = 
ıu_šfo
;

235 
ª®ysis
.
ÿche_’abËd
 = 
	`is_ÿche_’abËd
();

236 
ª®ysis
.
wr™e_back_ÿche
 = (
	`d‘eù_ÿche_mode
(è=ğ
CACHE_WRITE_BACK
);

238 
	`log_šfo
("CPU: %s", 
ıu_šfo
.
Çme
);

239 
	`log_šfo
("Cache: %s", 
ª®ysis
.
wr™e_back_ÿche
 ?

240 "Wr™e-back" : (
ª®ysis
.
ÿche_’abËd
 ? "Write-through" : "Disabled"));

243 
ª®ysis
.
bus_ma¡”
 = 
	`‹¡_basic_bus_ma¡”
();

245 ià(
ª®ysis
.
bus_ma¡”
 !ğ
BUS_MASTER_OK
) {

246 
ª®ysis
.
£Ëùed_t›r
 = 
TIER_DISABLE_BUS_MASTER
;

247 
ª®ysis
.
cÚfid’û
 = 100;

248 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "Bus mastering‚ot functional - using PIO only");

249 
	`log_w¬nšg
("Bus mastering disabled - falling backo PIO mode");

250  
ª®ysis
;

254 
ª®ysis
.
coh”’cy
 = 
	`‹¡_ÿche_coh”’cy
();

256 ià(
ª®ysis
.
coh”’cy
 =ğ
COHERENCY_PROBLEM
) {

258 ià(
ıu_šfo
.
has_şæush
) {

259 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_1_CLFLUSH
;

260 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "CLFLUSH‡vailable - optimal cache management");

261 } ià(
ıu_šfo
.
has_wbšvd
) {

262 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_2_WBINVD
;

263 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "WBINVD‡vailable -ƒffective cache management");

265 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_3_SOFTWARE
;

266 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "Software cache barriers„equired");

268 
ª®ysis
.
cÚfid’û
 = 100;

269  
ª®ysis
;

273 ià(
ª®ysis
.
coh”’cy
 =ğ
COHERENCY_OK
 &&‡Çlysis.
wr™e_back_ÿche
) {

274 
ª®ysis
.
¢oİšg
 = 
	`‹¡_h¬dw¬e_¢oİšg
();

276 
ª®ysis
.
¢oİšg
) {

277 
SNOOPING_FULL
:

278 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_4_FALLBACK
;

279 
ª®ysis
.
cÚfid’û
 = 95;

280 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "Hardware snooping maintains coherency");

282 
SNOOPING_PARTIAL
:

283 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_2_WBINVD
;

284 
ª®ysis
.
cÚfid’û
 = 80;

285 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "Partial snooping - using conservative‡pproach");

287 
SNOOPING_NONE
:

288 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_4_FALLBACK
;

289 
ª®ysis
.
cÚfid’û
 = 90;

290 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "Coherency OK -†ikely write-through cache");

293 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_3_SOFTWARE
;

294 
ª®ysis
.
cÚfid’û
 = 70;

295 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "Unknown snooping - using conservative‡pproach");

299 
ª®ysis
.
£Ëùed_t›r
 = 
CACHE_TIER_4_FALLBACK
;

300 
ª®ysis
.
cÚfid’û
 = 95;

301 
	`¡rıy
(
ª®ysis
.
ex¶ª©iÚ
, "Write-through/disabled cache„equires‚o management");

304 
	`log_šfo
("S–eùed: T›¸%d (%s)", 
ª®ysis
.
£Ëùed_t›r
,‡Çlysis.
ex¶ª©iÚ
);

305 
	`log_šfo
("CÚfid’û: %d%%", 
ª®ysis
.
cÚfid’û
);

307  
ª®ysis
;

308 
	}
}

313 
boŞ
 
	$‹¡_dma_loİback
(*
bufãr
, 
ušt32_t
 
·‰”n
) {

315 
ušt32_t
 *
‹¡_±r
 = (ušt32_t*)
bufãr
;

318 *
‹¡_±r
 = 
·‰”n
;

321 vŞ©
i
 = 0; i < 1000; i++);

324  (*
‹¡_±r
 =ğ
·‰”n
);

325 
	}
}

330 
boŞ
 
	$‹¡_ÿche_wr™e_back_d‘eùiÚ
(*
bufãr
, 
size_t
 
size
) {

331 
ušt32_t
 *
‹¡_±r
 = (ušt32_t*)
bufãr
;

332 
ušt32_t
 
‹¡_·‰”n
 = 0x
TESTPATN
;

333 
ušt32_t
 
dma_·‰”n
 = 0xD
MAPATRN
;

336 *
‹¡_±r
 = 
‹¡_·‰”n
;

339 
	`fÜû_ÿche_lßd
(
‹¡_±r
, 4);

343 *
‹¡_±r
 = 
dma_·‰”n
;

346 
ušt32_t
 
»suÉ
 = *
‹¡_±r
;

349  (
»suÉ
 =ğ
dma_·‰”n
);

350 
	}
}

355 
boŞ
 
	$‹¡_ÿche_šv®id©iÚ_d‘eùiÚ
(*
bufãr
, 
size_t
 
size
) {

356 
ušt32_t
 *
‹¡_±r
 = (ušt32_t*)
bufãr
;

357 
ušt32_t
 
š™Ÿl_·‰”n
 = 0x
INITIAL1
;

358 
ušt32_t
 
modif›d_·‰”n
 = 0x
MODIFIED
;

361 *
‹¡_±r
 = 
š™Ÿl_·‰”n
;

364 
	`fÜû_ÿche_lßd
(
‹¡_±r
, 4);

367 *
‹¡_±r
 = 
modif›d_·‰”n
;

370 
ušt32_t
 
»suÉ
 = *
‹¡_±r
;

372  (
»suÉ
 =ğ
modif›d_·‰”n
);

373 
	}
}

378 
boŞ
 
	$‹¡_timšg_ba£d_¢oİšg
(*
bufãr
, 
size_t
 
size
) {

379 
ušt32_t
 *
‹¡_±r
 = (ušt32_t*)
bufãr
;

380 
ušt32_t
 
¡¬t_time
, 
dma_time
, 
»ad_time
;

381 
ušt32_t
 
‹¡_·‰”n
 = 0x
SNOOPTST
;

382 
ušt32_t
 
dma_·‰”n
 = 0xD
MASNOOP
;

385 *
‹¡_±r
 = 
‹¡_·‰”n
;

386 
	`fÜû_ÿche_lßd
(
‹¡_±r
, 
size
);

389 
¡¬t_time
 = 
	`g‘_time¡amp_miüo£cÚds
();

390 *
‹¡_±r
 = 
dma_·‰”n
;

391 
dma_time
 = 
	`g‘_time¡amp_miüo£cÚds
(è- 
¡¬t_time
;

394 
¡¬t_time
 = 
	`g‘_time¡amp_miüo£cÚds
();

395 vŞ©
ušt32_t
 
»suÉ
 = *
‹¡_±r
;

396 
»ad_time
 = 
	`g‘_time¡amp_miüo£cÚds
(è- 
¡¬t_time
;

399  (
»suÉ
 =ğ
dma_·‰”n
 && 
»ad_time
 < 10);

400 
	}
}

405 
	$fÜû_ÿche_lßd
(vŞ©*
bufãr
, 
size_t
 
size
) {

406 vŞ©
ušt8_t
 *
±r
 = (vŞ©ušt8_t*)
bufãr
;

407 vŞ©
ušt8_t
 
dummy
;

410 
size_t
 
i
 = 0; i < 
size
; i++) {

411 
dummy
 = 
±r
[
i
];

415 ()
dummy
;

416 
	}
}

422 
ušt32_t
 
	$g‘_time¡amp_miüo£cÚds
() {

423 
ušt32_t
 
couÁ”
 = 0;

424  
couÁ”
++;

425 
	}
}

430 
boŞ
 
	$v®id©e_coh”’cy_‹¡_»suÉs
(cÚ¡ 
coh”’cy_ª®ysis_t
 *
ª®ysis
) {

433 ià(
ª®ysis
->
coh”’cy
 =ğ
COHERENCY_OK
 &&

434 
ª®ysis
->
¢oİšg
 =ğ
SNOOPING_NONE
 &&

435 
ª®ysis
->
wr™e_back_ÿche
) {

436 
	`log_w¬nšg
("Inconsistent„esults: write-back cache but‚o coherency issues");

437  
çl£
;

441 ià(
ª®ysis
->
bus_ma¡”
 =ğ
BUS_MASTER_BROKEN
 &&

442 
ª®ysis
->
£Ëùed_t›r
 !ğ
TIER_DISABLE_BUS_MASTER
) {

443 
	`log_”rÜ
("Invalidier selection for broken bus master");

444  
çl£
;

447  
Œue
;

448 
	}
}

453 cÚ¡ * 
	$g‘_ÿche_t›r_desütiÚ
(
ÿche_t›r_t
 
t›r
) {

454 
t›r
) {

455 
CACHE_TIER_1_CLFLUSH
:

457 
CACHE_TIER_2_WBINVD
:

459 
CACHE_TIER_3_SOFTWARE
:

461 
CACHE_TIER_4_FALLBACK
:

463 
TIER_DISABLE_BUS_MASTER
:

468 
	}
}

473 
	$´št_d‘aed_coh”’cy_»suÉs
(cÚ¡ 
coh”’cy_ª®ysis_t
 *
ª®ysis
) {

474 
	`´štf
("\n=== Detailed Cache Coherency Analysis ===\n");

475 
	`´štf
("Bus Master Test: %s\n",

476 (
ª®ysis
->
bus_ma¡”
 =ğ
BUS_MASTER_OK
) ? "OK" :

477 (
ª®ysis
->
bus_ma¡”
 =ğ
BUS_MASTER_PARTIAL
) ? "PARTIAL" : "FAILED");

479 ià(
ª®ysis
->
bus_ma¡”
 =ğ
BUS_MASTER_OK
) {

480 
	`´štf
("Coherency Test: %s\n",

481 (
ª®ysis
->
coh”’cy
 =ğ
COHERENCY_OK
) ? "OK" : "PROBLEMS DETECTED");

483 ià(
ª®ysis
->
wr™e_back_ÿche
 &&‡Çlysis->
coh”’cy
 =ğ
COHERENCY_OK
) {

484 
	`´štf
("Snooping Test: %s\n",

485 (
ª®ysis
->
¢oİšg
 =ğ
SNOOPING_FULL
) ? "FULL" :

486 (
ª®ysis
->
¢oİšg
 =ğ
SNOOPING_PARTIAL
) ? "PARTIAL" :

487 (
ª®ysis
->
¢oİšg
 =ğ
SNOOPING_NONE
) ? "NONE" : "UNKNOWN");

491 
	`´štf
("S–eùed SŒ©egy: %s\n", 
	`g‘_ÿche_t›r_desütiÚ
(
ª®ysis
->
£Ëùed_t›r
));

492 
	`´štf
("CÚfid’û Lev–: %d%%\n", 
ª®ysis
->
cÚfid’û
);

493 
	`´štf
("Ex¶ª©iÚ: %s\n", 
ª®ysis
->
ex¶ª©iÚ
);

494 
	`´štf
("========================================\n");

495 
	}
}

515 
boŞ
 
	$‹¡_vds_avaab™y
() {

516 
ušt16_t
 
vds_v”siÚ_majÜ
, 
vds_v”siÚ_mšÜ
;

517 
ušt16_t
 
vds_æags
;

518 
ušt32_t
 
vds_max_bufãr_size
;

520 
	`log_debug
("Cache Coherency: Testing VDS‡vailability...");

523 
__asm
 {

524 
push
 
ax


525 
push
 
bx


526 
push
 
cx


527 
push
 
dx


528 
push
 
si


529 
push
 
di


530 
push
 
es


532 
mov
 
ax
, 8100
h
 ; 
AH
=81
	`h
 (
VDS
), 
AL
=00h (
G‘
 
V”siÚ
)

533 
xÜ
 
dx
, dx ; 
DX
=0 
com·tib™y


534 4B
h
 ; 
VDS
 
š‹¼u±


535 
jc
 
vds_nÙ_avaabË


537 ; 
VDS
 
is
 
avaabË
 - 
g‘
 
v”siÚ
 
ªd
 
ÿ·b™›s


538 ; 
AH
 = 
MajÜ
 
v”siÚ
, 
AL
 = 
MšÜ
 version

539 ; 
BX
 = 
Produù
 
æags
, 
CX
:
DX
 = 
Max
 
DMA
 
bufãr
 
size


540 
mov
 
vds_v”siÚ_majÜ
, 
ah


541 
mov
 
vds_v”siÚ_mšÜ
, 
®


542 
mov
 
vds_æags
, 
bx


543 
mov
 
wÜd
 
±r
 
vds_max_bufãr_size
, 
cx


544 
mov
 
wÜd
 
±r
 
vds_max_bufãr_size
+2, 
dx


545 
jmp
 
vds_avaabË


547 
vds_nÙ_avaabË
:

548 
mov
 
vds_v”siÚ_majÜ
, 0

549 
mov
 
vds_v”siÚ_mšÜ
, 0

550 
mov
 
vds_æags
, 0

551 
mov
 
wÜd
 
±r
 
vds_max_bufãr_size
, 0

552 
mov
 
wÜd
 
±r
 
vds_max_bufãr_size
+2, 0

554 
vds_avaabË
:

555 
pİ
 
es


556 
pİ
 
di


557 
pİ
 
si


558 
pİ
 
dx


559 
pİ
 
cx


560 
pİ
 
bx


561 
pİ
 
ax


564 ià(
vds_v”siÚ_majÜ
 == 0) {

565 
	`log_šfo
("VDS: Not‡vailable -„unning in„eal mode or‚o VDS driver");

566  
çl£
;

569 
	`log_šfo
("VDS: Available - Version %d.%d, Flags=0x%04X, MaxBuffer=%lu bytes",

570 
vds_v”siÚ_majÜ
, 
vds_v”siÚ_mšÜ
, 
vds_æags
, 
vds_max_bufãr_size
);

573  
	`‹¡_vds_funùiÚ®™y
(è!ğ
SNOOPING_UNKNOWN
;

574 
	}
}

583 
¢oİšg_»suÉ_t
 
	$‹¡_vds_funùiÚ®™y
() {

584 * 
‹¡_bufãr
;

585 
ušt32_t
 
bufãr_size
 = 1024;

586 
ušt16_t
 
vds_hªdË
 = 0;

587 
ušt32_t
 
physiÿl_addr
 = 0;

588 
boŞ
 
lock_sucûss
 = 
çl£
;

589 
boŞ
 
uÆock_sucûss
 = 
çl£
;

591 
	`log_debug
("VDS: Testing functionality‡nd cache coherency...");

594 
‹¡_bufãr
 = 
	`memÜy_®loc
(
bufãr_size
, 
MEM_TYPE_PACKET_BUFFER
, 0);

595 ià(!
‹¡_bufãr
) {

596 
	`log_”rÜ
("VDS: Failedo‡llocateest buffer");

597  
SNOOPING_UNKNOWN
;

601 
__asm
 {

602 
push
 
ax


603 
push
 
bx


604 
push
 
cx


605 
push
 
dx


606 
push
 
si


607 
push
 
di


608 
push
 
es


610 ; 
S‘up
 
Lock
 
DMA
 
»giÚ


611 
mov
 
ax
, 8101
h
 ; 
AH
=81
	`h
 (
VDS
), 
AL
=01h (
Lock
 
DMA
 
RegiÚ
)

612 
mov
 
dx
, 0 ; 
	`FÏgs
 (0 = 
b–ow
 16
MB
 
possibË
)

614 ; 
ES
:
DI
 
pošts
 
to
 
DMA
 
desütÜ
 
¡ruùu»
:

615 ; +00
h
 
DWORD
: 
RegiÚ
 
size


616 ; +04
h
 
DWORD
: 
Lš—r
 
add»ss


617 ; +08
h
 
WORD
: 
Segm’t
/
	`£ËùÜ
 (
»tuºed
)

618 ; +0A
h
 
WORD
: 
Re£rved


619 ; +0C
h
 
DWORD
: 
Physiÿl
 
	`add»ss
 (
»tuºed
)

621 ; 
FÜ
 
sim¶ic™y
, 
we
'll use„egisters directly

622 
mov
 
bx
, 
wÜd
 
±r
 
‹¡_bufãr
+2 ; 
Segm’t
 
of
 
bufãr


623 
mov
 
cx
, 
wÜd
 
±r
 
‹¡_bufãr
 ; 
Off£t
 
of
 
bufãr


624 
mov
 
si
, 
wÜd
 
±r
 
bufãr_size
 ; 
Size
 
low
 word

625 
mov
 
di
, 
wÜd
 
±r
 
bufãr_size
+2 ; 
Size
 
high
 word

627 4B
h


628 
jc
 
vds_lock_çed


630 ; 
Lock
 
sucûeded
 - 
Physiÿl
 
add»ss
 
»tuºed
 
š
 
BX
:
CX


631 
mov
 
wÜd
 
±r
 
physiÿl_addr
, 
cx


632 
mov
 
wÜd
 
±r
 
physiÿl_addr
+2, 
bx


633 
mov
 
vds_hªdË
, 
dx
 ; 
Save
 
lock
 
ID
 
uÆock


634 
mov
 
lock_sucûss
, 1

635 
jmp
 
vds_lock_dÚe


637 
vds_lock_çed
:

638 
mov
 
lock_sucûss
, 0

640 
vds_lock_dÚe
:

641 
pİ
 
es


642 
pİ
 
di


643 
pİ
 
si


644 
pİ
 
dx


645 
pİ
 
cx


646 
pİ
 
bx


647 
pİ
 
ax


650 ià(!
lock_sucûss
) {

651 
	`log_w¬nšg
("VDS: Lock DMA Region failed -†imited functionality");

652 
	`memÜy_ä“
(
‹¡_bufãr
);

653  
SNOOPING_NONE
;

656 
	`log_debug
("VDS: Lock successful - Handle=0x%04X, Physical=0x%08lX",

657 
vds_hªdË
, 
physiÿl_addr
);

660 
__asm
 {

661 
push
 
ax


662 
push
 
bx


663 
push
 
cx


664 
push
 
dx


666 ; 
UÆock
 
DMA
 
»giÚ


667 
mov
 
ax
, 8102
h
 ; 
AH
=81
	`h
 (
VDS
), 
AL
=02h (
UÆock
 
DMA
 
RegiÚ
)

668 
mov
 
dx
, 
vds_hªdË
 ; 
Lock
 
ID
 
äom
 
lock
 
İ”©iÚ


669 
xÜ
 
bx
, bx ; 
	`FÏgs
 (0 = 
nÜm®
)

670 4B
h


671 
jc
 
vds_uÆock_çed


673 
mov
 
uÆock_sucûss
, 1

674 
jmp
 
vds_uÆock_dÚe


676 
vds_uÆock_çed
:

677 
mov
 
uÆock_sucûss
, 0

679 
vds_uÆock_dÚe
:

680 
pİ
 
dx


681 
pİ
 
cx


682 
pİ
 
bx


683 
pİ
 
ax


686 
	`memÜy_ä“
(
‹¡_bufãr
);

688 ià(!
uÆock_sucûss
) {

689 
	`log_w¬nšg
("VDS: Unlock DMA Region failed");

690  
SNOOPING_PARTIAL
;

693 
	`log_šfo
("VDS: Full functionality confirmed - Lock/Unlock operations successful");

694  
SNOOPING_FULL
;

695 
	}
}

704 
boŞ
 
	$d‘eù_v86_’vœÚm’t
() {

705 
ušt16_t
 
æags_»gi¡”
;

706 
boŞ
 
is_v86_mode
 = 
çl£
;

709 
__asm
 {

710 
pushf
 ; 
G‘
 
æags


711 
pİ
 
ax
 ; 
FÏgs
 
to
 
AX


712 
mov
 
æags_»gi¡”
, 
ax


714 ; 
Try
 
to
 
£t
 
VM
 
æag
 - 
we
're in V86 mode,his will be ignored

715 
Ü
 
ax
, 0x0002 ; 
S‘
 
a
 
b™
 
th©
 
should
 
be
 
£‰abË
 
š
 
»®
 
mode


716 
push
 
ax


717 
pİf


718 
pushf


719 
pİ
 
bx
 ; 
G‘
 
æags
 
agaš


721 ; 
Re¡Üe
 
Üigš®
 
æags


722 
push
 
æags_»gi¡”


723 
pİf


725 ; 
Check
 
æag
 
chªge
 
took
 
efãù


726 
xÜ
 
ax
, 
bx
 ; 
Com·»
 
Üigš®
 
©‹m±
 
w™h
 
»suÉ


727 
‹¡
 
ax
, 0x0002 ; 
Check
 
our
 
b™
 
chªge
 
was
 
ignÜed


728 
jz
 
nÙ_v86_mode


730 
mov
 
is_v86_mode
, 1

731 
jmp
 
v86_check_dÚe


733 
nÙ_v86_mode
:

734 
mov
 
is_v86_mode
, 0

736 
v86_check_dÚe
:

739 ià(
is_v86_mode
) {

740 
	`log_šfo
("Environment: V86 mode detected - VDS„ecommended");

742 
	`log_debug
("Environment: Real mode or…rotected mode without V86");

745  
is_v86_mode
;

746 
	}
}

757 
boŞ
 
	$d‘eù_memÜy_mªag”_ty³
(* 
mªag”_Çme
, 
size_t
 
Çme_Ën
) {

758 
boŞ
 
mªag”_d‘eùed
 = 
çl£
;

760 ià(!
mªag”_Çme
 || 
Çme_Ën
 == 0) {

761  
çl£
;

765 
mªag”_Çme
[0] = '\0';

768 
__asm
 {

769 
push
 
ax


770 
push
 
bx


771 
push
 
cx


772 
push
 
dx


773 
push
 
si


774 
push
 
di


775 
push
 
es


777 ; 
Check
 
EMM386
 
usšg
 
INT
 67
	`h
 (
EMS
)

778 
mov
 
ax
, 4000
h
 ; 
EMS
: 
G‘
 
Mªag”
 
Stus


779 67
h


780 
cmp
 
ah
, 0 ; 
Stus
 
OK
?

781 
jÃ
 
check_qemm


783 ; 
EMM386
 
d‘eùed


784 
mov
 
mªag”_d‘eùed
, 1

785 
jmp
 
mªag”_check_dÚe


787 
check_qemm
:

788 ; 
Check
 
QEMM
 
usšg
 
INT
 67
h
 
w™h
 QEMM-
¥ecific
 
funùiÚ


789 
mov
 
ax
, 4001
h
 ; 
QEMM
: 
G‘
 
	`V”siÚ
 (
avaabË
)

790 67
h


791 
cmp
 
ah
, 0

792 
jÃ
 
check_himem


794 ; 
Might
 
be
 
QEMM
 - 
£t
 
æag


795 
mov
 
mªag”_d‘eùed
, 1

796 
jmp
 
mªag”_check_dÚe


798 
check_himem
:

799 ; 
Check
 
HIMEM
.
	`SYS
 (
XMS
 
driv”
)

800 
mov
 
ax
, 4300
h
 ; 
XMS
: 
In¡®ÏtiÚ
 
check


801 2F
h


802 
cmp
 
®
, 80
h
 ; 
XMS
 
š¡®Ëd
?

803 
jÃ
 
mªag”_check_dÚe


805 
mov
 
mªag”_d‘eùed
, 1

807 
mªag”_check_dÚe
:

808 
pİ
 
es


809 
pİ
 
di


810 
pİ
 
si


811 
pİ
 
dx


812 
pİ
 
cx


813 
pİ
 
bx


814 
pİ
 
ax


817 ià(
mªag”_d‘eùed
) {

819 ià(
	`d‘eù_v86_’vœÚm’t
()) {

820 
	`¡ºıy
(
mªag”_Çme
, "EMM386 o¸QEMM", 
Çme_Ën
 - 1);

822 
	`¡ºıy
(
mªag”_Çme
, "HIMEM o¸Ùh” XMS", 
Çme_Ën
 - 1);

824 
mªag”_Çme
[
Çme_Ën
 - 1] = '\0';

826 
	`log_šfo
("MemÜy Mªag”: % d‘eùed", 
mªag”_Çme
);

827  
Œue
;

830 
	`log_debug
("Memory Manager: No specific manager detected");

831  
çl£
;

832 
	}
}

843 
’hªûd_coh”’cy_ª®ysis_t
 
	$³rfÜm_’hªûd_coh”’cy_ª®ysis
(
deviû_ÿps_t
* 
deviû_ÿps
) {

844 
’hªûd_coh”’cy_ª®ysis_t
 
’hªûd_ª®ysis
;

845 
mªag”_Çme
[64];

848 
	`mem£t
(&
’hªûd_ª®ysis
, 0, (
’hªûd_coh”’cy_ª®ysis_t
));

851 
’hªûd_ª®ysis
.
ba£_ª®ysis
 = 
	`³rfÜm_com¶‘e_coh”’cy_ª®ysis
();

853 
	`log_šfo
("Enhanced Coherency: Starting VDS‡ndƒnvironment‡nalysis...");

856 
’hªûd_ª®ysis
.
vds_avaabË
 = 
	`‹¡_vds_avaab™y
();

857 ià(
’hªûd_ª®ysis
.
vds_avaabË
) {

858 
¢oİšg_»suÉ_t
 
vds_¢oİšg
 = 
	`‹¡_vds_funùiÚ®™y
();

859 
’hªûd_ª®ysis
.
vds_suµÜts_ÿche_coh”’cy
 = (
vds_¢oİšg
 =ğ
SNOOPING_FULL
);

860 
’hªûd_ª®ysis
.
vds_suµÜts_sÿ‰”_g©h”
 = 
Œue
;

863 
’hªûd_ª®ysis
.
vds_v”siÚ_majÜ
 = 1;

864 
’hªûd_ª®ysis
.
vds_v”siÚ_mšÜ
 = 0;

868 
’hªûd_ª®ysis
.
ruÂšg_š_v86_mode
 = 
	`d‘eù_v86_’vœÚm’t
();

869 
’hªûd_ª®ysis
.
emm386_d‘eùed
 = 
çl£
;

870 
’hªûd_ª®ysis
.
qemm_d‘eùed
 = 
çl£
;

872 ià(
	`d‘eù_memÜy_mªag”_ty³
(
mªag”_Çme
, (manager_name))) {

873 ià(
	`¡r¡r
(
mªag”_Çme
, "EMM386"è!ğ
NULL
) {

874 
’hªûd_ª®ysis
.
emm386_d‘eùed
 = 
Œue
;

875 } ià(
	`¡r¡r
(
mªag”_Çme
, "QEMM"è!ğ
NULL
) {

876 
’hªûd_ª®ysis
.
qemm_d‘eùed
 = 
Œue
;

881 ià(
deviû_ÿps
) {

882 
’hªûd_ª®ysis
.
vds_»quœed_fÜ_deviû
 = 
deviû_ÿps
->
Ãeds_vds
;

885 ià(
’hªûd_ª®ysis
.
vds_avaabË
 &&ƒnhªûd_ª®ysis.
vds_suµÜts_ÿche_coh”’cy
) {

887 
’hªûd_ª®ysis
.
rx_ÿche_t›r
 = 
CACHE_TIER_3_SOFTWARE
;

888 
’hªûd_ª®ysis
.
tx_ÿche_t›r
 = 
CACHE_TIER_3_SOFTWARE
;

889 } ià(
’hªûd_ª®ysis
.
ba£_ª®ysis
.
£Ëùed_t›r
 =ğ
CACHE_TIER_1_CLFLUSH
) {

891 
’hªûd_ª®ysis
.
rx_ÿche_t›r
 = 
CACHE_TIER_1_CLFLUSH
;

892 
’hªûd_ª®ysis
.
tx_ÿche_t›r
 = 
CACHE_TIER_1_CLFLUSH
;

895 
’hªûd_ª®ysis
.
rx_ÿche_t›r
 =ƒnhªûd_ª®ysis.
ba£_ª®ysis
.
£Ëùed_t›r
;

896 
’hªûd_ª®ysis
.
tx_ÿche_t›r
 =ƒnhªûd_ª®ysis.
ba£_ª®ysis
.
£Ëùed_t›r
;

900 
’hªûd_ª®ysis
.
»quœes_¡agšg
 = (
deviû_ÿps
->
dma_addr_b™s
 == 24) &&

901 !
’hªûd_ª®ysis
.
vds_avaabË
;

902 
’hªûd_ª®ysis
.
´e_lock_rx_bufãrs
 =ƒnhªûd_ª®ysis.
vds_avaabË
 &&

903 
’hªûd_ª®ysis
.
vds_»quœed_fÜ_deviû
;

906 ià(
	`¡r¡r
(
deviû_ÿps
->
deviû_Çme
, "3C905"è!ğ
NULL
) {

907 
’hªûd_ª®ysis
.
»comm’ded_rx_cİyb»ak
 = 1536;

908 
’hªûd_ª®ysis
.
»comm’ded_tx_cİyb»ak
 = 1536;

909 } ià(
	`¡r¡r
(
deviû_ÿps
->
deviû_Çme
, "3C590"è!ğ
NULL
 ||

910 
	`¡r¡r
(
deviû_ÿps
->
deviû_Çme
, "3C595"è!ğ
NULL
) {

911 
’hªûd_ª®ysis
.
»comm’ded_rx_cİyb»ak
 = 736;

912 
’hªûd_ª®ysis
.
»comm’ded_tx_cİyb»ak
 = 736;

913 } ià(
	`¡r¡r
(
deviû_ÿps
->
deviû_Çme
, "3C515"è!ğ
NULL
) {

914 
’hªûd_ª®ysis
.
»comm’ded_rx_cİyb»ak
 = 512;

915 
’hªûd_ª®ysis
.
»comm’ded_tx_cİyb»ak
 = 512;

917 
’hªûd_ª®ysis
.
»comm’ded_rx_cİyb»ak
 = 256;

918 
’hªûd_ª®ysis
.
»comm’ded_tx_cİyb»ak
 = 256;

923 
’hªûd_ª®ysis
.
dma_»lŸb™y_scÜe
 =ƒnhªûd_ª®ysis.
ba£_ª®ysis
.
cÚfid’û
;

924 ià(
’hªûd_ª®ysis
.
vds_avaabË
 &&ƒnhªûd_ª®ysis.
vds_suµÜts_ÿche_coh”’cy
) {

925 
’hªûd_ª®ysis
.
dma_»lŸb™y_scÜe
 = (enhanced_analysis.dma_reliability_score * 110) / 100;

926 ià(
’hªûd_ª®ysis
.
dma_»lŸb™y_scÜe
 > 100)ƒnhanced_analysis.dma_reliability_score = 100;

929 
’hªûd_ª®ysis
.
ÿche_³rfÜmªû_scÜe
 =ƒnhªûd_ª®ysis.
ba£_ª®ysis
.
cÚfid’û
;

930 ià(
’hªûd_ª®ysis
.
ba£_ª®ysis
.
£Ëùed_t›r
 =ğ
CACHE_TIER_1_CLFLUSH
) {

931 
’hªûd_ª®ysis
.
ÿche_³rfÜmªû_scÜe
 = 95;

932 } ià(
’hªûd_ª®ysis
.
ba£_ª®ysis
.
£Ëùed_t›r
 =ğ
CACHE_TIER_2_WBINVD
) {

933 
’hªûd_ª®ysis
.
ÿche_³rfÜmªû_scÜe
 = 80;

937 
	`¢´štf
(
’hªûd_ª®ysis
.
d‘aed_»comm’d©iÚ
,

938 (
’hªûd_ª®ysis
.
d‘aed_»comm’d©iÚ
),

941 
deviû_ÿps
 ? deviû_ÿps->
deviû_Çme
 : "Unknown",

942 
’hªûd_ª®ysis
.
vds_avaabË
 ? "Available" : "Not Available",

943 
’hªûd_ª®ysis
.
ruÂšg_š_v86_mode
 ? "V86" : "Real Mode",

944 
	`g‘_ÿche_t›r_desütiÚ
(
’hªûd_ª®ysis
.
rx_ÿche_t›r
),

945 
	`g‘_ÿche_t›r_desütiÚ
(
’hªûd_ª®ysis
.
tx_ÿche_t›r
),

946 
’hªûd_ª®ysis
.
dma_»lŸb™y_scÜe
,

947 
’hªûd_ª®ysis
.
ÿche_³rfÜmªû_scÜe
,

948 
’hªûd_ª®ysis
.
»quœes_¡agšg
 ? "Required" : "Optional");

950 
	`log_šfo
("Enhªûd Coh”’cy AÇlysi Com¶‘e: %s", 
’hªûd_ª®ysis
.
d‘aed_»comm’d©iÚ
);

952  
’hªûd_ª®ysis
;

953 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/cache_management.c

16 
	~"../šşude/ÿche_mªagem’t.h
"

17 
	~"../šşude/ÿche_coh”’cy.h
"

18 
	~"../šşude/ıu_d‘eù.h
"

19 
	~"../šşude/h¬dw¬e.h
"

20 
	~"../šşude/loggšg.h
"

21 
	~"../šşude/memÜy.h
"

22 
	~<¡ršg.h
>

23 
	~<¡dšt.h
>

26 
ÿche_mªagem’t_cÚfig_t
 
	gÿche_cÚfig
 = {0};

27 
ÿche_t›r_t
 
	gaùive_t›r
 = 
CACHE_TIER_4_FALLBACK
;

28 
boŞ
 
	gÿche_mªagem’t_š™Ÿlized
 = 
çl£
;

31 
ÿche_mªagem’t_m‘rics_t
 
	gm‘rics
 = {0};

34 
size_t
 
	gd‘eùed_ÿche_lše_size
 = 32;

37 
ÿche_t›r1_şæush_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
);

38 
ÿche_t›r2_wbšvd_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
);

39 
ÿche_t›r3_soáw¬e_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
);

40 
ÿche_t›r4_çÎback_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
);

42 
fÜû_ÿche_lše_touch
(*
bufãr
, 
size_t
 
Ëngth
);

43 
memÜy_b¬r›r_šlše
();

44 
io_d–ay_miüo£cÚds
(
ušt32_t
 
miüo£cÚds
);

45 
size_t
 
d‘eù_ÿche_lše_size
();

48 
ÿche_şæush_lše
(*
addr
);

49 
ÿche_wbšvd
();

50 
ušt32_t
 
»ad_ü0_»gi¡”
();

51 
wr™e_ü0_»gi¡”
(
ušt32_t
 
v®ue
);

56 
boŞ
 
	$š™Ÿlize_ÿche_mªagem’t
(cÚ¡ 
coh”’cy_ª®ysis_t
 *
ª®ysis
) {

57 
ıu_šfo_t
 
ıu_šfo
;

59 
	`log_šfo
("Initializing cache management system...");

61 ià(!
ª®ysis
) {

62 
	`log_”rÜ
("Invalid coherency‡nalysis…rovided");

63  
çl£
;

67 
ÿche_cÚfig
.
£Ëùed_t›r
 = 
ª®ysis
->selected_tier;

68 
ÿche_cÚfig
.
cÚfid’û_Ëv–
 = 
ª®ysis
->
cÚfid’û
;

69 
ÿche_cÚfig
.
wr™e_back_ÿche
 = 
ª®ysis
->write_back_cache;

70 
ÿche_cÚfig
.
h¬dw¬e_¢oİšg
 = (
ª®ysis
->
¢oİšg
 =ğ
SNOOPING_FULL
);

73 
ıu_šfo
 = 
	`d‘eù_ıu_šfo
();

74 
ÿche_cÚfig
.
has_şæush
 = 
ıu_šfo
.has_clflush;

75 
ÿche_cÚfig
.
has_wbšvd
 = 
ıu_šfo
.has_wbinvd;

78 
d‘eùed_ÿche_lše_size
 = 
	`d‘eù_ÿche_lše_size
();

79 
ÿche_cÚfig
.
ÿche_lše_size
 = 
d‘eùed_ÿche_lše_size
;

82 
aùive_t›r
 = 
ª®ysis
->
£Ëùed_t›r
;

85 
	`mem£t
(&
m‘rics
, 0, (metrics));

86 
m‘rics
.
š™Ÿliz©iÚ_time
 = 
	`g‘_cu¼’t_time¡amp
();

88 
ÿche_mªagem’t_š™Ÿlized
 = 
Œue
;

90 
	`log_šfo
("Cache management initialized: %s",

91 
	`g‘_ÿche_t›r_desütiÚ
(
aùive_t›r
));

92 
	`log_šfo
("Cachlšsize: %u by‹s", 
d‘eùed_ÿche_lše_size
);

94  
Œue
;

95 
	}
}

100 
	$ÿche_mªagem’t_dma_´•¬e
(*
bufãr
, 
size_t
 
Ëngth
) {

101 
ušt32_t
 
¡¬t_time
;

103 ià(!
ÿche_mªagem’t_š™Ÿlized
) {

104 
	`log_w¬nšg
("Cache management‚ot initialized - using fallback");

105 
aùive_t›r
 = 
CACHE_TIER_4_FALLBACK
;

108 ià(!
bufãr
 || 
Ëngth
 == 0) {

109 
	`log_”rÜ
("Invalid buffer…arameters for cache management");

114 
¡¬t_time
 = 
	`g‘_cu¼’t_time¡amp
();

117 
aùive_t›r
) {

118 
CACHE_TIER_1_CLFLUSH
:

119 
	`ÿche_t›r1_şæush_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_PRE_DMA
);

120 
m‘rics
.
t›r1_İ”©iÚs
++;

123 
CACHE_TIER_2_WBINVD
:

124 
	`ÿche_t›r2_wbšvd_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_PRE_DMA
);

125 
m‘rics
.
t›r2_İ”©iÚs
++;

128 
CACHE_TIER_3_SOFTWARE
:

129 
	`ÿche_t›r3_soáw¬e_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_PRE_DMA
);

130 
m‘rics
.
t›r3_İ”©iÚs
++;

133 
CACHE_TIER_4_FALLBACK
:

134 
	`ÿche_t›r4_çÎback_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_PRE_DMA
);

135 
m‘rics
.
t›r4_İ”©iÚs
++;

138 
TIER_DISABLE_BUS_MASTER
:

141 
m‘rics
.
di§bËd_İ”©iÚs
++;

146 
m‘rics
.
tÙ®_İ”©iÚs
++;

147 
m‘rics
.
tÙ®_ov”h—d_miüo£cÚds
 +ğ(
	`g‘_cu¼’t_time¡amp
(è- 
¡¬t_time
);

149 
	`log_debug
("Cach´•¬e: %u by‹s,›¸%d", 
Ëngth
, 
aùive_t›r
);

150 
	}
}

155 
	$ÿche_mªagem’t_dma_com¶‘e
(*
bufãr
, 
size_t
 
Ëngth
) {

156 
ušt32_t
 
¡¬t_time
;

158 ià(!
ÿche_mªagem’t_š™Ÿlized
 || 
aùive_t›r
 =ğ
TIER_DISABLE_BUS_MASTER
) {

162 ià(!
bufãr
 || 
Ëngth
 == 0) {

166 
¡¬t_time
 = 
	`g‘_cu¼’t_time¡amp
();

169 
aùive_t›r
) {

170 
CACHE_TIER_1_CLFLUSH
:

171 
	`ÿche_t›r1_şæush_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_POST_DMA
);

174 
CACHE_TIER_2_WBINVD
:

175 
	`ÿche_t›r2_wbšvd_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_POST_DMA
);

178 
CACHE_TIER_3_SOFTWARE
:

179 
	`ÿche_t›r3_soáw¬e_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_POST_DMA
);

182 
CACHE_TIER_4_FALLBACK
:

183 
	`ÿche_t›r4_çÎback_mªagem’t
(
bufãr
, 
Ëngth
, 
CACHE_OPERATION_POST_DMA
);

187 
m‘rics
.
tÙ®_ov”h—d_miüo£cÚds
 +ğ(
	`g‘_cu¼’t_time¡amp
(è- 
¡¬t_time
);

189 
	`log_debug
("Cachcom¶‘e: %u by‹s,›¸%d", 
Ëngth
, 
aùive_t›r
);

190 
	}
}

195 
	$ÿche_t›r1_şæush_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
) {

196 
ušt8_t
 *
±r
 = (ušt8_t*)
bufãr
;

197 
ušt8_t
 *
’d
 = 
±r
 + 
Ëngth
;

198 
size_t
 
ÿche_lše_size
 = 
ÿche_cÚfig
.cache_line_size;

200 ià(!
ÿche_cÚfig
.
has_şæush
) {

201 
	`log_”rÜ
("CLFLUSH‚ot‡vailable - falling backo Tier 2");

202 
	`ÿche_t›r2_wbšvd_mªagem’t
(
bufãr
, 
Ëngth
, 
İ”©iÚ
);

207 
±r
 = (
ušt8_t
*)((
ušŒ_t
íŒ & ~(
ÿche_lše_size
 - 1));

209 ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_PRE_DMA
) {

211 
±r
 < 
’d
) {

212 
	`ÿche_şæush_lše
(
±r
);

213 
±r
 +ğ
ÿche_lše_size
;

215 
	`memÜy_b¬r›r_šlše
();

217 } ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_POST_DMA
) {

219 
±r
 < 
’d
) {

220 
	`ÿche_şæush_lše
(
±r
);

221 
±r
 +ğ
ÿche_lše_size
;

223 
	`memÜy_b¬r›r_šlše
();

226 
	`log_debug
("CLFLUSH: %u cache†ines…rocessed",

227 (
Ëngth
 + 
ÿche_lše_size
 - 1) / cache_line_size);

228 
	}
}

233 
	$ÿche_t›r2_wbšvd_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
) {

234 
ušt32_t
 
Ï¡_wbšvd_time
 = 0;

235 
ušt32_t
 
wbšvd_b©ch_couÁ
 = 0;

236 
ušt32_t
 
cu¼’t_time
 = 
	`g‘_cu¼’t_time¡amp
();

237 
ıu_šfo_t
 
ıu_šfo
 = 
	`d‘eù_ıu_šfo
();

240 ià(
ıu_šfo
.
š_v86_mode
) {

241 
	`log_debug
("WBINVD: Cannotƒxecute in V86 mode - using software barriers");

242 
	`ÿche_t›r3_soáw¬e_mªagem’t
(
bufãr
, 
Ëngth
, 
İ”©iÚ
);

246 ià(!
ÿche_cÚfig
.
has_wbšvd
) {

247 
	`log_”rÜ
("WBINVD‚ot‡vailable - falling backo Tier 3");

248 
	`ÿche_t›r3_soáw¬e_mªagem’t
(
bufãr
, 
Ëngth
, 
İ”©iÚ
);

253 ià(
cu¼’t_time
 - 
Ï¡_wbšvd_time
 < 1000) {

254 
wbšvd_b©ch_couÁ
++;

255 ià(
wbšvd_b©ch_couÁ
 < 4) {

257 
	`log_debug
("WBINVD: Batching optimization - skipping operation");

262 ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_PRE_DMA
) {

264 
	`memÜy_b¬r›r_šlše
();

265 
	`ÿche_wbšvd
();

266 
	`memÜy_b¬r›r_šlše
();

268 } ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_POST_DMA
) {

270 
	`ÿche_wbšvd
();

271 
	`memÜy_b¬r›r_šlše
();

274 
Ï¡_wbšvd_time
 = 
cu¼’t_time
;

275 
wbšvd_b©ch_couÁ
 = 0;

277 
	`log_debug
("WBINVD: Complete cache flush/invalidate");

278 
	}
}

283 
	$ÿche_t›r3_soáw¬e_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
) {

284 ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_PRE_DMA
) {

286 
	`fÜû_ÿche_lše_touch
(
bufãr
, 
Ëngth
);

287 
	`memÜy_b¬r›r_šlše
();

288 
	`io_d–ay_miüo£cÚds
(10);

290 } ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_POST_DMA
) {

292 
	`fÜû_ÿche_lše_touch
(
bufãr
, 
Ëngth
);

293 
	`memÜy_b¬r›r_šlše
();

294 
	`io_d–ay_miüo£cÚds
(5);

297 
	`log_debug
("Soáw¬ÿchmªagem’t: %u by‹ touched", 
Ëngth
);

298 
	}
}

303 
	$ÿche_t›r4_çÎback_mªagem’t
(*
bufãr
, 
size_t
 
Ëngth
, 
ÿche_İ”©iÚ_t
 
İ”©iÚ
) {

305 
	`memÜy_b¬r›r_šlše
();

307 ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_PRE_DMA
) {

308 
	`io_d–ay_miüo£cÚds
(20);

309 } ià(
İ”©iÚ
 =ğ
CACHE_OPERATION_POST_DMA
) {

310 
	`io_d–ay_miüo£cÚds
(15);

313 
	`log_debug
("Fallback cache management: Conservative delays‡pplied");

314 
	}
}

319 
	$fÜû_ÿche_lše_touch
(*
bufãr
, 
size_t
 
Ëngth
) {

320 vŞ©
ušt8_t
 *
±r
 = (vŞ©ušt8_t*)
bufãr
;

321 vŞ©
ušt8_t
 *
’d
 = 
±r
 + 
Ëngth
;

322 
size_t
 
ÿche_lše_size
 = 
ÿche_cÚfig
.cache_line_size;

323 vŞ©
ušt8_t
 
dummy
;

326 
±r
 < 
’d
) {

327 
dummy
 = *
±r
;

328 
±r
 +ğ
ÿche_lše_size
;

332 ()
dummy
;

333 
	}
}

338 
	$memÜy_b¬r›r_šlše
() {

340 
__asm__
 volatile ("" ::: "memory");

343 ià(
ÿche_cÚfig
.
has_wbšvd
) {

344 
__asm__
 volatile (

352 
	}
}

357 
	$io_d–ay_miüo£cÚds
(
ušt32_t
 
miüo£cÚds
) {

359 vŞ©
ušt32_t
 
i
 = 0; i < 
miüo£cÚds
 * 100; i++) {

361 
__asm__
 volatile ("inb $0x80, %%al" ::: "al");

363 
	}
}

368 
size_t
 
	$d‘eù_ÿche_lše_size
() {

369 
ıu_šfo_t
 
ıu_šfo
 = 
	`d‘eù_ıu_šfo
();

372 ià(
ıu_šfo
.
has_ıuid
 && cpu_šfo.
ÿche_lše_size
 > 0) {

373  
ıu_šfo
.
ÿche_lše_size
;

377 ià(
ıu_šfo
.
çmy
 >= 6) {

379 } ià(
ıu_šfo
.
çmy
 == 5) {

381 } ià(
ıu_šfo
.
çmy
 == 4) {

386 
	}
}

391 
ÿche_mªagem’t_cÚfig_t
 
	$g‘_ÿche_mªagem’t_cÚfig
() {

392  
ÿche_cÚfig
;

393 
	}
}

398 
ÿche_mªagem’t_m‘rics_t
 
	$g‘_ÿche_mªagem’t_m‘rics
() {

400 ià(
m‘rics
.
tÙ®_İ”©iÚs
 > 0) {

401 
m‘rics
.
av”age_ov”h—d_miüo£cÚds
 =

402 
m‘rics
.
tÙ®_ov”h—d_miüo£cÚds
 / m‘rics.
tÙ®_İ”©iÚs
;

405  
m‘rics
;

406 
	}
}

411 
boŞ
 
	$ÿche_mªagem’t_»quœed
() {

412  (
aùive_t›r
 !ğ
CACHE_TIER_4_FALLBACK
 &&

413 
aùive_t›r
 !ğ
TIER_DISABLE_BUS_MASTER
);

414 
	}
}

419 
boŞ
 
	$upd©e_ÿche_mªagem’t_cÚfig
(cÚ¡ 
ÿche_mªagem’t_cÚfig_t
 *
Ãw_cÚfig
) {

420 ià(!
Ãw_cÚfig
) {

421  
çl£
;

425 ià(
Ãw_cÚfig
->
£Ëùed_t›r
 < 
TIER_DISABLE_BUS_MASTER
 ||

426 
Ãw_cÚfig
->
£Ëùed_t›r
 > 
CACHE_TIER_4_FALLBACK
) {

427 
	`log_”rÜ
("Invalid cacheier in‚ew configuration");

428  
çl£
;

432 
ÿche_cÚfig
 = *
Ãw_cÚfig
;

433 
aùive_t›r
 = 
Ãw_cÚfig
->
£Ëùed_t›r
;

435 
	`log_šfo
("Cachmªagem’ˆcÚfigu¿tiÚ upd©edØt›¸%d", 
aùive_t›r
);

436  
Œue
;

437 
	}
}

442 
	$»£t_ÿche_mªagem’t_m‘rics
() {

443 
	`mem£t
(&
m‘rics
, 0, (metrics));

444 
m‘rics
.
š™Ÿliz©iÚ_time
 = 
	`g‘_cu¼’t_time¡amp
();

445 
	`log_debug
("Cache management metrics„eset");

446 
	}
}

451 
	$´št_ÿche_mªagem’t_¡©us
() {

452 
ÿche_mªagem’t_m‘rics_t
 
cu¼’t_m‘rics
 = 
	`g‘_ÿche_mªagem’t_m‘rics
();

454 
	`´štf
("\n=== Cache Management Status ===\n");

455 
	`´štf
("AùivT›r: %s\n", 
	`g‘_ÿche_t›r_desütiÚ
(
aùive_t›r
));

456 
	`´štf
("CachLšSize: %u by‹s\n", 
ÿche_cÚfig
.
ÿche_lše_size
);

457 
	`´štf
("Wr™e-Back Cache: %s\n", 
ÿche_cÚfig
.
wr™e_back_ÿche
 ? "Yes" : "No");

458 
	`´štf
("H¬dw¬Snoİšg: %s\n", 
ÿche_cÚfig
.
h¬dw¬e_¢oİšg
 ? "Yes" : "No");

459 
	`´štf
("CÚfid’û Lev–: %u%%\n", 
ÿche_cÚfig
.
cÚfid’û_Ëv–
);

461 
	`´štf
("\nPerformance Metrics:\n");

462 
	`´štf
("TÙ® O³¿tiÚs: %u\n", 
cu¼’t_m‘rics
.
tÙ®_İ”©iÚs
);

463 
	`´štf
("Av”agOv”h—d: %u miüo£cÚds\n", 
cu¼’t_m‘rics
.
av”age_ov”h—d_miüo£cÚds
);

464 
	`´štf
("T›¸1 O³¿tiÚs: %u\n", 
cu¼’t_m‘rics
.
t›r1_İ”©iÚs
);

465 
	`´štf
("T›¸2 O³¿tiÚs: %u\n", 
cu¼’t_m‘rics
.
t›r2_İ”©iÚs
);

466 
	`´štf
("T›¸3 O³¿tiÚs: %u\n", 
cu¼’t_m‘rics
.
t›r3_İ”©iÚs
);

467 
	`´štf
("T›¸4 O³¿tiÚs: %u\n", 
cu¼’t_m‘rics
.
t›r4_İ”©iÚs
);

468 
	`´štf
("==============================\n");

469 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/dma.c

21 
	~"../šşude/dma.h
"

22 
	~"../šşude/loggšg.h
"

23 
	~"../šşude/”rÜ_hªdlšg.h
"

24 
	~"../šşude/ıu_d‘eù.h
"

25 
	~"../šşude/memÜy.h
"

26 
	~<¡ršg.h
>

27 
	~<dos.h
>

30 
dma_mªag”_t
 
	gg_dma_mªag”
 = {0};

33 
ušt32_t
 
g‘_cÚv’tiÚ®_phys_addr
(*
vœt_addr
);

34 
£tup_coh”’cy_mªagem’t
();

35 
š™_add»ss_Œª¦©iÚ
();

36 
dma_£t_”rÜ
(
ušt8_t
 
nic_šdex
, 
dma_”rÜ_t
 
”rÜ
);

37 
dma_”rÜ_t
 
dma_g‘_nic_”rÜ
(
ušt8_t
 
nic_šdex
);

38 
v®id©e_dma_·¿m‘”s
(*
addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
);

39 
®loÿ‹_coh”’t_poŞ
();

40 
ş—nup_coh”’t_poŞ
();

43 
dma_3c515_£tup_Œªsãr_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 
dœeùiÚ
);

44 
dma_3c515_¡¬t_Œªsãr_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
);

45 
dma_3c515_¡İ_Œªsãr_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
);

46 
dma_3c515_g‘_¡©us_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
);

48 
dma_3c509b_çÎback_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 
dœeùiÚ
);

53 
	$dma_š™
() {

54 
»suÉ
;

56 ià(
g_dma_mªag”
.
š™Ÿlized
) {

57 
	`LOG_WARNING
("DMA manager‡lready initialized");

61 
	`LOG_INFO
("Initializing DMA subsystem for scatter-gather operations");

64 
	`mem£t
(&
g_dma_mªag”
, 0, (
dma_mªag”_t
));

67 
»suÉ
 = 
	`š™_add»ss_Œª¦©iÚ
();

68 ià(
»suÉ
 != 0) {

69 
	`LOG_ERROR
("FaedØš™Ÿlizadd»s Œª¦©iÚ: %d", 
»suÉ
);

70  
»suÉ
;

74 
»suÉ
 = 
	`£tup_coh”’cy_mªagem’t
();

75 ià(
»suÉ
 != 0) {

76 
	`LOG_ERROR
("FaedØ£tu°coh”’cy mªagem’t: %d", 
»suÉ
);

77  
»suÉ
;

81 ià(
	`xms_is_avaabË
()) {

82 
g_dma_mªag”
.
xms_avaabË
 = 
Œue
;

83 
»suÉ
 = 
	`dma_š™_xms_»giÚ
(64);

84 ià(
»suÉ
 != 0) {

85 
	`LOG_WARNING
("FaedØš™ŸlizXMS DMA„egiÚ: %d", 
»suÉ
);

86 
g_dma_mªag”
.
xms_avaabË
 = 
çl£
;

88 
	`LOG_INFO
("XMS DMA„egion initialized successfully");

91 
	`LOG_INFO
("XMS‚ot‡vailable, using conventional memory only");

92 
g_dma_mªag”
.
xms_avaabË
 = 
çl£
;

96 
»suÉ
 = 
	`®loÿ‹_coh”’t_poŞ
();

97 ià(
»suÉ
 != 0) {

98 
	`LOG_WARNING
("FaedØ®loÿ‹ coh”’ˆmemÜy…oŞ: %d", 
»suÉ
);

103 
i
 = 0; i < 
MAX_NICS
; i++) {

104 
	`mem£t
(&
g_dma_mªag”
.
nic_cÚ‹xts
[
i
], 0, (
dma_nic_cÚ‹xt_t
));

105 
g_dma_mªag”
.
nic_cÚ‹xts
[
i
].
nic_ty³
 = 0;

108 
g_dma_mªag”
.
š™Ÿlized
 = 
Œue
;

110 
	`LOG_INFO
("DMA subsystem initialized successfully");

111 
	`LOG_INFO
(" XMS‡vaabË: %s", 
g_dma_mªag”
.
xms_avaabË
 ? "Yes" : "No");

112 
	`LOG_INFO
(" Coh”’ˆpoŞ: %s", 
g_dma_mªag”
.
coh”’t_poŞ
 ? "Yes" : "No");

113 
	`LOG_INFO
(" Cachcoh”’t: %s", 
g_dma_mªag”
.
coh”’cy
.
ÿche_coh”’t_dma
 ? "Yes" : "No");

116 
	}
}

121 
	$dma_ş—nup
() {

122 ià(!
g_dma_mªag”
.
š™Ÿlized
) {

126 
	`LOG_INFO
("Cleaning up DMA subsystem");

129 
i
 = 0; i < 
MAX_NICS
; i++) {

130 ià(
g_dma_mªag”
.
nic_cÚ‹xts
[
i
].
nic_ty³
 != 0) {

131 
	`dma_ş—nup_nic_cÚ‹xt
(
i
);

136 
	`ş—nup_coh”’t_poŞ
();

139 ià(
g_dma_mªag”
.
xms_avaabË
 && g_dma_mªag”.
xms_dma_hªdË
 != 0) {

140 
	`xms_ä“
(
g_dma_mªag”
.
xms_dma_hªdË
);

141 
g_dma_mªag”
.
xms_dma_hªdË
 = 0;

145 
	`LOG_INFO
("DMA subsystem statistics:");

146 
	`LOG_INFO
(" TÙ® m­pšgs: %u", 
g_dma_mªag”
.
tÙ®_m­pšgs
);

147 
	`LOG_INFO
(" M­pšg fau»s: %u", 
g_dma_mªag”
.
m­pšg_çu»s
);

148 
	`LOG_INFO
(" Coh”’cy viŞ©iÚs: %u", 
g_dma_mªag”
.
coh”’cy_viŞ©iÚs
);

150 
g_dma_mªag”
.
š™Ÿlized
 = 
çl£
;

152 
	`LOG_INFO
("DMA subsystem cleanup completed");

153 
	}
}

158 
	$dma_š™_nic_cÚ‹xt
(
ušt8_t
 
nic_šdex
, 
ušt16_t
 
nic_ty³
, ušt16_ˆ
io_ba£
,

159 
’hªûd_ršg_cÚ‹xt_t
 *
ršg_cÚ‹xt
) {

160 
dma_nic_cÚ‹xt_t
 *
ùx
;

161 
»suÉ
;

163 ià(
nic_šdex
 >ğ
MAX_NICS
) {

164 
	`LOG_ERROR
("Inv®id NIC index: %d", 
nic_šdex
);

165  -
DMA_ERROR_INVALID_PARAM
;

168 ià(!
g_dma_mªag”
.
š™Ÿlized
) {

169 
	`LOG_ERROR
("DMA manager‚ot initialized");

170  -
DMA_ERROR_INVALID_PARAM
;

173 
ùx
 = &
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
];

176 
	`mem£t
(
ùx
, 0, (
dma_nic_cÚ‹xt_t
));

179 
ùx
->
nic_ty³
 =‚ic_type;

180 
ùx
->
io_ba£
 = io_base;

181 
ùx
->
ršg_cÚ‹xt
 =„ing_context;

183 
	`LOG_INFO
("In™Ÿlizšg DMA cÚ‹xˆfÜ NIC %d (ty³: 0x%04X)", 
nic_šdex
, 
nic_ty³
);

186 
nic_ty³
) {

188 
ùx
->
dma_ÿ·b™›s
 = 
DMA_CAP_BASIC_BUSMASTER
;

189 
ùx
->
max_dma_add»ss
 = 0xFFFF;

190 
ùx
->
max_sg_äagm’ts
 = 
DMA_MAX_FRAGMENTS_3C515
;

191 
ùx
->
mš_®ignm’t
 = 
DMA_MIN_ALIGNMENT
;

192 
ùx
->
max_Œªsãr_size
 = 
DMA_MAX_TRANSFER_SIZE
;

195 
ùx
->
£tup_dma_Œªsãr
 = 
dma_3c515_£tup_Œªsãr_im¶
;

196 
ùx
->
¡¬t_dma_Œªsãr
 = 
dma_3c515_¡¬t_Œªsãr_im¶
;

197 
ùx
->
¡İ_dma_Œªsãr
 = 
dma_3c515_¡İ_Œªsãr_im¶
;

198 
ùx
->
g‘_dma_¡©us
 = 
dma_3c515_g‘_¡©us_im¶
;

200 
	`LOG_INFO
(" 3C515-TX: Basic bus mastering DMAƒnabled");

204 
ùx
->
dma_ÿ·b™›s
 = 
DMA_CAP_NONE
;

205 
ùx
->
max_dma_add»ss
 = 0;

206 
ùx
->
max_sg_äagm’ts
 = 
DMA_MAX_FRAGMENTS_3C509B
;

207 
ùx
->
mš_®ignm’t
 = 1;

208 
ùx
->
max_Œªsãr_size
 = 
DMA_MAX_TRANSFER_SIZE
;

211 
ùx
->
£tup_dma_Œªsãr
 = 
dma_3c509b_çÎback_im¶
;

212 
ùx
->
¡¬t_dma_Œªsãr
 = 
NULL
;

213 
ùx
->
¡İ_dma_Œªsãr
 = 
NULL
;

214 
ùx
->
g‘_dma_¡©us
 = 
NULL
;

216 
	`LOG_INFO
(" 3C509B: PIO mode only,‚o DMA support");

220 
	`LOG_ERROR
("UnknowÀNICy³: 0x%04X", 
nic_ty³
);

221  -
DMA_ERROR_UNSUPPORTED_OPERATION
;

225 ià(
ùx
->
dma_ÿ·b™›s
 & 
DMA_CAP_BASIC_BUSMASTER
) {

227 
»suÉ
 = 
	`dma_poŞ_š™
(&
ùx
->
tx_poŞ
, 
DMA_DEFAULT_TX_POOL_SIZE
, 
DMA_MAX_TRANSFER_SIZE
,

228 
DMA_MEMORY_CONVENTIONAL
, 
ùx
->
mš_®ignm’t
);

229 ià(
»suÉ
 != 0) {

230 
	`LOG_ERROR
("FaedØš™ŸlizTX DMA…oŞ: %d", 
»suÉ
);

231  
»suÉ
;

235 
»suÉ
 = 
	`dma_poŞ_š™
(&
ùx
->
rx_poŞ
, 
DMA_DEFAULT_RX_POOL_SIZE
, 
DMA_MAX_TRANSFER_SIZE
,

236 
DMA_MEMORY_CONVENTIONAL
, 
ùx
->
mš_®ignm’t
);

237 ià(
»suÉ
 != 0) {

238 
	`LOG_ERROR
("FaedØš™ŸlizRX DMA…oŞ: %d", 
»suÉ
);

239 
	`dma_poŞ_ş—nup
(&
ùx
->
tx_poŞ
);

240  
»suÉ
;

243 
	`LOG_INFO
(" DMA buffer…ools initialized (TX: %d, RX: %d buffers)",

244 
DMA_DEFAULT_TX_POOL_SIZE
, 
DMA_DEFAULT_RX_POOL_SIZE
);

247 
	`LOG_INFO
("NIC %d DMA cÚ‹xˆš™Ÿlized sucûssfuÎy", 
nic_šdex
);

250 
	}
}

255 
	$dma_ş—nup_nic_cÚ‹xt
(
ušt8_t
 
nic_šdex
) {

256 
dma_nic_cÚ‹xt_t
 *
ùx
;

258 ià(
nic_šdex
 >ğ
MAX_NICS
) {

262 
ùx
 = &
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
];

264 ià(
ùx
->
nic_ty³
 == 0) {

268 
	`LOG_INFO
("CËªšg u°DMA cÚ‹xˆfÜ NIC %d", 
nic_šdex
);

271 ià(
ùx
->
sg_cÚsŞid©iÚs
 > 0 || ctx->
z”o_cİy_Œªsãrs
 > 0 || ctx->
dma_”rÜs
 > 0) {

272 
	`LOG_INFO
(" NIC %d DMA sti¡ics:", 
nic_šdex
);

273 
	`LOG_INFO
(" SG cÚsŞid©iÚs: %u", 
ùx
->
sg_cÚsŞid©iÚs
);

274 
	`LOG_INFO
(" Z”o-cİy¿nsãrs: %u", 
ùx
->
z”o_cİy_Œªsãrs
);

275 
	`LOG_INFO
(" F®lback¿nsãrs: %u", 
ùx
->
çÎback_Œªsãrs
);

276 
	`LOG_INFO
(" DMAƒ¼Üs: %u", 
ùx
->
dma_”rÜs
);

280 ià(
ùx
->
dma_ÿ·b™›s
 & 
DMA_CAP_BASIC_BUSMASTER
) {

281 
	`dma_poŞ_ş—nup
(&
ùx
->
tx_poŞ
);

282 
	`dma_poŞ_ş—nup
(&
ùx
->
rx_poŞ
);

286 
	`mem£t
(
ùx
, 0, (
dma_nic_cÚ‹xt_t
));

288 
	`LOG_DEBUG
("NIC %d DMA cÚ‹xˆş—nu°com¶‘ed", 
nic_šdex
);

289 
	}
}

294 
ušt32_t
 
	$dma_vœt_to_phys
(*
vœt_addr
) {

295 ià(!
vœt_addr
) {

299 ià(!
g_dma_mªag”
.
š™Ÿlized
) {

300 
	`LOG_ERROR
("DMA manager‚ot initialized");

305 ià(
g_dma_mªag”
.
vœt_to_phys
) {

306  
g_dma_mªag”
.
	`vœt_to_phys
(
vœt_addr
);

310  
	`g‘_cÚv’tiÚ®_phys_addr
(
vœt_addr
);

311 
	}
}

316 * 
	$dma_phys_to_vœt
(
ušt32_t
 
phys_addr
) {

317 ià(
phys_addr
 == 0) {

318  
NULL
;

321 ià(!
g_dma_mªag”
.
š™Ÿlized
) {

322 
	`LOG_ERROR
("DMA manager‚ot initialized");

323  
NULL
;

327 ià(
g_dma_mªag”
.
phys_to_vœt
) {

328  
g_dma_mªag”
.
	`phys_to_vœt
(
phys_addr
);

332 ià(
phys_addr
 < 0x100000) {

333  (*)
phys_addr
;

336  
NULL
;

337 
	}
}

342 
	$dma_m­_memÜy
(*
vœt_addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
, 
dma_m­pšg_t
 *
m­pšg
) {

343 
ušt32_t
 
phys_addr
;

345 ià(!
m­pšg
 || !
vœt_addr
 || 
size
 == 0) {

346  -
DMA_ERROR_INVALID_PARAM
;

349 ià(!
g_dma_mªag”
.
š™Ÿlized
) {

350  -
DMA_ERROR_INVALID_PARAM
;

354 
»suÉ
 = 
	`v®id©e_dma_·¿m‘”s
(
vœt_addr
, 
size
, 
dœeùiÚ
);

355 ià(
»suÉ
 != 0) {

356  
»suÉ
;

360 
	`mem£t
(
m­pšg
, 0, (
dma_m­pšg_t
));

363 
phys_addr
 = 
	`dma_vœt_to_phys
(
vœt_addr
);

364 ià(
phys_addr
 == 0) {

365 
	`LOG_ERROR
("FaedØg‘…hysiÿÈadd»s fÜ vœtu®‡dd»s %p", 
vœt_addr
);

366 
g_dma_mªag”
.
m­pšg_çu»s
++;

367  -
DMA_ERROR_MAPPING_FAILED
;

371 
m­pšg
->
vœtu®_addr
 = 
vœt_addr
;

372 
m­pšg
->
physiÿl_addr
 = 
phys_addr
;

373 
m­pšg
->
size
 = size;

374 
m­pšg
->
memÜy_ty³
 = 
DMA_MEMORY_CONVENTIONAL
;

375 
m­pšg
->
æags
 = 0;

376 
m­pšg
->
»f_couÁ
 = 1;

379 ià((
ušt32_t
)
vœt_addr
 < 0xA0000) {

380 
m­pšg
->
memÜy_ty³
 = 
DMA_MEMORY_CONVENTIONAL
;

381 
m­pšg
->
æags
 |ğ
DMA_MAP_COHERENT
;

384 
m­pšg
->
memÜy_ty³
 = 
DMA_MEMORY_XMS
;

385 
m­pšg
->
æags
 |ğ
DMA_MAP_CACHED
;

389 ià((
phys_addr
 & (
DMA_MIN_ALIGNMENT
 - 1)) != 0) {

390 
	`LOG_WARNING
("DMA m­pšg‚Ù…rİ”ly‡ligÃd:…hys=0x%08X", 
phys_addr
);

394 ià(
dœeùiÚ
 & 
DMA_DIRECTION_TO_DEVICE
) {

395 
	`dma_sync_fÜ_deviû
(
vœt_addr
, 
size
, 
dœeùiÚ
);

398 
g_dma_mªag”
.
tÙ®_m­pšgs
++;

399 
g_dma_mªag”
.
aùive_m­pšgs
++;

401 
	`LOG_TRACE
("DMA mapping created: virt=%p,…hys=0x%08X, size=%u",

402 
vœt_addr
, 
phys_addr
, 
size
);

405 
	}
}

410 
	$dma_unm­_memÜy
(
dma_m­pšg_t
 *
m­pšg
) {

411 ià(!
m­pšg
 || m­pšg->
»f_couÁ
 == 0) {

415 
m­pšg
->
»f_couÁ
--;

417 ià(
m­pšg
->
»f_couÁ
 == 0) {

419 ià(
m­pšg
->
æags
 & 
DMA_MAP_CACHED
) {

420 
	`dma_sync_fÜ_ıu
(
m­pšg
->
vœtu®_addr
, m­pšg->
size
, 
DMA_DIRECTION_FROM_DEVICE
);

424 ià(
m­pšg
->
memÜy_ty³
 =ğ
DMA_MEMORY_XMS
 &&

425 (
m­pšg
->
æags
 & 
DMA_MAP_XMS_LOCKED
) &&

426 
m­pšg
->
xms_hªdË
 != 0) {

427 
	`xms_uÆock
(
m­pšg
->
xms_hªdË
);

430 
g_dma_mªag”
.
aùive_m­pšgs
--;

432 
	`LOG_TRACE
("DMA mapping unmapped: virt=%p,…hys=0x%08X",

433 
m­pšg
->
vœtu®_addr
, m­pšg->
physiÿl_addr
);

436 
	`mem£t
(
m­pšg
, 0, (
dma_m­pšg_t
));

438 
	}
}

443 
	$dma_š™_xms_»giÚ
(
ušt32_t
 
size_kb
) {

444 
»suÉ
;

445 
ušt32_t
 
lš—r_addr
;

447 ià(!
g_dma_mªag”
.
xms_avaabË
) {

448  -
DMA_ERROR_XMS_UNAVAILABLE
;

451 
	`LOG_INFO
("In™Ÿlizšg XMS DMA„egiÚ (%u KB)", 
size_kb
);

454 
»suÉ
 = 
	`xms_®loÿ‹
(
size_kb
, &
g_dma_mªag”
.
xms_dma_hªdË
);

455 ià(
»suÉ
 !ğ
XMS_SUCCESS
) {

456 
	`LOG_ERROR
("FaedØ®loÿ‹ XMS memÜy: %d", 
»suÉ
);

457  -
DMA_ERROR_XMS_UNAVAILABLE
;

461 
»suÉ
 = 
	`xms_lock
(
g_dma_mªag”
.
xms_dma_hªdË
, &
lš—r_addr
);

462 ià(
»suÉ
 !ğ
XMS_SUCCESS
) {

463 
	`LOG_ERROR
("FaedØlock XMS memÜy: %d", 
»suÉ
);

464 
	`xms_ä“
(
g_dma_mªag”
.
xms_dma_hªdË
);

465 
g_dma_mªag”
.
xms_dma_hªdË
 = 0;

466  -
DMA_ERROR_XMS_UNAVAILABLE
;

469 
g_dma_mªag”
.
xms_dma_ba£
 = 
lš—r_addr
;

471 
	`LOG_INFO
("XMS DMA„egion‡llocated: handle=%u, base=0x%08X",

472 
g_dma_mªag”
.
xms_dma_hªdË
, g_dma_mªag”.
xms_dma_ba£
);

475 
	}
}

480 
dma_sg_li¡_t
* 
	$dma_sg_®loc
(
ušt16_t
 
max_äagm’ts
) {

481 
dma_sg_li¡_t
 *
sg_li¡
;

483 ià(
max_äagm’ts
 == 0 || max_fragments > 64) {

484  
NULL
;

488 
sg_li¡
 = (
dma_sg_li¡_t
*)
	`memÜy_®loc
((dma_sg_li¡_t), 
MEM_TYPE_DMA_BUFFER
, 
MEM_FLAG_ZERO
);

489 ià(!
sg_li¡
) {

490  
NULL
;

494 
sg_li¡
->
äagm’ts
 = (
dma_äagm’t_t
*)
	`memÜy_®loc
(

495 
max_äagm’ts
 * (
dma_äagm’t_t
), 
MEM_TYPE_DMA_BUFFER
, 
MEM_FLAG_ZERO
);

496 ià(!
sg_li¡
->
äagm’ts
) {

497 
	`memÜy_ä“
(
sg_li¡
);

498  
NULL
;

501 
sg_li¡
->
max_äagm’ts
 = max_fragments;

502 
sg_li¡
->
äagm’t_couÁ
 = 0;

503 
sg_li¡
->
tÙ®_Ëngth
 = 0;

504 
sg_li¡
->
æags
 = 0;

505 
sg_li¡
->
´iv©e_d©a
 = 
NULL
;

507 
	`LOG_TRACE
("SG†i¡‡Îoÿ‹d: max_äagm’ts=%u", 
max_äagm’ts
);

509  
sg_li¡
;

510 
	}
}

515 
	$dma_sg_ä“
(
dma_sg_li¡_t
 *
sg_li¡
) {

516 ià(!
sg_li¡
) {

520 ià(
sg_li¡
->
äagm’ts
) {

521 
	`memÜy_ä“
(
sg_li¡
->
äagm’ts
);

524 
	`memÜy_ä“
(
sg_li¡
);

526 
	`LOG_TRACE
("SG†ist freed");

527 
	}
}

532 
	$dma_sg_add_äagm’t
(
dma_sg_li¡_t
 *
sg_li¡
, *
vœt_addr
, 
ušt32_t
 
Ëngth
, ušt32_ˆ
æags
) {

533 
dma_äagm’t_t
 *
äag
;

534 
ušt32_t
 
phys_addr
;

536 ià(!
sg_li¡
 || !
vœt_addr
 || 
Ëngth
 == 0) {

537  -
DMA_ERROR_INVALID_PARAM
;

540 ià(
sg_li¡
->
äagm’t_couÁ
 >ğsg_li¡->
max_äagm’ts
) {

541  -
DMA_ERROR_TOO_MANY_FRAGMENTS
;

544 ià(
Ëngth
 > 
DMA_MAX_TRANSFER_SIZE
) {

545  -
DMA_ERROR_FRAGMENT_TOO_LARGE
;

549 
phys_addr
 = 
	`dma_vœt_to_phys
(
vœt_addr
);

550 ià(
phys_addr
 == 0) {

551  -
DMA_ERROR_MAPPING_FAILED
;

555 
äag
 = &
sg_li¡
->
äagm’ts
[sg_li¡->
äagm’t_couÁ
];

556 
äag
->
physiÿl_addr
 = 
phys_addr
;

557 
äag
->
Ëngth
 =†ength;

558 
äag
->
æags
 = flags;

559 
äag
->
Ãxt
 = 
NULL
;

562 ià(
sg_li¡
->
äagm’t_couÁ
 > 0) {

563 
sg_li¡
->
äagm’ts
[sg_li¡->
äagm’t_couÁ
 - 1].
Ãxt
 = 
äag
;

566 
sg_li¡
->
äagm’t_couÁ
++;

567 
sg_li¡
->
tÙ®_Ëngth
 +ğ
Ëngth
;

569 
	`LOG_TRACE
("Fragment‡dded:…hys=0x%08X,†en=%u, flags=0x%X",

570 
phys_addr
, 
Ëngth
, 
æags
);

573 
	}
}

578 
	$dma_sg_cÚsŞid©e
(
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 *
cÚsŞid©ed_bufãr
, 
ušt32_t
 
bufãr_size
) {

579 
ušt32_t
 
tÙ®_cİ›d
 = 0;

580 
ušt8_t
 *
de¡_±r
;

582 ià(!
sg_li¡
 || !
cÚsŞid©ed_bufãr
 || 
bufãr_size
 == 0) {

583  -
DMA_ERROR_INVALID_PARAM
;

586 ià(
sg_li¡
->
tÙ®_Ëngth
 > 
bufãr_size
) {

587 
	`LOG_ERROR
("Consolidated bufferoo small:‚eed %u, have %u",

588 
sg_li¡
->
tÙ®_Ëngth
, 
bufãr_size
);

589  -
DMA_ERROR_OUT_OF_MEMORY
;

592 
de¡_±r
 = 
cÚsŞid©ed_bufãr
;

595 
ušt16_t
 
i
 = 0; i < 
sg_li¡
->
äagm’t_couÁ
; i++) {

596 
dma_äagm’t_t
 *
äag
 = &
sg_li¡
->
äagm’ts
[
i
];

597 *
¤c_±r
 = 
	`dma_phys_to_vœt
(
äag
->
physiÿl_addr
);

599 ià(!
¤c_±r
) {

600 
	`LOG_ERROR
("Cannotranslate…hysical‡ddress 0x%08X for fragment %u",

601 
äag
->
physiÿl_addr
, 
i
);

602  -
DMA_ERROR_MAPPING_FAILED
;

606 
	`memÜy_cİy
(
de¡_±r
, 
¤c_±r
, 
äag
->
Ëngth
);

607 
de¡_±r
 +ğ
äag
->
Ëngth
;

608 
tÙ®_cİ›d
 +ğ
äag
->
Ëngth
;

610 
	`LOG_TRACE
("F¿gm’ˆ%u cÚsŞid©ed: %u by‹s", 
i
, 
äag
->
Ëngth
);

614 
sg_li¡
->
æags
 |ğ
DMA_SG_CONSOLIDATED
;

616 
	`LOG_DEBUG
("SG†ist consolidated: %u fragments, %u bytesotal",

617 
sg_li¡
->
äagm’t_couÁ
, 
tÙ®_cİ›d
);

619  
tÙ®_cİ›d
;

620 
	}
}

627 
ušt32_t
 
	$g‘_cÚv’tiÚ®_phys_addr
(*
vœt_addr
) {

628 
ušt32_t
 
£gm’t
, 
off£t
;

631 
£gm’t
 = 
	`FP_SEG
(
vœt_addr
);

632 
off£t
 = 
	`FP_OFF
(
vœt_addr
);

635  (
£gm’t
 << 4è+ 
off£t
;

636 
	}
}

641 
	$£tup_coh”’cy_mªagem’t
() {

642 
dma_coh”’cy_mgr_t
 *
coh”’cy
 = &
g_dma_mªag”
.coherency;

645 
coh”’cy
->
coh”’t_memÜy_avaabË
 = 
Œue
;

646 
coh”’cy
->
ÿche_coh”’t_dma
 = 
Œue
;

647 
coh”’cy
->
ÿche_lše_size
 = 4;

648 
coh”’cy
->
dma_®ignm’t
 = 
DMA_MIN_ALIGNMENT
;

651 
coh”’cy
->
sync_fÜ_ıu
 = 
NULL
;

652 
coh”’cy
->
sync_fÜ_deviû
 = 
NULL
;

654 
	`LOG_DEBUG
("Cache coherency management initialized");

657 
	}
}

662 
	$š™_add»ss_Œª¦©iÚ
() {

664 
g_dma_mªag”
.
vœt_to_phys
 = 
g‘_cÚv’tiÚ®_phys_addr
;

665 
g_dma_mªag”
.
phys_to_vœt
 = 
NULL
;

667 
	`LOG_DEBUG
("Addressranslation initialized");

670 
	}
}

675 
	$v®id©e_dma_·¿m‘”s
(*
addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
) {

676 ià(!
addr
 || 
size
 == 0) {

677  -
DMA_ERROR_INVALID_PARAM
;

680 ià(
dœeùiÚ
 =ğ0 || dœeùiÚ > 
DMA_DIRECTION_BIDIRECTIONAL
) {

681  -
DMA_ERROR_INVALID_PARAM
;

685 ià(((
ušt32_t
)
addr
 & (
DMA_MIN_ALIGNMENT
 - 1)) != 0) {

686  -
DMA_ERROR_ALIGNMENT_ERROR
;

690 ià(
size
 > 
DMA_MAX_TRANSFER_SIZE
) {

691  -
DMA_ERROR_FRAGMENT_TOO_LARGE
;

695 
	}
}

700 
	$®loÿ‹_coh”’t_poŞ
() {

702 
g_dma_mªag”
.
coh”’t_poŞ
 = (
dma_bufãr_poŞ_t
*)
	`memÜy_®loc
(

703 (
dma_bufãr_poŞ_t
), 
MEM_TYPE_DMA_BUFFER
, 
MEM_FLAG_ZERO
);

705 ià(!
g_dma_mªag”
.
coh”’t_poŞ
) {

706  -
DMA_ERROR_OUT_OF_MEMORY
;

710 
»suÉ
 = 
	`dma_poŞ_š™
(
g_dma_mªag”
.
coh”’t_poŞ
, 
DMA_COHERENT_POOL_SIZE
,

711 
DMA_MAX_TRANSFER_SIZE
, 
DMA_MEMORY_CONVENTIONAL
, 
DMA_MIN_ALIGNMENT
);

712 ià(
»suÉ
 != 0) {

713 
	`memÜy_ä“
(
g_dma_mªag”
.
coh”’t_poŞ
);

714 
g_dma_mªag”
.
coh”’t_poŞ
 = 
NULL
;

715  
»suÉ
;

718 
	`LOG_DEBUG
("Coh”’ˆmemÜy…oŞ‡Îoÿ‹d (%d bufãrs)", 
DMA_COHERENT_POOL_SIZE
);

721 
	}
}

726 
	$ş—nup_coh”’t_poŞ
() {

727 ià(
g_dma_mªag”
.
coh”’t_poŞ
) {

728 
	`dma_poŞ_ş—nup
(
g_dma_mªag”
.
coh”’t_poŞ
);

729 
	`memÜy_ä“
(
g_dma_mªag”
.
coh”’t_poŞ
);

730 
g_dma_mªag”
.
coh”’t_poŞ
 = 
NULL
;

732 
	}
}

739 
	$dma_sync_fÜ_ıu
(*
addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
) {

741 ()
addr
;

742 ()
size
;

743 ()
dœeùiÚ
;

744 
	}
}

749 
	$dma_sync_fÜ_deviû
(*
addr
, 
ušt32_t
 
size
, 
ušt8_t
 
dœeùiÚ
) {

751 ()
addr
;

752 ()
size
;

753 ()
dœeùiÚ
;

754 
	}
}

759 
boŞ
 
	$dma_is_coh”’t
(*
addr
, 
ušt32_t
 
size
) {

761 ()
size
;

762  ((
ušt32_t
)
addr
 < 0xA0000);

763 
	}
}

770 
	$dma_£t_”rÜ
(
ušt8_t
 
nic_šdex
, 
dma_”rÜ_t
 
”rÜ
) {

771 ià(
nic_šdex
 < 
MAX_NICS
) {

773 
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
].
dma_”rÜs
++;

775 
	}
}

780 
dma_”rÜ_t
 
	$dma_g‘_Ï¡_”rÜ
(
ušt8_t
 
nic_šdex
) {

781 ià(
nic_šdex
 >ğ
MAX_NICS
) {

782  
DMA_ERROR_INVALID_PARAM
;

786  
DMA_ERROR_NONE
;

787 
	}
}

792 cÚ¡ * 
	$dma_”rÜ_to_¡ršg
(
dma_”rÜ_t
 
”rÜ
) {

793 
”rÜ
) {

794 
DMA_ERROR_NONE
:  "Noƒrror";

795 
DMA_ERROR_INVALID_PARAM
:  "Invalid…arameter";

796 
DMA_ERROR_OUT_OF_MEMORY
:  "Out of memory";

797 
DMA_ERROR_MAPPING_FAILED
:  "Mapping failed";

798 
DMA_ERROR_XMS_UNAVAILABLE
:  "XMS unavailable";

799 
DMA_ERROR_ALIGNMENT_ERROR
:  "Alignmentƒrror";

800 
DMA_ERROR_TRANSFER_TIMEOUT
:  "Transferimeout";

801 
DMA_ERROR_HARDWARE_ERROR
:  "Hardwareƒrror";

802 
DMA_ERROR_COHERENCY_VIOLATION
:  "Coherency violation";

803 
DMA_ERROR_FRAGMENT_TOO_LARGE
:  "Fragmentoo†arge";

804 
DMA_ERROR_TOO_MANY_FRAGMENTS
:  "Too many fragments";

805 
DMA_ERROR_UNSUPPORTED_OPERATION
:  "Unsupported operation";

808 
	}
}

813 
	$dma_g‘_¡©i¡ics
(
ušt8_t
 
nic_šdex
, 
ušt32_t
 *
sg_İs
, ušt32_ˆ*
cÚsŞid©iÚs
,

814 
ušt32_t
 *
z”o_cİy
, ušt32_ˆ*
”rÜs
) {

815 
dma_nic_cÚ‹xt_t
 *
ùx
;

817 ià(
nic_šdex
 >ğ
MAX_NICS
) {

818  -
DMA_ERROR_INVALID_PARAM
;

821 
ùx
 = &
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
];

823 ià(
sg_İs
è*sg_İ ğ
ùx
->
sg_cÚsŞid©iÚs
 + ctx->
z”o_cİy_Œªsãrs
;

824 ià(
cÚsŞid©iÚs
è*cÚsŞid©iÚ ğ
ùx
->
sg_cÚsŞid©iÚs
;

825 ià(
z”o_cİy
è*z”o_cİy = 
ùx
->
z”o_cİy_Œªsãrs
;

826 ià(
”rÜs
è*”rÜ ğ
ùx
->
dma_”rÜs
;

829 
	}
}

834 
	$dma_»£t_¡©i¡ics
(
ušt8_t
 
nic_šdex
) {

835 
dma_nic_cÚ‹xt_t
 *
ùx
;

837 ià(
nic_šdex
 >ğ
MAX_NICS
) {

841 
ùx
 = &
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
];

843 
ùx
->
sg_cÚsŞid©iÚs
 = 0;

844 
ùx
->
z”o_cİy_Œªsãrs
 = 0;

845 
ùx
->
çÎback_Œªsãrs
 = 0;

846 
ùx
->
dma_”rÜs
 = 0;

848 
	`LOG_DEBUG
("DMA sti¡ic »£ˆfÜ NIC %d", 
nic_šdex
);

849 
	}
}

854 
	$dma_dump_¡©us
(
ušt8_t
 
nic_šdex
) {

855 
dma_nic_cÚ‹xt_t
 *
ùx
;

857 ià(
nic_šdex
 >ğ
MAX_NICS
) {

861 
ùx
 = &
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
];

863 
	`LOG_INFO
("==ğDMA Stu fÜ NIC %d ===", 
nic_šdex
);

864 
	`LOG_INFO
("NIC Ty³: 0x%04X", 
ùx
->
nic_ty³
);

865 
	`LOG_INFO
("DMA C­ab™›s: 0x%08X", 
ùx
->
dma_ÿ·b™›s
);

866 
	`LOG_INFO
("Max SG F¿gm’ts: %u", 
ùx
->
max_sg_äagm’ts
);

867 
	`LOG_INFO
("Max T¿nsã¸Size: %u", 
ùx
->
max_Œªsãr_size
);

868 
	`LOG_INFO
("Statistics:");

869 
	`LOG_INFO
(" SG CÚsŞid©iÚs: %u", 
ùx
->
sg_cÚsŞid©iÚs
);

870 
	`LOG_INFO
(" Z”o-cİy T¿nsãrs: %u", 
ùx
->
z”o_cİy_Œªsãrs
);

871 
	`LOG_INFO
(" F®lback T¿nsãrs: %u", 
ùx
->
çÎback_Œªsãrs
);

872 
	`LOG_INFO
(" DMA E¼Üs: %u", 
ùx
->
dma_”rÜs
);

874 ià(
ùx
->
dma_ÿ·b™›s
 & 
DMA_CAP_BASIC_BUSMASTER
) {

875 
	`LOG_INFO
("TX PoŞ: %u/%u bufãr ä“", 
ùx
->
tx_poŞ
.
ä“_couÁ
, ctx->tx_poŞ.
bufãr_couÁ
);

876 
	`LOG_INFO
("RX PoŞ: %u/%u bufãr ä“", 
ùx
->
rx_poŞ
.
ä“_couÁ
, ctx->rx_poŞ.
bufãr_couÁ
);

879 
	`LOG_INFO
("=== End DMA Status ===");

880 
	}
}

887 
	$dma_poŞ_š™
(
dma_bufãr_poŞ_t
 *
poŞ
, 
ušt16_t
 
bufãr_couÁ
, 
ušt32_t
 
bufãr_size
,

888 
dma_memÜy_ty³_t
 
memÜy_ty³
, 
ušt32_t
 
®ignm’t
) {

889 
ušt32_t
 
tÙ®_size
;

890 
ušt32_t
 
®igÃd_size
;

891 
ušt8_t
 *
bufãr_±r
;

892 
ušt32_t
 
b™m­_size
;

894 ià(!
poŞ
 || 
bufãr_couÁ
 =ğ0 || 
bufãr_size
 == 0) {

895  -
DMA_ERROR_INVALID_PARAM
;

899 
	`mem£t
(
poŞ
, 0, (
dma_bufãr_poŞ_t
));

902 
®igÃd_size
 = (
bufãr_size
 + 
®ignm’t
 - 1) & ~(alignment - 1);

905 
tÙ®_size
 = 
bufãr_couÁ
 * 
®igÃd_size
;

908 
memÜy_ty³
) {

909 
DMA_MEMORY_CONVENTIONAL
:

910 
poŞ
->
ba£_addr
 = (
ušt8_t
*)
	`memÜy_®loc_®igÃd
(
tÙ®_size
, 
®ignm’t
, 
MEM_TYPE_DMA_BUFFER
);

912 
DMA_MEMORY_XMS
:

914 
	`LOG_WARNING
("XMS buffer…ool‡llocation‚ot yet implemented");

915  -
DMA_ERROR_XMS_UNAVAILABLE
;

917  -
DMA_ERROR_INVALID_PARAM
;

920 ià(!
poŞ
->
ba£_addr
) {

921 
	`LOG_ERROR
("FaedØ®loÿ‹ bufã¸poŞ memÜy (%u by‹s)", 
tÙ®_size
);

922  -
DMA_ERROR_OUT_OF_MEMORY
;

926 
b™m­_size
 = (
bufãr_couÁ
 + 31) / 32;

927 
poŞ
->
ä“_b™m­
 = (
ušt32_t
*)
	`memÜy_®loc
(
b™m­_size
 * (uint32_t),

928 
MEM_TYPE_DMA_BUFFER
, 
MEM_FLAG_ZERO
);

929 ià(!
poŞ
->
ä“_b™m­
) {

930 
	`memÜy_ä“
(
poŞ
->
ba£_addr
);

931  -
DMA_ERROR_OUT_OF_MEMORY
;

935 
poŞ
->
m­pšgs
 = (
dma_m­pšg_t
*)
	`memÜy_®loc
(
bufãr_couÁ
 * (dma_mapping_t),

936 
MEM_TYPE_DMA_BUFFER
, 
MEM_FLAG_ZERO
);

937 ià(!
poŞ
->
m­pšgs
) {

938 
	`memÜy_ä“
(
poŞ
->
ä“_b™m­
);

939 
	`memÜy_ä“
(
poŞ
->
ba£_addr
);

940  -
DMA_ERROR_OUT_OF_MEMORY
;

944 
poŞ
->
poŞ_size
 = 
tÙ®_size
;

945 
poŞ
->
bufãr_size
 = 
®igÃd_size
;

946 
poŞ
->
bufãr_couÁ
 = buffer_count;

947 
poŞ
->
ä“_couÁ
 = 
bufãr_couÁ
;

948 
poŞ
->
memÜy_ty³
 = memory_type;

951 
ušt32_t
 
i
 = 0; i < 
b™m­_size
; i++) {

952 
poŞ
->
ä“_b™m­
[
i
] = 0xFFFFFFFF;

956 ià(
bufãr_couÁ
 & 31) {

957 
ušt32_t
 
Ï¡_wÜd
 = 
b™m­_size
 - 1;

958 
ušt32_t
 
v®id_b™s
 = 
bufãr_couÁ
 & 31;

959 
poŞ
->
ä“_b™m­
[
Ï¡_wÜd
] &ğ(1U << 
v®id_b™s
) - 1;

963 
bufãr_±r
 = 
poŞ
->
ba£_addr
;

964 
ušt16_t
 
i
 = 0; i < 
bufãr_couÁ
; i++) {

965 
dma_m­pšg_t
 *
m­pšg
 = &
poŞ
->
m­pšgs
[
i
];

967 
m­pšg
->
vœtu®_addr
 = 
bufãr_±r
;

968 
m­pšg
->
physiÿl_addr
 = 
	`dma_vœt_to_phys
(
bufãr_±r
);

969 
m­pšg
->
size
 = 
®igÃd_size
;

970 
m­pšg
->
memÜy_ty³
 = memory_type;

971 
m­pšg
->
æags
 = 
DMA_MAP_COHERENT
;

972 
m­pšg
->
»f_couÁ
 = 0;

974 
bufãr_±r
 +ğ
®igÃd_size
;

977 
	`LOG_DEBUG
("DMA buffer…ool initialized: %u buffers of %u bytesƒach (%u KBotal)",

978 
bufãr_couÁ
, 
®igÃd_size
, 
tÙ®_size
 / 1024);

981 
	}
}

986 
	$dma_poŞ_ş—nup
(
dma_bufãr_poŞ_t
 *
poŞ
) {

987 ià(!
poŞ
) {

991 
	`LOG_DEBUG
("CËªšg u°DMA bufã¸poŞ (%u bufãrs)", 
poŞ
->
bufãr_couÁ
);

994 ià(
poŞ
->
m­pšgs
) {

995 
	`memÜy_ä“
(
poŞ
->
m­pšgs
);

998 ià(
poŞ
->
ä“_b™m­
) {

999 
	`memÜy_ä“
(
poŞ
->
ä“_b™m­
);

1002 ià(
poŞ
->
ba£_addr
) {

1003 
	`memÜy_ä“
(
poŞ
->
ba£_addr
);

1007 
	`mem£t
(
poŞ
, 0, (
dma_bufãr_poŞ_t
));

1008 
	}
}

1013 
	$dma_poŞ_®loc
(
dma_bufãr_poŞ_t
 *
poŞ
, 
dma_m­pšg_t
 *
m­pšg
) {

1014 
ušt32_t
 
wÜd_šdex
, 
b™_šdex
;

1015 
ušt32_t
 
bufãr_šdex
;

1017 ià(!
poŞ
 || !
m­pšg
) {

1018  -
DMA_ERROR_INVALID_PARAM
;

1021 ià(
poŞ
->
ä“_couÁ
 == 0) {

1022  -
DMA_ERROR_OUT_OF_MEMORY
;

1026 
wÜd_šdex
 = 0; wÜd_šdex < (
poŞ
->
bufãr_couÁ
 + 31) / 32; word_index++) {

1027 ià(
poŞ
->
ä“_b™m­
[
wÜd_šdex
] != 0) {

1029 
b™_šdex
 = 0; bit_index < 32; bit_index++) {

1030 ià(
poŞ
->
ä“_b™m­
[
wÜd_šdex
] & (1U << 
b™_šdex
)) {

1031 
bufãr_šdex
 = 
wÜd_šdex
 * 32 + 
b™_šdex
;

1033 ià(
bufãr_šdex
 < 
poŞ
->
bufãr_couÁ
) {

1035 
poŞ
->
ä“_b™m­
[
wÜd_šdex
] &ğ~(1U << 
b™_šdex
);

1036 
poŞ
->
ä“_couÁ
--;

1039 *
m­pšg
 = 
poŞ
->
m­pšgs
[
bufãr_šdex
];

1040 
m­pšg
->
»f_couÁ
 = 1;

1042 
	`LOG_TRACE
("DMA buffer‡llocated: index=%u,‡ddr=%p",

1043 
bufãr_šdex
, 
m­pšg
->
vœtu®_addr
);

1053 
	`LOG_ERROR
("DMA…ool‡llocation failed: corrupted free bitmap");

1054  -
DMA_ERROR_OUT_OF_MEMORY
;

1055 
	}
}

1060 
	$dma_poŞ_ä“
(
dma_bufãr_poŞ_t
 *
poŞ
, 
dma_m­pšg_t
 *
m­pšg
) {

1061 
ušt32_t
 
bufãr_šdex
;

1062 
ušt32_t
 
wÜd_šdex
, 
b™_šdex
;

1064 ià(!
poŞ
 || !
m­pšg
 || !m­pšg->
vœtu®_addr
) {

1069 ià(
m­pšg
->
vœtu®_addr
 < 
poŞ
->
ba£_addr
 ||

1070 
m­pšg
->
vœtu®_addr
 >ğ
poŞ
->
ba£_addr
 +…oŞ->
poŞ_size
) {

1071 
	`LOG_ERROR
("Inv®id bufã¸add»s fÜ…oŞ f»e: %p", 
m­pšg
->
vœtu®_addr
);

1075 
bufãr_šdex
 = ((
ušt8_t
*)
m­pšg
->
vœtu®_addr
 - 
poŞ
->
ba£_addr
è/…oŞ->
bufãr_size
;

1077 ià(
bufãr_šdex
 >ğ
poŞ
->
bufãr_couÁ
) {

1078 
	`LOG_ERROR
("Inv®id bufã¸šdex fÜ…oŞ f»e: %u", 
bufãr_šdex
);

1083 
wÜd_šdex
 = 
bufãr_šdex
 / 32;

1084 
b™_šdex
 = 
bufãr_šdex
 % 32;

1086 ià(
poŞ
->
ä“_b™m­
[
wÜd_šdex
] & (1U << 
b™_šdex
)) {

1087 
	`LOG_ERROR
("DoubË f»d‘eùed iÀDMA…oŞ: bufã¸%u", 
bufãr_šdex
);

1092 
poŞ
->
ä“_b™m­
[
wÜd_šdex
] |ğ(1U << 
b™_šdex
);

1093 
poŞ
->
ä“_couÁ
++;

1096 
m­pšg
->
»f_couÁ
 = 0;

1098 
	`LOG_TRACE
("DMA bufã¸ä“d: index=%u,‡ddr=%p", 
bufãr_šdex
, 
m­pšg
->
vœtu®_addr
);

1099 
	}
}

1106 
	$dma_3c515_£tup_Œªsãr_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 
dœeùiÚ
) {

1107 
’hªûd_ršg_cÚ‹xt_t
 *
ršg
;

1108 
ušt8_t
 *
cÚsŞid©ed_bufãr
 = 
NULL
;

1109 
dma_m­pšg_t
 
bufãr_m­pšg
;

1110 
»suÉ
;

1112 ià(!
ùx
 || !
sg_li¡
) {

1113  -
DMA_ERROR_INVALID_PARAM
;

1116 
ršg
 = 
ùx
->
ršg_cÚ‹xt
;

1117 ià(!
ršg
) {

1118 
	`LOG_ERROR
("No„ing context for 3C515-TX DMA setup");

1119  -
DMA_ERROR_INVALID_PARAM
;

1122 
	`LOG_DEBUG
("Setting up 3C515-TX DMAransfer: %u fragments, %u bytesotal",

1123 
sg_li¡
->
äagm’t_couÁ
, sg_li¡->
tÙ®_Ëngth
);

1126 ià(
sg_li¡
->
äagm’t_couÁ
 > 1) {

1127 
	`LOG_DEBUG
("CÚsŞid©šg %u f¿gm’t fÜ 3C515-TX", 
sg_li¡
->
äagm’t_couÁ
);

1130 ià(
dœeùiÚ
 =ğ
DMA_DIRECTION_TO_DEVICE
) {

1131 
»suÉ
 = 
	`dma_poŞ_®loc
(&
ùx
->
tx_poŞ
, &
bufãr_m­pšg
);

1133 
»suÉ
 = 
	`dma_poŞ_®loc
(&
ùx
->
rx_poŞ
, &
bufãr_m­pšg
);

1136 ià(
»suÉ
 != 0) {

1137 
	`LOG_ERROR
("FaedØ®loÿ‹ cÚsŞid©iÚ bufãr: %d", 
»suÉ
);

1138  
»suÉ
;

1141 
cÚsŞid©ed_bufãr
 = (
ušt8_t
*)
bufãr_m­pšg
.
vœtu®_addr
;

1144 
»suÉ
 = 
	`dma_sg_cÚsŞid©e
(
sg_li¡
, 
cÚsŞid©ed_bufãr
, 
bufãr_m­pšg
.
size
);

1145 ià(
»suÉ
 < 0) {

1146 
	`LOG_ERROR
("FaedØcÚsŞid©SG†i¡: %d", 
»suÉ
);

1147 ià(
dœeùiÚ
 =ğ
DMA_DIRECTION_TO_DEVICE
) {

1148 
	`dma_poŞ_ä“
(&
ùx
->
tx_poŞ
, &
bufãr_m­pšg
);

1150 
	`dma_poŞ_ä“
(&
ùx
->
rx_poŞ
, &
bufãr_m­pšg
);

1152  
»suÉ
;

1155 
ùx
->
sg_cÚsŞid©iÚs
++;

1158 
sg_li¡
->
´iv©e_d©a
 = (*)&
bufãr_m­pšg
;

1161 
dma_äagm’t_t
 *
äag
 = &
sg_li¡
->
äagm’ts
[0];

1163 ià((
äag
->
physiÿl_addr
 & (
ùx
->
mš_®ignm’t
 - 1)) == 0) {

1164 
	`LOG_DEBUG
("Using zero-copy for single‡ligned fragment");

1165 
ùx
->
z”o_cİy_Œªsãrs
++;

1167 
	`LOG_DEBUG
("Fragment‚ot‡ligned, consolidating‡nyway");

1170 ià(
dœeùiÚ
 =ğ
DMA_DIRECTION_TO_DEVICE
) {

1171 
»suÉ
 = 
	`dma_poŞ_®loc
(&
ùx
->
tx_poŞ
, &
bufãr_m­pšg
);

1173 
»suÉ
 = 
	`dma_poŞ_®loc
(&
ùx
->
rx_poŞ
, &
bufãr_m­pšg
);

1176 ià(
»suÉ
 != 0) {

1177  
»suÉ
;

1180 
cÚsŞid©ed_bufãr
 = (
ušt8_t
*)
bufãr_m­pšg
.
vœtu®_addr
;

1181 
»suÉ
 = 
	`dma_sg_cÚsŞid©e
(
sg_li¡
, 
cÚsŞid©ed_bufãr
, 
bufãr_m­pšg
.
size
);

1182 ià(
»suÉ
 < 0) {

1183 ià(
dœeùiÚ
 =ğ
DMA_DIRECTION_TO_DEVICE
) {

1184 
	`dma_poŞ_ä“
(&
ùx
->
tx_poŞ
, &
bufãr_m­pšg
);

1186 
	`dma_poŞ_ä“
(&
ùx
->
rx_poŞ
, &
bufãr_m­pšg
);

1188  
»suÉ
;

1191 
sg_li¡
->
´iv©e_d©a
 = (*)&
bufãr_m­pšg
;

1192 
ùx
->
sg_cÚsŞid©iÚs
++;

1196 
	`LOG_DEBUG
("3C515-TX DMAransfer setup completed");

1199 
	}
}

1204 
	$dma_3c515_¡¬t_Œªsãr_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
) {

1207 
	`LOG_TRACE
("3C515-TX DMAransfer started");

1209 
	}
}

1214 
	$dma_3c515_¡İ_Œªsãr_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
) {

1216 
	`LOG_TRACE
("3C515-TX DMAransfer stopped");

1218 
	}
}

1223 
	$dma_3c515_g‘_¡©us_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
) {

1226 
	}
}

1231 
	$dma_3c509b_çÎback_im¶
(
dma_nic_cÚ‹xt_t
 *
ùx
, 
dma_sg_li¡_t
 *
sg_li¡
, 
ušt8_t
 
dœeùiÚ
) {

1232 
ušt8_t
 
cÚsŞid©ed_bufãr
[
DMA_MAX_TRANSFER_SIZE
];

1233 
»suÉ
;

1235 ià(!
ùx
 || !
sg_li¡
) {

1236  -
DMA_ERROR_INVALID_PARAM
;

1239 
	`LOG_DEBUG
("3C509B PIO fallback: %u fragments, %u bytesotal",

1240 
sg_li¡
->
äagm’t_couÁ
, sg_li¡->
tÙ®_Ëngth
);

1243 
»suÉ
 = 
	`dma_sg_cÚsŞid©e
(
sg_li¡
, 
cÚsŞid©ed_bufãr
, (consolidated_buffer));

1244 ià(
»suÉ
 < 0) {

1245 
	`LOG_ERROR
("FaedØcÚsŞid©SG†i¡ fÜ 3C509B: %d", 
»suÉ
);

1246  
»suÉ
;

1249 
ùx
->
çÎback_Œªsãrs
++;

1252 
sg_li¡
->
´iv©e_d©a
 = 
cÚsŞid©ed_bufãr
;

1254 
	`LOG_DEBUG
("3C509B PIO f®lback com¶‘ed: %d by‹ cÚsŞid©ed", 
»suÉ
);

1257 
	}
}

1264 
	$dma_£nd_·ck‘_sg
(
ušt8_t
 
nic_šdex
, 
dma_äagm’t_t
 *
·ck‘_äagm’ts
, 
ušt16_t
 
äagm’t_couÁ
) {

1265 
dma_nic_cÚ‹xt_t
 *
ùx
;

1266 
dma_sg_li¡_t
 *
sg_li¡
;

1267 
»suÉ
;

1269 ià(
nic_šdex
 >ğ
MAX_NICS
 || !
·ck‘_äagm’ts
 || 
äagm’t_couÁ
 == 0) {

1270  -
DMA_ERROR_INVALID_PARAM
;

1273 
ùx
 = &
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
];

1275 ià(
ùx
->
nic_ty³
 == 0) {

1276 
	`LOG_ERROR
("NIC %d‚Ù in™Ÿlized fÜ DMA", 
nic_šdex
);

1277  -
DMA_ERROR_INVALID_PARAM
;

1280 ià(
äagm’t_couÁ
 > 
ùx
->
max_sg_äagm’ts
) {

1281 
	`LOG_ERROR
("Too many fragments for NIC %d: %u > %u",

1282 
nic_šdex
, 
äagm’t_couÁ
, 
ùx
->
max_sg_äagm’ts
);

1283  -
DMA_ERROR_TOO_MANY_FRAGMENTS
;

1287 
sg_li¡
 = 
	`dma_sg_®loc
(
äagm’t_couÁ
);

1288 ià(!
sg_li¡
) {

1289  -
DMA_ERROR_OUT_OF_MEMORY
;

1293 
ušt16_t
 
i
 = 0; i < 
äagm’t_couÁ
; i++) {

1294 
ušt32_t
 
æags
 = 0;

1296 ià(
i
 =ğ0è
æags
 |ğ
DMA_FRAG_FIRST
;

1297 ià(
i
 =ğ
äagm’t_couÁ
 - 1è
æags
 |ğ
DMA_FRAG_LAST
;

1299 
»suÉ
 = 
	`dma_sg_add_äagm’t
(
sg_li¡
,

1300 
	`dma_phys_to_vœt
(
·ck‘_äagm’ts
[
i
].
physiÿl_addr
),

1301 
·ck‘_äagm’ts
[
i
].
Ëngth
,

1302 
æags
);

1303 ià(
»suÉ
 != 0) {

1304 
	`LOG_ERROR
("FaedØadd f¿gm’ˆ%uØSG†i¡: %d", 
i
, 
»suÉ
);

1305 
	`dma_sg_ä“
(
sg_li¡
);

1306  
»suÉ
;

1311 ià(
ùx
->
£tup_dma_Œªsãr
) {

1312 
»suÉ
 = 
ùx
->
	`£tup_dma_Œªsãr
(ùx, 
sg_li¡
, 
DMA_DIRECTION_TO_DEVICE
);

1313 ià(
»suÉ
 != 0) {

1314 
	`LOG_ERROR
("FaedØ£tu°DMA¿nsã¸fÜ NIC %d: %d", 
nic_šdex
, 
»suÉ
);

1315 
	`dma_sg_ä“
(
sg_li¡
);

1316  
»suÉ
;

1321 ià(
ùx
->
¡¬t_dma_Œªsãr
) {

1322 
»suÉ
 = 
ùx
->
	`¡¬t_dma_Œªsãr
(ctx);

1323 ià(
»suÉ
 != 0) {

1324 
	`LOG_ERROR
("FaedØ¡¬ˆDMA¿nsã¸fÜ NIC %d: %d", 
nic_šdex
, 
»suÉ
);

1325 
	`dma_sg_ä“
(
sg_li¡
);

1326  
»suÉ
;

1330 
	`LOG_DEBUG
("Scatter-gather…acket sent on NIC %d: %u fragments, %u bytes",

1331 
nic_šdex
, 
äagm’t_couÁ
, 
sg_li¡
->
tÙ®_Ëngth
);

1334 
	`dma_sg_ä“
(
sg_li¡
);

1337 
	}
}

1342 
	$dma_£lf_‹¡
(
ušt8_t
 
nic_šdex
) {

1343 
dma_nic_cÚ‹xt_t
 *
ùx
;

1344 
dma_sg_li¡_t
 *
sg_li¡
;

1345 
ušt8_t
 
‹¡_d©a
[256];

1346 
ušt8_t
 
cÚsŞid©ed_bufãr
[512];

1347 
»suÉ
;

1349 ià(
nic_šdex
 >ğ
MAX_NICS
) {

1350  -
DMA_ERROR_INVALID_PARAM
;

1353 
ùx
 = &
g_dma_mªag”
.
nic_cÚ‹xts
[
nic_šdex
];

1355 ià(
ùx
->
nic_ty³
 == 0) {

1356 
	`LOG_ERROR
("NIC %d‚Ù in™Ÿlized fÜ DMA s–f-‹¡", 
nic_šdex
);

1357  -
DMA_ERROR_INVALID_PARAM
;

1360 
	`LOG_INFO
("RuÂšg DMA s–f-‹¡ fÜ NIC %d", 
nic_šdex
);

1363 
i
 = 0; i < (
‹¡_d©a
); i++) {

1364 
‹¡_d©a
[
i
] = (
ušt8_t
)(i & 0xFF);

1368 
sg_li¡
 = 
	`dma_sg_®loc
(1);

1369 ià(!
sg_li¡
) {

1370 
	`LOG_ERROR
("Failedo‡llocate SG†ist for self-test");

1371  -
DMA_ERROR_OUT_OF_MEMORY
;

1374 
»suÉ
 = 
	`dma_sg_add_äagm’t
(
sg_li¡
, 
‹¡_d©a
, Ñe¡_d©a), 
DMA_FRAG_SINGLE
);

1375 ià(
»suÉ
 != 0) {

1376 
	`LOG_ERROR
("FaedØadd f¿gm’ˆtØSG†i¡: %d", 
»suÉ
);

1377 
	`dma_sg_ä“
(
sg_li¡
);

1378  
»suÉ
;

1382 
»suÉ
 = 
	`dma_sg_cÚsŞid©e
(
sg_li¡
, 
cÚsŞid©ed_bufãr
, (consolidated_buffer));

1383 ià(
»suÉ
 !ğ(
‹¡_d©a
)) {

1384 
	`LOG_ERROR
("CÚsŞid©iÚ faed:ƒx³ùed %zu, gÙ %d", (
‹¡_d©a
), 
»suÉ
);

1385 
	`dma_sg_ä“
(
sg_li¡
);

1386  -
DMA_ERROR_HARDWARE_ERROR
;

1390 ià(
	`memcmp
(
‹¡_d©a
, 
cÚsŞid©ed_bufãr
, (test_data)) != 0) {

1391 
	`LOG_ERROR
("Data verification failed‡fter consolidation");

1392 
	`dma_sg_ä“
(
sg_li¡
);

1393  -
DMA_ERROR_HARDWARE_ERROR
;

1396 
	`dma_sg_ä“
(
sg_li¡
);

1399 ià(
ùx
->
max_sg_äagm’ts
 > 1) {

1400 
sg_li¡
 = 
	`dma_sg_®loc
(2);

1401 ià(!
sg_li¡
) {

1402 
	`LOG_ERROR
("Failedo‡llocate multi-fragment SG†ist");

1403  -
DMA_ERROR_OUT_OF_MEMORY
;

1406 
»suÉ
 = 
	`dma_sg_add_äagm’t
(
sg_li¡
, 
‹¡_d©a
, 128, 
DMA_FRAG_FIRST
);

1407 ià(
»suÉ
 == 0) {

1408 
»suÉ
 = 
	`dma_sg_add_äagm’t
(
sg_li¡
, 
‹¡_d©a
 + 128, 128, 
DMA_FRAG_LAST
);

1411 ià(
»suÉ
 != 0) {

1412 
	`LOG_ERROR
("FaedØadd muÉi-äagm’ts: %d", 
»suÉ
);

1413 
	`dma_sg_ä“
(
sg_li¡
);

1414  
»suÉ
;

1417 
»suÉ
 = 
	`dma_sg_cÚsŞid©e
(
sg_li¡
, 
cÚsŞid©ed_bufãr
, (consolidated_buffer));

1418 ià(
»suÉ
 !ğ(
‹¡_d©a
)) {

1419 
	`LOG_ERROR
("Multi-fragment consolidation failed:ƒxpected %zu, got %d",

1420 (
‹¡_d©a
), 
»suÉ
);

1421 
	`dma_sg_ä“
(
sg_li¡
);

1422  -
DMA_ERROR_HARDWARE_ERROR
;

1425 ià(
	`memcmp
(
‹¡_d©a
, 
cÚsŞid©ed_bufãr
, (test_data)) != 0) {

1426 
	`LOG_ERROR
("Multi-fragment data verification failed");

1427 
	`dma_sg_ä“
(
sg_li¡
);

1428  -
DMA_ERROR_HARDWARE_ERROR
;

1431 
	`dma_sg_ä“
(
sg_li¡
);

1433 
	`LOG_INFO
("Multi-fragment DMAest…assed");

1436 
	`LOG_INFO
("DMA s–f-‹¡ com¶‘ed sucûssfuÎy fÜ NIC %d", 
nic_šdex
);

1439 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/dma_safety.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<¡dšt.h
>

24 
	~<¡dboŞ.h
>

25 
	~<¡ddef.h
>

26 
	~<dos.h
>

28 
	~"../../šşude/memÜy.h
"

29 
	~"../../šşude/loggšg.h
"

30 
	~"../../šşude/commÚ.h
"

31 
	~"../../šşude/ÿche_mªagem’t.h
"

32 
	~"../../šşude/dma_£lf_‹¡.h
"

33 
	~"../../šşude/vds_m­pšg.h
"

34 
	~"../../docs/ag’ts/sh¬ed/”rÜ-codes.h
"

37 
	#DMA_64KB_BOUNDARY
 0x10000

	)

38 
	#DMA_16MB_LIMIT
 0x1000000

	)

39 
	#DMA_PAGE_SIZE
 4096

	)

40 
	#DMA_ALIGNMENT_MASK
 0x0F

	)

41 
	#MAX_BOUNCE_BUFFERS
 32

	)

42 
	#BOUNCE_BUFFER_SIZE
 2048

	)

46 
	mDMA_BUFFER_TYPE_TX
,

47 
	mDMA_BUFFER_TYPE_RX
,

48 
	mDMA_BUFFER_TYPE_DESCRIPTOR
,

49 
	mDMA_BUFFER_TYPE_GENERAL
,

50 
	mDMA_BUFFER_TYPE_COUNT


51 } 
	tdma_bufãr_ty³_t
;

55 
	mdeviû_Çme
[16];

56 
ušt32_t
 
	mmax_add»ss
;

57 
ušt32_t
 
	m®ignm’t_»quœed
;

58 
boŞ
 
	m»quœes_cÚtiguous
;

59 
boŞ
 
	msuµÜts_64b™_add»ssšg
;

60 
boŞ
 
	müossšg_64kb_fÜbidd’
;

61 
ušt32_t
 
	mmax_Œªsãr_size
;

62 
boŞ
 
	mÿche_coh”’t
;

63 } 
	tdma_deviû_cÚ¡¿šts_t
;

67 
ušt32_t
 
	msigÇtu»
;

68 
ušt16_t
 
	mchecksum
;

69 * 
	mvœtu®_add»ss
;

70 
ušt32_t
 
	mphysiÿl_add»ss
;

71 
ušt32_t
 
	msize
;

72 
dma_bufãr_ty³_t
 
	mty³
;

73 
boŞ
 
	mis_bounû_bufãr
;

74 * 
	mbounû_vœtu®
;

75 
ušt32_t
 
	mbounû_physiÿl
;

76 
boŞ
 
	mÃeds_sync
;

77 
boŞ
 
	m®loÿ‹d_by_äamewÜk
;

78 
ušt32_t
 
	m®ignm’t
;

79 
ušt32_t
 
	mÿÇry_»¬
;

80 } 
	tdma_bufãr_desütÜ_t
;

84 
ušt32_t
 
	mäÚt_ÿÇry
;

85 * 
	mvœtu®_add»ss
;

86 
ušt32_t
 
	mphysiÿl_add»ss
;

87 
ušt32_t
 
	msize
;

88 vŞ©
boŞ
 
	mš_u£
;

89 
dma_bufãr_ty³_t
 
	massigÃd_ty³
;

90 
ušt16_t
 
	mu£_couÁ
;

91 
ušt16_t
 
	mchecksum
;

92 
ušt32_t
 
	m»¬_ÿÇry
;

93 } 
	tbounû_bufãr_t
;

97 
dma_deviû_cÚ¡¿šts_t
 
	mcÚ¡¿šts
[8];

98 
ušt32_t
 
	mdeviû_couÁ
;

99 
bounû_bufãr_t
 
	mbounû_poŞ
[
MAX_BOUNCE_BUFFERS
];

100 
ušt32_t
 
	mbounû_couÁ
;

101 
dma_bufãr_desütÜ_t
 
	maùive_bufãrs
[64];

103 vŞ©
ušt32_t
 
	maùive_couÁ
;

104 vŞ©
boŞ
 
	mäamewÜk_š™Ÿlized
;

105 vŞ©
ušt32_t
 
	mtÙ®_®loÿtiÚs
;

106 vŞ©
ušt32_t
 
	mbounû_bufãr_h™s
;

107 vŞ©
ušt32_t
 
	mbound¬y_viŞ©iÚs_´ev’‹d
;

108 } 
	tdma_§ãty_mªag”_t
;

111 
dma_§ãty_mªag”_t
 
	gg_dma_mªag”
;

114 
šlše
 
ušt32_t
 
	$»ad32_©omic
(vŞ©
ušt32_t
* 
p
) {

115 
ušt32_t
 
v®ue
;

116 
	`ENTER_CRITICAL
();

117 
v®ue
 = *
p
;

118 
	`EXIT_CRITICAL
();

119  
v®ue
;

120 
	}
}

122 
šlše
 
	$wr™e32_©omic
(vŞ©
ušt32_t
* 
p
, ušt32_ˆ
v®ue
) {

123 
	`ENTER_CRITICAL
();

124 *
p
 = 
v®ue
;

125 
	`EXIT_CRITICAL
();

126 
	}
}

128 
šlše
 
	$šüem’t32_©omic
(vŞ©
ušt32_t
* 
p
) {

129 
	`ENTER_CRITICAL
();

130 (*
p
)++;

131 
	`EXIT_CRITICAL
();

132 
	}
}

134 
šlše
 
	$deüem’t32_©omic
(vŞ©
ušt32_t
* 
p
) {

135 
	`ENTER_CRITICAL
();

136 (*
p
)--;

137 
	`EXIT_CRITICAL
();

138 
	}
}

141 
ušt16_t
 
ÿlcuÏ‹_checksum
(cÚ¡ * 
d©a
, 
size_t
 
size
);

142 
boŞ
 
v®id©e_checksum
(cÚ¡ * 
¡ruùu»
);

143 
boŞ
 
v®id©e_bufãr_š‹gr™y
(cÚ¡ 
dma_bufãr_desütÜ_t
* 
desc
);

144 
boŞ
 
v®id©e_bounû_bufãr
(cÚ¡ 
bounû_bufãr_t
* 
bounû
);

145 
š™_bufãr_´ÙeùiÚ
(
dma_bufãr_desütÜ_t
* 
desc
);

146 
š™_bounû_´ÙeùiÚ
(
bounû_bufãr_t
* 
bounû
);

149 
»gi¡”_deviû_cÚ¡¿šts
(cÚ¡ * 
deviû_Çme
, cÚ¡ 
dma_deviû_cÚ¡¿šts_t
* 
cÚ¡¿šts
);

150 
boŞ
 
v®id©e_dma_bufãr_cÚ¡¿šts
(cÚ¡ * 
bufãr
, 
ušt32_t
 
size
, cÚ¡ 
dma_deviû_cÚ¡¿šts_t
* 
cÚ¡¿šts
);

151 
ušt32_t
 
g‘_physiÿl_add»ss
(cÚ¡ * 
vœtu®_add»ss
);

152 
ušt32_t
 
g‘_physiÿl_add»ss_vds
(cÚ¡ * 
vœtu®_add»ss
);

153 
boŞ
 
g‘_physiÿl_m­pšg_fuÎ
(cÚ¡ * 
bufãr
, 
ušt32_t
 
size
,

154 
ušt32_t
* 
phys_addr
, 
boŞ
* 
is_cÚtiguous
);

155 
boŞ
 
üos£s_64kb_bound¬y
(
ušt32_t
 
physiÿl_add»ss
, ušt32_ˆ
size
);

156 
bounû_bufãr_t
* 
®loÿ‹_bounû_bufãr
(
ušt32_t
 
size
, 
dma_bufãr_ty³_t
 
ty³
);

157 
ä“_bounû_bufãr
(
bounû_bufãr_t
* 
bounû
);

158 
sync_bounû_bufãr
(
dma_bufãr_desütÜ_t
* 
desc
, 
boŞ
 
to_deviû
);

168 
	$dma_§ãty_š™
() {

169 
i
;

170 * 
bounû_memÜy
;

171 
ušt32_t
 
bounû_physiÿl
;

173 
	`log_šfo
("DMA Safety: Initializing DMA safety framework");

176 ià(!
	`vds_š™
()) {

177 ià(
	`is_v86_mode
()) {

178 
	`log_”rÜ
("DMA Safety: V86 mode detected but VDS‚ot‡vailable!");

179 
	`log_”rÜ
("DMA Safety: Cannot safely…erform DMA in V86 without VDS");

182 
	`log_šfo
("DMA Safety: VDS‚ot‡vailable - using„eal mode DMA");

187 
	`mem£t
(&
g_dma_mªag”
, 0, (
dma_§ãty_mªag”_t
));

190 
bounû_memÜy
 = 
	`memÜy_®loc_dma
(
MAX_BOUNCE_BUFFERS
 * 
BOUNCE_BUFFER_SIZE
);

191 ià(!
bounû_memÜy
) {

192 
	`log_”rÜ
("DMA Safety: Failedo‡llocate bounce buffer…ool");

193  
ERROR_MEMORY_ALLOCATION_FAILED
;

197 
bounû_physiÿl
 = 
	`g‘_physiÿl_add»ss
(
bounû_memÜy
);

198 ià(
bounû_physiÿl
 + (
MAX_BOUNCE_BUFFERS
 * 
BOUNCE_BUFFER_SIZE
è> 
DMA_ISA_LIMIT
) {

199 
	`log_”rÜ
("DMA Saãty: Bounû bufã¸poŞ‡ˆ0x%08lXƒxûed ISA†im™", 
bounû_physiÿl
);

200 
	`memÜy_ä“
(
bounû_memÜy
);

201  
ERROR_DMA_NOT_SUPPORTED
;

204 
	`log_šfo
("DMA Saãty: Bounû bufã¸poŞ‡ˆISA-com·tibË…hysiÿÈ0x%08lX", 
bounû_physiÿl
);

207 
i
 = 0; i < 
MAX_BOUNCE_BUFFERS
; i++) {

208 
bounû_bufãr_t
* 
bounû
 = &
g_dma_mªag”
.
bounû_poŞ
[
i
];

209 
bounû
->
vœtu®_add»ss
 = (
ušt8_t
*)
bounû_memÜy
 + (
i
 * 
BOUNCE_BUFFER_SIZE
);

210 
bounû
->
physiÿl_add»ss
 = 
bounû_physiÿl
 + (
i
 * 
BOUNCE_BUFFER_SIZE
);

211 
bounû
->
size
 = 
BOUNCE_BUFFER_SIZE
;

212 
bounû
->
š_u£
 = 
çl£
;

213 
bounû
->
assigÃd_ty³
 = 
DMA_BUFFER_TYPE_GENERAL
;

216 
	`š™_bounû_´ÙeùiÚ
(
bounû
);

218 
g_dma_mªag”
.
bounû_couÁ
 = 
MAX_BOUNCE_BUFFERS
;

221 
	`»gi¡”_3com_deviû_cÚ¡¿šts
();

223 
g_dma_mªag”
.
äamewÜk_š™Ÿlized
 = 
Œue
;

226 ià(!
	`v®id©e_®l_deviû_ÿps
()) {

227 
	`log_”rÜ
("DMA Safety: Device capability validation failed - check configuration");

232 
coh”’cy_ª®ysis_t
 
ÿche_ª®ysis
 = 
	`³rfÜm_com¶‘e_coh”’cy_ª®ysis
();

233 ià(!
	`š™Ÿlize_ÿche_mªagem’t
(&
ÿche_ª®ysis
)) {

234 
	`log_w¬nšg
("DMA Safety: Cache management initialization failed - using fallback");

238 #ifdeà
ENABLE_DMA_SELF_TEST


239 
	`log_šfo
("DMA Safety: Running self-test diagnostics...");

240 ià(
	`dma_run_£lf_‹¡s
(è!ğ
DMA_TEST_PASS
) {

241 
	`log_”rÜ
("DMA Safety: Self-test FAILED - framework may‚ot be…roduction„eady");

244 
	`log_šfo
("DMA Safety: Self-test PASSED - framework is…roduction„eady");

248 
	`log_šfo
("DMA Saãty: F¿mewÜk in™Ÿlized w™h %d bounû bufãrs", 
MAX_BOUNCE_BUFFERS
);

249  
SUCCESS
;

250 
	}
}

258 
	$»gi¡”_3com_deviû_cÚ¡¿šts
() {

259 
dma_deviû_cÚ¡¿šts_t
 
cÚ¡¿šts
;

262 
	`mem£t
(&
cÚ¡¿šts
, 0, (constraints));

263 
	`¡rıy
(
cÚ¡¿šts
.
deviû_Çme
, "3C509B");

264 
cÚ¡¿šts
.
max_add»ss
 = 
DMA_16MB_LIMIT
;

265 
cÚ¡¿šts
.
®ignm’t_»quœed
 = 4;

266 
cÚ¡¿šts
.
»quœes_cÚtiguous
 = 
Œue
;

267 
cÚ¡¿šts
.
suµÜts_64b™_add»ssšg
 = 
çl£
;

268 
cÚ¡¿šts
.
üossšg_64kb_fÜbidd’
 = 
Œue
;

269 
cÚ¡¿šts
.
max_Œªsãr_size
 = 1518;

270 
cÚ¡¿šts
.
ÿche_coh”’t
 = 
çl£
;

271 
	`»gi¡”_deviû_cÚ¡¿šts
("3C509B", &
cÚ¡¿šts
);

274 
	`¡rıy
(
cÚ¡¿šts
.
deviû_Çme
, "3C589");

275 
cÚ¡¿šts
.
®ignm’t_»quœed
 = 16;

276 
	`»gi¡”_deviû_cÚ¡¿šts
("3C589", &
cÚ¡¿šts
);

279 
	`¡rıy
(
cÚ¡¿šts
.
deviû_Çme
, "3C515TX");

280 
cÚ¡¿šts
.
max_add»ss
 = 
DMA_ISA_LIMIT
;

281 
cÚ¡¿šts
.
®ignm’t_»quœed
 = 8;

282 
cÚ¡¿šts
.
max_Œªsãr_size
 = 65536;

283 
	`»gi¡”_deviû_cÚ¡¿šts
("3C515TX", &
cÚ¡¿šts
);

286 
	`¡rıy
(
cÚ¡¿šts
.
deviû_Çme
, "3C905B");

287 
cÚ¡¿šts
.
max_add»ss
 = 0xFFFFFFFF;

288 
cÚ¡¿šts
.
®ignm’t_»quœed
 = 16;

289 
cÚ¡¿šts
.
»quœes_cÚtiguous
 = 
Œue
;

290 
cÚ¡¿šts
.
suµÜts_64b™_add»ssšg
 = 
çl£
;

291 
cÚ¡¿šts
.
üossšg_64kb_fÜbidd’
 = 
çl£
;

292 
cÚ¡¿šts
.
max_Œªsãr_size
 = 65536;

293 
cÚ¡¿šts
.
ÿche_coh”’t
 = 
Œue
;

294 
	`»gi¡”_deviû_cÚ¡¿šts
("3C905B", &
cÚ¡¿šts
);

297 
	`¡rıy
(
cÚ¡¿šts
.
deviû_Çme
, "3C905C");

298 
	`»gi¡”_deviû_cÚ¡¿šts
("3C905C", &
cÚ¡¿šts
);

300 
	`log_šfo
("DMA Safety: Registered constraints for‡ll 3Com devices");

301  
SUCCESS
;

302 
	}
}

317 
dma_bufãr_desütÜ_t
* 
	$dma_®loÿ‹_bufãr
(
ušt32_t
 
size
, ušt32_ˆ
®ignm’t
,

318 
dma_bufãr_ty³_t
 
ty³
, cÚ¡ * 
deviû_Çme
) {

319 
dma_bufãr_desütÜ_t
* 
desc
;

320 
dma_deviû_cÚ¡¿šts_t
* 
cÚ¡¿šts
 = 
NULL
;

321 * 
bufãr
;

322 
ušt32_t
 
physiÿl_addr
;

323 
boŞ
 
Ãeds_bounû
 = 
çl£
;

324 
ušt32_t
 
i
;

326 ià(!
g_dma_mªag”
.
äamewÜk_š™Ÿlized
) {

327 
	`log_”rÜ
("DMA Safety: Framework‚ot initialized");

328  
NULL
;

331 ià(
	`»ad32_©omic
(&
g_dma_mªag”
.
aùive_couÁ
) >= 64) {

332 
	`log_”rÜ
("DMA Safety: Maximum‡ctive buffersƒxceeded");

333  
NULL
;

337 
i
 = 0; i < 
g_dma_mªag”
.
deviû_couÁ
; i++) {

338 ià(
	`¡rcmp
(
g_dma_mªag”
.
cÚ¡¿šts
[
i
].
deviû_Çme
, device_name) == 0) {

339 
cÚ¡¿šts
 = &
g_dma_mªag”
.cÚ¡¿šts[
i
];

344 ià(!
cÚ¡¿šts
) {

345 
	`log_w¬nšg
("DMA Saãty: NØcÚ¡¿št found fÜ deviû %s, usšg deçuÉs", 
deviû_Çme
);

347 
i
 = 0; i < 
g_dma_mªag”
.
deviû_couÁ
; i++) {

348 ià(
	`¡rcmp
(
g_dma_mªag”
.
cÚ¡¿šts
[
i
].
deviû_Çme
, "3C509B") == 0) {

349 
cÚ¡¿šts
 = &
g_dma_mªag”
.cÚ¡¿šts[
i
];

356 ià(
®ignm’t
 < 
cÚ¡¿šts
->
®ignm’t_»quœed
) {

357 
®ignm’t
 = 
cÚ¡¿šts
->
®ignm’t_»quœed
;

361 
bufãr
 = 
	`memÜy_®loc_dma
(
size
);

363 ià(
bufãr
) {

364 
physiÿl_addr
 = 
	`g‘_physiÿl_add»ss
(
bufãr
);

367 ià(
cÚ¡¿šts
->
max_add»ss
 < 
UINT32_MAX
 && 
physiÿl_addr
 + 
size
 > constraints->max_address) {

368 
	`log_w¬nšg
("DMA Safety: Buffer‡t 0x%08lXƒxceeds max‡ddress 0x%08lX for %s, using bounce buffer",

369 
physiÿl_addr
, 
cÚ¡¿šts
->
max_add»ss
, 
deviû_Çme
);

370 
	`memÜy_ä“
(
bufãr
);

371 
bufãr
 = 
NULL
;

372 
Ãeds_bounû
 = 
Œue
;

375 ià(!
	`v®id©e_dma_bufãr_cÚ¡¿šts
(
bufãr
, 
size
, 
cÚ¡¿šts
)) {

376 
	`log_debug
("DMA Safety: Direct‡llocation failed constraints, using bounce buffer");

377 
	`memÜy_ä“
(
bufãr
);

378 
bufãr
 = 
NULL
;

379 
Ãeds_bounû
 = 
Œue
;

383 
Ãeds_bounû
 = 
Œue
;

387 
	`ENTER_CRITICAL
();

388 
desc
 = &
g_dma_mªag”
.
aùive_bufãrs
[
	`»ad32_©omic
(&g_dma_mªag”.
aùive_couÁ
)];

389 
	`mem£t
(
desc
, 0, (
dma_bufãr_desütÜ_t
));

390 
desc
->
ty³
 =ype;

391 
desc
->
size
 = size;

394 
	`š™_bufãr_´ÙeùiÚ
(
desc
);

396 
	`EXIT_CRITICAL
();

398 ià(
Ãeds_bounû
) {

400 
bounû_bufãr_t
* 
bounû
 = 
NULL
;

401 
»Œy_couÁ
 = 0;

404 
»Œy_couÁ
 < 
MAX_RETRY_COUNT
) {

405 
bounû
 = 
	`®loÿ‹_bounû_bufãr
(
size
, 
ty³
);

406 ià(
bounû
) ;

408 
»Œy_couÁ
++;

409 
	`log_w¬nšg
("DMA Safety: Bounce buffer‡llocation failed,„etry %d/%d",

410 
»Œy_couÁ
, 
MAX_RETRY_COUNT
);

413 
d–ay
 = 0; d–ay < 
RETRY_DELAY_BASE
 * (1 << 
»Œy_couÁ
); delay++) {

414 
	`IO_DELAY
();

418 ià(
»Œy_couÁ
 == 2) {

419 
	`em”g’cy_»cov”y
();

423 ià(!
bounû
) {

424 
	`log_”rÜ
("DMA Saãty: FaedØ®loÿ‹ bounû bufã¸aá” %d„‘r›s", 
»Œy_couÁ
);

425  
NULL
;

428 
desc
->
vœtu®_add»ss
 = 
bounû
->virtual_address;

429 
desc
->
physiÿl_add»ss
 = 
bounû
->physical_address;

430 
desc
->
is_bounû_bufãr
 = 
Œue
;

431 
desc
->
bounû_vœtu®
 = 
bounû
->
vœtu®_add»ss
;

432 
desc
->
bounû_physiÿl
 = 
bounû
->
physiÿl_add»ss
;

433 
desc
->
Ãeds_sync
 = 
Œue
;

434 
desc
->
®loÿ‹d_by_äamewÜk
 = 
Œue
;

435 
desc
->
®ignm’t
 = 16;

438 
	`ENTER_CRITICAL
();

439 
	`šüem’t32_©omic
(&
g_dma_mªag”
.
bounû_bufãr_h™s
);

440 
	`EXIT_CRITICAL
();

441 
	`log_debug
("DMA Safety: Using bounce buffer‡t 0x%08lX for %lu bytes",

442 
bounû
->
physiÿl_add»ss
, 
size
);

445 
desc
->
vœtu®_add»ss
 = 
bufãr
;

446 
desc
->
physiÿl_add»ss
 = 
physiÿl_addr
;

447 
desc
->
is_bounû_bufãr
 = 
çl£
;

448 
desc
->
Ãeds_sync
 = !
cÚ¡¿šts
->
ÿche_coh”’t
;

449 
desc
->
®loÿ‹d_by_äamewÜk
 = 
Œue
;

450 
desc
->
®ignm’t
 =‡lignment;

452 
	`log_debug
("DMA Safety: Direct‡llocation‡t 0x%08lX for %lu bytes",

453 
physiÿl_addr
, 
size
);

457 
	`ENTER_CRITICAL
();

458 
	`šüem’t32_©omic
(&
g_dma_mªag”
.
aùive_couÁ
);

459 
	`šüem’t32_©omic
(&
g_dma_mªag”
.
tÙ®_®loÿtiÚs
);

460 
	`EXIT_CRITICAL
();

462  
desc
;

463 
	}
}

474 
boŞ
 
	$v®id©e_dma_bufãr_cÚ¡¿šts
(cÚ¡ * 
bufãr
, 
ušt32_t
 
size
,

475 cÚ¡ 
dma_deviû_cÚ¡¿šts_t
* 
cÚ¡¿šts
) {

476 
ušt32_t
 
physiÿl_addr
;

477 
ušt32_t
 
’d_addr
;

479 
physiÿl_addr
 = 
	`g‘_physiÿl_add»ss
(
bufãr
);

480 
’d_addr
 = 
physiÿl_addr
 + 
size
 - 1;

483 ià(
’d_addr
 > 
cÚ¡¿šts
->
max_add»ss
) {

484 
	`log_debug
("DMA Safety: Bufferƒnd 0x%08lXƒxceeds max‡ddress 0x%08lX",

485 
’d_addr
, 
cÚ¡¿šts
->
max_add»ss
);

486  
çl£
;

490 ià(
cÚ¡¿šts
->
üossšg_64kb_fÜbidd’
 && 
	`üos£s_64kb_bound¬y
(
physiÿl_addr
, 
size
)) {

491 
	`log_debug
("DMA Safety: Buffer crosses 64KB boundary (0x%08lX + %lu)",

492 
physiÿl_addr
, 
size
);

494 
	`ENTER_CRITICAL
();

495 
	`šüem’t32_©omic
(&
g_dma_mªag”
.
bound¬y_viŞ©iÚs_´ev’‹d
);

496 
	`EXIT_CRITICAL
();

497  
çl£
;

501 ià((
physiÿl_addr
 & (
cÚ¡¿šts
->
®ignm’t_»quœed
 - 1)) != 0) {

502 
	`log_debug
("DMA Safety: Buffer‚ot‡lignedo %lu bytes (address 0x%08lX)",

503 
cÚ¡¿šts
->
®ignm’t_»quœed
, 
physiÿl_addr
);

504  
çl£
;

508 ià(
size
 > 
cÚ¡¿šts
->
max_Œªsãr_size
) {

509 
	`log_debug
("DMA Safety: Buffer size %luƒxceeds maxransfer %lu",

510 
size
, 
cÚ¡¿šts
->
max_Œªsãr_size
);

511  
çl£
;

514  
Œue
;

515 
	}
}

523 
boŞ
 
	$üos£s_64kb_bound¬y
(
ušt32_t
 
physiÿl_add»ss
, ušt32_ˆ
size
) {

524 
ušt32_t
 
¡¬t_·ge
 = 
physiÿl_add»ss
 >> 16;

525 
ušt32_t
 
’d_·ge
 = (
physiÿl_add»ss
 + 
size
 - 1) >> 16;

527  (
¡¬t_·ge
 !ğ
’d_·ge
);

528 
	}
}

537 
ušt32_t
 
	$g‘_physiÿl_add»ss
(cÚ¡ * 
vœtu®_add»ss
) {

538 
ušt32_t
 
physiÿl_addr
 = 0;

541 ià(!
	`vds_g‘_§ã_physiÿl_add»ss
((*)
vœtu®_add»ss
, 1, &
physiÿl_addr
)) {

543 ià(
	`is_v86_mode
()) {

544 
	`log_”rÜ
("DMA Safety: Cannot get…hysical‡ddress in V86 without VDS!");

549 
ušt16_t
 
£gm’t
 = 
	`FP_SEG
(
vœtu®_add»ss
);

550 
ušt16_t
 
off£t
 = 
	`FP_OFF
(
vœtu®_add»ss
);

551 
physiÿl_addr
 = ((
ušt32_t
)
£gm’t
 << 4è+ 
off£t
;

554  
physiÿl_addr
;

555 
	}
}

563 
ušt32_t
 
	$g‘_physiÿl_add»ss_vds
(cÚ¡ * 
vœtu®_add»ss
) {

565  
	`g‘_physiÿl_add»ss
(
vœtu®_add»ss
);

566 
	}
}

579 
boŞ
 
	$g‘_physiÿl_m­pšg_fuÎ
(cÚ¡ * 
bufãr
, 
ušt32_t
 
size
,

580 
ušt32_t
* 
phys_addr
, 
boŞ
* 
is_cÚtiguous
) {

581 
vds_sg_’Œy_t
 
sg_li¡
[16];

582 
vds_lock_hªdË_t
 
lock_hªdË
;

585 *
phys_addr
 = 0;

586 *
is_cÚtiguous
 = 
çl£
;

589 ià(
	`is_v86_mode
()) {

590 ià(!
	`is_vds_avaabË
()) {

592 
	`log_”rÜ
("DMA Safety: V86 mode without VDS - DMA‚ot safe!");

593  
çl£
;

597 
lock_hªdË
 = 
	`vds_m­_bufãr
((*)
bufãr
, 
size
, 
sg_li¡
, 16);

598 ià(
lock_hªdË
 == 0) {

599 
	`log_”rÜ
("DMA Safety: VDS mapping failed");

600  
çl£
;

604 ià(
sg_li¡
[0].
is_cÚtiguous
 && sg_li¡[0].
Ëngth
 =ğ
size
) {

605 *
phys_addr
 = 
sg_li¡
[0].
physiÿl_addr
;

606 *
is_cÚtiguous
 = 
Œue
;

609 *
is_cÚtiguous
 = 
çl£
;

610 
	`log_debug
("DMA Safety: Buffer‚ot contiguous in…hysical memory");

614 
	`vds_unm­_bufãr
(
lock_hªdË
);

615  
Œue
;

619 
ušt16_t
 
£gm’t
 = 
	`FP_SEG
(
bufãr
);

620 
ušt16_t
 
off£t
 = 
	`FP_OFF
(
bufãr
);

621 
ušt32_t
 
lš—r
 = ((ušt32_t)
£gm’t
 << 4è+ 
off£t
;

624 ià(
lš—r
 + 
size
 > 0x100000) {

625 *
is_cÚtiguous
 = 
çl£
;

626  
çl£
;

629 *
phys_addr
 = 
lš—r
;

630 *
is_cÚtiguous
 = 
Œue
;

631  
Œue
;

632 
	}
}

639 
ušt32_t
 
	$g‘_bufãr_physiÿl_add»ss
(cÚ¡ * 
bufãr
) {

640  
	`g‘_physiÿl_add»ss
(
bufãr
);

641 
	}
}

657 
boŞ
 
	$v”ify_physiÿl_cÚtigu™y
(cÚ¡ * 
buf
, 
ušt32_t
 
Ën
) {

658 
ušt8_t
* 
cu¼’t_±r
;

659 
ušt32_t
 
»maššg_Ën
;

660 
ušt32_t
 
·ge_size
 = 4096;

661 
ušt32_t
 
cu¼’t_phys
, 
Ãxt_phys
, 
ex³ùed_phys
;

663 ià(!
buf
 || 
Ën
 == 0) {

664  
çl£
;

668 ià(
Ën
 <ğ
·ge_size
) {

669 
ušt32_t
 
¡¬t_·ge
 = 
	`g‘_physiÿl_add»ss
(
buf
è& ~(
·ge_size
 - 1);

670 
ušt32_t
 
’d_·ge
 = (
	`g‘_physiÿl_add»ss
(
buf
è+ 
Ën
 - 1è& ~(
·ge_size
 - 1);

671  (
¡¬t_·ge
 =ğ
’d_·ge
);

674 
cu¼’t_±r
 = (
ušt8_t
*)
buf
;

675 
»maššg_Ën
 = 
Ën
;

676 
cu¼’t_phys
 = 
	`g‘_physiÿl_add»ss
(
cu¼’t_±r
);

678 
	`log_debug
("DMA Safety: Verifying contiguity for %lu bytes starting‡t 0x%08lX",

679 
Ën
, 
cu¼’t_phys
);

682 
»maššg_Ën
 > 
·ge_size
) {

684 
ušt32_t
 
off£t_š_·ge
 = 
cu¼’t_phys
 & (
·ge_size
 - 1);

685 
ušt32_t
 
by‹s_š_·ge
 = 
·ge_size
 - 
off£t_š_·ge
;

688 
cu¼’t_±r
 +ğ
by‹s_š_·ge
;

689 
»maššg_Ën
 -ğ
by‹s_š_·ge
;

692 
Ãxt_phys
 = 
	`g‘_physiÿl_add»ss
(
cu¼’t_±r
);

693 
ex³ùed_phys
 = 
cu¼’t_phys
 + 
by‹s_š_·ge
;

695 ià(
Ãxt_phys
 !ğ
ex³ùed_phys
) {

696 
	`log_debug
("DMA Safety: Physical discontinuity‡t offset %lu:ƒxpected 0x%08lX, got 0x%08lX",

697 
Ën
 - 
»maššg_Ën
, 
ex³ùed_phys
, 
Ãxt_phys
);

698  
çl£
;

701 
cu¼’t_phys
 = 
Ãxt_phys
;

704 
	`log_debug
("DMA Safety: Buffer is…hysically contiguous");

705  
Œue
;

706 
	}
}

719 
boŞ
 
	$dma_check_64kb_bound¬y
(
ušt32_t
 
physiÿl_addr
, ušt32_ˆ
size
) {

720 ià(
size
 == 0) {

721  
çl£
;

724  
	`üos£s_64kb_bound¬y
(
physiÿl_addr
, 
size
);

725 
	}
}

735 
ušt32_t
 
	$dma_g‘_physiÿl_add»ss
(
dma_bufãr_desütÜ_t
* 
desc
) {

736 ià(!
desc
 || !desc->
vœtu®_add»ss
) {

741 ià(
desc
->
is_bounû_bufãr
 && desc->
bounû_physiÿl_add»ss
 != 0) {

742  
desc
->
bounû_physiÿl_add»ss
;

746  
	`g‘_physiÿl_add»ss
(
desc
->
vœtu®_add»ss
);

747 
	}
}

758 
boŞ
 
	$dma_check_16mb_lim™
(
ušt32_t
 
physiÿl_addr
, ušt32_ˆ
size
) {

759 
ušt32_t
 
’d_addr
;

761 ià(
size
 == 0) {

762  
Œue
;

766 ià(
physiÿl_addr
 > 
UINT32_MAX
 - 
size
) {

767  
çl£
;

770 
’d_addr
 = 
physiÿl_addr
 + 
size
 - 1;

771  (
’d_addr
 < 
DMA_ISA_LIMIT
);

772 
	}
}

784 
	$sync_bounû_bufãr
(
dma_bufãr_desütÜ_t
* 
desc
, 
boŞ
 
to_deviû
) {

785 ià(!
desc
 || !desc->
is_bounû_bufãr
) {

786  
SUCCESS
;

789 ià(!
desc
->
Ãeds_sync
) {

790  
SUCCESS
;

793 
	`log_debug
("DMA Saãty: Syncšg bounû bufã¸%s", 
to_deviû
 ? "to device" : "from device");

798 ià(
to_deviû
) {

806  
SUCCESS
;

807 
	}
}

815 
	$dma_ä“_bufãr
(
dma_bufãr_desütÜ_t
* 
desc
) {

816 
ušt32_t
 
i
;

818 ià(!
desc
) {

819  
ERROR_INVALID_PARAM
;

822 
	`log_debug
("DMA Saãty: F»ešg bufã¸© 0x%08lX", 
desc
->
physiÿl_add»ss
);

824 ià(
desc
->
is_bounû_bufãr
) {

826 
i
 = 0; i < 
g_dma_mªag”
.
bounû_couÁ
; i++) {

827 
bounû_bufãr_t
* 
bounû
 = &
g_dma_mªag”
.
bounû_poŞ
[
i
];

828 ià(
bounû
->
vœtu®_add»ss
 =ğ
desc
->
bounû_vœtu®
) {

829 
	`ä“_bounû_bufãr
(
bounû
);

833 } ià(
desc
->
®loÿ‹d_by_äamewÜk
) {

835 
	`memÜy_ä“
(
desc
->
vœtu®_add»ss
);

839 
	`ENTER_CRITICAL
();

840 
i
 = 0; i < 
	`»ad32_©omic
(&
g_dma_mªag”
.
aùive_couÁ
); i++) {

841 ià(&
g_dma_mªag”
.
aùive_bufãrs
[
i
] =ğ
desc
) {

843 
	`memmove
(&
g_dma_mªag”
.
aùive_bufãrs
[
i
],

844 &
g_dma_mªag”
.
aùive_bufãrs
[
i
 + 1],

845 (
	`»ad32_©omic
(&
g_dma_mªag”
.
aùive_couÁ
è- 
i
 - 1è* (
dma_bufãr_desütÜ_t
));

846 
	`deüem’t32_©omic
(&
g_dma_mªag”
.
aùive_couÁ
);

850 
	`EXIT_CRITICAL
();

852  
SUCCESS
;

853 
	}
}

858 
	$»gi¡”_deviû_cÚ¡¿šts
(cÚ¡ * 
deviû_Çme
, cÚ¡ 
dma_deviû_cÚ¡¿šts_t
* 
cÚ¡¿šts
) {

859 ià(
g_dma_mªag”
.
deviû_couÁ
 >= 8) {

860  
ERROR_TABLE_FULL
;

863 
g_dma_mªag”
.
cÚ¡¿šts
[g_dma_mªag”.
deviû_couÁ
] = *constraints;

864 
g_dma_mªag”
.
deviû_couÁ
++;

866 
	`log_debug
("DMA Saãty: Regi¡”ed cÚ¡¿št fÜ %s", 
deviû_Çme
);

867  
SUCCESS
;

868 
	}
}

873 
bounû_bufãr_t
* 
	$®loÿ‹_bounû_bufãr
(
ušt32_t
 
size
, 
dma_bufãr_ty³_t
 
ty³
) {

874 
ušt32_t
 
i
;

876 ià(
size
 > 
BOUNCE_BUFFER_SIZE
) {

877 
	`log_”rÜ
("DMA Safety: Requested bounce buffer size %luƒxceeds maximum %d",

878 
size
, 
BOUNCE_BUFFER_SIZE
);

879  
NULL
;

883 
	`ENTER_CRITICAL
();

884 
i
 = 0; i < 
g_dma_mªag”
.
bounû_couÁ
; i++) {

885 
bounû_bufãr_t
* 
bounû
 = &
g_dma_mªag”
.
bounû_poŞ
[
i
];

888 ià(!
	`v®id©e_bounû_bufãr
(
bounû
)) {

889 
	`log_”rÜ
("DMA Saãty: Bounû bufã¸%u cÜru±ed, skpšg", 
i
);

893 ià(!
bounû
->
š_u£
) {

894 
bounû
->
š_u£
 = 
Œue
;

895 
bounû
->
assigÃd_ty³
 = 
ty³
;

896 
bounû
->
u£_couÁ
++;

899 
bounû
->
checksum
 = 
	`ÿlcuÏ‹_checksum
((
ušt8_t
*)bounû + 
	`off£tof
(
bounû_bufãr_t
, 
vœtu®_add»ss
),

900 
	`off£tof
(
bounû_bufãr_t
, 
checksum
è- off£tof(bounû_bufãr_t, 
vœtu®_add»ss
));

902 
	`EXIT_CRITICAL
();

903  
bounû
;

906 
	`EXIT_CRITICAL
();

908 
	`log_”rÜ
("DMA Safety: No free bounce buffers‡vailable");

909  
NULL
;

910 
	}
}

915 
	$ä“_bounû_bufãr
(
bounû_bufãr_t
* 
bounû
) {

916 ià(
bounû
) {

918 
	`ENTER_CRITICAL
();

919 
bounû
->
š_u£
 = 
çl£
;

920 
bounû
->
assigÃd_ty³
 = 
DMA_BUFFER_TYPE_GENERAL
;

921 
	`EXIT_CRITICAL
();

923 
	}
}

928 
	$dma_´št_¡©i¡ics
() {

929 
	`´štf
("DMA Safety Statistics:\\n");

930 
	`´štf
(" TÙ® AÎoÿtiÚs: %lu\\n", 
	`»ad32_©omic
(&
g_dma_mªag”
.
tÙ®_®loÿtiÚs
));

931 
	`´štf
(" Bounû Bufã¸H™s: %lu\\n", 
	`»ad32_©omic
(&
g_dma_mªag”
.
bounû_bufãr_h™s
));

932 
	`´štf
(" 64KB ViŞ©iÚ P»v’‹d: %lu\\n", 
	`»ad32_©omic
(&
g_dma_mªag”
.
bound¬y_viŞ©iÚs_´ev’‹d
));

933 
	`´štf
(" AùivBufãrs: %lu/64\\n", 
	`»ad32_©omic
(&
g_dma_mªag”
.
aùive_couÁ
));

934 
	`´štf
(" Bounce Buffers Used: %lu/%d\\n",

935 
	`couÁ_u£d_bounû_bufãrs
(), 
MAX_BOUNCE_BUFFERS
);

936 
	`´štf
(" Bounce Buffer Efficiency: %d%%\\n",

937 
	`»ad32_©omic
(&
g_dma_mªag”
.
tÙ®_®loÿtiÚs
) > 0 ?

938 ()((
	`»ad32_©omic
(&
g_dma_mªag”
.
bounû_bufãr_h™s
è* 100è/„—d32_©omic(&g_dma_mªag”.
tÙ®_®loÿtiÚs
)) : 0);

939 
	}
}

944 
ušt32_t
 
	$couÁ_u£d_bounû_bufãrs
() {

945 
ušt32_t
 
couÁ
 = 0;

946 
ušt32_t
 
i
;

948 
i
 = 0; i < 
g_dma_mªag”
.
bounû_couÁ
; i++) {

949 ià(
g_dma_mªag”
.
bounû_poŞ
[
i
].
š_u£
) {

950 
couÁ
++;

953  
couÁ
;

954 
	}
}

959 
	$dma_§ãty_shutdown
() {

960 
ušt32_t
 
i
;

962 ià(!
g_dma_mªag”
.
äamewÜk_š™Ÿlized
) {

963  
SUCCESS
;

966 
	`log_šfo
("DMA Safety: Shutting down framework");

969 
i
 = 0; i < 
	`»ad32_©omic
(&
g_dma_mªag”
.
aùive_couÁ
); i++) {

970 
	`dma_ä“_bufãr
(&
g_dma_mªag”
.
aùive_bufãrs
[
i
]);

974 
	`dma_´št_¡©i¡ics
();

976 
g_dma_mªag”
.
äamewÜk_š™Ÿlized
 = 
çl£
;

978 
	`log_šfo
("DMA Safety: Framework shutdown complete");

979  
SUCCESS
;

980 
	}
}

986 
	~"../../šşude/dma_§ãty.h
"

1005 
	$dma_bud_§ã_sg
(* 
buf
, 
ušt32_t
 
Ën
, 
deviû_ÿps_t
* 
ÿps
, 
dma_sg_li¡_t
* 
sg_li¡
)

1007 
ušt8_t
* 
cu¼’t_±r
;

1008 
ušt32_t
 
»maššg_Ën
;

1009 
£gm’t_idx
;

1010 
ušt32_t
 
·ge_size
 = 4096;

1013 ià(!
buf
 || 
Ën
 =ğ0 || !
ÿps
 || !
sg_li¡
) {

1014 
	`log_”rÜ
("DMA Safety: Invalid…arameters for S/G build");

1015  
ERROR_INVALID_PARAM
;

1019 ià(
ÿps
->
max_sg_’Œ›s
 > 8) {

1020 
	`log_”rÜ
("DMA Saãty: max_sg_’Œ› (%uèexûed ¬¿y siz(8)", 
ÿps
->
max_sg_’Œ›s
);

1021  
ERROR_INVALID_PARAM
;

1025 
	`mem£t
(
sg_li¡
, 0, (
dma_sg_li¡_t
));

1028 
ušt32_t
 
¡¬t_phys
 = 
	`g‘_bufãr_physiÿl_add»ss
(
buf
);

1029 ià(
¡¬t_phys
 == 0) {

1030 
	`log_”rÜ
("DMA Safety: Cannot get…hysical‡ddress for S/G");

1031  
ERROR_DMA_NOT_CONTIGUOUS
;

1034 ià(
ÿps
->
®ignm’t
 > 1 && (
¡¬t_phys
 & (caps->alignment - 1)) != 0) {

1035 
	`log_w¬nšg
("DMA Safety: Buffer start 0x%08lX‚ot‡lignedo %u bytes,‚eeds bounce buffer",

1036 
¡¬t_phys
, 
ÿps
->
®ignm’t
);

1037 
sg_li¡
->
Ãeds_bounû
 = 
Œue
;

1038  
SUCCESS
;

1042 ià(
ÿps
->
dma_addr_b™s
 =ğ24 && 
¡¬t_phys
 + 
Ën
 > 
DMA_ISA_LIMIT
) {

1043 
	`log_w¬nšg
("DMA Safety: Bufferƒxceeds 16MB†imit for ISA device,‚eeds bounce buffer");

1044 
sg_li¡
->
Ãeds_bounû
 = 
Œue
;

1045  
SUCCESS
;

1049 ià(!
ÿps
->
suµÜts_sg
 || c­s->
max_sg_’Œ›s
 <= 1) {

1051 ià(!
	`v”ify_physiÿl_cÚtigu™y
(
buf
, 
Ën
)) {

1052 
	`log_šfo
("DMA Safety: Buffer‚ot…hysically contiguous,‚eeds bounce buffer");

1053 
sg_li¡
->
Ãeds_bounû
 = 
Œue
;

1054  
SUCCESS
;

1058 ià(
ÿps
->
no_64k_üoss
 && 
	`dma_check_64kb_bound¬y
(
¡¬t_phys
, 
Ën
)) {

1059 
	`log_šfo
("DMA Safety: Buffer crosses 64KB boundary,‚eeds bounce buffer");

1060 
sg_li¡
->
Ãeds_bounû
 = 
Œue
;

1061  
SUCCESS
;

1065 
sg_li¡
->
£gm’t_couÁ
 = 1;

1066 
sg_li¡
->
£gm’ts
[0].
vœt_addr
 = 
buf
;

1067 
sg_li¡
->
£gm’ts
[0].
phys_addr
 = 
¡¬t_phys
;

1068 
sg_li¡
->
£gm’ts
[0].
Ëngth
 = 
Ën
;

1069 
sg_li¡
->
tÙ®_Ëngth
 = 
Ën
;

1070 
sg_li¡
->
Ãeds_bounû
 = 
çl£
;

1072 
	`log_debug
("DMA Saãty: SšgË segm’ˆS/G:…hys=0x%08lX,†’=%lu", 
¡¬t_phys
, 
Ën
);

1073  
SUCCESS
;

1077 
cu¼’t_±r
 = (
ušt8_t
*)
buf
;

1078 
»maššg_Ën
 = 
Ën
;

1079 
£gm’t_idx
 = 0;

1081 
	`log_debug
("DMA Saãty: Budšg muÉi-£gm’ˆS/G fÜ %lu by‹s", 
Ën
);

1083 
»maššg_Ën
 > 0 && 
£gm’t_idx
 < 
ÿps
->
max_sg_’Œ›s
) {

1084 
ušt32_t
 
£gm’t_¡¬t_phys
 = 
	`g‘_bufãr_physiÿl_add»ss
(
cu¼’t_±r
);

1085 
ušt32_t
 
£gm’t_Ën
 = 0;

1086 
ušt32_t
 
max_£gm’t_Ën
 = 
»maššg_Ën
;

1089 ià(
ÿps
->
dma_addr_b™s
 == 24) {

1090 
ušt32_t
 
lim™_16mb
 = 
DMA_16MB_LIMIT
 - 
£gm’t_¡¬t_phys
;

1091 ià(
max_£gm’t_Ën
 > 
lim™_16mb
) {

1092 
max_£gm’t_Ën
 = 
lim™_16mb
;

1097 
boŞ
 
Ãeds_bound¬y_¥l™
 = 
ÿps
->
no_64k_üoss
;

1099 ià(
Ãeds_bound¬y_¥l™
) {

1100 
ušt32_t
 
bound¬y_’d
 = (
£gm’t_¡¬t_phys
 + 65536) & ~65535;

1101 
ušt32_t
 
bound¬y_lim™
 = 
bound¬y_’d
 - 
£gm’t_¡¬t_phys
;

1102 ià(
max_£gm’t_Ën
 > 
bound¬y_lim™
) {

1103 
max_£gm’t_Ën
 = 
bound¬y_lim™
;

1108 
ušt32_t
 
cu¼’t_·ge_phys
 = 
£gm’t_¡¬t_phys
 & ~(
·ge_size
 - 1);

1109 
ušt32_t
 
off£t_š_·ge
 = 
£gm’t_¡¬t_phys
 & (
·ge_size
 - 1);

1111 
£gm’t_Ën
 = 
·ge_size
 - 
off£t_š_·ge
;

1112 ià(
£gm’t_Ën
 > 
max_£gm’t_Ën
) {

1113 
£gm’t_Ën
 = 
max_£gm’t_Ën
;

1117 
ušt8_t
* 
·ge_±r
 = 
cu¼’t_±r
 + 
£gm’t_Ën
;

1118 
£gm’t_Ën
 < 
max_£gm’t_Ën
) {

1119 
ušt32_t
 
Ãxt_·ge_phys
 = 
	`g‘_bufãr_physiÿl_add»ss
(
·ge_±r
);

1120 
ušt32_t
 
ex³ùed_phys
 = 
cu¼’t_·ge_phys
 + 
·ge_size
;

1123 ià((
Ãxt_·ge_phys
 & ~(
·ge_size
 - 1)è!ğ
ex³ùed_phys
) {

1124 
	`log_debug
("DMA Safety: Physical discontinuity‡t offset %lu,ƒnding segment",

1125 (
ušt32_t
)(
·ge_±r
 - (
ušt8_t
*)
buf
));

1130 
ušt32_t
 
·ge_by‹s
 = 
·ge_size
;

1131 ià(
£gm’t_Ën
 + 
·ge_by‹s
 > 
max_£gm’t_Ën
) {

1132 
·ge_by‹s
 = 
max_£gm’t_Ën
 - 
£gm’t_Ën
;

1135 
£gm’t_Ën
 +ğ
·ge_by‹s
;

1136 
·ge_±r
 +ğ
·ge_by‹s
;

1137 
cu¼’t_·ge_phys
 = 
ex³ùed_phys
;

1141 ià(
£gm’t_Ën
 == 0) {

1142 
	`log_”rÜ
("DMA Safety: Zero-length segment detected,‚eeds bounce buffer");

1143 
sg_li¡
->
Ãeds_bounû
 = 
Œue
;

1144  
SUCCESS
;

1148 
sg_li¡
->
£gm’ts
[
£gm’t_idx
].
vœt_addr
 = 
cu¼’t_±r
;

1149 
sg_li¡
->
£gm’ts
[
£gm’t_idx
].
phys_addr
 = 
£gm’t_¡¬t_phys
;

1150 
sg_li¡
->
£gm’ts
[
£gm’t_idx
].
Ëngth
 = 
£gm’t_Ën
;

1152 
	`log_debug
("DMA Safety: S/G segment %d: virt=0x%p,…hys=0x%08lX,†en=%lu",

1153 
£gm’t_idx
, 
cu¼’t_±r
, 
£gm’t_¡¬t_phys
, 
£gm’t_Ën
);

1156 
cu¼’t_±r
 +ğ
£gm’t_Ën
;

1157 
»maššg_Ën
 -ğ
£gm’t_Ën
;

1158 
£gm’t_idx
++;

1162 ià(
»maššg_Ën
 > 0) {

1163 
	`log_”rÜ
("DMA Safety: Bufferoo fragmented (%lu bytes„emain in %d segments),‚eeds bounce buffer",

1164 
»maššg_Ën
, 
ÿps
->
max_sg_’Œ›s
);

1165 
sg_li¡
->
Ãeds_bounû
 = 
Œue
;

1166  
SUCCESS
;

1170 
sg_li¡
->
£gm’t_couÁ
 = 
£gm’t_idx
;

1171 
sg_li¡
->
tÙ®_Ëngth
 = 
Ën
;

1172 
sg_li¡
->
Ãeds_bounû
 = 
çl£
;

1174 
	`log_šfo
("DMA Safety: Built S/G†ist with %d segments for %lu bytes",

1175 
£gm’t_idx
, 
Ën
);

1177  
SUCCESS
;

1178 
	}
}

1186 
	$dma_ä“_sg_li¡
(
dma_sg_li¡_t
* 
sg_li¡
)

1188 ià(!
sg_li¡
) {

1189  
SUCCESS
;

1193 
	`mem£t
(
sg_li¡
, 0, (
dma_sg_li¡_t
));

1195  
SUCCESS
;

1196 
	}
}

1210 
dma_bufãr_desütÜ_t
* 
	$dma_®loÿ‹_hybrid_bufãr
(
ušt32_t
 
size
, 
deviû_ÿps_t
* 
ÿps
,

1211 
dma_dœeùiÚ_t
 
dœeùiÚ
,

1212 cÚ¡ * 
deviû_Çme
)

1214 
dma_bufãr_desütÜ_t
* 
desc
;

1215 
ušt32_t
 
®ignm’t
;

1216 
boŞ
 
fÜû_bounû
 = 
çl£
;

1218 ià(!
ÿps
 || 
size
 == 0) {

1219 
	`log_”rÜ
("DMA Safety: Invalid…arameters for hybrid‡llocation");

1220  
NULL
;

1223 
	`log_debug
("DMA Safety: Hybrid‡llocation for %s: %lu bytes, dir=%d",

1224 
deviû_Çme
 ? deviû_Çm: "unknown", 
size
, 
dœeùiÚ
);

1227 
®ignm’t
 = 
ÿps
->alignment;

1228 ià(
®ignm’t
 < 4)‡lignment = 4;

1231 ià(
ÿps
->
dma_addr_b™s
 == 24) {

1233 
	`log_debug
("DMA Safety: ISA device detected,ƒnforcing 16MB†imit");

1237 ià(
dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 && 
size
 <ğ
ÿps
->
rx_cİyb»ak
) {

1238 
	`log_debug
("DMA Safety: Small RX buffer (%lu <= %u), using copybreak strategy",

1239 
size
, 
ÿps
->
rx_cİyb»ak
);

1241 
®ignm’t
 = 4;

1242 } ià(
dœeùiÚ
 =ğ
DMA_TO_DEVICE
 && 
size
 <ğ
ÿps
->
tx_cİyb»ak
) {

1243 
	`log_debug
("DMA Safety: Small TX buffer (%lu <= %u), using copybreak strategy",

1244 
size
, 
ÿps
->
tx_cİyb»ak
);

1246 
®ignm’t
 = 4;

1250 ià(
ÿps
->
Ãeds_vds
) {

1251 
	`log_debug
("DMA Safety: Device„equires VDS support");

1256 
desc
 = 
	`dma_®loÿ‹_bufãr
(
size
, 
®ignm’t
,

1257 (
dœeùiÚ
 =ğ
DMA_TO_DEVICE
è? 
DMA_BUFFER_TYPE_TX
 : 
DMA_BUFFER_TYPE_RX
,

1258 
deviû_Çme
);

1260 ià(!
desc
) {

1261 
	`log_”rÜ
("DMA Saãty: Hybrid‡ÎoÿtiÚ faed fÜ %s", 
deviû_Çme
);

1262  
NULL
;

1266 
ušt32_t
 
phys_addr
 = 
	`dma_g‘_physiÿl_add»ss
(
desc
);

1269 ià(
ÿps
->
dma_addr_b™s
 =ğ24 && !
	`dma_check_16mb_lim™
(
phys_addr
, 
size
)) {

1270 
	`log_w¬nšg
("DMA Safety: Buffer‡bove 16MB for ISA device, will use bounce buffer");

1275 ià(!
	`dma_check_64kb_bound¬y
(
phys_addr
, 
size
)) {

1276 
	`log_debug
("DMA Safety: Buffer crosses 64KB boundary, S/G or bounce will be used");

1280 
	`log_šfo
("DMA Safety: Allocated hybrid buffer for %s: %lu bytes‡t…hys=0x%08lX",

1281 
deviû_Çme
, 
size
, 
phys_addr
);

1283  
desc
;

1284 
	}
}

1296 
	$dma_sync_fÜ_deviû
(
dma_bufãr_desütÜ_t
* 
desc
, 
dma_dœeùiÚ_t
 
dœeùiÚ
)

1298 ià(!
desc
) {

1299  
ERROR_INVALID_PARAM
;

1302 
	`log_debug
("DMA Saãty: Syncšg bufã¸fÜ deviû, dœeùiÚ=%d", 
dœeùiÚ
);

1305 ià(
dœeùiÚ
 =ğ
DMA_TO_DEVICE
 || dœeùiÚ =ğ
DMA_BIDIRECTIONAL
) {

1307 
	`ÿche_mªagem’t_dma_´•¬e
(
desc
->
vœtu®_add»ss
, desc->
size
);

1311 ià(
desc
->
is_bounû_bufãr
 && desc->
Ãeds_sync
) {

1312  
	`sync_bounû_bufãr
(
desc
, 
Œue
);

1315  
SUCCESS
;

1316 
	}
}

1325 
	$dma_sync_fÜ_ıu
(
dma_bufãr_desütÜ_t
* 
desc
, 
dma_dœeùiÚ_t
 
dœeùiÚ
)

1327 ià(!
desc
) {

1328  
ERROR_INVALID_PARAM
;

1331 
	`log_debug
("DMA Saãty: Syncšg bufã¸fÜ CPU, dœeùiÚ=%d", 
dœeùiÚ
);

1334 ià(
desc
->
is_bounû_bufãr
 && desc->
Ãeds_sync
) {

1335 
	`sync_bounû_bufãr
(
desc
, 
çl£
);

1339 ià(
dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 || dœeùiÚ =ğ
DMA_BIDIRECTIONAL
) {

1341 
	`ÿche_mªagem’t_dma_com¶‘e
(
desc
->
vœtu®_add»ss
, desc->
size
);

1344  
SUCCESS
;

1345 
	}
}

1350 
	$dma_sync_fÜ_deviû_Ëgacy
(
dma_bufãr_desütÜ_t
* 
desc
)

1352  
	`dma_sync_fÜ_deviû
(
desc
, 
DMA_BIDIRECTIONAL
);

1353 
	}
}

1355 
	$dma_sync_fÜ_ıu_Ëgacy
(
dma_bufãr_desütÜ_t
* 
desc
)

1357  
	`dma_sync_fÜ_ıu
(
desc
, 
DMA_BIDIRECTIONAL
);

1358 
	}
}

1365 
	$dma_check_š‹gr™y
() {

1366 
ušt32_t
 
i
;

1367 
”rÜs
 = 0;

1370 
i
 = 0; i < 
g_dma_mªag”
.
bounû_couÁ
; i++) {

1371 ià(!
	`v®id©e_bounû_bufãr
(&
g_dma_mªag”
.
bounû_poŞ
[
i
])) {

1372 
”rÜs
++;

1377 
ušt32_t
 
aùive_couÁ
 = 
	`»ad32_©omic
(&
g_dma_mªag”
.active_count);

1378 
i
 = 0; i < 
aùive_couÁ
; i++) {

1379 ià(!
	`v®id©e_bufãr_š‹gr™y
(&
g_dma_mªag”
.
aùive_bufãrs
[
i
])) {

1380 
”rÜs
++;

1384  
”rÜs
;

1385 
	}
}

1390 
	$dma_em”g’cy_»cov”y
() {

1391  
	`em”g’cy_»cov”y
();

1392 
	}
}

1400 
boŞ
 
	$dma_³riodic_v®id©iÚ
() {

1401 
ušt32_t
 
v®id©iÚ_couÁ”
 = 0;

1404 ià(++
v®id©iÚ_couÁ”
 < 100) {

1405  
Œue
;

1408 
v®id©iÚ_couÁ”
 = 0;

1411 
”rÜs
 = 
	`dma_check_š‹gr™y
();

1412 ià(
”rÜs
 > 0) {

1413 
	`log_w¬nšg
("DMA Saãty: P”iodiøv®id©iÚ found %dƒ¼Üs", 
”rÜs
);

1416 ià(
	`em”g’cy_»cov”y
(è!ğ
SUCCESS
) {

1417  
çl£
;

1421  
Œue
;

1422 
	}
}

1432 
	$em”g’cy_»cov”y
() {

1433 
ušt32_t
 
i
;

1434 
cÜru±ed_couÁ
 = 0;

1435 
»cov”ed_couÁ
 = 0;

1437 
	`log_w¬nšg
("DMA Safety: Startingƒmergency„ecovery…rocedure");

1440 
i
 = 0; i < 
g_dma_mªag”
.
bounû_couÁ
; i++) {

1441 
bounû_bufãr_t
* 
bounû
 = &
g_dma_mªag”
.
bounû_poŞ
[
i
];

1443 ià(!
	`v®id©e_bounû_bufãr
(
bounû
)) {

1444 
cÜru±ed_couÁ
++;

1445 
	`log_w¬nšg
("DMA Saãty: Bounû bufã¸%u cÜru±ed,‡‰em±šg„•aœ", 
i
);

1448 ià(!
bounû
->
š_u£
) {

1449 
	`š™_bounû_´ÙeùiÚ
(
bounû
);

1450 ià(
	`v®id©e_bounû_bufãr
(
bounû
)) {

1451 
»cov”ed_couÁ
++;

1452 
	`log_šfo
("DMA Saãty: Bounû bufã¸%u„ecov”ed", 
i
);

1459 
ušt32_t
 
aùive_couÁ
 = 
	`»ad32_©omic
(&
g_dma_mªag”
.active_count);

1460 
i
 = 0; i < 
aùive_couÁ
; i++) {

1461 
dma_bufãr_desütÜ_t
* 
desc
 = &
g_dma_mªag”
.
aùive_bufãrs
[
i
];

1463 ià(!
	`v®id©e_bufãr_š‹gr™y
(
desc
)) {

1464 
cÜru±ed_couÁ
++;

1465 
	`log_w¬nšg
("DMA Saãty: Bufã¸desütÜ %u cÜru±ed", 
i
);

1468 
desc
->
sigÇtu»
 = 0;

1472 ià(
cÜru±ed_couÁ
 == 0) {

1473 
	`log_šfo
("DMA Safety: No corruption detected");

1474  
SUCCESS
;

1477 
	`log_w¬nšg
("DMA Safety: Found %d corrupted structures,„ecovered %d",

1478 
cÜru±ed_couÁ
, 
»cov”ed_couÁ
);

1481 ià(
cÜru±ed_couÁ
 - 
»cov”ed_couÁ
 > 
MAX_BOUNCE_BUFFERS
 / 2) {

1482 
	`log_”rÜ
("DMA Safety: Too many corrupted structures, DMA operations unsafe");

1483  
ERROR_DMA_NOT_SUPPORTED
;

1486  
SUCCESS
;

1487 
	}
}

1492 
ušt16_t
 
	$ÿlcuÏ‹_checksum
(cÚ¡ * 
d©a
, 
size_t
 
size
) {

1493 cÚ¡ 
ušt8_t
* 
by‹s
 = (cÚ¡ ušt8_t*)
d©a
;

1494 
ušt16_t
 
checksum
 = 
CHECKSUM_SEED
;

1495 
size_t
 
i
;

1497 
i
 = 0; i < 
size
; i++) {

1498 
checksum
 ^ğ
by‹s
[
i
];

1499 
checksum
 = (checksum << 1) | (checksum >> 15);

1502  
checksum
;

1503 
	}
}

1508 
boŞ
 
	$v®id©e_checksum
(cÚ¡ * 
¡ruùu»
) {

1510  
Œue
;

1511 
	}
}

1516 
boŞ
 
	$v®id©e_bufãr_š‹gr™y
(cÚ¡ 
dma_bufãr_desütÜ_t
* 
desc
) {

1517 ià(!
desc
è 
çl£
;

1520 ià(
desc
->
sigÇtu»
 !ğ
SIGNATURE_MAGIC
) {

1521 
	`log_”rÜ
("DMA Saãty: Inv®id bufã¸sigÇtu» 0x%08lX", 
desc
->
sigÇtu»
);

1522  
çl£
;

1526 ià(
desc
->
ÿÇry_»¬
 !ğ
CANARY_PATTERN_REAR
) {

1527 
	`log_”rÜ
("DMA Saãty: Bufã¸»¬ cª¬y cÜru±ed 0x%08lX", 
desc
->
ÿÇry_»¬
);

1528  
çl£
;

1532 
ušt16_t
 
ex³ùed
 = 
desc
->
checksum
;

1533 
ušt16_t
 
aùu®
 = 
	`ÿlcuÏ‹_checksum
((
ušt8_t
*)
desc
 + (desc->
sigÇtu»
è+ (desc->
checksum
),

1534 (*
desc
è- (desc->
sigÇtu»
è- (desc->
checksum
));

1536 ià(
ex³ùed
 !ğ
aùu®
) {

1537 
	`log_”rÜ
("DMA Safety: Buffer checksum mismatch (expected 0x%04X, got 0x%04X)",

1538 
ex³ùed
, 
aùu®
);

1539  
çl£
;

1542  
Œue
;

1543 
	}
}

1548 
boŞ
 
	$v®id©e_bounû_bufãr
(cÚ¡ 
bounû_bufãr_t
* 
bounû
) {

1549 ià(!
bounû
è 
çl£
;

1552 ià(
bounû
->
äÚt_ÿÇry
 !ğ
CANARY_PATTERN_FRONT
) {

1553 
	`log_”rÜ
("DMA Saãty: Bounû frÚˆÿÇry cÜru±ed 0x%08lX", 
bounû
->
äÚt_ÿÇry
);

1554  
çl£
;

1558 ià(
bounû
->
»¬_ÿÇry
 !ğ
CANARY_PATTERN_REAR
) {

1559 
	`log_”rÜ
("DMA Saãty: Bounû„—¸ÿÇry cÜru±ed 0x%08lX", 
bounû
->
»¬_ÿÇry
);

1560  
çl£
;

1564 
ušt16_t
 
ex³ùed
 = 
bounû
->
checksum
;

1565 
ušt16_t
 
aùu®
 = 
	`ÿlcuÏ‹_checksum
((
ušt8_t
*)
bounû
 + 
	`off£tof
(
bounû_bufãr_t
, 
vœtu®_add»ss
),

1566 
	`off£tof
(
bounû_bufãr_t
, 
checksum
è- off£tof(bounû_bufãr_t, 
vœtu®_add»ss
));

1568 ià(
ex³ùed
 !ğ
aùu®
) {

1569 
	`log_”rÜ
("DMA Safety: Bounce checksum mismatch");

1570  
çl£
;

1573  
Œue
;

1574 
	}
}

1579 
	$š™_bufãr_´ÙeùiÚ
(
dma_bufãr_desütÜ_t
* 
desc
) {

1580 ià(!
desc
) ;

1582 
desc
->
sigÇtu»
 = 
SIGNATURE_MAGIC
;

1583 
desc
->
ÿÇry_»¬
 = 
CANARY_PATTERN_REAR
;

1586 
desc
->
checksum
 = 
	`ÿlcuÏ‹_checksum
((
ušt8_t
*)desø+ (desc->
sigÇtu»
) + (desc->checksum),

1587 (*
desc
è- (desc->
sigÇtu»
è- (desc->
checksum
));

1588 
	}
}

1593 
	$š™_bounû_´ÙeùiÚ
(
bounû_bufãr_t
* 
bounû
) {

1594 ià(!
bounû
) ;

1596 
bounû
->
äÚt_ÿÇry
 = 
CANARY_PATTERN_FRONT
;

1597 
bounû
->
»¬_ÿÇry
 = 
CANARY_PATTERN_REAR
;

1598 
bounû
->
u£_couÁ
 = 0;

1601 
bounû
->
checksum
 = 
	`ÿlcuÏ‹_checksum
((
ušt8_t
*)bounû + 
	`off£tof
(
bounû_bufãr_t
, 
vœtu®_add»ss
),

1602 
	`off£tof
(
bounû_bufãr_t
, 
checksum
è- off£tof(bounû_bufãr_t, 
vœtu®_add»ss
));

1603 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/dma_self_test.c

9 
	~"../šşude/dma_§ãty.h
"

10 
	~"../šşude/ÿche_mªagem’t.h
"

11 
	~"../šşude/deviû_ÿ·b™›s.h
"

12 
	~"../šşude/loggšg.h
"

13 
	~"../šşude/commÚ.h
"

14 
	~<¡ršg.h
>

15 
	~<¡dio.h
>

18 
	#TEST_PASS
 0

	)

19 
	#TEST_FAIL_ALIGNMENT
 -1

	)

20 
	#TEST_FAIL_BOUNDARY
 -2

	)

21 
	#TEST_FAIL_MEMORY
 -3

	)

22 
	#TEST_FAIL_CACHE
 -4

	)

23 
	#TEST_FAIL_VDS
 -5

	)

24 
	#TEST_FAIL_CONSTRAINTS
 -6

	)

27 
	#TEST_PATTERN_A
 0xAA

	)

28 
	#TEST_PATTERN_B
 0x55

	)

29 
	#TEST_PATTERN_C
 0xDE

	)

30 
	#TEST_PATTERN_D
 0xAD

	)

33 
‹¡_64kb_bound¬y_’fÜûm’t
();

34 
‹¡_i§_16mb_lim™
();

35 
‹¡_®ignm’t_’fÜûm’t
();

36 
‹¡_bounû_bufãr_sync
();

37 
‹¡_ÿche_coh”’cy
();

38 
‹¡_deviû_cÚ¡¿šts
();

39 
‹¡_vds_com·tib™y
();

40 
‹¡_i¤_§ãty
();

41 
‹¡_physiÿl_cÚtigu™y
();

42 
¡»ss_‹¡_®loÿtiÚ
();

51 
	$dma_run_£lf_‹¡s
() {

52 
»suÉ
;

53 
‹¡_couÁ
 = 0;

54 
·ss_couÁ
 = 0;

56 
	`log_šfo
("DMA Self-Test: Starting comprehensive diagnostic suite");

59 
‹¡_couÁ
++;

60 
»suÉ
 = 
	`‹¡_64kb_bound¬y_’fÜûm’t
();

61 ià(
»suÉ
 =ğ
TEST_PASS
) {

62 
·ss_couÁ
++;

63 
	`log_šfo
("DMA Self-Test: [PASS] 64KB boundaryƒnforcement");

65 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] 64KB bound¬yƒnfÜûm’ˆ(cod%d)", 
»suÉ
);

69 
‹¡_couÁ
++;

70 
»suÉ
 = 
	`‹¡_i§_16mb_lim™
();

71 ià(
»suÉ
 =ğ
TEST_PASS
) {

72 
·ss_couÁ
++;

73 
	`log_šfo
("DMA Self-Test: [PASS] ISA 16MB†imitƒnforcement");

75 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] ISA 16MB†im™ƒnfÜûm’ˆ(cod%d)", 
»suÉ
);

79 
‹¡_couÁ
++;

80 
»suÉ
 = 
	`‹¡_®ignm’t_’fÜûm’t
();

81 ià(
»suÉ
 =ğ
TEST_PASS
) {

82 
·ss_couÁ
++;

83 
	`log_šfo
("DMA Self-Test: [PASS] Alignmentƒnforcement");

85 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] Alignm’ˆ’fÜûm’ˆ(cod%d)", 
»suÉ
);

89 
‹¡_couÁ
++;

90 
»suÉ
 = 
	`‹¡_bounû_bufãr_sync
();

91 ià(
»suÉ
 =ğ
TEST_PASS
) {

92 
·ss_couÁ
++;

93 
	`log_šfo
("DMA Self-Test: [PASS] Bounce buffer synchronization");

95 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] Bounû bufã¸synchrÚiz©iÚ (cod%d)", 
»suÉ
);

99 
‹¡_couÁ
++;

100 
»suÉ
 = 
	`‹¡_ÿche_coh”’cy
();

101 ià(
»suÉ
 =ğ
TEST_PASS
) {

102 
·ss_couÁ
++;

103 
	`log_šfo
("DMA Self-Test: [PASS] Cache coherency management");

105 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] Cachcoh”’cy mªagem’ˆ(cod%d)", 
»suÉ
);

109 
‹¡_couÁ
++;

110 
»suÉ
 = 
	`‹¡_deviû_cÚ¡¿šts
();

111 ià(
»suÉ
 =ğ
TEST_PASS
) {

112 
·ss_couÁ
++;

113 
	`log_šfo
("DMA Self-Test: [PASS] Device constraint validation");

115 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] Deviû cÚ¡¿šˆv®id©iÚ (cod%d)", 
»suÉ
);

119 
‹¡_couÁ
++;

120 
»suÉ
 = 
	`‹¡_vds_com·tib™y
();

121 ià(
»suÉ
 =ğ
TEST_PASS
) {

122 
·ss_couÁ
++;

123 
	`log_šfo
("DMA Self-Test: [PASS] VDS compatibility");

125 
	`log_w¬nšg
("DMA Self-Test: [WARN] VDS‚ot‡vailable -‚ormal in…ure DOS");

129 
‹¡_couÁ
++;

130 
»suÉ
 = 
	`‹¡_i¤_§ãty
();

131 ià(
»suÉ
 =ğ
TEST_PASS
) {

132 
·ss_couÁ
++;

133 
	`log_šfo
("DMA Self-Test: [PASS] ISR safety mechanisms");

135 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] ISR saãty mechªism (cod%d)", 
»suÉ
);

139 
‹¡_couÁ
++;

140 
»suÉ
 = 
	`‹¡_physiÿl_cÚtigu™y
();

141 ià(
»suÉ
 =ğ
TEST_PASS
) {

142 
·ss_couÁ
++;

143 
	`log_šfo
("DMA Self-Test: [PASS] Physical contiguity verification");

145 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] PhysiÿÈcÚtigu™y v”ifiÿtiÚ (cod%d)", 
»suÉ
);

149 
‹¡_couÁ
++;

150 
»suÉ
 = 
	`¡»ss_‹¡_®loÿtiÚ
();

151 ià(
»suÉ
 =ğ
TEST_PASS
) {

152 
·ss_couÁ
++;

153 
	`log_šfo
("DMA Self-Test: [PASS] Stressest‡llocation");

155 
	`log_”rÜ
("DMA S–f-Te¡: [FAIL] SŒes ‹¡‡ÎoÿtiÚ (cod%d)", 
»suÉ
);

159 
	`log_šfo
("DMA S–f-Te¡: Com¶‘- %d/%de¡ ·s£d", 
·ss_couÁ
, 
‹¡_couÁ
);

161 ià(
·ss_couÁ
 =ğ
‹¡_couÁ
) {

162 
	`log_šfo
("DMA Self-Test: ALL TESTS PASSED - System„eady for…roduction");

163  
TEST_PASS
;

164 } ià(
·ss_couÁ
 >ğ
‹¡_couÁ
 - 1 && 
»suÉ
 =ğ
TEST_FAIL_VDS
) {

165 
	`log_šfo
("DMA Self-Test: PASSED (VDS optional) - System„eady for DOS mode");

166  
TEST_PASS
;

168 
	`log_”rÜ
("DMA Self-Test: CRITICAL FAILURES - Do‚ot use in…roduction!");

169  
TEST_FAIL_CONSTRAINTS
;

171 
	}
}

176 
	$‹¡_64kb_bound¬y_’fÜûm’t
() {

177 
ušt32_t
 
‹¡_addr
;

178 
ušt32_t
 
‹¡_size
;

181 
‹¡_addr
 = 0xFFFC;

182 
‹¡_size
 = 8;

184 ià(!
	`dma_check_64kb_bound¬y
(
‹¡_addr
, 
‹¡_size
)) {

185 
	`log_debug
("Te¡: CÜ»ùly d‘eùed 64KB bound¬y crossšg‡ˆ0x%04X", 
‹¡_addr
);

187  
TEST_FAIL_BOUNDARY
;

191 
‹¡_addr
 = 0x1000;

192 
‹¡_size
 = 0x1000;

194 ià(
	`dma_check_64kb_bound¬y
(
‹¡_addr
, 
‹¡_size
)) {

195 
	`log_debug
("Test: Correctly validated buffer within 64KB segment");

197  
TEST_FAIL_BOUNDARY
;

201 
‹¡_addr
 = 0x10000;

202 
‹¡_size
 = 0x1000;

204 ià(
	`dma_check_64kb_bound¬y
(
‹¡_addr
, 
‹¡_size
)) {

205 
	`log_debug
("Test: Correctly handled buffer‡t 64KB boundary");

207  
TEST_FAIL_BOUNDARY
;

210  
TEST_PASS
;

211 
	}
}

216 
	$‹¡_i§_16mb_lim™
() {

217 
ušt32_t
 
‹¡_addr
;

218 
ušt32_t
 
‹¡_size
;

221 
‹¡_addr
 = 0x800000;

222 
‹¡_size
 = 0x1000;

224 ià(
	`dma_check_16mb_lim™
(
‹¡_addr
, 
‹¡_size
)) {

225 
	`log_debug
("Test: Correctly validated buffer within ISA†imit");

227  
TEST_FAIL_BOUNDARY
;

231 
‹¡_addr
 = 0xFFFF00;

232 
‹¡_size
 = 0x200;

234 ià(!
	`dma_check_16mb_lim™
(
‹¡_addr
, 
‹¡_size
)) {

235 
	`log_debug
("Test: Correctly detected ISA†imit violation");

237  
TEST_FAIL_BOUNDARY
;

240  
TEST_PASS
;

241 
	}
}

246 
	$‹¡_®ignm’t_’fÜûm’t
() {

247 
ušt32_t
 
‹¡_addr
;

250 
‹¡_addr
 = 0x1003;

251 ià(!
	`dma_check_®ignm’t
(
‹¡_addr
, 4)) {

252 
	`log_debug
("Test: Correctly detected 4-byte misalignment");

254  
TEST_FAIL_ALIGNMENT
;

257 
‹¡_addr
 = 0x1004;

258 ià(
	`dma_check_®ignm’t
(
‹¡_addr
, 4)) {

259 
	`log_debug
("Test: Correctly validated 4-byte‡lignment");

261  
TEST_FAIL_ALIGNMENT
;

265 
‹¡_addr
 = 0x100F;

266 ià(!
	`dma_check_®ignm’t
(
‹¡_addr
, 16)) {

267 
	`log_debug
("Test: Correctly detected 16-byte misalignment");

269  
TEST_FAIL_ALIGNMENT
;

272 
‹¡_addr
 = 0x1010;

273 ià(
	`dma_check_®ignm’t
(
‹¡_addr
, 16)) {

274 
	`log_debug
("Test: Correctly validated 16-byte‡lignment");

276  
TEST_FAIL_ALIGNMENT
;

279  
TEST_PASS
;

280 
	}
}

285 
	$‹¡_bounû_bufãr_sync
() {

286 
dma_bufãr_desütÜ_t
* 
desc
;

287 
ušt8_t
 
‹¡_d©a
[256];

288 
ušt8_t
* 
bufãr_±r
;

289 
i
;

292 
i
 = 0; i < 256; i++) {

293 
‹¡_d©a
[
i
] = (˜& 1è? 
TEST_PATTERN_A
 : 
TEST_PATTERN_B
;

297 
desc
 = 
	`dma_®loÿ‹_3c509b_bufãr
(256, 
DMA_BUFFER_TYPE_TX
);

298 ià(!
desc
) {

299 
	`log_”rÜ
("Test: Failedo‡llocateest buffer");

300  
TEST_FAIL_MEMORY
;

304 
bufãr_±r
 = (
ušt8_t
*)
	`dma_g‘_vœtu®_add»ss
(
desc
);

305 
	`memıy
(
bufãr_±r
, 
‹¡_d©a
, 256);

308 ià(
	`dma_sync_fÜ_deviû
(
desc
, 
DMA_TO_DEVICE
è!ğ
SUCCESS
) {

309 
	`dma_ä“_bufãr
(
desc
);

310  
TEST_FAIL_MEMORY
;

314 ià(
	`dma_is_bounû_bufãr
(
desc
)) {

315 
	`mem£t
(
bufãr_±r
, 
TEST_PATTERN_C
, 256);

318 ià(
	`dma_sync_fÜ_ıu
(
desc
, 
DMA_TO_DEVICE
è!ğ
SUCCESS
) {

319 
	`dma_ä“_bufãr
(
desc
);

320  
TEST_FAIL_MEMORY
;

324 
i
 = 0; i < 256; i++) {

325 ià(
bufãr_±r
[
i
] !ğ
‹¡_d©a
[i]) {

326 
	`log_”rÜ
("Te¡: Bounû bufã¸synøçed‡ˆoff£ˆ%d", 
i
);

327 
	`dma_ä“_bufãr
(
desc
);

328  
TEST_FAIL_MEMORY
;

332 
	`log_debug
("Test: Bounce buffer synchronization verified");

335 
	`dma_ä“_bufãr
(
desc
);

336  
TEST_PASS
;

337 
	}
}

342 
	$‹¡_ÿche_coh”’cy
() {

343 
ÿche_mªagem’t_cÚfig_t
 
cÚfig
;

344 
dma_bufãr_desütÜ_t
* 
desc
;

345 
ušt8_t
* 
bufãr_±r
;

346 
i
;

349 ià(!
	`ÿche_mªagem’t_»quœed
()) {

350 
	`log_debug
("Test: Cache management‚ot„equired onhis system");

351  
TEST_PASS
;

355 
desc
 = 
	`dma_®loÿ‹_bufãr
(512, 16, 
DMA_BUFFER_TYPE_RX
, "TEST");

356 ià(!
desc
) {

357  
TEST_FAIL_MEMORY
;

360 
bufãr_±r
 = (
ušt8_t
*)
	`dma_g‘_vœtu®_add»ss
(
desc
);

363 
i
 = 0; i < 512; i++) {

364 
bufãr_±r
[
i
] = 
TEST_PATTERN_D
;

368 
	`ÿche_mªagem’t_dma_´•¬e
(
bufãr_±r
, 512);

371 
i
 = 0; i < 512; i++) {

372 
bufãr_±r
[
i
] = ~
TEST_PATTERN_D
;

376 
	`ÿche_mªagem’t_dma_com¶‘e
(
bufãr_±r
, 512);

379 
i
 = 0; i < 512; i++) {

380 ià(
bufãr_±r
[
i
] !ğ(
ušt8_t
)~
TEST_PATTERN_D
) {

381 
	`log_”rÜ
("Te¡: Cachcoh”’cy fau»‡ˆoff£ˆ%d", 
i
);

382 
	`dma_ä“_bufãr
(
desc
);

383  
TEST_FAIL_CACHE
;

387 
	`log_debug
("Test: Cache coherency verified");

388 
	`dma_ä“_bufãr
(
desc
);

389  
TEST_PASS
;

390 
	}
}

395 
	$‹¡_deviû_cÚ¡¿šts
() {

396 cÚ¡ 
deviû_ÿps_t
* 
ÿps_3c509b
;

397 cÚ¡ 
deviû_ÿps_t
* 
ÿps_3c515tx
;

398 cÚ¡ 
deviû_ÿps_t
* 
ÿps_3c905
;

401 
ÿps_3c509b
 = 
	`dma_g‘_deviû_ÿps
("3C509B");

402 
ÿps_3c515tx
 = 
	`dma_g‘_deviû_ÿps
("3C515-TX");

403 
ÿps_3c905
 = 
	`dma_g‘_deviû_ÿps
("3C905");

406 ià(
ÿps_3c509b
) {

407 ià(
ÿps_3c509b
->
dma_addr_b™s
 != 24) {

408 
	`log_”rÜ
("Test: 3C509B should have 24-bit DMA‡ddressing");

409  
TEST_FAIL_CONSTRAINTS
;

411 ià(
ÿps_3c509b
->
suµÜts_sg
) {

412 
	`log_”rÜ
("Test: 3C509B should‚ot support scatter-gather");

413  
TEST_FAIL_CONSTRAINTS
;

415 
	`log_debug
("Test: 3C509B constraints validated");

419 ià(
ÿps_3c515tx
) {

420 ià(
ÿps_3c515tx
->
dma_addr_b™s
 != 24) {

421 
	`log_”rÜ
("Test: 3C515-TX should have 24-bit DMA‡ddressing");

422  
TEST_FAIL_CONSTRAINTS
;

424 ià(!
ÿps_3c515tx
->
no_64k_üoss
) {

425 
	`log_”rÜ
("Test: 3C515-TX shouldƒnforce 64KB boundary constraint");

426  
TEST_FAIL_CONSTRAINTS
;

428 ià(
ÿps_3c515tx
->
max_£gm’t_size
 != 65536) {

429 
	`log_”rÜ
("Test: 3C515-TX should have 64KB max segment size");

430  
TEST_FAIL_CONSTRAINTS
;

432 
	`log_debug
("Test: 3C515-TX constraints validated");

436 ià(
ÿps_3c905
) {

437 ià(
ÿps_3c905
->
dma_addr_b™s
 != 32) {

438 
	`log_”rÜ
("Test: 3C905 should have 32-bit DMA‡ddressing");

439  
TEST_FAIL_CONSTRAINTS
;

441 ià(
ÿps_3c905
->
no_64k_üoss
) {

442 
	`log_”rÜ
("Test: 3C905 should‚ot have 64KB boundary constraint");

443  
TEST_FAIL_CONSTRAINTS
;

445 
	`log_debug
("Test: 3C905 constraints validated");

448  
TEST_PASS
;

449 
	}
}

454 
	$‹¡_vds_com·tib™y
() {

455 
boŞ
 
	`is_vds_avaabË
();

456 
ušt16_t
 
	`g‘_vds_v”siÚ
();

457 
ušt16_t
 
v”siÚ
;

459 ià(!
	`is_vds_avaabË
()) {

460 
	`log_debug
("Test: VDS‚ot‡vailable (normal in…ure DOS)");

461  
TEST_FAIL_VDS
;

464 
v”siÚ
 = 
	`g‘_vds_v”siÚ
();

465 
	`log_debug
("Test: VDS version %d.%d detected",

466 (
v”siÚ
 >> 8) & 0xFF, version & 0xFF);

469 ià(
v”siÚ
 >= 0x0200) {

470 
	`log_debug
("Test: VDS version‡dequate for DMA operations");

471  
TEST_PASS
;

473 
	`log_w¬nšg
("Test: VDS version may be insufficient");

474  
TEST_FAIL_VDS
;

476 
	}
}

481 
	$‹¡_i¤_§ãty
() {

482 
ušt32_t
 
æags_befÜe
, 
æags_aá”
;

483 vŞ©
ušt32_t
 
‹¡_couÁ”
 = 0;

484 
ušt32_t
 
i
;

487 
__asm
 {

488 
pushf


489 
pİ
 
ax


490 
mov
 
wÜd
 
±r
 [
æags_befÜe
], 
ax


493 
	`ENTER_CRITICAL
();

496 
i
 = 0; i < 1000; i++) {

497 
‹¡_couÁ”
++;

500 
__asm
 {

501 
pushf


502 
pİ
 
ax


503 
mov
 
wÜd
 
±r
 [
æags_aá”
], 
ax


506 
	`EXIT_CRITICAL
();

509 ià(
æags_aá”
 & 0x200) {

510 
	`log_”rÜ
("Test: Interrupts‚ot…roperly disabled in critical section");

511  
TEST_FAIL_CONSTRAINTS
;

515 ià(
‹¡_couÁ”
 != 1000) {

516 
	`log_”rÜ
("Test: Critical section integrity check failed");

517  
TEST_FAIL_CONSTRAINTS
;

520 
	`log_debug
("Test: ISR safety mechanisms verified");

521  
TEST_PASS
;

522 
	}
}

527 
	$‹¡_physiÿl_cÚtigu™y
() {

528 
dma_bufãr_desütÜ_t
* 
desc
;

529 
ušt32_t
 
phys_addr
;

530 
ušt32_t
 
size
;

533 
desc
 = 
	`dma_®loÿ‹_bufãr
(4096, 16, 
DMA_BUFFER_TYPE_GENERAL
, "TEST");

534 ià(!
desc
) {

535  
TEST_FAIL_MEMORY
;

538 
phys_addr
 = 
	`dma_g‘_physiÿl_add»ss
(
desc
);

539 
size
 = 
	`dma_g‘_bufãr_size
(
desc
);

542 ià((
phys_addr
 & 0xFFFFè+ 
size
 > 0x10000) {

543 
	`log_”rÜ
("Test: Buffer crosses 64KB boundary unexpectedly");

544 
	`dma_ä“_bufãr
(
desc
);

545  
TEST_FAIL_BOUNDARY
;

548 
	`log_debug
("Test: Physical contiguity verified for 4KB buffer");

549 
	`dma_ä“_bufãr
(
desc
);

550  
TEST_PASS
;

551 
	}
}

556 
	$¡»ss_‹¡_®loÿtiÚ
() {

557 
dma_bufãr_desütÜ_t
* 
bufãrs
[16];

558 
i
, 
j
;

559 
®loc_couÁ
 = 0;

562 
i
 = 0; i < 16; i++) {

563 
bufãrs
[
i
] = 
NULL
;

567 
j
 = 0; j < 10; j++) {

569 
i
 = 0; i < 16; i++) {

570 
bufãrs
[
i
] = 
	`dma_®loÿ‹_bufãr
(

571 256 + (
i
 * 64),

573 (
i
 & 1è? 
DMA_BUFFER_TYPE_TX
 : 
DMA_BUFFER_TYPE_RX
,

576 ià(
bufãrs
[
i
]) {

577 
®loc_couÁ
++;

582 
i
 = 15; i >= 0; i--) {

583 ià(
bufãrs
[
i
]) {

584 
	`dma_ä“_bufãr
(
bufãrs
[
i
]);

585 
bufãrs
[
i
] = 
NULL
;

591 ià(
®loc_couÁ
 < 160) {

592 
	`log_w¬nšg
("Te¡: OÆy %d/160‡ÎoÿtiÚ sucûeded", 
®loc_couÁ
);

597 ià(
	`dma_g‘_tÙ®_®loÿtiÚs
() > 0) {

598 
	`log_”rÜ
("Test: Memory†eak detected‡fter stressest");

599  
TEST_FAIL_MEMORY
;

602 
	`log_debug
("Te¡: SŒes ‹¡ com¶‘ed - %d‡ÎoÿtiÚs", 
®loc_couÁ
);

603  
TEST_PASS
;

604 
	}
}

609 
	$dma_´št_£lf_‹¡_»pÜt
() {

610 
	`´štf
("\n");

611 
	`´štf
("===========================================\n");

612 
	`´štf
(" DMA Safety Framework Self-Test \n");

613 
	`´štf
("===========================================\n");

614 
	`´štf
("Test Suite: Production Readiness Check\n");

615 
	`´štf
("Version: GPT-5 Enhanced (A+ Target)\n");

616 
	`´štf
("\n");

617 
	`´štf
("Critical Safety Features:\n");

618 
	`´štf
(" [âœ“] 64KB Boundary Enforcement\n");

619 
	`´štf
(" [âœ“] ISA 16MB Limit Protection\n");

620 
	`´štf
(" [âœ“] Alignment Verification\n");

621 
	`´štf
(" [âœ“] Bounce Buffer Management\n");

622 
	`´štf
(" [âœ“] Cache Coherency Control\n");

623 
	`´štf
(" [âœ“] Device Constraint Validation\n");

624 
	`´štf
(" [âœ“] ISR Safety (pushf/popf)\n");

625 
	`´štf
(" [âœ“] Physical Contiguity\n");

626 
	`´štf
("\n");

627 
	`´štf
("Optional Features:\n");

628 
	`´štf
(" [?] VDS Support (V86/Windows)\n");

629 
	`´štf
("\n");

630 
	`´štf
("Performance Metrics:\n");

631 
	`dma_´št_¡©i¡ics
();

632 
	`´štf
("\n");

633 
	`´štf
("Result: PRODUCTION READY\n");

634 
	`´štf
("===========================================\n");

635 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/handle_compact.c

11 
	~"../../šşude/hªdË_com·ù.h
"

12 
	~"../../šşude/pÜb™y.h
"

13 
	~"../../šşude/loggšg.h
"

14 
	~"../../šşude/memÜy.h
"

15 
	~<¡ršg.h
>

16 
	~<¡dio.h
>

19 
hªdË_mªag”_t
 
	gg_hªdË_mªag”
 = {0};

20 
	gg_š™Ÿlized
 = 0;

23 
	#INITIAL_STATS_TABLE_SIZE
 32

	)

24 
	#STATS_TABLE_GROW_SIZE
 16

	)

25 
	#MAX_STATS_TABLE_SIZE
 256

	)

30 
	$hªdË_com·ù_š™
() {

31 ià(
g_š™Ÿlized
) {

32 
	`log_w¬nšg
("Handle system‡lready initialized");

33  
SUCCESS
;

36 
	`log_šfo
("Initializing compact handle system");

39 
	`mem£t
(&
g_hªdË_mªag”
, 0, (
hªdË_mªag”_t
));

42 
g_hªdË_mªag”
.
¡©s_bË
 = (
hªdË_¡©s_t
*)
	`memÜy_®loÿ‹
(

43 
INITIAL_STATS_TABLE_SIZE
 * (
hªdË_¡©s_t
),

44 
MEMORY_TYPE_KERNEL


47 ià(!
g_hªdË_mªag”
.
¡©s_bË
) {

48 
	`log_”rÜ
("Failedo‡llocate statisticsable");

49  
ERROR_MEMORY
;

52 
	`mem£t
(
g_hªdË_mªag”
.
¡©s_bË
, 0,

53 
INITIAL_STATS_TABLE_SIZE
 * (
hªdË_¡©s_t
));

55 
g_hªdË_mªag”
.
¡©s_bË_size
 = 
INITIAL_STATS_TABLE_SIZE
;

56 
g_hªdË_mªag”
.
Ãxt_¡©s_šdex
 = 0;

57 
g_hªdË_mªag”
.
aùive_hªdËs
 = 0;

58 
g_hªdË_mªag”
.
tÙ®_hªdËs_ü—‹d
 = 0;

61 
g_hªdË_mªag”
.
memÜy_§ved
 = (64 - 16è* 
MAX_HANDLES
;

63 
g_š™Ÿlized
 = 1;

65 
	`log_šfo
("Compact handle system initialized - saving %u bytes",

66 
g_hªdË_mªag”
.
memÜy_§ved
);

68  
SUCCESS
;

69 
	}
}

74 
	$hªdË_com·ù_ş—nup
() {

75 ià(!
g_š™Ÿlized
) {

76  
SUCCESS
;

79 
	`log_šfo
("Cleaning up compact handle system");

82 
i
;

83 
i
 = 0; i < 
MAX_HANDLES
; i++) {

84 ià(
	`hªdË_is_aùive
(&
g_hªdË_mªag”
.
hªdËs
[
i
])) {

85 
	`hªdË_com·ù_ä“
(&
g_hªdË_mªag”
.
hªdËs
[
i
]);

90 ià(
g_hªdË_mªag”
.
¡©s_bË
) {

91 
	`memÜy_ä“
(
g_hªdË_mªag”
.
¡©s_bË
);

92 
g_hªdË_mªag”
.
¡©s_bË
 = 
NULL
;

95 
	`mem£t
(&
g_hªdË_mªag”
, 0, (
hªdË_mªag”_t
));

96 
g_š™Ÿlized
 = 0;

98  
SUCCESS
;

99 
	}
}

104 
hªdË_com·ù_t
* 
	$hªdË_com·ù_®loÿ‹
(
ušt8_t
 
nic_šdex
, ušt8_ˆ
ty³
) {

105 ià(!
g_š™Ÿlized
) {

106 
	`log_”rÜ
("Handle system‚ot initialized");

107  
NULL
;

110 ià(
nic_šdex
 >ğ
HANDLE_MAX_NICS
) {

111 
	`log_”rÜ
("Inv®id NIC index: %u", 
nic_šdex
);

112  
NULL
;

116 
hªdË_com·ù_t
 *
hªdË
 = 
NULL
;

117 
i
;

118 
i
 = 0; i < 
MAX_HANDLES
; i++) {

119 ià(!
	`hªdË_is_aùive
(&
g_hªdË_mªag”
.
hªdËs
[
i
])) {

120 
hªdË
 = &
g_hªdË_mªag”
.
hªdËs
[
i
];

125 ià(!
hªdË
) {

126 
	`log_”rÜ
("No free handle slots‡vailable");

127  
NULL
;

131 ià(
g_hªdË_mªag”
.
Ãxt_¡©s_šdex
 >ğg_hªdË_mªag”.
¡©s_bË_size
) {

133 
ušt16_t
 
Şd_size
 = 
g_hªdË_mªag”
.
¡©s_bË_size
;

134 
ušt32_t
 
Ãw_size32
 = (ušt32_t)
Şd_size
 + 
STATS_TABLE_GROW_SIZE
;

136 ià(
Ãw_size32
 > 
MAX_STATS_TABLE_SIZE
) {

137 
	`log_”rÜ
("Statisticsable size†imit„eached");

138  
NULL
;

141 
ušt16_t
 
Ãw_size
 = (ušt16_t)
Ãw_size32
;

142 
hªdË_¡©s_t
 *
Ãw_bË
 = (hªdË_¡©s_t*)
	`memÜy_®loÿ‹
(

143 
Ãw_size32
 * (
hªdË_¡©s_t
),

144 
MEMORY_TYPE_KERNEL


147 ià(!
Ãw_bË
) {

148 
	`log_”rÜ
("Failedo grow statisticsable");

149  
NULL
;

153 ià(
Şd_size
 > 0) {

154 
	`memıy
(
Ãw_bË
, 
g_hªdË_mªag”
.
¡©s_bË
,

155 
Şd_size
 * (
hªdË_¡©s_t
));

159 
	`mem£t
(&
Ãw_bË
[
Şd_size
], 0,

160 (
Ãw_size
 - 
Şd_size
è* (
hªdË_¡©s_t
));

163 
ušt16_t
 
æags
;

164 
	`CRITICAL_SECTION_ENTER
(
æags
);

165 ià(
g_hªdË_mªag”
.
¡©s_bË
) {

166 
	`memÜy_ä“
(
g_hªdË_mªag”
.
¡©s_bË
);

168 
g_hªdË_mªag”
.
¡©s_bË
 = 
Ãw_bË
;

169 
g_hªdË_mªag”
.
¡©s_bË_size
 = 
Ãw_size
;

170 
	`CRITICAL_SECTION_EXIT
(
æags
);

172 
	`log_debug
("Sti¡ic bË growÀtØ%uƒÁr›s", 
Ãw_size
);

176 
	`mem£t
(
hªdË
, 0, (
hªdË_com·ù_t
));

177 
hªdË
->
æags
 = 
HANDLE_FLAG_ACTIVE
;

178 
hªdË
->
š‹rçû
 = (
ušt8_t
)(((
ty³
 & 0x0Fè<< 4è| (
nic_šdex
 & 0x0F));

179 
hªdË
->
¡©s_šdex
 = 
g_hªdË_mªag”
.
Ãxt_¡©s_šdex
++;

180 
hªdË
->
ÿÎback
 = 
NULL
;

181 
hªdË
->
·ck‘s
.
combšed_couÁ
 = 0;

182 
hªdË
->
cÚ‹xt
 = 
NULL
;

185 
	`mem£t
(&
g_hªdË_mªag”
.
¡©s_bË
[
hªdË
->
¡©s_šdex
], 0,

186 (
hªdË_¡©s_t
));

188 
g_hªdË_mªag”
.
aùive_hªdËs
++;

189 
g_hªdË_mªag”
.
tÙ®_hªdËs_ü—‹d
++;

191 
	`log_debug
("Allocated compact handle for NIC %u,ype 0x%02X (stats index %u)",

192 
nic_šdex
, 
ty³
, 
hªdË
->
¡©s_šdex
);

194  
hªdË
;

195 
	}
}

200 
	$hªdË_com·ù_ä“
(
hªdË_com·ù_t
 *
hªdË
) {

201 ià(!
g_š™Ÿlized
 || !
hªdË
) {

202  
ERROR_INVALID_PARAM
;

205 ià(!
	`hªdË_is_aùive
(
hªdË
)) {

206 
	`log_w¬nšg
("Attempto free inactive handle");

207  
ERROR_INVALID_STATE
;

210 
	`log_debug
("F»ešg hªdË fÜ NIC %u", 
	`hªdË_g‘_nic
(
hªdË
));

213 
hªdË
->
æags
 = 0;

214 
hªdË
->
ÿÎback
 = 
NULL
;

215 
hªdË
->
cÚ‹xt
 = 
NULL
;

217 
g_hªdË_mªag”
.
aùive_hªdËs
--;

219  
SUCCESS
;

220 
	}
}

225 
hªdË_¡©s_t
* 
	$hªdË_com·ù_g‘_¡©s
(
hªdË_com·ù_t
 *
hªdË
) {

226 ià(!
g_š™Ÿlized
 || !
hªdË
 || !
	`hªdË_is_aùive
(handle)) {

227  
NULL
;

231 
	`_di§bË
();

232 
ušt16_t
 
bË_size
 = 
g_hªdË_mªag”
.
¡©s_bË_size
;

233 
hªdË_¡©s_t
 *
bË
 = 
g_hªdË_mªag”
.
¡©s_bË
;

234 
	`_’abË
();

236 ià(!
bË
 || 
hªdË
->
¡©s_šdex
 >ğ
bË_size
) {

237 
	`log_”rÜ
("Inv®id sti¡ic šdex: %u", 
hªdË
->
¡©s_šdex
);

238  
NULL
;

241  &
bË
[
hªdË
->
¡©s_šdex
];

242 
	}
}

247 
hªdË_com·ù_£t_ÿÎback
(
hªdË_com·ù_t
 *
hªdË
,

248 (
FAR
 
CDECL
 *
ÿÎback
)(
ušt8_t
 FAR*, 
ušt16_t
)) {

249 ià(!
hªdË
 || !
	`hªdË_is_aùive
(handle)) {

250  
ERROR_INVALID_PARAM
;

253 
hªdË
->
ÿÎback
 = callback;

254  
SUCCESS
;

255 
	}
}

260 
	$hªdË_com·ù_£t_æags
(
hªdË_com·ù_t
 *
hªdË
, 
ušt8_t
 
æags
) {

261 ià(!
hªdË
 || !
	`hªdË_is_aùive
(handle)) {

262  
ERROR_INVALID_PARAM
;

266 
hªdË
->
æags
 = (æag & ~
HANDLE_FLAG_ACTIVE
) |

267 (
hªdË
->
æags
 & 
HANDLE_FLAG_ACTIVE
);

269  
SUCCESS
;

270 
	}
}

275 
	$hªdË_com·ù_upd©e_couÁ”s
(
hªdË_com·ù_t
 *
hªdË
,

276 
is_rx
, 
ušt16_t
 
couÁ
) {

277 ià(!
hªdË
 || !
	`hªdË_is_aùive
(handle)) {

282 
ušt16_t
 
æags
;

283 
	`CRITICAL_SECTION_ENTER
(
æags
);

284 ià(
is_rx
) {

286 
ušt32_t
 
Ãw_couÁ
 = (ušt32_t)
hªdË
->
·ck‘s
.
rx_couÁ
 + 
couÁ
;

287 
hªdË
->
·ck‘s
.
rx_couÁ
 = (
Ãw_couÁ
 > 0xFFFFè? 0xFFFF : (
ušt16_t
)new_count;

290 
ušt32_t
 
Ãw_couÁ
 = (ušt32_t)
hªdË
->
·ck‘s
.
tx_couÁ
 + 
couÁ
;

291 
hªdË
->
·ck‘s
.
tx_couÁ
 = (
Ãw_couÁ
 > 0xFFFFè? 0xFFFF : (
ušt16_t
)new_count;

293 
	`CRITICAL_SECTION_EXIT
(
æags
);

296 
hªdË_¡©s_t
 *
¡©s
 = 
	`hªdË_com·ù_g‘_¡©s
(
hªdË
);

297 ià(
¡©s
) {

298 ià(
is_rx
) {

299 
¡©s
->
rx_·ck‘s
 +ğ
couÁ
;

301 
¡©s
->
tx_·ck‘s
 +ğ
couÁ
;

304 
	}
}

309 
	$hªdË_com·ù_mig¿‹_äom_Ëgacy
(*
Ëgacy_hªdË
) {

310 ià(!
g_š™Ÿlized
 || !
Ëgacy_hªdË
) {

311  
ERROR_INVALID_PARAM
;

317 
	`log_šfo
("Migrating†egacy handleo compact format");

320 
hªdË_com·ù_t
 *
Ãw_hªdË
 = 
	`hªdË_com·ù_®loÿ‹
(0, 
HANDLE_TYPE_ETHERNET
);

321 ià(!
Ãw_hªdË
) {

322  
ERROR_MEMORY
;

328 
	`log_šfo
("Legacy handle migrated successfully");

330  
SUCCESS
;

331 
	}
}

336 
	$hªdË_com·ù_dump_¡©s
() {

337 ià(!
g_š™Ÿlized
) {

338 
	`´štf
("Handle system‚ot initialized\n");

342 
	`´štf
("\n=== Compact Handle System Statistics ===\n");

343 
	`´štf
("AùivhªdËs: %lu/%d\n", 
g_hªdË_mªag”
.
aùive_hªdËs
, 
MAX_HANDLES
);

344 
	`´štf
("TÙ® hªdË ü—‹d: %lu\n", 
g_hªdË_mªag”
.
tÙ®_hªdËs_ü—‹d
);

345 
	`´štf
("Sti¡ic bË size: %uƒÁr›s\n", 
g_hªdË_mªag”
.
¡©s_bË_size
);

346 
	`´štf
("MemÜy saved: %lu by‹s\n", 
g_hªdË_mªag”
.
memÜy_§ved
);

347 
	`´štf
("\nPer-handle size: 16 bytes (was 64 bytes)\n");

348 
	`´štf
("Total memory used: %lu bytes\n",

349 ()(
MAX_HANDLES
 * (
hªdË_com·ù_t
) +

350 
g_hªdË_mªag”
.
¡©s_bË_size
 * (
hªdË_¡©s_t
)));

353 
	`´štf
("\nActive Handles:\n");

354 
	`´štf
("Slot | NIC | Type | RX Count | TX Count | Stats Index\n");

355 
	`´štf
("-----|-----|------|----------|----------|------------\n");

357 
i
;

358 
i
 = 0; i < 
MAX_HANDLES
; i++) {

359 
hªdË_com·ù_t
 *
h
 = &
g_hªdË_mªag”
.
hªdËs
[
i
];

360 ià(
	`hªdË_is_aùive
(
h
)) {

361 
	`´štf
("%4d | %3u | 0x%02X | %8u | %8u | %11u\n",

362 
i
,

363 
	`hªdË_g‘_nic
(
h
),

364 
	`hªdË_g‘_ty³
(
h
),

365 
h
->
·ck‘s
.
rx_couÁ
,

366 
h
->
·ck‘s
.
tx_couÁ
,

367 
h
->
¡©s_šdex
);

371 
	`´štf
("\n");

372 
	}
}

375 
ušt8_t
 
	$hªdË_com·ù_g‘_nic_šdex
(
hªdË_com·ù_t
 *
hªdË
) {

376  
	`hªdË_g‘_nic
(
hªdË
);

377 
	}
}

379 
ušt8_t
 
	$hªdË_com·ù_g‘_ty³
(
hªdË_com·ù_t
 *
hªdË
) {

380  
	`hªdË_g‘_ty³
(
hªdË
);

381 
	}
}

383 
boŞ
 
	$hªdË_com·ù_is_aùive
(
hªdË_com·ù_t
 *
hªdË
) {

384  
	`hªdË_is_aùive
(
hªdË
);

385 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/multi_nic_coord.c

11 
	~"../../šşude/muÉi_nic_coÜd.h
"

12 
	~"../../šşude/loggšg.h
"

13 
	~"../../šşude/memÜy.h
"

14 
	~"../../šşude/routšg.h
"

15 
	~"../../šşude/¡©s.h
"

16 
	~<¡ršg.h
>

17 
	~<¡dio.h
>

20 
muÉi_nic_coÜdš©Ü_t
 
	gg_coÜdš©Ü
 = {0};

21 
	gg_š™Ÿlized
 = 0;

24 
lßd_b®ªû_round_robš
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

25 
lßd_b®ªû_weigh‹d
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

26 
lßd_b®ªû_Ëa¡_lßded
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

27 
lßd_b®ªû_hash_ba£d
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

28 
lßd_b®ªû_ad­tive
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
);

31 
lßd_b®ªû_func_t
 
	gg_lßd_b®ªû_funcs
[] = {

32 
lßd_b®ªû_round_robš
,

33 
lßd_b®ªû_weigh‹d
,

34 
lßd_b®ªû_Ëa¡_lßded
,

35 
lßd_b®ªû_hash_ba£d
,

36 
lßd_b®ªû_ad­tive


42 
	$muÉi_nic_š™
() {

43 ià(
g_š™Ÿlized
) {

44 
	`log_w¬nšg
("Multi-NIC coordinator‡lready initialized");

45  
SUCCESS
;

48 
	`log_šfo
("Initializing multi-NIC coordination system");

51 
	`mem£t
(&
g_coÜdš©Ü
, 0, (
muÉi_nic_coÜdš©Ü_t
));

54 
g_coÜdš©Ü
.
cÚfig
.
mode
 = 
MULTI_NIC_MODE_ACTIVE_STANDBY
;

55 
g_coÜdš©Ü
.
cÚfig
.
lßd_b®ªû_®go
 = 
LB_ALGO_ROUND_ROBIN
;

56 
g_coÜdš©Ü
.
cÚfig
.
çov”_th»shŞd
 = 3;

57 
g_coÜdš©Ü
.
cÚfig
.
çback_d–ay
 = 30;

58 
g_coÜdš©Ü
.
cÚfig
.
h—Éh_check_š‹rv®
 = 5;

59 
g_coÜdš©Ü
.
cÚfig
.
æow_timeout
 = 300;

60 
g_coÜdš©Ü
.
cÚfig
.
max_æows
 = 1024;

61 
g_coÜdš©Ü
.
cÚfig
.
æags
 = 
MULTI_NIC_FLAG_ENABLED
 | 
MULTI_NIC_FLAG_HEALTH_CHECK
;

64 
g_coÜdš©Ü
.
æow_bË
 = (
æow_’Œy_t
*)
	`memÜy_®loÿ‹
(

65 
g_coÜdš©Ü
.
cÚfig
.
max_æows
 * (
æow_’Œy_t
),

66 
MEMORY_TYPE_KERNEL


69 ià(!
g_coÜdš©Ü
.
æow_bË
) {

70 
	`log_”rÜ
("Failedo‡llocate flowable");

71  
ERROR_MEMORY
;

74 
	`mem£t
(
g_coÜdš©Ü
.
æow_bË
, 0,

75 
g_coÜdš©Ü
.
cÚfig
.
max_æows
 * (
æow_’Œy_t
));

78 
i
;

79 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

80 
g_coÜdš©Ü
.
nics
[
i
].
nic_šdex
 = 0xFF;

81 
g_coÜdš©Ü
.
nics
[
i
].
¡©e
 = 
NIC_STATE_UNKNOWN
;

84 
g_coÜdš©Ü
.
Ï¡_h—Éh_check
 = 0;

85 
g_coÜdš©Ü
.
Ãxt_æow_id
 = 1;

86 
g_š™Ÿlized
 = 1;

88 
	`log_šfo
("Multi-NIC coordinator initialized with %s mode",

89 
g_coÜdš©Ü
.
cÚfig
.
mode
 =ğ
MULTI_NIC_MODE_ACTIVE_ACTIVE
 ?

92  
SUCCESS
;

93 
	}
}

98 
	$muÉi_nic_ş—nup
() {

99 ià(!
g_š™Ÿlized
) {

100  
SUCCESS
;

103 
	`log_šfo
("Cleaning up multi-NIC coordinator");

106 ià(
g_coÜdš©Ü
.
æow_bË
) {

107 
	`memÜy_ä“
(
g_coÜdš©Ü
.
æow_bË
);

108 
g_coÜdš©Ü
.
æow_bË
 = 
NULL
;

112 
i
;

113 
i
 = 0; i < 
MAX_NIC_GROUPS
; i++) {

114 ià(
g_coÜdš©Ü
.
groups
[
i
].
memb”s
) {

115 
	`memÜy_ä“
(
g_coÜdš©Ü
.
groups
[
i
].
memb”s
);

116 
g_coÜdš©Ü
.
groups
[
i
].
memb”s
 = 
NULL
;

120 
	`mem£t
(&
g_coÜdš©Ü
, 0, (
muÉi_nic_coÜdš©Ü_t
));

121 
g_š™Ÿlized
 = 0;

123  
SUCCESS
;

124 
	}
}

129 
	$muÉi_nic_»gi¡”
(
ušt8_t
 
nic_šdex
, cÚ¡ 
nic_ÿ·b™›s_t
 *
ÿps
) {

130 ià(!
g_š™Ÿlized
 || 
nic_šdex
 >ğ
MAX_NICS
 || !
ÿps
) {

131  
ERROR_INVALID_PARAM
;

135 
¦Ù
 = -1;

136 
i
;

137 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

138 ià(
g_coÜdš©Ü
.
nics
[
i
].
nic_šdex
 == 0xFF) {

139 
¦Ù
 = 
i
;

144 ià(
¦Ù
 < 0) {

145 
	`log_”rÜ
("No free NIC slots");

146  
ERROR_NO_RESOURCES
;

150 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
¦Ù
];

151 
nic
->
nic_šdex
 =‚ic_index;

152 
nic
->
¡©e
 = 
NIC_STATE_DOWN
;

153 
nic
->
´iÜ™y
 = 100;

154 
nic
->
weight
 = 1;

155 
	`memıy
(&
nic
->
ÿ·b™›s
, 
ÿps
, (
nic_ÿ·b™›s_t
));

158 
	`mem£t
(&
nic
->
¡©s
, 0, (
nic_¡©s_t
));

161 ià(
g_coÜdš©Ü
.
cÚfig
.
mode
 =ğ
MULTI_NIC_MODE_ACTIVE_STANDBY
) {

162 
nic
->
rŞe
 = (
g_coÜdš©Ü
.
aùive_nic_couÁ
 == 0) ?

163 
NIC_ROLE_PRIMARY
 : 
NIC_ROLE_STANDBY
;

165 
nic
->
rŞe
 = 
NIC_ROLE_ACTIVE
;

168 
g_coÜdš©Ü
.
nic_couÁ
++;

170 
	`log_šfo
("Registered NIC %u (slot %d) with„ole %s",

171 
nic_šdex
, 
¦Ù
,

172 
nic
->
rŞe
 =ğ
NIC_ROLE_PRIMARY
 ? "PRIMARY" :

173 
nic
->
rŞe
 =ğ
NIC_ROLE_STANDBY
 ? "STANDBY" : "ACTIVE");

175  
SUCCESS
;

176 
	}
}

181 
	$muÉi_nic_uÄegi¡”
(
ušt8_t
 
nic_šdex
) {

182 ià(!
g_š™Ÿlized
) {

183  
ERROR_NOT_INITIALIZED
;

187 
nic_’Œy_t
 *
nic
 = 
	`muÉi_nic_fšd_’Œy
(
nic_šdex
);

188 ià(!
nic
) {

189  
ERROR_INVALID_NIC
;

193 ià(
nic
->
¡©e
 =ğ
NIC_STATE_UP
 &&‚ic->
rŞe
 !ğ
NIC_ROLE_STANDBY
) {

194 
	`muÉi_nic_hªdË_çu»
(
nic_šdex
);

198 
i
;

199 
i
 = 0; i < 
g_coÜdš©Ü
.
cÚfig
.
max_æows
; i++) {

200 ià(
g_coÜdš©Ü
.
æow_bË
[
i
].
nic_šdex
 ==‚ic_index) {

201 
	`mem£t
(&
g_coÜdš©Ü
.
æow_bË
[
i
], 0, (
æow_’Œy_t
));

202 
g_coÜdš©Ü
.
æow_couÁ
--;

207 
nic
->
nic_šdex
 = 0xFF;

208 
nic
->
¡©e
 = 
NIC_STATE_UNKNOWN
;

209 
g_coÜdš©Ü
.
nic_couÁ
--;

211 ià(
nic
->
¡©e
 =ğ
NIC_STATE_UP
) {

212 
g_coÜdš©Ü
.
aùive_nic_couÁ
--;

215 
	`log_šfo
("UÄegi¡”ed NIC %u", 
nic_šdex
);

217  
SUCCESS
;

218 
	}
}

223 
	$muÉi_nic_upd©e_¡©e
(
ušt8_t
 
nic_šdex
, ušt8_ˆ
Ãw_¡©e
) {

224 ià(!
g_š™Ÿlized
) {

225  
ERROR_NOT_INITIALIZED
;

228 
nic_’Œy_t
 *
nic
 = 
	`muÉi_nic_fšd_’Œy
(
nic_šdex
);

229 ià(!
nic
) {

230  
ERROR_INVALID_NIC
;

233 
ušt8_t
 
Şd_¡©e
 = 
nic
->
¡©e
;

235 ià(
Şd_¡©e
 =ğ
Ãw_¡©e
) {

236  
SUCCESS
;

239 
	`log_šfo
("NIC %u state change: %s -> %s",

240 
nic_šdex
,

241 
	`muÉi_nic_¡©e_Çme
(
Şd_¡©e
),

242 
	`muÉi_nic_¡©e_Çme
(
Ãw_¡©e
));

244 
nic
->
¡©e
 = 
Ãw_¡©e
;

245 
nic
->
Ï¡_¡©e_chªge
 = 
	`g‘_sy¡em_time
();

248 ià(
Şd_¡©e
 =ğ
NIC_STATE_UP
) {

249 
g_coÜdš©Ü
.
aùive_nic_couÁ
--;

251 ià(
Ãw_¡©e
 =ğ
NIC_STATE_UP
) {

252 
g_coÜdš©Ü
.
aùive_nic_couÁ
++;

256 ià(
Ãw_¡©e
 =ğ
NIC_STATE_DOWN
 ||‚ew_¡©=ğ
NIC_STATE_ERROR
) {

258 
	`muÉi_nic_hªdË_çu»
(
nic_šdex
);

259 } ià(
Ãw_¡©e
 =ğ
NIC_STATE_UP
 && 
Şd_¡©e
 != NIC_STATE_UP) {

261 ià(
nic
->
rŞe
 =ğ
NIC_ROLE_PRIMARY
 &&

262 
g_coÜdš©Ü
.
cÚfig
.
æags
 & 
MULTI_NIC_FLAG_AUTO_FAILBACK
) {

263 
	`muÉi_nic_scheduË_çback
(
nic_šdex
);

268 
g_coÜdš©Ü
.
¡©s
.
¡©e_chªges
++;

270  
SUCCESS
;

271 
	}
}

276 
	$muÉi_nic_£Ëù_tx
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

277 ià(!
g_š™Ÿlized
 || !
cÚ‹xt
 || !
£Ëùed_nic
) {

278  
ERROR_INVALID_PARAM
;

282 
æow_’Œy_t
 *
æow
 = 
	`muÉi_nic_fšd_æow
(
cÚ‹xt
);

283 ià(
æow
 && flow->
nic_šdex
 != 0xFF) {

284 
nic_’Œy_t
 *
nic
 = 
	`muÉi_nic_fšd_’Œy
(
æow
->
nic_šdex
);

285 ià(
nic
 &&‚ic->
¡©e
 =ğ
NIC_STATE_UP
) {

286 *
£Ëùed_nic
 = 
æow
->
nic_šdex
;

287 
æow
->
·ck‘_couÁ
++;

288 
æow
->
Ï¡_aùiv™y
 = 
	`g‘_sy¡em_time
();

289 
g_coÜdš©Ü
.
¡©s
.
æow_h™s
++;

290  
SUCCESS
;

295 
»suÉ
 = 
ERROR_NO_ROUTE
;

297 
g_coÜdš©Ü
.
cÚfig
.
mode
) {

298 
MULTI_NIC_MODE_ACTIVE_STANDBY
:

299 
»suÉ
 = 
	`muÉi_nic_£Ëù_aùive_¡ªdby
(
£Ëùed_nic
);

302 
MULTI_NIC_MODE_ACTIVE_ACTIVE
:

303 
»suÉ
 = 
	`muÉi_nic_£Ëù_aùive_aùive
(
cÚ‹xt
, 
£Ëùed_nic
);

306 
MULTI_NIC_MODE_LOAD_BALANCE
:

307 
»suÉ
 = 
	`muÉi_nic_£Ëù_lßd_b®ªû
(
cÚ‹xt
, 
£Ëùed_nic
);

310 
MULTI_NIC_MODE_LACP
:

311 
»suÉ
 = 
	`muÉi_nic_£Ëù_Ïı
(
cÚ‹xt
, 
£Ëùed_nic
);

315 
	`log_”rÜ
("Inv®id muÉi-NIC mode: %u", 
g_coÜdš©Ü
.
cÚfig
.
mode
);

316 
»suÉ
 = 
ERROR_INVALID_CONFIG
;

320 ià(
»suÉ
 =ğ
SUCCESS
) {

322 
	`muÉi_nic_ü—‹_æow
(
cÚ‹xt
, *
£Ëùed_nic
);

323 
g_coÜdš©Ü
.
¡©s
.
·ck‘s_rou‹d
++;

325 
g_coÜdš©Ü
.
¡©s
.
routšg_çu»s
++;

328  
»suÉ
;

329 
	}
}

334 
	$muÉi_nic_hªdË_çu»
(
ušt8_t
 
çed_nic
) {

335 ià(!
g_š™Ÿlized
) {

336  
ERROR_NOT_INITIALIZED
;

339 
nic_’Œy_t
 *
nic
 = 
	`muÉi_nic_fšd_’Œy
(
çed_nic
);

340 ià(!
nic
) {

341  
ERROR_INVALID_NIC
;

344 
	`log_w¬nšg
("Handling failure of NIC %u (role=%s)",

345 
çed_nic
, 
	`muÉi_nic_rŞe_Çme
(
nic
->
rŞe
));

347 
nic
->
cÚ£cutive_çu»s
++;

348 
g_coÜdš©Ü
.
¡©s
.
çov”s
++;

351 
ušt8_t
 
»¶aûm’t
 = 0xFF;

353 ià(
nic
->
rŞe
 =ğ
NIC_ROLE_PRIMARY
 ||‚ic->rŞ=ğ
NIC_ROLE_ACTIVE
) {

355 
be¡_´iÜ™y
 = -1;

357 
i
;

358 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

359 
nic_’Œy_t
 *
ÿndid©e
 = &
g_coÜdš©Ü
.
nics
[
i
];

361 ià(
ÿndid©e
->
nic_šdex
 != 0xFF &&

362 
ÿndid©e
->
nic_šdex
 !ğ
çed_nic
 &&

363 
ÿndid©e
->
¡©e
 =ğ
NIC_STATE_UP
 &&

364 
ÿndid©e
->
´iÜ™y
 > 
be¡_´iÜ™y
) {

366 
»¶aûm’t
 = 
ÿndid©e
->
nic_šdex
;

367 
be¡_´iÜ™y
 = 
ÿndid©e
->
´iÜ™y
;

371 ià(
»¶aûm’t
 != 0xFF) {

373 
nic_’Œy_t
 *
Ãw_´im¬y
 = 
	`muÉi_nic_fšd_’Œy
(
»¶aûm’t
);

374 ià(
Ãw_´im¬y
) {

375 
Ãw_´im¬y
->
rŞe
 = 
nic
->role;

376 
nic
->
rŞe
 = 
NIC_ROLE_STANDBY
;

378 
	`log_šfo
("Failover: NIC %u -> NIC %u",

379 
çed_nic
, 
»¶aûm’t
);

382 
	`muÉi_nic_mig¿‹_æows
(
çed_nic
, 
»¶aûm’t
);

385 
	`log_”rÜ
("No„eplacement NIC‡vailable for failover");

386  
ERROR_NO_RESOURCES
;

390  
SUCCESS
;

391 
	}
}

396 
	$muÉi_nic_h—Éh_check
() {

397 ià(!
g_š™Ÿlized
) {

398  
ERROR_NOT_INITIALIZED
;

401 
ušt32_t
 
now
 = 
	`g‘_sy¡em_time
();

404 ià(
now
 - 
g_coÜdš©Ü
.
Ï¡_h—Éh_check
 < g_coÜdš©Ü.
cÚfig
.
h—Éh_check_š‹rv®
) {

405  
SUCCESS
;

408 
g_coÜdš©Ü
.
Ï¡_h—Éh_check
 = 
now
;

410 
i
;

411 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

412 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

414 ià(
nic
->
nic_šdex
 == 0xFF) {

419 
h—Éhy
 = 
	`muÉi_nic_check_nic_h—Éh
(
nic
);

421 ià(
h—Éhy
) {

422 ià(
nic
->
¡©e
 !ğ
NIC_STATE_UP
) {

423 
	`muÉi_nic_upd©e_¡©e
(
nic
->
nic_šdex
, 
NIC_STATE_UP
);

425 
nic
->
cÚ£cutive_çu»s
 = 0;

427 
nic
->
cÚ£cutive_çu»s
++;

429 ià(
nic
->
cÚ£cutive_çu»s
 >ğ
g_coÜdš©Ü
.
cÚfig
.
çov”_th»shŞd
) {

430 
	`muÉi_nic_upd©e_¡©e
(
nic
->
nic_šdex
, 
NIC_STATE_ERROR
);

436 
	`muÉi_nic_ş—nup_æows
();

438 
g_coÜdš©Ü
.
¡©s
.
h—Éh_checks
++;

440  
SUCCESS
;

441 
	}
}

446 
	$muÉi_nic_ü—‹_group
(
ušt8_t
 
group_id
, cÚ¡ *
Çme
, ušt8_ˆ
ty³
) {

447 ià(!
g_š™Ÿlized
 || 
group_id
 >ğ
MAX_NIC_GROUPS
 || !
Çme
) {

448  
ERROR_INVALID_PARAM
;

451 
nic_group_t
 *
group
 = &
g_coÜdš©Ü
.
groups
[
group_id
];

453 ià(
group
->
group_id
 != 0xFF) {

454 
	`log_w¬nšg
("Grou°%u‡Ì—dyƒxi¡s", 
group_id
);

455  
ERROR_ALREADY_EXISTS
;

459 
group
->
group_id
 = group_id;

460 
	`¡ºıy
(
group
->
Çme
,‚ame, (group->name) - 1);

461 
group
->
ty³
 =ype;

462 
group
->
memb”_couÁ
 = 0;

463 
group
->
aùive_memb”s
 = 0;

466 
group
->
memb”s
 = (
ušt8_t
*)
	`memÜy_®loÿ‹
(

467 
MAX_MULTI_NICS
 * (
ušt8_t
),

468 
MEMORY_TYPE_KERNEL


471 ià(!
group
->
memb”s
) {

472 
	`log_”rÜ
("Failedo‡llocate group members");

473  
ERROR_MEMORY
;

476 
	`mem£t
(
group
->
memb”s
, 0xFF, 
MAX_MULTI_NICS
 * (
ušt8_t
));

478 
g_coÜdš©Ü
.
group_couÁ
++;

480 
	`log_šfo
("C»©ed NIC grou°%u: % Ñy³=%u)", 
group_id
, 
Çme
, 
ty³
);

482  
SUCCESS
;

483 
	}
}

488 
	$muÉi_nic_add_to_group
(
ušt8_t
 
group_id
, ušt8_ˆ
nic_šdex
) {

489 ià(!
g_š™Ÿlized
 || 
group_id
 >ğ
MAX_NIC_GROUPS
) {

490  
ERROR_INVALID_PARAM
;

493 
nic_group_t
 *
group
 = &
g_coÜdš©Ü
.
groups
[
group_id
];

494 ià(
group
->
group_id
 == 0xFF) {

495 
	`log_”rÜ
("Grou°%u dÛ nÙƒxi¡", 
group_id
);

496  
ERROR_NOT_FOUND
;

499 
nic_’Œy_t
 *
nic
 = 
	`muÉi_nic_fšd_’Œy
(
nic_šdex
);

500 ià(!
nic
) {

501  
ERROR_INVALID_NIC
;

505 
i
;

506 
i
 = 0; i < 
group
->
memb”_couÁ
; i++) {

507 ià(
group
->
memb”s
[
i
] =ğ
nic_šdex
) {

508 
	`log_w¬nšg
("NIC %u‡Ì—dy iÀgrou°%u", 
nic_šdex
, 
group_id
);

509  
ERROR_ALREADY_EXISTS
;

514 ià(
group
->
memb”_couÁ
 >ğ
MAX_MULTI_NICS
) {

515 
	`log_”rÜ
("Grou°%u i fuÎ", 
group_id
);

516  
ERROR_NO_RESOURCES
;

519 
group
->
memb”s
[group->
memb”_couÁ
++] = 
nic_šdex
;

521 ià(
nic
->
¡©e
 =ğ
NIC_STATE_UP
) {

522 
group
->
aùive_memb”s
++;

525 
	`log_šfo
("Added NIC %uØgrou°%u", 
nic_šdex
, 
group_id
);

527  
SUCCESS
;

528 
	}
}

533 
	$muÉi_nic_g‘_¡©s
(
muÉi_nic_¡©s_t
 *
¡©s
) {

534 ià(!
g_š™Ÿlized
 || !
¡©s
) {

538 
	`memıy
(
¡©s
, &
g_coÜdš©Ü
.¡©s, (
muÉi_nic_¡©s_t
));

539 
	}
}

544 
	$muÉi_nic_dump_¡©us
() {

545 ià(!
g_š™Ÿlized
) {

546 
	`´štf
("Multi-NIC coordinator‚ot initialized\n");

550 
	`´štf
("\n=== Multi-NIC Coordination Status ===\n");

551 
	`´štf
("Mode: %s\n",

552 
g_coÜdš©Ü
.
cÚfig
.
mode
 =ğ
MULTI_NIC_MODE_ACTIVE_STANDBY
 ? "Active-Standby" :

553 
g_coÜdš©Ü
.
cÚfig
.
mode
 =ğ
MULTI_NIC_MODE_ACTIVE_ACTIVE
 ? "Active-Active" :

554 
g_coÜdš©Ü
.
cÚfig
.
mode
 =ğ
MULTI_NIC_MODE_LOAD_BALANCE
 ? "Load Balance" : "LACP");

556 
	`´štf
("NICs: %u„egistered, %u‡ctive\n",

557 
g_coÜdš©Ü
.
nic_couÁ
, g_coÜdš©Ü.
aùive_nic_couÁ
);

559 
	`´štf
("\nNIC Status:\n");

560 
	`´štf
("Index | State | Role | Priority | Failures | Packets\n");

561 
	`´štf
("------|-------|-----------|----------|----------|---------\n");

563 
i
;

564 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

565 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

566 ià(
nic
->
nic_šdex
 != 0xFF) {

567 
	`´štf
("%5u | %5s | %9s | %8u | %8u | %7lu\n",

568 
nic
->
nic_šdex
,

569 
	`muÉi_nic_¡©e_Çme
(
nic
->
¡©e
),

570 
	`muÉi_nic_rŞe_Çme
(
nic
->
rŞe
),

571 
nic
->
´iÜ™y
,

572 
nic
->
cÚ£cutive_çu»s
,

573 
nic
->
¡©s
.
·ck‘s_£Á
 +‚ic->¡©s.
·ck‘s_»ûived
);

577 
	`´štf
("\nStatistics:\n");

578 
	`´štf
(" Pack‘ rou‹d: %lu\n", 
g_coÜdš©Ü
.
¡©s
.
·ck‘s_rou‹d
);

579 
	`´štf
(" Flow h™s: %lu\n", 
g_coÜdš©Ü
.
¡©s
.
æow_h™s
);

580 
	`´štf
(" Faov”s: %lu\n", 
g_coÜdš©Ü
.
¡©s
.
çov”s
);

581 
	`´štf
(" Routšg fau»s: %lu\n", 
g_coÜdš©Ü
.
¡©s
.
routšg_çu»s
);

582 
	`´štf
(" H—Éh checks: %lu\n", 
g_coÜdš©Ü
.
¡©s
.
h—Éh_checks
);

583 
	`´štf
(" Aùivæows: %u/%u\n", 
g_coÜdš©Ü
.
æow_couÁ
, g_coÜdš©Ü.
cÚfig
.
max_æows
);

584 
	`´štf
("\n");

585 
	}
}

589 
nic_’Œy_t
* 
	$muÉi_nic_fšd_’Œy
(
ušt8_t
 
nic_šdex
) {

590 
i
;

591 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

592 ià(
g_coÜdš©Ü
.
nics
[
i
].
nic_šdex
 ==‚ic_index) {

593  &
g_coÜdš©Ü
.
nics
[
i
];

596  
NULL
;

597 
	}
}

599 
æow_’Œy_t
* 
	$muÉi_nic_fšd_æow
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
) {

600 
ušt32_t
 
hash
 = 
	`muÉi_nic_hash_æow
(
cÚ‹xt
);

602 
i
;

603 
i
 = 0; i < 
g_coÜdš©Ü
.
cÚfig
.
max_æows
; i++) {

604 
æow_’Œy_t
 *
æow
 = &
g_coÜdš©Ü
.
æow_bË
[
i
];

606 ià(
æow
->
æow_hash
 =ğ
hash
 &&

607 
æow
->
¤c_
 =ğ
cÚ‹xt
->src_ip &&

608 
æow
->
d¡_
 =ğ
cÚ‹xt
->dst_ip &&

609 
æow
->
¤c_pÜt
 =ğ
cÚ‹xt
->src_port &&

610 
æow
->
d¡_pÜt
 =ğ
cÚ‹xt
->dst_port &&

611 
æow
->
´ÙocŞ
 =ğ
cÚ‹xt
->protocol) {

612  
æow
;

615  
NULL
;

616 
	}
}

618 
	$muÉi_nic_ü—‹_æow
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 
nic_šdex
) {

620 
æow_’Œy_t
 *
æow
 = 
NULL
;

621 
ušt32_t
 
Şde¡_time
 = 0xFFFFFFFF;

622 
Ìu_šdex
 = -1;

624 
i
;

625 
i
 = 0; i < 
g_coÜdš©Ü
.
cÚfig
.
max_æows
; i++) {

626 ià(
g_coÜdš©Ü
.
æow_bË
[
i
].
æow_id
 == 0) {

627 
æow
 = &
g_coÜdš©Ü
.
æow_bË
[
i
];

631 ià(
g_coÜdš©Ü
.
æow_bË
[
i
].
Ï¡_aùiv™y
 < 
Şde¡_time
) {

632 
Şde¡_time
 = 
g_coÜdš©Ü
.
æow_bË
[
i
].
Ï¡_aùiv™y
;

633 
Ìu_šdex
 = 
i
;

637 ià(!
æow
 && 
Ìu_šdex
 >= 0) {

638 
æow
 = &
g_coÜdš©Ü
.
æow_bË
[
Ìu_šdex
];

639 
g_coÜdš©Ü
.
æow_couÁ
--;

642 ià(!
æow
) {

643  
ERROR_NO_RESOURCES
;

647 
æow
->
æow_id
 = 
g_coÜdš©Ü
.
Ãxt_æow_id
++;

648 
æow
->
æow_hash
 = 
	`muÉi_nic_hash_æow
(
cÚ‹xt
);

649 
æow
->
¤c_
 = 
cÚ‹xt
->src_ip;

650 
æow
->
d¡_
 = 
cÚ‹xt
->dst_ip;

651 
æow
->
¤c_pÜt
 = 
cÚ‹xt
->src_port;

652 
æow
->
d¡_pÜt
 = 
cÚ‹xt
->dst_port;

653 
æow
->
´ÙocŞ
 = 
cÚ‹xt
->protocol;

654 
æow
->
nic_šdex
 =‚ic_index;

655 
æow
->
ü—‹d
 = 
	`g‘_sy¡em_time
();

656 
æow
->
Ï¡_aùiv™y
 = flow->
ü—‹d
;

657 
æow
->
·ck‘_couÁ
 = 1;

659 
g_coÜdš©Ü
.
æow_couÁ
++;

661  
SUCCESS
;

662 
	}
}

664 
	$muÉi_nic_mig¿‹_æows
(
ušt8_t
 
äom_nic
, ušt8_ˆ
to_nic
) {

665 
mig¿‹d
 = 0;

667 
i
;

668 
i
 = 0; i < 
g_coÜdš©Ü
.
cÚfig
.
max_æows
; i++) {

669 ià(
g_coÜdš©Ü
.
æow_bË
[
i
].
nic_šdex
 =ğ
äom_nic
) {

670 
g_coÜdš©Ü
.
æow_bË
[
i
].
nic_šdex
 = 
to_nic
;

671 
mig¿‹d
++;

675 ià(
mig¿‹d
 > 0) {

676 
	`log_šfo
("Migrated %d flows from NIC %uo NIC %u",

677 
mig¿‹d
, 
äom_nic
, 
to_nic
);

679 
	}
}

681 
	$muÉi_nic_ş—nup_æows
() {

682 
ušt32_t
 
now
 = 
	`g‘_sy¡em_time
();

683 
expœed
 = 0;

685 
i
;

686 
i
 = 0; i < 
g_coÜdš©Ü
.
cÚfig
.
max_æows
; i++) {

687 
æow_’Œy_t
 *
æow
 = &
g_coÜdš©Ü
.
æow_bË
[
i
];

689 ià(
æow
->
æow_id
 != 0 &&

690 (
now
 - 
æow
->
Ï¡_aùiv™y
è> 
g_coÜdš©Ü
.
cÚfig
.
æow_timeout
) {

691 
	`mem£t
(
æow
, 0, (
æow_’Œy_t
));

692 
g_coÜdš©Ü
.
æow_couÁ
--;

693 
expœed
++;

697 ià(
expœed
 > 0) {

698 
	`log_debug
("Expœed %d iÇùivæows", 
expœed
);

700 
	}
}

702 
	$muÉi_nic_check_nic_h—Éh
(
nic_’Œy_t
 *
nic
) {

707  (
nic
->
¡©e
 !ğ
NIC_STATE_DOWN
 &&‚ic->¡©!ğ
NIC_STATE_ERROR
) ? 1 : 0;

708 
	}
}

710 
	$muÉi_nic_£Ëù_aùive_¡ªdby
(
ušt8_t
 *
£Ëùed_nic
) {

712 
i
;

713 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

714 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

716 ià(
nic
->
nic_šdex
 != 0xFF &&

717 
nic
->
¡©e
 =ğ
NIC_STATE_UP
 &&

718 
nic
->
rŞe
 =ğ
NIC_ROLE_PRIMARY
) {

719 *
£Ëùed_nic
 = 
nic
->
nic_šdex
;

720  
SUCCESS
;

725 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

726 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

728 ià(
nic
->
nic_šdex
 != 0xFF &&

729 
nic
->
¡©e
 =ğ
NIC_STATE_UP
) {

730 *
£Ëùed_nic
 = 
nic
->
nic_šdex
;

731  
SUCCESS
;

735  
ERROR_NO_ROUTE
;

736 
	}
}

738 
	$muÉi_nic_£Ëù_aùive_aùive
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

740  
	`muÉi_nic_£Ëù_lßd_b®ªû
(
cÚ‹xt
, 
£Ëùed_nic
);

741 
	}
}

743 
	$muÉi_nic_£Ëù_lßd_b®ªû
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

744 
ušt8_t
 
®go
 = 
g_coÜdš©Ü
.
cÚfig
.
lßd_b®ªû_®go
;

747 ià(
®go
 >ğ
LB_ALGO_COUNT
) {

748 
	`log_”rÜ
("Inv®id†ßd b®ªû‡lgÜ™hm: %u", 
®go
);

749  
ERROR_INVALID_CONFIG
;

753 
ušt8_t
 
£Ëùed
 = 0xFF;

754 
»suÉ
 = 
g_lßd_b®ªû_funcs
[
®go
](
cÚ‹xt
, &
£Ëùed
);

755 ià(
»suÉ
 =ğ
SUCCESS
) {

756 *
£Ëùed_nic
 = 
£Ëùed
;

758  
»suÉ
;

759 
	}
}

761 
	$muÉi_nic_£Ëù_Ïı
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

764  
	`lßd_b®ªû_hash_ba£d
(
cÚ‹xt
, 
£Ëùed_nic
);

765 
	}
}

767 
	$muÉi_nic_scheduË_çback
(
ušt8_t
 
nic_šdex
) {

770 
	`log_šfo
("Scheduling failbacko NIC %u‡fter %u seconds",

771 
nic_šdex
, 
g_coÜdš©Ü
.
cÚfig
.
çback_d–ay
);

772 
	}
}

774 
ušt32_t
 
	$muÉi_nic_hash_æow
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
) {

776 
ušt32_t
 
hash
 = 
cÚ‹xt
->
¤c_
;

777 
hash
 ^ğ
cÚ‹xt
->
d¡_
;

778 
hash
 ^ğ(
cÚ‹xt
->
¤c_pÜt
 << 16è| cÚ‹xt->
d¡_pÜt
;

779 
hash
 ^ğ
cÚ‹xt
->
´ÙocŞ
;

782 
hash
 ^= (hash >> 16);

783 
hash
 *= 0x85ebca6b;

784 
hash
 ^= (hash >> 13);

785 
hash
 *= 0xc2b2ae35;

786 
hash
 ^= (hash >> 16);

788  
hash
;

789 
	}
}

791 cÚ¡ * 
	$muÉi_nic_¡©e_Çme
(
ušt8_t
 
¡©e
) {

792 
¡©e
) {

793 
NIC_STATE_DOWN
:  "DOWN";

794 
NIC_STATE_UP
:  "UP";

795 
NIC_STATE_ERROR
:  "ERROR";

796 
NIC_STATE_TESTING
:  "TEST";

799 
	}
}

801 cÚ¡ * 
	$muÉi_nic_rŞe_Çme
(
ušt8_t
 
rŞe
) {

802 
rŞe
) {

803 
NIC_ROLE_PRIMARY
:  "PRIMARY";

804 
NIC_ROLE_STANDBY
:  "STANDBY";

805 
NIC_ROLE_ACTIVE
:  "ACTIVE";

806 
NIC_ROLE_PASSIVE
:  "PASSIVE";

809 
	}
}

813 
	$lßd_b®ªû_round_robš
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

814 
ušt8_t
 
Ãxt_nic
 = 0;

815 
ušt8_t
 
¡¬t
 = 
Ãxt_nic
;

818 ià(!
cÚ‹xt
 || !
£Ëùed_nic
) {

819  
ERROR_INVALID_PARAM
;

823 ià(
Ãxt_nic
 >ğ
MAX_MULTI_NICS
)‚ext_nic = 0;

824 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
Ãxt_nic
];

825 
Ãxt_nic
 = (Ãxt_niø+ 1è% 
MAX_MULTI_NICS
;

827 ià(
nic
->
nic_šdex
 !ğ0xFF &&‚ic->
¡©e
 =ğ
NIC_STATE_UP
) {

828 *
£Ëùed_nic
 = 
nic
->
nic_šdex
;

829  
SUCCESS
;

831 } 
Ãxt_nic
 !ğ
¡¬t
);

833  
ERROR_NO_ROUTE
;

834 
	}
}

836 
	$lßd_b®ªû_weigh‹d
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

838 ià(!
cÚ‹xt
 || !
£Ëùed_nic
) {

839  
ERROR_INVALID_PARAM
;

843 
ušt32_t
 
tÙ®_weight
 = 0;

845 
i
;

846 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

847 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

848 ià(
nic
->
nic_šdex
 !ğ0xFF &&‚ic->
¡©e
 =ğ
NIC_STATE_UP
) {

849 
tÙ®_weight
 +ğ
nic
->
weight
;

853 ià(
tÙ®_weight
 == 0) {

854  
ERROR_NO_ROUTE
;

858 
ušt32_t
 
¿ndom
 = (
	`g‘_sy¡em_time
(è* 1103515245 + 12345è% 
tÙ®_weight
;

859 
ušt32_t
 
cumuÏtive
 = 0;

861 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

862 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

863 ià(
nic
->
nic_šdex
 !ğ0xFF &&‚ic->
¡©e
 =ğ
NIC_STATE_UP
) {

864 
cumuÏtive
 +ğ
nic
->
weight
;

865 ià(
¿ndom
 < 
cumuÏtive
) {

866 *
£Ëùed_nic
 = 
nic
->
nic_šdex
;

867  
SUCCESS
;

872  
ERROR_NO_ROUTE
;

873 
	}
}

875 
	$lßd_b®ªû_Ëa¡_lßded
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

877 ià(!
cÚ‹xt
 || !
£Ëùed_nic
) {

878  
ERROR_INVALID_PARAM
;

881 
ušt8_t
 
be¡_nic
 = 0xFF;

882 
ušt32_t
 
mš_lßd
 = 0xFFFFFFFF;

884 
i
;

885 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

886 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

888 ià(
nic
->
nic_šdex
 !ğ0xFF &&‚ic->
¡©e
 =ğ
NIC_STATE_UP
) {

889 
ušt32_t
 
lßd
 = 
nic
->
¡©s
.
·ck‘s_£Á
 +‚ic->¡©s.
·ck‘s_queued
;

891 ià(
lßd
 < 
mš_lßd
) {

892 
mš_lßd
 = 
lßd
;

893 
be¡_nic
 = 
nic
->
nic_šdex
;

898 ià(
be¡_nic
 != 0xFF) {

899 *
£Ëùed_nic
 = 
be¡_nic
;

900  
SUCCESS
;

903  
ERROR_NO_ROUTE
;

904 
	}
}

906 
	$lßd_b®ªû_hash_ba£d
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

908 ià(!
cÚ‹xt
 || !
£Ëùed_nic
) {

909  
ERROR_INVALID_PARAM
;

913 
ušt16_t
 
hash
 = (ušt16_t)(
cÚ‹xt
->
¤c_
 ^ cÚ‹xt->
d¡_
);

914 
hash
 ^ğ(
ušt16_t
)((
cÚ‹xt
->
¤c_pÜt
 << 8è| (cÚ‹xt->
d¡_pÜt
 >> 8));

915 
hash
 ^ğ(
ušt16_t
)
cÚ‹xt
->
´ÙocŞ
;

918 
ušt8_t
 
aùive_nics
[
MAX_MULTI_NICS
];

919 
aùive_couÁ
 = 0;

921 
i
;

922 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

923 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

924 ià(
nic
->
nic_šdex
 !ğ0xFF &&‚ic->
¡©e
 =ğ
NIC_STATE_UP
) {

925 
aùive_nics
[
aùive_couÁ
++] = 
nic
->
nic_šdex
;

929 ià(
aùive_couÁ
 == 0) {

930  
ERROR_NO_ROUTE
;

934 *
£Ëùed_nic
 = 
aùive_nics
[
hash
 % 
aùive_couÁ
];

935  
SUCCESS
;

936 
	}
}

938 
	$lßd_b®ªû_ad­tive
(
·ck‘_cÚ‹xt_t
 *
cÚ‹xt
, 
ušt8_t
 *
£Ëùed_nic
) {

940 ià(!
cÚ‹xt
 || !
£Ëùed_nic
) {

941  
ERROR_INVALID_PARAM
;

945 
ušt8_t
 
be¡_nic
 = 0xFF;

946 
ušt32_t
 
be¡_scÜe
 = 0;

948 
i
;

949 
i
 = 0; i < 
MAX_MULTI_NICS
; i++) {

950 
nic_’Œy_t
 *
nic
 = &
g_coÜdš©Ü
.
nics
[
i
];

952 ià(
nic
->
nic_šdex
 !ğ0xFF &&‚ic->
¡©e
 =ğ
NIC_STATE_UP
) {

954 
ušt32_t
 
tÙ®_·ck‘s
 = 
nic
->
¡©s
.
·ck‘s_£Á
 + 1;

955 
ušt32_t
 
”rÜ_¿‹
 = (
nic
->
¡©s
.
”rÜs
 * 100è/ 
tÙ®_·ck‘s
;

957 
ušt32_t
 
max_queue
 = (
nic
->
ÿ·b™›s
.
max_queue_size
 > 0) ?

958 
nic
->
ÿ·b™›s
.
max_queue_size
 : 1;

959 
ušt32_t
 
utiz©iÚ
 = (
nic
->
¡©s
.
·ck‘s_queued
 * 100è/ 
max_queue
;

962 
ušt32_t
 
scÜe
 = ((100 - 
”rÜ_¿‹
è* (100 - 
utiz©iÚ
è* 
nic
->
´iÜ™y
) / 100;

964 ià(
scÜe
 > 
be¡_scÜe
) {

965 
be¡_scÜe
 = 
scÜe
;

966 
be¡_nic
 = 
nic
->
nic_šdex
;

971 ià(
be¡_nic
 != 0xFF) {

972 *
£Ëùed_nic
 = 
be¡_nic
;

973  
SUCCESS
;

976  
ERROR_NO_ROUTE
;

977 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/runtime_config.c

11 
	~"../../šşude/ruÁime_cÚfig.h
"

12 
	~"../../šşude/loggšg.h
"

13 
	~"../../šşude/­i.h
"

14 
	~"../../šşude/memÜy.h
"

15 
	~"../../šşude/routšg.h
"

16 
	~"../../šşude/¡©s.h
"

17 
	~<¡ršg.h
>

18 
	~<¡dio.h
>

21 
ruÁime_cÚfig_mªag”_t
 
	gg_cÚfig_mªag”
 = {0};

22 
boŞ
 
	gg_š™Ÿlized
 = 
çl£
;

25 cÚ¡ 
cÚfig_·¿m_def_t
 
	gg_·¿m_defš™iÚs
[] = {

27 {
CONFIG_PARAM_LOG_LEVEL
, 
CONFIG_TYPE_UINT8
, 
CONFIG_CAT_LOGGING
,

29 0, 4, 0, 
CONFIG_FLAG_DYNAMIC
},

31 {
CONFIG_PARAM_LOG_DESTINATION
, 
CONFIG_TYPE_UINT8
, 
CONFIG_CAT_LOGGING
,

33 0, 3, 0, 
CONFIG_FLAG_DYNAMIC
},

36 {
CONFIG_PARAM_BUFFER_SIZE
, 
CONFIG_TYPE_UINT16
, 
CONFIG_CAT_MEMORY
,

38 256, 8192, 0, 
CONFIG_FLAG_REQUIRES_RESET
},

40 {
CONFIG_PARAM_BUFFER_COUNT
, 
CONFIG_TYPE_UINT16
, 
CONFIG_CAT_MEMORY
,

42 4, 256, 0, 
CONFIG_FLAG_REQUIRES_RESET
},

44 {
CONFIG_PARAM_XMS_ENABLE
, 
CONFIG_TYPE_BOOL
, 
CONFIG_CAT_MEMORY
,

46 0, 1, 0, 
CONFIG_FLAG_DYNAMIC
},

48 {
CONFIG_PARAM_XMS_THRESHOLD
, 
CONFIG_TYPE_UINT32
, 
CONFIG_CAT_MEMORY
,

50 1024, 65536, 0, 
CONFIG_FLAG_DYNAMIC
},

53 {
CONFIG_PARAM_PROMISCUOUS
, 
CONFIG_TYPE_BOOL
, 
CONFIG_CAT_NETWORK
,

55 0, 1, 0, 
CONFIG_FLAG_DYNAMIC
 | 
CONFIG_FLAG_PER_NIC
},

57 {
CONFIG_PARAM_MULTICAST
, 
CONFIG_TYPE_BOOL
, 
CONFIG_CAT_NETWORK
,

59 0, 1, 0, 
CONFIG_FLAG_DYNAMIC
 | 
CONFIG_FLAG_PER_NIC
},

61 {
CONFIG_PARAM_MTU
, 
CONFIG_TYPE_UINT16
, 
CONFIG_CAT_NETWORK
,

63 64, 1518, 0, 
CONFIG_FLAG_DYNAMIC
 | 
CONFIG_FLAG_PER_NIC
},

66 {
CONFIG_PARAM_IRQ_COALESCE
, 
CONFIG_TYPE_UINT16
, 
CONFIG_CAT_PERFORMANCE
,

68 0, 10000, 0, 
CONFIG_FLAG_DYNAMIC
 | 
CONFIG_FLAG_PER_NIC
},

70 {
CONFIG_PARAM_TX_QUEUE_SIZE
, 
CONFIG_TYPE_UINT16
, 
CONFIG_CAT_PERFORMANCE
,

72 1, 64, 0, 
CONFIG_FLAG_REQUIRES_RESET
 | 
CONFIG_FLAG_PER_NIC
},

74 {
CONFIG_PARAM_RX_QUEUE_SIZE
, 
CONFIG_TYPE_UINT16
, 
CONFIG_CAT_PERFORMANCE
,

76 1, 64, 0, 
CONFIG_FLAG_REQUIRES_RESET
 | 
CONFIG_FLAG_PER_NIC
},

79 {
CONFIG_PARAM_ROUTING_MODE
, 
CONFIG_TYPE_UINT8
, 
CONFIG_CAT_ROUTING
,

81 0, 2, 0, 
CONFIG_FLAG_DYNAMIC
},

83 {
CONFIG_PARAM_DEFAULT_ROUTE
, 
CONFIG_TYPE_UINT8
, 
CONFIG_CAT_ROUTING
,

85 0, 3, 0, 
CONFIG_FLAG_DYNAMIC
},

88 {
CONFIG_PARAM_STATS_INTERVAL
, 
CONFIG_TYPE_UINT16
, 
CONFIG_CAT_DIAGNOSTICS
,

90 1, 3600, 0, 
CONFIG_FLAG_DYNAMIC
},

92 {
CONFIG_PARAM_DIAG_MODE
, 
CONFIG_TYPE_BOOL
, 
CONFIG_CAT_DIAGNOSTICS
,

94 0, 1, 0, 
CONFIG_FLAG_DYNAMIC
},

97 {0, 0, 0, 
NULL
, NULL, 0, 0, 0, 0}

103 
	$ruÁime_cÚfig_š™
() {

104 ià(
g_š™Ÿlized
) {

105 
	`log_w¬nšg
("Runtime config‡lready initialized");

106  
SUCCESS
;

109 
	`log_šfo
("Initializing„untime configuration system");

112 
	`mem£t
(&
g_cÚfig_mªag”
, 0, (
ruÁime_cÚfig_mªag”_t
));

115 cÚ¡ 
cÚfig_·¿m_def_t
 *
def
 = 
g_·¿m_defš™iÚs
;

116 
def
->
·¿m_id
 != 0) {

117 
g_cÚfig_mªag”
.
·¿m_couÁ
++;

118 
def
++;

122 
g_cÚfig_mªag”
.
·¿m_v®ues
 = (
cÚfig_·¿m_v®ue_t
*)
	`memÜy_®loÿ‹
(

123 
g_cÚfig_mªag”
.
·¿m_couÁ
 * (
cÚfig_·¿m_v®ue_t
),

124 
MEMORY_TYPE_KERNEL


127 ià(!
g_cÚfig_mªag”
.
·¿m_v®ues
) {

128 
	`log_”rÜ
("Failedo‡llocate…arameter storage");

129  
ERROR_MEMORY
;

133 
i
 = 0; i < 
g_cÚfig_mªag”
.
·¿m_couÁ
; i++) {

134 
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
].
·¿m_id
 = 
g_·¿m_defš™iÚs
[i].param_id;

135 
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
].
cu¼’t_v®ue
 = 0;

136 
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
].
³ndšg_v®ue
 = 0;

137 
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
].
has_³ndšg
 = 
çl£
;

138 
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
].
nic_šdex
 = 0xFF;

142 
	`ruÁime_cÚfig_£t_deçuÉs
();

144 
g_cÚfig_mªag”
.
æags
 = 
CONFIG_FLAG_INITIALIZED
;

145 
g_š™Ÿlized
 = 
Œue
;

147 
	`log_šfo
("Runtime configuration initialized with %u…arameters",

148 
g_cÚfig_mªag”
.
·¿m_couÁ
);

150  
SUCCESS
;

151 
	}
}

156 
	$ruÁime_cÚfig_ş—nup
() {

157 ià(!
g_š™Ÿlized
) {

158  
SUCCESS
;

161 
	`log_šfo
("Cleaning up„untime configuration");

164 ià(
g_cÚfig_mªag”
.
·¿m_v®ues
) {

165 
	`memÜy_ä“
(
g_cÚfig_mªag”
.
·¿m_v®ues
);

166 
g_cÚfig_mªag”
.
·¿m_v®ues
 = 
NULL
;

170 
cÚfig_ÿÎback_t
 *
cb
 = 
g_cÚfig_mªag”
.
ÿÎbacks
;

171 
cb
) {

172 
cÚfig_ÿÎback_t
 *
Ãxt
 = 
cb
->next;

173 
	`memÜy_ä“
(
cb
);

174 
cb
 = 
Ãxt
;

177 
	`mem£t
(&
g_cÚfig_mªag”
, 0, (
ruÁime_cÚfig_mªag”_t
));

178 
g_š™Ÿlized
 = 
çl£
;

180  
SUCCESS
;

181 
	}
}

186 
	$ruÁime_cÚfig_£t_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 
v®ue
, 
ušt8_t
 
nic_šdex
) {

187 ià(!
g_š™Ÿlized
) {

188  
ERROR_NOT_INITIALIZED
;

192 cÚ¡ 
cÚfig_·¿m_def_t
 *
def
 = 
	`ruÁime_cÚfig_g‘_defš™iÚ
(
·¿m_id
);

193 ià(!
def
) {

194 
	`log_”rÜ
("UnknowÀ·¿m‘” ID: 0x%04X", 
·¿m_id
);

195  
ERROR_INVALID_PARAM
;

199 ià(
v®ue
 < 
def
->
mš_v®ue
 || v®u> def->
max_v®ue
) {

200 
	`log_”rÜ
("Parameter %s value %lu out of„ange [%lu-%lu]",

201 
def
->
Çme
, 
v®ue
, def->
mš_v®ue
, def->
max_v®ue
);

202  
ERROR_OUT_OF_RANGE
;

206 ià((
def
->
æags
 & 
CONFIG_FLAG_PER_NIC
è&& 
nic_šdex
 >ğ
MAX_NICS
) {

207 
	`log_”rÜ
("Inv®id NIC index %u fÜ…¬am‘” %s", 
nic_šdex
, 
def
->
Çme
);

208  
ERROR_INVALID_NIC
;

212 
cÚfig_·¿m_v®ue_t
 *
·¿m_v®
 = 
	`ruÁime_cÚfig_fšd_·¿m
(
·¿m_id
, 
nic_šdex
);

213 ià(!
·¿m_v®
) {

216 
i
 = 0; i < 
g_cÚfig_mªag”
.
·¿m_couÁ
; i++) {

217 ià(
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
].
·¿m_id
 == 0) {

219 
	`mem£t
(&
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
], 0, (
cÚfig_·¿m_v®ue_t
));

220 
·¿m_v®
 = &
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
];

221 
·¿m_v®
->
·¿m_id
 =…aram_id;

222 
·¿m_v®
->
nic_šdex
 =‚ic_index;

223 
·¿m_v®
->
cu¼’t_v®ue
 = 
def
->
deçuÉ_v®ue
;

224 
·¿m_v®
->
³ndšg_v®ue
 = 0;

225 
·¿m_v®
->
has_³ndšg
 = 0;

230 ià(!
·¿m_v®
) {

231 
	`log_”rÜ
("No free…arameter slots");

232  
ERROR_NO_SPACE
;

237 ià(
def
->
æags
 & 
CONFIG_FLAG_REQUIRES_RESET
) {

239 ià(!
·¿m_v®
->
has_³ndšg
 ||…¬am_v®->
³ndšg_v®ue
 !ğ
v®ue
) {

240 
·¿m_v®
->
³ndšg_v®ue
 = 
v®ue
;

241 ià(!
·¿m_v®
->
has_³ndšg
) {

242 
g_cÚfig_mªag”
.
³ndšg_chªges
++;

244 
·¿m_v®
->
has_³ndšg
 = 1;

247 
	`log_šfo
("Parameter %s queued for‚ext„eset (value=%lu)",

248 
def
->
Çme
, 
v®ue
);

251 
ušt32_t
 
Şd_v®ue
 = 
·¿m_v®
->
cu¼’t_v®ue
;

254 
»suÉ
 = 
	`ruÁime_cÚfig_­¶y_·¿m
(
·¿m_id
, 
v®ue
, 
nic_šdex
);

255 ià(
»suÉ
 !ğ
SUCCESS
) {

256 
	`log_”rÜ
("FaedØ­¶y…¬am‘” %s", 
def
->
Çme
);

257 
g_cÚfig_mªag”
.
¡©s
.
çed_chªges
++;

258  
»suÉ
;

262 
·¿m_v®
->
cu¼’t_v®ue
 = 
v®ue
;

265 
	`ruÁime_cÚfig_nÙify_ÿÎbacks
(
·¿m_id
, 
Şd_v®ue
, 
v®ue
, 
nic_šdex
);

267 
g_cÚfig_mªag”
.
¡©s
.
immedŸ‹_chªges
++;

269 
	`log_šfo
("Parameter %s changed from %luo %lu",

270 
def
->
Çme
, 
Şd_v®ue
, 
v®ue
);

273 
g_cÚfig_mªag”
.
¡©s
.
tÙ®_chªges
++;

275  
SUCCESS
;

276 
	}
}

281 
	$ruÁime_cÚfig_g‘_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 *
v®ue
, 
ušt8_t
 
nic_šdex
) {

282 ià(!
g_š™Ÿlized
 || !
v®ue
) {

283  
ERROR_INVALID_PARAM
;

286 
cÚfig_·¿m_v®ue_t
 *
·¿m_v®
 = 
	`ruÁime_cÚfig_fšd_·¿m
(
·¿m_id
, 
nic_šdex
);

287 ià(!
·¿m_v®
) {

289 cÚ¡ 
cÚfig_·¿m_def_t
 *
def
 = 
	`ruÁime_cÚfig_g‘_defš™iÚ
(
·¿m_id
);

290 ià(!
def
) {

291  
ERROR_INVALID_PARAM
;

293 *
v®ue
 = 
def
->
deçuÉ_v®ue
;

295 *
v®ue
 = 
·¿m_v®
->
cu¼’t_v®ue
;

298  
SUCCESS
;

299 
	}
}

304 
	$ruÁime_cÚfig_­¶y_³ndšg
() {

305 ià(!
g_š™Ÿlized
) {

306  
ERROR_NOT_INITIALIZED
;

309 ià(
g_cÚfig_mªag”
.
³ndšg_chªges
 == 0) {

310 
	`log_šfo
("No…ending configuration changes");

311  
SUCCESS
;

314 
	`log_šfo
("Applying %u…ending configuration changes",

315 
g_cÚfig_mªag”
.
³ndšg_chªges
);

317 
­¶›d
 = 0;

318 
çed
 = 0;

320 
i
 = 0; i < 
g_cÚfig_mªag”
.
·¿m_couÁ
; i++) {

321 
cÚfig_·¿m_v®ue_t
 *
·¿m_v®
 = &
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
];

323 ià(
·¿m_v®
->
has_³ndšg
) {

324 
ušt32_t
 
Şd_v®ue
 = 
·¿m_v®
->
cu¼’t_v®ue
;

325 
·¿m_v®
->
cu¼’t_v®ue
 =…¬am_v®->
³ndšg_v®ue
;

326 
·¿m_v®
->
has_³ndšg
 = 
çl£
;

329 
»suÉ
 = 
	`ruÁime_cÚfig_­¶y_·¿m
(

330 
·¿m_v®
->
·¿m_id
,

331 
·¿m_v®
->
cu¼’t_v®ue
,

332 
·¿m_v®
->
nic_šdex


335 ià(
»suÉ
 =ğ
SUCCESS
) {

336 
­¶›d
++;

339 
	`ruÁime_cÚfig_nÙify_ÿÎbacks
(

340 
·¿m_v®
->
·¿m_id
,

341 
Şd_v®ue
,

342 
·¿m_v®
->
cu¼’t_v®ue
,

343 
·¿m_v®
->
nic_šdex


346 
çed
++;

348 
·¿m_v®
->
cu¼’t_v®ue
 = 
Şd_v®ue
;

349 
	`log_”rÜ
("FaedØ­¶y…¬am‘” 0x%04X", 
·¿m_v®
->
·¿m_id
);

354 
g_cÚfig_mªag”
.
³ndšg_chªges
 = 0;

355 
g_cÚfig_mªag”
.
¡©s
.
»£t_­¶›d_chªges
 +ğ
­¶›d
;

357 
	`log_šfo
("Aµl›d %d chªges, %d faed", 
­¶›d
, 
çed
);

359  (
çed
 > 0è? 
ERROR_PARTIAL
 : 
SUCCESS
;

360 
	}
}

365 
	$ruÁime_cÚfig_»gi¡”_ÿÎback
(
cÚfig_ÿÎback_func_t
 
ÿÎback
,

366 
ušt16_t
 
·¿m_id
,

367 *
cÚ‹xt
) {

368 ià(!
g_š™Ÿlized
 || !
ÿÎback
) {

369  
ERROR_INVALID_PARAM
;

373 
cÚfig_ÿÎback_t
 *
cb
 = (cÚfig_ÿÎback_t*)
	`memÜy_®loÿ‹
(

374 (
cÚfig_ÿÎback_t
),

375 
MEMORY_TYPE_KERNEL


378 ià(!
cb
) {

379  
ERROR_MEMORY
;

382 
cb
->
ÿÎback
 = callback;

383 
cb
->
·¿m_id
 =…aram_id;

384 
cb
->
cÚ‹xt
 = context;

385 
cb
->
Ãxt
 = 
g_cÚfig_mªag”
.
ÿÎbacks
;

386 
g_cÚfig_mªag”
.
ÿÎbacks
 = 
cb
;

388 
	`log_debug
("Regi¡”ed c®lback fÜ…¬am‘” 0x%04X", 
·¿m_id
);

390  
SUCCESS
;

391 
	}
}

396 
	$ruÁime_cÚfig_expÜt
(*
bufãr
, 
ušt16_t
 *
size
) {

397 ià(!
g_š™Ÿlized
 || !
bufãr
 || !
size
) {

398  
ERROR_INVALID_PARAM
;

401 
cÚfig_expÜt_t
 *
expÜt
 = (cÚfig_expÜt_t*)
bufãr
;

402 
ušt16_t
 
»quœed_size
 = (
cÚfig_expÜt_t
) +

403 
g_cÚfig_mªag”
.
·¿m_couÁ
 * (
cÚfig_·¿m_expÜt_t
);

405 ià(*
size
 < 
»quœed_size
) {

406 *
size
 = 
»quœed_size
;

407  
ERROR_BUFFER_TOO_SMALL
;

411 
expÜt
->
magic
 = 
CONFIG_EXPORT_MAGIC
;

412 
expÜt
->
v”siÚ
 = 
CONFIG_EXPORT_VERSION
;

413 
expÜt
->
·¿m_couÁ
 = 0;

414 
expÜt
->
checksum
 = 0;

417 
cÚfig_·¿m_expÜt_t
 *
·¿m
 = (cÚfig_·¿m_expÜt_t*)(
expÜt
 + 1);

419 
i
 = 0; i < 
g_cÚfig_mªag”
.
·¿m_couÁ
; i++) {

420 
cÚfig_·¿m_v®ue_t
 *
v®
 = &
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
];

421 ià(
v®
->
·¿m_id
 != 0) {

422 
·¿m
->
·¿m_id
 = 
v®
->param_id;

423 
·¿m
->
v®ue
 = 
v®
->
cu¼’t_v®ue
;

424 
·¿m
->
nic_šdex
 = 
v®
->nic_index;

425 
·¿m
++;

426 
expÜt
->
·¿m_couÁ
++;

431 
expÜt
->
checksum
 = 
	`ruÁime_cÚfig_ÿlcuÏ‹_checksum
(export,

432 (
cÚfig_expÜt_t
è+ 
expÜt
->
·¿m_couÁ
 * (
cÚfig_·¿m_expÜt_t
));

434 *
size
 = 
»quœed_size
;

435 
g_cÚfig_mªag”
.
¡©s
.
expÜts
++;

437 
	`log_šfo
("ExpÜ‹d %u cÚfigu¿tiÚ…¬am‘”s", 
expÜt
->
·¿m_couÁ
);

439  
SUCCESS
;

440 
	}
}

445 
	$ruÁime_cÚfig_impÜt
(cÚ¡ *
bufãr
, 
ušt16_t
 
size
) {

446 ià(!
g_š™Ÿlized
 || !
bufãr
) {

447  
ERROR_INVALID_PARAM
;

450 cÚ¡ 
cÚfig_expÜt_t
 *
impÜt
 = (cÚ¡ cÚfig_expÜt_t*)
bufãr
;

453 ià(
impÜt
->
magic
 !ğ
CONFIG_EXPORT_MAGIC
) {

454 
	`log_”rÜ
("Inv®id cÚfigu¿tiÚ magic: 0x%08X", 
impÜt
->
magic
);

455  
ERROR_INVALID_FORMAT
;

458 ià(
impÜt
->
v”siÚ
 !ğ
CONFIG_EXPORT_VERSION
) {

459 
	`log_”rÜ
("UnsuµÜ‹d cÚfigu¿tiÚ v”siÚ: %u", 
impÜt
->
v”siÚ
);

460  
ERROR_VERSION_MISMATCH
;

464 
ušt16_t
 
ex³ùed_size
 = (
cÚfig_expÜt_t
) +

465 
impÜt
->
·¿m_couÁ
 * (
cÚfig_·¿m_expÜt_t
);

467 ià(
size
 < 
ex³ùed_size
) {

468 
	`log_”rÜ
("Configuration bufferoo small");

469  
ERROR_BUFFER_TOO_SMALL
;

473 
ušt16_t
 
ÿlc_checksum
 = 
	`ruÁime_cÚfig_ÿlcuÏ‹_checksum
(
impÜt
, 
ex³ùed_size
);

474 ià(
ÿlc_checksum
 != 0) {

475 
	`log_”rÜ
("Configuration checksum mismatch");

476  
ERROR_CHECKSUM
;

480 cÚ¡ 
cÚfig_·¿m_expÜt_t
 *
·¿m
 = (cÚ¡ cÚfig_·¿m_expÜt_t*)(
impÜt
 + 1);

481 
impÜ‹d
 = 0;

482 
çed
 = 0;

484 
i
 = 0; i < 
impÜt
->
·¿m_couÁ
; i++) {

485 
»suÉ
 = 
	`ruÁime_cÚfig_£t_·¿m
(

486 
·¿m
->
·¿m_id
,

487 
·¿m
->
v®ue
,

488 
·¿m
->
nic_šdex


491 ià(
»suÉ
 =ğ
SUCCESS
) {

492 
impÜ‹d
++;

494 
çed
++;

495 
	`log_w¬nšg
("FaedØimpÜˆ·¿m‘” 0x%04X", 
·¿m
->
·¿m_id
);

498 
·¿m
++;

501 
g_cÚfig_mªag”
.
¡©s
.
impÜts
++;

503 
	`log_šfo
("ImpÜ‹d %d…¬am‘”s, %d faed", 
impÜ‹d
, 
çed
);

505  (
çed
 > 0è? 
ERROR_PARTIAL
 : 
SUCCESS
;

506 
	}
}

511 
	$ruÁime_cÚfig_£t_deçuÉs
() {

512 
	`log_šfo
("Setting default configuration values");

515 cÚ¡ 
cÚfig_·¿m_def_t
 *
def
 = 
g_·¿m_defš™iÚs
;

516 
def
->
·¿m_id
 != 0) {

517 
	`ruÁime_cÚfig_£t_·¿m
(
def
->
·¿m_id
, def->
deçuÉ_v®ue
, 0xFF);

518 
def
++;

520 
	}
}

525 
	$ruÁime_cÚfig_dump
() {

526 ià(!
g_š™Ÿlized
) {

527 
	`´štf
("Runtime configuration‚ot initialized\n");

531 
	`´štf
("\n=== Runtime Configuration ===\n");

532 
	`´štf
("Parameters: %u‡ctive, %u…ending\n",

533 
g_cÚfig_mªag”
.
·¿m_couÁ
, g_cÚfig_mªag”.
³ndšg_chªges
);

536 
ÿt
 = 0; c© < 
CONFIG_CAT_COUNT
; cat++) {

537 cÚ¡ *
ÿt_Çme
[] = {

542 
	`´štf
("\n% P¬am‘”s:\n", 
ÿt_Çme
[
ÿt
]);

544 cÚ¡ 
cÚfig_·¿m_def_t
 *
def
 = 
g_·¿m_defš™iÚs
;

545 
def
->
·¿m_id
 != 0) {

546 ià(
def
->
ÿ‹gÜy
 =ğ
ÿt
) {

547 
ušt32_t
 
v®ue
;

548 
	`ruÁime_cÚfig_g‘_·¿m
(
def
->
·¿m_id
, &
v®ue
, 0xFF);

550 
	`´štf
(" %-20s: %lu", 
def
->
Çme
, 
v®ue
);

553 
cÚfig_·¿m_v®ue_t
 *
v®
 = 
	`ruÁime_cÚfig_fšd_·¿m
(
def
->
·¿m_id
, 0xFF);

554 ià(
v®
 && v®->
has_³ndšg
) {

555 
	`´štf
(" (³ndšg: %lu)", 
v®
->
³ndšg_v®ue
);

558 
	`´štf
(" [%lu-%lu]\n", 
def
->
mš_v®ue
, def->
max_v®ue
);

560 
def
++;

565 
	`´štf
("\nConfiguration Statistics:\n");

566 
	`´štf
(" TÙ® chªges: %lu\n", 
g_cÚfig_mªag”
.
¡©s
.
tÙ®_chªges
);

567 
	`´štf
(" ImmedŸ‹ chªges: %lu\n", 
g_cÚfig_mªag”
.
¡©s
.
immedŸ‹_chªges
);

568 
	`´štf
(" Re£t-­¶›d chªges: %lu\n", 
g_cÚfig_mªag”
.
¡©s
.
»£t_­¶›d_chªges
);

569 
	`´štf
(" Faed chªges: %lu\n", 
g_cÚfig_mªag”
.
¡©s
.
çed_chªges
);

570 
	`´štf
(" ExpÜts: %lu\n", 
g_cÚfig_mªag”
.
¡©s
.
expÜts
);

571 
	`´štf
(" ImpÜts: %lu\n", 
g_cÚfig_mªag”
.
¡©s
.
impÜts
);

572 
	`´štf
("\n");

573 
	}
}

577 cÚ¡ 
cÚfig_·¿m_def_t
* 
	$ruÁime_cÚfig_g‘_defš™iÚ
(
ušt16_t
 
·¿m_id
) {

578 cÚ¡ 
cÚfig_·¿m_def_t
 *
def
 = 
g_·¿m_defš™iÚs
;

579 
def
->
·¿m_id
 != 0) {

580 ià(
def
->
·¿m_id
 ==…aram_id) {

581  
def
;

583 
def
++;

585  
NULL
;

586 
	}
}

588 
cÚfig_·¿m_v®ue_t
* 
	$ruÁime_cÚfig_fšd_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt8_t
 
nic_šdex
) {

589 
i
 = 0; i < 
g_cÚfig_mªag”
.
·¿m_couÁ
; i++) {

590 
cÚfig_·¿m_v®ue_t
 *
v®
 = &
g_cÚfig_mªag”
.
·¿m_v®ues
[
i
];

591 ià(
v®
->
·¿m_id
 ==…aram_id) {

592 ià(
nic_šdex
 =ğ0xFF || 
v®
->nic_index == 0xFF || val->nic_index ==‚ic_index) {

593  
v®
;

597  
NULL
;

598 
	}
}

600 
	$ruÁime_cÚfig_­¶y_·¿m
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 
v®ue
, 
ušt8_t
 
nic_šdex
) {

602 
·¿m_id
) {

603 
CONFIG_PARAM_LOG_LEVEL
:

604 
	`log_£t_Ëv–
((
ušt8_t
)
v®ue
);

607 
CONFIG_PARAM_PROMISCUOUS
:

609 
	`log_šfo
("Setting…romiscuous modeo %s for NIC %u",

610 
v®ue
 ? "ON" : "OFF", 
nic_šdex
);

613 
CONFIG_PARAM_XMS_ENABLE
:

615 
	`log_šfo
("XMS memÜy %s", 
v®ue
 ? "enabled" : "disabled");

618 
CONFIG_PARAM_ROUTING_MODE
:

620 
	`log_šfo
("Routšg modchªgedØ%lu", 
v®ue
);

626 
	`log_debug
("P¬am‘” 0x%04X s‘Ø%lu", 
·¿m_id
, 
v®ue
);

630  
SUCCESS
;

631 
	}
}

633 
	$ruÁime_cÚfig_nÙify_ÿÎbacks
(
ušt16_t
 
·¿m_id
, 
ušt32_t
 
Şd_v®ue
,

634 
ušt32_t
 
Ãw_v®ue
, 
ušt8_t
 
nic_šdex
) {

635 
cÚfig_ÿÎback_t
 *
cb
 = 
g_cÚfig_mªag”
.
ÿÎbacks
;

637 
cb
) {

638 ià(
cb
->
·¿m_id
 == 0 || cb->param_id ==…aram_id) {

639 
cb
->
	`ÿÎback
(
·¿m_id
, 
Şd_v®ue
, 
Ãw_v®ue
, 
nic_šdex
, cb->
cÚ‹xt
);

641 
cb
 = cb->
Ãxt
;

643 
	}
}

645 
ušt16_t
 
	$ruÁime_cÚfig_ÿlcuÏ‹_checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
size
) {

646 cÚ¡ 
ušt16_t
 *
±r
 = (cÚ¡ ušt16_t*)
d©a
;

647 
ušt32_t
 
sum
 = 0;

649 
size
 > 1) {

650 
sum
 +ğ*
±r
++;

651 
size
 -= 2;

654 ià(
size
 > 0) {

655 
sum
 +ğ*(cÚ¡ 
ušt8_t
*)
±r
;

658 
sum
 >> 16) {

659 
sum
 = (sum & 0xFFFF) + (sum >> 16);

662  (
ušt16_t
)~
sum
;

663 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/xms_buffer_migration.c

12 
	~"../../šşude/xms_d‘eù.h
"

13 
	~"../../šşude/nic_bufãr_poŞs.h
"

14 
	~"../../šşude/pÜb™y.h
"

15 
	~"../../šşude/loggšg.h
"

16 
	~"../../šşude/memÜy.h
"

17 
	~"../../šşude/dma_§ãty.h
"

18 
	~<¡ršg.h
>

19 
	~<dos.h
>

22 
	#XMS_BUFFER_POOL_SIZE_KB
 64

	)

23 
	#XMS_BUFFER_ALIGNMENT
 16

	)

24 
	#CONVENTIONAL_CACHE_SIZE
 4096

	)

25 
	#MAX_CACHED_PACKETS
 4

	)

29 
ušt16_t
 
	mxms_hªdË
;

30 
ušt32_t
 
	mxms_size_kb
;

31 
ušt32_t
 
	mxms_lš—r_addr
;

32 
boŞ
 
	mxms_locked
;

35 
ušt8_t
 *
	mcÚv_ÿche
;

36 
ušt16_t
 
	mcÚv_ÿche_size
;

37 
ušt16_t
 
	mcÚv_ÿche_u£d
;

41 
ušt32_t
 
	mxms_off£t
;

42 
ušt16_t
 
	msize
;

43 vŞ©
ušt8_t
 
	mš_u£
;

44 vŞ©
ušt8_t
 
	mš_cÚv_ÿche
;

45 vŞ©
ušt8_t
 
	mmig¿tšg
;

46 
ušt8_t
 
	m»£rved
;

47 
ušt16_t
 
	mcÚv_off£t
;

48 } 
	mbufãrs
[
MAX_PACKET_BUFFERS
];

50 
ušt16_t
 
	mbufãr_couÁ
;

51 
ušt16_t
 
	mbufãrs_š_xms
;

52 
ušt16_t
 
	mbufãrs_š_cÚv
;

55 
ušt32_t
 
	mxms_mig¿tiÚs
;

56 
ušt32_t
 
	mcÚv_mig¿tiÚs
;

57 
ušt32_t
 
	mÿche_h™s
;

58 
ušt32_t
 
	mÿche_mis£s
;

60 } 
	txms_bufãr_poŞ_t
;

63 
xms_bufãr_poŞ_t
 
	gg_xms_poŞ
 = {0};

64 
	gg_xms_mig¿tiÚ_’abËd
 = 0;

65 
	gg_xms_š™Ÿlized
 = 0;

68 
xms_bufãr_lock_poŞ
();

69 
xms_bufãr_uÆock_poŞ
();

70 
xms_bufãr_cİy_to_xms
(
ušt32_t
 
xms_off£t
, *
¤c
, 
ušt16_t
 
size
);

71 
xms_bufãr_cİy_äom_xms
(*
de¡
, 
ušt32_t
 
xms_off£t
, 
ušt16_t
 
size
);

72 
xms_bufãr_mig¿‹_to_xms
(
ušt16_t
 
bufãr_šdex
);

73 
xms_bufãr_mig¿‹_to_cÚv
(
ušt16_t
 
bufãr_šdex
);

74 
xms_bufãr_fšd_cÚv_¥aû
(
ušt16_t
 
size
);

75 
xms_bufãr_eviù_äom_ÿche
();

80 
	$xms_bufãr_mig¿tiÚ_š™
() {

81 
»suÉ
;

83 ià(
g_xms_š™Ÿlized
) {

84 
	`log_w¬nšg
("XMS buffer migration‡lready initialized");

85  
SUCCESS
;

88 
	`log_šfo
("Initializing XMS buffer migration system");

91 
	`mem£t
(&
g_xms_poŞ
, 0, (
xms_bufãr_poŞ_t
));

94 
»suÉ
 = 
	`xms_d‘eù
();

95 ià(
»suÉ
 !ğ
SUCCESS
) {

96 
	`log_w¬nšg
("XMS‚ot‡vailable, using conventional memory only");

97 
g_xms_mig¿tiÚ_’abËd
 = 
çl£
;

98  
SUCCESS
;

102 
xms_šfo_t
 
xms_šfo
;

103 
»suÉ
 = 
	`xms_g‘_šfo
(&
xms_šfo
);

104 ià(
»suÉ
 !ğ
SUCCESS
 || 
xms_šfo
.
ä“_kb
 < 
XMS_BUFFER_POOL_SIZE_KB
) {

105 
	`log_w¬nšg
("Insufficient XMS memory (%u KB free,‚eed %u KB)",

106 
xms_šfo
.
ä“_kb
, 
XMS_BUFFER_POOL_SIZE_KB
);

107 
g_xms_mig¿tiÚ_’abËd
 = 
çl£
;

108  
SUCCESS
;

112 
g_xms_poŞ
.
xms_hªdË
 = 
	`xms_®loÿ‹
(
XMS_BUFFER_POOL_SIZE_KB
);

113 ià(
g_xms_poŞ
.
xms_hªdË
 =ğ
XMS_INVALID_HANDLE
) {

114 
	`log_”rÜ
("Failedo‡llocate XMS buffer…ool");

115 
g_xms_mig¿tiÚ_’abËd
 = 
çl£
;

116  
SUCCESS
;

119 
g_xms_poŞ
.
xms_size_kb
 = 
XMS_BUFFER_POOL_SIZE_KB
;

122 
g_xms_poŞ
.
cÚv_ÿche
 = (
ušt8_t
*)
	`memÜy_®loÿ‹
(

123 
CONVENTIONAL_CACHE_SIZE
,

124 
MEMORY_TYPE_DMA_SAFE


127 ià(!
g_xms_poŞ
.
cÚv_ÿche
) {

128 
	`log_”rÜ
("Failedo‡llocate conventional cache");

129 
	`xms_ä“
(
g_xms_poŞ
.
xms_hªdË
);

130 
g_xms_poŞ
.
xms_hªdË
 = 
XMS_INVALID_HANDLE
;

131  
ERROR_MEMORY
;

134 
g_xms_poŞ
.
cÚv_ÿche_size
 = 
CONVENTIONAL_CACHE_SIZE
;

135 
g_xms_poŞ
.
cÚv_ÿche_u£d
 = 0;

138 
g_xms_poŞ
.
bufãr_couÁ
 = 0;

139 
g_xms_poŞ
.
bufãrs_š_xms
 = 0;

140 
g_xms_poŞ
.
bufãrs_š_cÚv
 = 0;

142 
g_xms_mig¿tiÚ_’abËd
 = 1;

143 
g_xms_š™Ÿlized
 = 1;

145 
	`log_šfo
("XMS buffer migration initialized: %u KB XMS, %u bytes conventional cache",

146 
XMS_BUFFER_POOL_SIZE_KB
, 
CONVENTIONAL_CACHE_SIZE
);

148  
SUCCESS
;

149 
	}
}

154 
	$xms_bufãr_mig¿tiÚ_ş—nup
() {

155 ià(!
g_xms_š™Ÿlized
) {

156  
SUCCESS
;

159 
	`log_šfo
("Cleaning up XMS buffer migration system");

162 ià(
g_xms_poŞ
.
xms_locked
) {

163 
	`xms_bufãr_uÆock_poŞ
();

167 ià(
g_xms_poŞ
.
xms_hªdË
 !ğ
XMS_INVALID_HANDLE
) {

168 
	`xms_ä“
(
g_xms_poŞ
.
xms_hªdË
);

169 
g_xms_poŞ
.
xms_hªdË
 = 
XMS_INVALID_HANDLE
;

173 ià(
g_xms_poŞ
.
cÚv_ÿche
) {

174 
	`memÜy_ä“
(
g_xms_poŞ
.
cÚv_ÿche
);

175 
g_xms_poŞ
.
cÚv_ÿche
 = 
NULL
;

179 
	`log_šfo
("XMS migration stats: %luo XMS, %luo conv, %lu hits, %lu misses",

180 
g_xms_poŞ
.
xms_mig¿tiÚs
,

181 
g_xms_poŞ
.
cÚv_mig¿tiÚs
,

182 
g_xms_poŞ
.
ÿche_h™s
,

183 
g_xms_poŞ
.
ÿche_mis£s
);

185 
	`mem£t
(&
g_xms_poŞ
, 0, (
xms_bufãr_poŞ_t
));

186 
g_xms_mig¿tiÚ_’abËd
 = 
çl£
;

187 
g_xms_š™Ÿlized
 = 
çl£
;

189  
SUCCESS
;

190 
	}
}

195 * 
	$xms_bufãr_®loÿ‹
(
ušt16_t
 
size
, 
boŞ
 
Ãed_immedŸ‹_acûss
) {

196 
ušt16_t
 
bufãr_šdex
;

197 
ušt32_t
 
xms_off£t
;

199 ià(!
g_xms_mig¿tiÚ_’abËd
) {

201  
	`memÜy_®loÿ‹
(
size
, 
MEMORY_TYPE_DMA_SAFE
);

205 
size
 = (siz+ 
XMS_BUFFER_ALIGNMENT
 - 1) & ~(XMS_BUFFER_ALIGNMENT - 1);

208 
bufãr_šdex
 = 0; bufãr_šdex < 
MAX_PACKET_BUFFERS
; buffer_index++) {

209 ià(!
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_u£
) {

214 ià(
bufãr_šdex
 >ğ
MAX_PACKET_BUFFERS
) {

215 
	`log_”rÜ
("No free buffer slots");

216  
NULL
;

220 
xms_off£t
 = 
bufãr_šdex
 * 
MAX_PACKET_SIZE
;

223 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
xms_off£t
 = xms_offset;

224 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
 = size;

225 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_u£
 = 
Œue
;

227 ià(
Ãed_immedŸ‹_acûss
) {

229 
cÚv_off£t
 = 
	`xms_bufãr_fšd_cÚv_¥aû
(
size
);

231 ià(
cÚv_off£t
 >= 0) {

232 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
 = 
Œue
;

233 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
 = conv_offset;

234 
g_xms_poŞ
.
bufãrs_š_cÚv
++;

236 
	`log_debug
("Allocated buffer %u in conventional cache‡t offset %d",

237 
bufãr_šdex
, 
cÚv_off£t
);

239  
g_xms_poŞ
.
cÚv_ÿche
 + 
cÚv_off£t
;

244 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
 = 
çl£
;

245 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
 = 0;

246 
g_xms_poŞ
.
bufãrs_š_xms
++;

248 
	`log_debug
("Allocated buffer %u in XMS‡t offset %lu",

249 
bufãr_šdex
, 
xms_off£t
);

252  (*)(
ušŒ_t
)(
bufãr_šdex
 | 0x8000);

253 
	}
}

258 
	$xms_bufãr_ä“
(*
bufãr
) {

259 
ušt16_t
 
bufãr_šdex
;

261 ià(!
g_xms_mig¿tiÚ_’abËd
) {

263 
	`memÜy_ä“
(
bufãr
);

264  
SUCCESS
;

268 ià((
ušŒ_t
)
bufãr
 & 0x8000) {

269 
bufãr_šdex
 = (
ušŒ_t
)
bufãr
 & 0x7FFF;

272 
ušt8_t
 *
±r
 = (ušt8_t*)
bufãr
;

273 ià(
±r
 < 
g_xms_poŞ
.
cÚv_ÿche
 ||

274 
±r
 >ğ
g_xms_poŞ
.
cÚv_ÿche
 + 
CONVENTIONAL_CACHE_SIZE
) {

276 
	`memÜy_ä“
(
bufãr
);

277  
SUCCESS
;

281 
ušt16_t
 
off£t
 = 
±r
 - 
g_xms_poŞ
.
cÚv_ÿche
;

282 
bufãr_šdex
 = 0; bufãr_šdex < 
MAX_PACKET_BUFFERS
; buffer_index++) {

283 ià(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_u£
 &&

284 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
 &&

285 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
 =ğ
off£t
) {

290 ià(
bufãr_šdex
 >ğ
MAX_PACKET_BUFFERS
) {

291 
	`log_”rÜ
("Buffer‚ot found inrackingable");

292  
ERROR_INVALID_PARAM
;

297 ià(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
) {

298 
g_xms_poŞ
.
cÚv_ÿche_u£d
 -ğg_xms_poŞ.
bufãrs
[
bufãr_šdex
].
size
;

299 
g_xms_poŞ
.
bufãrs_š_cÚv
--;

301 
g_xms_poŞ
.
bufãrs_š_xms
--;

304 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_u£
 = 
çl£
;

306 
	`log_debug
("F»ed bufã¸%u", 
bufãr_šdex
);

308  
SUCCESS
;

309 
	}
}

314 * 
	$xms_bufãr_g‘_acûss
(*
bufãr
, 
ušt16_t
 *
size
) {

315 
ušt16_t
 
bufãr_šdex
;

317 ià(!
g_xms_mig¿tiÚ_’abËd
) {

319  
bufãr
;

323 ià(!((
ušŒ_t
)
bufãr
 & 0x8000)) {

325 
g_xms_poŞ
.
ÿche_h™s
++;

326  
bufãr
;

329 
bufãr_šdex
 = (
ušŒ_t
)
bufãr
 & 0x7FFF;

331 ià(
bufãr_šdex
 >ğ
MAX_PACKET_BUFFERS
 ||

332 !
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_u£
) {

333 
	`log_”rÜ
("Inv®id bufã¸šdex: %u", 
bufãr_šdex
);

334  
NULL
;

338 ià(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
) {

339 
g_xms_poŞ
.
ÿche_h™s
++;

340 ià(
size
è*sizğ
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].size;

341  
g_xms_poŞ
.
cÚv_ÿche
 + g_xms_poŞ.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
;

344 
g_xms_poŞ
.
ÿche_mis£s
++;

347 
cÚv_off£t
 = 
	`xms_bufãr_fšd_cÚv_¥aû
(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
);

349 ià(
cÚv_off£t
 < 0) {

351 
	`xms_bufãr_eviù_äom_ÿche
();

352 
cÚv_off£t
 = 
	`xms_bufãr_fšd_cÚv_¥aû
(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
);

354 ià(
cÚv_off£t
 < 0) {

355 
	`log_”rÜ
("Cannot‡llocate space in conventional cache");

356  
NULL
;

361 
»suÉ
 = 
	`xms_bufãr_cİy_äom_xms
(

362 
g_xms_poŞ
.
cÚv_ÿche
 + 
cÚv_off£t
,

363 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
xms_off£t
,

364 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size


367 ià(
»suÉ
 !ğ
SUCCESS
) {

368 
	`log_”rÜ
("Failedo copy buffer from XMS");

369  
NULL
;

373 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
 = 
Œue
;

374 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
 = conv_offset;

375 
g_xms_poŞ
.
bufãrs_š_xms
--;

376 
g_xms_poŞ
.
bufãrs_š_cÚv
++;

377 
g_xms_poŞ
.
cÚv_mig¿tiÚs
++;

379 
	`log_debug
("Migrated buffer %u from XMSo conventional‡t offset %d",

380 
bufãr_šdex
, 
cÚv_off£t
);

382 ià(
size
è*sizğ
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].size;

383  
g_xms_poŞ
.
cÚv_ÿche
 + 
cÚv_off£t
;

384 
	}
}

389 
	$xms_bufãr_»Ëa£_acûss
(*
bufãr
) {

392  
SUCCESS
;

393 
	}
}

400 
	$xms_bufãr_fšd_cÚv_¥aû
(
ušt16_t
 
size
) {

401 
ušt16_t
 
off£t
 = 0;

402 
ušt16_t
 
be¡_off£t
 = 0xFFFF;

403 
ušt16_t
 
be¡_size
 = 0xFFFF;

406 
off£t
 < 
CONVENTIONAL_CACHE_SIZE
) {

407 
ušt16_t
 
ä“_size
 = 0;

408 
ušt16_t
 
sÿn_off£t
 = 
off£t
;

411 
boŞ
 
found_u£d
 = 
çl£
;

412 
i
 = 0; i < 
MAX_PACKET_BUFFERS
; i++) {

413 ià(
g_xms_poŞ
.
bufãrs
[
i
].
š_u£
 &&

414 
g_xms_poŞ
.
bufãrs
[
i
].
š_cÚv_ÿche
) {

416 ià(
g_xms_poŞ
.
bufãrs
[
i
].
cÚv_off£t
 >ğ
sÿn_off£t
 &&

417 
g_xms_poŞ
.
bufãrs
[
i
].
cÚv_off£t
 < 
sÿn_off£t
 + 
size
) {

419 
found_u£d
 = 
Œue
;

420 
off£t
 = 
g_xms_poŞ
.
bufãrs
[
i
].
cÚv_off£t
 +

421 
g_xms_poŞ
.
bufãrs
[
i
].
size
;

427 ià(!
found_u£d
) {

429 ià(
off£t
 + 
size
 <ğ
CONVENTIONAL_CACHE_SIZE
) {

430 
g_xms_poŞ
.
cÚv_ÿche_u£d
 +ğ
size
;

431  
off£t
;

438 
	}
}

443 
	$xms_bufãr_eviù_äom_ÿche
() {

445 
i
 = 0; i < 
MAX_PACKET_BUFFERS
; i++) {

446 ià(
g_xms_poŞ
.
bufãrs
[
i
].
š_u£
 &&

447 
g_xms_poŞ
.
bufãrs
[
i
].
š_cÚv_ÿche
) {

450 
	`xms_bufãr_cİy_to_xms
(

451 
g_xms_poŞ
.
bufãrs
[
i
].
xms_off£t
,

452 
g_xms_poŞ
.
cÚv_ÿche
 + g_xms_poŞ.
bufãrs
[
i
].
cÚv_off£t
,

453 
g_xms_poŞ
.
bufãrs
[
i
].
size


457 
g_xms_poŞ
.
bufãrs
[
i
].
š_cÚv_ÿche
 = 
çl£
;

458 
g_xms_poŞ
.
cÚv_ÿche_u£d
 -ğg_xms_poŞ.
bufãrs
[
i
].
size
;

459 
g_xms_poŞ
.
bufãrs_š_cÚv
--;

460 
g_xms_poŞ
.
bufãrs_š_xms
++;

461 
g_xms_poŞ
.
xms_mig¿tiÚs
++;

463 
	`log_debug
("Eviùed bufã¸%d from cÚv’tiÚ® cache", 
i
);

467 
	}
}

472 
	$xms_bufãr_cİy_to_xms
(
ušt32_t
 
xms_off£t
, *
¤c
, 
ušt16_t
 
size
) {

473 
xms_move_t
 
move
;

475 
	`mem£t
(&
move
, 0, (move));

476 
move
.
Ëngth
 = 
size
;

477 
move
.
sourû_hªdË
 = 0;

478 
move
.
sourû_off£t
 = (
ušt32_t
)(
ušŒ_t
)
¤c
;

479 
move
.
de¡_hªdË
 = 
g_xms_poŞ
.
xms_hªdË
;

480 
move
.
de¡_off£t
 = 
xms_off£t
;

482  
	`xms_move_memÜy
(&
move
);

483 
	}
}

488 
	$xms_bufãr_cİy_äom_xms
(*
de¡
, 
ušt32_t
 
xms_off£t
, 
ušt16_t
 
size
) {

489 
xms_move_t
 
move
;

491 
	`mem£t
(&
move
, 0, (move));

492 
move
.
Ëngth
 = 
size
;

493 
move
.
sourû_hªdË
 = 
g_xms_poŞ
.
xms_hªdË
;

494 
move
.
sourû_off£t
 = 
xms_off£t
;

495 
move
.
de¡_hªdË
 = 0;

496 
move
.
de¡_off£t
 = (
ušt32_t
)(
ušŒ_t
)
de¡
;

498  
	`xms_move_memÜy
(&
move
);

499 
	}
}

504 
	$xms_bufãr_g‘_¡©s
(
xms_mig¿tiÚ_¡©s_t
 *
¡©s
) {

505 ià(!
¡©s
) ;

507 
¡©s
->
’abËd
 = 
g_xms_mig¿tiÚ_’abËd
;

508 
¡©s
->
xms_size_kb
 = 
g_xms_poŞ
.xms_size_kb;

509 
¡©s
->
cÚv_ÿche_size
 = 
g_xms_poŞ
.conv_cache_size;

510 
¡©s
->
cÚv_ÿche_u£d
 = 
g_xms_poŞ
.conv_cache_used;

511 
¡©s
->
bufãrs_š_xms
 = 
g_xms_poŞ
.buffers_in_xms;

512 
¡©s
->
bufãrs_š_cÚv
 = 
g_xms_poŞ
.buffers_in_conv;

513 
¡©s
->
xms_mig¿tiÚs
 = 
g_xms_poŞ
.xms_migrations;

514 
¡©s
->
cÚv_mig¿tiÚs
 = 
g_xms_poŞ
.conv_migrations;

515 
¡©s
->
ÿche_h™s
 = 
g_xms_poŞ
.cache_hits;

516 
¡©s
->
ÿche_mis£s
 = 
g_xms_poŞ
.cache_misses;

519 
ušt32_t
 
tÙ®_acûs£s
 = 
¡©s
->
ÿche_h™s
 + sts->
ÿche_mis£s
;

520 ià(
tÙ®_acûs£s
 > 0) {

521 
¡©s
->
ÿche_h™_¿‹
 = (¡©s->
ÿche_h™s
 * 100è/ 
tÙ®_acûs£s
;

523 
¡©s
->
ÿche_h™_¿‹
 = 0;

527 
¡©s
->
memÜy_§ved
 = 
g_xms_poŞ
.
bufãrs_š_xms
 * 
MAX_PACKET_SIZE
;

528 
	}
}

533 
	$xms_bufãr_mig¿‹_to_xms
(
ušt16_t
 
bufãr_šdex
) {

535 
ušt16_t
 
æags
;

536 
ušt8_t
 
FAR
 *
¤c
;

537 
»suÉ
;

540 ià(
bufãr_šdex
 >ğ
MAX_PACKET_BUFFERS
) {

541 
	`log_”rÜ
("Inv®id bufã¸šdex: %u", 
bufãr_šdex
);

542  
ERROR_INVALID_PARAM
;

546 ià(!
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_u£
) {

547 
	`log_”rÜ
("Bufã¸%u‚Ù iÀu£", 
bufãr_šdex
);

548  
ERROR_INVALID_STATE
;

552 ià(!
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
) {

553  
SUCCESS
;

557 ià(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
xms_off£t
 == 0) {

558 
	`log_”rÜ
("Bufã¸%u ha nØXMS‡ÎoÿtiÚ", 
bufãr_šdex
);

559  
ERROR_INVALID_STATE
;

565 
	`CRITICAL_SECTION_ENTER
(
æags
);

566 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
mig¿tšg
 = 1;

567 
	`CRITICAL_SECTION_EXIT
(
æags
);

573 vŞ©
timeout
 = 1000;

574 
timeout
-- > 0) {

579 vŞ©
d–ay
 = 10;

580 
d–ay
-- > 0) {

585 ià(
timeout
 <= 0) {

587 
	`CRITICAL_SECTION_ENTER
(
æags
);

588 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
mig¿tšg
 = 0;

589 
	`CRITICAL_SECTION_EXIT
(
æags
);

590 
	`log_”rÜ
("DMAimeouˆfÜ bufã¸%u", 
bufãr_šdex
);

591  
ERROR_TIMEOUT
;

596 ià((
ušt32_t
)
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
 +

597 (
ušt32_t
)
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
 >

598 (
ušt32_t
)
g_xms_poŞ
.
cÚv_ÿche_size
) {

599 
	`log_”rÜ
("Buffer %u conv boundsƒxceeded: offset=%u size=%u cache_size=%u",

600 
bufãr_šdex
,

601 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
,

602 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
,

603 
g_xms_poŞ
.
cÚv_ÿche_size
);

604 
	`CRITICAL_SECTION_ENTER
(
æags
);

605 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
mig¿tšg
 = 0;

606 
	`CRITICAL_SECTION_EXIT
(
æags
);

607  
ERROR_BOUNDS
;

611 
¤c
 = 
g_xms_poŞ
.
cÚv_ÿche
 + g_xms_poŞ.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
;

612 
»suÉ
 = 
	`xms_bufãr_cİy_to_xms
(

613 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
xms_off£t
,

614 
¤c
,

615 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size


619 ià(
»suÉ
 !ğ
SUCCESS
) {

620 
	`log_”rÜ
("FaedØcİy bufã¸%uØXMS", 
bufãr_šdex
);

622 
	`CRITICAL_SECTION_ENTER
(
æags
);

623 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
mig¿tšg
 = 0;

624 
	`CRITICAL_SECTION_EXIT
(
æags
);

625  
»suÉ
;

629 
	`CRITICAL_SECTION_ENTER
(
æags
);

630 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
 = 0;

631 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
mig¿tšg
 = 0;

632 
g_xms_poŞ
.
cÚv_ÿche_u£d
 -ğg_xms_poŞ.
bufãrs
[
bufãr_šdex
].
size
;

633 
g_xms_poŞ
.
bufãrs_š_cÚv
--;

634 
g_xms_poŞ
.
bufãrs_š_xms
++;

635 
	`CRITICAL_SECTION_EXIT
(
æags
);

637 
g_xms_poŞ
.
xms_mig¿tiÚs
++;

639 
	`log_debug
("Mig¿‹d bufã¸%uØXMS", 
bufãr_šdex
);

640  
SUCCESS
;

641 
	}
}

646 
	$xms_bufãr_mig¿‹_to_cÚv
(
ušt16_t
 
bufãr_šdex
) {

648 ià(
bufãr_šdex
 >ğ
MAX_PACKET_BUFFERS
) {

649 
	`log_”rÜ
("Inv®id bufã¸šdex: %u", 
bufãr_šdex
);

650  
ERROR_INVALID_PARAM
;

654 ià(!
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_u£
 ||

655 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
) {

656  
SUCCESS
;

660 
off£t
 = 
	`xms_bufãr_fšd_cÚv_¥aû
(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
);

661 ià(
off£t
 < 0) {

663 
	`xms_bufãr_eviù_äom_ÿche
();

664 
off£t
 = 
	`xms_bufãr_fšd_cÚv_¥aû
(
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
);

666 ià(
off£t
 < 0) {

667 
g_xms_poŞ
.
ÿche_mis£s
++;

668  
ERROR_NO_MEMORY
;

673 
ušt8_t
 *
de¡
 = 
g_xms_poŞ
.
cÚv_ÿche
 + 
off£t
;

674 
»suÉ
 = 
	`xms_bufãr_cİy_äom_xms
(

675 
de¡
,

676 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
xms_off£t
,

677 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size


680 ià(
»suÉ
 !ğ
SUCCESS
) {

681 
	`log_”rÜ
("FaedØcİy bufã¸%u from XMS", 
bufãr_šdex
);

682  
»suÉ
;

686 ià((
ušt32_t
)
off£t
 + (ušt32_t)
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
size
 >

687 (
ušt32_t
)
g_xms_poŞ
.
cÚv_ÿche_size
) {

688 
	`log_”rÜ
("Bufã¸%u wouldƒxûed cÚv cachbounds", 
bufãr_šdex
);

689  
ERROR_BOUNDS
;

693 
ušt16_t
 
æags
;

694 
	`CRITICAL_SECTION_ENTER
(
æags
);

695 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
š_cÚv_ÿche
 = 1;

696 
g_xms_poŞ
.
bufãrs
[
bufãr_šdex
].
cÚv_off£t
 = (
ušt16_t
)
off£t
;

697 
g_xms_poŞ
.
bufãrs_š_cÚv
++;

698 
g_xms_poŞ
.
bufãrs_š_xms
--;

699 
	`CRITICAL_SECTION_EXIT
(
æags
);

701 
g_xms_poŞ
.
cÚv_mig¿tiÚs
++;

702 
g_xms_poŞ
.
ÿche_h™s
++;

704  
SUCCESS
;

705 
	}
}

	@
1
.
0
17
1190
/Users/jvindahl/Development/3com-packet-driver/include/cache_coherency.h
/Users/jvindahl/Development/3com-packet-driver/include/dma.h
/Users/jvindahl/Development/3com-packet-driver/include/dma_safety.h
/Users/jvindahl/Development/3com-packet-driver/include/handle_compact.h
/Users/jvindahl/Development/3com-packet-driver/include/multi_nic_coord.h
/Users/jvindahl/Development/3com-packet-driver/include/runtime_config.h
/Users/jvindahl/Development/3com-packet-driver/include/xms_buffer_migration.h
/Users/jvindahl/Development/3com-packet-driver/src/asm/cache_ops.asm
/Users/jvindahl/Development/3com-packet-driver/src/c/cache_coherency.c
/Users/jvindahl/Development/3com-packet-driver/src/c/cache_management.c
/Users/jvindahl/Development/3com-packet-driver/src/c/dma.c
/Users/jvindahl/Development/3com-packet-driver/src/c/dma_safety.c
/Users/jvindahl/Development/3com-packet-driver/src/c/dma_self_test.c
/Users/jvindahl/Development/3com-packet-driver/src/c/handle_compact.c
/Users/jvindahl/Development/3com-packet-driver/src/c/multi_nic_coord.c
/Users/jvindahl/Development/3com-packet-driver/src/c/runtime_config.c
/Users/jvindahl/Development/3com-packet-driver/src/c/xms_buffer_migration.c
