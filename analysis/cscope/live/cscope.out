cscope 15 $HOME/Development/3com-packet-driver/analysis/cscope/live -q 0000006101 0000949535
	@/Users/jvindahl/Development/3com-packet-driver/include/3c509b.h

38 #iâdeà
_3C509B_H_


39 
	#_3C509B_H_


	)

41 
	~<¡dšt.h
>

48 
outb
(
ušt16_t
 
pÜt
, 
ušt8_t
 
v®ue
);

49 
outw
(
ušt16_t
 
pÜt
, ušt16_ˆ
v®ue
);

50 
ušt8_t
 
šb
(
ušt16_t
 
pÜt
);

51 
ušt16_t
 
šw
(ušt16_ˆ
pÜt
);

55 
	m_3C509B_SUCCESS
 = 0,

56 
	m_3C509B_ERR_NO_CARD
,

57 
	m_3C509B_ERR_INIT_FAIL
,

58 
	m_3C509B_ERR_TX_TIMEOUT
,

59 
	m_3C509B_ERR_TX_ABORTED
,

60 
	m_3C509B_ERR_TX_UNDERRUN
,

61 
	m_3C509B_ERR_TX_JABBER
,

62 
	m_3C509B_ERR_RX_OVERRUN
,

63 
	m_3C509B_ERR_RX_CRC
,

64 
	m_3C509B_ERR_RX_FRAMING
,

65 
	m_3C509B_ERR_RX_LENGTH
,

66 
	m_3C509B_ERR_RX_OVERSIZE
,

67 
	m_3C509B_ERR_INVALID_PACKET
,

68 
	m_3C509B_ERR_RX_INCOMPLETE
,

69 
	m_3C509B_ERR_ADAPTER_FAILURE
,

70 
	m_3C509B_ERR_STATS_FULL
,

71 
	m_3C509B_ERR_OTHER


72 } 
	t_3c509b_”rÜ_t
;

76 
	#_3C509B_MANUFACTURER_ID
 0x6D50

77 
	#_3C509B_PRODUCT_ID_509B
 0x5090

78 
	#_3C509B_PRODUCT_ID_MASK
 0xF0FF

79 
	#_3C509B_MAX_MTU
 1514

80 
	#_3C509B_MIN_PACKET_SIZE
 60

81 
	#_3C509B_BUFFER_SIZE
 0x2000

82 
	#_3C509B_IO_EXTENT
 16

83 
	#_3C509B_ID_PORT
 0x110

84 
	#_3C509B_RESIDENT_MEMORY_SIZE
 0x1000

85 

	)

89 
	#_3C509B_INIT_DELAY_LOOPS
 0x100

93 

	)

94 
	#_3C509B_EEPROM_READ_DELAY
 2000

95 
	#_3C509B_TX_TIMEOUT_LOOPS
 0x1000

96 

	)

97 
	#_3C509B_PIT_COUNTER_PORT
 0x40

98 

	)

101 
	#_3C509B_WINDOW_0
 0

102 
	#_3C509B_WINDOW_1
 1

103 
	#_3C509B_WINDOW_2
 2

104 
	#_3C509B_WINDOW_4
 4

105 
	#_3C509B_WINDOW_6
 6

106 

	)

115 
	#_3C509B_COMMAND_REG
 0x0E

116 
	#_3C509B_STATUS_REG
 0x0E

117 

	)

123 
	#_3C509B_CMD_TOTAL_RESET
 (0 << 11)

124 
	#_3C509B_CMD_SELECT_WINDOW
 (1 << 11)

125 
	#_3C509B_CMD_START_COAX
 (2 << 11)

126 
	#_3C509B_CMD_RX_DISABLE
 (3 << 11)

127 
	#_3C509B_CMD_RX_ENABLE
 (4 << 11)

128 
	#_3C509B_CMD_RX_RESET
 (5 << 11)

129 
	#_3C509B_CMD_RX_DISCARD
 (8 << 11)

130 
	#_3C509B_CMD_TX_ENABLE
 (9 << 11)

131 
	#_3C509B_CMD_TX_DISABLE
 (10 << 11)

132 
	#_3C509B_CMD_TX_RESET
 (11 << 11)

133 
	#_3C509B_CMD_ACK_INTR
 (13 << 11)

134 
	#_3C509B_CMD_SET_INTR_ENB
 (14 << 11)

135 
	#_3C509B_CMD_SET_STATUS_ENB
 (15 << 11)

136 
	#_3C509B_CMD_SET_RX_FILTER
 (16 << 11)

137 
	#_3C509B_CMD_SET_TX_THRESHOLD
 (18 << 11)

138 
	#_3C509B_CMD_SET_TX_START
 (19 << 11)

139 
	#_3C509B_CMD_STATS_ENABLE
 (21 << 11)

140 
	#_3C509B_CMD_STATS_DISABLE
 (22 << 11)

141 
	#_3C509B_CMD_STOP_COAX
 (23 << 11)

142 
	#_3C509B_CMD_POWER_UP
 (27 << 11)

143 
	#_3C509B_CMD_POWER_DOWN
 (28 << 11)

144 
	#_3C509B_CMD_POWER_AUTO
 (29 << 11)

145 

	)

149 
	#_3C509B_STATUS_INT_LATCH
 0x0001

150 
	#_3C509B_STATUS_ADAPTER_FAILURE
 0x0002

151 
	#_3C509B_STATUS_TX_COMPLETE
 0x0004

152 
	#_3C509B_STATUS_TX_AVAILABLE
 0x0008

153 
	#_3C509B_STATUS_RX_COMPLETE
 0x0010

154 
	#_3C509B_STATUS_RX_EARLY
 0x0020

155 
	#_3C509B_STATUS_INT_REQ
 0x0040

156 
	#_3C509B_STATUS_STATS_FULL
 0x0080

157 
	#_3C509B_STATUS_CMD_BUSY
 0x1000

158 

	)

161 
	#_3C509B_W0_CONFIG_CTRL
 0x04

162 
	#_3C509B_W0_ADDR_CONFIG
 0x06

163 
	#_3C509B_W0_IRQ
 0x08

164 
	#_3C509B_EEPROM_CMD
 0x0A

165 
	#_3C509B_EEPROM_DATA
 0x0C

166 

	)

168 
	#_3C509B_EEPROM_READ
 0x80

169 
	#_3C509B_EEPROM_WRITE
 0x40

170 
	#_3C509B_EEPROM_ERASE
 0xC0

171 
	#_3C509B_EEPROM_EWENB
 0x30

172 
	#_3C509B_EEPROM_EWDIS
 0x00

173 

	)

176 
	#_3C509B_TX_FIFO
 0x00

177 
	#_3C509B_RX_FIFO
 0x00

178 
	#_3C509B_RX_STATUS
 0x08

179 
	#_3C509B_TX_STATUS
 0x0B

180 
	#_3C509B_TX_FREE
 0x0C

181 

	)

184 
	#_3C509B_RX_FILTER_STATION
 0x0001

185 
	#_3C509B_RX_FILTER_MULTICAST
 0x0002

186 
	#_3C509B_RX_FILTER_BROADCAST
 0x0004

187 
	#_3C509B_RX_FILTER_PROMISCUOUS
 0x0008

189 

	)

191 
	#_3C509B_IMASK_ADAPTER_FAILURE
 
_3C509B_STATUS_ADAPTER_FAILURE


	)

192 
	#_3C509B_IMASK_TX_COMPLETE
 
_3C509B_STATUS_TX_COMPLETE


	)

193 
	#_3C509B_IMASK_TX_AVAILABLE
 
_3C509B_STATUS_TX_AVAILABLE


	)

194 
	#_3C509B_IMASK_RX_COMPLETE
 
_3C509B_STATUS_RX_COMPLETE


	)

195 
	#_3C509B_IMASK_RX_EARLY
 
_3C509B_STATUS_RX_EARLY


	)

196 
	#_3C509B_IMASK_STATS_FULL
 
_3C509B_STATUS_STATS_FULL


	)

197 
	#_3C509B_IMASK_INT_LATCHED
 
_3C509B_STATUS_INT_LATCH


198 
	#_3C509B_IMASK_ALL
 0x00bf

199 

	)

201 
	#_3C509B_RXSTAT_INCOMPLETE
 0x8000

202 
	#_3C509B_RXSTAT_ERROR
 0x4000

203 
	#_3C509B_RXSTAT_LEN_MASK
 0x07FF

204 

	)

206 
	#_3C509B_RXERR_OVERRUN
 0x0000

207 
	#_3C509B_RXERR_OVERSIZE
 0x0800

208 
	#_3C509B_RXERR_DRIBBLE
 0x1000

209 
	#_3C509B_RXERR_RUNT
 0x1800

210 
	#_3C509B_RXERR_CRC
 0x2800

211 
	#_3C509B_RXERR_FRAMING
 0x2000

212 
	#_3C509B_RXERR_LENGTH
 0x1800

213 

	)

216 
	#_3C509B_TXSTAT_COMPLETE
 0x80

217 
	#_3C509B_TXSTAT_INTERRUPT
 0x40

218 
	#_3C509B_TXSTAT_JABBER
 0x20

219 
	#_3C509B_TXSTAT_UNDERRUN
 0x10

220 
	#_3C509B_TXSTAT_MAX_COLLISIONS
 0x08

221 
	#_3C509B_TXSTAT_STATUS_OVERFLOW
 0x04

222 
	#_3C509B_TXSTAT_RX_STATUS_OVERFLOW
 0x02

223 
	#_3C509B_TXSTAT_RX_OVERRUN
 0x01

224 

	)

226 
	#_3C509B_TXSTAT_ERROR_MASK
 0x3F

227 
	#_3C509B_TXSTAT_SERIOUS_ERROR_MASK
 0x3C

228 
	#_3C509B_TXSTAT_OVERFLOW_MASK
 0x06

229 

	)

237 
	#_3C509B_MEDIA_CTRL
 0x0A

238 
	#_3C509B_W4_NETDIAG
 0x06

239 

	)

242 
	#_3C509B_MEDIA_SQE_DISABLE
 0x8000

243 
	#_3C509B_MEDIA_COLLISION_DETECT
 0x2000

244 
	#_3C509B_MEDIA_COLLISION_SOURCE
 0x1000

245 
	#_3C509B_MEDIA_UTP_DISABLE
 0x0800

246 
	#_3C509B_MEDIA_JABBER_GUARD_DISABLE
 0x0400

247 
	#_3C509B_MEDIA_GUARD_TIMER_DISABLE
 0x0200

248 
	#_3C509B_MEDIA_LINK_BEAT_DISABLE
 0x0080

249 
	#_3C509B_MEDIA_JABBER_DISABLE
 0x0040

250 
	#_3C509B_MEDIA_XCVR_MASK
 0x003C

251 
	#_3C509B_MEDIA_XCVR_SHIFT
 2

252 

	)

254 
	#_3C509B_XCVR_AUTO
 (0x0 << 2)

255 
	#_3C509B_XCVR_10BASE_T
 (0x0 << 2)

256 
	#_3C509B_XCVR_AUI_EXT
 (0x1 << 2)

257 
	#_3C509B_XCVR_10BASE2
 (0x3 << 2)

258 
	#_3C509B_XCVR_INTERNAL
 (0x8 << 2)

259 

	)

262 
	#_3C509B_NETDIAG_ASIC_REVMASK
 0xF000

263 
	#_3C509B_NETDIAG_ASIC_REVSHIFT
 12

264 
	#_3C509B_NETDIAG_UPPER_BYTES_OK
 0x0800

265 
	#_3C509B_NETDIAG_STATS_ENABLED
 0x0400

266 
	#_3C509B_NETDIAG_RX_ENABLED
 0x0200

267 
	#_3C509B_NETDIAG_TX_ENABLED
 0x0100

268 
	#_3C509B_NETDIAG_EXTERNAL_LOOP
 0x0080

269 
	#_3C509B_NETDIAG_INTERNAL_LOOP
 0x0040

270 
	#_3C509B_NETDIAG_FIFO_LOOPBACK
 0x0020

271 
	#_3C509B_NETDIAG_MAC_LOOPBACK
 0x0010

272 
	#_3C509B_NETDIAG_ENDEC_LOOPBACK
 0x0008

274 

	)

278 
	#_3C509B_W6_CARRIER_LOST
 0x00

279 
	#_3C509B_W6_SQE_ERRORS
 0x01

280 
	#_3C509B_W6_MULTIPLE_COLLS
 0x02

281 
	#_3C509B_W6_SINGLE_COLLS
 0x03

282 
	#_3C509B_W6_LATE_COLLS
 0x04

283 
	#_3C509B_W6_RX_OVERRUNS
 0x05

284 
	#_3C509B_W6_GOOD_TX
 0x06

285 
	#_3C509B_W6_GOOD_RX
 0x07

286 
	#_3C509B_W6_TX_DEFERRALS
 0x08

287 
	#_3C509B_W6_RX_OCTETS_LO
 0x0A

288 
	#_3C509B_W6_TX_OCTETS_LO
 0x0C

289 

	)

292 
	#_3C509B_ID_GLOBAL_RESET
 0xC0

293 
	#_3C509B_SET_TAG_REGISTER
 0xD0

294 
	#_3C509B_TEST_TAG_REGISTER
 0xD8

295 
	#_3C509B_ACTIVATE_AND_SET_IO
 0xE0

296 
	#_3C509B_ACTIVATE_VULCAN
 0xFF

297 

	)

302 
	#_3C509B_EEPROM_STATION_ADDR_LO
 0x00

303 
	#_3C509B_EEPROM_STATION_ADDR_MID
 0x01

304 
	#_3C509B_EEPROM_STATION_ADDR_HI
 0x02

305 
	#_3C509B_EEPROM_PRODUCT_ID
 0x03

306 
	#_3C509B_EEPROM_MFG_DATE
 0x04

307 
	#_3C509B_EEPROM_MFG_DIVISION
 0x05

308 
	#_3C509B_EEPROM_MFG_PRODUCT
 0x06

309 
	#_3C509B_EEPROM_MFG_ID
 0x07

310 
	#_3C509B_EEPROM_ADDR_CONFIG
 0x08

311 
	#_3C509B_EEPROM_RESOURCE_CONFIG
 0x09

312 
	#_3C509B_EEPROM_OEM_NODE_ADDR_LO
 0x0A

313 
	#_3C509B_EEPROM_OEM_NODE_ADDR_MID
 0x0B

314 
	#_3C509B_EEPROM_OEM_NODE_ADDR_HI
 0x0C

315 
	#_3C509B_EEPROM_SW_CONFIG_INFO
 0x0D

316 
	#_3C509B_EEPROM_CHECKSUM
 0x0F

317 

	)

319 
	#_3C509B_CONFIG_XCVR_MASK
 0x4000

320 
	#_3C509B_CONFIG_XCVR_SHIFT
 14

321 
	#_3C509B_CONFIG_AUTO_SELECT
 0x0100

322 
	#_3C509B_CONFIG_FULL_DUPLEX
 0x0020

323 

	)

325 
	#_3C509B_EEPROM_XCVR_MASK
 0xC000

326 
	#_3C509B_EEPROM_XCVR_SHIFT
 14

327 
	#_3C509B_EEPROM_AUTO_SELECT
 0x0100

328 
	#_3C509B_EEPROM_FULL_DUPLEX
 0x0020

329 

	)

333 
	#_3C509B_EEPROM_BUSY_BIT
 0x8000

334 
	#_3C509B_EEPROM_CMD_PORT
 0x0A

335 
	#_3C509B_EEPROM_DATA_PORT
 0x0C

336 
	#_3C509B_EEPROM_DELAY_US
 162

337 
	#_3C509B_EEPROM_TIMEOUT_MS
 1

338 

	)

340 
	#_3C509B_ISA_IO_DELAY
(è
	`šb
(0x80)

	)

343 
	#_3C509B_DELAY_US
(
n
) { \

344 
ušt16_t
 
_loİs
 = (
n
) / 3; \

345 
_loİs
--è
	`_3C509B_ISA_IO_DELAY
(); \

346 }

	)

349 
	#_3C509B_ACK_INTERRUPT
(
ba£
, 
mask
) \

350 
	`outw
((
ušt16_t
)((
ba£
è+ 
_3C509B_COMMAND_REG
), (ušt16_t)(
_3C509B_CMD_ACK_INTR
 | (
mask
)))

	)

353 
	#_3C509B_SEND_EOI_MASTER
(è
	`outb
(0x20, 0x20)

354 
	#_3C509B_SEND_EOI_SLAVE
(è
	`outb
(0xA0, 0x20)

355 

	)

357 
	#_3C509B_TX_FIFO_PORT
 0x00

358 
	#_3C509B_RX_FIFO_PORT
 0x00

359 
	#_3C509B_TX_FREE_PORT
 0x0C

360 
	#_3C509B_RX_STATUS_PORT
 0x08

361 
	#_3C509B_TX_STATUS_PORT
 0x0B

362 

	)

364 
	#_3C509B_CMD_MASK
 0xF800

365 
	#_3C509B_CMD_PARAM_MASK
 0x07FF

366 
	#_3C509B_MAKE_CMD
(
cmd
, 
·¿m
è((cmdè| (Õ¬amè& 
_3C509B_CMD_PARAM_MASK
))

	)

369 
	#_3C509B_WINDOW_CMD_PORT
 0x0E

370 
	#_3C509B_SELECT_WINDOW_DIRECT
(
ba£
, 
w
) \

371 
	`outw
((
ušt16_t
)((
ba£
è+ 
_3C509B_WINDOW_CMD_PORT
), (ušt16_t)(0x0800 | (
w
)))

	)

374 
	#_3C509B_MIN_PACKET_SIZE
 14

375 
	#_3C509B_MAX_PACKET_SIZE
 1514

376 

	)

378 
	#_3C509B_FLAG_CONFIGURED
 0x01

379 
	#_3C509B_FLAG_ENABLED
 0x02

380 
	#_3C509B_FLAG_PROMISCUOUS
 0x04

381 
	#_3C509B_FLAG_FULL_DUPLEX
 0x08

382 

	)

387 
	#_3C509B_SELECT_WINDOW
(
io_ba£
, 
wš
) \

388 
	`outw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_COMMAND_REG
), (ušt16_t)(
_3C509B_CMD_SELECT_WINDOW
 | (
wš
)))

	)

391 
	#_3C509B_SET_MEDIA_10BASE_T
(
io_ba£
) do { \

392 
	`_3C509B_SELECT_WINDOW
(
io_ba£
, 4); \

393 
	`outw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_MEDIA_CTRL
), 
_3C509B_XCVR_10BASE_T
); \

394 } 0)

	)

396 
	#_3C509B_SET_MEDIA_BNC
(
io_ba£
) do { \

397 
	`_3C509B_SELECT_WINDOW
(
io_ba£
, 4); \

398 
	`outw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_MEDIA_CTRL
), 
_3C509B_XCVR_10BASE2
); \

399 
	`outw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_COMMAND_REG
), 
_3C509B_CMD_START_COAX
); \

400 } 0)

	)

402 
	#_3C509B_SET_MEDIA_AUI
(
io_ba£
) do { \

403 
	`_3C509B_SELECT_WINDOW
(
io_ba£
, 4); \

404 
	`outw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_MEDIA_CTRL
), 
_3C509B_XCVR_AUI_EXT
); \

405 } 0)

	)

408 
	#_3C509B_READ_XCVR_TYPE_FROM_EEPROM
(
io_ba£
, 
addr
) ({ \

409 
ušt16_t
 
cÚfig
; \

410 
	`_3C509B_SELECT_WINDOW
(
io_ba£
, 0); \

411 
	`outw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_EEPROM_CMD
), 
_3C509B_EEPROM_READ
 | (
addr
)); \

412 dØ{ 
cÚfig
 = 
	`šw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_EEPROM_DATA
)); } \

413 
cÚfig
 & 
_3C509B_EEPROM_BUSY_BIT
); \

414 ((
cÚfig
 & 
_3C509B_EEPROM_XCVR_MASK
è>> 
_3C509B_EEPROM_XCVR_SHIFT
); \

415 })

	)

417 
	#_3C509B_GET_CURRENT_XCVR_TYPE
(
io_ba£
) ({ \

418 
ušt16_t
 
medŸ_ù¾
; \

419 
	`_3C509B_SELECT_WINDOW
(
io_ba£
, 4); \

420 
medŸ_ù¾
 = 
	`šw
((
ušt16_t
)(
io_ba£
 + 
_3C509B_MEDIA_CTRL
)); \

421 ((
medŸ_ù¾
 & 
_3C509B_MEDIA_XCVR_MASK
è>> 
_3C509B_MEDIA_XCVR_SHIFT
); \

422 })

	)

433 
£nd_·ck‘_dœeù_pio
(cÚ¡ * 
¡ack_bufãr
, 
ušt16_t
 
Ëngth
, ušt16_ˆ
io_ba£
);

441 
dœeù_pio_outsw
(cÚ¡ * 
¤c_bufãr
, 
ušt16_t
 
d¡_pÜt
, ušt16_ˆ
wÜd_couÁ
);

452 
£nd_·ck‘_dœeù_pio_w™h_h—d”
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
de¡_mac
,

453 
ušt16_t
 
‘h”ty³
, cÚ¡ * 
·ylßd
, ušt16_ˆ
·ylßd_Ën
);

	@/Users/jvindahl/Development/3com-packet-driver/include/3c515.h

11 #iâdeà
_3C515_H_


12 
	#_3C515_H_


	)

14 
	~<commÚ.h
>

17 
dma_äagm’t
 
	tdma_äagm’t_t
;

21 
	#_3C515_TX_PRODUCT_ID
 0x5051

22 
	#_3C515_TX_PRODUCT_ID_MASK
 0xF0FF

23 
	#_3C515_TX_MAX_MTU
 1514

24 
	#_3C515_TX_MIN_PACKET_SIZE
 60

25 
	#_3C515_TX_IO_EXTENT
 32

26 
	#_3C515_TX_TX_RING_SIZE
 16

27 
	#_3C515_TX_RX_RING_SIZE
 16

28 

	)

31 
	#_3C515_TX_WINDOW_0
 0

32 
	#_3C515_TX_WINDOW_1
 1

33 
	#_3C515_TX_WINDOW_2
 2

34 
	#_3C515_TX_WINDOW_3
 3

35 
	#_3C515_TX_WINDOW_4
 4

36 
	#_3C515_TX_WINDOW_6
 6

37 
	#_3C515_TX_WINDOW_7
 7

38 

	)

41 
	#_3C515_TX_COMMAND_REG
 0x0E

42 
	#_3C515_TX_STATUS_REG
 0x0E

43 

	)

48 
	#_3C515_TX_CMD_TOTAL_RESET
 (0 << 11)

49 
	#_3C515_TX_CMD_SELECT_WINDOW
 (1 << 11)

50 
	#_3C515_TX_CMD_START_COAX
 (2 << 11)

51 
	#_3C515_TX_CMD_RX_ENABLE
 (4 << 11)

52 
	#_3C515_TX_CMD_RX_DISABLE
 (3 << 11)

53 
	#_3C515_TX_CMD_RX_RESET
 (5 << 11)

54 
	#_3C515_TX_CMD_UP_STALL
 (6 << 11)

55 
	#_3C515_TX_CMD_UP_UNSTALL
 ((6 << 11) + 1)

56 
	#_3C515_TX_CMD_DOWN_STALL
 ((6 << 11) + 2)

57 
	#_3C515_TX_CMD_DOWN_UNSTALL
 ((6 << 11) + 3)

58 
	#_3C515_TX_CMD_RX_DISCARD
 (8 << 11)

59 
	#_3C515_TX_CMD_TX_ENABLE
 (9 << 11)

60 
	#_3C515_TX_CMD_TX_DISABLE
 (10 << 11)

61 
	#_3C515_TX_CMD_TX_RESET
 (11 << 11)

62 
	#_3C515_TX_CMD_FAKE_INTR
 (12 << 11)

63 
	#_3C515_TX_CMD_ACK_INTR
 (13 << 11)

64 
	#_3C515_TX_CMD_SET_INTR_ENB
 (14 << 11)

65 
	#_3C515_TX_CMD_SET_STATUS_ENB
 (15 << 11)

66 
	#_3C515_TX_CMD_SET_RX_FILTER
 (16 << 11)

67 
	#_3C515_TX_CMD_SET_RX_THRESHOLD
 (17 << 11)

68 
	#_3C515_TX_CMD_SET_TX_THRESHOLD
 (18 << 11)

69 
	#_3C515_TX_CMD_SET_TX_START
 (19 << 11)

70 
	#_3C515_TX_CMD_START_DMA_UP
 (20 << 11)

71 
	#_3C515_TX_CMD_START_DMA_DOWN
 ((20 << 11) + 1)

72 
	#_3C515_TX_CMD_STATS_ENABLE
 (21 << 11)

73 
	#_3C515_TX_CMD_STATS_DISABLE
 (22 << 11)

74 
	#_3C515_TX_CMD_STOP_COAX
 (23 << 11)

75 

	)

79 
	#_3C515_TX_STATUS_INT_LATCH
 0x0001

80 
	#_3C515_TX_STATUS_ADAPTER_FAILURE
 0x0002

81 
	#_3C515_TX_STATUS_TX_COMPLETE
 0x0004

82 
	#_3C515_TX_STATUS_TX_AVAILABLE
 0x0008

83 
	#_3C515_TX_STATUS_RX_COMPLETE
 0x0010

84 
	#_3C515_TX_STATUS_RX_EARLY
 0x0020

85 
	#_3C515_TX_STATUS_INT_REQ
 0x0040

86 
	#_3C515_TX_STATUS_STATS_FULL
 0x0080

87 
	#_3C515_TX_STATUS_DMA_DONE
 (1 << 8)

88 
	#_3C515_TX_STATUS_DOWN_COMPLETE
 (1 << 9)

89 
	#_3C515_TX_STATUS_UP_COMPLETE
 (1 << 10)

90 
	#_3C515_TX_STATUS_DMA_IN_PROGRESS
 (1 << 11)

91 
	#_3C515_TX_STATUS_CMD_IN_PROGRESS
 (1 << 12)

92 

	)

95 
	#_3C515_TX_IMASK_ADAPTER_FAILURE
 
_3C515_TX_STATUS_ADAPTER_FAILURE


	)

96 
	#_3C515_TX_IMASK_TX_COMPLETE
 
_3C515_TX_STATUS_TX_COMPLETE


	)

97 
	#_3C515_TX_IMASK_TX_AVAILABLE
 
_3C515_TX_STATUS_TX_AVAILABLE


	)

98 
	#_3C515_TX_IMASK_RX_COMPLETE
 
_3C515_TX_STATUS_RX_COMPLETE


	)

99 
	#_3C515_TX_IMASK_RX_EARLY
 
_3C515_TX_STATUS_RX_EARLY


	)

100 
	#_3C515_TX_IMASK_STATS_FULL
 
_3C515_TX_STATUS_STATS_FULL


	)

101 
	#_3C515_TX_IMASK_DMA_DONE
 
_3C515_TX_STATUS_DMA_DONE


	)

102 
	#_3C515_TX_IMASK_DOWN_COMPLETE
 
_3C515_TX_STATUS_DOWN_COMPLETE


	)

103 
	#_3C515_TX_IMASK_UP_COMPLETE
 
_3C515_TX_STATUS_UP_COMPLETE


	)

107 
	#_3C515_TX_RX_FILTER_STATION
 1

108 
	#_3C515_TX_RX_FILTER_MULTICAST
 2

109 
	#_3C515_TX_RX_FILTER_BROADCAST
 4

110 
	#_3C515_TX_RX_FILTER_PROM
 8

111 

	)

114 
	#_3C515_TX_W0_IRQ
 0x08

115 
	#_3C515_TX_W0_EEPROM_CMD
 0x200A

116 
	#_3C515_TX_W0_EEPROM_DATA
 0x200C

117 

	)

119 
	#_3C515_TX_EEPROM_READ
 0x80

120 
	#_3C515_TX_EEPROM_WRITE
 0x40

121 
	#_3C515_TX_EEPROM_ERASE
 0xC0

122 
	#_3C515_TX_EEPROM_EWENB
 0x30

123 
	#_3C515_TX_EEPROM_EWDIS
 0x00

124 

	)

126 
	#_3C515_TX_EEPROM_READ_DELAY
 162

127 

	)

129 
	e“´om_off£t
 {

130 
	mPhysAddr01
 = 0,

131 
	mPhysAddr23
 = 1,

132 
	mPhysAddr45
 = 2,

133 
	mMod–ID
 = 3,

134 
	mEth”Lšk3ID
 = 7

138 
	excvr_ty³s
 {

139 
	mXCVR_10ba£T
 = 0,

140 
	mXCVR_AUI
 = 1,

141 
	mXCVR_10ba£TOÆy
 = 2,

142 
	mXCVR_10ba£2
 = 3,

143 
	mXCVR_100ba£Tx
 = 4,

144 
	mXCVR_100ba£Fx
 = 5,

145 
	mXCVR_MII
 = 6,

146 
	mXCVR_DeçuÉ
 = 8

150 
	#MAX_INTERRUPT_WORK
 32

151 
	#WAIT_TX_AVAIL
 200

152 
	#RX_COPYBREAK
 200

153 

	)

157 
	#_3C515_TX_DMA_UP_LIST_PTR
 0x38

158 
	#_3C515_TX_DMA_DOWN_LIST_PTR
 0x24

159 
	#_3C515_TX_DMA_UP_PKT_STATUS
 0x30

160 
	#_3C515_TX_DMA_DOWN_PKT_STATUS
 0x20

161 

	)

163 
	#_3C515_TX_CMD_DOWN_STALL
 0x5000

164 
	#_3C515_TX_CMD_DOWN_UNSTALL
 0x5002

165 
	#_3C515_TX_CMD_UP_STALL
 0x5100

166 
	#_3C515_TX_CMD_UP_UNSTALL
 0x5102

167 

	)

170 
	#_3C515_TX_PKT_STATUS
 0x400

171 
	#_3C515_TX_DOWN_LIST_PTR
 0x404

172 
	#_3C515_TX_FRAG_ADDR
 0x408

173 
	#_3C515_TX_FRAG_LEN
 0x40C

174 
	#_3C515_TX_TX_FREE_THRESHOLD
 0x40F

175 
	#_3C515_TX_UP_PKT_STATUS
 0x410

176 
	#_3C515_TX_UP_LIST_PTR
 0x418

177 

	)

179 
	#_3C515_TX_DMA_DOWN_PKT_STATUS
 0x20

180 

	)

182 
	#_3C515_TX_W7_UP_LIST_PTR
 0x418

183 
	#_3C515_TX_W7_DOWN_LIST_PTR
 0x404

184 
	#_3C515_TX_W7_DMA_CTRL
 0x400

185 
	#_3C515_TX_W7_UP_POLL
 0x41C

186 
	#_3C515_TX_W7_DOWN_POLL
 0x408

187 

	)

190 
ušt32_t
 
	mÃxt
;

191 
ušt32_t
 
	m¡©us
;

192 
ušt32_t
 
	maddr
;

193 
ušt32_t
 
	mËngth
;

194 } 
	tdma_desütÜ_t
;

197 
	#_3C515_TX_DMA_DESC_COMPLETE
 0x00008000

198 
	#_3C515_TX_DMA_DESC_ERROR
 0x00004000

199 
	#_3C515_TX_DMA_DESC_LAST
 0x00002000

200 
	#_3C515_TX_DMA_DESC_FIRST
 0x00001000

201 
	#_3C515_TX_DMA_DESC_DN_COMPLETE
 0x00010000

202 
	#_3C515_TX_DMA_DESC_UP_COMPLETE
 0x00020000

203 

	)

205 
	#_3C515_TX_ISA_IO_DELAY
(è
	`ou
(0x80, 0)

206 
	#_3C515_TX_EEPROM_DELAY_US
 162

207 
	#_3C515_TX_RESET_DELAY_MS
 10

208 

	)

210 
	#_3C515_TX_ISA_DMA_MAX_ADDR
 0xFFFFFF

211 
	#_3C515_TX_ISA_DMA_BOUNDARY
 0x10000

212 
	#_3C515_TX_EEPROM_DELAY_US
 200

213 
	#_3C515_TX_RESET_DELAY_MS
 10

214 

	)

216 
	#_3C515_TX_PHYS_TO_SEGMENT
(
addr
è((
ušt16_t
)(×ddrè>> 4))

	)

217 
	#_3C515_TX_PHYS_TO_OFFSET
(
addr
è((
ušt16_t
)(×ddrè& 0x0F))

	)

218 
	#_3C515_TX_MAKE_PHYSICAL
(
£g
, 
off
è(((
ušt32_t
)(£gè<< 4è+ (
ušt16_t
)(off))

	)

221 
	#_3C515_TX_FLAG_BUS_MASTER
 0x01

222 
	#_3C515_TX_FLAG_100MBPS
 0x02

223 
	#_3C515_TX_FLAG_FULL_DUPLEX
 0x04

224 
	#_3C515_TX_FLAG_MII_XCVR
 0x08

225 
	#_3C515_TX_FLAG_AUTO_NEG
 0x10

226 

	)

229 
	#_3C515_TX_TX_FIFO
 0x10

230 
	#_3C515_TX_RX_FIFO
 0x10

231 
	#_3C515_TX_RX_STATUS
 0x18

232 
	#_3C515_TX_TX_STATUS
 0x1B

233 
	#_3C515_TX_TX_FREE
 0x1C

234 
	#_3C515_TX_RX_ERRORS
 0x14

235 
	#_3C515_TX_W1_TIMER
 0x1A

236 

	)

238 
	#_3C515_TX_RXSTAT_INCOMPLETE
 0x8000

239 
	#_3C515_TX_RXSTAT_ERROR
 0x4000

240 
	#_3C515_TX_RXSTAT_LEN_MASK
 0x1FFF

241 

	)

243 
	#_3C515_TX_RXERR_OVERRUN
 0x01

	)

244 
	#_3C515_TX_RXERR_LENGTH
 0x02

	)

245 
	#_3C515_TX_RXERR_FRAME
 0x04

	)

246 
	#_3C515_TX_RXERR_CRC
 0x08

	)

247 
	#_3C515_TX_RXERR_DRIBBLE
 0x10

	)

250 
	#_3C515_TX_TXSTAT_COMPLETE
 0x01

251 
	#_3C515_TX_TXSTAT_DEFERRED
 0x02

252 
	#_3C515_TX_TXSTAT_ABORTED
 0x04

253 
	#_3C515_TX_TXSTAT_SCOLL
 0x08

254 
	#_3C515_TX_TXSTAT_MCOLL
 0x10

255 
	#_3C515_TX_TXSTAT_UNDERRUN
 0x20

256 
	#_3C515_TX_TXSTAT_JABBER
 0x40

257 
	#_3C515_TX_TXSTAT_MAXCOLL
 0x80

258 

	)

265 
	#_3C515_TX_W3_CONFIG
 0x00

266 
	#_3C515_TX_W3_MAC_CTRL
 0x06

267 
	#_3C515_TX_W3_OPTIONS
 0x08

268 

	)

270 
	#_3C515_TX_RAM_SIZE
 0x00000007

271 
	#_3C515_TX_RAM_WIDTH
 0x00000008

272 
	#_3C515_TX_RAM_SPEED
 0x00000030

273 
	#_3C515_TX_ROM_SIZE
 0x000000C0

274 
	#_3C515_TX_RAM_SPLIT_SHIFT
 16

275 
	#_3C515_TX_RAM_SPLIT
 (3 << 
_3C515_TX_RAM_SPLIT_SHIFT
)

276 
	#_3C515_TX_XCVR_SHIFT
 20

277 
	#_3C515_TX_XCVR
 (7 << 
_3C515_TX_XCVR_SHIFT
)

278 
	#_3C515_TX_AUTOSELECT
 0x1000000

279 

	)

281 
	#_3C515_TX_FULL_DUPLEX_BIT
 0x20

282 

	)

285 
	#_3C515_TX_W4_NETDIAG
 0x06

286 
	#_3C515_TX_W4_MEDIA
 0x0A

287 
	#_3C515_TX_W4_MII_READ
 0x0800

288 
	#_3C515_TX_W4_MII_WRITE
 0x0A00

289 

	)

291 
	#_3C515_TX_MEDIA_SQE
 0x0008

292 
	#_3C515_TX_MEDIA_10TP
 0x00C0

293 
	#_3C515_TX_MEDIA_LNK
 0x0080

294 
	#_3C515_TX_MEDIA_LNKBEAT
 0x0800

295 

	)

298 
	#_3C515_TX_W6_TX_CARR_ERRS
 0x00

299 
	#_3C515_TX_W6_TX_HRTBT_ERRS
 0x01

300 
	#_3C515_TX_W6_TX_MULT_COLLS
 0x02

301 
	#_3C515_TX_W6_TX_TOT_COLLS
 0x03

302 
	#_3C515_TX_W6_TX_WIN_ERRS
 0x04

303 
	#_3C515_TX_W6_RX_FIFO_ERRS
 0x05

304 
	#_3C515_TX_W6_TX_PACKETS
 0x06

305 
	#_3C515_TX_W6_RX_PACKETS
 0x07

306 
	#_3C515_TX_W6_TX_DEFERRALS
 0x08

307 
	#_3C515_TX_W6_BADSSD
 0x0C

308 

	)

311 
	#_3C515_TX_W7_MASTER_ADDR
 0x00

312 
	#_3C515_TX_W7_MASTER_LEN
 0x06

313 
	#_3C515_TX_W7_MASTER_STATUS
 0x0C

314 

	)

316 
	#_3C515_TX_PKT_STATUS
 0x400

317 
	#_3C515_TX_DOWN_LIST_PTR
 0x404

318 
	#_3C515_TX_UP_LIST_PTR
 0x418

319 
	#_3C515_TX_FRAG_ADDR
 0x408

320 
	#_3C515_TX_FRAG_LEN
 0x40C

321 
	#_3C515_TX_TX_FREE_THRESH
 0x40F

322 
	#_3C515_TX_UP_PKT_STATUS
 0x410

323 

	)

327 
ušt32_t
 
	mÃxt
;

328 
št32_t
 
	m¡©us
;

329 
ušt32_t
 
	maddr
;

330 
št32_t
 
	mËngth
;

331 } 
	t_3c515_tx_rx_desc_t
;

334 
ušt32_t
 
	mÃxt
;

335 
št32_t
 
	m¡©us
;

336 
ušt32_t
 
	maddr
;

337 
št32_t
 
	mËngth
;

338 } 
	t_3c515_tx_tx_desc_t
;

343 
	#_3C515_TX_RX_DESC_COMPLETE
 0x80000000

344 
	#_3C515_TX_RX_DESC_ERROR
 0x40000000

345 
	#_3C515_TX_RX_DESC_LEN_MASK
 0x00001FFF

346 

	)

348 
	#RxDCom¶‘e
 0x00008000

349 
	#RxDE¼Ü
 0x00004000

350 

	)

352 
	#_3C515_TX_TX_DESC_COMPLETE
 0x80000000

353 
	#_3C515_TX_TX_DESC_ERROR
 0x40000000

354 
	#_3C515_TX_TX_DESC_LEN_MASK
 0x00001FFF

355 
	#_3C515_TX_TX_INTR_BIT
 0x20000000

356 

	)

360 
	#_3C515_TX_SELECT_WINDOW
(
io_ba£
, 
wš
) \

361 
	`outw
(
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_SELECT_WINDOW
 | (
wš
))

	)

369 
ušt8_t
 
	mmedŸ_ty³
;

370 
ušt8_t
 
	mdu¶ex_mode
;

371 
ušt8_t
 
	mŒªsûiv”_ty³
;

372 
ušt16_t
 
	mlšk_¥“d
;

373 
ušt8_t
 
	mlšk_aùive
;

374 
ušt8_t
 
	mauto_ÃgÙŸtiÚ
;

375 
ušt16_t
 
	madv”ti£d_modes
;

376 } 
	tmedŸ_cÚfig_t
;

383 
ušt16_t
 
	mio_ba£
;

384 
ušt8_t
 
	mœq
;

387 
_3c515_tx_tx_desc_t
 *
	mtx_desc_ršg
;

388 
_3c515_tx_rx_desc_t
 *
	mrx_desc_ršg
;

389 
ušt32_t
 
	mtx_šdex
;

390 
ušt32_t
 
	mrx_šdex
;

391 
ušt8_t
 *
	mbufãrs
;

394 
“´om_cÚfig_t
 
	m“´om_cÚfig
;

395 
medŸ_cÚfig_t
 
	mmedŸ_cÚfig
;

398 
ušt8_t
 
	mh¬dw¬e_»ady
;

399 
ušt8_t
 
	mdriv”_aùive
;

400 
ušt32_t
 
	mÏ¡_cÚfig_v®id©iÚ
;

401 
ušt32_t
 
	mÏ¡_¡©s_upd©e
;

402 
ušt32_t
 
	mÏ¡_lšk_check
;

405 
ušt32_t
 
	mtx_·ck‘s
;

406 
ušt32_t
 
	mrx_·ck‘s
;

407 
ušt32_t
 
	mtx_by‹s
;

408 
ušt32_t
 
	mrx_by‹s
;

409 
ušt32_t
 
	mtx_”rÜs
;

410 
ušt32_t
 
	mrx_”rÜs
;

411 
ušt32_t
 
	mlšk_chªges
;

412 
ušt32_t
 
	mcÚfig_”rÜs
;

415 
ušt16_t
 
	mš‹¼u±_mask
;

416 
ušt8_t
 
	mfuÎ_du¶ex_’abËd
;

417 
ušt8_t
 
	mdma_’abËd
;

418 
ušt8_t
 
	m¡©s_’abËd
;

419 
ušt8_t
 
	mlšk_mÚ™Üšg_’abËd
;

422 *
	m”rÜ_cÚ‹xt
;

423 } 
	tnic_cÚ‹xt_t
;

437 
com¶‘e_3c515_š™Ÿliz©iÚ
(
nic_cÚ‹xt_t
 *
ùx
);

445 
_3c515_’hªûd_š™
(
ušt16_t
 
io_ba£
, 
ušt8_t
 
œq
, ušt8_ˆ
nic_šdex
);

450 
_3c515_’hªûd_ş—nup
();

462 
_3c515_’hªûd_£nd_·ck‘_sg
(cÚ¡ 
ušt8_t
 *
·ck‘_d©a
, 
ušt16_t
 
·ck‘_Ën
,

463 
dma_äagm’t_t
 *
äagm’ts
, 
ušt16_t
 
äag_couÁ
);

474 
_3c515_’hªûd_ü—‹_äagm’ts
(cÚ¡ 
ušt8_t
 *
·ck‘_d©a
, 
ušt16_t
 
·ck‘_Ën
,

475 
dma_äagm’t_t
 *
äagm’ts
, 
ušt16_t
 
max_äagm’ts
,

476 
ušt16_t
 
äagm’t_size
);

482 
_3c515_’hªûd_‹¡_sÿ‰”_g©h”
();

489 
³riodic_cÚfigu¿tiÚ_v®id©iÚ
(
nic_cÚ‹xt_t
 *
ùx
);

495 
nic_cÚ‹xt_t
 *
g‘_3c515_cÚ‹xt
();

504 
g‘_h¬dw¬e_cÚfig_šfo
(
nic_cÚ‹xt_t
 *
ùx
, *
bufãr
, 
size_t
 
bufãr_size
);

513 
»ad_ªd_·r£_“´om
(
nic_cÚ‹xt_t
 *
ùx
);

521 
cÚfigu»_medŸ_ty³
(
nic_cÚ‹xt_t
 *
ùx
, 
medŸ_cÚfig_t
 *
medŸ
);

528 
cÚfigu»_fuÎ_du¶ex
(
nic_cÚ‹xt_t
 *
ùx
);

535 
£tup_š‹¼u±_mask
(
nic_cÚ‹xt_t
 *
ùx
);

542 
cÚfigu»_bus_ma¡”_dma
(
nic_cÚ‹xt_t
 *
ùx
);

549 
’abË_h¬dw¬e_¡©i¡ics
(
nic_cÚ‹xt_t
 *
ùx
);

556 
£tup_lšk_mÚ™Üšg
(
nic_cÚ‹xt_t
 *
ùx
);

563 
v®id©e_h¬dw¬e_cÚfigu¿tiÚ
(
nic_cÚ‹xt_t
 *
ùx
);

570 
»£t_nic_h¬dw¬e
(
nic_cÚ‹xt_t
 *
ùx
);

575 
	#DUPLEX_HALF
 0

	)

576 
	#DUPLEX_FULL
 1

	)

577 
	#DUPLEX_AUTO
 2

	)

580 
	#SPEED_10MBPS
 10

	)

581 
	#SPEED_100MBPS
 100

	)

582 
	#SPEED_AUTO
 0

	)

585 
	#RESET_TIMEOUT_MS
 1000

	)

586 
	#CONFIG_STABILIZATION_MS
 100

	)

587 
	#LINK_CHECK_INTERVAL_MS
 500

	)

588 
	#STATS_UPDATE_INTERVAL_MS
 1000

	)

589 
	#CONFIG_VALIDATION_INTERVAL_MS
 5000

	)

	@/Users/jvindahl/Development/3com-packet-driver/include/config.h

11 #iâdeà
_CONFIG_H_


12 
	#_CONFIG_H_


	)

14 #ifdeà
__ılu¥lus


19 
	~"commÚ.h
"

22 
busma¡”_‹¡_»suÉs
 
	tbusma¡”_‹¡_»suÉs_t
;

23 
nic_cÚ‹xt
 
	tnic_cÚ‹xt_t
;

26 
	#CONFIG_SUCCESS
 0

	)

27 
	#CONFIG_ERR_INVALID_PARAM
 -1

	)

28 
	#CONFIG_ERR_INVALID_VALUE
 -2

	)

29 
	#CONFIG_ERR_MEMORY
 -3

	)

30 
	#CONFIG_ERR_IO_CONFLICT
 -4

	)

31 
	#CONFIG_ERR_IRQ_CONFLICT
 -5

	)

32 
	#CONFIG_ERR_CPU_REQUIRED
 -6

	)

33 
	#CONFIG_ERR_ROUTE_SYNTAX
 -7

	)

34 
	#CONFIG_ERR_TOO_MANY_ROUTES
 -8

	)

35 
	#CONFIG_ERR_INVALID_SPEED
 -9

	)

36 
	#CONFIG_ERR_INVALID_IO_RANGE
 -10

	)

37 
	#CONFIG_ERR_INVALID_IRQ_RANGE
 -11

	)

41 
SPEED_AUTO
 = 0,

42 
SPEED_10
 = 10,

43 
SPEED_100
 = 100

44 } 
	tÃtwÜk_¥“d_t
;

48 
BUSMASTER_OFF
 = 0,

49 
BUSMASTER_ON
 = 1,

50 
BUSMASTER_AUTO
 = 2

51 } 
	tbusma¡”_mode_t
;

55 
ušt32_t
 
ÃtwÜk
;

56 
ušt32_t
 
Ãtmask
;

57 
ušt8_t
 
nic_id
;

58 
boŞ
 
aùive
;

59 } 
	trou‹_’Œy_t
;

61 
	#MAX_ROUTES
 16

	)

66 
debug_Ëv–
;

67 
u£_xms
;

68 
’abË_routšg
;

69 
’abË_¡©ic_routšg
;

70 
bufãr_couÁ
;

71 
bufãr_size
;

72 
ušt8_t
 
š‹¼u±_veùÜ
;

73 
ušt16_t
 
io_ba£
;

74 
ušt8_t
 
œq
;

75 
’abË_¡©s
;

76 
´omiscuous_mode
;

77 
’abË_loggšg
;

78 
‹¡_mode
;

83 
ušt16_t
 
ov”ride_bufãr_size
;

84 
ušt8_t
 
ov”ride_tx_ršg_couÁ
;

85 
ušt8_t
 
ov”ride_rx_ršg_couÁ
;

86 
ušt8_t
 
fÜû_pio_mode
;

87 
ušt8_t
 
fÜû_mšim®_bufãrs
;

88 
ušt8_t
 
fÜû_İtim®_bufãrs
;

91 
ušt16_t
 
io1_ba£
;

92 
ušt16_t
 
io2_ba£
;

93 
ušt8_t
 
œq1
;

94 
ušt8_t
 
œq2
;

95 
ÃtwÜk_¥“d_t
 
¥“d
;

96 
busma¡”_mode_t
 
busma¡”
;

97 
boŞ
 
log_’abËd
;

98 
rou‹_’Œy_t
 
rou‹s
[
MAX_ROUTES
];

99 
ušt8_t
 
rou‹_couÁ
;

102 
ušt8_t
 
mac_add»ss
[
ETH_ALEN
];

103 
boŞ
 
u£_cu¡om_mac
;

104 
ušt16_t
 
mtu
;

105 
ušt8_t
 
»ûive_mode
;

106 
ušt16_t
 
tx_timeout
;

107 
ušt16_t
 
rx_bufãr_couÁ
;

108 
ušt16_t
 
tx_bufãr_couÁ
;

109 
ušt8_t
 
tx_th»shŞd
;

110 
ušt8_t
 
rx_th»shŞd
;

111 
boŞ
 
auto_d‘eù
;

112 
boŞ
 
lßd_b®ªcšg
;

113 
boŞ
 
·ck‘_routšg
;

114 
boŞ
 
¡©i¡ics_’abËd
;

115 
ušt8_t
 
log_Ëv–
;

116 
ušt16_t
 
»sid’t_size
;

117 
boŞ
 
š¡®l_t¤
;

118 
boŞ
 
’abË_muÉiÿ¡
;

119 
boŞ
 
’abË_brßdÿ¡
;

120 
boŞ
 
’abË_fuÎ_du¶ex
;

121 
boŞ
 
’abË_æow_cÚŒŞ
;

122 
boŞ
 
’abË_checksums
;

123 
ušt16_t
 
lšk_check_š‹rv®
;

124 
ušt16_t
 
¡©i¡ics_š‹rv®
;

125 
ušt16_t
 
w©chdog_timeout
;

126 
boŞ
 
debug_’abËd
;

127 
ušt32_t
 
debug_æags
;

128 
debug_ouut
[32];

129 
boŞ
 
v”bo£_mode
;

130 
cÚfig_fe
[128];

131 
boŞ
 
§ve_Ú_ex™
;

132 
boŞ
 
lßd_deçuÉs
;

133 } 
	tcÚfig_t
;

136 
	#CONFIG_DEFAULT_MTU
 1514

	)

137 
	#CONFIG_DEFAULT_RX_BUFFERS
 16

	)

138 
	#CONFIG_DEFAULT_TX_BUFFERS
 8

	)

139 
	#CONFIG_DEFAULT_BUFFER_SIZE
 1600

	)

140 
	#CONFIG_DEFAULT_TX_TIMEOUT
 1000

	)

141 
	#CONFIG_DEFAULT_LOG_LEVEL
 
LOG_LEVEL_INFO


	)

142 
	#CONFIG_DEFAULT_TSR_SIZE
 64

	)

143 
	#CONFIG_DEFAULT_INTERRUPT
 0x60

	)

144 
	#CONFIG_DEFAULT_LINK_CHECK
 1000

	)

145 
	#CONFIG_DEFAULT_STATS_INTERVAL
 5000

	)

146 
	#CONFIG_DEFAULT_WATCHDOG
 10000

	)

149 
	#CONFIG_DEFAULT_IO1_BASE
 0x300

	)

150 
	#CONFIG_DEFAULT_IO2_BASE
 0x320

	)

151 
	#CONFIG_DEFAULT_IRQ1
 5

	)

152 
	#CONFIG_DEFAULT_IRQ2
 10

	)

153 
	#CONFIG_DEFAULT_SPEED
 
SPEED_AUTO


	)

154 
	#CONFIG_DEFAULT_BUSMASTER
 
BUSMASTER_AUTO


	)

155 
	#CONFIG_DEFAULT_LOG_ENABLED
 
Œue


	)

158 
	#CONFIG_MIN_IO_BASE
 0x200

	)

159 
	#CONFIG_MAX_IO_BASE
 0x3F0

	)

160 
	#CONFIG_IO_RANGE_SIZE
 0x20

	)

163 
	#CONFIG_VALID_IRQS
 0x9EA8

	)

166 
boŞ
 
cÚfig_is_v®id_io_add»ss
(
ušt16_t
 
io_ba£
);

167 
boŞ
 
cÚfig_is_v®id_œq_numb”
(
ušt8_t
 
œq
);

168 
boŞ
 
cÚfig_check_io_cÚæiù
(
ušt16_t
 
io1
, ušt16_ˆ
io2
);

169 
boŞ
 
cÚfig_check_œq_cÚæiù
(
ušt8_t
 
œq1
, ušt8_ˆ
œq2
);

170 
boŞ
 
cÚfig_ıu_suµÜts_busma¡”
();

171 
cÚfig_·r£_rou‹_’Œy
(cÚ¡ * 
rou‹_¡r
, 
rou‹_’Œy_t
* 
rou‹
);

172 
cÚfig_v®id©e_üoss_·¿m‘”s
(cÚ¡ 
cÚfig_t
* 
cÚfig
);

175 
cÚfig_³rfÜm_busma¡”_auto_‹¡
(
cÚfig_t
 *
cÚfig
, 
nic_cÚ‹xt_t
 *
ùx
, 
boŞ
 
quick_mode
);

176 
­¶y_busma¡”_cÚfigu¿tiÚ
(
nic_cÚ‹xt_t
 *
ùx
,

177 cÚ¡ 
busma¡”_‹¡_»suÉs_t
 *
»suÉs
,

178 
cÚfig_t
 *
cÚfig
);

179 
g’”©e_busma¡”_‹¡_»pÜt
(cÚ¡ 
busma¡”_‹¡_»suÉs_t
 *
»suÉs
,

180 *
bufãr
, 
size_t
 
bufãr_size
);

183 
cÚfig_t
 
g_cÚfig
;

184 
boŞ
 
g_cÚfig_lßded
;

187 
cÚfig_·r£_·¿ms
(cÚ¡ *
·¿ms
, 
cÚfig_t
 *
cÚfig
);

188 
cÚfig_v®id©e
(cÚ¡ 
cÚfig_t
 *
cÚfig
);

189 
cÚfig_g‘_deçuÉs
(
cÚfig_t
 *
cÚfig
);

190 
cÚfig_´št
(cÚ¡ 
cÚfig_t
 *
cÚfig
, 
Ëv–
);

193 
cÚfig_š™
();

194 
cÚfig_ş—nup
();

195 
cÚfig_£t_deçuÉs
(
cÚfig_t
 *
cÚfig
);

196 
cÚfig_lßd_fe
(cÚ¡ *
f’ame
, 
cÚfig_t
 *
cÚfig
);

197 
cÚfig_§ve_fe
(cÚ¡ *
f’ame
, cÚ¡ 
cÚfig_t
 *
cÚfig
);

198 
cÚfig_·r£_commªd_lše
(
¬gc
, *
¬gv
[], 
cÚfig_t
 *
cÚfig
);

199 
cÚfig_·r£_·¿m‘”
(cÚ¡ *
·¿m
, cÚ¡ *
v®ue
, 
cÚfig_t
 *
cÚfig
);

200 
cÚfig_´št_u§ge
(cÚ¡ *
´og¿m_Çme
);

201 
cÚfig_´št_h–p
();

202 
cÚfig_£t_¡ršg
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

203 
cÚfig_£t_št
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
Çme
, 
v®ue
);

204 
cÚfig_£t_boŞ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
Çme
, 
boŞ
 
v®ue
);

205 cÚ¡ * 
cÚfig_g‘_¡ršg
(cÚ¡ 
cÚfig_t
 *
cÚfig
, cÚ¡ *
Çme
);

206 
cÚfig_g‘_št
(cÚ¡ 
cÚfig_t
 *
cÚfig
, cÚ¡ *
Çme
);

207 
boŞ
 
cÚfig_g‘_boŞ
(cÚ¡ 
cÚfig_t
 *
cÚfig
, cÚ¡ *
Çme
);

208 
cÚfig_d‘eù_h¬dw¬e
(
cÚfig_t
 *
cÚfig
);

209 
cÚfig_v®id©e_h¬dw¬e
(cÚ¡ 
cÚfig_t
 *
cÚfig
);

210 
cÚfig_­¶y_h¬dw¬e_£‰šgs
(cÚ¡ 
cÚfig_t
 *
cÚfig
);

211 
boŞ
 
cÚfig_is_v®id_io_ba£
(
ušt16_t
 
io_ba£
);

212 
boŞ
 
cÚfig_is_v®id_œq
(
ušt8_t
 
œq
);

213 
boŞ
 
cÚfig_is_v®id_mac
(cÚ¡ 
ušt8_t
 *
mac
);

214 
cÚfig_·r£_mac_add»ss
(cÚ¡ *
mac_¡r
, 
ušt8_t
 *
mac
);

215 
cÚfig_fÜm©_mac_add»ss
(cÚ¡ 
ušt8_t
 *
mac
, *
mac_¡r
, 
size_t
 
size
);

216 
cÚfig_´št_cu¼’t
();

217 
cÚfig_´št_deçuÉs
();

219 #ifdeà
__ılu¥lus


	@/Users/jvindahl/Development/3com-packet-driver/include/hardware.h

11 #iâdeà
_HARDWARE_H_


12 
	#_HARDWARE_H_


	)

14 #ifdeà
__ılu¥lus


19 
	~"commÚ.h
"

20 
	~"”rÜ_hªdlšg.h
"

23 
nic_šfo
;

24 
nic_İs
;

28 
NIC_TYPE_UNKNOWN
 = 0,

29 
NIC_TYPE_3C509B
,

30 
NIC_TYPE_3C515_TX


31 } 
	tnic_ty³_t
;

34 
	#NIC_STATUS_PRESENT
 
	`BIT
(0è

	)

35 
	#NIC_STATUS_INITIALIZED
 
	`BIT
(1è

	)

36 
	#NIC_STATUS_ACTIVE
 
	`BIT
(2è

	)

37 
	#NIC_STATUS_ERROR
 
	`BIT
(3è

	)

38 
	#NIC_STATUS_LINK_UP
 
	`BIT
(4è

	)

39 
	#NIC_STATUS_FULL_DUPLEX
 
	`BIT
(5è

	)

40 
	#NIC_STATUS_100MBPS
 
	`BIT
(6è

	)

41 
	#NIC_STATUS_PROMISCUOUS
 
	`BIT
(7è

	)

44 
	#HW_CAP_DMA
 
	`BIT
(0è

	)

45 
	#HW_CAP_BUS_MASTER
 
	`BIT
(1è

	)

46 
	#HW_CAP_MULTICAST
 
	`BIT
(2è

	)

47 
	#HW_CAP_PROMISCUOUS
 
	`BIT
(3è

	)

48 
	#HW_CAP_FULL_DUPLEX
 
	`BIT
(4è

	)

49 
	#HW_CAP_AUTO_SPEED
 
	`BIT
(5è

	)

50 
	#HW_CAP_WAKE_ON_LAN
 
	`BIT
(6è

	)

51 
	#HW_CAP_CHECKSUM_OFFLOAD
 
	`BIT
(7è

	)

70 
	snic_İs
 {

72 (*
š™
)(
nic_šfo
 *
nic
);

73 (*
ş—nup
)(
nic_šfo
 *
nic
);

74 (*
»£t
)(
nic_šfo
 *
nic
);

75 (*
£lf_‹¡
)(
nic_šfo
 *
nic
);

78 (*
£nd_·ck‘
)(
nic_šfo
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ën
);

79 (*
»ûive_·ck‘
)(
nic_šfo
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ën
);

80 (*
check_tx_com¶‘e
)(
nic_šfo
 *
nic
);

81 (*
check_rx_avaabË
)(
nic_šfo
 *
nic
);

84 (*
hªdË_š‹¼u±
)(
nic_šfo
 *
nic
);

85 (*
check_š‹¼u±
)(
nic_šfo
 *
nic
);

86 (*
’abË_š‹¼u±s
)(
nic_šfo
 *
nic
);

87 (*
di§bË_š‹¼u±s
)(
nic_šfo
 *
nic
);

90 (*
£t_mac_add»ss
)(
nic_šfo
 *
nic
, cÚ¡ 
ušt8_t
 *
mac
);

91 (*
g‘_mac_add»ss
)(
nic_šfo
 *
nic
, 
ušt8_t
 *
mac
);

92 (*
£t_´omiscuous
)(
nic_šfo
 *
nic
, 
boŞ
 
’abË
);

93 (*
£t_muÉiÿ¡
)(
nic_šfo
 *
nic
, cÚ¡ 
ušt8_t
 *
addrs
, 
couÁ
);

94 (*
£t_»ûive_mode
)(
nic_šfo
 *
nic
, 
ušt8_t
 
mode
);

97 (*
g‘_lšk_¡©us
)(
nic_šfo
 *
nic
);

98 (*
g‘_¡©i¡ics
)(
nic_šfo
 *
nic
, *
¡©s
);

99 (*
ş—r_¡©i¡ics
)(
nic_šfo
 *
nic
);

102 (*
su¥’d
)(
nic_šfo
 *
nic
);

103 (*
»sume
)(
nic_šfo
 *
nic
);

104 (*
£t_pow”_¡©e
)(
nic_šfo
 *
nic
, 
¡©e
);

107 (*
£t_¥“d_du¶ex
)(
nic_šfo
 *
nic
, 
¥“d
, 
boŞ
 
fuÎ_du¶ex
);

108 (*
g‘_¥“d_du¶ex
)(
nic_šfo
 *
nic
, *
¥“d
, 
boŞ
 *
fuÎ_du¶ex
);

109 (*
£t_æow_cÚŒŞ
)(
nic_šfo
 *
nic
, 
boŞ
 
’abË
);

112 (*
hªdË_”rÜ
)(
nic_šfo
 *
nic
, 
ušt32_t
 
”rÜ_¡©us
);

113 (*
»cov”_äom_”rÜ
)(
nic_šfo
 *
nic
, 
ušt8_t
 
”rÜ_ty³
);

114 (*
v®id©e_»cov”y
)(
nic_šfo
 *
nic
);

115 } 
	tnic_İs_t
;

118 
	snic_šfo
 {

120 
nic_ty³_t
 
ty³
;

121 
nic_İs_t
 *
İs
;

122 
ušt8_t
 
šdex
;

123 
ušt32_t
 
¡©us
;

124 
ušt32_t
 
ÿ·b™›s
;

127 
ušt16_t
 
io_ba£
;

128 
ušt16_t
 
io_¿nge
;

129 
ušt32_t
 
mem_ba£
;

130 
ušt32_t
 
mem_size
;

131 
ušt8_t
 
œq
;

132 
ušt8_t
 
dma_chªÃl
;

135 
ušt8_t
 
mac
[
ETH_ALEN
];

136 
ušt8_t
 
³rm_mac
[
ETH_ALEN
];

137 
ušt16_t
 
mtu
;

138 
ušt8_t
 
»ûive_mode
;

141 
ušt16_t
 
tx_timeout
;

142 
ušt16_t
 
rx_bufãr_size
;

143 
ušt16_t
 
tx_bufãr_size
;

144 
ušt8_t
 
tx_fifo_th»shŞd
;

145 
ušt8_t
 
rx_fifo_th»shŞd
;

148 *
´iv©e_d©a
;

149 
ušt32_t
 
´iv©e_d©a_size
;

150 
ušt8_t
 
cu¼’t_wšdow
;

153 
ušt32_t
 
tx_·ck‘s
;

154 
ušt32_t
 
rx_·ck‘s
;

155 
ušt32_t
 
tx_by‹s
;

156 
ušt32_t
 
rx_by‹s
;

157 
ušt32_t
 
tx_”rÜs
;

158 
ušt32_t
 
rx_”rÜs
;

159 
ušt32_t
 
tx_drİ³d
;

160 
ušt32_t
 
rx_drİ³d
;

161 
ušt32_t
 
š‹¼u±s
;

164 
boŞ
 
lšk_up
;

165 
¥“d
;

166 
boŞ
 
fuÎ_du¶ex
;

167 
boŞ
 
autÚeg
;

170 
ušt32_t
 
Ï¡_”rÜ
;

171 
ušt32_t
 
”rÜ_couÁ
;

174 
nic_cÚ‹xt_t
 *
”rÜ_cÚ‹xt
;

177 
ušt8_t
 
muÉiÿ¡_couÁ
;

178 
ušt8_t
 
muÉiÿ¡_li¡
[16][
ETH_ALEN
];

179 } 
	tnic_šfo_t
;

182 
pci_deviû_šfo
;

183 
i§_deviû_šfo
;

186 
nic_šfo_t
 
g_nics
[
MAX_NICS
];

187 
g_num_nics
;

188 
boŞ
 
g_h¬dw¬e_š™Ÿlized
;

191 
h¬dw¬e_š™
();

192 
h¬dw¬e_ş—nup
();

193 
h¬dw¬e_d‘eù_®l
();

194 
h¬dw¬e_’um”©e_nics
(
nic_šfo_t
 *
nics
, 
max_nics
);

197 
nic_šfo_t
* 
h¬dw¬e_g‘_nic
(
šdex
);

198 
h¬dw¬e_g‘_nic_couÁ
();

199 
nic_šfo_t
* 
h¬dw¬e_fšd_nic_by_ty³
(
nic_ty³_t
 
ty³
);

200 
nic_šfo_t
* 
h¬dw¬e_fšd_nic_by_mac
(cÚ¡ 
ušt8_t
 *
mac
);

203 
h¬dw¬e_š™_nic
(
nic_šfo_t
 *
nic
);

204 
h¬dw¬e_ş—nup_nic
(
nic_šfo_t
 *
nic
);

205 
h¬dw¬e_»£t_nic
(
nic_šfo_t
 *
nic
);

206 
h¬dw¬e_‹¡_nic
(
nic_šfo_t
 *
nic
);

209 
h¬dw¬e_£nd_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ën
);

210 
h¬dw¬e_»ûive_·ck‘
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ën
);

211 
h¬dw¬e_check_tx_com¶‘e
(
nic_šfo_t
 *
nic
);

212 
h¬dw¬e_check_rx_avaabË
(
nic_šfo_t
 *
nic
);

215 
h¬dw¬e_š‹¼u±_hªdËr
();

216 
h¬dw¬e_hªdË_nic_š‹¼u±
(
nic_šfo_t
 *
nic
);

217 
h¬dw¬e_check_š‹¼u±_sourû
();

218 
h¬dw¬e_’abË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

219 
h¬dw¬e_di§bË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

222 
h¬dw¬e_£t_mac_add»ss
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
mac
);

223 
h¬dw¬e_g‘_mac_add»ss
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
mac
);

224 
h¬dw¬e_£t_´omiscuous_mode
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË
);

225 
h¬dw¬e_£t_muÉiÿ¡_li¡
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
addrs
, 
couÁ
);

226 
h¬dw¬e_£t_»ûive_mode
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
mode
);

229 
h¬dw¬e_g‘_lšk_¡©us
(
nic_šfo_t
 *
nic
);

230 
h¬dw¬e_g‘_nic_¡©i¡ics
(
nic_šfo_t
 *
nic
, *
¡©s
);

231 
h¬dw¬e_ş—r_nic_¡©i¡ics
(
nic_šfo_t
 *
nic
);

232 
h¬dw¬e_´št_nic_šfo
(cÚ¡ 
nic_šfo_t
 *
nic
);

233 
h¬dw¬e_dump_»gi¡”s
(cÚ¡ 
nic_šfo_t
 *
nic
);

236 
nic_İs_t
* 
g‘_3c509b_İs
();

237 
nic_İs_t
* 
g‘_3c515_İs
();

238 
nic_İs_t
* 
g‘_nic_İs
(
nic_ty³_t
 
ty³
);

241 cÚ¡ * 
nic_ty³_to_¡ršg
(
nic_ty³_t
 
ty³
);

242 cÚ¡ * 
nic_¡©us_to_¡ršg
(
ušt32_t
 
¡©us
);

243 
boŞ
 
h¬dw¬e_is_nic_´e£Á
(
šdex
);

244 
boŞ
 
h¬dw¬e_is_nic_aùive
(
šdex
);

247 
h¬dw¬e_su¥’d_nic
(
nic_šfo_t
 *
nic
);

248 
h¬dw¬e_»sume_nic
(
nic_šfo_t
 *
nic
);

249 
h¬dw¬e_£t_pow”_¡©e
(
nic_šfo_t
 *
nic
, 
¡©e
);

252 
h¬dw¬e_£t_¥“d_du¶ex
(
nic_šfo_t
 *
nic
, 
¥“d
, 
boŞ
 
fuÎ_du¶ex
);

253 
h¬dw¬e_g‘_¥“d_du¶ex
(
nic_šfo_t
 *
nic
, *
¥“d
, 
boŞ
 *
fuÎ_du¶ex
);

254 
h¬dw¬e_£t_æow_cÚŒŞ
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË
);

257 
h¬dw¬e_‹¡_cÚcu¼’t_İ”©iÚs
(
ušt32_t
 
‹¡_du¿tiÚ_ms
);

258 
h¬dw¬e_‹¡_lßd_b®ªcšg
(
ušt32_t
 
num_·ck‘s
);

259 
h¬dw¬e_‹¡_çov”
(
´im¬y_nic
);

260 
h¬dw¬e_‹¡_»sourû_cÚ‹ÁiÚ
(
ušt32_t
 
num_™”©iÚs
);

261 
h¬dw¬e_‹¡_muÉi_nic_³rfÜmªû
(
ušt32_t
 
‹¡_du¿tiÚ_ms
);

262 
h¬dw¬e_run_muÉi_nic_‹¡s
();

265 
h¬dw¬e_š™_”rÜ_hªdlšg
();

266 
h¬dw¬e_ş—nup_”rÜ_hªdlšg
();

267 
h¬dw¬e_ü—‹_”rÜ_cÚ‹xt
(
nic_šfo_t
 *
nic
);

268 
h¬dw¬e_de¡roy_”rÜ_cÚ‹xt
(
nic_šfo_t
 *
nic
);

271 
h¬dw¬e_hªdË_rx_”rÜ
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
rx_¡©us
);

272 
h¬dw¬e_hªdË_tx_”rÜ
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
tx_¡©us
);

273 
h¬dw¬e_hªdË_ad­‹r_”rÜ
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
çu»_ty³
);

274 
h¬dw¬e_©‹m±_»cov”y
(
nic_šfo_t
 *
nic
);

277 
h¬dw¬e_´št_”rÜ_¡©i¡ics
(
nic_šfo_t
 *
nic
);

278 
h¬dw¬e_´št_glob®_”rÜ_summ¬y
();

279 
h¬dw¬e_g‘_sy¡em_h—Éh_¡©us
();

280 
h¬dw¬e_expÜt_”rÜ_log
(*
bufãr
, 
size_t
 
bufãr_size
);

283 
h¬dw¬e_cÚfigu»_”rÜ_th»shŞds
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
max_”rÜ_¿‹
,

284 
ušt32_t
 
max_cÚ£cutive
, ušt32_ˆ
»cov”y_timeout
);

289 
h¬dw¬e_£nd_·ck‘_bufã»d
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
);

290 
h¬dw¬e_»ûive_·ck‘_bufã»d
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
ušt16_t
 *
Ëngth
);

293 
h¬dw¬e_g‘_nic_bufãr_¡©s
(
nic_šdex
, 
bufãr_poŞ_¡©s_t
* 
¡©s
);

294 
h¬dw¬e_»b®ªû_bufãr_»sourûs
();

297 
h¬dw¬e_´št_com´eh’sive_¡©s
();

298 
h¬dw¬e_mÚ™Ü_ªd_mašš
();

301 
	#MAX_NICS
 8

	)

302 
	#NIC_RESET_TIMEOUT
 1000

	)

303 
	#NIC_INIT_TIMEOUT
 5000

	)

304 
	#LINK_CHECK_INTERVAL
 1000

	)

307 
	#S–eùWšdow
 0x0800

	)

308 
	#AckIÁr
 0x6800

	)

309 
	#RxDisÿrd
 0x4000

	)

310 
	#TxCom¶‘e
 0x0004

	)

311 
	#RxCom¶‘e
 0x0010

	)

314 
	#EL3_CMD
 0x0E

	)

315 
	#EL3_STATUS
 0x0E

	)

318 
	#EL3WINDOW
(
nic
, 
wš
) do { \

319 
	`outw
(
S–eùWšdow
 | (
wš
), (
nic
)->
io_ba£
 + 
EL3_CMD
); \

320 (
nic
)->
cu¼’t_wšdow
 = (
wš
); \

321 } 0)

	)

324 
is_mÿ_sy¡em
();

325 
is_ei§_sy¡em
();

326 
is_vlb_sy¡em
();

327 
g‘_ps2_mod–
();

330 
nic_d‘eù_mÿ_3c523
();

331 
nic_d‘eù_mÿ_3c529
();

332 
nic_d‘eù_ei§_3c592
();

333 
nic_d‘eù_ei§_3c597
();

334 
nic_d‘eù_ei§_3c509b
();

335 
nic_d‘eù_vlb
();

337 #ifdeà
__ılu¥lus


342 
ušt32_t
 
h¬dw¬e_g‘_Ï¡_”rÜ_time
(
ušt8_t
 
nic_šdex
);

	@/Users/jvindahl/Development/3com-packet-driver/include/packet_api.h

14 #iâdeà
_PACKET_API_H_


15 
	#_PACKET_API_H_


	)

17 #ifdeà
__ılu¥lus


22 
	~"commÚ.h
"

25 
	#PACKET_DRIVER_VERSION
 0x0100

	)

26 
	#PACKET_DRIVER_CLASS
 1

	)

27 
	#PACKET_DRIVER_TYPE
 1

	)

30 
	#PACKET_DRIVER_INFO
 1

	)

31 
	#PACKET_ACCESS_TYPE
 2

	)

32 
	#PACKET_RELEASE_TYPE
 3

	)

33 
	#PACKET_SEND_PKT
 4

	)

34 
	#PACKET_TERMINATE
 5

	)

35 
	#PACKET_GET_ADDRESS
 6

	)

36 
	#PACKET_RESET_INTERFACE
 7

	)

37 
	#PACKET_GET_PARAMETERS
 8

	)

38 
	#PACKET_AS_SEND_PKT
 9

	)

39 
	#PACKET_SET_RCV_MODE
 10

	)

40 
	#PACKET_GET_RCV_MODE
 11

	)

41 
	#PACKET_SET_MULTICAST
 12

	)

42 
	#PACKET_GET_MULTICAST
 13

	)

43 
	#PACKET_GET_STATISTICS
 14

	)

44 
	#PACKET_SET_ADDRESS
 15

	)

47 
	#PACKET_NO_ERROR
 0

	)

48 
	#PACKET_BAD_HANDLE
 1

	)

49 
	#PACKET_NO_CLASS
 2

	)

50 
	#PACKET_NO_TYPE
 3

	)

51 
	#PACKET_NO_NUMBER
 4

	)

52 
	#PACKET_BAD_TYPE
 5

	)

53 
	#PACKET_NO_MULTICAST
 6

	)

54 
	#PACKET_CANT_TERMINATE
 7

	)

55 
	#PACKET_BAD_MODE
 8

	)

56 
	#PACKET_NO_SPACE
 9

	)

57 
	#PACKET_TYPE_INUSE
 10

	)

58 
	#PACKET_BAD_COMMAND
 11

	)

59 
	#PACKET_CANT_SEND
 12

	)

60 
	#PACKET_CANT_SET
 13

	)

61 
	#PACKET_BAD_ADDRESS
 14

	)

62 
	#PACKET_CANT_RESET
 15

	)

64 \
n
#defš
	#RCV_MODE_OFF
 0

	)

65 
	#RCV_MODE_DIRECT
 1

	)

66 
	#RCV_MODE_BROADCAST
 2

	)

67 
	#RCV_MODE_MULTICAST
 3

	)

68 
	#RCV_MODE_PROMISCUOUS
 4

	)

69 
	#RCV_MODE_ALL_MULTICAST
 5

	)

72 
	#PACKET_TYPE_IP
 0x0800

	)

73 
	#PACKET_TYPE_ARP
 0x0806

	)

74 
	#PACKET_TYPE_RARP
 0x8035

	)

75 
	#PACKET_TYPE_IPX
 0x8137

	)

76 
	#PACKET_TYPE_ALL
 0xFFFF

	)

79 
	#MAX_HANDLES
 16

	)

80 
	#INVALID_HANDLE
 0xFFFF

	)

84 
ušt8_t
 
v”siÚ
;

85 
ušt8_t
 
şass
;

86 
ušt16_t
 
ty³
;

87 
ušt8_t
 
numb”
;

88 
ušt8_t
 
basic
;

89 
ušt16_t
 
ex‹nded
;

90 
Çme
[15];

91 } 
	tPACKED
 
	tdriv”_šfo_t
;

95 
ušt8_t
 
Ëngth
;

96 
ušt8_t
 
addr_Ën
;

97 
ušt8_t
 
h—d”_Ën
;

98 
ušt16_t
 
»cv_bufs
;

99 
ušt16_t
 
»cv_buf_Ën
;

100 
ušt16_t
 
£nd_bufs
;

101 
ušt16_t
 
£nd_buf_Ën
;

102 } 
	tPACKED
 
	tš‹rçû_·¿ms_t
;

106 
ušt32_t
 
·ck‘s_š
;

107 
ušt32_t
 
·ck‘s_out
;

108 
ušt32_t
 
by‹s_š
;

109 
ušt32_t
 
by‹s_out
;

110 
ušt32_t
 
”rÜs_š
;

111 
ušt32_t
 
”rÜs_out
;

112 
ušt32_t
 
·ck‘s_drİ³d
;

113 } 
	tPACKED
 
	t¡©i¡ics_t
;

116 
	s·ck‘_hªdË
 {

117 
ušt16_t
 
hªdË
;

118 
ušt16_t
 
·ck‘_ty³
;

119 
ušt8_t
 
»cv_mode
;

120 (*
»ûiv”
)();

121 
boŞ
 
š_u£
;

122 
·ck‘_hªdË
* 
Ãxt
;

123 } 
	t·ck‘_hªdË_t
;

127 
ušt8_t
 
addr_Ën
;

128 
ušt8_t
 
addr_couÁ
;

129 
ušt8_t
 
add»s£s
[16][
ETH_ALEN
];

130 } 
	tPACKED
 
	tmuÉiÿ¡_li¡_t
;

133 
·ck‘_hªdË_t
 
g_·ck‘_hªdËs
[
MAX_HANDLES
];

134 
¡©i¡ics_t
 
g_·ck‘_¡©s
;

135 
ušt8_t
 
g_cu¼’t_»cv_mode
;

136 
muÉiÿ¡_li¡_t
 
g_muÉiÿ¡_li¡
;

141 
·ck‘_driv”_šfo
(
driv”_šfo_t
* 
šfo
);

142 
·ck‘_acûss_ty³
(
ušt16_t
 
if_şass
, ušt16_ˆ
if_ty³
,

143 
ušt16_t
 
if_numb”
, ušt16_ˆ
·ck‘_ty³
,

144 (*
»ûiv”
)(), 
ušt16_t
* 
hªdË
);

145 
·ck‘_»Ëa£_ty³
(
ušt16_t
 
hªdË
);

146 
·ck‘_£nd_pkt
(cÚ¡ 
ušt8_t
* 
·ck‘
, 
ušt16_t
 
Ëngth
);

147 
·ck‘_‹rmš©e
();

148 
·ck‘_g‘_add»ss
(
ušt16_t
 
if_numb”
, 
ušt8_t
* 
add»ss
, ušt16_t* 
Ëngth
);

149 
·ck‘_»£t_š‹rçû
(
ušt16_t
 
if_numb”
);

150 
·ck‘_g‘_·¿m‘”s
(
ušt16_t
 
if_numb”
, 
š‹rçû_·¿ms_t
* 
·¿ms
);

153 
·ck‘_as_£nd_pkt
(
ušt16_t
 
hªdË
, cÚ¡ 
ušt8_t
* 
·ck‘
, ušt16_ˆ
Ëngth
);

154 
·ck‘_£t_rcv_mode
(
ušt16_t
 
if_numb”
, 
ušt8_t
 
mode
);

155 
·ck‘_g‘_rcv_mode
(
ušt16_t
 
if_numb”
, 
ušt8_t
* 
mode
);

156 
·ck‘_£t_muÉiÿ¡_li¡
(
ušt16_t
 
if_numb”
, cÚ¡ 
muÉiÿ¡_li¡_t
* 
li¡
);

157 
·ck‘_g‘_muÉiÿ¡_li¡
(
ušt16_t
 
if_numb”
, 
muÉiÿ¡_li¡_t
* 
li¡
);

158 
·ck‘_g‘_¡©i¡ics
(
ušt16_t
 
if_numb”
, 
¡©i¡ics_t
* 
¡©s
);

159 
·ck‘_£t_add»ss
(
ušt16_t
 
if_numb”
, cÚ¡ 
ušt8_t
* 
add»ss
, ušt16_ˆ
Ëngth
);

162 
ušt16_t
 
®loÿ‹_hªdË
();

163 
»Ëa£_hªdË
(
ušt16_t
 
hªdË
);

164 
·ck‘_hªdË_t
* 
g‘_hªdË_šfo
(
ušt16_t
 
hªdË
);

165 
boŞ
 
is_v®id_hªdË
(
ušt16_t
 
hªdË
);

168 
·ck‘_»ûive_hªdËr
(
ušt8_t
* 
·ck‘
, 
ušt16_t
 
Ëngth
, ušt16_ˆ
·ck‘_ty³
);

169 
ÿÎ_»ûiv”s
(
ušt8_t
* 
·ck‘
, 
ušt16_t
 
Ëngth
, ušt16_ˆ
·ck‘_ty³
);

170 
boŞ
 
should_»ûive_·ck‘
(
ušt16_t
 
·ck‘_ty³
, cÚ¡ 
ušt8_t
* 
de¡_addr
);

173 
upd©e_¡©i¡ics
(
boŞ
 
is_»ûive
, 
ušt16_t
 
Ëngth
, boŞ 
”rÜ
);

174 
»£t_¡©i¡ics
();

177 
ušt16_t
 
exŒaù_·ck‘_ty³
(cÚ¡ 
ušt8_t
* 
·ck‘
);

178 
boŞ
 
is_brßdÿ¡_add»ss
(cÚ¡ 
ušt8_t
* 
add»ss
);

179 
boŞ
 
is_muÉiÿ¡_add»ss
(cÚ¡ 
ušt8_t
* 
add»ss
);

180 
boŞ
 
is_our_add»ss
(cÚ¡ 
ušt8_t
* 
add»ss
);

181 
boŞ
 
is_š_muÉiÿ¡_li¡
(cÚ¡ 
ušt8_t
* 
add»ss
);

184 
·ck‘_driv”_š‹¼u±
();

185 
£tup_·ck‘_š‹¼u±
(
ušt8_t
 
veùÜ
);

186 
»move_·ck‘_š‹¼u±
();

189 
boŞ
 
v®id©e_š‹rçû_numb”
(
ušt16_t
 
if_numb”
);

190 
boŞ
 
v®id©e_·ck‘_ty³
(
ušt16_t
 
·ck‘_ty³
);

191 
boŞ
 
v®id©e_»ûive_mode
(
ušt8_t
 
mode
);

192 
boŞ
 
v®id©e_add»ss_Ëngth
(
ušt16_t
 
Ëngth
);

195 cÚ¡ * 
·ck‘_”rÜ_¡ršg
(
”rÜ_code
);

196 
£t_·ck‘_”rÜ
(
”rÜ_code
);

197 
g‘_Ï¡_·ck‘_”rÜ
();

199 #ifdeà
__ılu¥lus


	@/Users/jvindahl/Development/3com-packet-driver/src/asm/hardware.asm

1 ; @
fe
 
	gh¬dw¬e
.
	gasm


2 ; @
br›f
 
	gLow
-
Ëv–
 
h¬dw¬e
 
š‹¿ùiÚ
 
	groutšes
 - 
Enhªûd
 
	gGroup
 6A/6B 
	gIm¶em’tiÚ


4 ; 3C
om
 
Pack‘
 
	gDriv”
 - 
SuµÜt
 3C515-
TX
 
	gªd
 3C509B 
	gNICs


5 ; 
Enhªûd
 
h¬dw¬e
 
d‘eùiÚ
 
ªd
 
IRQ
 
mªagem’t
 
	gGroups
 6A & 6B

7 ; 
This
 
fe
 
is
 
·¹
 
of
 
	gthe
 3C
om
 
Pack‘
 
Driv”
 
	g´ojeù
.

10 .
MODEL
 
	gSMALL


13 ; 
Inşude
 
as£mbly
 
š‹rçû
 
defš™iÚs


14 
	gšşude
 "asm_interfaces.inc"

15 
	gšşude
 "lfsr_table.inc"

17 ; 
	gI
/
O
 
pÜt
 
cÚ¡ªts


18 
ISA_MIN_IO
 
	gEQU
 100
	gh
 ; 
Mšimum
 
ISA
 
	gI
/
O
 
add»ss


19 
ISA_MAX_IO
 
	gEQU
 3FF
	gh
 ; 
Maximum
 
ISA
 
	gI
/
O
 
add»ss


20 
EISA_MIN_IO
 
	gEQU
 1000
	gh
 ; 
Mšimum
 
EISA
 
	gI
/
O
 
add»ss


21 
EISA_MAX_IO
 
	gEQU
 9FFF
	gh
 ; 
Maximum
 
EISA
 
	gI
/
O
 
	gadd»ss


23 ; 
	gCommÚ
 3C
om
 
	$»gi¡”s
 (
»Ïtive
 
to
 
ba£
)

24 
REG_COMMAND
 
EQU
 0E
h
 ; 
Commªd
 

25 
REG_STATUS
 
EQU
 0E
h
 ; 
Stus
 

26 
REG_WINDOW
 
EQU
 0E
h
 ; 
Wšdow
 
£Ëù
 

27 
REG_DATA
 
EQU
 00
h
 ; 
D©a
 (
wšdow
 
d•’d’t
)

28 
REG_INT_STATUS
 
EQU
 0E
h
 ; 
IÁ”ru±
 
¡©us


29 
REG_ID_PORT
 
EQU
 100
h
 ; 
ID
 
pÜt
 3C509B

31 ; 3C509B 
¥ecific
 
cÚ¡ªts


32 
C509B_EEPROM_READ
 
EQU
 0080
h
 ; 
EEPROM
 
»ad
 
commªd


33 
C509B_ACTIVATE
 
EQU
 0FF
h
 ; 
Aùiv©iÚ
 
£qu’û
 
v®ue


34 
C509B_ID_SEQUENCE
 
EQU
 6FFF
h
 ; 
ID
 
£qu’û
 
isŞ©iÚ


36 ; 3C515-
TX
 
¥ecific
 
	$cÚ¡ªts
 (
ISA
 
w™h
 
bus
 
ma¡”šg
)

37 
C515_ISA_MIN_IO
 
EQU
 100
h
 ; 
Mšimum
 
ISA
 
I
/
O
 3C515

38 
C515_ISA_MAX_IO
 
EQU
 3E0
h
 ; 
Maximum
 
ISA
 
I
/
O
 3C515

39 
C515_ISA_STEP
 
EQU
 20
h
 ; 
ISA
 
sÿn
 
¡•
 
size


40 
C515_DMA_CTRL
 
EQU
 400
h
 ; 
ISA
 
DMA
 
cÚŒŞ
 
off£t


41 
C515_BUS_MASTER
 
EQU
 01
h
 ; 
Bus
 
ma¡”
 
’abË
 
æag


43 ; 
H¬dw¬e
 
¡©e
 
cÚ¡ªts


44 
HW_STATE_UNKNOWN
 
EQU
 0 ; 
H¬dw¬e
 
¡©e
 
unknown


45 
HW_STATE_DETECTED
 
EQU
 1 ; 
H¬dw¬e
 
d‘eùed


46 
HW_STATE_CONFIGURED
 
EQU
 2 ; 
H¬dw¬e
 
cÚfigu»d


47 
HW_STATE_ACTIVE
 
EQU
 3 ; 
H¬dw¬e
 
aùive


48 
HW_STATE_ERROR
 
EQU
 0FF
h
 ; 
H¬dw¬e
 
”rÜ


50 ; 
Maximum
 
h¬dw¬e
 
š¡ªûs


51 
MAX_HW_INSTANCES
 
EQU
 2 ; 
SuµÜt
 
up
 
to
 2 
NICs


53 ; 
Enhªûd
 
d©a
 
£gm’t
 
Groups
 6A & 6B

54 
_DATA
 
SEGMENT


55 
ASSUME
 
DS
:
_DATA


57 ; 
Enhªûd
 
h¬dw¬e
 
d‘eùiÚ
 
¡©e
 
usšg
 
¡ruùu»d
 
­´ßch


58 
hw_š¡ªû_bË
 
HW_INSTANCE
 
MAX_HW_INSTANCES
 
	`dup
(<>)

59 
hw_š¡ªû_couÁ
 
db
 0 ; 
Numb”
 
of
 
d‘eùed
 
š¡ªûs


61 ; 
Legacy
 
com·tib™y
 
	$f›lds
 (
maššed
 
exi¡šg
 
code
)

62 
hw_š¡ªûs
 
db
 
MAX_HW_INSTANCES
 
	$dup
(
HW_STATE_UNDETECTED
)

63 
hw_io_ba£s
 
dw
 
MAX_HW_INSTANCES
 
	$dup
(0)

64 
hw_œq_lšes
 
db
 
MAX_HW_INSTANCES
 
	$dup
(0)

65 
hw_ty³s
 
db
 
MAX_HW_INSTANCES
 
	`dup
(0è; 0=
unknown
, 1=3C509B, 2=3C515

66 
hw_mac_add»s£s
 
db
 
MAX_HW_INSTANCES
*6 
	`dup
(0è; 
MAC
 
add»s£s


68 ; 
Add™iÚ®
 
bËs
 
’hªûd
 
im¶em’tiÚ


69 
hw_ioba£_bË
 
dw
 
MAX_HW_INSTANCES
 
	`dup
(0è; 
I
/
O
 
ba£
 
add»s£s


70 
hw_ty³_bË
 
db
 
MAX_HW_INSTANCES
 
	`dup
(0è; 
NIC
 
	$ty³s
 (1=3C509B, 2=3C515)

71 
hw_æags_bË
 
db
 
MAX_HW_INSTANCES
 
	`dup
(0è; 
H¬dw¬e
 
æags


72 
cu¼’t_š¡ªû
 
db
 0 ; 
Cu¼’t
 
aùive
 
š¡ªû


73 
cu¼’t_ioba£
 
dw
 0 ; 
Cu¼’t
 
NIC
 
I
/
O
 
ba£


74 
cu¼’t_œq
 
db
 0 ; 
Cu¼’t
 
NIC
 
IRQ


76 ; 
Enhªûd
 
I
/
O
 
İ”©iÚ
 
¡©i¡ics


77 
io_»ad_couÁ
 
dd
 0 ; 
TÙ®
 
I
/
O
 
»ads


78 
io_wr™e_couÁ
 
dd
 0 ; 
TÙ®
 
I
/
O
 
wr™es


79 
io_”rÜ_couÁ
 
dw
 0 ; 
I
/
O
 
”rÜ
 
couÁ


80 
io_timeout_couÁ
 
dw
 0 ; 
I
/
O
 
timeout
 
couÁ


81 
io_»Œy_couÁ
 
dw
 0 ; 
I
/
O
 
»Œy
 
couÁ


83 ; 
Sy¡em
 
¡©e
 
mªagem’t


84 
h¬dw¬e_š™Ÿlized
 
db
 0 ; 
H¬dw¬e
 
subsy¡em
 
š™Ÿlized


85 
cu¼’t_š¡ªû
 
db
 0 ; 
Cu¼’y
 
£Ëùed
 
h¬dw¬e
 
š¡ªû


86 
Ï¡_”rÜ_code
 
db
 0 ; 
La¡
 
”rÜ
 
code
 
’couÁ”ed


87 
debug_æags
 
db
 0 ; 
Debug
 
cÚŒŞ
 
æags


89 ; 
Timšg
 
ªd
 
synchrÚiz©iÚ


90 
time¡amp_Ï¡_d‘eù
 
dd
 0 ; 
La¡
 
d‘eùiÚ
 
time¡amp


91 
time¡amp_Ï¡_cÚfig
 
dd
 0 ; 
La¡
 
cÚfigu¿tiÚ
 
time¡amp


93 
_DATA
 
ENDS


95 ; 
Code
 
£gm’t


96 
_TEXT
 
SEGMENT


97 
ASSUME
 
CS
:
_TEXT
, 
DS
:
_DATA


99 ; 
Enhªûd
 
funùiÚ
 
expÜts
 
Groups
 6A & 6B

100 
PUBLIC
 
h¬dw¬e_š™_asm


101 
PUBLIC
 
h¬dw¬e_d‘eù_®l


102 
PUBLIC
 
h¬dw¬e_cÚfigu»_3c509b


103 
PUBLIC
 
h¬dw¬e_cÚfigu»_3c515


104 
PUBLIC
 
h¬dw¬e_»ad_·ck‘


105 
PUBLIC
 
h¬dw¬e_£nd_·ck‘_asm


106 
PUBLIC
 
h¬dw¬e_g‘_add»ss


107 
PUBLIC
 
h¬dw¬e_hªdË_3c509b_œq


108 
PUBLIC
 
h¬dw¬e_hªdË_3c515_œq


109 
PUBLIC
 
io_»ad_by‹


110 
PUBLIC
 
io_wr™e_by‹


111 
PUBLIC
 
io_»ad_wÜd


112 
PUBLIC
 
io_wr™e_wÜd


113 
PUBLIC
 
d‘eù_3c509b


114 
PUBLIC
 
š™_3c509b


116 ; 
Enhªûd
 
Group
 6A/6B 
š‹rçû
 
funùiÚs


117 
PUBLIC
 
h¬dw¬e_d‘eù_ªd_cÚfigu»


118 
PUBLIC
 
h¬dw¬e_g‘_deviû_šfo


119 
PUBLIC
 
h¬dw¬e_£t_deviû_¡©e


120 
PUBLIC
 
h¬dw¬e_hªdË_š‹¼u±


121 
PUBLIC
 
h¬dw¬e_v®id©e_cÚfigu¿tiÚ


122 
PUBLIC
 
d‘eù_3c509b_deviû


123 
PUBLIC
 
d‘eù_3c515_deviû


124 
PUBLIC
 
cÚfigu»_3c509b_deviû


125 
PUBLIC
 
cÚfigu»_3c515_deviû


126 
PUBLIC
 
£tup_3c509b_œq


127 
PUBLIC
 
£tup_3c515_œq


128 
PUBLIC
 
»£t_3c509b_deviû


129 
PUBLIC
 
»£t_3c515_deviû


130 
PUBLIC
 
»ad_3c509b_“´om


131 
PUBLIC
 
»ad_3c515_“´om
\
n
\n; 3C515-
TX
 
HAL
 
vbË
 
funùiÚ
 
expÜts
\
nPUBLIC
 
asm_3c515_d‘eù_h¬dw¬e
\nPUBLIC 
asm_3c515_š™_h¬dw¬e
\nPUBLIC 
asm_3c515_»£t_h¬dw¬e
\nPUBLIC 
asm_3c515_cÚfigu»_medŸ
\nPUBLIC 
asm_3c515_£t_¡©iÚ_add»ss
\nPUBLIC 
asm_3c515_’abË_š‹¼u±s
\nPUBLIC 
asm_3c515_¡¬t_Œªsûiv”
\nPUBLIC 
asm_3c515_¡İ_Œªsûiv”
\nPUBLIC 
asm_3c515_g‘_lšk_¡©us
\nPUBLIC 
asm_3c515_g‘_¡©i¡ics
\nPUBLIC 
asm_3c515_£t_muÉiÿ¡
\nPUBLIC 
asm_3c515_£t_´omiscuous


133 ; 
Ex‹º®
 
»ã»nûs


134 
EXTRN
 
g‘_ıu_ã©u»s
:
PROC
 ; 
From
 
ıu_d‘eù
.
asm


137 ; 
h¬dw¬e_š™_asm
 - 
In™Ÿlize
 
h¬dw¬e
 
subsy¡em


139 ; 
IÅut
: 
NÚe


140 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


141 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


143 
h¬dw¬e_š™_asm
 
PROC


144 
push
 
bp


145 
mov
 
bp
, 
¥


146 
push
 
bx


147 
push
 
cx


148 
push
 
dx


149 
push
 
si


151 ; 
In™Ÿlize
 
h¬dw¬e
 
d‘eùiÚ
 
¡ruùu»s
, 
ş—r
 
¡©i¡ics
, 
ªd
 
d‘eù
 
®l
 
avaabË
 hardware

153 ; 
CË¬
 
h¬dw¬e
 
¡©e


154 
mov
 
cx
, 
MAX_HW_INSTANCES


155 
mov
 
si
, 
OFFSET
 
hw_š¡ªûs


156 
mov
 
®
, 
HW_STATE_UNKNOWN


157 .
ş—r_¡©e_loİ
:

158 
mov
 [
si
], 
®


159 
šc
 
si


160 
loİ
 .
ş—r_¡©e_loİ


162 ; 
CË¬
 
I
/
O
 
¡©i¡ics


163 
mov
 
dwÜd
 
±r
 [
io_»ad_couÁ
], 0

164 
mov
 
dwÜd
 
±r
 [
io_wr™e_couÁ
], 0

165 
mov
 
wÜd
 
±r
 [
io_”rÜ_couÁ
], 0

167 ; 
D‘eù
 
®l
 
h¬dw¬e


168 
ÿÎ
 
h¬dw¬e_d‘eù_®l


169 
cmp
 
ax
, 0

170 
jÃ
 .
d‘eùiÚ_çed


172 ; 
Sucûss


173 
mov
 
ax
, 0

174 
jmp
 .
ex™


176 .
d‘eùiÚ_çed
:

177 ; 
Log
 
d‘eùiÚ
 
çu»


178 
push
 
ax


179 
push
 
dx


180 
mov
 
ax
, 
ERROR_NOT_FOUND


181 
ÿÎ
 
log_h¬dw¬e_”rÜ


182 
pİ
 
dx


183 
pİ
 
ax


184 
mov
 
ax
, 1

185 
jmp
 .
ex™


187 .
ex™
:

188 
pİ
 
si


189 
pİ
 
dx


190 
pİ
 
cx


191 
pİ
 
bx


192 
pİ
 
bp


193 
»t


194 
h¬dw¬e_š™_asm
 
ENDP


197 ; 
h¬dw¬e_d‘eù_®l
 - 
D‘eù
 
®l
 
suµÜ‹d
 
h¬dw¬e


199 ; 
IÅut
: 
NÚe


200 ; 
Ouut
: 
AX
 = 
numb”
 
of
 
deviûs
 
d‘eùed


201 ; 
U£s
: 
AÎ
 
»gi¡”s


203 
h¬dw¬e_d‘eù_®l
 
PROC


204 
push
 
bp


205 
mov
 
bp
, 
¥


206 
push
 
bx


207 
push
 
cx


208 
push
 
dx


209 
push
 
si


210 
push
 
di


212 ; 
Com´eh’sive
 
h¬dw¬e
 
d‘eùiÚ
 - 
sÿn
 
ISA
 
ªd
 
EISA
 
bu£s
 3C509B‡nd 3C515-
TX
 
ÿrds


214 
mov
 
bx
, 0 ; 
Deviû
 
couÁ”


216 ; 
Try
 
to
 
d‘eù
 3C509B (
ISA
 
bus
)

217 
ÿÎ
 
d‘eù_3c509b


218 
cmp
 
ax
, 0

219 
je
 .
no_3c509b


221 ; 
Found
 3C509B - 
¡Üe
 
š
 
fœ¡
 
¦Ù


222 
mov
 
by‹
 
±r
 [
hw_š¡ªûs
], 
HW_STATE_DETECTED


223 
mov
 
by‹
 
±r
 [
hw_ty³s
], 1 ; 
Ty³
 1 = 3C509B

224 
mov
 [
hw_io_ba£s
], 
ax
 ; 
StÜe
 
I
/
O
 
ba£


225 
šc
 
bx


227 .
no_3c509b
:

228 ; 
Try
 
to
 
d‘eù
 3C515-
	$TX
 (
ISA
 
bus
 
w™h
 bu 
ma¡”šg
)

229 
ÿÎ
 
d‘eù_3c515


230 
cmp
 
ax
, 0

231 
je
 .
no_3c515


233 ; 
Found
 3C515 - 
¡Üe
 
š
 
£cÚd
 
	$¦Ù
 (
avaabË
)

234 
cmp
 
bx
, 
MAX_HW_INSTANCES


235 
j«
 .
no_mÜe_¦Ùs


237 
mov
 
si
, 
OFFSET
 
hw_š¡ªûs


238 
add
 
si
, 
bx


239 
mov
 
by‹
 
±r
 [
si
], 
HW_STATE_DETECTED


240 
mov
 
si
, 
OFFSET
 
hw_ty³s


241 
add
 
si
, 
bx


242 
mov
 
by‹
 
±r
 [
si
], 2 ; 
Ty³
 2 = 3C515

243 
mov
 
si
, 
OFFSET
 
hw_io_ba£s


244 
shl
 
bx
, 1 ; 
CÚv”t
 
to
 
wÜd
 
off£t


245 
add
 
si
, 
bx


246 
mov
 [
si
], 
ax
 ; 
StÜe
 
I
/
O
 
ba£


247 
shr
 
bx
, 1 ; 
Re¡Üe
 
by‹
 
off£t


248 
šc
 
bx


250 .
no_mÜe_¦Ùs
:

251 .
no_3c515
:

252 ; 
Check
 
unsuµÜ‹d
 
bus
 
NICs
 
ªd
 
w¬n
 
u£r


253 
push
 
bx
 ; 
Save
 
deviû
 
couÁ


255 ; 
Check
 
EISA
 
	$NICs
 (
¡ub
)

256 
ÿÎ
 
nic_d‘eù_ei§_3c592


257 
mov
 
cx
, 
ax


258 
ÿÎ
 
nic_d‘eù_ei§_3c597


259 
Ü
 
ax
, 
cx


260 
jz
 .
check_mÿ


261 
push
 
OFFSET
 
msg_ei§_nÙ_suµÜ‹d


262 
ÿÎ
 
log_w¬nšg


263 
add
 
¥
, 2

265 .
check_mÿ
:

266 ; 
Check
 
this
 
is
 
ª
 
MCA
 
sy¡em


267 
ÿÎ
 
is_mÿ_sy¡em


268 
Ü
 
ax
,‡x

269 
jz
 .
check_vlb
 ; 
NÙ
 
MCA
, 
sk
 MCA 
checks


271 ; 
It
's‡n MCA system - check for MCA NICs

272 
ÿÎ
 
nic_d‘eù_mÿ_3c523


273 
mov
 
cx
, 
ax


274 
ÿÎ
 
nic_d‘eù_mÿ_3c529


275 
Ü
 
ax
, 
cx


276 
jz
 .
mÿ_no_nics
 ; 
No
 
MCA
 
NICs
 
found


278 ; 
MCA
 
NICs
 
found
 - 
w¬n
 
u£r


279 
push
 
OFFSET
 
msg_mÿ_nÙ_suµÜ‹d


280 
ÿÎ
 
log_w¬nšg


281 
add
 
¥
, 2

283 .
mÿ_no_nics
:

284 ; 
AÎ
 
MCA
 
sy¡ems
 
¬e
 
pu»
 MCA - 
no
 
ISA
 
¦Ùs
 
avaabË


285 
push
 
OFFSET
 
msg_pu»_mÿ_”rÜ1


286 
ÿÎ
 
log_”rÜ


287 
add
 
¥
, 2

288 
push
 
OFFSET
 
msg_pu»_mÿ_”rÜ2


289 
ÿÎ
 
log_”rÜ


290 
add
 
¥
, 2

291 
push
 
OFFSET
 
msg_pu»_mÿ_”rÜ3


292 
ÿÎ
 
log_”rÜ


293 
add
 
¥
, 2

295 ; 
S‘
 
deviû
 
couÁ
 
to
 0 
ªd
 
ex™
 
—¾y


296 
pİ
 
bx
 ; 
Re¡Üe
 
§ved
 
deviû
 
couÁ


297 
xÜ
 
ax
,‡x ; 
R‘uº
 0 
deviûs


298 
jmp
 .
—¾y_ex™


300 .
check_vlb
:

301 ; 
Check
 
VLB
 
	$NICs
 (
¡ub
)

302 
ÿÎ
 
nic_d‘eù_vlb


303 
Ü
 
ax
,‡x

304 
jz
 .
dÚe_checkšg


305 ; 
VLB
 
®»ady
 
logs
 
™s
 
own
 
mes§ge


307 .
dÚe_checkšg
:

308 
pİ
 
bx
 ; 
Re¡Üe
 
deviû
 
couÁ


310 ; 
R‘uº
 
numb”
 
of
 
deviûs
 
d‘eùed


311 
mov
 
ax
, 
bx


313 .
—¾y_ex™
:

314 
pİ
 
di


315 
pİ
 
si


316 
pİ
 
dx


317 
pİ
 
cx


318 
pİ
 
bx


319 
pİ
 
bp


320 
»t


321 
h¬dw¬e_d‘eù_®l
 
ENDP


324 ; 
d‘eù_3c509b
 - 
D‘eù
 3C509B 
ISA
 
ÿrd
 
usšg
 
´İ”
 
LFSR
 
ID
 
£qu’û


326 ; 
IÅut
: 
NÚe


327 ; 
Ouut
: 
AX
 = 
I
/
O
 
ba£
 
add»ss
 
found
, 0 
nÙ
 found

328 ; 
U£s
: 
AÎ
 
»gi¡”s


330 
d‘eù_3c509b
 
PROC


331 
push
 
bp


332 
mov
 
bp
, 
¥


333 
push
 
bx


334 
push
 
cx


335 
push
 
dx


336 
push
 
si


337 
push
 
di


339 ; 
P”fÜm
 3C509B 
ID
 
£qu’û
 
usšg
 
LFSR
 
bË


340 ; 
This
 
is
 
the
 
¡ªd¬d
 3C
om
 
isŞ©iÚ
 
´ÙocŞ


342 ; 
Re£t
 
®l
 
ÿrds
 
to
 
known
 
¡©e


343 
mov
 
dx
, 0110
h
 ; 
Snd¬d
 
ID
 
pÜt


344 
mov
 
®
, 0C0
h
 ; 
Glob®
 
»£t
 
commªd


345 
out
 
dx
, 
®


347 ; 
Sm®l
 
d–ay
 
aá”
 
»£t


348 
mov
 
cx
, 1000

349 .
»£t_d–ay
:

350 
loİ
 .
»£t_d–ay


352 ; 
S’d
 
ID
 
£qu’û
 
to
 
isŞ©e
 
ÿrds


353 ; 
U£
 
LFSR
 
£qu’û
: 255 
by‹s
 
¡¬tšg
 
w™h
 0xFF

354 
mov
 
®
, 0 ; 
S¹
 
w™h
 0x00

355 
out
 
dx
, 
®


356 
mov
 
®
, 0 ; 
SecÚd
 0x00

357 
out
 
dx
, 
®


359 ; 
S’d
 255-
by‹
 
LFSR
 
£qu’û


360 
mov
 
si
, 
OFFSET
 
lf¤_bË


361 
mov
 
cx
, 
LFSR_TABLE_SIZE
 ; 255 
by‹s


363 .
id_£qu’û_loİ
:

364 
lodsb
 ; 
Lßd
 
by‹
 
äom
 
LFSR
 
bË


365 
out
 
dx
, 
®
 ; 
S’d
 
to
 
ID
 
pÜt


366 
loİ
 .
id_£qu’û_loİ


368 ; 
Re£t
 
g
 
fœ¡
 
ÿrd
 
d‘eùiÚ


369 
mov
 
®
, 0D0
h
 ; 
S‘
 
g
 
commªd


370 
out
 
dx
, 
®


372 ; 
R—d
 
EEPROM
 
add»ss
 7 
to
 
check
 3C
om
 
sigÇtu»


373 
mov
 
®
, 87
h
 ; 
R—d
 
EEPROM
 
loÿtiÚ
 7

374 
out
 
dx
, 
®


376 ; 
Wa™
 
EEPROM
 
	`»ady
 (15Î¼
s
 
mšimum
 
äom
 
Lšux
 
driv”
)

377 
mov
 
cx
, 50 ; 
Aµroxim©–y
 15Î¼
s
 
©
 
typiÿl
 
CPU
 
¥“ds


378 .
“´om_wa™1
:

379 
nİ


380 
loİ
 .
“´om_wa™1


382 ; 
R—d
 
the
 
d©a
 
b™
 
by
 
	$b™
 (3C509B 
´ÙocŞ
)

383 
mov
 
cx
, 16 ; 16 
b™s


384 
mov
 
bx
, 0 ; 
AccumuÏtÜ


386 .
»ad_“´om_loİ
:

387 
shl
 
bx
, 1 ; 
Shiá
 
accumuÏtÜ
 
Ëá


388 
š
 
®
, 
dx
 ; 
R—d
 
äom
 
ID
 
pÜt


389 
ªd
 
®
, 01
h
 ; 
Mask
 
to
 
g‘
 
LSB


390 
Ü
 
bl
, 
®
 ; 
OR
 
što
 
accumuÏtÜ


391 
loİ
 .
»ad_“´om_loİ


393 ; 
Check
 3C
om
 
´oduù
 
	$ID
 (0x6D50)

394 
cmp
 
bx
, 6D50
h


395 
jÃ
 .
nÙ_found


397 ; 
Found
 3C
om
 
ÿrd
 - 
»ad
 
I
/
O
 
ba£
 
cÚfigu¿tiÚ


398 
mov
 
®
, 88
h
 ; 
R—d
 
EEPROM
 
loÿtiÚ
 8 (
I
/
O
 
cÚfig
)

399 
out
 
dx
, 
®


401 ; 
Wa™
 
EEPROM
 
»ady


402 
mov
 
cx
, 50

403 .
“´om_wa™2
:

404 
nİ


405 
loİ
 .
“´om_wa™2


407 ; 
R—d
 
I
/
O
 
ba£
 
cÚfigu¿tiÚ


408 
mov
 
cx
, 16

409 
mov
 
bx
, 0

411 .
»ad_ioba£_loİ
:

412 
shl
 
bx
, 1

413 
š
 
®
, 
dx


414 
ªd
 
®
, 01
h


415 
Ü
 
bl
, 
®


416 
loİ
 .
»ad_ioba£_loİ


418 ; 
C®cuÏ‹
 
I
/
O
 
ba£
 
add»ss


419 ; 
BÙtom
 5 
b™s
 
give
 
the
 
ba£
, 
tİ
 b™ giv
š‹rçû
 
ty³


420 
ªd
 
bx
, 001F
h
 ; 
Mask
 
to
 
g‘
 
ba£
 
add»ss
 
b™s


421 
shl
 
bx
, 4 ; 
MuÉly
 
by
 16

422 
add
 
bx
, 0200
h
 ; 
Add
 
ba£
 
off£t


424 ; 
Aùiv©e
 
the
 
ÿrd
 
©
 
this
 
I
/
O
 
add»ss


425 
mov
 
®
, 
bl
 ; 
Low
 
by‹
 
of
 
I
/
O
 
ba£


426 
shr
 
®
, 4 ; 
Shiá
 
to
 
g‘
 
add»ss
 
code


427 
Ü
 
®
, 0E0
h
 ; 
Add
 
aùiv©e
 
commªd


428 
out
 
dx
, 
®


430 ; 
Sm®l
 
d–ay
 
aá”
 
aùiv©iÚ


431 
mov
 
cx
, 2000

432 .
aùiv©e_d–ay
:

433 
loİ
 .
aùiv©e_d–ay


435 ; 
V”ify
 
the
 
ÿrd
 
»¥Úds
 
©
 
ÿlcuÏ‹d
 
add»ss


436 
mov
 
dx
, 
bx
 ; 
U£
 
ÿlcuÏ‹d
 
I
/
O
 
ba£


437 
add
 
dx
, 0E
h
 ; 
Commªd
/
Stus
 

439 ; 
S–eù
 
wšdow
 0 
id’tifiÿtiÚ


440 
mov
 
ax
, (1 
shl
 11è
Ü
 0 ; 
S–eù
 
wšdow
 0 
commªd


441 
out
 
dx
, 
ax


443 ; 
Sm®l
 
d–ay
 
wšdow
 
£ËùiÚ


444 
mov
 
cx
, 100

445 .
wšdow_d–ay
:

446 
loİ
 .
wšdow_d–ay


448 ; 
R—d
 
äom
 
the
 
ÿrd
 
to
 
v”ify
 
´e£nû


449 
š
 
ax
, 
dx


450 ; 
If
 
we
 
g‘
 
®l
 1
s
, 
ÿrd
 
is
 
nÙ
 
th”e


451 
cmp
 
ax
, 0FFFF
h


452 
je
 .
nÙ_found


454 ; 
Sucûss
 -  
I
/
O
 
ba£
 
add»ss


455 
mov
 
ax
, 
bx


456 
jmp
 .
ex™


458 .
nÙ_found
:

459 
mov
 
ax
, 0 ; 
R‘uº
 0 
nÙ
 
found


461 .
ex™
:

462 
pİ
 
di


463 
pİ
 
si


464 
pİ
 
dx


465 
pİ
 
cx


466 
pİ
 
bx


467 
pİ
 
bp


468 
»t


469 
d‘eù_3c509b
 
ENDP


472 ; 
š™_3c509b
 - 
In™Ÿlize
 
d‘eùed
 3C509B 
ÿrd


474 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss
, 
AL
 = 
NIC
 
šdex


475 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


476 ; 
U£s
: 
AÎ
 
»gi¡”s


478 
š™_3c509b
 
PROC


479 
push
 
bp


480 
mov
 
bp
, 
¥


481 
push
 
bx


482 
push
 
cx


483 
push
 
dx


484 
push
 
si


485 
push
 
di


487 ; 
StÜe
 
NIC
 
šdex
 
Ï‹r
 
u£


488 
mov
 
bl
, 
®


490 ; 
P”fÜm
 
tÙ®
 
»£t
 
fœ¡


491 
mov
 
ax
, (0 
shl
 11è; 
TÙ®
 
Re£t
 
commªd


492 
add
 
dx
, 0E
h
 ; 
Commªd
 
off£t


493 
out
 
dx
, 
ax


494 
sub
 
dx
, 0E
h
 ; 
Re¡Üe
 
ba£
 
add»ss


496 ; 
Wa™
 
»£t
 
to
 
	$com¶‘e
 (
mšimum
 1
ms
)

497 
mov
 
cx
, 10000

498 .
»£t_wa™
:

499 
nİ


500 
loİ
 .
»£t_wa™


502 ; 
S–eù
 
wšdow
 0 
cÚfigu¿tiÚ


503 
add
 
dx
, 0E
h
 ; 
Commªd
 

504 
mov
 
ax
, (1 
shl
 11è
Ü
 0 ; 
S–eù
 
Wšdow
 0

505 
out
 
dx
, 
ax


506 
sub
 
dx
, 0E
h


508 ; 
R—d
 
ªd
 
¡Üe
 
MAC
 
add»ss
 
äom
 
EEPROM


509 
mov
 
si
, 0 ; 
EEPROM
 
add»ss
 
couÁ”


510 
mov
 
di
, 
OFFSET
 
hw_mac_add»s£s


511 
mov
 
ah
, 0

512 
mov
 
®
, 
bl
 ; 
NIC
 
šdex


513 
mov
 
ş
, 6 ; 6 
by‹s
 
³r
 
MAC
 
add»ss


514 
mul
 
ş


515 
add
 
di
, 
ax
 ; 
Pošt
 
to
 
this
 
NIC
's MAC storage

517 ; 
R—d
 
MAC
 
	$add»ss
 (3 
wÜds
 = 6 
by‹s
)

518 
mov
 
cx
, 3 ; 
R—d
 3 
EEPROM
 
wÜds


520 .
»ad_mac_loİ
:

521 ; 
S‘
 
EEPROM
 
add»ss
 
»ad


522 
push
 
dx


523 
add
 
dx
, 0A
h
 ; 
EEPROM
 
commªd
 

524 
mov
 
ax
, 0080
h
 ; 
R—d
 
commªd


525 
Ü
 
ax
, 
si
 ; 
Add
 
EEPROM
 
add»ss


526 
out
 
dx
, 
ax


528 ; 
Wa™
 
EEPROM
 
	`»ady
 (15Î¼
s
 
mšimum
)

529 
push
 
cx


530 
mov
 
cx
, 50

531 .
mac_“´om_wa™
:

532 
nİ


533 
loİ
 .
mac_“´om_wa™


534 
pİ
 
cx


536 ; 
R—d
 
EEPROM
 
d©a


537 
add
 
dx
, 2 ; 
EEPROM
 
d©a
 (0C
h
)

538 
š
 
ax
, 
dx


539 
pİ
 
dx


541 ; 
StÜe
 
MAC
 
	$by‹s
 (3C
om
 
¡Ües
 
by‹s
 
sw­³d
)

542 
mov
 [
di
], 
ah
 ; 
StÜe
 
high
 
by‹
 
fœ¡


543 
šc
 
di


544 
mov
 [
di
], 
®
 ; 
StÜe
 
low
 
by‹


545 
šc
 
di


547 
šc
 
si
 ; 
Next
 
EEPROM
 
add»ss


548 
loİ
 .
»ad_mac_loİ


550 ; 
S–eù
 
wšdow
 2 
to
 
£t
 
¡©iÚ
 
add»ss


551 
add
 
dx
, 0E
h
 ; 
Commªd
 

552 
mov
 
ax
, (1 
shl
 11è
Ü
 2 ; 
S–eù
 
Wšdow
 2

553 
out
 
dx
, 
ax


555 ; 
Wr™e
 
MAC
 
add»ss
 
to
 
¡©iÚ
‡dd»s 
»gi¡”s


556 
mov
 
si
, 
OFFSET
 
hw_mac_add»s£s


557 
mov
 
ah
, 0

558 
mov
 
®
, 
bl
 ; 
NIC
 
šdex


559 
mov
 
ş
, 6

560 
mul
 
ş


561 
add
 
si
, 
ax
 ; 
Pošt
 
to
 
this
 
NIC
's MAC

563 
mov
 
cx
, 6 ; 6 
by‹s
 
to
 
wr™e


564 
mov
 
di
, 0 ; 
Regi¡”
 
off£t


566 .
wr™e_mac_loİ
:

567 
mov
 
®
, [
si
] ; 
Lßd
 
MAC
 
by‹


568 
push
 
dx


569 
add
 
dx
, 
di
 ; 
Add
 
off£t


570 
out
 
dx
, 
®
 ; 
Wr™e
 
to
 
¡©iÚ
 
add»ss
 

571 
pİ
 
dx


572 
šc
 
si
 ; 
Next
 
MAC
 
by‹


573 
šc
 
di
 ; 
Next
 

574 
loİ
 .
wr™e_mac_loİ


576 ; 
S–eù
 
wšdow
 1 
nÜm®
 
İ”©iÚ


577 
add
 
dx
, 0E
h
 ; 
Commªd
 

578 
mov
 
ax
, (1 
shl
 11è
Ü
 1 ; 
S–eù
 
Wšdow
 1

579 
out
 
dx
, 
ax


581 ; 
S‘
 
»ûive
 
	`f‹r
 (
¡©iÚ
 + 
brßdÿ¡
)

582 
mov
 
ax
, (16 
shl
 11è
Ü
 0005
h
 ; 
S‘RxF‹r
: 
StiÚ
 + 
Brßdÿ¡


583 
out
 
dx
, 
ax


585 ; 
EÇbË
 
»ûiv”


586 
mov
 
ax
, (4 
shl
 11è; 
RxEÇbË
 
commªd


587 
out
 
dx
, 
ax


589 ; 
EÇbË
 
Œªsm™‹r


590 
mov
 
ax
, (9 
shl
 11è; 
TxEÇbË
 
commªd


591 
out
 
dx
, 
ax


593 ; 
Sucûss


594 
mov
 
ax
, 0

596 
pİ
 
di


597 
pİ
 
si


598 
pİ
 
dx


599 
pİ
 
cx


600 
pİ
 
bx


601 
pİ
 
bp


602 
»t


603 
š™_3c509b
 
ENDP


606 ; 
d‘eù_3c515
 - 
D‘eù
 3C515-
TX
 
ISA
 
ÿrd
 
w™h
 
bus
 
sÿn
 0x100-0x3E0 
¡•
 0x20

608 ; 
IÅut
: 
NÚe


609 ; 
Ouut
: 
AX
 = 
I
/
O
 
ba£
 
add»ss
 
found
, 0 
nÙ
 found

610 ; 
U£s
: 
AÎ
 
»gi¡”s


612 
d‘eù_3c515
 
PROC


613 
push
 
bp


614 
mov
 
bp
, 
¥


615 
push
 
bx


616 
push
 
cx


617 
push
 
dx


618 
push
 
si


620 ; 
Sÿn
 
ISA
 
bus
 
äom
 0x100 
to
 0x3E0 
š
 
¡•s
 
of
 0x20

621 ; 3C515 
is
 
ª
 
ISA
 
ÿrd
, 
NOT
 
PCI
!

622 
mov
 
dx
, 
C515_ISA_MIN_IO
 ; 
S¹
 
©
 0x100

623 
mov
 
cx
, ((
C515_ISA_MAX_IO
 - 
C515_ISA_MIN_IO
è/ 
C515_ISA_STEP
) + 1

625 .
sÿn_loİ
:

626 ; 
Try
 
cu¼’t
 
I
/
O
 
add»ss


627 
ÿÎ
 
´obe_3c515_©_add»ss


628 
cmp
 
ax
, 0

629 
jÃ
 .
found


631 ; 
Move
 
to
 
Ãxt
 
	$add»ss
 (
¡•
 0x20)

632 
add
 
dx
, 20
h


633 
loİ
 .
sÿn_loİ


635 ; 
NÙ
 
found


636 
mov
 
ax
, 0

637 
jmp
 .
ex™


639 .
found
:

640 ; 
R‘uº
 
the
 
I
/
O
 
ba£
 
wh”e
 
ÿrd
 
was
 
found


641 
mov
 
ax
, 
dx


643 .
ex™
:

644 
pİ
 
si


645 
pİ
 
dx


646 
pİ
 
cx


647 
pİ
 
bx


648 
pİ
 
bp


649 
»t


650 
d‘eù_3c515
 
ENDP


653 ; 
´obe_3c515_©_add»ss
 - 
Probe
 3C515 
©
 
¥ecific
 
add»ss


655 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss
 
to
 
´obe


656 ; 
Ouut
: 
AX
 = 1 
found
, 0 
nÙ
 found

657 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
SI


659 
´obe_3c515_©_add»ss
 
PROC


660 
push
 
bp


661 
mov
 
bp
, 
¥


662 
push
 
bx


663 
push
 
cx


664 
push
 
si


665 
push
 
dx


667 ; 
S–eù
 
wšdow
 0 
EEPROM
 
acûss


668 
push
 
dx


669 
add
 
dx
, 0E
h
 ; 
Commªd
 

670 
mov
 
ax
, (1 << 11è| 0 ; 
S–eù
 
wšdow
 0

671 
out
 
dx
, 
ax


672 
pİ
 
dx


674 ; 
Sm®l
 
d–ay
 
wšdow
 
£ËùiÚ


675 
mov
 
cx
, 100

676 .
d–ay1
:

677 
nİ


678 
loİ
 .
d–ay1


680 ; 
Try
 
to
 
»ad
 
EEPROM
Ø
id’tify
 3C515-
TX


681 ; 3C515 
u£s
 
difã»Á
 
EEPROM
 
acûss
 
©
 
ba£
+0x0A 
š
 
Wšdow
 0

682 
push
 
dx


683 
add
 
dx
, 0A
h
 ; 
EEPROM
 
commªd
 (
ISA
 
off£t
)

684 
mov
 
ax
, 80
h
 | 3 ; 
R—d
 
commªd
 
Mod–ID
 
loÿtiÚ


685 
out
 
dx
, 
ax


686 
pİ
 
dx


688 ; 
Wa™
 162Î¼
s
 
	$EEPROM
 (
äom
 
Lšux
 
driv”
 
ª®ysis
)

689 
mov
 
cx
, 162

690 .
“´om_d–ay
:

691 
ÿÎ
 
d–ay_1us
 ; 1 
miüo£cÚd
 
d–ay


692 
loİ
 .
“´om_d–ay


694 ; 
R—d
 
EEPROM
 
d©a


695 
push
 
dx


696 
add
 
dx
, 0C
h
 ; 
EEPROM
 
d©a
 (
ISA
 
off£t
)

697 
š
 
ax
, 
dx


698 
pİ
 
dx


700 ; 
Check
 3C515-
TX
 
´oduù
 
	$ID
 (0x5051 
w™h
 
»visiÚ
 
mask
)

701 
ªd
 
ax
, 0F0FF
h
 ; 
Mask
 
off
 
»visiÚ
 
nibbË


702 
cmp
 
ax
, 5051
h
 ; 3C515-
TX
 
´oduù
 
ID


703 
je
 .
found_3c515


705 ; 
NÙ
 
found


706 
mov
 
ax
, 0

707 
jmp
 .
ex™


709 .
found_3c515
:

710 ; 
V”ify
 
™
's„eally‡ 3C515 by checking 3Com ID

711 
push
 
dx


712 
add
 
dx
, 200A
h
 ; 
EEPROM
 
commªd
 

713 
mov
 
ax
, 80
h
 | 7 ; 
R—d
 
Eth”Lšk3ID
 
loÿtiÚ


714 
out
 
dx
, 
ax


715 
pİ
 
dx


717 ; 
Wa™
 
EEPROM


718 
mov
 
cx
, 162

719 .
“´om_d–ay2
:

720 
ÿÎ
 
d–ay_1us


721 
loİ
 .
“´om_d–ay2


723 ; 
R—d
 3C
om
 
ID


724 
push
 
dx


725 
add
 
dx
, 200C
h
 ; 
EEPROM
 
d©a
 

726 
š
 
ax
, 
dx


727 
pİ
 
dx


729 
cmp
 
ax
, 6D50
h
 ; 3C
om
 
mªuçùu»r
 
ID


730 
jÃ
 .
nÙ_3com


732 ; 
Found
 
v®id
 3C515-
TX


733 
mov
 
ax
, 1

734 
jmp
 .
ex™


736 .
nÙ_3com
:

737 
mov
 
ax
, 0

739 .
ex™
:

740 
pİ
 
dx


741 
pİ
 
si


742 
pİ
 
cx


743 
pİ
 
bx


744 
pİ
 
bp


745 
»t


746 
´obe_3c515_©_add»ss
 
ENDP


749 ; 
d–ay_1us
 - 1 
miüo£cÚd
 
d–ay


751 ; 
IÅut
: 
NÚe


752 ; 
Ouut
: 
NÚe


753 ; 
U£s
: 
	`NÚe
 (
´e£rves
 
®l
 
»gi¡”s
)

755 
d–ay_1us
 
PROC


756 
push
 
cx


757 ; 
Aµroxim©e
 1Î¼
s
 
	`d–ay
 (
CPU
-
d•’d’t
, 
rough
 
e¡im©e
)

758 
mov
 
cx
, 3 ; 
Adju¡
 
CPU
 
¥“d


759 .
d–ay_loİ
:

760 
nİ


761 
loİ
 .
d–ay_loİ


762 
pİ
 
cx


763 
»t


764 
d–ay_1us
 
ENDP


767 ; 
h¬dw¬e_cÚfigu»_3c509b
 - 
CÚfigu»
 3C509B 
h¬dw¬e


769 ; 
IÅut
: 
AL
 = 
š¡ªû
 
šdex
, 
DX
 = 
I
/
O
 
ba£
 
add»ss


770 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


771 ; 
U£s
: 
AÎ
 
»gi¡”s


773 
h¬dw¬e_cÚfigu»_3c509b
 
PROC


774 
push
 
bp


775 
mov
 
bp
, 
¥


776 
push
 
bx


777 
push
 
cx


778 
push
 
dx


779 
push
 
si


781 ; 
Com¶‘e
 3C509B 
cÚfigu¿tiÚ
 
£qu’û


782 ; 
Save
 
š¡ªû
 
ªd
 
I
/
O
 
ba£


783 
push
 
ax
 ; 
Save
 
š¡ªû
 
šdex


784 
mov
 
si
, 
dx
 ; 
SI
 = 
I
/
O
 
ba£


786 ; 
S‹p
 1: 
Re£t
 
the
 
ad­‹r


787 
mov
 
dx
, 
si


788 
add
 
dx
, 
REG_COMMAND


789 
mov
 
ax
, 0000
h
 ; 
Glob®
 
»£t
 
commªd


790 
out
 
dx
, 
ax


792 ; 
Wa™
 
»£t
 
to
 
	`com¶‘e
 (~1
ms
)

793 
mov
 
cx
, 300

794 .
»£t_wa™
:

795 
š
 
®
, 80
h
 ; 
I
/
O
 
	`d–ay
 (~3.3u
s
)

796 
loİ
 .
»£t_wa™


798 ; 
S‹p
 2: 
S–eù
 
Wšdow
 0 
EEPROM
 
acûss


799 
mov
 
dx
, 
si


800 
add
 
dx
, 
REG_WINDOW


801 
mov
 
ax
, 0800
h
 ; 
CMD_SELECT_WINDOW
 | 0

802 
out
 
dx
, 
ax


804 ; 
S‹p
 3: 
R—d
 
MAC
 
add»ss
 
äom
 
EEPROM


805 
pİ
 
ax
 ; 
Re¡Üe
 
š¡ªû
 
šdex


806 
push
 
ax


807 
ÿÎ
 
»ad_mac_äom_“´om_3c509b


809 ; 
S‹p
 4: 
S–eù
 
Wšdow
 2 
to
 
£t
 
¡©iÚ
 
add»ss


810 
mov
 
dx
, 
si


811 
add
 
dx
, 
REG_WINDOW


812 
mov
 
ax
, 0802
h
 ; 
CMD_SELECT_WINDOW
 | 2

813 
out
 
dx
, 
ax


815 ; 
Wr™e
 
MAC
 
add»ss
 
to
 
¡©iÚ
‡dd»s 
»gi¡”s


816 
pİ
 
ax
 ; 
G‘
 
š¡ªû
 
šdex


817 
push
 
ax


818 
mov
 
bl
, 
®


819 
xÜ
 
bh
, bh

820 
shl
 
bx
, 1 ; 
WÜd
 
off£t


821 
shl
 
bx
, 1 ; 
x4


822 
shl
 
bx
, 1 ; 
x8
 6-
by‹
 
MAC


823 
mov
 
di
, 
OFFSET
 
hw_mac_add»s£s


824 
add
 
di
, 
bx


826 ; 
Wr™e
 6 
by‹s
 
of
 
MAC
 
to
 
Wšdow
 2, 
»gi¡”s
 0-5

827 
mov
 
cx
, 3 ; 3 
wÜds


828 
mov
 
dx
, 
si
 ; 
Ba£
 
add»ss


829 .
wr™e_mac
:

830 
mov
 
ax
, [
di
]

831 
out
 
dx
, 
ax


832 
add
 
dx
, 2

833 
add
 
di
, 2

834 
loİ
 .
wr™e_mac


836 ; 
S‹p
 5: 
CÚfigu»
 
medŸ
 
ty³
 
š
 
Wšdow
 3

837 
mov
 
dx
, 
si


838 
add
 
dx
, 
REG_WINDOW


839 
mov
 
ax
, 0803
h
 ; 
CMD_SELECT_WINDOW
 | 3

840 
out
 
dx
, 
ax


842 ; 
CÚfigu»
 
š‹º®
 
cÚfig
 (
off£t
 0)

843 
mov
 
dx
, 
si


844 
š
 
ax
, 
dx


845 
Ü
 
ax
, 0030
h
 ; 
EÇbË
 10Ba
£T


846 
out
 
dx
, 
ax


848 ; 
CÚfigu»
 
MAC
 
	$cÚŒŞ
 (
off£t
 6)

849 
mov
 
dx
, 
si


850 
add
 
dx
, 6

851 
š
 
ax
, 
dx


852 
ªd
 
ax
, 0FF8F
h
 ; 
CË¬
 
medŸ
 
b™s


853 
Ü
 
ax
, 0000
h
 ; 10Ba
	$£T
 (
b™s
 6:4 = 000)

854 
out
 
dx
, 
ax


856 ; 
S‹p
 6: 
S–eù
 
Œªsûiv”


857 
mov
 
dx
, 
si


858 
add
 
dx
, 
REG_COMMAND


859 
mov
 
ax
, 3000
h
 ; 
CMD_SELECT_XCVR
 | 10Ba
£T


860 
out
 
dx
, 
ax


862 ; 
S‹p
 7: 
S–eù
 
Wšdow
 1 
İ”©iÚ


863 
mov
 
ax
, 0801
h
 ; 
CMD_SELECT_WINDOW
 | 1

864 
out
 
dx
, 
ax


866 ; 
S‹p
 8: 
S‘
 
RX
 
	`f‹r
 (
¡©iÚ
 + 
brßdÿ¡
)

867 
mov
 
ax
, 0800
h
 | 05h ; 
SET_RX_FILTER
 | 
StiÚ
+
Brßdÿ¡


868 
out
 
dx
, 
ax


870 ; 
S‹p
 9: 
S‘
 
RX
 
—¾y
 
th»shŞd


871 
mov
 
ax
, 1000
h
 | 40h ; 
SET_RX_EARLY
 | 64 
by‹s


872 
out
 
dx
, 
ax


874 ; 
S‹p
 10: 
S‘
 
TX
 
avaabË
 
th»shŞd


875 
mov
 
ax
, 9800
h
 | 40h ; 
SET_TX_AVAIL
 | 64 
by‹s


876 
out
 
dx
, 
ax


878 ; 
S‹p
 11: 
EÇbË
 
»ûiv”


879 
mov
 
ax
, 2000
h
 ; 
RX_ENABLE


880 
out
 
dx
, 
ax


882 ; 
S‹p
 12: 
EÇbË
 
Œªsm™‹r


883 
mov
 
ax
, 4800
h
 ; 
TX_ENABLE


884 
out
 
dx
, 
ax


886 ; 
S‹p
 13: 
S‘
 
š‹¼u±
 
mask


887 
mov
 
ax
, 7000
h
 | 00FFh ; 
SET_INTR_MASK
 | 
AÎ
 
š‹¼u±s


888 
out
 
dx
, 
ax


890 ; 
S‹p
 14: 
CË¬
 
ªy
 
³ndšg
 
š‹¼u±s


891 
mov
 
ax
, 6800
h
 | 00FFh ; 
ACK_INTR
 | 
AÎ


892 
out
 
dx
, 
ax


894 ; 
V®id©e
 
š¡ªû
 
šdex


895 
pİ
 
ax
 ; 
Re¡Üe
 
š¡ªû


896 
cmp
 
®
, 
MAX_HW_INSTANCES


897 
j«
 .
šv®id_š¡ªû


899 ; 
M¬k
 
as
 
cÚfigu»d


900 
mov
 
bl
, 
®


901 
mov
 
bh
, 0

902 
mov
 
si
, 
OFFSET
 
hw_š¡ªûs


903 
add
 
si
, 
bx


904 
mov
 
by‹
 
±r
 [
si
], 
HW_STATE_CONFIGURED


906 ; 
Sucûss


907 
mov
 
ax
, 0

908 
jmp
 .
ex™


910 .
šv®id_š¡ªû
:

911 
mov
 
ax
, 1

912 
jmp
 .
ex™


914 .
ex™
:

915 
pİ
 
si


916 
pİ
 
dx


917 
pİ
 
cx


918 
pİ
 
bx


919 
pİ
 
bp


920 
»t


921 
h¬dw¬e_cÚfigu»_3c509b
 
ENDP


924 ; 
š™_3c515
 - 
In™Ÿlize
 3C515-
TX
 
w™h
 
DMA
 
£tup
 
ªd
 
bus
 
ma¡”šg


926 ; 
IÅut
: 
AL
 = 
š¡ªû
 
šdex
, 
DX
 = 
I
/
O
 
ba£
 
add»ss


927 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


928 ; 
U£s
: 
AÎ
 
»gi¡”s


930 
š™_3c515
 
PROC


931 
push
 
bp


932 
mov
 
bp
, 
¥


933 
push
 
bx


934 
push
 
cx


935 
push
 
dx


936 
push
 
si


937 
push
 
di


939 ; 
V®id©e
 
š¡ªû
 
šdex


940 
cmp
 
®
, 
MAX_HW_INSTANCES


941 
j«
 .
šv®id_š¡ªû


943 ; 
Save
 
·¿m‘”s


944 
mov
 
bl
, 
®
 ; 
Save
 
š¡ªû
 
šdex


945 
mov
 
si
, 
dx
 ; 
Save
 
I
/
O
 
ba£


947 ; 
TÙ®
 
»£t
 
fœ¡


948 
add
 
dx
, 0E
h
 ; 
Commªd
 

949 
mov
 
ax
, 0 ; 
TÙ®
 
»£t
 
commªd


950 
out
 
dx
, 
ax


952 ; 
Wa™
 
»£t
 
to
 
com¶‘e


953 
mov
 
cx
, 1000

954 .
»£t_wa™
:

955 
ÿÎ
 
d–ay_1ms


956 
loİ
 .
»£t_wa™


958 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
I
/
O
 
ba£


960 ; 
S–eù
 
wšdow
 0 
to
 
»ad
 
EEPROM
 
ªd
 
g‘
 
MAC
 
add»ss


961 
add
 
dx
, 0E
h


962 
mov
 
ax
, (1 << 11è| 0 ; 
S–eù
 
wšdow
 0

963 
out
 
dx
, 
ax


964 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


966 ; 
R—d
 
MAC
 
add»ss
 
äom
 
EEPROM


967 
ÿÎ
 
»ad_3c515_mac_add»ss


969 ; 
S–eù
 
wšdow
 2 
to
 
£t
 
MAC
 
add»ss


970 
add
 
dx
, 0E
h


971 
mov
 
ax
, (1 << 11è| 2 ; 
S–eù
 
wšdow
 2

972 
out
 
dx
, 
ax


973 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


975 ; 
Wr™e
 
MAC
 
add»ss
 
to
 
¡©iÚ
‡dd»s 
	`»gi¡”s
 (0-5)

976 ; 
Cİy
 
MAC
 
äom
 
EEPROM
 
to
 
¡©iÚ
 
add»ss
 
»gi¡”s


977 
push
 
si


978 
push
 
di


979 
push
 
cx


981 ; 
G‘
 
š¡ªû
 
MAC
 
add»ss
 
poš‹r


982 
mov
 
bl
, 
®
 ; 
In¡ªû
 
šdex


983 
xÜ
 
bh
, bh

984 
shl
 
bx
, 1

985 
shl
 
bx
, 1

986 
add
 
bx
, bx ; 
x6
 
MAC
 
size


987 
mov
 
si
, 
OFFSET
 
hw_mac_add»s£s


988 
add
 
si
, 
bx


990 ; 
S–eù
 
Wšdow
 2 
¡©iÚ
 
add»ss


991 
add
 
dx
, 0E
h


992 
mov
 
ax
, (1 << 11è| 2 ; 
S–eù
 
Wšdow
 2

993 
out
 
dx
, 
ax


994 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


996 ; 
Wr™e
 
MAC
 
to
 
»gi¡”s
 0-5

997 
mov
 
cx
, 3 ; 3 
wÜds


998 
xÜ
 
di
, d˜; 
S¹
 
©
 0

999 .
cİy_mac
:

1000 
mov
 
ax
, [
si
]

1001 
out
 
dx
, 
ax


1002 
add
 
dx
, 2

1003 
add
 
si
, 2

1004 
loİ
 .
cİy_mac


1006 
pİ
 
cx


1007 
pİ
 
di


1008 
pİ
 
si


1010 ; 
S–eù
 
wšdow
 3 
cÚfigu¿tiÚ


1011 
add
 
dx
, 0E
h


1012 
mov
 
ax
, (1 << 11è| 3 ; 
S–eù
 
wšdow
 3

1013 
out
 
dx
, 
ax


1014 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1016 ; 
CÚfigu»
 
medŸ
 
	`ty³
 (auto-
£Ëù
 10/100)

1017 
add
 
dx
, 8 ; 
O±iÚs
 

1018 
š
 
ax
, 
dx


1019 
Ü
 
ax
, 1000000
h
 ; 
EÇbË
‡uto-
£Ëù


1020 
out
 
dx
, 
ax


1021 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1023 ; 
S–eù
 
wšdow
 7 
bus
 
ma¡”
 
DMA
 
£tup


1024 
add
 
dx
, 0E
h


1025 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

1026 
out
 
dx
, 
ax


1027 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1029 ; 
In™Ÿlize
 
DMA
 
desütÜ
 
poš‹rs


1030 
add
 
dx
, 404
h
 ; 
Down
 
li¡
 
	$poš‹r
 (
TX
)

1031 
xÜ
 
ax
,‡x ; 
NULL
 
š™ŸÎy


1032 
out
 
dx
, 
ax
 ; 
Low
 
wÜd


1033 
add
 
dx
, 2

1034 
out
 
dx
, 
ax
 ; 
High
 
wÜd


1036 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1037 
add
 
dx
, 418
h
 ; 
Up
 
li¡
 
	$poš‹r
 (
RX
)

1038 
xÜ
 
ax
,‡x ; 
NULL
 
š™ŸÎy


1039 
out
 
dx
, 
ax
 ; 
Low
 
wÜd


1040 
add
 
dx
, 2

1041 
out
 
dx
, 
ax
 ; 
High
 
wÜd


1043 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1045 ; 
S–eù
 
wšdow
 1 
nÜm®
 
İ”©iÚ


1046 
add
 
dx
, 0E
h


1047 
mov
 
ax
, (1 << 11è| 1 ; 
S–eù
 
wšdow
 1

1048 
out
 
dx
, 
ax


1049 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1051 ; 
S‘
 
up
 
š‹¼u±
 
	$mask
 (
’abË
 
DMA
 
š‹¼u±s
)

1052 
add
 
dx
, 0E
h
 ; 
Commªd
 

1053 
mov
 
ax
, (14 << 11è| 07FF
h
 ; 
S‘
 
š‹¼u±
 
’abË
 
w™h
 
DMA
 
b™s


1054 
out
 
dx
, 
ax


1055 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1057 ; 
EÇbË
 
»ûiv”


1058 
add
 
dx
, 0E
h


1059 
mov
 
ax
, (4 << 11è; 
RX
 
EÇbË
 
commªd


1060 
out
 
dx
, 
ax


1061 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1063 ; 
EÇbË
 
Œªsm™‹r


1064 
add
 
dx
, 0E
h


1065 
mov
 
ax
, (9 << 11è; 
TX
 
EÇbË
 
commªd


1066 
out
 
dx
, 
ax


1067 
mov
 
dx
, 
si
 ; 
Re¡Üe
 
ba£


1069 ; 
S‘
 
RX
 
f‹r
 
to
 
»ûive
 
uniÿ¡
 + 
brßdÿ¡


1070 
add
 
dx
, 0E
h


1071 
mov
 
ax
, (16 << 11è| 5 ; 
S‘
 
RX
 
f‹r
: 
¡©iÚ
 + 
brßdÿ¡


1072 
out
 
dx
, 
ax


1074 ; 
M¬k
 
as
 
cÚfigu»d


1075 
mov
 
bh
, 0

1076 
mov
 
si
, 
OFFSET
 
hw_š¡ªûs


1077 
add
 
si
, 
bx


1078 
mov
 
by‹
 
±r
 [
si
], 
HW_STATE_CONFIGURED


1080 ; 
Sucûss


1081 
mov
 
ax
, 0

1082 
jmp
 .
ex™


1084 .
šv®id_š¡ªû
:

1085 
mov
 
ax
, 1

1086 
jmp
 .
ex™


1088 .
ex™
:

1089 
pİ
 
di


1090 
pİ
 
si


1091 
pİ
 
dx


1092 
pİ
 
cx


1093 
pİ
 
bx


1094 
pİ
 
bp


1095 
»t


1096 
š™_3c515
 
ENDP


1099 ; 
»ad_3c515_mac_add»ss
 - 
R—d
 
MAC
 
add»ss
 
äom
 3C515 
EEPROM


1101 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


1102 ; 
Ouut
: 
	`NÚe
 (
MAC
 
¡Üed
 
š‹º®ly
)

1103 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


1105 
»ad_3c515_mac_add»ss
 
PROC


1106 
push
 
bp


1107 
mov
 
bp
, 
¥


1108 
push
 
bx


1109 
push
 
cx


1110 
push
 
si


1111 
push
 
di


1113 ; 
R—d
 
MAC
 
add»ss
 
äom
 
EEPROM
 
loÿtiÚs
 0, 1, 2

1114 
mov
 
bx
, 0 ; 
EEPROM
 
add»ss
 
couÁ”


1115 
mov
 
di
, 
OFFSET
 
hw_mac_add»s£s
 ; 
De¡š©iÚ
 
bufãr


1117 .
»ad_mac_loİ
:

1118 ; 
S‘
 
EEPROM
 
add»ss


1119 
push
 
dx


1120 
add
 
dx
, 200A
h
 ; 
EEPROM
 
commªd
 

1121 
mov
 
ax
, 80
h
 ; 
R—d
 
commªd


1122 
Ü
 
ax
, 
bx
 ; 
OR
 
w™h
 
add»ss


1123 
out
 
dx
, 
ax


1124 
pİ
 
dx


1126 ; 
Wa™
 162Î¼
s
 
EEPROM


1127 
mov
 
cx
, 162

1128 .
mac_“´om_d–ay
:

1129 
ÿÎ
 
d–ay_1us


1130 
loİ
 .
mac_“´om_d–ay


1132 ; 
R—d
 
EEPROM
 
	`d©a
 (16-
b™
 
wÜd
)

1133 
push
 
dx


1134 
add
 
dx
, 0C
h
 ; 
EEPROM
 
d©a
 (
ISA
)

1135 
š
 
ax
, 
dx


1136 
pİ
 
dx


1138 ; 
StÜe
 
MAC
 
	$by‹s
 (
l™e
 
’dŸn
)

1139 
mov
 [
di
], 
®
 ; 
Low
 
by‹


1140 
šc
 
di


1141 
mov
 [
di
], 
ah
 ; 
High
 
by‹


1142 
šc
 
di


1144 
šc
 
bx
 ; 
Next
 
EEPROM
 
add»ss


1145 
cmp
 
bx
, 3 ; 
R—d
 3 
	$wÜds
 (6 
by‹s
)

1146 
jl
 .
»ad_mac_loİ


1148 
pİ
 
di


1149 
pİ
 
si


1150 
pİ
 
cx


1151 
pİ
 
bx


1152 
pİ
 
bp


1153 
»t


1154 
»ad_3c515_mac_add»ss
 
ENDP


1157 ; 
h¬dw¬e_»ad_·ck‘
 - 
R—d
 
·ck‘
 
äom
 
h¬dw¬e


1159 ; 
IÅut
: 
AL
 = 
NIC
 
šdex


1160 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


1161 ; 
U£s
: 
AÎ
 
»gi¡”s


1163 
h¬dw¬e_»ad_·ck‘
 
PROC


1164 
push
 
bp


1165 
mov
 
bp
, 
¥


1166 
push
 
bx


1167 
push
 
cx


1168 
push
 
dx


1169 
push
 
si


1170 
push
 
di


1172 ; 
V®id©e
 
NIC
 
šdex
, 
»ad
 
·ck‘
 
äom
 
­´İrŸ‹
 
h¬dw¬e
, 
ªd
 
hªdË
 
difã»Á
 NIC 
ty³s


1174 ; 
V®id©e
 
NIC
 
šdex


1175 
cmp
 
®
, 
MAX_HW_INSTANCES


1176 
j«
 .
šv®id_nic


1178 ; 
Check
 
NIC
 
ty³
 
ªd
 
di¥©ch
 
to
 
­´İrŸ‹
 
hªdËr


1179 
mov
 
bl
, 
®


1180 
mov
 
bh
, 0

1181 
mov
 
si
, 
OFFSET
 
hw_ty³s


1182 
add
 
si
, 
bx


1183 
mov
 
ş
, [
si
]

1185 
cmp
 
ş
, 1

1186 
je
 .
»ad_3c509b


1187 
cmp
 
ş
, 2

1188 
je
 .
»ad_3c515


1189 
jmp
 .
unknown_ty³


1191 .
»ad_3c509b
:

1192 ; 
R—d
 
·ck‘
 
äom
 3C509B 
usšg
 
PIO


1193 
push
 
es


1194 
push
 
di


1195 
push
 
si


1196 
push
 
cx


1197 
push
 
bx


1199 ; 
G‘
 
I
/
O
 
ba£
 
this
 
š¡ªû


1200 
mov
 
bl
, 
®


1201 
xÜ
 
bh
, bh

1202 
shl
 
bx
, 1 ; 
WÜd
 
off£t


1203 
mov
 
si
, 
OFFSET
 
hw_ioba£_bË


1204 
mov
 
dx
, [
si
+
bx
] ; 
DX
 = 
I
/
O
 
ba£


1205 
mov
 
si
, 
dx
 ; 
Save
 
š
 
SI


1207 ; 
S–eù
 
Wšdow
 1 
RX
 
İ”©iÚs


1208 
add
 
dx
, 
REG_WINDOW


1209 
mov
 
ax
, 0801
h
 ; 
CMD_SELECT_WINDOW
 | 1

1210 
out
 
dx
, 
ax


1212 ; 
Check
 
RX
 
¡©us


1213 
mov
 
dx
, 
si


1214 
add
 
dx
, 08
h
 ; 
RX_STATUS
 

1215 
š
 
ax
, 
dx


1216 
‹¡
 
ax
, 8000
h
 ; 
RX_COMPLETE
 
b™


1217 
jz
 .
no_·ck‘_3c509b


1219 ; 
G‘
 
·ck‘
 
Ëngth


1220 
ªd
 
ax
, 07FF
h
 ; 
ExŒaù
 
	$Ëngth
 (11 
b™s
)

1221 
mov
 
cx
, 
ax
 ; 
CX
 = 
·ck‘
 
Ëngth


1223 ; 
V®id©e
 
·ck‘
 
Ëngth


1224 
cmp
 
cx
, 1514

1225 
ja
 .
bad_·ck‘_3c509b


1226 
cmp
 
cx
, 14

1227 
jb
 .
bad_·ck‘_3c509b


1229 ; 
ES
:
DI
 
pošts
 
to
 
»ûive
 
	`bufãr
 (
·s£d
 
š
 
BP
+8)

1230 
Ës
 
di
, [
bp
+8]

1232 ; 
Save
 
·ck‘
 
Ëngth


1233 
push
 
cx


1235 ; 
R—d
 
·ck‘
 
äom
 
RX
 
FIFO


1236 
mov
 
dx
, 
si
 ; 
I
/
O
 
ba£


1237 
add
 
dx
, 00
h
 ; 
RX_FIFO
 

1239 ; 
O±imize
 
wÜd
 
»ads


1240 
shr
 
cx
, 1 ; 
CÚv”t
 
to
 
wÜd
 
couÁ


1241 
jz
 .
»ad_Ï¡_by‹_3c509b


1243 .
»ad_loİ_3c509b
:

1244 
š
 
ax
, 
dx
 ; 
R—d
 
wÜd
 
äom
 
FIFO


1245 
¡osw
 ; 
StÜe
 
to
 
ES
:
DI


1246 
loİ
 .
»ad_loİ_3c509b


1248 .
»ad_Ï¡_by‹_3c509b
:

1249 
pİ
 
cx
 ; 
Re¡Üe
 
·ck‘
 
Ëngth


1250 
‹¡
 
cx
, 1 ; 
Check
 
odd
 
by‹


1251 
jz
 .
»ad_dÚe_3c509b


1252 
š
 
®
, 
dx
 ; 
R—d
 
sšgË
 
by‹


1253 
¡osb


1255 .
»ad_dÚe_3c509b
:

1256 ; 
Disÿrd
 
·ck‘
 
äom
 
	`FIFO
 (
»quœed
!)

1257 
mov
 
dx
, 
si


1258 
add
 
dx
, 
REG_COMMAND


1259 
mov
 
ax
, 4000
h
 ; 
CMD_RX_DISCARD


1260 
out
 
dx
, 
ax


1262 ; 
Wa™
 
disÿrd
 
to
 
com¶‘e


1263 
mov
 
cx
, 100

1264 .
wa™_disÿrd_3c509b
:

1265 
mov
 
dx
, 
si


1266 
add
 
dx
, 08
h
 ; 
RX_STATUS


1267 
š
 
ax
, 
dx


1268 
‹¡
 
ax
, 1000
h
 ; 
RX_EARLY
 
b™


1269 
jz
 .
disÿrd_dÚe_3c509b


1270 
push
 
cx


1271 
mov
 
cx
, 3

1272 .
d–ay_3c509b
:

1273 
š
 
®
, 80
h
 ; 
I
/
O
 
d–ay


1274 
loİ
 .
d–ay_3c509b


1275 
pİ
 
cx


1276 
loİ
 .
wa™_disÿrd_3c509b


1278 .
disÿrd_dÚe_3c509b
:

1279 
mov
 
ax
, 
cx
 ; 
R‘uº
 
·ck‘
 
Ëngth


1280 
jmp
 .
ş—nup_rx_3c509b


1282 .
bad_·ck‘_3c509b
:

1283 ; 
Disÿrd
 
bad
 
·ck‘


1284 
mov
 
dx
, 
si


1285 
add
 
dx
, 
REG_COMMAND


1286 
mov
 
ax
, 4000
h
 ; 
CMD_RX_DISCARD


1287 
out
 
dx
, 
ax


1289 .
no_·ck‘_3c509b
:

1290 
xÜ
 
ax
,‡x ; 
No
 
·ck‘
/
”rÜ


1292 .
ş—nup_rx_3c509b
:

1293 
pİ
 
bx


1294 
pİ
 
cx


1295 
pİ
 
si


1296 
pİ
 
di


1297 
pİ
 
es


1298 
jmp
 .
ex™


1300 .
»ad_3c515
:

1301 ; 
R—d
 
·ck‘
 
äom
 3C515-
	$TX
 (
DMA
 
Ü
 
PIO
 
mode
)

1302 
push
 
es


1303 
push
 
di


1304 
push
 
si


1305 
push
 
cx


1306 
push
 
bx


1308 ; 
G‘
 
I
/
O
 
ba£
 
ªd
 
check
 
DMA
 
mode


1309 
mov
 
bl
, 
®


1310 
xÜ
 
bh
, bh

1311 
shl
 
bx
, 1

1312 
mov
 
si
, 
OFFSET
 
hw_ioba£_bË


1313 
mov
 
dx
, [
si
+
bx
]

1314 
mov
 
si
, 
dx


1316 ; 
Check
 
bus
 
ma¡”
 
DMA
 
is
 
’abËd


1317 
mov
 
di
, 
OFFSET
 
hw_æags_bË


1318 
mov
 
bl
, [
di
+
bx
]

1319 
‹¡
 
bl
, 01
h
 ; 
FLAG_BUS_MASTER


1320 
jz
 .
u£_pio_3c515


1322 ; 
DMA
 
mode
 - 
S–eù
 
Wšdow
 7

1323 
add
 
dx
, 
REG_WINDOW


1324 
mov
 
ax
, 0807
h
 ; 
CMD_SELECT_WINDOW
 | 7

1325 
out
 
dx
, 
ax


1327 ; 
Check
 
	$UP
 (
RX
è
li¡
 
¡©us


1328 
mov
 
dx
, 
si


1329 
add
 
dx
, 38
h
 ; 
UP_PKT_STATUS


1330 
š
 
ax
, 
dx


1331 
š
 
dx
, dx ; 
R—d
 
high
 
wÜd


1332 
‹¡
 
ax
, 8000
h
 ; 
Com¶‘e
 
b™


1333 
jz
 .
no_dma_·ck‘_3c515


1335 ; 
ExŒaù
 
·ck‘
 
Ëngth


1336 
ªd
 
ax
, 1FFF
h
 ; 13-
b™
 
Ëngth


1337 
mov
 
cx
, 
ax


1339 ; 
G‘
 
·ck‘
 
äom
 
DMA
 
bufãr


1340 ; (
Im¶em’tiÚ
 
d•’ds
 
Ú
 
DMA
 
bufãr
 
mªagem’t
)

1342 ; 
AcknowËdge
 
DMA
 
com¶‘iÚ


1343 
mov
 
dx
, 
si


1344 
add
 
dx
, 
REG_COMMAND


1345 
mov
 
ax
, 6800
h
 | 0200h ; 
ACK_INTR
 | 
UP_COMPLETE


1346 
out
 
dx
, 
ax


1348 
mov
 
ax
, 
cx
 ; 
R‘uº
 
Ëngth


1349 
jmp
 .
ş—nup_rx_3c515


1351 .
u£_pio_3c515
:

1352 ; 
PIO
 
mode
 - 
sim¬
 
to
 3C509B

1353 
add
 
dx
, 
REG_WINDOW


1354 
mov
 
ax
, 0801
h


1355 
out
 
dx
, 
ax


1357 
mov
 
dx
, 
si


1358 
add
 
dx
, 18
h
 ; 
RX_STATUS
 3C515

1359 
š
 
ax
, 
dx


1360 
‹¡
 
ax
, 8000
h


1361 
jz
 .
no_·ck‘_3c515


1363 
ªd
 
ax
, 1FFF
h
 ; 13-
b™
 
Ëngth
 3C515

1364 
mov
 
cx
, 
ax


1366 
cmp
 
cx
, 1514

1367 
ja
 .
bad_·ck‘_3c515


1368 
cmp
 
cx
, 14

1369 
jb
 .
bad_·ck‘_3c515


1371 
Ës
 
di
, [
bp
+8]

1372 
push
 
cx


1374 
mov
 
dx
, 
si


1375 
add
 
dx
, 10
h
 ; 
RX_FIFO
 3C515

1376 
shr
 
cx
, 1

1377 
jz
 .
»ad_Ï¡_3c515


1379 .
»ad_loİ_3c515
:

1380 
š
 
ax
, 
dx


1381 
¡osw


1382 
loİ
 .
»ad_loİ_3c515


1384 .
»ad_Ï¡_3c515
:

1385 
pİ
 
cx


1386 
‹¡
 
cx
, 1

1387 
jz
 .
»ad_dÚe_3c515


1388 
š
 
®
, 
dx


1389 
¡osb


1391 .
»ad_dÚe_3c515
:

1392 
mov
 
dx
, 
si


1393 
add
 
dx
, 
REG_COMMAND


1394 
mov
 
ax
, 4000
h


1395 
out
 
dx
, 
ax


1397 
mov
 
ax
, 
cx


1398 
jmp
 .
ş—nup_rx_3c515


1400 .
bad_·ck‘_3c515
:

1401 
mov
 
dx
, 
si


1402 
add
 
dx
, 
REG_COMMAND


1403 
mov
 
ax
, 4000
h


1404 
out
 
dx
, 
ax


1406 .
no_·ck‘_3c515
:

1407 .
no_dma_·ck‘_3c515
:

1408 
xÜ
 
ax
,‡x

1410 .
ş—nup_rx_3c515
:

1411 
pİ
 
bx


1412 
pİ
 
cx


1413 
pİ
 
si


1414 
pİ
 
di


1415 
pİ
 
es


1416 
jmp
 .
ex™


1418 .
šv®id_nic
:

1419 
mov
 
ax
, 1

1420 
jmp
 .
ex™


1422 .
unknown_ty³
:

1423 
mov
 
ax
, 2

1424 
jmp
 .
ex™


1426 .
ex™
:

1427 
pİ
 
di


1428 
pİ
 
si


1429 
pİ
 
dx


1430 
pİ
 
cx


1431 
pİ
 
bx


1432 
pİ
 
bp


1433 
»t


1434 
h¬dw¬e_»ad_·ck‘
 
ENDP


1437 ; 
h¬dw¬e_£nd_·ck‘_asm
 - 
S’d
 
·ck‘
 
vŸ
 
h¬dw¬e


1439 ; 
IÅut
: 
DS
:
SI
 = 
·ck‘
 
d©a
, 
CX
 =…ack‘ 
Ëngth


1440 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


1441 ; 
U£s
: 
AÎ
 
»gi¡”s


1443 
h¬dw¬e_£nd_·ck‘_asm
 
PROC


1444 
push
 
bp


1445 
mov
 
bp
, 
¥


1446 
push
 
bx


1447 
push
 
cx


1448 
push
 
dx


1449 
push
 
si


1450 
push
 
di


1452 ; 
Com¶‘e
 
·ck‘
 
ŒªsmissiÚ
 
im¶em’tiÚ


1454 ; 
Basic
 
·ck‘
 
v®id©iÚ


1455 
cmp
 
cx
, 60 ; 
Mšimum
 
Eth”Ãt
 
äame


1456 
jb
 .
šv®id_·ck‘


1457 
cmp
 
cx
, 1514 ; 
Maximum
 
Eth”Ãt
 
äame


1458 
ja
 .
šv®id_·ck‘


1460 ; 
G‘
 
cu¼’t
 
NIC
 
š¡ªû
 
ªd
 
v®id©e


1461 
mov
 
®
, [
cu¼’t_š¡ªû
]

1462 
cmp
 
®
, 
MAX_HW_INSTANCES


1463 
j«
 .
no_aùive_nic


1465 ; 
G‘
 
NIC
 
ty³
 
ªd
 
I
/
O
 
ba£


1466 
mov
 
bl
, 
®


1467 
xÜ
 
bh
, bh

1468 
mov
 
di
, 
OFFSET
 
hw_ty³_bË


1469 
mov
 
ş
, [
di
+
bx
] ; 
CL
 = 
NIC
 
ty³


1471 
shl
 
bx
, 1 ; 
WÜd
 
off£t


1472 
mov
 
di
, 
OFFSET
 
hw_ioba£_bË


1473 
mov
 
dx
, [
di
+
bx
] ; 
DX
 = 
I
/
O
 
ba£


1474 
‹¡
 
dx
, dx

1475 
jz
 .
no_aùive_nic


1477 ; 
B¿nch
 
ba£d
 
Ú
 
NIC
 
ty³


1478 
cmp
 
ş
, 1 ; 3C509B

1479 
je
 .
tx_3c509b


1480 
cmp
 
ş
, 2 ; 3C515

1481 
je
 .
tx_3c515


1482 
jmp
 .
no_aùive_nic


1484 .
tx_3c509b
:

1485 ; 
T¿nsm™
 
·ck‘
 
Ú
 3C509B

1486 
push
 
si


1487 
push
 
cx


1488 
push
 
bx


1490 
mov
 
bx
, 
dx
 ; 
Save
 
I
/
O
 
ba£


1492 ; 
S–eù
 
Wšdow
 1 
TX


1493 
add
 
dx
, 
REG_WINDOW


1494 
mov
 
ax
, 0801
h
 ; 
CMD_SELECT_WINDOW
 | 1

1495 
out
 
dx
, 
ax


1496 
mov
 
dx
, 
bx
 ; 
Re¡Üe
 
ba£


1498 ; 
Check
 
TX
 
¥aû
 
avaabË


1499 
add
 
dx
, 0C
h
 ; 
TX_FREE
 

1500 
š
 
ax
, 
dx


1501 
cmp
 
ax
, 
cx
 ; 
Com·»
 
w™h
 
·ck‘
 
Ëngth


1502 
jb
 .
tx_busy


1504 ; 
S‘
 
TX
 
·ck‘
 
Ëngth


1505 
mov
 
dx
, 
bx


1506 
add
 
dx
, 
REG_COMMAND


1507 
mov
 
ax
, 9000
h
 ; 
CMD_TX_SET_LEN


1508 
Ü
 
ax
, 
cx
 ; 
Inşude
 
Ëngth


1509 
out
 
dx
, 
ax


1511 ; 
Check
 
TX
 
¡®l


1512 
mov
 
dx
, 
bx


1513 
add
 
dx
, 0B
h
 ; 
TX_STATUS


1514 
š
 
®
, 
dx


1515 
‹¡
 
®
, 04
h
 ; 
STALL
 
b™


1516 
jz
 .
no_¡®l_3c509b


1518 ; 
CË¬
 
¡®l


1519 
mov
 
dx
, 
bx


1520 
add
 
dx
, 
REG_COMMAND


1521 
mov
 
ax
, 5800
h
 ; 
CMD_TX_RESET


1522 
out
 
dx
, 
ax


1524 ; 
Re
-
’abË
 
TX


1525 
mov
 
ax
, 4800
h
 ; 
CMD_TX_ENABLE


1526 
out
 
dx
, 
ax


1528 .
no_¡®l_3c509b
:

1529 ; 
Wr™e
 
·ck‘
 
to
 
TX
 
FIFO


1530 
mov
 
dx
, 
bx


1531 
add
 
dx
, 00
h
 ; 
TX_FIFO


1533 
push
 
cx


1534 
shr
 
cx
, 1 ; 
WÜd
 
couÁ


1535 
jz
 .
tx_Ï¡_by‹_3c509b


1537 .
tx_loİ_3c509b
:

1538 
lodsw
 ; 
Lßd
 
äom
 
DS
:
SI


1539 
out
 
dx
, 
ax
 ; 
Wr™e
 
to
 
FIFO


1540 
loİ
 .
tx_loİ_3c509b


1542 .
tx_Ï¡_by‹_3c509b
:

1543 
pİ
 
cx


1544 
‹¡
 
cx
, 1

1545 
jz
 .
tx_¡¬t_3c509b


1546 
lodsb


1547 
out
 
dx
, 
®


1549 .
tx_¡¬t_3c509b
:

1550 ; 
S¹
 
ŒªsmissiÚ


1551 
mov
 
dx
, 
bx


1552 
add
 
dx
, 
REG_COMMAND


1553 
mov
 
ax
, 4800
h
 ; 
CMD_TX_START


1554 
out
 
dx
, 
ax


1556 
xÜ
 
ax
,‡x ; 
Sucûss


1557 
pİ
 
bx


1558 
pİ
 
cx


1559 
pİ
 
si


1560 
jmp
 .
ex™


1562 .
tx_3c515
:

1563 ; 
T¿nsm™
 
·ck‘
 
Ú
 3C515-
TX


1564 
push
 
si


1565 
push
 
cx


1566 
push
 
bx


1568 
mov
 
bx
, 
dx
 ; 
Save
 
ba£


1570 ; 
Check
 
usšg
 
DMA


1571 
push
 
bx


1572 
shr
 
bx
, 1

1573 
mov
 
di
, 
OFFSET
 
hw_æags_bË


1574 
mov
 
®
, [
di
+
bx
]

1575 
pİ
 
bx


1576 
‹¡
 
®
, 01
h
 ; 
FLAG_BUS_MASTER


1577 
jz
 .
tx_pio_3c515


1579 ; 
DMA
 
	`ŒªsmissiÚ
 (
sim¶if›d
)

1580 ; 
Would
 
Ãed
 
´İ”
 
desütÜ
 
£tup


1581 
jmp
 .
tx_busy


1583 .
tx_pio_3c515
:

1584 ; 
PIO
 
mode
 - 
sim¬
 
to
 3C509B

1585 
add
 
dx
, 
REG_WINDOW


1586 
mov
 
ax
, 0801
h


1587 
out
 
dx
, 
ax


1588 
mov
 
dx
, 
bx


1590 
add
 
dx
, 1C
h
 ; 
TX_FREE
 3C515

1591 
š
 
ax
, 
dx


1592 
cmp
 
ax
, 
cx


1593 
jb
 .
tx_busy


1595 
mov
 
dx
, 
bx


1596 
add
 
dx
, 
REG_COMMAND


1597 
mov
 
ax
, 9000
h


1598 
Ü
 
ax
, 
cx


1599 
out
 
dx
, 
ax


1601 
mov
 
dx
, 
bx


1602 
add
 
dx
, 10
h
 ; 
TX_FIFO
 3C515

1604 
push
 
cx


1605 
shr
 
cx
, 1

1606 
jz
 .
tx_Ï¡_3c515


1608 .
tx_loİ_3c515
:

1609 
lodsw


1610 
out
 
dx
, 
ax


1611 
loİ
 .
tx_loİ_3c515


1613 .
tx_Ï¡_3c515
:

1614 
pİ
 
cx


1615 
‹¡
 
cx
, 1

1616 
jz
 .
tx_¡¬t_3c515


1617 
lodsb


1618 
out
 
dx
, 
®


1620 .
tx_¡¬t_3c515
:

1621 
mov
 
dx
, 
bx


1622 
add
 
dx
, 
REG_COMMAND


1623 
mov
 
ax
, 4800
h


1624 
out
 
dx
, 
ax


1626 
xÜ
 
ax
,‡x

1627 
pİ
 
bx


1628 
pİ
 
cx


1629 
pİ
 
si


1630 
jmp
 .
ex™


1632 .
tx_busy
:

1633 
mov
 
ax
, 
ERROR_BUSY


1634 
jmp
 .
ex™


1635 ; 
Sucûss


1636 
mov
 
ax
, 0

1637 
jmp
 .
ex™


1639 .
šv®id_·ck‘
:

1640 
mov
 
ax
, 1

1641 
jmp
 .
ex™


1643 .
no_aùive_nic
:

1644 
mov
 
ax
, 2

1645 
jmp
 .
ex™


1647 .
ex™
:

1648 
pİ
 
di


1649 
pİ
 
si


1650 
pİ
 
dx


1651 
pİ
 
cx


1652 
pİ
 
bx


1653 
pİ
 
bp


1654 
»t


1655 
h¬dw¬e_£nd_·ck‘_asm
 
ENDP


1658 ; 
h¬dw¬e_g‘_add»ss
 - 
G‘
 
MAC
 
add»ss
 
äom
 
h¬dw¬e


1660 ; 
IÅut
: 
AL
 = 
NIC
 
šdex
, 
ES
:
DI
 = 
	`bufãr
 (6 
by‹s
)

1661 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


1662 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
SI
, 
DI


1664 
h¬dw¬e_g‘_add»ss
 
PROC


1665 
push
 
bp


1666 
mov
 
bp
, 
¥


1667 
push
 
bx


1668 
push
 
cx


1669 
push
 
si


1671 ; 
R—d
 
MAC
 
add»ss
 
äom
 
h¬dw¬e
 
EEPROM


1673 ; 
V®id©e
 
NIC
 
šdex


1674 
cmp
 
®
, 
MAX_HW_INSTANCES


1675 
j«
 .
šv®id_nic


1677 
push
 
ax
 ; 
Save
 
š¡ªû


1679 ; 
G‘
 
NIC
 
ty³
 
ªd
 
I
/
O
 
ba£


1680 
mov
 
bl
, 
®


1681 
xÜ
 
bh
, bh

1682 
mov
 
si
, 
OFFSET
 
hw_ty³_bË


1683 
mov
 
ş
, [
si
+
bx
] ; 
CL
 = 
NIC
 
ty³


1685 
shl
 
bx
, 1 ; 
WÜd
 
off£t


1686 
mov
 
si
, 
OFFSET
 
hw_ioba£_bË


1687 
mov
 
dx
, [
si
+
bx
] ; 
DX
 = 
I
/
O
 
ba£


1689 ; 
B¿nch
 
ba£d
 
Ú
 
NIC
 
ty³


1690 
cmp
 
ş
, 1 ; 3C509B

1691 
je
 .
»ad_mac_3c509b


1692 
cmp
 
ş
, 2 ; 3C515

1693 
je
 .
»ad_mac_3c515


1695 ; 
U£
 
ÿched
 
MAC
 
ty³
 
unknown


1696 
jmp
 .
u£_ÿched_mac


1698 .
»ad_mac_3c509b
:

1699 ; 
S–eù
 
Wšdow
 0 
EEPROM


1700 
add
 
dx
, 
REG_WINDOW


1701 
mov
 
ax
, 0800
h
 ; 
CMD_SELECT_WINDOW
 | 0

1702 
out
 
dx
, 
ax


1703 
sub
 
dx
, 
REG_WINDOW
 ; 
Back
 
to
 
ba£


1705 ; 
R—d
 3 
wÜds
 
of
 
MAC
 
äom
 
EEPROM
 
add»s£s
 0-2

1706 
xÜ
 
si
, s˜; 
EEPROM
 
add»ss


1707 
mov
 
cx
, 3 ; 3 
wÜds


1709 .
»ad_“´om_3c509b
:

1710 
push
 
cx


1711 ; 
S’d
 
EEPROM
 
»ad
 
commªd


1712 
mov
 
ax
, 
dx
 ; 
Save
 
ba£


1713 
add
 
dx
, 0A
h
 ; 
EEPROM
 
commªd
 

1714 
mov
 
cx
, 80
h
 ; 
EEPROM_READ_CMD


1715 
Ü
 
cx
, 
si
 ; 
Add
 
add»ss


1716 
mov
 
ax
, 
cx


1717 
out
 
dx
, 
ax


1719 ; 
Wa™
 
EEPROM
 
	$»ady
 (162u
s
 
typiÿl
)

1720 
mov
 
cx
, 50 ; 
R‘ry
 
couÁ


1721 .
wa™_“´om_3c509b
:

1722 
push
 
cx


1723 
mov
 
cx
, 6 ; ~20u
s
 
d–ay


1724 .
d–ay_“´om
:

1725 
š
 
®
, 80
h
 ; 
I
/
O
 
d–ay


1726 
loİ
 .
d–ay_“´om


1727 
pİ
 
cx


1729 
š
 
ax
, 
dx
 ; 
Check
 
¡©us


1730 
‹¡
 
ah
, 80
h
 ; 
EEPROM_BUSY
 
b™


1731 
jz
 .
“´om_»ady_3c509b


1732 
loİ
 .
wa™_“´om_3c509b


1734 ; 
Timeout
 - 
u£
 
ÿched


1735 
pİ
 
cx


1736 
jmp
 .
u£_ÿched_mac


1738 .
“´om_»ady_3c509b
:

1739 ; 
R—d
 
d©a
 
wÜd


1740 
mov
 
ax
, 
dx


1741 
sub
 
ax
, 0A
h
 ; 
Back
 
to
 
ba£


1742 
mov
 
dx
, 
ax


1743 
add
 
dx
, 0C
h
 ; 
EEPROM
 
d©a
 

1744 
š
 
ax
, 
dx


1746 ; 
StÜe
 
š
 
	$bufãr
 (
cÚv”t
 
’dŸÂess
)

1747 
xchg
 
ah
, 
®


1748 
¡osw
 ; 
StÜe
 
to
 
ES
:
DI


1750 
mov
 
dx
, 
ax
 ; 
Re¡Üe
 
ba£


1751 
sub
 
dx
, 0C
h


1752 
šc
 
si
 ; 
Next
 
EEPROM
 
add»ss


1753 
pİ
 
cx


1754 
loİ
 .
»ad_“´om_3c509b


1756 
jmp
 .
mac_»ad_dÚe


1758 .
»ad_mac_3c515
:

1759 ; 
Sim¬
 
´oûss
 3C515

1760 
add
 
dx
, 
REG_WINDOW


1761 
mov
 
ax
, 0800
h


1762 
out
 
dx
, 
ax


1763 
sub
 
dx
, 
REG_WINDOW


1765 
mov
 
si
, 0A
h
 ; 
MAC
 
¡¬ts
 
©
 0x0A 
š
 3C515 
EEPROM


1766 
mov
 
cx
, 3

1768 .
»ad_“´om_3c515
:

1769 
push
 
cx


1770 
add
 
dx
, 0A
h


1771 
mov
 
ax
, 200
h
 ; 
EEPROM_READ_3C515


1772 
Ü
 
ax
, 
si


1773 
out
 
dx
, 
ax


1775 
mov
 
cx
, 100

1776 .
wa™_3c515
:

1777 
push
 
cx


1778 
mov
 
cx
, 10

1779 .
d–ay_3c515
:

1780 
š
 
®
, 80
h


1781 
loİ
 .
d–ay_3c515


1782 
pİ
 
cx


1784 
š
 
ax
, 
dx


1785 
‹¡
 
ah
, 80
h


1786 
jz
 .
»ady_3c515


1787 
loİ
 .
wa™_3c515


1789 
pİ
 
cx


1790 
jmp
 .
u£_ÿched_mac


1792 .
»ady_3c515
:

1793 
add
 
dx
, 2 ; 
D©a
 

1794 
š
 
ax
, 
dx


1795 
xchg
 
ah
, 
®


1796 
¡osw


1797 
sub
 
dx
, 2

1798 
sub
 
dx
, 0A
h


1799 
šc
 
si


1800 
pİ
 
cx


1801 
loİ
 .
»ad_“´om_3c515


1803 
jmp
 .
mac_»ad_dÚe


1805 .
u£_ÿched_mac
:

1806 ; 
F®l
 
back
 
to
 
ÿched
 
MAC
 
add»ss


1807 
pİ
 
ax
 ; 
Re¡Üe
 
š¡ªû


1808 
push
 
ax


1809 
mov
 
bl
, 
®


1810 
xÜ
 
bh
, bh

1811 
mov
 
ş
, 6

1812 
mov
 
®
, 
bl


1813 
mul
 
ş
 ; 
AX
 = 
šdex
 * 6

1814 
mov
 
si
, 
OFFSET
 
hw_mac_add»s£s


1815 
add
 
si
, 
ax


1816 
mov
 
cx
, 6

1817 
»p
 
movsb


1819 .
mac_»ad_dÚe
:

1820 
pİ
 
ax
 ; 
Re¡Üe
 
š¡ªû


1822 ; 
Sucûss


1823 
mov
 
ax
, 0

1824 
jmp
 .
ex™


1826 .
šv®id_nic
:

1827 
mov
 
ax
, 1

1828 
jmp
 .
ex™


1830 .
ex™
:

1831 
pİ
 
si


1832 
pİ
 
cx


1833 
pİ
 
bx


1834 
pİ
 
bp


1835 
»t


1836 
h¬dw¬e_g‘_add»ss
 
ENDP


1839 ; 
»ad_mac_äom_“´om_3c509b
 - 
R—d
 
MAC
 
add»ss
 
äom
 3C509B 
EEPROM


1841 ; 
IÅut
: 
AL
 = 
š¡ªû
 
šdex
, 
SI
 = 
I
/
O
 
ba£
 
add»ss


1842 ; 
Ouut
: 
MAC
 
add»ss
 
¡Üed
 
š
 
hw_mac_add»s£s
 
š¡ªû


1843 ; 
U£s
: 
AÎ
 
»gi¡”s


1845 
»ad_mac_äom_“´om_3c509b
 
PROC


1846 
push
 
bp


1847 
mov
 
bp
, 
¥


1848 
push
 
bx


1849 
push
 
cx


1850 
push
 
dx


1851 
push
 
di


1852 
push
 
si


1854 ; 
C®cuÏ‹
 
MAC
 
¡Üage
 
off£t


1855 
mov
 
bl
, 
®


1856 
xÜ
 
bh
, bh

1857 
mov
 
ş
, 6

1858 
mov
 
®
, 
bl


1859 
mul
 
ş
 ; 
AX
 = 
šdex
 * 6

1860 
mov
 
di
, 
OFFSET
 
hw_mac_add»s£s


1861 
add
 
di
, 
ax
 ; 
DI
 = 
MAC
 
¡Üage
 
loÿtiÚ


1863 ; 
S–eù
 
Wšdow
 0 
EEPROM
 
acûss


1864 
mov
 
dx
, 
si


1865 
add
 
dx
, 
REG_WINDOW


1866 
mov
 
ax
, 0800
h
 ; 
CMD_SELECT_WINDOW
 | 0

1867 
out
 
dx
, 
ax


1869 ; 
R—d
 3 
wÜds
 
of
 
MAC
 
add»ss
 
äom
 
EEPROM


1870 
xÜ
 
bx
, bx ; 
EEPROM
 
add»ss
 
couÁ”


1871 
mov
 
cx
, 3 ; 3 
wÜds
 
to
 
»ad


1873 .
»ad_mac_loİ
:

1874 
push
 
cx


1876 ; 
S’d
 
EEPROM
 
»ad
 
commªd


1877 
mov
 
dx
, 
si


1878 
add
 
dx
, 0A
h
 ; 
EEPROM
 
commªd
 

1879 
mov
 
ax
, 80
h
 ; 
EEPROM_READ_CMD


1880 
Ü
 
ax
, 
bx
 ; 
Add
 
	`add»ss
 (0-2)

1881 
out
 
dx
, 
ax


1883 ; 
Wa™
 
EEPROM
 
	$»ady
 (162u
s
 
typiÿl
, 1
ms
 
max
)

1884 
mov
 
cx
, 50 ; 
R‘ry
 
couÁ


1885 .
wa™_“´om
:

1886 
push
 
cx


1887 ; 
D–ay
 ~20u
s


1888 
mov
 
cx
, 6

1889 .
d–ay_loİ
:

1890 
š
 
®
, 80
h
 ; 
I
/
O
 
d–ay


1891 
loİ
 .
d–ay_loİ


1892 
pİ
 
cx


1894 ; 
Check
 
EEPROM
 
busy
 
b™


1895 
š
 
ax
, 
dx


1896 
‹¡
 
ah
, 80
h
 ; 
EEPROM_BUSY
 
b™


1897 
jz
 .
“´om_»ady


1898 
loİ
 .
wa™_“´om


1900 ; 
Timeout
 - 
u£
  
MAC


1901 
pİ
 
cx


1902 
jmp
 .
u£_deçuÉ_mac


1904 .
“´om_»ady
:

1905 ; 
R—d
 
the
 
d©a
 
wÜd


1906 
mov
 
dx
, 
si


1907 
add
 
dx
, 0C
h
 ; 
EEPROM
 
d©a
 

1908 
š
 
ax
, 
dx


1910 ; 
StÜe
 
š
 
MAC
 
	$bufãr
 (
cÚv”t
 
’dŸÂess
)

1911 
xchg
 
ah
, 
®


1912 
mov
 [
di
], 
ax


1913 
add
 
di
, 2

1914 
šc
 
bx
 ; 
Next
 
EEPROM
 
add»ss


1915 
pİ
 
cx


1916 
loİ
 .
»ad_mac_loİ


1918 
jmp
 .
mac_»ad_com¶‘e


1920 .
u£_deçuÉ_mac
:

1921 ; 
S‘
  
MAC
 
EEPROM
 
»ad
 
çs


1922 
mov
 
wÜd
 [
di
], 0201
h
 ; 00:01:02

1923 
mov
 
wÜd
 [
di
+2], 0403
h
 ; 03:04:05

1924 
mov
 
wÜd
 [
di
+4], 0605
h


1926 .
mac_»ad_com¶‘e
:

1927 
pİ
 
si


1928 
pİ
 
di


1929 
pİ
 
dx


1930 
pİ
 
cx


1931 
pİ
 
bx


1932 
pİ
 
bp


1933 
»t


1934 
»ad_mac_äom_“´om_3c509b
 
ENDP


1937 ; 
log_h¬dw¬e_”rÜ
 - 
Log
 
h¬dw¬e
 
”rÜ


1939 ; 
IÅut
: 
AX
 = 
”rÜ
 
code


1940 ; 
Ouut
: 
NÚe


1941 ; 
U£s
: 
	`NÚe
 (
´e£rves
 
®l
 
»gi¡”s
)

1943 
log_h¬dw¬e_”rÜ
 
PROC


1944 
push
 
ax


1945 
push
 
bx


1946 
push
 
cx


1947 
push
 
dx


1949 ; 
Inüem’t
 
”rÜ
 
couÁ”


1950 
šc
 
wÜd
 
±r
 [
io_”rÜ_couÁ
]

1952 ; 
Could
 
add
 
mÜe
 
sİhi¡iÿ‹d
 
loggšg
 
h”e


1953 ; 
FÜ
 
now
, 
ju¡
 
couÁ
 
”rÜs


1955 
pİ
 
dx


1956 
pİ
 
cx


1957 
pİ
 
bx


1958 
pİ
 
ax


1959 
»t


1960 
log_h¬dw¬e_”rÜ
 
ENDP


1963 ; 
h¬dw¬e_hªdË_3c509b_œq
 - 
HªdË
 3C509B 
š‹¼u±


1965 ; 
IÅut
: 
NÚe


1966 ; 
Ouut
: 
AX
 = 0 
hªdËd
, 
nÚ
-
z”o
 
¥urious


1967 ; 
U£s
: 
AÎ
 
»gi¡”s


1969 
h¬dw¬e_hªdË_3c509b_œq
 
PROC


1970 
push
 
bp


1971 
mov
 
bp
, 
¥


1972 
push
 
bx


1973 
push
 
cx


1974 
push
 
dx


1976 ; 
Com¶‘e
 3C509B 
š‹¼u±
 
hªdËr


1977 
push
 
si


1978 
push
 
di


1979 
push
 
ds


1980 
push
 
es


1982 ; 
S‘
 
up
 
d©a
 
£gm’t


1983 
mov
 
ax
, 
cs


1984 
mov
 
ds
, 
ax


1986 ; 
G‘
 
I
/
O
 
ba£
 
cu¼’t
 
NIC


1987 
mov
 
si
, [
cu¼’t_ioba£
]

1988 
‹¡
 
si
, si

1989 
jz
 .
nÙ_ours_3c509b


1991 ; 
R—d
 
š‹¼u±
 
¡©us


1992 
mov
 
dx
, 
si


1993 
add
 
dx
, 
REG_INT_STATUS


1994 
š
 
ax
, 
dx


1995 
mov
 
bx
, 
ax
 ; 
Save
 
¡©us


1997 ; 
Check
 
our
 
š‹¼u±


1998 
‹¡
 
ax
, 00FF
h


1999 
jz
 .
nÙ_ours_3c509b


2001 ; 
Proûss
 
TX
 
com¶‘e


2002 
‹¡
 
bx
, 0004
h
 ; 
TX_COMPLETE


2003 
jz
 .
check_rx_3c509b


2005 ; 
HªdË
 
TX
 
com¶‘iÚ


2006 
mov
 
dx
, 
si


2007 
add
 
dx
, 0B
h
 ; 
TX_STATUS


2008 
š
 
®
, 
dx


2010 ; 
Check
 
”rÜs


2011 
‹¡
 
®
, 0F8
h
 ; 
E¼Ü
 
b™s


2012 
jz
 .
tx_ok_3c509b


2014 ; 
Re£t
 
TX
 
Ú
 
”rÜ


2015 
mov
 
dx
, 
si


2016 
add
 
dx
, 
REG_COMMAND


2017 
mov
 
ax
, 5800
h
 ; 
CMD_TX_RESET


2018 
out
 
dx
, 
ax


2019 
mov
 
ax
, 4800
h
 ; 
CMD_TX_ENABLE


2020 
out
 
dx
, 
ax


2022 .
tx_ok_3c509b
:

2023 ; 
Pİ
 
TX
 
¡©us


2024 
mov
 
dx
, 
si


2025 
add
 
dx
, 0B
h


2026 
xÜ
 
®
,‡l

2027 
out
 
dx
, 
®
 ; 
CË¬
 
¡©us


2029 ; 
AcknowËdge
 
TX
 
š‹¼u±


2030 
mov
 
dx
, 
si


2031 
add
 
dx
, 
REG_COMMAND


2032 
mov
 
ax
, 6800
h
 | 0004h ; 
ACK_INTR
 | 
TX_COMPLETE


2033 
out
 
dx
, 
ax


2035 .
check_rx_3c509b
:

2036 ; 
Proûss
 
RX
 
com¶‘e


2037 
‹¡
 
bx
, 0001
h
 ; 
RX_COMPLETE


2038 
jz
 .
check_”rÜs_3c509b


2040 ; 
Proûss
 
»ûived
 
·ck‘s


2041 
mov
 
®
, [
cu¼’t_š¡ªû
]

2042 
push
 
bp


2043 
mov
 
bp
, 
¥


2044 
sub
 
¥
, 8 ; 
S·û
 
bufãr
 
±r


2045 
Ëa
 
di
, [
bp
-8]

2046 
mov
 [
bp
-8], 
di
 ; 
Bufãr
 
±r


2047 
mov
 [
bp
-6], 
ds


2048 
push
 
di


2049 
push
 
ds


2050 
ÿÎ
 
h¬dw¬e_»ad_·ck‘


2051 
add
 
¥
, 8

2052 
mov
 
¥
, 
bp


2053 
pİ
 
bp


2055 ; 
AcknowËdge
 
RX
 
š‹¼u±


2056 
mov
 
dx
, 
si


2057 
add
 
dx
, 
REG_COMMAND


2058 
mov
 
ax
, 6800
h
 | 0001h ; 
ACK_INTR
 | 
RX_COMPLETE


2059 
out
 
dx
, 
ax


2061 .
check_”rÜs_3c509b
:

2062 ; 
Check
 
ad­‹r
 
çu»


2063 
‹¡
 
bx
, 0080
h
 ; 
ADAPTER_FAIL


2064 
jz
 .
check_¡©s_3c509b


2066 ; 
Re£t
 
ad­‹r


2067 
mov
 
®
, [
cu¼’t_š¡ªû
]

2068 
mov
 
dx
, 
si


2069 
ÿÎ
 
h¬dw¬e_cÚfigu»_3c509b


2071 ; 
AcknowËdge
 
çu»


2072 
mov
 
dx
, 
si


2073 
add
 
dx
, 
REG_COMMAND


2074 
mov
 
ax
, 6800
h
 | 0080h ; 
ACK_INTR
 | 
ADAPTER_FAIL


2075 
out
 
dx
, 
ax


2077 .
check_¡©s_3c509b
:

2078 ; 
Upd©e
 
¡©i¡ics


2079 
‹¡
 
bx
, 0008
h
 ; 
UPDATE_STATS


2080 
jz
 .
št_dÚe_3c509b


2082 ; 
S–eù
 
Wšdow
 6 
¡©s


2083 
mov
 
dx
, 
si


2084 
add
 
dx
, 
REG_WINDOW


2085 
mov
 
ax
, 0806
h
 ; 
CMD_SELECT_WINDOW
 | 6

2086 
out
 
dx
, 
ax


2088 ; 
R—d
 
¡©i¡ics
 
to
 
ş—r


2089 
mov
 
cx
, 10

2090 
mov
 
dx
, 
si


2091 .
»ad_¡©s_3c509b
:

2092 
š
 
®
, 
dx


2093 
šc
 
dx


2094 
loİ
 .
»ad_¡©s_3c509b


2096 ; 
Back
 
to
 
Wšdow
 1

2097 
mov
 
dx
, 
si


2098 
add
 
dx
, 
REG_WINDOW


2099 
mov
 
ax
, 0801
h
 ; 
CMD_SELECT_WINDOW
 | 1

2100 
out
 
dx
, 
ax


2102 ; 
AcknowËdge
 
¡©s


2103 
mov
 
dx
, 
si


2104 
add
 
dx
, 
REG_COMMAND


2105 
mov
 
ax
, 6800
h
 | 0008h ; 
ACK_INTR
 | 
UPDATE_STATS


2106 
out
 
dx
, 
ax


2108 .
št_dÚe_3c509b
:

2109 ; 
S’d
 
EOI
 
to
 
PIC


2110 
mov
 
®
, [
cu¼’t_œq
]

2111 
cmp
 
®
, 7

2112 
jbe
 .
ma¡”_pic_3c509b


2113 
mov
 
®
, 20
h


2114 
out
 0A0
h
, 
®
 ; 
EOI
 
to
 
¦ave
 
PIC


2115 .
ma¡”_pic_3c509b
:

2116 
mov
 
®
, 20
h


2117 
out
 20
h
, 
®
 ; 
EOI
 
to
 
ma¡”
 
PIC


2119 
xÜ
 
ax
,‡x ; 
IÁ”ru±
 
hªdËd


2120 
jmp
 .
ex™_i¤_3c509b


2122 .
nÙ_ours_3c509b
:

2123 
mov
 
ax
, 1 ; 
NÙ
 
our
 
š‹¼u±


2125 .
ex™_i¤_3c509b
:

2126 
pİ
 
es


2127 
pİ
 
ds


2128 
pİ
 
di


2129 
pİ
 
si


2131 
pİ
 
dx


2132 
pİ
 
cx


2133 
pİ
 
bx


2134 
pİ
 
bp


2135 
»t


2136 
h¬dw¬e_hªdË_3c509b_œq
 
ENDP


2139 ; 
h¬dw¬e_hªdË_3c515_œq
 - 
HªdË
 3C515-
TX
 
š‹¼u±


2141 ; 
IÅut
: 
NÚe


2142 ; 
Ouut
: 
AX
 = 0 
hªdËd
, 
nÚ
-
z”o
 
¥urious


2143 ; 
U£s
: 
AÎ
 
»gi¡”s


2145 
h¬dw¬e_hªdË_3c515_œq
 
PROC


2146 
push
 
bp


2147 
mov
 
bp
, 
¥


2148 
push
 
bx


2149 
push
 
cx


2150 
push
 
dx


2152 ; 
Com¶‘e
 3C515-
TX
 
š‹¼u±
 
hªdËr
 
w™h
 
DMA
 
suµÜt


2153 
push
 
si


2154 
push
 
di


2155 
push
 
ds


2156 
push
 
es


2158 
mov
 
ax
, 
cs


2159 
mov
 
ds
, 
ax


2161 ; 
G‘
 
I
/
O
 
ba£


2162 
mov
 
si
, [
cu¼’t_ioba£
]

2163 
‹¡
 
si
, si

2164 
jz
 .
nÙ_ours_3c515


2166 ; 
R—d
 
š‹¼u±
 
¡©us


2167 
mov
 
dx
, 
si


2168 
add
 
dx
, 
REG_INT_STATUS


2169 
š
 
ax
, 
dx


2170 
mov
 
bx
, 
ax


2172 
‹¡
 
ax
, 00FF
h


2173 
jz
 .
nÙ_ours_3c515


2175 ; 
Check
 
DMA
 
	$š‹¼u±s
 (
high”
 
´iÜ™y
)

2176 
‹¡
 
bx
, 0200
h
 ; 
	$UP_COMPLETE
 (
RX
 
DMA
)

2177 
jz
 .
check_down_3c515


2179 ; 
HªdË
 
RX
 
DMA
 
com¶‘iÚ


2180 ; 
S–eù
 
Wšdow
 7 
DMA


2181 
mov
 
dx
, 
si


2182 
add
 
dx
, 
REG_WINDOW


2183 
mov
 
ax
, 0807
h
 ; 
CMD_SELECT_WINDOW
 | 7

2184 
out
 
dx
, 
ax


2186 ; 
Proûss
 
RX
 
DMA
 
desütÜs


2187 ; (
Im¶em’tiÚ
 
d•’ds
 
Ú
 
DMA
 
bufãr
 
mªagem’t
)

2189 ; 
AcknowËdge
 
UP
 
com¶‘e


2190 
mov
 
dx
, 
si


2191 
add
 
dx
, 
REG_COMMAND


2192 
mov
 
ax
, 6800
h
 | 0200h ; 
ACK_INTR
 | 
UP_COMPLETE


2193 
out
 
dx
, 
ax


2195 .
check_down_3c515
:

2196 
‹¡
 
bx
, 0400
h
 ; 
	$DOWN_COMPLETE
 (
TX
 
DMA
)

2197 
jz
 .
check_pio_3c515


2199 ; 
HªdË
 
TX
 
DMA
 
com¶‘iÚ


2200 ; 
Proûss
 
TX
 
DMA
 
desütÜs


2202 ; 
AcknowËdge
 
DOWN
 
com¶‘e


2203 
mov
 
dx
, 
si


2204 
add
 
dx
, 
REG_COMMAND


2205 
mov
 
ax
, 6800
h
 | 0400h ; 
ACK_INTR
 | 
DOWN_COMPLETE


2206 
out
 
dx
, 
ax


2208 .
check_pio_3c515
:

2209 ; 
Snd¬d
 
TX
 
com¶‘e


2210 
‹¡
 
bx
, 0004
h
 ; 
TX_COMPLETE


2211 
jz
 .
check_rx_3c515


2213 
mov
 
dx
, 
si


2214 
add
 
dx
, 1B
h
 ; 
TX_STATUS
 3C515

2215 
š
 
®
, 
dx


2216 
out
 
dx
, 
®
 ; 
Pİ
 
¡©us


2218 
mov
 
dx
, 
si


2219 
add
 
dx
, 
REG_COMMAND


2220 
mov
 
ax
, 6800
h
 | 0004h ; 
ACK_INTR
 | 
TX_COMPLETE


2221 
out
 
dx
, 
ax


2223 .
check_rx_3c515
:

2224 
‹¡
 
bx
, 0001
h
 ; 
RX_COMPLETE


2225 
jz
 .
check_ho¡_3c515


2227 ; 
Check
 
usšg
 
DMA
 
Ü
 
PIO


2228 
mov
 
di
, 
OFFSET
 
hw_æags_bË


2229 
mov
 
®
, [
cu¼’t_š¡ªû
]

2230 
xÜ
 
ah
,‡h

2231 
add
 
di
, 
ax


2232 
‹¡
 
by‹
 [
di
], 01
h
 ; 
FLAG_BUS_MASTER


2233 
jnz
 .
rx_dma_3c515


2235 ; 
PIO
 
mode
 
RX


2236 
mov
 
®
, [
cu¼’t_š¡ªû
]

2237 
push
 
bp


2238 
mov
 
bp
, 
¥


2239 
sub
 
¥
, 8

2240 
Ëa
 
di
, [
bp
-8]

2241 
mov
 [
bp
-8], 
di


2242 
mov
 [
bp
-6], 
ds


2243 
push
 
di


2244 
push
 
ds


2245 
ÿÎ
 
h¬dw¬e_»ad_·ck‘


2246 
add
 
¥
, 8

2247 
mov
 
¥
, 
bp


2248 
pİ
 
bp


2250 .
rx_dma_3c515
:

2251 ; 
AcknowËdge
 
RX
 
š‹¼u±


2252 
mov
 
dx
, 
si


2253 
add
 
dx
, 
REG_COMMAND


2254 
mov
 
ax
, 6800
h
 | 0001h ; 
ACK_INTR
 | 
RX_COMPLETE


2255 
out
 
dx
, 
ax


2257 .
check_ho¡_3c515
:

2258 ; 
Check
 
ho¡
 
”rÜ


2259 
‹¡
 
bx
, 0002
h
 ; 
HOST_ERROR


2260 
jz
 .
št_dÚe_3c515


2262 ; 
R—d
 
PCI
 
¡©us


2263 
mov
 
dx
, 
si


2264 
add
 
dx
, 20
h
 ; 
PCI_STATUS


2265 
š
 
ax
, 
dx


2267 ; 
CË¬
 
”rÜs


2268 
out
 
dx
, 
ax


2270 ; 
Re£t
 
çl


2271 
‹¡
 
ax
, 8000
h
 ; 
PCI_ERR_FATAL


2272 
jz
 .
ack_ho¡_3c515


2274 
mov
 
®
, [
cu¼’t_š¡ªû
]

2275 
mov
 
dx
, 
si


2276 
ÿÎ
 
š™_3c515


2278 .
ack_ho¡_3c515
:

2279 
mov
 
dx
, 
si


2280 
add
 
dx
, 
REG_COMMAND


2281 
mov
 
ax
, 6800
h
 | 0002h ; 
ACK_INTR
 | 
HOST_ERROR


2282 
out
 
dx
, 
ax


2284 .
št_dÚe_3c515
:

2285 ; 
Re¡Üe
 
Wšdow
 1

2286 
mov
 
dx
, 
si


2287 
add
 
dx
, 
REG_WINDOW


2288 
mov
 
ax
, 0801
h
 ; 
CMD_SELECT_WINDOW
 | 1

2289 
out
 
dx
, 
ax


2291 ; 
S’d
 
EOI


2292 
mov
 
®
, [
cu¼’t_œq
]

2293 
cmp
 
®
, 7

2294 
jbe
 .
ma¡”_pic_3c515


2295 
mov
 
®
, 20
h


2296 
out
 0A0
h
, 
®


2297 .
ma¡”_pic_3c515
:

2298 
mov
 
®
, 20
h


2299 
out
 20
h
, 
®


2301 
xÜ
 
ax
,‡x ; 
HªdËd


2302 
jmp
 .
ex™_i¤_3c515


2304 .
nÙ_ours_3c515
:

2305 
mov
 
ax
, 1 ; 
NÙ
 
ours


2307 .
ex™_i¤_3c515
:

2308 
pİ
 
es


2309 
pİ
 
ds


2310 
pİ
 
di


2311 
pİ
 
si


2313 
pİ
 
dx


2314 
pİ
 
cx


2315 
pİ
 
bx


2316 
pİ
 
bp


2317 
»t


2318 
h¬dw¬e_hªdË_3c515_œq
 
ENDP


2321 ; 
io_»ad_by‹
 - 
R—d
 
by‹
 
äom
 
I
/
O
 
pÜt


2323 ; 
IÅut
: 
DX
 = 
pÜt
 
add»ss


2324 ; 
Ouut
: 
AL
 = 
d©a
 
»ad


2325 ; 
U£s
: 
AL


2327 
io_»ad_by‹
 
PROC


2328 
push
 
bp


2329 
mov
 
bp
, 
¥


2331 ; 
P”fÜm
 
I
/
O
 
»ad


2332 
š
 
®
, 
dx


2334 ; 
Upd©e
 
¡©i¡ics


2335 
šc
 
dwÜd
 
±r
 [
io_»ad_couÁ
]

2337 
pİ
 
bp


2338 
»t


2339 
io_»ad_by‹
 
ENDP


2342 ; 
io_wr™e_by‹
 - 
Wr™e
 
by‹
 
to
 
I
/
O
 
pÜt


2344 ; 
IÅut
: 
DX
 = 
pÜt
 
add»ss
, 
AL
 = 
d©a
 
to
 
wr™e


2345 ; 
Ouut
: 
NÚe


2346 ; 
U£s
: 
NÚe


2348 
io_wr™e_by‹
 
PROC


2349 
push
 
bp


2350 
mov
 
bp
, 
¥


2352 ; 
P”fÜm
 
I
/
O
 
wr™e


2353 
out
 
dx
, 
®


2355 ; 
Upd©e
 
¡©i¡ics


2356 
šc
 
dwÜd
 
±r
 [
io_wr™e_couÁ
]

2358 
pİ
 
bp


2359 
»t


2360 
io_wr™e_by‹
 
ENDP


2363 ; 
io_»ad_wÜd
 - 
R—d
 
wÜd
 
äom
 
I
/
O
 
pÜt


2365 ; 
IÅut
: 
DX
 = 
pÜt
 
add»ss


2366 ; 
Ouut
: 
AX
 = 
d©a
 
»ad


2367 ; 
U£s
: 
AX


2369 
io_»ad_wÜd
 
PROC


2370 
push
 
bp


2371 
mov
 
bp
, 
¥


2373 ; 
P”fÜm
 
I
/
O
 
»ad


2374 
š
 
ax
, 
dx


2376 ; 
Upd©e
 
¡©i¡ics


2377 
šc
 
dwÜd
 
±r
 [
io_»ad_couÁ
]

2379 
pİ
 
bp


2380 
»t


2381 
io_»ad_wÜd
 
ENDP


2384 ; 
io_wr™e_wÜd
 - 
Wr™e
 
wÜd
 
to
 
I
/
O
 
pÜt


2386 ; 
IÅut
: 
DX
 = 
pÜt
 
add»ss
, 
AX
 = 
d©a
 
to
 
wr™e


2387 ; 
Ouut
: 
NÚe


2388 ; 
U£s
: 
NÚe


2390 
io_wr™e_wÜd
 
PROC


2391 
push
 
bp


2392 
mov
 
bp
, 
¥


2394 ; 
P”fÜm
 
I
/
O
 
wr™e


2395 
out
 
dx
, 
ax


2397 ; 
Upd©e
 
¡©i¡ics


2398 
šc
 
dwÜd
 
±r
 [
io_wr™e_couÁ
]

2400 
pİ
 
bp


2401 
»t


2402 
io_wr™e_wÜd
 
ENDP


2405 ; 
ENHANCED
 
GROUP
 6A/6B 
FUNCTIONS
 - 
DEVICE
-
SPECIFIC
 
IMPLEMENTATIONS


2409 ; 
cÚfigu»_3c509b_deviû
 - 
Enhªûd
 3C509B 
cÚfigu¿tiÚ
 
w™h
 
deãnsive
 
´og¿mmšg


2411 ; 
IÅut
: 
AL
 = 
deviû
 
šdex


2412 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2413 ; 
U£s
: 
AÎ
 
»gi¡”s


2415 
cÚfigu»_3c509b_deviû
 
PROC


2416 
push
 
bp


2417 
mov
 
bp
, 
¥


2418 
push
 
bx


2419 
push
 
cx


2420 
push
 
dx


2421 
push
 
si


2423 ; 
V®id©e
 
deviû
 
šdex


2424 
VALIDATE_HW_INSTANCE
 
®
, 
MAX_HW_INSTANCES


2425 
jc
 .
šv®id_šdex


2427 ; 
G‘
 
deviû
 
I
/
O
 
ba£
 
äom
 
š¡ªû
 
bË


2428 
mov
 
bl
, 
®


2429 
mov
 
bh
, 0

2430 
mov
 
si
, 
bx


2431 
shl
 
si
, 1 ; 
WÜd
 
off£t
 
I
/
O
 
ba£s


2432 
mov
 
dx
, [
hw_io_ba£s
 + 
si
]

2433 
‹¡
 
dx
, dx

2434 
jz
 .
no_io_ba£


2436 ; 
Re£t
 
the
 
deviû
 
fœ¡


2437 
HARDWARE_RESET
 
dx
, 
HW_TYPE_3C509B
, 1000

2438 
jc
 .
»£t_çed


2440 ; 
CÚfigu»
 
deviû
 
»gi¡”s
 
usšg
 
wšdow
 
£ËùiÚ


2441 
SELECT_3C509B_WINDOW
 
dx
, 0

2443 ; 
R—d
 
ªd
 
v®id©e
 
EEPROM


2444 
ÿÎ
 
»ad_3c509b_“´om


2445 
cmp
 
ax
, 
HW_SUCCESS


2446 
jÃ
 .
“´om_çed


2448 ; 
S‘up
 
IRQ
 
¥ecif›d


2449 
mov
 
®
, [
hw_œq_lšes
 + 
bx
]

2450 
cmp
 
®
, 0

2451 
je
 .
sk_œq_£tup


2452 
ÿÎ
 
£tup_3c509b_œq


2454 .
sk_œq_£tup
:

2455 ; 
M¬k
 
deviû
 
as
 
cÚfigu»d


2456 
mov
 
®
, 
bl
 ; 
Re¡Üe
 
deviû
 
šdex


2457 
mov
 
ah
, 
HW_STATE_CONFIGURED


2458 
ÿÎ
 
h¬dw¬e_£t_deviû_¡©e


2460 
mov
 
ax
, 
HW_SUCCESS


2461 
jmp
 .
ex™


2463 .
šv®id_šdex
:

2464 
mov
 
ax
, 
HW_ERROR_INVALID_PARAM


2465 
jmp
 .
ex™


2467 .
no_io_ba£
:

2468 
mov
 
ax
, 
HW_ERROR_IO_ERROR


2469 
jmp
 .
ex™


2471 .
»£t_çed
:

2472 
mov
 
ax
, 
HW_ERROR_RESET_FAILED


2473 
jmp
 .
ex™


2475 .
“´om_çed
:

2476 
mov
 
ax
, 
HW_ERROR_EEPROM_READ


2478 .
ex™
:

2479 
pİ
 
si


2480 
pİ
 
dx


2481 
pİ
 
cx


2482 
pİ
 
bx


2483 
pİ
 
bp


2484 
»t


2485 
cÚfigu»_3c509b_deviû
 
ENDP


2488 ; 
cÚfigu»_3c515_deviû
 - 
Enhªûd
 3C515-
TX
 
cÚfigu¿tiÚ


2490 ; 
IÅut
: 
AL
 = 
deviû
 
šdex


2491 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2492 ; 
U£s
: 
AÎ
 
»gi¡”s


2494 
cÚfigu»_3c515_deviû
 
PROC


2495 
push
 
bp


2496 
mov
 
bp
, 
¥


2497 
push
 
bx


2498 
push
 
cx


2499 
push
 
dx


2500 
push
 
si


2502 ; 
V®id©e
 
deviû
 
šdex


2503 
VALIDATE_HW_INSTANCE
 
®
, 
MAX_HW_INSTANCES


2504 
jc
 .
šv®id_šdex


2506 ; 
G‘
 
deviû
 
I
/
O
 
ba£
 
äom
 
š¡ªû
 
bË


2507 
mov
 
bl
, 
®


2508 
mov
 
bh
, 0

2509 
mov
 
si
, 
bx


2510 
shl
 
si
, 1 ; 
WÜd
 
off£t
 
I
/
O
 
ba£s


2511 
mov
 
dx
, [
hw_io_ba£s
 + 
si
]

2512 
‹¡
 
dx
, dx

2513 
jz
 .
no_io_ba£


2515 ; 
Re£t
 
the
 
deviû
 
fœ¡


2516 
HARDWARE_RESET
 
dx
, 
HW_TYPE_3C515TX
, 1000

2517 
jc
 .
»£t_çed


2519 ; 
CÚfigu»
 
deviû
 
»gi¡”s


2520 
SELECT_3C515_WINDOW
 
dx
, 0

2522 ; 
R—d
 
ªd
 
v®id©e
 
EEPROM


2523 
ÿÎ
 
»ad_3c515_“´om


2524 
cmp
 
ax
, 
HW_SUCCESS


2525 
jÃ
 .
“´om_çed


2527 ; 
S‘up
 
DMA
 
suµÜ‹d


2528 
ÿÎ
 
cÚfigu»_3c515_dma


2530 ; 
S‘up
 
IRQ
 
¥ecif›d


2531 
mov
 
®
, [
hw_œq_lšes
 + 
bx
]

2532 
cmp
 
®
, 0

2533 
je
 .
sk_œq_£tup


2534 
ÿÎ
 
£tup_3c515_œq


2536 .
sk_œq_£tup
:

2537 ; 
M¬k
 
deviû
 
as
 
cÚfigu»d


2538 
mov
 
®
, 
bl
 ; 
Re¡Üe
 
deviû
 
šdex


2539 
mov
 
ah
, 
HW_STATE_CONFIGURED


2540 
ÿÎ
 
h¬dw¬e_£t_deviû_¡©e


2542 
mov
 
ax
, 
HW_SUCCESS


2543 
jmp
 .
ex™


2545 .
šv®id_šdex
:

2546 
mov
 
ax
, 
HW_ERROR_INVALID_PARAM


2547 
jmp
 .
ex™


2549 .
no_io_ba£
:

2550 
mov
 
ax
, 
HW_ERROR_IO_ERROR


2551 
jmp
 .
ex™


2553 .
»£t_çed
:

2554 
mov
 
ax
, 
HW_ERROR_RESET_FAILED


2555 
jmp
 .
ex™


2557 .
“´om_çed
:

2558 
mov
 
ax
, 
HW_ERROR_EEPROM_READ


2560 .
ex™
:

2561 
pİ
 
si


2562 
pİ
 
dx


2563 
pİ
 
cx


2564 
pİ
 
bx


2565 
pİ
 
bp


2566 
»t


2567 
cÚfigu»_3c515_deviû
 
ENDP


2570 ; 
»ad_3c509b_“´om
 - 
R—d
 3C509B 
EEPROM
 
w™h
 
deãnsive
 
´og¿mmšg


2572 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


2573 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2574 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


2576 
»ad_3c509b_“´om
 
PROC


2577 
push
 
bp


2578 
mov
 
bp
, 
¥


2579 
push
 
bx


2580 
push
 
cx


2581 
push
 
dx


2583 ; 
S–eù
 
wšdow
 0 
EEPROM
 
acûss


2584 
SELECT_3C509B_WINDOW
 
dx
, 0

2586 ; 
R—d
 
EEPROM
 
w™h
 
timeout
 
´ÙeùiÚ


2587 
mov
 
cx
, 16 ; 
R—d
 16 
wÜds


2588 
mov
 
bx
, 0 ; 
S¹šg
 
add»ss


2590 .
“´om_»ad_loİ
:

2591 ; 
S‘
 
EEPROM
 
add»ss


2592 
push
 
dx


2593 
add
 
dx
, 0A
h
 ; 
EEPROM
 
commªd
 

2594 
mov
 
ax
, 80
h
 ; 
R—d
 
commªd


2595 
Ü
 
ax
, 
bx
 ; 
OR
 
w™h
 
add»ss


2596 
out
 
dx
, 
ax


2597 
pİ
 
dx


2599 ; 
Wa™
 
EEPROM
 
»ady
 
w™h
 
timeout


2600 
WAIT_FOR_CONDITION
 
dx
+0A
h
, 8000h, 
TIMEOUT_MEDIUM


2601 
jc
 .
“´om_timeout


2603 ; 
R—d
 
EEPROM
 
d©a


2604 
push
 
dx


2605 
add
 
dx
, 0C
h
 ; 
EEPROM
 
d©a
 

2606 
š
 
ax
, 
dx


2607 
pİ
 
dx


2609 ; 
StÜe
 
	`d©a
 (
sim¶if›d
 - 
would
 
¡Üe
 
š
 
MAC
 
add»ss
 
¬¿y
)

2610 ; 
FÜ
 
now
 
ju¡
 
v®id©e
 
™
's‚ot 0

2611 
‹¡
 
ax
,‡x

2612 
jz
 .
šv®id_“´om


2614 
šc
 
bx


2615 
dec
 
cx


2616 
jnz
 .
“´om_»ad_loİ


2618 
mov
 
ax
, 
HW_SUCCESS


2619 
jmp
 .
ex™


2621 .
“´om_timeout
:

2622 
mov
 
ax
, 
HW_ERROR_TIMEOUT


2623 
jmp
 .
ex™


2625 .
šv®id_“´om
:

2626 
mov
 
ax
, 
HW_ERROR_EEPROM_READ


2628 .
ex™
:

2629 
pİ
 
dx


2630 
pİ
 
cx


2631 
pİ
 
bx


2632 
pİ
 
bp


2633 
»t


2634 
»ad_3c509b_“´om
 
ENDP


2637 ; 
»ad_3c515_“´om
 - 
R—d
 3C515-
TX
 
EEPROM


2639 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


2640 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2641 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


2643 
»ad_3c515_“´om
 
PROC


2644 
push
 
bp


2645 
mov
 
bp
, 
¥


2646 
push
 
bx


2647 
push
 
cx


2648 
push
 
dx


2650 ; 
S–eù
 
wšdow
 0 
EEPROM
 
acûss


2651 
SELECT_3C515_WINDOW
 
dx
, 0

2653 ; 
R—d
 
EEPROM
 
w™h
 
timeout
 
	$´ÙeùiÚ
 (
sim¬
 
to
 3C509B 
but
 
difã»Á
 
»gi¡”s
)

2654 
mov
 
cx
, 16 ; 
R—d
 16 
wÜds


2655 
mov
 
bx
, 0 ; 
S¹šg
 
add»ss


2657 .
“´om_»ad_loİ
:

2658 ; 
S‘
 
EEPROM
 
add»ss


2659 
push
 
dx


2660 
add
 
dx
, 200A
h
 ; 
EEPROM
 
commªd
 3C515

2661 
mov
 
ax
, 80
h
 ; 
R—d
 
commªd


2662 
Ü
 
ax
, 
bx
 ; 
OR
 
w™h
 
add»ss


2663 
out
 
dx
, 
ax


2664 
pİ
 
dx


2666 ; 
Wa™
 
EEPROM
 
»ady
 
w™h
 
timeout


2667 
WAIT_FOR_CONDITION
 
dx
+200A
h
, 8000h, 
TIMEOUT_MEDIUM


2668 
jc
 .
“´om_timeout


2670 ; 
R—d
 
EEPROM
 
d©a


2671 
push
 
dx


2672 
add
 
dx
, 200C
h
 ; 
EEPROM
 
d©a
 

2673 
š
 
ax
, 
dx


2674 
pİ
 
dx


2676 ; 
V®id©e
 
d©a


2677 
‹¡
 
ax
,‡x

2678 
jz
 .
šv®id_“´om


2680 
šc
 
bx


2681 
dec
 
cx


2682 
jnz
 .
“´om_»ad_loİ


2684 
mov
 
ax
, 
HW_SUCCESS


2685 
jmp
 .
ex™


2687 .
“´om_timeout
:

2688 
mov
 
ax
, 
HW_ERROR_TIMEOUT


2689 
jmp
 .
ex™


2691 .
šv®id_“´om
:

2692 
mov
 
ax
, 
HW_ERROR_EEPROM_READ


2694 .
ex™
:

2695 
pİ
 
dx


2696 
pİ
 
cx


2697 
pİ
 
bx


2698 
pİ
 
bp


2699 
»t


2700 
»ad_3c515_“´om
 
ENDP


2703 ; 
£tup_3c509b_œq
 - 
S‘up
 3C509B 
IRQ
 
hªdËr


2705 ; 
IÅut
: 
AL
 = 
IRQ
 
numb”
, 
DX
 = 
I
/
O
 
ba£


2706 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2707 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


2709 
£tup_3c509b_œq
 
PROC


2710 
push
 
bp


2711 
mov
 
bp
, 
¥


2712 
push
 
bx


2713 
push
 
cx


2714 
push
 
dx


2716 ; 
V®id©e
 
IRQ


2717 
VALIDATE_IRQ
 
®


2718 
jc
 .
šv®id_œq


2720 ; 
CÚfigu»
 
š‹¼u±
 
’abË
 
mask


2721 
SELECT_3C509B_WINDOW
 
dx
, 1

2723 
push
 
dx


2724 
add
 
dx
, 0E
h
 ; 
Commªd
 

2725 
mov
 
ax
, (14 << 11è| 00BF
h
 ; 
S‘
 
š‹¼u±
 
’abË
 
mask


2726 
out
 
dx
, 
ax


2727 
pİ
 
dx


2729 
mov
 
ax
, 
HW_SUCCESS


2730 
jmp
 .
ex™


2732 .
šv®id_œq
:

2733 
mov
 
ax
, 
HW_ERROR_IRQ_CONFLICT


2735 .
ex™
:

2736 
pİ
 
dx


2737 
pİ
 
cx


2738 
pİ
 
bx


2739 
pİ
 
bp


2740 
»t


2741 
£tup_3c509b_œq
 
ENDP


2744 ; 
£tup_3c515_œq
 - 
S‘up
 3C515-
TX
 
IRQ
 
hªdËr


2746 ; 
IÅut
: 
AL
 = 
IRQ
 
numb”
, 
DX
 = 
I
/
O
 
ba£


2747 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2748 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


2750 
£tup_3c515_œq
 
PROC


2751 
push
 
bp


2752 
mov
 
bp
, 
¥


2753 
push
 
bx


2754 
push
 
cx


2755 
push
 
dx


2757 ; 
V®id©e
 
IRQ


2758 
VALIDATE_IRQ
 
®


2759 
jc
 .
šv®id_œq


2761 ; 
CÚfigu»
 
š‹¼u±
 
’abË
 
mask
 3C515-
TX


2762 
SELECT_3C515_WINDOW
 
dx
, 1

2764 
push
 
dx


2765 
add
 
dx
, 0E
h
 ; 
Commªd
 

2766 
mov
 
ax
, (14 << 11è| 07FF
h
 ; 
Enhªûd
 
š‹¼u±
 
mask
 
DMA


2767 
out
 
dx
, 
ax


2768 
pİ
 
dx


2770 
mov
 
ax
, 
HW_SUCCESS


2771 
jmp
 .
ex™


2773 .
šv®id_œq
:

2774 
mov
 
ax
, 
HW_ERROR_IRQ_CONFLICT


2776 .
ex™
:

2777 
pİ
 
dx


2778 
pİ
 
cx


2779 
pİ
 
bx


2780 
pİ
 
bp


2781 
»t


2782 
£tup_3c515_œq
 
ENDP


2785 ; 
cÚfigu»_3c515_dma
 - 
CÚfigu»
 3C515-
TX
 
DMA
 
£‰šgs


2787 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


2788 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2789 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


2791 
cÚfigu»_3c515_dma
 
PROC


2792 
push
 
bp


2793 
mov
 
bp
, 
¥


2794 
push
 
bx


2795 
push
 
cx


2796 
push
 
dx


2798 ; 
S–eù
 
wšdow
 7 
DMA
 
cÚŒŞ


2799 
SELECT_3C515_WINDOW
 
dx
, 7

2801 ; 
In™Ÿlize
 
DMA
 
desütÜ
 
poš‹rs


2802 
push
 
dx


2803 
add
 
dx
, 404
h
 ; 
Down
 
li¡
 
poš‹r


2804 
xÜ
 
ax
,‡x ; 
NULL
 
poš‹r
 
š™ŸÎy


2805 
out
 
dx
, 
ax


2806 
add
 
dx
, 2

2807 
out
 
dx
, 
ax
 ; 
High
 
wÜd


2809 
add
 
dx
, 14
h
 - 6 ; 
Up
 
li¡
 
	`poš‹r
 (418h - 404h = 14h)

2810 
out
 
dx
, 
ax


2811 
add
 
dx
, 2

2812 
out
 
dx
, 
ax
 ; 
High
 
wÜd


2813 
pİ
 
dx


2815 
mov
 
ax
, 
HW_SUCCESS


2817 
pİ
 
dx


2818 
pİ
 
cx


2819 
pİ
 
bx


2820 
pİ
 
bp


2821 
»t


2822 
cÚfigu»_3c515_dma
 
ENDP


2825 ; 
»£t_3c509b_deviû
 - 
Re£t
 3C509B 
deviû


2827 ; 
IÅut
: 
AL
 = 
deviû
 
šdex


2828 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2829 ; 
U£s
: 
AX
, 
BX
, 
DX


2831 
»£t_3c509b_deviû
 
PROC


2832 
push
 
bp


2833 
mov
 
bp
, 
¥


2834 
push
 
bx


2835 
push
 
dx


2837 ; 
G‘
 
I
/
O
 
ba£
 
deviû


2838 
mov
 
bl
, 
®


2839 
mov
 
bh
, 0

2840 
shl
 
bx
, 1

2841 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
]

2843 ; 
P”fÜm
 
h¬dw¬e
 
»£t


2844 
HARDWARE_RESET
 
dx
, 
HW_TYPE_3C509B
, 1000

2845 
jc
 .
»£t_çed


2847 
mov
 
ax
, 
HW_SUCCESS


2848 
jmp
 .
ex™


2850 .
»£t_çed
:

2851 
mov
 
ax
, 
HW_ERROR_RESET_FAILED


2853 .
ex™
:

2854 
pİ
 
dx


2855 
pİ
 
bx


2856 
pİ
 
bp


2857 
»t


2858 
»£t_3c509b_deviû
 
ENDP


2861 ; 
»£t_3c515_deviû
 - 
Re£t
 3C515-
TX
 
deviû


2863 ; 
IÅut
: 
AL
 = 
deviû
 
šdex


2864 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2865 ; 
U£s
: 
AX
, 
BX
, 
DX


2867 
»£t_3c515_deviû
 
PROC


2868 
push
 
bp


2869 
mov
 
bp
, 
¥


2870 
push
 
bx


2871 
push
 
dx


2873 ; 
G‘
 
I
/
O
 
ba£
 
deviû


2874 
mov
 
bl
, 
®


2875 
mov
 
bh
, 0

2876 
shl
 
bx
, 1

2877 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
]

2879 ; 
P”fÜm
 
h¬dw¬e
 
»£t


2880 
HARDWARE_RESET
 
dx
, 
HW_TYPE_3C515TX
, 1000

2881 
jc
 .
»£t_çed


2883 
mov
 
ax
, 
HW_SUCCESS


2884 
jmp
 .
ex™


2886 .
»£t_çed
:

2887 
mov
 
ax
, 
HW_ERROR_RESET_FAILED


2889 .
ex™
:

2890 
pİ
 
dx


2891 
pİ
 
bx


2892 
pİ
 
bp


2893 
»t


2894 
»£t_3c515_deviû
 
ENDP


2897 ; 
SYSTEM
-
LEVEL
 
FUNCTIONS


2901 ; 
h¬dw¬e_š™_sy¡em
 - 
In™Ÿlize
 
h¬dw¬e
 
subsy¡em


2903 ; 
IÅut
: 
NÚe


2904 ; 
Ouut
: 
AX
 = 
HW_SUCCESS
 
Ü
 
”rÜ
 
code


2905 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
SI


2907 
h¬dw¬e_š™_sy¡em
 
PROC


2908 
push
 
bp


2909 
mov
 
bp
, 
¥


2910 
push
 
bx


2911 
push
 
cx


2912 
push
 
si


2914 ; 
Check
 
®»ady
 
š™Ÿlized


2915 
cmp
 [
h¬dw¬e_š™Ÿlized
], 1

2916 
je
 .
®»ady_š™Ÿlized


2918 ; 
CË¬
 
h¬dw¬e
 
š¡ªû
 
bË


2919 
mov
 
cx
, 
SIZE
 
HW_INSTANCE


2920 
mov
 
ax
, 
MAX_HW_INSTANCES


2921 
mul
 
cx


2922 
mov
 
cx
, 
ax
 ; 
TÙ®
 
by‹s
 
to
 
ş—r


2923 
mov
 
si
, 
OFFSET
 
hw_š¡ªû_bË


2925 .
ş—r_loİ
:

2926 
mov
 
by‹
 
±r
 [
si
], 0

2927 
šc
 
si


2928 
dec
 
cx


2929 
jnz
 .
ş—r_loİ


2931 ; 
In™Ÿlize
 
couÁ”s


2932 
mov
 [
hw_š¡ªû_couÁ
], 0

2933 
mov
 [
Ï¡_”rÜ_code
], 0

2935 ; 
CË¬
 
I
/
O
 
¡©i¡ics


2936 
mov
 
dwÜd
 
±r
 [
io_»ad_couÁ
], 0

2937 
mov
 
dwÜd
 
±r
 [
io_wr™e_couÁ
], 0

2938 
mov
 
wÜd
 
±r
 [
io_”rÜ_couÁ
], 0

2939 
mov
 
wÜd
 
±r
 [
io_timeout_couÁ
], 0

2940 
mov
 
wÜd
 
±r
 [
io_»Œy_couÁ
], 0

2942 ; 
M¬k
 
as
 
š™Ÿlized


2943 
mov
 [
h¬dw¬e_š™Ÿlized
], 1

2945 .
®»ady_š™Ÿlized
:

2946 
mov
 
ax
, 
HW_SUCCESS


2948 
pİ
 
si


2949 
pİ
 
cx


2950 
pİ
 
bx


2951 
pİ
 
bp


2952 
»t


2953 
h¬dw¬e_š™_sy¡em
 
ENDP


2956 ; 
h¬dw¬e_d‘eù_®l_deviûs
 - 
D‘eù
 
®l
 
suµÜ‹d
 
h¬dw¬e
 
deviûs


2958 ; 
IÅut
: 
NÚe


2959 ; 
Ouut
: 
AX
 = 
numb”
 
of
 
deviûs
 
d‘eùed


2960 ; 
U£s
: 
AÎ
 
»gi¡”s


2962 
h¬dw¬e_d‘eù_®l_deviûs
 
PROC


2963 
push
 
bp


2964 
mov
 
bp
, 
¥


2965 
push
 
bx


2966 
push
 
cx


2967 
push
 
dx


2968 
push
 
si


2969 
push
 
di


2971 
mov
 
bx
, 0 ; 
Deviû
 
couÁ”


2973 ; 
Try
 
to
 
d‘eù
 3C509B 
deviûs


2974 
ÿÎ
 
d‘eù_3c509b_deviû


2975 
jc
 .
no_3c509b


2977 ; 
StÜe
 
d‘eùed
 3C509B

2978 
mov
 
si
, 
OFFSET
 
hw_š¡ªû_bË


2979 
mov
 
cx
, 
SIZE
 
HW_INSTANCE


2980 
mov
 
dx
, 
bx


2981 
mul
 
cx


2982 
add
 
si
, 
ax


2984 
mov
 [
si
 + 
HW_INSTANCE
.
ty³
], 
HW_TYPE_3C509B


2985 
mov
 [
si
 + 
HW_INSTANCE
.
¡©e
], 
HW_STATE_DETECTED


2986 
mov
 [
si
 + 
HW_INSTANCE
.
io_ba£
], 
ax
 ; 
From
 
d‘eù
 
funùiÚ


2988 ; 
Upd©e
 
Ëgacy
 
¬¿ys
 
com·tib™y


2989 
mov
 [
hw_ty³s
 + 
bx
], 
HW_TYPE_3C509B


2990 
mov
 [
hw_š¡ªûs
 + 
bx
], 
HW_STATE_DETECTED


2991 
push
 
bx


2992 
shl
 
bx
, 1

2993 
mov
 [
hw_io_ba£s
 + 
bx
], 
ax


2994 
pİ
 
bx


2996 
šc
 
bx
 ; 
Inüem’t
 
deviû
 
couÁ


2998 .
no_3c509b
:

2999 ; 
Try
 
to
 
d‘eù
 3C515-
TX
 
deviûs


3000 
ÿÎ
 
d‘eù_3c515_deviû


3001 
jc
 .
no_3c515


3003 ; 
Check
 
we
 
have
 
room
 
ªÙh”
 
deviû


3004 
cmp
 
bx
, 
MAX_HW_INSTANCES


3005 
j«
 .
no_3c515


3007 ; 
StÜe
 
d‘eùed
 3C515-
TX


3008 
push
 
ax
 ; 
Save
 
I
/
O
 
ba£


3009 
mov
 
si
, 
OFFSET
 
hw_š¡ªû_bË


3010 
mov
 
cx
, 
SIZE
 
HW_INSTANCE


3011 
mov
 
ax
, 
bx


3012 
mul
 
cx


3013 
add
 
si
, 
ax


3014 
pİ
 
ax
 ; 
Re¡Üe
 
I
/
O
 
ba£


3016 
mov
 [
si
 + 
HW_INSTANCE
.
ty³
], 
HW_TYPE_3C515TX


3017 
mov
 [
si
 + 
HW_INSTANCE
.
¡©e
], 
HW_STATE_DETECTED


3018 
mov
 [
si
 + 
HW_INSTANCE
.
io_ba£
], 
ax


3020 ; 
Upd©e
 
Ëgacy
 
¬¿ys


3021 
mov
 [
hw_ty³s
 + 
bx
], 
HW_TYPE_3C515TX


3022 
mov
 [
hw_š¡ªûs
 + 
bx
], 
HW_STATE_DETECTED


3023 
push
 
bx


3024 
shl
 
bx
, 1

3025 
mov
 [
hw_io_ba£s
 + 
bx
], 
ax


3026 
pİ
 
bx


3028 
šc
 
bx
 ; 
Inüem’t
 
deviû
 
couÁ


3030 .
no_3c515
:

3031 ; 
StÜe
 
fš®
 
deviû
 
couÁ


3032 
mov
 [
hw_š¡ªû_couÁ
], 
bl


3033 
mov
 
ax
, 
bx
 ; 
R‘uº
 
deviû
 
couÁ


3035 
pİ
 
di


3036 
pİ
 
si


3037 
pİ
 
dx


3038 
pİ
 
cx


3039 
pİ
 
bx


3040 
pİ
 
bp


3041 
»t


3042 
h¬dw¬e_d‘eù_®l_deviûs
 
ENDP


3045 ; 
UTILITY
 
AND
 
SUPPORT
 
FUNCTIONS


3049 ; 
d–ay_1ms
 - 1 
mli£cÚd
 
d–ay


3051 ; 
IÅut
: 
NÚe


3052 ; 
Ouut
: 
NÚe


3053 ; 
U£s
: 
CX


3055 
d–ay_1ms
 
PROC


3056 
push
 
cx


3058 ; 
Aµroxim©e
 1
ms
 
d–ay
 
usšg
 
	`loİ
 (
CPU
-
d•’d’t
)

3059 ; 
This
 
is
 
a
 
rough
 
­´oxim©iÚ
 
Şd”
 
CPUs


3060 
mov
 
cx
, 1000

3062 .
d–ay_loİ
:

3063 
nİ


3064 
loİ
 .
d–ay_loİ


3066 
pİ
 
cx


3067 
»t


3068 
d–ay_1ms
 
ENDP


3071 ; 
d–ay_10ms
 - 10 
mli£cÚd
 
d–ay


3073 ; 
IÅut
: 
NÚe


3074 ; 
Ouut
: 
NÚe


3075 ; 
U£s
: 
CX


3077 
d–ay_10ms
 
PROC


3078 
push
 
cx


3080 
mov
 
cx
, 10

3082 .
d–ay_loİ
:

3083 
ÿÎ
 
d–ay_1ms


3084 
loİ
 .
d–ay_loİ


3086 
pİ
 
cx


3087 
»t


3088 
d–ay_10ms
 
ENDP


3091 ; 
PHASE
 3: 
ADVANCED
 
DMA
 
FUNCTIONS
 
FOR
 3C515-
TX


3092 ; 
Sub
-
Ag’t
 1: 
DMA
 
S³cŸli¡
 - 
Low
-
Ëv–
 DMA 
İ”©iÚs


3096 ; 
dma_¡®l_’gšes
 - 
SÎ
 
DMA
 
’gšes
 
timeout
 
»cov”y


3098 ; 
IÅut
: 
AL
 = 1 
to
 
¡®l
 
TX
, 0Ø
sk
 TX

3099 ; 
AH
 = 1 
to
 
¡®l
 
RX
, 0Ø
sk
 RX

3100 ; 
DX
 = 
I
/
O
 
ba£
 
add»ss


3101 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
Ãg©ive
 
”rÜ
 
code
 
Ú
 
çu»


3102 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


3104 
PUBLIC
 
dma_¡®l_’gšes


3105 
dma_¡®l_’gšes
 
PROC


3106 
push
 
bp


3107 
mov
 
bp
, 
¥


3108 
push
 
bx


3109 
push
 
cx


3110 
push
 
dx


3112 ; 
Save
 
¡®l
 
æags


3113 
mov
 
bl
, 
®
 ; 
TX
 
¡®l
 
æag


3114 
mov
 
bh
, 
ah
 ; 
RX
 
¡®l
 
æag


3116 ; 
G‘
 
I
/
O
 
ba£
 
äom
 
	$cÚ‹xt
 (
·s£d
 
š
 
DX
)

3117 
‹¡
 
dx
, dx

3118 
jz
 .
no_io_ba£


3120 ; 
S–eù
 
wšdow
 7 
DMA
 
cÚŒŞ


3121 
push
 
dx


3122 
add
 
dx
, 0E
h
 ; 
Commªd
 

3123 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

3124 
out
 
dx
, 
ax


3125 
pİ
 
dx


3127 ; 
Sm®l
 
d–ay
 
wšdow
 
£ËùiÚ


3128 
mov
 
cx
, 100

3129 .
wšdow_d–ay
:

3130 
nİ


3131 
loİ
 .
wšdow_d–ay


3133 ; 
SÎ
 
TX
 
’gše
 
»que¡ed


3134 
‹¡
 
bl
, bl

3135 
jz
 .
sk_tx_¡®l


3137 
push
 
dx


3138 
add
 
dx
, 0E
h
 ; 
Commªd
 

3139 
mov
 
ax
, (6 << 11è+ 2 ; 
DownSÎ
 
commªd


3140 
out
 
dx
, 
ax


3141 
pİ
 
dx


3143 ; 
Wa™
 
TX
 
’gše
 
to
 
¡®l


3144 
mov
 
cx
, 1000 ; 
Timeout
 
couÁ”


3145 .
tx_¡®l_wa™
:

3146 
push
 
dx


3147 
add
 
dx
, 0E
h
 ; 
Stus
 

3148 
š
 
ax
, 
dx


3149 
pİ
 
dx


3150 
‹¡
 
ax
, 0800
h
 ; 
Check
 
DMA
 
š
 
´og»ss
 
b™


3151 
jz
 .
tx_¡®Ëd


3152 
dec
 
cx


3153 
jnz
 .
tx_¡®l_wa™


3155 ; 
TX
 
¡®l
 
timeout


3156 
mov
 
ax
, -1

3157 
jmp
 .
ex™


3159 .
tx_¡®Ëd
:

3160 .
sk_tx_¡®l
:

3161 ; 
SÎ
 
RX
 
’gše
 
»que¡ed


3162 
‹¡
 
bh
, bh

3163 
jz
 .
sk_rx_¡®l


3165 
push
 
dx


3166 
add
 
dx
, 0E
h
 ; 
Commªd
 

3167 
mov
 
ax
, (6 << 11è+ 0 ; 
UpSÎ
 
commªd


3168 
out
 
dx
, 
ax


3169 
pİ
 
dx


3171 ; 
Wa™
 
RX
 
’gše
 
to
 
¡®l


3172 
mov
 
cx
, 1000 ; 
Timeout
 
couÁ”


3173 .
rx_¡®l_wa™
:

3174 
push
 
dx


3175 
add
 
dx
, 0E
h
 ; 
Stus
 

3176 
š
 
ax
, 
dx


3177 
pİ
 
dx


3178 
‹¡
 
ax
, 0800
h
 ; 
Check
 
DMA
 
š
 
´og»ss
 
b™


3179 
jz
 .
rx_¡®Ëd


3180 
dec
 
cx


3181 
jnz
 .
rx_¡®l_wa™


3183 ; 
RX
 
¡®l
 
timeout


3184 
mov
 
ax
, -1

3185 
jmp
 .
ex™


3187 .
rx_¡®Ëd
:

3188 .
sk_rx_¡®l
:

3189 ; 
Sucûss


3190 
mov
 
ax
, 0

3191 
jmp
 .
ex™


3193 .
no_io_ba£
:

3194 
mov
 
ax
, -1

3196 .
ex™
:

3197 
pİ
 
dx


3198 
pİ
 
cx


3199 
pİ
 
bx


3200 
pİ
 
bp


3201 
»t


3202 
dma_¡®l_’gšes
 
ENDP


3205 ; 
dma_un¡®l_’gšes
 - 
Un¡®l
 
DMA
 
’gšes
 
aá”
 
»cov”y


3207 ; 
IÅut
: 
AL
 = 1 
to
 
un¡®l
 
TX
, 0Ø
sk
 TX

3208 ; 
AH
 = 1 
to
 
un¡®l
 
RX
, 0Ø
sk
 RX

3209 ; 
DX
 = 
I
/
O
 
ba£
 
add»ss


3210 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
Ãg©ive
 
”rÜ
 
code
 
Ú
 
çu»


3211 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


3213 
PUBLIC
 
dma_un¡®l_’gšes


3214 
dma_un¡®l_’gšes
 
PROC


3215 
push
 
bp


3216 
mov
 
bp
, 
¥


3217 
push
 
bx


3218 
push
 
cx


3219 
push
 
dx


3221 ; 
Save
 
un¡®l
 
æags


3222 
mov
 
bl
, 
®
 ; 
TX
 
un¡®l
 
æag


3223 
mov
 
bh
, 
ah
 ; 
RX
 
un¡®l
 
æag


3225 ; 
G‘
 
I
/
O
 
ba£


3226 
‹¡
 
dx
, dx

3227 
jz
 .
no_io_ba£


3229 ; 
S–eù
 
wšdow
 7 
DMA
 
cÚŒŞ


3230 
push
 
dx


3231 
add
 
dx
, 0E
h
 ; 
Commªd
 

3232 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

3233 
out
 
dx
, 
ax


3234 
pİ
 
dx


3236 ; 
Sm®l
 
d–ay
 
wšdow
 
£ËùiÚ


3237 
mov
 
cx
, 100

3238 .
wšdow_d–ay
:

3239 
nİ


3240 
loİ
 .
wšdow_d–ay


3242 ; 
Un¡®l
 
TX
 
’gše
 
»que¡ed


3243 
‹¡
 
bl
, bl

3244 
jz
 .
sk_tx_un¡®l


3246 
push
 
dx


3247 
add
 
dx
, 0E
h
 ; 
Commªd
 

3248 
mov
 
ax
, (6 << 11è+ 3 ; 
DownUn¡®l
 
commªd


3249 
out
 
dx
, 
ax


3250 
pİ
 
dx


3252 .
sk_tx_un¡®l
:

3253 ; 
Un¡®l
 
RX
 
’gše
 
»que¡ed


3254 
‹¡
 
bh
, bh

3255 
jz
 .
sk_rx_un¡®l


3257 
push
 
dx


3258 
add
 
dx
, 0E
h
 ; 
Commªd
 

3259 
mov
 
ax
, (6 << 11è+ 1 ; 
UpUn¡®l
 
commªd


3260 
out
 
dx
, 
ax


3261 
pİ
 
dx


3263 .
sk_rx_un¡®l
:

3264 ; 
Sucûss


3265 
mov
 
ax
, 0

3266 
jmp
 .
ex™


3268 .
no_io_ba£
:

3269 
mov
 
ax
, -1

3271 .
ex™
:

3272 
pİ
 
dx


3273 
pİ
 
cx


3274 
pİ
 
bx


3275 
pİ
 
bp


3276 
»t


3277 
dma_un¡®l_’gšes
 
ENDP


3280 ; 
dma_¡¬t_Œªsãr
 - 
S¹
 
DMA
 
Œªsãr
 
’gšes


3282 ; 
IÅut
: 
AL
 = 1 
to
 
¡¬t
 
TX
, 0Ø
sk
 TX

3283 ; 
AH
 = 1 
to
 
¡¬t
 
RX
, 0Ø
sk
 RX

3284 ; 
DX
 = 
I
/
O
 
ba£
 
add»ss


3285 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
Ãg©ive
 
”rÜ
 
code
 
Ú
 
çu»


3286 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


3288 
PUBLIC
 
dma_¡¬t_Œªsãr


3289 
dma_¡¬t_Œªsãr
 
PROC


3290 
push
 
bp


3291 
mov
 
bp
, 
¥


3292 
push
 
bx


3293 
push
 
cx


3294 
push
 
dx


3296 ; 
Save
 
¡¬t
 
æags


3297 
mov
 
bl
, 
®
 ; 
TX
 
¡¬t
 
æag


3298 
mov
 
bh
, 
ah
 ; 
RX
 
¡¬t
 
æag


3300 ; 
G‘
 
I
/
O
 
ba£


3301 
‹¡
 
dx
, dx

3302 
jz
 .
no_io_ba£


3304 ; 
S–eù
 
wšdow
 7 
DMA
 
cÚŒŞ


3305 
push
 
dx


3306 
add
 
dx
, 0E
h
 ; 
Commªd
 

3307 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

3308 
out
 
dx
, 
ax


3309 
pİ
 
dx


3311 ; 
Sm®l
 
d–ay
 
wšdow
 
£ËùiÚ


3312 
mov
 
cx
, 100

3313 .
wšdow_d–ay
:

3314 
nİ


3315 
loİ
 .
wšdow_d–ay


3317 ; 
S¹
 
TX
 
DMA
 
»que¡ed


3318 
‹¡
 
bl
, bl

3319 
jz
 .
sk_tx_¡¬t


3321 
push
 
dx


3322 
add
 
dx
, 0E
h
 ; 
Commªd
 

3323 
mov
 
ax
, (20 << 11è+ 1 ; 
S¹DMADown
 
commªd


3324 
out
 
dx
, 
ax


3325 
pİ
 
dx


3327 .
sk_tx_¡¬t
:

3328 ; 
S¹
 
RX
 
DMA
 
»que¡ed


3329 
‹¡
 
bh
, bh

3330 
jz
 .
sk_rx_¡¬t


3332 
push
 
dx


3333 
add
 
dx
, 0E
h
 ; 
Commªd
 

3334 
mov
 
ax
, (20 << 11è+ 0 ; 
S¹DMAUp
 
commªd


3335 
out
 
dx
, 
ax


3336 
pİ
 
dx


3338 .
sk_rx_¡¬t
:

3339 ; 
Sucûss


3340 
mov
 
ax
, 0

3341 
jmp
 .
ex™


3343 .
no_io_ba£
:

3344 
mov
 
ax
, -1

3346 .
ex™
:

3347 
pİ
 
dx


3348 
pİ
 
cx


3349 
pİ
 
bx


3350 
pİ
 
bp


3351 
»t


3352 
dma_¡¬t_Œªsãr
 
ENDP


3355 ; 
dma_g‘_’gše_¡©us
 - 
G‘
 
DMA
 
’gše
 
¡©us


3357 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


3358 ; 
ES
:
BX
 = 
poš‹r
 
to
 
¡©us
 
	`¡ruùu»
 (
tx_¡©us
, 
rx_¡©us
)

3359 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
Ãg©ive
 
”rÜ
 
code
 
Ú
 
çu»


3360 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI


3362 
PUBLIC
 
dma_g‘_’gše_¡©us


3363 
dma_g‘_’gše_¡©us
 
PROC


3364 
push
 
bp


3365 
mov
 
bp
, 
¥


3366 
push
 
bx


3367 
push
 
cx


3368 
push
 
dx


3369 
push
 
si


3371 ; 
G‘
 
I
/
O
 
ba£


3372 
‹¡
 
dx
, dx

3373 
jz
 .
no_io_ba£


3375 ; 
Save
 
¡©us
 
poš‹r


3376 
mov
 
si
, 
bx


3378 ; 
S–eù
 
wšdow
 7 
DMA
 
¡©us


3379 
push
 
dx


3380 
add
 
dx
, 0E
h
 ; 
Commªd
 

3381 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

3382 
out
 
dx
, 
ax


3383 
pİ
 
dx


3385 ; 
Sm®l
 
d–ay
 
wšdow
 
£ËùiÚ


3386 
mov
 
cx
, 100

3387 .
wšdow_d–ay
:

3388 
nİ


3389 
loİ
 .
wšdow_d–ay


3391 ; 
R—d
 
DMA
 
¡©us
 

3392 
push
 
dx


3393 
add
 
dx
, 0E
h
 ; 
Stus
 

3394 
š
 
ax
, 
dx


3395 
pİ
 
dx


3397 ; 
ExŒaù
 
TX
 
	$¡©us
 (
b™s
 
»Ï‹d
 
to
 
down
 
DMA
)

3398 
mov
 
bx
, 
ax


3399 
ªd
 
bx
, 0200
h
 ; 
Down
 
com¶‘e
 
	$b™
 (
b™
 9)

3400 
mov
 [
es
:
si
], 
bx
 ; 
StÜe
 
TX
 
¡©us


3402 ; 
ExŒaù
 
RX
 
	$¡©us
 (
b™s
 
»Ï‹d
 
to
 
up
 
DMA
)

3403 
mov
 
bx
, 
ax


3404 
ªd
 
bx
, 0400
h
 ; 
Up
 
com¶‘e
 
	$b™
 (
b™
 10)

3405 
mov
 [
es
:
si
+4], 
bx
 ; 
StÜe
 
RX
 
	`¡©us
 (
off£t
 
by
 4 
by‹s
)

3407 ; 
Sucûss


3408 
mov
 
ax
, 0

3409 
jmp
 .
ex™


3411 .
no_io_ba£
:

3412 
mov
 
ax
, -1

3414 .
ex™
:

3415 
pİ
 
si


3416 
pİ
 
dx


3417 
pİ
 
cx


3418 
pİ
 
bx


3419 
pİ
 
bp


3420 
»t


3421 
dma_g‘_’gše_¡©us
 
ENDP


3424 ; 
dma_´•¬e_coh”’t_bufãr
 - 
P»·»
 
bufãr
 
ÿche
 
coh”’cy


3426 ; 
IÅut
: 
ES
:
BX
 = 
bufãr
 
add»ss


3427 ; 
CX
 = 
bufãr
 
Ëngth


3428 ; 
DL
 = 
	`dœeùiÚ
 (0=
TX
, 1=
RX
)

3429 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
Ãg©ive
 
”rÜ
 
code
 
Ú
 
çu»


3430 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


3432 
PUBLIC
 
dma_´•¬e_coh”’t_bufãr


3433 
dma_´•¬e_coh”’t_bufãr
 
PROC


3434 
push
 
bp


3435 
mov
 
bp
, 
¥


3436 
push
 
bx


3437 
push
 
cx


3438 
push
 
dx


3440 ; 
FÜ
 
ISA
 
bus
 
ma¡”šg
, 
we
 
Ãed
 
to
 
’su»
 
ÿche
 
coh”’cy


3441 ; 
This
 
is
 
a
 
sim¶if›d
 
im¶em’tiÚ
 
DOS
 
’vœÚm’t


3443 ; 
Check
 
bufãr
 
add»ss
 
is
 
v®id


3444 
‹¡
 
bx
, bx

3445 
jz
 .
šv®id_bufãr


3447 ; 
Check
 
bufãr
 
Ëngth


3448 
‹¡
 
cx
, cx

3449 
jz
 .
šv®id_bufãr


3451 ; 
Check
 
bufãr
 
is
 
š
 
su™abË
 
memÜy
 
¿nge
 
ISA
 
DMA


3452 ; 
ISA
 
DMA
 
is
 
lim™ed
 
to
 24-
b™
 
	$add»ssšg
 (16
MB
)

3453 
mov
 
ax
, 
es


3454 
cmp
 
ax
, 0FFFF
h
 ; 
Check
 
£gm’t
 
is
 
»asÚabË


3455 
ja
 .
šv®id_bufãr


3457 ; 
FÜ
 
DOS
, 
we
 
´im¬y
 
Ãed
 
to
 
æush
 
ªy
 
CPU
 
ÿches


3458 ; 
This
 
is
 
CPU
-
d•’d’t
, 
but
 
mo¡
 386/486 
sy¡ems
 
Ãed
 
WBINVD


3460 ; 
Check
 
we
're„unning on 386 or†ater (has cache)

3461 
ÿÎ
 
g‘_ıu_ã©u»s
 ; 
G‘
 
CPU
 
ã©u»s


3462 
‹¡
 
ax
, 0001
h
 ; 
Check
 
ÿche
 
´e£Á


3463 
jz
 .
no_ÿche_æush_Ãeded


3465 ; 
Flush
 
ÿche
 
DMA
 
	`§ãty
 (386/486/
P’tium
)

3466 ; 
NÙe
: 
This
 
is
 
´iveged
 
š¡ruùiÚ
, 
may
 
çuÉ
 
Ú
 
some
 
sy¡ems


3467 
pushf


3468 
şi
 ; 
Di§bË
 
š‹¼u±s


3470 ; 
Issue
 
ÿche
 
	`æush
 (
wr™e
-
back
 
ªd
 
šv®id©e
)

3471 ; 
This
 
æushes
 
®l
 
ÿches
, 
which
 
is
 
ov”kl
 
but
 
§ã


3472 .
by‹
 0F
h
, 09h ; 
WBINVD
 
š¡ruùiÚ


3474 
pİf
 ; 
Re¡Üe
 
š‹¼u±s


3476 .
no_ÿche_æush_Ãeded
:

3477 ; 
Sucûss


3478 
mov
 
ax
, 0

3479 
jmp
 .
ex™


3481 .
šv®id_bufãr
:

3482 
mov
 
ax
, -1

3484 .
ex™
:

3485 
pİ
 
dx


3486 
pİ
 
cx


3487 
pİ
 
bx


3488 
pİ
 
bp


3489 
»t


3490 
dma_´•¬e_coh”’t_bufãr
 
ENDP


3493 ; 
dma_com¶‘e_coh”’t_bufãr
 - 
Com¶‘e
 
ÿche
 
coh”’cy
 
aá”
 
DMA


3495 ; 
IÅut
: 
ES
:
BX
 = 
bufãr
 
add»ss


3496 ; 
CX
 = 
bufãr
 
Ëngth


3497 ; 
DL
 = 
	`dœeùiÚ
 (0=
TX
, 1=
RX
)

3498 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
Ãg©ive
 
”rÜ
 
code
 
Ú
 
çu»


3499 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


3501 
PUBLIC
 
dma_com¶‘e_coh”’t_bufãr


3502 
dma_com¶‘e_coh”’t_bufãr
 
PROC


3503 
push
 
bp


3504 
mov
 
bp
, 
¥


3505 
push
 
bx


3506 
push
 
cx


3507 
push
 
dx


3509 ; 
Check
 
bufãr
 
add»ss
 
is
 
v®id


3510 
‹¡
 
bx
, bx

3511 
jz
 .
šv®id_bufãr


3513 ; 
Check
 
bufãr
 
Ëngth


3514 
‹¡
 
cx
, cx

3515 
jz
 .
šv®id_bufãr


3517 ; 
FÜ
 
RX
 
İ”©iÚs
, 
we
 
Ãed
 
to
 
šv®id©e
 
ÿche
 
lšes


3518 ; 
to
 
’su»
 
CPU
 
£es
 
d©a
 
wr™‹n
 
by
 
DMA


3519 
cmp
 
dl
, 1 ; 
Check
 
RX
 
İ”©iÚ


3520 
jÃ
 .
tx_İ”©iÚ


3522 ; 
RX
 
İ”©iÚ
 - 
šv®id©e
 
ÿche
 
to
 
£e
 
DMA
 
d©a


3523 
ÿÎ
 
g‘_ıu_ã©u»s
 ; 
G‘
 
CPU
 
ã©u»s


3524 
‹¡
 
ax
, 0001
h
 ; 
Check
 
ÿche
 
´e£Á


3525 
jz
 .
no_ÿche_šv®id©e_Ãeded


3527 
pushf


3528 
şi
 ; 
Di§bË
 
š‹¼u±s


3530 ; 
Inv®id©e
 
ÿche
 
	`lšes
 (
RX
 
we
 
wªt
 
to
 
£e
 
DMA
 
d©a
)

3531 .
by‹
 0F
h
, 08h ; 
INVD
 
š¡ruùiÚ


3533 
pİf
 ; 
Re¡Üe
 
š‹¼u±s


3534 
jmp
 .
ÿche_com¶‘e


3536 .
tx_İ”©iÚ
:

3537 ; 
TX
 
İ”©iÚ
 - 
no
 
¥ecŸl
 
aùiÚ
 
Ãeded
 
aá”
 
DMA


3538 
jmp
 .
ÿche_com¶‘e


3540 .
no_ÿche_šv®id©e_Ãeded
:

3541 .
ÿche_com¶‘e
:

3542 ; 
Sucûss


3543 
mov
 
ax
, 0

3544 
jmp
 .
ex™


3546 .
šv®id_bufãr
:

3547 
mov
 
ax
, -1

3549 .
ex™
:

3550 
pİ
 
dx


3551 
pİ
 
cx


3552 
pİ
 
bx


3553 
pİ
 
bp


3554 
»t


3555 
dma_com¶‘e_coh”’t_bufãr
 
ENDP


3558 ; 
£tup_advªûd_dma_desütÜs
 - 
S‘up
 
h¬dw¬e
 
desütÜ
 
poš‹rs


3560 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


3561 ; 
ES
:
BX
 = 
poš‹r
 
to
 
TX
 
ršg
 
physiÿl
 
add»ss


3562 ; 
ES
:
SI
 = 
poš‹r
 
to
 
RX
 
ršg
 
physiÿl
 
add»ss


3563 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
Ãg©ive
 
”rÜ
 
code
 
Ú
 
çu»


3564 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI


3566 
PUBLIC
 
£tup_advªûd_dma_desütÜs


3567 
£tup_advªûd_dma_desütÜs
 
PROC


3568 
push
 
bp


3569 
mov
 
bp
, 
¥


3570 
push
 
bx


3571 
push
 
cx


3572 
push
 
dx


3573 
push
 
si


3574 
push
 
di


3576 ; 
G‘
 
I
/
O
 
ba£


3577 
‹¡
 
dx
, dx

3578 
jz
 .
no_io_ba£


3580 ; 
Save
 
desütÜ
 
add»s£s


3581 
mov
 
di
, 
si
 ; 
Save
 
RX
 
ršg
 
add»ss


3583 ; 
S–eù
 
wšdow
 7 
desütÜ
 
poš‹r
 
£tup


3584 
push
 
dx


3585 
add
 
dx
, 0E
h
 ; 
Commªd
 

3586 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

3587 
out
 
dx
, 
ax


3588 
pİ
 
dx


3590 ; 
Sm®l
 
d–ay
 
wšdow
 
£ËùiÚ


3591 
mov
 
cx
, 100

3592 .
wšdow_d–ay
:

3593 
nİ


3594 
loİ
 .
wšdow_d–ay


3596 ; 
S‘
 
TX
 
desütÜ
 
li¡
 
	$poš‹r
 (
Down
 
Li¡
 
Poš‹r
)

3597 
push
 
dx


3598 
add
 
dx
, 404
h
 ; 
Down
 
li¡
 
poš‹r
 

3599 
mov
 
ax
, [
es
:
bx
] ; 
G‘
 
low
 
wÜd
 
of
 
TX
 
ršg
 
add»ss


3600 
out
 
dx
, 
ax


3601 
add
 
dx
, 2 ; 
High
 
wÜd
 

3602 
mov
 
ax
, [
es
:
bx
+2] ; 
G‘
 
high
 
wÜd
 
of
 
TX
 
ršg
 
add»ss


3603 
out
 
dx
, 
ax


3604 
pİ
 
dx


3606 ; 
S‘
 
RX
 
desütÜ
 
li¡
 
	$poš‹r
 (
Up
 
Li¡
 
Poš‹r
)

3607 
push
 
dx


3608 
add
 
dx
, 418
h
 ; 
Up
 
li¡
 
poš‹r
 

3609 
mov
 
ax
, [
es
:
di
] ; 
G‘
 
low
 
wÜd
 
of
 
RX
 
ršg
 
add»ss


3610 
out
 
dx
, 
ax


3611 
add
 
dx
, 2 ; 
High
 
wÜd
 

3612 
mov
 
ax
, [
es
:
di
+2] ; 
G‘
 
high
 
wÜd
 
of
 
RX
 
ršg
 
add»ss


3613 
out
 
dx
, 
ax


3614 
pİ
 
dx


3616 ; 
EÇbË
 
bus
 
ma¡”šg
 
š
 
the
 
NIC


3617 
push
 
dx


3618 
add
 
dx
, 0E
h
 ; 
Commªd
 

3619 
mov
 
ax
, (14 << 11è| 07FF
h
 ; 
S‘
 
š‹¼u±
 
’abË
 
w™h
 
®l
 
DMA
 
b™s


3620 
out
 
dx
, 
ax


3621 
pİ
 
dx


3623 ; 
Sucûss


3624 
mov
 
ax
, 0

3625 
jmp
 .
ex™


3627 .
no_io_ba£
:

3628 
mov
 
ax
, -1

3630 .
ex™
:

3631 
pİ
 
di


3632 
pİ
 
si


3633 
pİ
 
dx


3634 
pİ
 
cx


3635 
pİ
 
bx


3636 
pİ
 
bp


3637 
»t


3638 
£tup_advªûd_dma_desütÜs
 
ENDP


3641 ; 
advªûd_dma_š‹¼u±_check
 - 
Check
 
advªûd
 
DMA
 
š‹¼u±s


3643 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


3644 ; 
Ouut
: 
AX
 = 
š‹¼u±
 
¡©us
 
mask


3645 ; 
BX
 = 
DMA
 
com¶‘iÚ
 
¡©us


3646 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


3648 
PUBLIC
 
advªûd_dma_š‹¼u±_check


3649 
advªûd_dma_š‹¼u±_check
 
PROC


3650 
push
 
bp


3651 
mov
 
bp
, 
¥


3652 
push
 
cx


3653 
push
 
dx


3655 ; 
In™Ÿlize
  
v®ues


3656 
mov
 
ax
, 0 ; 
IÁ”ru±
 
¡©us


3657 
mov
 
bx
, 0 ; 
DMA
 
com¶‘iÚ
 
¡©us


3659 ; 
G‘
 
I
/
O
 
ba£


3660 
‹¡
 
dx
, dx

3661 
jz
 .
no_io_ba£


3663 ; 
R—d
 
š‹¼u±
 
¡©us
 

3664 
push
 
dx


3665 
add
 
dx
, 0E
h
 ; 
Stus
 

3666 
š
 
ax
, 
dx
 ; 
R—d
 
¡©us


3667 
pİ
 
dx


3669 ; 
Check
 
DMA
-
»Ï‹d
 
š‹¼u±s


3670 
mov
 
bx
, 
ax
 ; 
Save
 
fuÎ
 
¡©us


3672 ; 
ExŒaù
 
DMA
 
com¶‘iÚ
 
b™s


3673 
ªd
 
bx
, 0700
h
 ; 
Mask
 
DMA
 
DÚe
, 
Down
 
Com¶‘e
, 
Up
 Complete

3675 ; 
Check
 
¥ecific
 
DMA
 
š‹¼u±
 
cÚd™iÚs


3676 
‹¡
 
ax
, 0100
h
 ; 
DMA
 
	$DÚe
 (
b™
 8)

3677 
jz
 .
no_dma_dÚe


3678 
Ü
 
bx
, 0001
h
 ; 
S‘
 
DMA
 
dÚe
 
æag


3680 .
no_dma_dÚe
:

3681 
‹¡
 
ax
, 0200
h
 ; 
Down
 
	`Com¶‘e
 (
b™
 9 - 
TX
)

3682 
jz
 .
no_tx_com¶‘e


3683 
Ü
 
bx
, 0002
h
 ; 
S‘
 
TX
 
com¶‘e
 
æag


3685 .
no_tx_com¶‘e
:

3686 
‹¡
 
ax
, 0400
h
 ; 
Up
 
	`Com¶‘e
 (
b™
 10 - 
RX
)

3687 
jz
 .
no_rx_com¶‘e


3688 
Ü
 
bx
, 0004
h
 ; 
S‘
 
RX
 
com¶‘e
 
æag


3690 .
no_rx_com¶‘e
:

3691 ; 
R‘uº
 
š‹¼u±
 
¡©us
 
š
 
AX
, 
DMA
 stu š 
BX


3692 
jmp
 .
ex™


3694 .
no_io_ba£
:

3695 
mov
 
ax
, 0

3696 
mov
 
bx
, 0

3698 .
ex™
:

3699 
pİ
 
dx


3700 
pİ
 
cx


3701 
pİ
 
bp


3702 
»t


3703 
advªûd_dma_š‹¼u±_check
 
ENDP


3706 ; 
HAL
 
BRIDGE
 
FUNCTIONS
 - 
C
 
to
 
As£mbly
 
IÁ”çû


3710 ; 
asm_3c509b_d‘eù_h¬dw¬e
 - 
HAL
 
bridge
 3C509B 
d‘eùiÚ


3712 ; 
IÅut
: [
BP
+4] = 
nic_cÚ‹xt
 *
	`cÚ‹xt
 (
C
 
ÿÎšg
 
cÚv’tiÚ
)

3713 ; 
Ouut
: 
AX
 = 
HAL_SUCCESS
 
Ü
 
”rÜ
 
code


3714 ; 
U£s
: 
Snd¬d
 
C
 
ÿÎšg
 
cÚv’tiÚ


3716 
PUBLIC
 
asm_3c509b_d‘eù_h¬dw¬e


3717 
asm_3c509b_d‘eù_h¬dw¬e
 
PROC


3718 
push
 
bp


3719 
mov
 
bp
, 
¥


3720 
push
 
bx


3721 
push
 
cx


3722 
push
 
dx


3723 
push
 
si


3725 ; 
C®l
 
our
 
d‘eù
 
funùiÚ


3726 
ÿÎ
 
d‘eù_3c509b


3727 
cmp
 
ax
, 0

3728 
je
 .
nÙ_found


3730 ; 
Found
 - 
¡Üe
 
I
/
O
 
ba£
 
š
 
cÚ‹xt
 
¡ruùu»


3731 ; 
PİuÏ‹
 
nic_cÚ‹xt
 
¡ruùu»


3732 
push
 
si


3733 
push
 
di


3734 
push
 
cx


3735 
push
 
bx


3737 ; 
ES
:
DI
 
should
 
pošt
 
to
 
nic_cÚ‹xt
 
¡ruùu»


3738 ; 
AL
 
cÚšs
 
š¡ªû
 
šdex


3740 
xÜ
 
ah
,‡h

3741 
mov
 
si
, 
ax
 ; 
Save
 
š¡ªû
 
šdex


3743 ; 
StÜe
 
I
/
O
 
	`ba£
 (16-
b™
)

3744 
shl
 
si
, 1 ; 
WÜd
 
off£t


3745 
mov
 
bx
, 
OFFSET
 
hw_ioba£_bË


3746 
mov
 
ax
, [
bx
+
si
]

3747 
¡osw
 ; 
StÜe
 
ioba£


3749 ; 
StÜe
 
	`IRQ
 (8-
b™
)

3750 
shr
 
si
, 1 ; 
Back
 
to
 
by‹
 
off£t


3751 
mov
 
bx
, 
OFFSET
 
hw_œq_lšes


3752 
mov
 
®
, [
bx
+
si
]

3753 
¡osb
 ; 
StÜe
 
œq


3755 ; 
StÜe
 
NIC
 
	`ty³
 (8-
b™
)

3756 
mov
 
bx
, 
OFFSET
 
hw_ty³s


3757 
mov
 
®
, [
bx
+
si
]

3758 
¡osb
 ; 
StÜe
 
nic_ty³


3760 ; 
StÜe
 
	`æags
 (8-
b™
)

3761 
mov
 
bx
, 
OFFSET
 
hw_æags_bË


3762 
mov
 
®
, [
bx
+
si
]

3763 
¡osb
 ; 
StÜe
 
æags


3765 ; 
StÜe
 
cu¼’t
 
	`wšdow
 (8-
b™
,  
to
 1)

3766 
mov
 
®
, 1

3767 
¡osb
 ; 
StÜe
 
wšdow


3769 ; 
StÜe
 
MAC
 
	$add»ss
 (6 
by‹s
)

3770 
mov
 
ax
, 
si


3771 
mov
 
ş
, 6

3772 
mul
 
ş
 ; 
AX
 = 
šdex
 * 6

3773 
mov
 
si
, 
OFFSET
 
hw_mac_add»s£s


3774 
add
 
si
, 
ax


3775 
mov
 
cx
, 6

3776 
»p
 
movsb
 ; 
Cİy
 
MAC
 
add»ss


3778 ; 
In™Ÿlize
 
¡©i¡ics
 
couÁ”s
 
to
 0

3779 
xÜ
 
ax
,‡x

3780 
¡osw
 ; 
tx_ä“
 = 0

3781 
¡osw
 ; 
rx_¡©us
 = 0

3782 
¡osw
 ; 
tx_·ck‘s
 
low
 = 0

3783 
¡osw
 ; 
tx_·ck‘s
 
high
 = 0

3784 
¡osw
 ; 
rx_·ck‘s
 
low
 = 0

3785 
¡osw
 ; 
rx_·ck‘s
 
high
 = 0

3786 
¡osw
 ; 
tx_”rÜs
 
low
 = 0

3787 
¡osw
 ; 
tx_”rÜs
 
high
 = 0

3788 
¡osw
 ; 
rx_”rÜs
 
low
 = 0

3789 
¡osw
 ; 
rx_”rÜs
 
high
 = 0

3791 
pİ
 
bx


3792 
pİ
 
cx


3793 
pİ
 
di


3794 
pİ
 
si


3795 
mov
 
bx
, 0 ; 
HAL_SUCCESS


3796 
jmp
 .
ex™


3798 .
nÙ_found
:

3799 
mov
 
bx
, -2 ; 
HAL_ERROR_HARDWARE_FAILURE


3801 .
ex™
:

3802 
mov
 
ax
, 
bx
 ; 
R‘uº
 
v®ue
 
š
 
AX


3803 
pİ
 
si


3804 
pİ
 
dx


3805 
pİ
 
cx


3806 
pİ
 
bx


3807 
pİ
 
bp


3808 
»t


3809 
asm_3c509b_d‘eù_h¬dw¬e
 
ENDP


3812 ; 
asm_3c509b_š™_h¬dw¬e
 - 
HAL
 
bridge
 3C509B 
š™Ÿliz©iÚ


3814 ; 
IÅut
: [
BP
+4] = 
nic_cÚ‹xt
 *
	`cÚ‹xt
 (
C
 
ÿÎšg
 
cÚv’tiÚ
)

3815 ; 
Ouut
: 
AX
 = 
HAL_SUCCESS
 
Ü
 
”rÜ
 
code


3816 ; 
U£s
: 
Snd¬d
 
C
 
ÿÎšg
 
cÚv’tiÚ


3818 
PUBLIC
 
asm_3c509b_š™_h¬dw¬e


3819 
asm_3c509b_š™_h¬dw¬e
 
PROC


3820 
push
 
bp


3821 
mov
 
bp
, 
¥


3822 
push
 
bx


3823 
push
 
cx


3824 
push
 
dx


3825 
push
 
si


3827 ; 
G‘
 
cÚ‹xt
 
poš‹r


3828 
mov
 
si
, [
bp
+4] ; 
nic_cÚ‹xt
 
poš‹r


3829 ; 
ExŒaù
 
I
/
O
 
ba£
 
äom
 
cÚ‹xt
 
¡ruùu»


3830 
push
 
si


3831 
push
 
ds


3833 ; 
DS
:
SI
 
pošts
 
to
 
cÚ‹xt
 
¡ruùu»


3834 
lds
 
si
, [
bp
+4] ; 
Lßd
 
cÚ‹xt
 
poš‹r


3835 
lodsw
 ; 
Lßd
 
	$ioba£
 (
fœ¡
 
f›ld
)

3836 
mov
 
dx
, 
ax
 ; 
DX
 = 
I
/
O
 
ba£


3838 
pİ
 
ds


3839 
pİ
 
si


3840 ; 
FÜ
 
now
, 
u£
 
fœ¡
 
d‘eùed
 
I
/
O
 
ba£


3841 
mov
 
dx
, [
hw_io_ba£s
] ; 
G‘
 
¡Üed
 
I
/
O
 
ba£


3842 
mov
 
®
, 0 ; 
NIC
 
šdex
 0

3844 ; 
C®l
 
our
 
š™
 
funùiÚ


3845 
ÿÎ
 
š™_3c509b


3846 
cmp
 
ax
, 0

3847 
jÃ
 .
š™_çed


3849 
mov
 
bx
, 0 ; 
HAL_SUCCESS


3850 
jmp
 .
ex™


3852 .
š™_çed
:

3853 
mov
 
bx
, -6 ; 
HAL_ERROR_INITIALIZATION


3855 .
ex™
:

3856 
mov
 
ax
, 
bx
 ; 
R‘uº
 
v®ue
 
š
 
AX


3857 
pİ
 
si


3858 
pİ
 
dx


3859 
pİ
 
cx


3860 
pİ
 
bx


3861 
pİ
 
bp


3862 
»t


3863 
asm_3c509b_š™_h¬dw¬e
 
ENDP


3865 ; 
Add™iÚ®
 
HAL
 
bridge
 
funùiÚ
 
¡ubs
 
com¶‘e
 
vbË


3866 
PUBLIC
 
asm_3c509b_»£t_h¬dw¬e


3867 
asm_3c509b_»£t_h¬dw¬e
 
PROC


3868 
push
 
bp


3869 
mov
 
bp
, 
¥


3870 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3871 
pİ
 
bp


3872 
»t


3873 
asm_3c509b_»£t_h¬dw¬e
 
ENDP


3875 
PUBLIC
 
asm_3c509b_cÚfigu»_medŸ


3876 
asm_3c509b_cÚfigu»_medŸ
 
PROC


3877 
push
 
bp


3878 
mov
 
bp
, 
¥


3879 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3880 
pİ
 
bp


3881 
»t


3882 
asm_3c509b_cÚfigu»_medŸ
 
ENDP


3884 
PUBLIC
 
asm_3c509b_£t_¡©iÚ_add»ss


3885 
asm_3c509b_£t_¡©iÚ_add»ss
 
PROC


3886 
push
 
bp


3887 
mov
 
bp
, 
¥


3888 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3889 
pİ
 
bp


3890 
»t


3891 
asm_3c509b_£t_¡©iÚ_add»ss
 
ENDP


3893 
PUBLIC
 
asm_3c509b_’abË_š‹¼u±s


3894 
asm_3c509b_’abË_š‹¼u±s
 
PROC


3895 
push
 
bp


3896 
mov
 
bp
, 
¥


3897 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3898 
pİ
 
bp


3899 
»t


3900 
asm_3c509b_’abË_š‹¼u±s
 
ENDP


3902 
PUBLIC
 
asm_3c509b_¡¬t_Œªsûiv”


3903 
asm_3c509b_¡¬t_Œªsûiv”
 
PROC


3904 
push
 
bp


3905 
mov
 
bp
, 
¥


3906 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3907 
pİ
 
bp


3908 
»t


3909 
asm_3c509b_¡¬t_Œªsûiv”
 
ENDP


3911 
PUBLIC
 
asm_3c509b_¡İ_Œªsûiv”


3912 
asm_3c509b_¡İ_Œªsûiv”
 
PROC


3913 
push
 
bp


3914 
mov
 
bp
, 
¥


3915 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3916 
pİ
 
bp


3917 
»t


3918 
asm_3c509b_¡İ_Œªsûiv”
 
ENDP


3920 
PUBLIC
 
asm_3c509b_g‘_lšk_¡©us


3921 
asm_3c509b_g‘_lšk_¡©us
 
PROC


3922 
push
 
bp


3923 
mov
 
bp
, 
¥


3924 
mov
 
ax
, 1 ; 
HAL_LINK_UP


3925 
pİ
 
bp


3926 
»t


3927 
asm_3c509b_g‘_lšk_¡©us
 
ENDP


3929 
PUBLIC
 
asm_3c509b_g‘_¡©i¡ics


3930 
asm_3c509b_g‘_¡©i¡ics
 
PROC


3931 
push
 
bp


3932 
mov
 
bp
, 
¥


3933 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3934 
pİ
 
bp


3935 
»t


3936 
asm_3c509b_g‘_¡©i¡ics
 
ENDP


3938 
PUBLIC
 
asm_3c509b_£t_muÉiÿ¡


3939 
asm_3c509b_£t_muÉiÿ¡
 
PROC


3940 
push
 
bp


3941 
mov
 
bp
, 
¥


3942 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3943 
pİ
 
bp


3944 
»t


3945 
asm_3c509b_£t_muÉiÿ¡
 
ENDP


3947 
PUBLIC
 
asm_3c509b_£t_´omiscuous


3948 
asm_3c509b_£t_´omiscuous
 
PROC


3949 
push
 
bp


3950 
mov
 
bp
, 
¥


3951 
mov
 
ax
, 0 ; 
HAL_SUCCESS


3952 
pİ
 
bp


3953 
»t


3954 
asm_3c509b_£t_´omiscuous
 
ENDP


3956 ;=============================================================================\
n
; 3C515-
TX
 
HAL
 
VTABLE
 
IMPLEMENTATIONS
\n;=============================================================================\n\n;-----------------------------------------------------------------------------\n; 
asm_3c515_d‘eù_h¬dw¬e
 - 
D‘eù
 3C515-TX 
h¬dw¬e
\n;\n; 
IÅut
: 
ES
:
BX
 = 
poš‹r
 
to
 
nic_cÚ‹xt
 
¡ruùu»
 \n; 
Ouut
: 
AX
 = 
HAL_SUCCESS
 
Ü
 
”rÜ
 
code
\n; 
U£s
: 
AÎ
 
»gi¡”s
\n;-----------------------------------------------------------------------------\
Çsm_3c515_d‘eù_h¬dw¬e
 
PROC
\À
push
 
bp
\À
mov
 bp, 
¥
\Àpush 
bx
\Àpush 
cx
\Àpush 
dx
\Àpush 
si
\Àpush 
di
\À\À; 
C®l
 
our
 
exi¡šg
 
d‘eù_3c515
 
funùiÚ
\À
ÿÎ
 d‘eù_3c515\À
cmp
 
ax
, 0\À
je
 .
nÙ_found
\À\À; 
Found
 - 
¡Üe
 
I
/
O
 
ba£
 
š
 
cÚ‹xt
\Àmov [
es
:bx+4],‡x ; 
StÜe
 I/O ba£ iÀ
	`cÚ‹xt
 (
off£t
 4)\Àmov‡x, 0 ; HAL_SUCCESS\À
jmp
 .
ex™
\À\n.nÙ_found:\Àmov‡x, -2 ; 
HAL_ERROR_HARDWARE_FAILURE
\À\n.ex™:\À
pİ
 di\Àpİ si\Àpİ dx\Àpİ cx\Àpİ bx\Àpİ bp\À
»t
\Çsm_3c515_d‘eù_h¬dw¬
ENDP
\n\n;-----------------------------------------------------------------------------\n; 
asm_3c515_š™_h¬dw¬e
 - 
In™Ÿlize
 3C515-TX h¬dw¬e\n;\n; IÅut: ES:BX =…oš‹¸tØnic_cÚ‹xˆ¡ruùu»\n; Ouut: AX = HAL_SUCCESS o¸”rÜ code\n; U£s: AÎ„egi¡” \n;-----------------------------------------------------------------------------\
Çsm_3c515_š™_h¬dw¬e
 PROC\Àpush bp\Àmov bp, sp\Àpush bx\Àpush cx\Àpush dx\Àpush si\À\À; 
G‘
 I/O ba£ 
äom
 cÚ‹xt\Àmov dx, [es:bx+4] ; I/O ba£ from cÚ‹xt\Àmov 
®
, 1 ; 
In¡ªû
 1 3C515\À\À; C®Èou¸
š™_3c515
 funùiÚ\ÀÿÎ in™_3c515\À; 
R‘uºs
 0 
sucûss
 
®»ady
\À\Àpİ si\Àpİ dx\Àpİ cx\Àpİ bx\Àpİ bp\À»t\Çsm_3c515_š™_h¬dw¬ENDP\n\n;-----------------------------------------------------------------------------\n; 
asm_3c515_»£t_h¬dw¬e
 - 
Re£t
 3C515-TX h¬dw¬e\n;\n; IÅut: ES:BX =…oš‹¸tØnic_cÚ‹xˆ¡ruùu»\n; Ouut: AX = HAL_SUCCESS o¸”rÜ code\n; U£s: AX, BX, 
DX
\n;-----------------------------------------------------------------------------\
Çsm_3c515_»£t_h¬dw¬e
 PROC\Àpush bp\Àmov bp, sp\Àpush bx\Àpush dx\À\À; G‘ I/O ba£ from cÚ‹xt\Àmov dx, [es:bx+4] ; I/O ba£ from cÚ‹xt\À\À; 
TÙ®
 
»£t
 
commªd
\À
add
 dx, 0E
h
 ; 
Commªd
 \Àmov‡x, 0 ; TÙ®„e£t\À
out
 dx,‡x\À\À; 
Wa™
 »£t\Àmov cx, 1000\n.
»£t_wa™
:\ÀÿÎ 
d–ay_1ms
\À
loİ
 .»£t_wa™\À\Àmov‡x, 0 ; HAL_SUCCESS\À\Àpİ dx\Àpİ bx\Àpİ bp\À»t\Çsm_3c515_»£t_h¬dw¬ENDP\n\n;-----------------------------------------------------------------------------\n; 
asm_3c515_cÚfigu»_medŸ
 - 
CÚfigu»
 
medŸ
 
ty³
\n;\n; IÅut: ES:BX =…oš‹¸tØnic_cÚ‹xˆ¡ruùu», 
CX
 = 
medŸ_ty³
\n; Ouut: AX = HAL_SUCCESS o¸”rÜ code\n; U£s: AX, BX, CX, DX\n;-----------------------------------------------------------------------------\
Çsm_3c515_cÚfigu»_medŸ
 PROC\Àpush bp\Àmov bp, sp\À\À; 
FÜ
 
now
, 
ju¡
  sucûs - medŸ 
is
‡uto-
cÚfigu»d
 iÀ
š™
\Àmov‡x, 0 ; HAL_SUCCESS\À\Àpİ bp\À»t\Çsm_3c515_cÚfigu»_medŸ ENDP\n\n;-----------------------------------------------------------------------------\n; 
asm_3c515_£t_¡©iÚ_add»ss
 - 
S‘
 
MAC
 
add»ss
\n;\n; IÅut: ES:BX =…oš‹¸tØnic_cÚ‹xˆ¡ruùu», ES:
SI
 = 
mac_addr
\n; Ouut: AX = HAL_SUCCESS o¸”rÜ code\n; U£s: AX, BX, CX, DX, SI, 
DI
\n;-----------------------------------------------------------------------------\
Çsm_3c515_£t_¡©iÚ_add»ss
 PROC\Àpush bp\Àmov bp, sp\Àpush bx\Àpush cx\Àpush dx\Àpush si\Àpush di\À\À; G‘ I/O ba£ from cÚ‹xt\Àmov dx, [es:bx+4] ; I/O ba£ from cÚ‹xt\À\À; 
S–eù
 
wšdow
 2 
¡©iÚ
‡dd»ss\Àadd dx, 0Eh ; Commªd \Àmov‡x, (1 << 11è| 2 ; S–eù wšdow 2\Àouˆdx,‡x\À\À; 
Wr™e
 MAC‡dd»s tØ¡©iÚ‡dd»s 
	`»gi¡”s
 (0-5)\À
sub
 dx, 0Eh ; 
Back
Øba£\Àmov cx, 6 ; 6 
by‹s
\Àmov di, 0 ; 
S¹
 
©
 off£ˆ0\À\n.
mac_loİ
:\Àmov‡l, [es:si] ; G‘ MAC 
by‹
\Àpush dx\Àadd dx, d˜; 
Add»ss
 off£t\Àouˆdx,‡È; Wr™MAC by‹\Àpİ dx\À
šc
 s˜; 
Next
 MAC by‹\Àšød˜; Nexˆ\Àloİ .mac_loİ\À\À; 
R‘uº
Øwšdow 1\Àadd dx, 0Eh ; Commªd \Àmov‡x, (1 << 11è| 1 ; S–eù wšdow 1\Àouˆdx,‡x\À\Àmov‡x, 0 ; HAL_SUCCESS\À\Àpİ di\Àpİ si\Àpİ dx\Àpİ cx\Àpİ bx\Àpİ bp\À»t\Çsm_3c515_£t_¡©iÚ_add»s ENDP\n\n;-----------------------------------------------------------------------------\n; 
Remaššg
 3C515 HAL 
vbË
 
	`funùiÚs
 (
¡ubs
 now)\n;-----------------------------------------------------------------------------\n\
Çsm_3c515_’abË_š‹¼u±s
 PROC\Àmov‡x, 0 ; HAL_SUCCESS\À»t\Çsm_3c515_’abË_š‹¼u± ENDP\n\
Çsm_3c515_¡¬t_Œªsûiv”
 PROC\Àmov‡x, 0 ; HAL_SUCCESS\À»t\Çsm_3c515_¡¬t_Œªsûiv” ENDP\n\
Çsm_3c515_¡İ_Œªsûiv”
 PROC\Àmov‡x, 0 ; HAL_SUCCESS\À»t\Çsm_3c515_¡İ_Œªsûiv” ENDP\n\
Çsm_3c515_g‘_lšk_¡©us
 PROC\Àmov‡x, 1 ; 
HAL_LINK_UP
\À»t\Çsm_3c515_g‘_lšk_¡©u ENDP\n\
Çsm_3c515_g‘_¡©i¡ics
 PROC\Àmov‡x, 0 ; HAL_SUCCESS\À»t\Çsm_3c515_g‘_¡©i¡ic ENDP\n\
Çsm_3c515_£t_muÉiÿ¡
 PROC\Àmov‡x, 0 ; HAL_SUCCESS\À»t\Çsm_3c515_£t_muÉiÿ¡ ENDP\n\
Çsm_3c515_£t_´omiscuous
 PROC\n mov‡x, 0 ; HAL_SUCCESS\n„et\nasm_3c515_set_promiscuous ENDP\n\n;=============================================================================

3957 ; 
ISA
 
ADDRESS
 
TRANSLATION
 
FOR
 3C515 
DMA


3961 ; 
i§_vœt_to_phys
 - 
CÚv”t
 
DOS
 
»®
 
mode
 
add»ss
 
to
 
ISA
 
physiÿl
‡ddress

3963 ; 
IÅut
: 
DS
:
SI
 = 
vœtu®
 
	`add»ss
 (
£gm’t
:
off£t
)

3964 ; 
Ouut
: 
DX
:
AX
 = 24-
b™
 
physiÿl
 
add»ss
 
ISA
 
DMA


3965 ; 
U£s
: 
AX
, 
DX


3967 
PUBLIC
 
i§_vœt_to_phys


3968 
i§_vœt_to_phys
 
PROC


3969 
push
 
cx


3971 ; 
C®cuÏ‹
 
physiÿl
 
add»ss
: (
£gm’t
 << 4è+ 
off£t


3972 
mov
 
ax
, 
ds


3973 
xÜ
 
dx
, dx

3974 
mov
 
cx
, 4

3976 ; 
Shiá
 
£gm’t
 
Ëá
 
by
 4 
	`b™s
 (
muÉly
 by 16)

3977 .
shiá_loİ
:

3978 
shl
 
ax
, 1

3979 
rş
 
dx
, 1

3980 
loİ
 .
shiá_loİ


3982 ; 
Add
 
off£t


3983 
add
 
ax
, 
si


3984 
adc
 
dx
, 0

3986 ; 
Ensu»
 
w™hš
 
ISA
 
DMA
 16
MB
 
	`lim™
 (24-
b™
 
add»ss
)

3987 
ªd
 
dx
, 00FF
h
 ; 
Mask
 
to
 24 
b™s


3989 
pİ
 
cx


3990 
»t


3991 
i§_vœt_to_phys
 
ENDP


3994 ; 
check_i§_dma_bound¬y
 - 
Check
 
bufãr
 
üos£s
 64
KB
 
DMA
 
bound¬y


3996 ; 
IÅut
: 
DX
:
AX
 = 
physiÿl
 
add»ss
, 
CX
 = 
bufãr
 
size


3997 ; 
Ouut
: 
CF
 
£t
 
bound¬y
 
üos£d
, 
ş—r
 
OK


3998 ; 
U£s
: 
	`NÚe
 (
´e£rves
 
®l
 
»gi¡”s
)

4000 
PUBLIC
 
check_i§_dma_bound¬y


4001 
check_i§_dma_bound¬y
 
PROC


4002 
push
 
ax


4003 
push
 
bx


4004 
push
 
dx


4006 ; 
C®cuÏ‹
 
’d
 
add»ss


4007 
mov
 
bx
, 
ax


4008 
add
 
bx
, 
cx


4009 
jnc
 .
no_ÿ¼y


4010 
šc
 
dx
 ; 
HªdË
 
ÿ¼y
 
to
 
high
 
wÜd


4012 .
no_ÿ¼y
:

4013 ; 
Check
 
high
 16 
b™s
 
	$chªged
 (
üos£d
 64
KB
 
bound¬y
)

4014 
push
 
ax


4015 
xÜ
 
ax
, 
bx
 ; 
XOR
 
¡¬t
 
ªd
 
’d
 
low
 
wÜds


4016 
ªd
 
ax
, 0F000
h
 ; 
Check
 
uµ”
 
nibbË
 
chªged


4017 
pİ
 
ax


4018 
jz
 .
§me_64k


4020 ; 
Cros£d
 
bound¬y


4021 
¡c
 ; 
S‘
 
ÿ¼y
 
æag


4022 
jmp
 .
ex™


4024 .
§me_64k
:

4025 
şc
 ; 
CË¬
 
ÿ¼y
 
æag


4027 .
ex™
:

4028 
pİ
 
dx


4029 
pİ
 
bx


4030 
pİ
 
ax


4031 
»t


4032 
check_i§_dma_bound¬y
 
ENDP


4035 ; 
£tup_i§_dma_desütÜ
 - 
S‘up
 
DMA
 
desütÜ
 
ISA
 
bus
 
ma¡”


4037 ; 
IÅut
: 
ES
:
DI
 = 
desütÜ
 
loÿtiÚ


4038 ; 
DX
:
AX
 = 
physiÿl
 
add»ss


4039 ; 
CX
 = 
Ëngth


4040 ; 
BX
 = 
cÚŒŞ
 
æags


4041 ; 
Ouut
: 
NÚe


4042 ; 
U£s
: 
	`NÚe
 (
´e£rves
 
®l
 
»gi¡”s
)

4044 
PUBLIC
 
£tup_i§_dma_desütÜ


4045 
£tup_i§_dma_desütÜ
 
PROC


4046 
push
 
ax


4047 
push
 
dx


4049 ; 
StÜe
 
physiÿl
 
	`add»ss
 (24-
b™
 
ISA
)

4050 
mov
 
wÜd
 
±r
 
es
:[
di
], 
ax
 ; 
Low
 16 
b™s


4051 
mov
 
by‹
 
±r
 
es
:[
di
+2], 
dl
 ; 
B™s
 16-23

4052 
mov
 
by‹
 
±r
 
es
:[
di
+3], 0 ; 
Z”o
 
uµ”
 byte

4054 ; 
StÜe
 
Ëngth


4055 
mov
 
wÜd
 
±r
 
es
:[
di
+4], 
cx


4057 ; 
StÜe
 
cÚŒŞ
 
æags


4058 
mov
 
wÜd
 
±r
 
es
:[
di
+6], 
bx


4060 
pİ
 
dx


4061 
pİ
 
ax


4062 
»t


4063 
£tup_i§_dma_desütÜ
 
ENDP


4066 ; 
š™_3c515_bus_ma¡”
 - 
In™Ÿlize
 
ISA
 
bus
 
ma¡”šg
 3C515

4068 ; 
IÅut
: 
DX
 = 
I
/
O
 
ba£
 
add»ss


4069 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


4070 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


4072 
PUBLIC
 
š™_3c515_bus_ma¡”


4073 
š™_3c515_bus_ma¡”
 
PROC


4074 
push
 
bp


4075 
mov
 
bp
, 
¥


4076 
push
 
bx


4077 
push
 
cx


4078 
push
 
si


4079 
push
 
di


4081 ; 
S–eù
 
wšdow
 7 
bus
 
ma¡”
 
cÚŒŞ


4082 
add
 
dx
, 0E
h
 ; 
Commªd
 

4083 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

4084 
out
 
dx
, 
ax


4086 ; 
In™Ÿlize
 
DMA
 
cÚŒŞ
 
»gi¡”s
 
©
 
ba£
+0x400

4087 
sub
 
dx
, 0E
h
 ; 
Back
 
to
 
ba£


4088 
add
 
dx
, 
C515_DMA_CTRL
 ; 
DMA
 
cÚŒŞ
 
	`off£t
 (0x400)

4090 ; 
CË¬
 
DMA
 
li¡s


4091 
xÜ
 
ax
,‡x

4092 
out
 
dx
, 
ax
 ; 
CË¬
 
TX
 
li¡
 
poš‹r


4093 
add
 
dx
, 4

4094 
out
 
dx
, 
ax
 ; 
CË¬
 
äagm’t
 
add»ss


4095 
add
 
dx
, 4

4096 
out
 
dx
, 
ax
 ; 
CË¬
 
äagm’t
 
Ëngth


4098 ; 
EÇbË
 
bus
 
ma¡”šg


4099 
sub
 
dx
, 
C515_DMA_CTRL


4100 
add
 
dx
, 0E
h
 ; 
Commªd
 

4101 
mov
 
ax
, 0x2000 ; 
BUS_MASTER_ENABLE


4102 
out
 
dx
, 
ax


4104 ; 
Sucûss


4105 
xÜ
 
ax
,‡x

4107 
pİ
 
di


4108 
pİ
 
si


4109 
pİ
 
cx


4110 
pİ
 
bx


4111 
pİ
 
bp


4112 
»t


4113 
š™_3c515_bus_ma¡”
 
ENDP


4116 ; 
MCA
/
EISA
/
VLB
 
D‘eùiÚ
 
Stubs


4118 ; 
Pu½o£
: 
D‘eù
 
unsuµÜ‹d
 
bus
 
NICs
 
to
 
´ovide
 
u£r
 
ãedback


4120 ; 
The£
 
¬e
 
STUBS
 
ONLY
 - 
they
 
d‘eù
 
but
 dØ
nÙ
 
suµÜt
:

4121 ; - 
MCA
: 3C523, 3C529

4122 ; - 
EISA
: 3C592, 3C597

4123 ; - 
VLB
: 
V¬ious
 
ÿrds


4125 ; 
Saãty
: 
R—d
-
Úly
 
İ”©iÚs
, 
»¡Ües
 
®l
 
sy¡em
 
¡©e


4126 ; 
Size
: ~1.4
KB
 
tÙ®
 
®l
 
¡ubs


4127 ; 
Risk
: 
Low
 - 
šşudes
 
timeout
 
´ÙeùiÚ


4131 ; 
is_mÿ_sy¡em
 - 
Quick
 
MCA
 
sy¡em
 
check


4133 ; 
IÅut
: 
NÚe


4134 ; 
Ouut
: 
AX
 = 1 
MCA
 
sy¡em
, 0 
nÙ


4135 ; 
U£s
: 
AX
, 
BX
, 
	`ES
 (
´e£rves
 
®l
)

4137 
PUBLIC
 
is_mÿ_sy¡em


4138 
is_mÿ_sy¡em
 
PROC


4139 
push
 
bx


4140 
push
 
cx


4141 
push
 
es


4143 ; 
U£
 
INT
 15
h
, 
AH
=
C0h
 
to
 
g‘
 
sy¡em
 
cÚfigu¿tiÚ


4144 
mov
 
ah
, 0C0
h
 ; 
G‘
 
Sy¡em
 
CÚfigu¿tiÚ


4145 15
h


4146 
jc
 .
nÙ_mÿ
 ; 
C¬ry
 
£t
 = 
no
 
cÚfig
 
šfo


4148 ; 
ES
:
BX
 
pošts
 
to
 
cÚfig
 
bË


4149 ; 
Fœ¡
 
by‹
 
is
 
the
 
bË
 
Ëngth
 - 
mu¡
 
check
 
befÜe
 
acûssšg


4150 
mov
 
®
, 
es
:[
bx
] ; 
G‘
 
bË
 
Ëngth


4151 
cmp
 
®
, 6 ; 
N“d
 
©
 
Ëa¡
 6 
by‹s
 
to
 
acûss
 
ã©u»
 
by‹
 1

4152 
jb
 .
nÙ_mÿ
 ; 
TabË
 
too
 , 
nÙ
 
§ã
 
to
 
check


4154 ; 
Check
 
ã©u»
 
by‹
 1 
©
 
off£t
 5

4155 
mov
 
®
, 
es
:[
bx
+5] ; 
F—tu»
 
by‹
 1

4156 
‹¡
 
®
, 02
h
 ; 
B™
 1 = 
MiüoChªÃl


4157 
jz
 .
nÙ_mÿ


4159 ; 
MCA
 
sy¡em
 
d‘eùed


4160 
mov
 
ax
, 1

4161 
jmp
 .
ex™


4163 .
nÙ_mÿ
:

4164 
xÜ
 
ax
,‡x ; 
NÙ
 
MCA


4166 .
ex™
:

4167 
pİ
 
es


4168 
pİ
 
cx


4169 
pİ
 
bx


4170 
»t


4171 
is_mÿ_sy¡em
 
ENDP


4174 ; 
g‘_ps2_mod–
 - 
G‘
 
PS
/2 
mod–
 
numb”


4176 ; 
IÅut
: 
NÚe


4177 ; 
Ouut
: 
AX
 = 
PS
/2 
mod–
 
	`numb”
 (0 
nÙ
 PS/2 
Ü
 
unknown
)

4178 ; 
U£s
: 
AX
, 
BX
, 
ES


4180 
PUBLIC
 
g‘_ps2_mod–


4181 
g‘_ps2_mod–
 
PROC


4182 
push
 
bx


4183 
push
 
es


4185 ; 
G‘
 
sy¡em
 
cÚfigu¿tiÚ


4186 
mov
 
ah
, 0C0
h


4187 15
h


4188 
jc
 .
unknown_mod–


4190 ; 
ES
:
BX
 
pošts
 
to
 
sy¡em
 
cÚfigu¿tiÚ
 
bË


4191 ; 
By‹
 
©
 
off£t
 2 
is
 
mod–
 
by‹


4192 
mov
 
®
, 
es
:[
bx
+2] ; 
Mod–
 
by‹


4193 
mov
 
ah
, 0 ; 
CË¬
 
high
 
by‹


4195 ; 
Check
 
known
 
PS
/2 
MCA
 
mod–s


4196 
cmp
 
®
, 50
h
 ; 
Mod–
 50

4197 
je
 .
v®id_mod–


4198 
cmp
 
®
, 56
h
 ; 
Mod–
 56

4199 
je
 .
v®id_mod–


4200 
cmp
 
®
, 57
h
 ; 
Mod–
 57

4201 
je
 .
v®id_mod–


4202 
cmp
 
®
, 60
h
 ; 
Mod–
 60

4203 
je
 .
v®id_mod–


4204 
cmp
 
®
, 70
h
 ; 
Mod–
 70

4205 
je
 .
v®id_mod–


4206 
cmp
 
®
, 76
h
 ; 
Mod–
 76

4207 
je
 .
v®id_mod–


4208 
cmp
 
®
, 77
h
 ; 
Mod–
 77

4209 
je
 .
v®id_mod–


4210 
cmp
 
®
, 80
h
 ; 
Mod–
 80

4211 
je
 .
v®id_mod–


4212 
cmp
 
®
, 85
h
 ; 
Mod–
 85

4213 
je
 .
v®id_mod–


4214 
cmp
 
®
, 90
h
 ; 
Mod–
 90

4215 
je
 .
v®id_mod–


4216 
cmp
 
®
, 95
h
 ; 
Mod–
 95

4217 
je
 .
v®id_mod–


4219 ; 
Unknown
 
Ü
 
nÚ
-
PS
/2 
mod–


4220 
jmp
 .
unknown_mod–


4222 .
v®id_mod–
:

4223 ; 
R‘uº
 
mod–
 
numb”
 
š
 
AX


4224 
jmp
 .
ex™


4226 .
unknown_mod–
:

4227 
xÜ
 
ax
,‡x ; 
R‘uº
 0 
unknown


4229 .
ex™
:

4230 
pİ
 
es


4231 
pİ
 
bx


4232 
»t


4233 
g‘_ps2_mod–
 
ENDP


4236 ; 
§ã_mÿ_pÜt_»ad
 - 
Saãly
 
»ad
 
MCA
 
POS
 
pÜt
 
w™h
 
timeout


4238 ; 
IÅut
: 
NÚe


4239 ; 
Ouut
: 
CF
 = 0 
pÜt
 
exi¡s
, CF = 1 
nÙ


4240 ; 
AL
 = 
pÜt
 
v®ue
 
exi¡s


4241 ; 
U£s
: 
AX
, 
CX
, 
DX


4243 
§ã_mÿ_pÜt_»ad
 
PROC


4244 
push
 
cx


4245 
push
 
dx


4247 
mov
 
cx
, 3 ; 
R‘ry
 
couÁ


4249 .
»Œy
:

4250 
mov
 
dx
, 96
h
 ; 
POS
 
cÚŒŞ
 
pÜt


4252 ; 
Check
 
pÜt
 
»¥Úds


4253 
š
 
®
, 
dx


4254 
cmp
 
®
, 0FF
h
 ; 
NÚ
-
exi¡’t
 
pÜt
?

4255 
jÃ
 .
pÜt_exi¡s


4257 
loİ
 .
»Œy


4259 ; 
PÜt
 
dÛ¢
'tƒxist

4260 
¡c
 ; 
S‘
 
ÿ¼y
 = 
”rÜ


4261 
jmp
 .
ex™


4263 .
pÜt_exi¡s
:

4264 
şc
 ; 
CË¬
 
ÿ¼y
 = 
sucûss


4266 .
ex™
:

4267 
pİ
 
dx


4268 
pİ
 
cx


4269 
»t


4270 
§ã_mÿ_pÜt_»ad
 
ENDP


4273 ; 
nic_d‘eù_mÿ_3c523
 - 
Stub
 
MCA
 3C523 
d‘eùiÚ


4275 ; 
Pu½o£
: 
D‘eù
 
but
 
nÙ
 
suµÜt
 
MCA
 
NICs
, 
šfÜm
 
u£r


4276 ; 
IÅut
: 
NÚe


4277 ; 
Ouut
: 
AX
 = 1 
MCA
 
NIC
 
	`found
 (
but
 
unsuµÜ‹d
), 0 
nÙ


4278 ; 
U£s
: 
AÎ
 
»gi¡”s


4280 
PUBLIC
 
nic_d‘eù_mÿ_3c523


4281 
nic_d‘eù_mÿ_3c523
 
PROC


4282 
push
 
bx


4283 
push
 
cx


4284 
push
 
dx


4285 
push
 
si


4287 ; 
Save
 
Üigš®
 
POS
 
¡©e


4288 
mov
 
dx
, 96
h


4289 
š
 
®
, 
dx


4290 
push
 
ax
 ; 
Save
 
Üigš®
 
¡©e


4292 ; 
Quick
 
check
 
this
 
is
 
ev’
 
ª
 
MCA
 
sy¡em


4293 
ÿÎ
 
is_mÿ_sy¡em


4294 
Ü
 
ax
,‡x

4295 
jz
 .
no_mÿ_nic
 ; 
NÙ
 
MCA
 
sy¡em
, 
sk


4297 ; 
Sÿn
 
MCA
 
¦Ùs
 3C523

4298 
xÜ
 
cx
, cx ; 
S¹
 
w™h
 
¦Ù
 0

4299 .
sÿn_loİ
:

4300 
cmp
 
cx
, 8 ; 
V®id©e
 
¦Ù
 
numb”


4301 
j«
 .
no_mÿ_nic
 ; 
P»v’t
 
ov”æow


4303 
mov
 
dx
, 96
h


4304 
mov
 
®
, 
ş


4305 
ªd
 
®
, 07
h
 ; 
Mask
 
to
 
v®id
 
¦Ù
 
¿nge


4306 
Ü
 
®
, 08
h
 ; 
EÇbË
 
POS
 
¦Ù


4307 
out
 
dx
, 
®


4309 ; 
Sm®l
 
d–ay
 
POS
 
’abË


4310 
push
 
cx


4311 
mov
 
cx
, 10

4312 .
d–ay1
:

4313 
nİ


4314 
loİ
 .
d–ay1


4315 
pİ
 
cx


4317 ; 
R—d
 
ad­‹r
 
ID


4318 
mov
 
dx
, 100
h


4319 
š
 
®
, 
dx
 ; 
ID
 
low
 
by‹


4320 
mov
 
ah
, 
®


4321 
šc
 
dx


4322 
š
 
®
, 
dx
 ; 
ID
 
high
 
by‹


4324 
cmp
 
ax
, 6042
h
 ; 3C523 
ad­‹r
 
ID


4325 
je
 .
found_3c523


4327 ; 
Di§bË
 
POS
 
ªd
 
Œy
 
Ãxt
 
¦Ù


4328 
push
 
cx


4329 
mov
 
dx
, 96
h


4330 
xÜ
 
®
,‡l

4331 
out
 
dx
, 
®


4333 ; 
Sm®l
 
d–ay


4334 
mov
 
cx
, 10

4335 .
d–ay2
:

4336 
nİ


4337 
loİ
 .
d–ay2


4338 
pİ
 
cx


4340 
šc
 
cx


4341 
cmp
 
cx
, 8 ; 8 
¦Ùs
 
max


4342 
jb
 .
sÿn_loİ


4344 .
no_mÿ_nic
:

4345 
xÜ
 
ax
,‡x ; 
No
 
MCA
 
NIC
 
found


4346 
jmp
 .
ex™


4348 .
found_3c523
:

4349 ; 
Di§bË
 
POS


4350 
mov
 
dx
, 96
h


4351 
xÜ
 
®
,‡l

4352 
out
 
dx
, 
®


4354 ; 
Log
 
d‘eùiÚ
 
mes§ge


4355 
push
 
cx
 ; 
Save
 
¦Ù
 
numb”


4356 
push
 
OFFSET
 
msg_3c523_found


4357 
ÿÎ
 
log_w¬nšg


4358 
add
 
¥
, 4

4360 
mov
 
ax
, 1 ; 
Found
 
but
 
nÙ
 
suµÜ‹d


4362 .
ex™
:

4363 ; 
Re¡Üe
 
Üigš®
 
POS
 
¡©e


4364 
pİ
 
bx
 ; 
G‘
 
§ved
 
¡©e


4365 
mov
 
dx
, 96
h


4366 
mov
 
®
, 
bl


4367 
out
 
dx
, 
®


4369 
pİ
 
si


4370 
pİ
 
dx


4371 
pİ
 
cx


4372 
pİ
 
bx


4373 
»t


4375 
msg_3c523_found
 
db
 'MCA: 3C523 EtherLink/MC detected but‚ot supported', 0

4376 
nic_d‘eù_mÿ_3c523
 
ENDP


4379 ; 
nic_d‘eù_mÿ_3c529
 - 
Stub
 
MCA
 3C529 
d‘eùiÚ


4381 ; 
Pu½o£
: 
D‘eù
 
but
 
nÙ
 
suµÜt
 
MCA
 3C529, 
šfÜm
 
u£r


4382 ; 
IÅut
: 
NÚe


4383 ; 
Ouut
: 
AX
 = 1 
MCA
 
NIC
 
	`found
 (
but
 
unsuµÜ‹d
), 0 
nÙ


4384 ; 
U£s
: 
AÎ
 
»gi¡”s


4386 
PUBLIC
 
nic_d‘eù_mÿ_3c529


4387 
nic_d‘eù_mÿ_3c529
 
PROC


4388 
push
 
bx


4389 
push
 
cx


4390 
push
 
dx


4391 
push
 
si


4393 ; 
Save
 
Üigš®
 
POS
 
¡©e


4394 
mov
 
dx
, 96
h


4395 
š
 
®
, 
dx


4396 
push
 
ax
 ; 
Save
 
Üigš®
 
¡©e


4398 ; 
Quick
 
check
 
this
 
is
 
ev’
 
ª
 
MCA
 
sy¡em


4399 
ÿÎ
 
is_mÿ_sy¡em


4400 
Ü
 
ax
,‡x

4401 
jz
 .
no_mÿ_nic
 ; 
NÙ
 
MCA
 
sy¡em
, 
sk


4403 ; 
Sÿn
 
MCA
 
¦Ùs
 3C529

4404 
xÜ
 
cx
, cx ; 
S¹
 
w™h
 
¦Ù
 0

4405 .
sÿn_loİ
:

4406 
cmp
 
cx
, 8 ; 
V®id©e
 
¦Ù
 
numb”


4407 
j«
 .
no_mÿ_nic
 ; 
P»v’t
 
ov”æow


4409 
mov
 
dx
, 96
h


4410 
mov
 
®
, 
ş


4411 
ªd
 
®
, 07
h
 ; 
Mask
 
to
 
v®id
 
¦Ù
 
¿nge


4412 
Ü
 
®
, 08
h
 ; 
EÇbË
 
POS
 
¦Ù


4413 
out
 
dx
, 
®


4415 ; 
Sm®l
 
d–ay
 
POS
 
’abË


4416 
push
 
cx


4417 
mov
 
cx
, 10

4418 .
d–ay1
:

4419 
nİ


4420 
loİ
 .
d–ay1


4421 
pİ
 
cx


4423 ; 
R—d
 
ad­‹r
 
ID


4424 
mov
 
dx
, 100
h


4425 
š
 
®
, 
dx
 ; 
ID
 
low
 
by‹


4426 
mov
 
ah
, 
®


4427 
šc
 
dx


4428 
š
 
®
, 
dx
 ; 
ID
 
high
 
by‹


4430 
cmp
 
ax
, 627C
h
 ; 3C529 
ad­‹r
 
ID


4431 
je
 .
found_3c529


4433 ; 
Di§bË
 
POS
 
ªd
 
Œy
 
Ãxt
 
¦Ù


4434 
push
 
cx


4435 
mov
 
dx
, 96
h


4436 
xÜ
 
®
,‡l

4437 
out
 
dx
, 
®


4439 ; 
Sm®l
 
d–ay


4440 
mov
 
cx
, 10

4441 .
d–ay2
:

4442 
nİ


4443 
loİ
 .
d–ay2


4444 
pİ
 
cx


4446 
šc
 
cx


4447 
cmp
 
cx
, 8 ; 8 
¦Ùs
 
max


4448 
jb
 .
sÿn_loİ


4450 .
no_mÿ_nic
:

4451 
xÜ
 
ax
,‡x ; 
No
 
MCA
 
NIC
 
found


4452 
jmp
 .
ex™


4454 .
found_3c529
:

4455 ; 
Di§bË
 
POS


4456 
mov
 
dx
, 96
h


4457 
xÜ
 
®
,‡l

4458 
out
 
dx
, 
®


4460 ; 
Log
 
d‘eùiÚ
 
mes§ge


4461 
push
 
cx
 ; 
Save
 
¦Ù
 
numb”


4462 
push
 
OFFSET
 
msg_3c529_found


4463 
ÿÎ
 
log_w¬nšg


4464 
add
 
¥
, 4

4466 
mov
 
ax
, 1 ; 
Found
 
but
 
nÙ
 
suµÜ‹d


4468 .
ex™
:

4469 ; 
Re¡Üe
 
Üigš®
 
POS
 
¡©e


4470 
pİ
 
bx
 ; 
G‘
 
§ved
 
¡©e


4471 
mov
 
dx
, 96
h


4472 
mov
 
®
, 
bl


4473 
out
 
dx
, 
®


4475 
pİ
 
si


4476 
pİ
 
dx


4477 
pİ
 
cx


4478 
pİ
 
bx


4479 
»t


4481 
msg_3c529_found
 
db
 'MCA: 3C529 EtherLink III/MC detected but‚ot supported', 0

4482 
nic_d‘eù_mÿ_3c529
 
ENDP


4485 ; 
is_ei§_sy¡em
 - 
Check
 
sy¡em
 
has
 
EISA
 
bus


4487 ; 
IÅut
: 
NÚe


4488 ; 
Ouut
: 
AX
 = 1 
EISA
 
sy¡em
, 0 
nÙ


4489 ; 
U£s
: 
AX
, 
	`DX
 (
´e£rves
 
®l
)

4491 
PUBLIC
 
is_ei§_sy¡em


4492 
is_ei§_sy¡em
 
PROC


4493 
push
 
dx


4495 ; 
Check
 
EISA
 
by
 
»adšg
 
the
 "EISA" 
sigÇtu»
 
äom
 
¦Ù
 0

4496 ; 
EISA
 
sy¡ems
 
have
 
ASCII
 "EISA" 
©
 
pÜts
 0xC80-0xC83

4497 ; 
This
 
is
 286-
	`com·tibË
 (
no
 32-
b™
 
š¡ruùiÚs
)

4499 
mov
 
dx
, 0C80
h
 ; 
EISA
 
¦Ù
 0 
ID
 
pÜt


4500 
š
 
®
, 
dx
 ; 
R—d
 
fœ¡
 
by‹


4501 
cmp
 
®
, 'E' ; 
Check
 'E'

4502 
jÃ
 .
nÙ_ei§


4504 
šc
 
dx
 ; 
PÜt
 0xC81

4505 
š
 
®
, 
dx
 ; 
R—d
 
£cÚd
 
by‹


4506 
cmp
 
®
, 'I' ; 
Check
 'I'

4507 
jÃ
 .
nÙ_ei§


4509 
šc
 
dx
 ; 
PÜt
 0xC82

4510 
š
 
®
, 
dx
 ; 
R—d
 
thœd
 
by‹


4511 
cmp
 
®
, 'S' ; 
Check
 'S'

4512 
jÃ
 .
nÙ_ei§


4514 
šc
 
dx
 ; 
PÜt
 0xC83

4515 
š
 
®
, 
dx
 ; 
R—d
 
fou¹h
 
by‹


4516 
cmp
 
®
, 'A' ; 
Check
 'A'

4517 
jÃ
 .
nÙ_ei§


4519 ; 
Found
 "EISA" 
sigÇtu»
 - 
this
 
is
 
ª
 
EISA
 
sy¡em


4520 
mov
 
ax
, 1 ; 
EISA
 
sy¡em


4521 
jmp
 .
ex™


4523 .
nÙ_ei§
:

4524 
xÜ
 
ax
,‡x ; 
NÙ
 
EISA


4526 .
ex™
:

4527 
pİ
 
dx


4528 
»t


4529 
is_ei§_sy¡em
 
ENDP


4532 ; 
nic_d‘eù_ei§_3c592
 - 
Stub
 
EISA
 3C592 
d‘eùiÚ


4534 ; 
Pu½o£
: 
D‘eù
 
but
 
nÙ
 
suµÜt
 
EISA
 
NICs
, 
šfÜm
 
u£r


4535 ; 
IÅut
: 
NÚe


4536 ; 
Ouut
: 
AX
 = 1 
EISA
 
NIC
 
	`found
 (
but
 
unsuµÜ‹d
), 0 
nÙ


4537 ; 
U£s
: 
AÎ
 
»gi¡”s


4539 
PUBLIC
 
nic_d‘eù_ei§_3c592


4540 
nic_d‘eù_ei§_3c592
 
PROC


4541 
push
 
bx


4542 
push
 
cx


4543 
push
 
dx


4545 ; 
Quick
 
check
 
this
 
is
 
ev’
 
ª
 
EISA
 
sy¡em


4546 
ÿÎ
 
is_ei§_sy¡em


4547 
Ü
 
ax
,‡x

4548 
jz
 .
no_ei§_nic


4550 ; 
Sÿn
 
EISA
 
¦Ùs
 1-15 (
¦Ù
 0 
is
 
mÙh”bßrd
)

4551 
mov
 
cx
, 1 ; 
S¹
 
w™h
 
¦Ù
 1

4552 .
sÿn_loİ
:

4553 ; 
C®cuÏ‹
 
EISA
 
ID
 
pÜt
 
this
 
¦Ù


4554 
mov
 
dx
, 
cx


4555 
shl
 
dx
, 12 ; 
SlÙ
 * 0x1000

4556 
add
 
dx
, 0C80
h
 ; 
EISA
 
ID
 
off£t


4558 ; 
R—d
 
EISA
 
ad­‹r
 
	`ID
 (32-
b™
)

4559 
š
 
—x
, 
dx


4561 ; 
Check
 3C592 
	`ID
 (
TCM5920
)

4562 ; 
EISA
 
IDs
 
¬e
 
’coded
, 
but
 
we
 
ÿn
 
check
 
·‰”ns


4563 
cmp
 
—x
, 0FFFFFFFF
h
 ; 
Em±y
 
¦Ù


4564 
je
 .
Ãxt_¦Ù


4566 ; 
Check
 
this
 
looks
 
like
 
a
 3C
om
 
ÿrd


4567 ; 3C
om
 
EISA
 
´efix
 
is
 "TCM" 
’coded


4568 
ªd
 
—x
, 0FFFFFF
h
 ; 
Mask
 
uµ”
 
by‹


4569 
cmp
 
—x
, 204D4354
h
 ; "TCM " 
	$·‰”n
 (
sim¶if›d
 
check
)

4570 
jÃ
 .
Ãxt_¦Ù


4572 ; 
Found
 
pÙ’tŸl
 3C
om
 
EISA
 
ÿrd


4573 
push
 
cx


4574 
push
 
OFFSET
 
msg_ei§_3c592_found


4575 
ÿÎ
 
log_w¬nšg


4576 
add
 
¥
, 4

4578 
mov
 
ax
, 1 ; 
Found
 
but
 
nÙ
 
suµÜ‹d


4579 
jmp
 .
ex™


4581 .
Ãxt_¦Ù
:

4582 
šc
 
cx


4583 
cmp
 
cx
, 16 ; 
Check
 
¦Ùs
 1-15

4584 
jb
 .
sÿn_loİ


4586 .
no_ei§_nic
:

4587 
xÜ
 
ax
,‡x ; 
No
 
EISA
 
NIC
 
found


4589 .
ex™
:

4590 
pİ
 
dx


4591 
pİ
 
cx


4592 
pİ
 
bx


4593 
»t


4595 
msg_ei§_3c592_found
 
db
 'EISA: 3C592 detected but‚ot supported', 0

4596 
nic_d‘eù_ei§_3c592
 
ENDP


4599 ; 
nic_d‘eù_ei§_3c597
 - 
Stub
 
EISA
 3C597 
d‘eùiÚ


4601 ; 
Pu½o£
: 
D‘eù
 
but
 
nÙ
 
suµÜt
 
EISA
 3C597, 
šfÜm
 
u£r


4602 ; 
IÅut
: 
NÚe


4603 ; 
Ouut
: 
AX
 = 1 
EISA
 
NIC
 
	`found
 (
but
 
unsuµÜ‹d
), 0 
nÙ


4604 ; 
U£s
: 
AÎ
 
»gi¡”s


4606 
PUBLIC
 
nic_d‘eù_ei§_3c597


4607 
nic_d‘eù_ei§_3c597
 
PROC


4608 ; 
Sim¬
 
¡ruùu»
 
to
 3C592 
d‘eùiÚ


4609 ; 
Would
 
check
 
difã»Á
 
EISA
 
ID
 
·‰”n


4610 
xÜ
 
ax
,‡x ; 
Sim¶if›d
 
¡ub


4611 
»t


4612 
nic_d‘eù_ei§_3c597
 
ENDP


4615 ; 
nic_d‘eù_vlb
 - 
Stub
 
VESA
 
Loÿl
 
Bus
 
NIC
 
d‘eùiÚ


4617 ; 
Pu½o£
: 
D‘eù
 
but
 
nÙ
 
suµÜt
 
VLB
 
NICs
, 
šfÜm
 
u£r


4618 ; 
IÅut
: 
NÚe


4619 ; 
Ouut
: 
AX
 = 1 
VLB
 
NIC
 
	`found
 (
but
 
unsuµÜ‹d
), 0 
nÙ


4620 ; 
U£s
: 
AÎ
 
»gi¡”s


4622 
PUBLIC
 
nic_d‘eù_vlb


4623 
nic_d‘eù_vlb
 
PROC


4624 
push
 
dx


4626 ; 
VLB
 
d‘eùiÚ
 
is
 
Œicky
 - 
no
 
¡ªd¬d
 detection

4627 ; 
Check
 
commÚ
 
VLB
 
NIC
 
I
/
O
 
	$add»s£s
 (0x6000 
¿nge
)

4628 
mov
 
dx
, 6000
h
 ; 
CommÚ
 
VLB
 
NIC
 
add»ss


4630 ; 
Try
 
to
 
»ad
 
äom
 
	$pÜt
 (
w™h
 
timeout
 
´ÙeùiÚ
)

4631 
š
 
®
, 
dx


4632 
cmp
 
®
, 0FF
h
 ; 
Lik–y
 
no
 
deviû


4633 
je
 .
no_vlb


4635 ; 
Do
 
a
 
mÜe
 
¥ecific
 
check


4636 
mov
 
dx
, 6008
h
 ; 
AnÙh”
 
VLB
 
NIC
 

4637 
š
 
®
, 
dx


4638 
cmp
 
®
, 0FF
h


4639 
je
 .
no_vlb


4641 ; 
Might
 
be
 
a
 
VLB
 
NIC


4642 
push
 
OFFSET
 
msg_vlb_nÙ_suµÜ‹d


4643 
ÿÎ
 
log_w¬nšg


4644 
add
 
¥
, 2

4646 
mov
 
ax
, 1 ; 
Found
 
but
 
nÙ
 
suµÜ‹d


4647 
jmp
 .
ex™


4649 .
no_vlb
:

4650 
xÜ
 
ax
,‡x ; 
No
 
VLB
 
NIC


4652 .
ex™
:

4653 
pİ
 
dx


4654 
»t


4656 
msg_vlb_nÙ_suµÜ‹d
 
db
 'VLB NICs‚ot supported', 0

4657 
nic_d‘eù_vlb
 
ENDP


4660 ; 
Upd©e
 
h¬dw¬e_d‘eù_®l
 
to
 
ÿÎ
 
¡ubs


4662 ; 
NÙe
: 
This
 
would
 
be
 
š£¹ed
 
što
 
the
 
exi¡šg
 
h¬dw¬e_d‘eù_®l
 
funùiÚ


4663 ; 
aá”
 
ISA
 
d‘eùiÚ
 
but
 
is
 
shown
 
h”e
 
com¶‘’ess


4665 
msg_ei§_nÙ_suµÜ‹d
 
db
 'EISA NICs detected but‚ot supported', 0

4666 
msg_mÿ_nÙ_suµÜ‹d
 
db
 'MicroChannel NICs detected but‚ot supported', 0

4667 
msg_Œy_i§
 
db
 'Please use supported ISA NICs: 3C509B or 3C515-TX', 0

4668 
msg_pu»_mÿ_”rÜ1
 
db
 'ERROR: No compatible‚etwork‡dapters‡vailable onhis system.', 0

4669 
msg_pu»_mÿ_”rÜ2
 
db
 'This driver only supports ISA-based 3Com NICs (3C509B, 3C515-TX).', 0

4670 
msg_pu»_mÿ_”rÜ3
 
db
 'MicroChannel systems„equire MCA-specific‚etwork drivers.', 0

4672 
_TEXT
 
ENDS


	@/Users/jvindahl/Development/3com-packet-driver/src/asm/nic_irq.asm

1 ; @
fe
 
	gnic_œq
.
	gasm


2 ; @
br›f
 
NIC
 
š‹¼u±
 
	ghªdlšg


4 ; 3C
om
 
Pack‘
 
	gDriv”
 - 
SuµÜt
 3C515-
TX
 
	gªd
 3C509B 
	gNICs


6 ; 
This
 
fe
 
is
 
·¹
 
of
 
	gthe
 3C
om
 
Pack‘
 
Driv”
 
	g´ojeù
.

9 .
MODEL
 
	gSMALL


12 
	gšşude
 'tsr_defensive.inc'

14 ; 
	gR“Á¿ncy
-
§ã
 
¡ack
 
sw™chšg
 
maüos
 
NIC
 
IRQ
 
	ghªdËrs


15 ; 
The£
 
maüos
 
¬e
 
šd•’d’t
 
of
 
DS
 
assum±iÚs
 
ªd
 
¡Üe
 
ÿÎ”
 
	gcÚ‹xt


16 ; 
Ú
 
the
 
IRQ
 
¡ack
 
™£lf
 
to
 
avoid
 
»’Œªcy
 
	gcÜru±iÚ


18 ; 
	gRequœem’ts
: 
NÚe
 (
fuÎy
 
£lf
-
cÚšed
)

19 ; 
	gU£s
: 
BX
, 
	gDX
, 
AX
 (
§ved
 
Ú
 
Ãw
 
¡ack
)

20 ; 
	gP»£rves
: 
AÎ
 
»gi¡”s
 
exû±
 
tho£
 
u£d
 
sw™chšg


23 ; 
	gSAFE_STACK_SWITCH_3C509B
 â€” 
Truly
 
	g»’Œªcy
-
§ã
 
¡ack
 

25 ; 
Sw™ches
 
to
 
´iv©e
 
IRQ
 
¡ack
 
š‹¼u±
 
hªdlšg
 
w™h
 
fuÎ
 
	g»’Œªcy


26 ; 
	g´ÙeùiÚ
. 
HªdËs
 
Ã¡ed
 
š‹¼u±s
 
cÜ»ùly
 
by
 
d‘eùšg
 
wh’
 
	g®»ady


27 ; 
Ú
 
the
 
IRQ
 
¡ack
 
ªd
 
´e£rvšg
 
´evious
 sck 
	gäames
.

29 ; 
	gALGORITHM
:

30 ; 1. 
Save
 
cu¼’t
 
	gSS
:
SP
 
š
 
»gi¡”s


31 ; 2. 
Check
 
®»ady
 
Ú
 
IRQ
 
¡ack
 (
SS
=
_DATA
 
AND
 
SP
 
w™hš
 
bounds
+
h—droom
)

32 ; 3a. 
If
 
®»ady
 
Ú
 
	g¡ack
: 
Push
 
cÚ‹xt
 oÀ
cu¼’t
 
¡ack
 (
no
 
SP
 
»£t
)

33 ; 3b. 
If
 
nÙ
 
Ú
 
	g¡ack
: 
Sw™ch
 
to
 
IRQ
 
¡ack
 
tİ
, 
th’
 
push
 
	gcÚ‹xt


34 ; 4. 
S‘
 
	gDS
=
_DATA
 
§ã
 
v¬ŸbË
 
acûss


35 ; 5. 
CË¬
 
dœeùiÚ
 
æag
 
ªd
 
	g»
-
’abË
 
	gš‹¼u±s


37 ; 
	gHEADROOM
: 
Requœes
 8+ 
by‹s
 
avaabË
 
befÜe
 
pushšg
 (4 
wÜds
 * 2 bytes)

38 ; 
	gNESTING
: 
UÆim™ed
 
d•th
 
suµÜ‹d
 - 
—ch
 
Ëv–
 
g‘s
 
´İ”
 
¡ack
 
äame


39 ; 
IF
 
	gPOLICY
: 
Always
 
’abËs
 
š‹¼u±s
 (
STI
è- 
su™abË
 
h¬dw¬e
 
ISRs


41 ; 
	gEÁry
: 
Any
 
¡ack
 
¡©e
, 
ªy
 
	gDS
, 
	gIF
=0 (
typiÿl
 
ISR
 
’Œy
)

42 ; 
	gEx™
: 
Priv©e
 
IRQ
 
¡ack
, 
	gDS
=
_DATA
, 
	gDF
=0, 
	gIF
=1

44 ; 
	gClobb”s
: 
AX
, 
	gBX
, 
	gCX
, 
DX
 (
CX
 
added
 
h—droom
 
ÿlcuÏtiÚ
)

45 ; 
	gPushes
: 
C®Ër
's SP, SS, DS, ES (4 words on IRQ stack)

46 ; 
	gP»£rves
: 
AÎ
 
Ùh”
 
»gi¡”s


47 ; 
	gRequœem’ts
: 
œq_¡ack_3c509b
 
ªd
 
œq_¡ack_tİ_3c509b
 
š
 
_DATA
/
DGROUP


48 ; 
	gCom·niÚ
: 
U£
 
w™h
 
RESTORE_CALLER_STACK_IRQ
 
´İ”
 
ISR
 
•ogue


50 
maüo
 
SAFE_STACK_SWITCH_3C509B


51 
LOCAL
 
__SWS3C509B_DoSw™ch
, 
__SWS3C509B_DÚe


53 
şi


54 
mov
 
	gbx
, 
	gss
 ; 
	gBX
 = 
ÿÎ”
 
SS


55 
mov
 
dx
, 
	g¥
 ; 
	gDX
 = 
ÿÎ”
 
SP


56 
mov
 
ax
, 
	g_DATA
 ; 
	gAX
 = 
our
 
DGROUP
 
£gm’t


58 ; 
A»
 
we
 
®»ady
 
Ú
 
our
 
IRQ
 
	g¡ack
?

59 
cmp
 
	gbx
, 
ax


60 
jÃ
 
	g__SWS3C509B_DoSw™ch
 ; 
	gSS
 !ğ
_DATA
 -> 
mu¡
 

62 ; 
	gSS
 =ğ
_DATA
, 
check
 
SP
 
bounds
 
w™h
 
	gh—droom
: SP 
mu¡
 
be
 > 
bÙtom
+8 
ªd
 <ğ
tİ


63 ; 
	gN“d
 8 
by‹s
 
h—droom
 4 
wÜd
 
	$pushes
 (
ÿÎ”
 
SP
, 
SS
, 
DS
, 
ES
)

64 
mov
 
cx
, 
OFFSET
 
œq_¡ack_3c509b


65 
add
 
cx
, 8 ; 
CX
 = 
bÙtom
 + 
h—droom
 
Ãeded


66 
cmp
 
dx
, 
cx


67 
jbe
 
__SWS3C509B_DoSw™ch
 ; 
SP
 <ğ
bÙtom
+8 -> 
šsuffic›Á
 
h—droom
, 
mu¡
 

68 
cmp
 
dx
, 
OFFSET
 
œq_¡ack_tİ_3c509b


69 
ja
 
__SWS3C509B_DoSw™ch
 ; 
SP
 > 
tİ
 -> 
nÙ
 
our
 
IRQ
 
¡ack


71 ; 
AÌ—dy
 
Ú
 
our
 
IRQ
 
¡ack
: dØ
nÙ
 
»£t
 
SP
. 
Save
 
cÚ‹xt
 oÀ
cu¼’t
 stack.

72 
push
 
dx
 ; 
Save
 
ÿÎ”
 
SP


73 
push
 
bx
 ; 
Save
 
ÿÎ”
 
SS


74 
push
 
ds
 ; 
Save
 
ÿÎ”
 
DS


75 
push
 
es
 ; 
Save
 
ÿÎ”
 
ES


76 
mov
 
ds
, 
ax
 ; 
DS
 = 
_DATA


77 
şd


78 
¡i


79 
jmp
 
SHORT
 
__SWS3C509B_DÚe


81 
__SWS3C509B_DoSw™ch
:

82 ; 
Sw™ch
 
to
 
IRQ
 
¡ack


83 
mov
 
ss
, 
ax


84 
mov
 
¥
, 
OFFSET
 
œq_¡ack_tİ_3c509b


85 ; 
Now
 
§ve
 
ÿÎ”
 
cÚ‹xt
 
Ú
 
the
 
IRQ
 
¡ack


86 
push
 
dx
 ; 
ÿÎ”
 
SP


87 
push
 
bx
 ; 
ÿÎ”
 
SS


88 
push
 
ds
 ; 
ÿÎ”
 
DS


89 
push
 
es
 ; 
ÿÎ”
 
ES


90 
mov
 
ds
, 
ax
 ; 
DS
 = 
_DATA


91 
şd


92 
¡i


94 
__SWS3C509B_DÚe
:

95 
’dm


98 ; 
SAFE_STACK_SWITCH_3C515
 â€” 
Truly
 
»’Œªcy
-
§ã
 
¡ack
 

100 ; 
Same
 
£mªtics
 
as
 3C509B 
v¬ŸÁ
, 
but
 3C515's IRQ stack.

102 
maüo
 
SAFE_STACK_SWITCH_3C515


103 
LOCAL
 
__SWS3C515_DoSw™ch
, 
__SWS3C515_DÚe


105 
şi


106 
mov
 
bx
, 
ss
 ; 
BX
 = 
ÿÎ”
 
SS


107 
mov
 
dx
, 
¥
 ; 
DX
 = 
ÿÎ”
 
SP


108 
mov
 
ax
, 
_DATA
 ; 
AX
 = 
our
 
DGROUP
 
£gm’t


110 ; 
A»
 
we
 
®»ady
 
Ú
 
our
 
IRQ
 
¡ack
?

111 
cmp
 
bx
, 
ax


112 
jÃ
 
__SWS3C515_DoSw™ch
 ; 
SS
 !ğ
_DATA
 -> 
mu¡
 

114 ; 
SS
 =ğ
_DATA
, 
check
 
SP
 
bounds
 
w™h
 
h—droom
: SP 
mu¡
 
be
 > 
bÙtom
+8 
ªd
 <ğ
tİ


115 ; 
N“d
 8 
by‹s
 
h—droom
 4 
wÜd
 
	$pushes
 (
ÿÎ”
 
SP
, 
SS
, 
DS
, 
ES
)

116 
mov
 
cx
, 
OFFSET
 
œq_¡ack_3c515


117 
add
 
cx
, 8 ; 
CX
 = 
bÙtom
 + 
h—droom
 
Ãeded


118 
cmp
 
dx
, 
cx


119 
jbe
 
__SWS3C515_DoSw™ch
 ; 
SP
 <ğ
bÙtom
+8 -> 
šsuffic›Á
 
h—droom
, 
mu¡
 

120 
cmp
 
dx
, 
OFFSET
 
œq_¡ack_tİ_3c515


121 
ja
 
__SWS3C515_DoSw™ch
 ; 
SP
 > 
tİ
 -> 
nÙ
 
our
 
IRQ
 
¡ack


123 ; 
AÌ—dy
 
Ú
 
our
 
IRQ
 
¡ack
: dØ
nÙ
 
»£t
 
SP
. 
Save
 
cÚ‹xt
 oÀ
cu¼’t
 stack.

124 
push
 
dx
 ; 
Save
 
ÿÎ”
 
SP


125 
push
 
bx
 ; 
Save
 
ÿÎ”
 
SS


126 
push
 
ds
 ; 
Save
 
ÿÎ”
 
DS


127 
push
 
es
 ; 
Save
 
ÿÎ”
 
ES


128 
mov
 
ds
, 
ax
 ; 
DS
 = 
_DATA


129 
şd


130 
¡i


131 
jmp
 
SHORT
 
__SWS3C515_DÚe


133 
__SWS3C515_DoSw™ch
:

134 ; 
Sw™ch
 
to
 
IRQ
 
¡ack


135 
mov
 
ss
, 
ax


136 
mov
 
¥
, 
OFFSET
 
œq_¡ack_tİ_3c515


137 ; 
Now
 
§ve
 
ÿÎ”
 
cÚ‹xt
 
Ú
 
the
 
IRQ
 
¡ack


138 
push
 
dx
 ; 
ÿÎ”
 
SP


139 
push
 
bx
 ; 
ÿÎ”
 
SS


140 
push
 
ds
 ; 
ÿÎ”
 
DS


141 
push
 
es
 ; 
ÿÎ”
 
ES


142 
mov
 
ds
, 
ax
 ; 
DS
 = 
_DATA


143 
şd


144 
¡i


146 
__SWS3C515_DÚe
:

147 
’dm


149 
maüo
 
RESTORE_CALLER_STACK_IRQ


150 
şi
 ; 
Cr™iÿl
 
£ùiÚ
 
¡¬t
 - 
no
 
š‹¼u±s
 
duršg
 
»¡Üe


151 ; 
Re¡Üe
 
ÿÎ”
 
ES
/
DS
 
äom
 
our
 
IRQ
 
¡ack


152 
pİ
 
es
 ; 
Re¡Üe
 
ÿÎ”
 
ES


153 
pİ
 
ds
 ; 
Re¡Üe
 
ÿÎ”
 
DS


154 ; 
Re¡Üe
 
ÿÎ”
 
SS
:
SP
 
äom
 
our
 
IRQ
 
¡ack


155 
pİ
 
bx
 ; 
Re¡Üe
 
Şd
 
SS


156 
pİ
 
dx
 ; 
Re¡Üe
 
Şd
 
SP


157 
mov
 
ss
, 
bx
 ; 
SS
 = 
ÿÎ”
's segment

158 
mov
 
¥
, 
dx
 ; 
SP
 = 
ÿÎ”
's…ointer (atomic‡fter SS†oad)

159 
¡i
 ; 
Re
-
’abË
 
š‹¼u±s


160 
’dm


162 ; 
IÁ”ru±
-
»Ï‹d
 
cÚ¡ªts


163 
IRQ_NONE
 
EQU
 0FF
h
 ; 
No
 
IRQ
 
assigÃd


164 
IRQ_MIN
 
EQU
 3 ; 
Mšimum
 
v®id
 
IRQ


165 
IRQ_MAX
 
EQU
 15 ; 
Maximum
 
v®id
 
IRQ


167 ; 
NIC
 
š‹¼u±
 
¡©us
 
æags


168 
IRQ_RX_COMPLETE
 
EQU
 01
h
 ; 
Pack‘
 
»ûived


169 
IRQ_TX_COMPLETE
 
EQU
 02
h
 ; 
Pack‘
 
Œªsm™‹d


170 
IRQ_TX_ERROR
 
EQU
 04
h
 ; 
T¿nsmissiÚ
 
”rÜ


171 
IRQ_RX_ERROR
 
EQU
 08
h
 ; 
Reû±iÚ
 
”rÜ


172 
IRQ_LINK_CHANGE
 
EQU
 10
h
 ; 
Lšk
 
¡©us
 
chªged


173 
IRQ_COUNTER_OVERFLOW
 
EQU
 20
h
 ; 
Sti¡ics
 
couÁ”
 
ov”æow


175 ; 
H¬dw¬e
 
š‹¼u±
 
	$veùÜs
 (8259 
PIC
)

176 
PIC1_COMMAND
 
EQU
 20
h
 ; 
Ma¡”
 
PIC
 
commªd
 
pÜt


177 
PIC1_DATA
 
EQU
 21
h
 ; 
Ma¡”
 
PIC
 
d©a
 
pÜt


178 
PIC2_COMMAND
 
EQU
 0A0
h
 ; 
SÏve
 
PIC
 
commªd
 
pÜt


179 
PIC2_DATA
 
EQU
 0A1
h
 ; 
SÏve
 
PIC
 
d©a
 
pÜt


180 
PIC_EOI
 
EQU
 20
h
 ; 
End
 
of
 
š‹¼u±
 
commªd


182 ; 
Maximum
 
numb”
 
of
 
NICs


183 
MAX_NICS
 
EQU
 2 ; 
SuµÜt
 
up
 
to
 2 
NICs


185 ; 
D©a
 
£gm’t


186 
_DATA
 
SEGMENT


187 
ASSUME
 
DS
:
_DATA


189 ; 
IRQ
 
mªagem’t


190 
nic_œq_numb”s
 
db
 
MAX_NICS
 
	`dup
(
IRQ_NONE
è; 
IRQ
 
numb”s
 
—ch
 
NIC


191 
Üigš®_œq_veùÜs
 
dd
 
MAX_NICS
 
	`dup
(0è; 
Origš®
 
š‹¼u±
 
veùÜs


192 
œq_š¡®Ëd
 
db
 
MAX_NICS
 
	`dup
(0è; 
IRQ
 
š¡®ÏtiÚ
 
æags


194 ; 
IÁ”ru±
 
¡©i¡ics


195 
œq_couÁ
 
dw
 
MAX_NICS
 
	`dup
(0è; 
IÁ”ru±
 
couÁ
 
³r
 
NIC


196 
¥urious_œq_couÁ
 
dw
 0 ; 
Spurious
 
š‹¼u±
 
couÁ


198 ; 
Cu¼’t
 
»ûive
 
mode


199 
cu¼’t_»ûive_mode
 
db
 2 ; 
DeçuÉ
 
to
 
dœeù
 
mode


201 ; 
Deãnsive
 
´og¿mmšg
 
	`d©a
 (
»quœed
 
by
 
t¤_deãnsive
.
šc
 
maüos
)

202 ; 
NÙe
: 
ÿÎ”_ss
/
ÿÎ”_¥
 
»moved
 - 
now
 
¡Üed
 
Ú
 
IRQ
 
¡ack
 
»’Œªcy
 
§ãty


203 
ü™iÿl_Ã¡šg
 
db
 0 ; 
Cr™iÿl
 
£ùiÚ
 
Ã¡šg
 
Ëv–


204 
šdos_£gm’t
 
dw
 0 ; 
InDOS
 
æag
 
£gm’t


205 
šdos_off£t
 
dw
 0 ; 
InDOS
 
æag
 
off£t


206 
ü™”r_£gm’t
 
dw
 0 ; 
Cr™iÿl
 
”rÜ
 
æag
 
£gm’t


207 
ü™”r_off£t
 
dw
 0 ; 
Cr™iÿl
 
”rÜ
 
æag
 
off£t


209 ; 
Priv©e
 
IRQ
 
hªdËr
 
¡acks
 
w™h
 
ov”æow
 
´ÙeùiÚ


210 ; 
Sized
 
wÜ¡
-
Ã¡ed
 
š‹¼u±s
: 
NIC
 + 
Tim”
 + 
Keybßrd
 + 
Disk
 + 
FPU


211 ; 2
KB
 
—ch
 
should
 
hªdË
 ~20 
Ã¡ed
 
š‹¼u±s
 
w™h
 100 
by‹s
 
av”age
 
³r
 
ISR


213 ; 16-
b™
 
¡ack
 
ÿÇry
 
·‰”ns
 
ov”æow
 
	`d‘eùiÚ
 (8086/286 
com·tibË
)

214 ; 
Usšg
 
wÜd
 
h®ves
 
of
 0xDEADBEEF 
š
 
l™e
-
’dŸn
 
fÜm©


215 
CANARY_WORD_LO
 
equ
 0BEEF
h
 ; 
Low
 
wÜd
 
of
 0xDEADBEEF

216 
CANARY_WORD_HI
 
equ
 0DEAD
h
 ; 
High
 
wÜd
 
of
 0xDEADBEEF

218 ; 
Red
 
zÚe
 
ÿÇry
 
©
 
bÙtom
 
of
 
—ch
 
	$¡ack
 (16 
by‹s
 = 8 
wÜds
)

219 
œq_¡ack_3c509b_ÿÇry
 
dw
 8 
	`dup
(
CANARY_WORD_LO
)

221 ; 3C509B 
IRQ
 
	`¡ack
 (2
KB
 + 
»d
 
zÚe
)

222 
œq_¡ack_3c509b
 
db
 2048 
	`dup
(?)

223 
œq_¡ack_tİ_3c509b
 
equ
 
$
 ; 
U£
 
fuÎ
 
¡ack
 
ÿ·c™y


225 ; 
Red
 
zÚe
 
ÿÇry
 
b‘w“n
 
	$¡acks
 (16 
by‹s
 = 8 
wÜds
)

226 
œq_¡ack_3c515_ÿÇry
 
dw
 8 
	`dup
(
CANARY_WORD_LO
)

228 ; 3C515 
IRQ
 
	`¡ack
 (2
KB
 + 
»d
 
zÚe
)

229 
œq_¡ack_3c515
 
db
 2048 
	`dup
(?)

230 
œq_¡ack_tİ_3c515
 
equ
 
$
 ; 
U£
 
fuÎ
 
¡ack
 
ÿ·c™y


232 ; 
Sck
 
ov”æow
 
d‘eùiÚ
 
couÁ”s


233 
¡ack_ov”æow_3c509b
 
dw
 0 ; 3C509B 
ov”æow
 
couÁ


234 
¡ack_ov”æow_3c515
 
dw
 0 ; 3C515 
ov”æow
 
couÁ


235 
em”g’cy_ÿÇry_couÁ
 
dw
 0 ; 
Em”g’cy
 
ÿÇry
 
»¥Ú£
 
couÁ


237 ; 
Deã¼ed
 
wÜk
 
funùiÚ
 
add»s£s


238 
deã¼ed_3c509b_wÜk
 
dw
 
OFFSET
 
´oûss_3c509b_·ck‘s


239 
deã¼ed_3c515_wÜk
 
dw
 
OFFSET
 
´oûss_3c515_·ck‘s


241 ; 
IÁ”ru±
 
b©chšg
 
cÚŒŞ


242 
MAX_EVENTS_PER_IRQ
 
equ
 10 ; 
Maximum
 
ev’ts
 
³r
 
	$š‹¼u±
 (
b©chšg
 
lim™
)

243 
b©ch_couÁ_3c509b
 
db
 0 ; 
Cu¼’t
 
b©ch
 
couÁ
 3C509B

244 
b©ch_couÁ_3c515
 
db
 0 ; 
Cu¼’t
 
b©ch
 
couÁ
 3C515-
TX


246 ; 
TempÜ¬y
 
·ck‘
 
	$bufãr
 (
should
 
be
 
»¶aûd
 
w™h
 
´İ”
 
bufãr
 
poŞ
)

247 
‹mp_rx_bufãr
 
db
 1600 
	`dup
(?è; 
Bufãr
 
·ck‘
 
»û±iÚ


249 ; 
Recov”y
 
	$couÁ”s
 (
»ã»nûd
 
by
 
deãnsive_š‹g¿tiÚ
.
asm
)

250 
»cov”y_couÁ
 
dw
 0 ; 
VeùÜ
 
»cov”y
 
©‹m±s


252 ; 
Enhªûd
 
¡©i¡ics
 
couÁ”s


253 
rx_·ck‘_couÁ
 
dw
 0 ; 
TÙ®
 
RX
 
·ck‘s


254 
tx_·ck‘_couÁ
 
dw
 0 ; 
TÙ®
 
TX
 
·ck‘s


255 
rx_”rÜ_couÁ
 
dw
 0 ; 
TÙ®
 
RX
 
”rÜs


256 
tx_”rÜ_couÁ
 
dw
 0 ; 
TÙ®
 
TX
 
”rÜs


257 
rx_ov”size_”rÜs
 
dw
 0 ; 
Ov”size
 
·ck‘
 
”rÜs


258 
rx_üc_”rÜs
 
dw
 0 ; 
CRC
 
”rÜs


259 
rx_äamšg_”rÜs
 
dw
 0 ; 
F¿mšg
 
”rÜs


260 
tx_max_cŞl_”rÜs
 
dw
 0 ; 
Max
 
cŞlisiÚ
 
”rÜs


261 
tx_und”run_”rÜs
 
dw
 0 ; 
TX
 
und”run
 
”rÜs


262 
tx_jabb”_”rÜs
 
dw
 0 ; 
Jabb”
 
”rÜs


264 ; 
ISR
 
¡©e
 
v¬ŸbËs


265 
cu¼’t_ioba£
 
dw
 0 ; 
Cu¼’t
 
NIC
 
I
/
O
 
ba£


266 
cu¼’t_tx_bufãr
 
dw
 0 ; 
Cu¼’t
 
TX
 
bufãr
 
poš‹r


267 
cu¼’t_tx_»Œ›s
 
db
 0 ; 
TX
 
»Œy
 
couÁ”


268 
œq_Ú_¦ave
 
db
 0 ; 
FÏg
 
¦ave
 
PIC
 
IRQ


269 
nic_ioba£_bË
 
dw
 
MAX_NICS
 
	`dup
(0è; 
I
/
O
 
ba£
 
add»s£s


271 ; 
DMA
 
mªagem’t
 
¡ruùu»s


272 
rx_dma_ršg_ba£
 
dd
 0 ; 
RX
 
DMA
 
ršg
 
ba£
 
add»ss


273 
rx_dma_ršg_’d
 
dw
 0 ; 
RX
 
DMA
 
ršg
 
’d
 
off£t


274 
rx_dma_ršg_±r
 
dw
 0 ; 
Cu¼’t
 
RX
 
DMA
 
poš‹r


275 
tx_dma_ršg_ba£
 
dd
 0 ; 
TX
 
DMA
 
ršg
 
ba£
 
add»ss


276 
tx_dma_ršg_’d
 
dw
 0 ; 
TX
 
DMA
 
ršg
 
’d
 
off£t


277 
tx_dma_ršg_±r
 
dw
 0 ; 
Cu¼’t
 
TX
 
DMA
 
poš‹r


279 ; 
Bufãr
 
poŞ
 
mªagem’t


280 
rx_bufãr_poŞ
 
dd
 32 
	`dup
(0è; 
RX
 
bufãr
 
poŞ


281 
tx_bufãr_poŞ
 
dd
 16 
	`dup
(0è; 
TX
 
bufãr
 
poŞ


282 
rx_ä“_couÁ
 
dw
 32 ; 
F»e
 
RX
 
bufãrs


283 
tx_ä“_couÁ
 
dw
 16 ; 
F»e
 
TX
 
bufãrs


285 ; 64-
b™
 
by‹
 
couÁ”s


286 
tx_by‹s_lo
 
dw
 0 ; 
TX
 
by‹s
 
low
 
wÜd


287 
tx_by‹s_hi
 
dw
 0 ; 
TX
 
by‹s
 
high
 
wÜd


288 
rx_by‹s_lo
 
dw
 0 ; 
RX
 
by‹s
 
low
 
wÜd


289 
rx_by‹s_hi
 
dw
 0 ; 
RX
 
by‹s
 
high
 
wÜd


291 
_DATA
 
ENDS


293 ; 
Code
 
£gm’t


294 
_TEXT
 
SEGMENT


295 
ASSUME
 
CS
:
_TEXT
, 
DS
:
_DATA


297 ; 
Public
 
funùiÚ
 
expÜts


298 
PUBLIC
 
nic_œq_š™


299 
PUBLIC
 
š¡®l_nic_œq


300 
PUBLIC
 
unš¡®l_nic_œq


301 
PUBLIC
 
nic_œq_hªdËr_3c509b


302 
PUBLIC
 
nic_œq_hªdËr_3c515


303 
PUBLIC
 
nic_œq_hªdËr_3c509b_b©ched


304 
PUBLIC
 
nic_œq_hªdËr_3c515_b©ched


305 
PUBLIC
 
nic_commÚ_œq_hªdËr


306 
PUBLIC
 
nic_£t_»ûive_mode


307 
PUBLIC
 
g‘_œq_¡©s


308 ; 
Enhªûd
 
š‹¼u±
 
hªdlšg
 
expÜts


309 
PUBLIC
 
´oûss_3c509b_·ck‘s


310 
PUBLIC
 
´oûss_3c515_·ck‘s


311 
PUBLIC
 
nic_´oûss_š‹¼u±_b©ch_3c509b


312 
PUBLIC
 
nic_´oûss_š‹¼u±_b©ch_3c515


313 
PUBLIC
 
check_3c509b_š‹¼u±_sourû


314 
PUBLIC
 
check_3c515_š‹¼u±_sourû


315 
PUBLIC
 
acknowËdge_3c509b_š‹¼u±


316 
PUBLIC
 
acknowËdge_3c515_š‹¼u±


318 ; 
Ex‹º®
 
»ã»nûs


319 
EXTRN
 
h¬dw¬e_hªdË_3c509b_œq
:
PROC
 ; 
From
 
h¬dw¬e
.
asm


320 
EXTRN
 
h¬dw¬e_hªdË_3c515_œq
:
PROC
 ; 
From
 
h¬dw¬e
.
asm


321 
EXTRN
 
·ck‘_İs_»ûive
:
PROC
 ; 
From
 
·ck‘_İs
.
asm


322 
EXTRN
 
g‘_ıu_ã©u»s
:
PROC
 ; 
From
 
ıu_d‘eù
.
asm


323 
EXTRN
 
_3c515_hªdË_š‹¼u±_b©ched
:
PROC
 ; 
Enhªûd
 3C515 
hªdËr


324 
EXTRN
 
_3c509b_hªdË_š‹¼u±_b©ched
:
PROC
 ; 
Enhªûd
 3C509B 
hªdËr


326 ; 
Deãnsive
 
´og¿mmšg
 
š‹g¿tiÚ


327 
EXTRN
 
queue_deã¼ed_wÜk
:
PROC
 ; 
From
 
deãnsive_š‹g¿tiÚ
.
asm


330 ; 
nic_œq_š™
 - 
In™Ÿlize
 
NIC
 
š‹¼u±
 
hªdlšg


332 ; 
IÅut
: 
NÚe


333 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


334 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


336 
nic_œq_š™
 
PROC


337 
push
 
bp


338 
mov
 
bp
, 
¥


339 
push
 
bx


340 
push
 
cx


341 
push
 
dx


342 
push
 
si


344 ; 
V®id©e
 
IRQ
 
¿nges
 
	`NICs
 (
Úly
 3,5,7,9-12,15 
®lowed
)

345 
ÿÎ
 
v®id©e_œq_¿nges


346 
jc
 .
šv®id_œq_cÚfig


348 ; 
In™Ÿlize
 
PIC
 
¡©e
 
Œackšg


349 
ÿÎ
 
š™_pic_¡©e


350 
jc
 .
pic_š™_çed


352 ; 
D‘eù
 
cu¼’t
 
IRQ
 
cÚæiùs


353 
ÿÎ
 
d‘eù_œq_cÚæiùs


354 ; 
CÚtšue
 
ev’
 
cÚæiùs
 
	`d‘eùed
 (
w¬nšgs
 
Úly
)

356 ; 
CË¬
 
IRQ
 
assignm’t
 
bË


357 
mov
 
cx
, 
MAX_NICS


358 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


359 
mov
 
®
, 
IRQ_NONE


360 .
ş—r_œq_loİ
:

361 
mov
 [
si
], 
®


362 
šc
 
si


363 
loİ
 .
ş—r_œq_loİ


365 ; 
CË¬
 
š¡®ÏtiÚ
 
æags


366 
mov
 
cx
, 
MAX_NICS


367 
mov
 
si
, 
OFFSET
 
œq_š¡®Ëd


368 
xÜ
 
®
,‡l

369 .
ş—r_æags_loİ
:

370 
mov
 [
si
], 
®


371 
šc
 
si


372 
loİ
 .
ş—r_æags_loİ


374 ; 
In™Ÿlize
 
š‹¼u±
 
b©chšg
 
couÁ”s


375 
mov
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
], 0

376 
mov
 
by‹
 
±r
 [
b©ch_couÁ_3c515
], 0

378 ; 
CË¬
 
š‹¼u±
 
¡©i¡ics


379 
mov
 
wÜd
 
±r
 [
œq_couÁ
], 0

380 
mov
 
wÜd
 
±r
 [
œq_couÁ
+2], 0

381 
mov
 
wÜd
 
±r
 [
¥urious_œq_couÁ
], 0

383 ; 
In™Ÿlize
 
deãnsive
 
´og¿mmšg
 
d©a
 
»quœed
 
by
 
maüos


384 
mov
 
wÜd
 
±r
 [
ÿÎ”_ss
], 0

385 
mov
 
wÜd
 
±r
 [
ÿÎ”_¥
], 0

386 
mov
 
by‹
 
±r
 [
ü™iÿl_Ã¡šg
], 0

388 ; 
Auto
-
d‘eù
 
Ü
 
u£
 
cÚfigu»d
 
IRQ
 
assignm’ts


389 
ÿÎ
 
auto_d‘eù_œqs


390 
jnc
 .
œq_d‘eùiÚ_dÚe


392 ; 
U£
 
çÎback
 
deçuÉs
 auto-
d‘eùiÚ
 
çs


393 
ÿÎ
 
­¶y_deçuÉ_œqs


395 .
œq_d‘eùiÚ_dÚe
:

397 ; 
Sucûss


398 
mov
 
ax
, 0

399 
jmp
 .
ex™


401 .
šv®id_œq_cÚfig
:

402 
mov
 
ax
, 1

403 
jmp
 .
ex™


405 .
pic_š™_çed
:

406 
mov
 
ax
, 2

407 
jmp
 .
ex™


409 .
ex™
:

410 
pİ
 
si


411 
pİ
 
dx


412 
pİ
 
cx


413 
pİ
 
bx


414 
pİ
 
bp


415 
»t


416 
nic_œq_š™
 
ENDP


419 ; 
š¡®l_nic_œq
 - 
In¡®l
 
š‹¼u±
 
hªdËr
 
¥ecific
 
NIC


421 ; 
IÅut
: 
AL
 = 
NIC
 
	`šdex
 (0-
ba£d
), 
BL
 = 
IRQ
 
numb”


422 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


423 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
DI
, 
ES


425 
š¡®l_nic_œq
 
PROC


426 
push
 
bp


427 
mov
 
bp
, 
¥


428 
push
 
bx


429 
push
 
cx


430 
push
 
dx


431 
push
 
si


432 
push
 
di


433 
push
 
es


435 ; 
V®id©e
 
IRQ
 
numb”
 
agaš¡
 
®lowed
 
¿nges


436 
ÿÎ
 
v®id©e_sšgË_œq_numb”


437 
jc
 .
šv®id_œq


439 ; 
Check
 
IRQ
 
cÚæiùs
 
w™h
 
Ùh”
 
deviûs


440 
ÿÎ
 
check_œq_cÚæiù


441 
jc
 .
œq_cÚæiù


443 ; 
Save
 
Üigš®
 
š‹¼u±
 
veùÜ
 
befÜe
 
š¡®ÏtiÚ


444 
ÿÎ
 
§ve_Üigš®_veùÜ


445 
jc
 .
§ve_çed


447 ; 
In¡®l
 
­´İrŸ‹
 
š‹¼u±
 
hªdËr
 
ba£d
 
Ú
 
NIC
 
ty³


448 
ÿÎ
 
š¡®l_œq_hªdËr


449 
jc
 .
š¡®l_çed


451 ; 
EÇbË
 
IRQ
 
©
 
PIC
 
Ëv–


452 
ÿÎ
 
’abË_pic_œq


453 
jc
 .
pic_’abË_çed


455 ; 
V®id©e
 
NIC
 
šdex


456 
cmp
 
®
, 
MAX_NICS


457 
j«
 .
šv®id_nic


459 ; 
V®id©e
 
IRQ
 
numb”


460 
cmp
 
bl
, 
IRQ_MIN


461 
jb
 .
šv®id_œq


462 
cmp
 
bl
, 
IRQ_MAX


463 
ja
 .
šv®id_œq


465 ; 
StÜe
 
IRQ
 
numb”


466 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


467 
mov
 
ah
, 0

468 
add
 
si
, 
ax


469 
mov
 [
si
], 
bl


471 ; 
In¡®ÏtiÚ
 
sucûssful
 - 
upd©e
 
Œackšg
 
¡ruùu»s


472 
ÿÎ
 
upd©e_œq_Œackšg


474 ; 
M¬k
 
as
 
š¡®Ëd


475 
mov
 
si
, 
OFFSET
 
œq_š¡®Ëd


476 
add
 
si
, 
ax


477 
mov
 
by‹
 
±r
 [
si
], 1

479 ; 
Sucûss


480 
mov
 
ax
, 0

481 
jmp
 .
ex™


483 .
šv®id_nic
:

484 
mov
 
ax
, 1

485 
jmp
 .
ex™


487 .
šv®id_œq
:

488 
mov
 
ax
, 2

489 
jmp
 .
ex™


491 .
œq_cÚæiù
:

492 
mov
 
ax
, 3

493 
jmp
 .
ex™


495 .
§ve_çed
:

496 
mov
 
ax
, 4

497 
jmp
 .
ex™


499 .
š¡®l_çed
:

500 
mov
 
ax
, 5

501 
jmp
 .
ex™


503 .
pic_’abË_çed
:

504 
mov
 
ax
, 6

505 
jmp
 .
ex™


507 .
ex™
:

508 
pİ
 
es


509 
pİ
 
di


510 
pİ
 
si


511 
pİ
 
dx


512 
pİ
 
cx


513 
pİ
 
bx


514 
pİ
 
bp


515 
»t


516 
š¡®l_nic_œq
 
ENDP


519 ; 
unš¡®l_nic_œq
 - 
Unš¡®l
 
š‹¼u±
 
hªdËr
 
¥ecific
 
NIC


521 ; 
IÅut
: 
AL
 = 
NIC
 
	`šdex
 (0-
ba£d
)

522 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


523 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
ES


525 
unš¡®l_nic_œq
 
PROC


526 
push
 
bp


527 
mov
 
bp
, 
¥


528 
push
 
bx


529 
push
 
cx


530 
push
 
dx


531 
push
 
si


532 
push
 
es


534 ; 
G‘
 
IRQ
 
numb”
 
this
 
NIC


535 
ÿÎ
 
g‘_nic_œq_numb”


536 
jc
 .
nÙ_š¡®Ëd


538 ; 
Di§bË
 
IRQ
 
©
 
PIC
 
Ëv–
 
fœ¡


539 
ÿÎ
 
di§bË_pic_œq


541 ; 
Re¡Üe
 
Üigš®
 
š‹¼u±
 
veùÜ


542 
ÿÎ
 
»¡Üe_Üigš®_veùÜ


544 ; 
CË¬
 
IRQ
 
Œackšg
 
šfÜm©iÚ


545 
ÿÎ
 
ş—r_œq_Œackšg


547 ; 
V®id©e
 
NIC
 
šdex


548 
cmp
 
®
, 
MAX_NICS


549 
j«
 .
šv®id_nic


551 ; 
Check
 
IRQ
 
is
 
š¡®Ëd


552 
mov
 
si
, 
OFFSET
 
œq_š¡®Ëd


553 
mov
 
ah
, 0

554 
add
 
si
, 
ax


555 
cmp
 
by‹
 
±r
 [
si
], 0

556 
je
 .
nÙ_š¡®Ëd


558 ; 
Upd©e
 
unš¡®l
 
Œackšg


559 
ÿÎ
 
upd©e_unš¡®l_Œackšg


561 ; 
M¬k
 
as
 
unš¡®Ëd


562 
mov
 
by‹
 
±r
 [
si
], 0

564 ; 
CË¬
 
IRQ
 
numb”


565 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


566 
add
 
si
, 
ax


567 
mov
 
by‹
 
±r
 [
si
], 
IRQ_NONE


569 ; 
Sucûss


570 
mov
 
ax
, 0

571 
jmp
 .
ex™


573 .
šv®id_nic
:

574 
mov
 
ax
, 1

575 
jmp
 .
ex™


577 .
nÙ_š¡®Ëd
:

578 
mov
 
ax
, 0 ; 
NÙ
 
ª
 
”rÜ
 
®»ady
 
unš¡®Ëd


579 
jmp
 .
ex™


581 .
ex™
:

582 
pİ
 
es


583 
pİ
 
si


584 
pİ
 
dx


585 
pİ
 
cx


586 
pİ
 
bx


587 
pİ
 
bp


588 
»t


589 
unš¡®l_nic_œq
 
ENDP


592 ; 
nic_œq_hªdËr_3c509b
 - 
OPTIMIZED
 
IÁ”ru±
 
hªdËr
 3C509B 
NIC


593 ; 
Pha£
 3 
P”fÜmªû
 
O±imiz©iÚ
: <100Âµ
s
 
executiÚ
 
rg‘


595 ; 
O±imiz©iÚs
:

596 ; - 
SŒ—mlšed
 
ISR
 
ü™iÿl
 
·th


597 ; - 
CPU
-
¥ecific
 
	`İ”©iÚs
 (286+/386+)

598 ; - 
IÁ”ru±
 
cßËscšg
 
w™h
 
b©chšg


599 ; - 
Mšim®
 
ISR
 
wÜk
 
w™h
 
deã¼ed
 
´oûssšg


600 ; - 
P”fÜmªû
 
m—su»m’t
 
š‹g¿tiÚ


602 ; 
IÅut
: 
	`NÚe
 (
š‹¼u±
 
cÚ‹xt
)

603 ; 
Ouut
: 
NÚe


604 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
§ved
/
»¡Üed
 
w™h
 
CPU
 
İtimiz©iÚ
)

606 
nic_œq_hªdËr_3c509b
 
PROC


607 ; ==ğ
PHASE
 3 
OPTIMIZED
 
ISR
 
PROLOG
 ===

608 ; 
S¹
 
³rfÜmªû
 
m—su»m’t
 
immedŸ‹ly


609 
push
 
ax


610 
push
 
dx


612 ; 
Quick
 
time¡amp
 
ISR
 
³rfÜmªû
 
Œackšg


613 
mov
 
ah
, 0

614 1A
h
 ; 
G‘
 
tick
 
couÁ
 
timšg


615 
mov
 [
³rf_¡¬t_time
], 
dx


617 
pİ
 
dx


619 ; 
S‘
 
up
 
our
 
d©a
 
	$£gm’t
 (
İtimized
)

620 
mov
 
ax
, 
_DATA


621 
mov
 
ds
, 
ax


622 
ASSUME
 
DS
:
_DATA


624 ; 
CPU
-
İtimized
 
§ve
 
ba£d
 
Ú
 
d‘eùed
 
ÿ·b™›s


625 
‹¡
 
wÜd
 
±r
 [
ıu_ÿ·b™›s
], 
CPU_CAP_286


626 
jz
 .
§ve_8086_¡yË


628 ; 286+ 
İtimized
 
§ve
 
usšg
 
PUSHA


629 
pusha
 ; 
SšgË
 
š¡ruùiÚ
 
vs
 8 
pushes


630 
push
 
es


631 
push
 
ds


632 
jmp
 .
»gi¡”s_§ved


634 .
§ve_8086_¡yË
:

635 ; 8086 
com·tibË
 
§ve


636 
push
 
ax


637 
push
 
bx


638 
push
 
cx


639 
push
 
dx


640 
push
 
si


641 
push
 
di


642 
push
 
es


643 
push
 
ds


645 .
»gi¡”s_§ved
:

646 ; 
Sw™ch
 
to
 
´iv©e
 
¡ack
 
usšg
 
deãnsive
 
maüo


647 
SAFE_STACK_SWITCH_3C509B


649 ; ==ğ
STREAMLINED
 
ISR
 
CRITICAL
 
	`PATH
 (
T¬g‘
: <50Âµ
s
) ===

650 ; 
UÉ¿
-
ç¡
 
h¬dw¬e
 
check
 - 
is
 
this
 
š‹¼u±
 
»®ly
 
ours
?

651 
ÿÎ
 
check_3c509b_š‹¼u±_sourû_ç¡


652 
jc
 .
¥urious_š‹¼u±


654 ; 
O±imized
 
š‹¼u±
 
cßËscšg
 
ªd
 
b©chšg


655 ; 
This
 
is
 
the
 
key
 
to
 
ach›všg
 <100Âµ
s
 
rg‘


656 
ÿÎ
 
š‹¼u±_cßËsû_ªd_b©ch_3c509b


657 
cmp
 
ax
, 0

658 
je
 .
no_immedŸ‹_wÜk
 ; 
AÎ
 
wÜk
 
cßËsûd
 
Ï‹r


660 ; 
Mšim®
 
immedŸ‹
 
´oûssšg
 
Úly
 
urg’t
 
š‹¼u±s


661 
ÿÎ
 
´oûss_urg’t_3c509b_š‹¼u±s


663 ; 
S’d
 
EOI
 
w™h
 
İtimized
 
PIC
 
hªdlšg


664 
ÿÎ
 
£nd_eoi_fÜ_3c509b_İtimized


666 .
no_immedŸ‹_wÜk
:

667 ; 
Inüem’t
 
³rfÜmªû
 
couÁ”s


668 
šc
 
wÜd
 
±r
 [
œq_couÁ
]

669 
šc
 
dwÜd
 
±r
 [
tÙ®_š‹¼u±s
]

671 ; ==ğ
DEFER
 
ALL
 
HEAVY
 
WORK
 ===

672 ; 
Queue
 
com´eh’sive
 
·ck‘
 
´oûssšg
 
DOS
 
idË
 
time


673 
mov
 
ax
, [
deã¼ed_3c509b_wÜk
]

674 
ÿÎ
 
queue_deã¼ed_wÜk


675 
jc
 .
queue_ov”æow_hªdËd
 ; 
F®lback
 
®»ady
 
hªdËd


677 
jmp
 .
i¤_ex™_İtimized


679 .
¥urious_š‹¼u±
:

680 ; 
O±imized
 
¥urious
 
š‹¼u±
 
hªdlšg


681 
šc
 
wÜd
 
±r
 [
¥urious_œq_couÁ
]

682 ; 
DÚ
't send EOI for spurious interrupts

683 
jmp
 .
i¤_ex™_İtimized


685 .
queue_ov”æow_hªdËd
:

686 ; 
Queue
 
ov”æow
 
is
 
hªdËd
 
š
 
š‹¼u±_cßËsû_ªd_b©ch_3c509b


687 ; 
No
 
add™iÚ®
 
´oûssšg
 
Ãeded
 
h”e


689 .
i¤_ex™_İtimized
:

690 ; ==ğ
PHASE
 3 
OPTIMIZED
 
ISR
 
EPILOG
 ===

691 ; 
End
 
³rfÜmªû
 
m—su»m’t


692 
push
 
ax


693 
push
 
dx


694 
mov
 
ah
, 0

695 1A
h
 ; 
G‘
 
’d
 
tick
 
couÁ


696 
mov
 [
³rf_’d_time
], 
dx


698 ; 
C®cuÏ‹
 
ªd
 
»cÜd
 
ISR
 
executiÚ
 
time


699 
mov
 
ax
, 
dx


700 
sub
 
ax
, [
³rf_¡¬t_time
]

701 
mov
 [
i¤_executiÚ_time
], 
ax


703 ; 
RecÜd
 
³rfÜmªû
 
§m¶e
 
mÚ™Üšg


704 
push
 
cx


705 
mov
 
ş
, 1 ; 
IÁ”ru±
 
ty³
: 
RX
/
TX


706 
mov
 
ch
, [
š‹¼u±_b©ch_couÁ
]

707 
ÿÎ
 
³rfÜmªû_mÚ™Ü_»cÜd_§m¶e_asm


708 
pİ
 
cx


710 
pİ
 
dx


711 
pİ
 
ax


713 ; 
Re¡Üe
 
ÿÎ”
's stack

714 
şi
 ; 
Cr™iÿl
 
£ùiÚ
 
¡¬t


715 
mov
 
ss
, [
ÿÎ”_ss
]

716 
mov
 
¥
, [
ÿÎ”_¥
]

717 
¡i
 ; 
Cr™iÿl
 
£ùiÚ
 
’d


719 ; 
CPU
-
İtimized
 
»¡Üe


720 
‹¡
 
wÜd
 
±r
 [
ıu_ÿ·b™›s
], 
CPU_CAP_286


721 
jz
 .
»¡Üe_8086_¡yË


723 ; 286+ 
İtimized
 
»¡Üe
 
usšg
 
POPA


724 
pİ
 
ds


725 
pİ
 
es


726 
pİa
 ; 
SšgË
 
š¡ruùiÚ
 
vs
 8 
pİs


727 
jmp
 .
»gi¡”s_»¡Üed


729 .
»¡Üe_8086_¡yË
:

730 ; 8086 
com·tibË
 
»¡Üe


731 
pİ
 
ds


732 
pİ
 
es


733 
pİ
 
di


734 
pİ
 
si


735 
pİ
 
dx


736 
pİ
 
cx


737 
pİ
 
bx


738 
pİ
 
ax


740 .
»gi¡”s_»¡Üed
:

741 ; 
Fš®
 
»¡Üe
 
ªd
 

742 
pİ
 
ax


744 
œ‘


745 
nic_œq_hªdËr_3c509b
 
ENDP


748 ; 
PHASE
 3 
OPTIMIZED
 
SuµÜt
 
funùiÚs
 
’hªûd
 3C509B 
š‹¼u±
 
hªdlšg


751 ; 
Fa¡
 
š‹¼u±
 
sourû
 
check
 - 
İtimized
 
mšim®
 
Ï‹ncy


752 
check_3c509b_š‹¼u±_sourû_ç¡
 
PROC


753 ; 
UÉ¿
-
ç¡
 
h¬dw¬e
 
check
 
İtimized
 <10Âµ
s
 
executiÚ


754 ; 
R‘uºs
: 
CY
 
ş—r
 
ours
, CY 
£t
 
nÙ
 ours

755 
push
 
dx


756 
push
 
bx


758 ; 
G‘
 
I
/
O
 
ba£
 
w™h
 
İtimized
 
lookup


759 
mov
 
bx
, 0 ; 
NIC
 0 
šdex


760 
shl
 
bx
, 1 ; 
WÜd
 
off£t


761 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
] ; 
Dœeù
 
šdexed
 
lookup


762 
‹¡
 
dx
, dx

763 
jz
 .
nÙ_ours_ç¡
 ; 
No
 
I
/
O
 
ba£
 = 
nÙ
 
our
 
š‹¼u±


765 ; 
SšgË
 
combšed
 
»ad
 
®l
 
š‹¼u±
 
¡©us
 
b™s


766 
add
 
dx
, 0E
h
 ; 
Stus
 
off£t


767 
š
 
ax
, 
dx
 ; 
R—d
 
	`¡©us
 (16-
b™
)

769 ; 
Check
 
muÉË
 
š‹¼u±
 
cÚd™iÚs
 
š
 
·¿Î–


770 ; 
	`IÁL©ch
 (
b™
 0è+ 
	`IÁReq
 (b™ 6è+ 
ªy
 
”rÜ
 
	`b™s
 (7-11)

771 
‹¡
 
ax
, 0FC1
h
 ; 
Te¡
 
®l
 
»Ëvªt
 
b™s
 
©
 
Úû


772 
jz
 .
nÙ_ours_ç¡
 ; 
No
 
š‹¼u±
 
cÚd™iÚ


774 ; 
Add™iÚ®
 
İtimiz©iÚ
: 
check
 
commÚ
 
š‹¼u±
 
·‰”ns


775 
‹¡
 
®
, 01
h
 ; 
IÁL©ch


776 
jz
 .
nÙ_ours_ç¡


777 
‹¡
 
®
, 40
h
 ; 
IÁReq


778 
jz
 .
nÙ_ours_ç¡


780 ; 
This
 
is
 
our
 
š‹¼u±
 - 
İtimize
 
commÚ
 

781 
pİ
 
bx


782 
pİ
 
dx


783 
şc
 ; 
CË¬
 
ÿ¼y
 = 
ours


784 
»t


786 .
nÙ_ours_ç¡
:

787 
pİ
 
bx


788 
pİ
 
dx


789 
¡c
 ; 
S‘
 
ÿ¼y
 = 
nÙ
 
ours


790 
»t


791 
check_3c509b_š‹¼u±_sourû_ç¡
 
ENDP


793 ; 
O±imized
 
š‹¼u±
 
cßËscšg
 
ªd
 
b©chšg


794 
š‹¼u±_cßËsû_ªd_b©ch_3c509b
 
PROC


795 ; 
Advªûd
 
š‹¼u±
 
cßËscšg
 <100Âµ
s
 
ISR
 
rg‘


796 ; 
IÅut
: 
NÚe


797 ; 
Ouut
: 
AX
 = 0 
cßËsûd
, 
nÚ
-
z”o
 
immedŸ‹
 
wÜk
 
Ãeded


798 
push
 
bx


799 
push
 
cx


800 
push
 
dx


802 ; 
R—d
 
h¬dw¬e
 
š‹¼u±
 
¡©us


803 
mov
 
bx
, 0 ; 
NIC
 0 
šdex


804 
shl
 
bx
, 1

805 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
]

806 
add
 
dx
, 0E
h
 ; 
Stus
 

807 
š
 
ax
, 
dx
 ; 
R—d
 
š‹¼u±
 
¡©us


809 ; 
Aµly
 
š‹¼u±
 
cßËscšg
 
®gÜ™hm


810 
ÿÎ
 
š‹¼u±_cßËsû_´oûss


811 
mov
 
cx
, 
ax
 ; 
Save
 
cßËsûd
 
»suÉ


813 ; 
If
 
cßËscšg
 
aùive
,  0 
no
 
immedŸ‹
 
wÜk


814 
‹¡
 
cx
, cx

815 
jz
 .
cßËscšg_aùive


817 ; 
Proûss
 
immedŸ‹
 
b©ch
 
w™h
 
size
 
lim™


818 
mov
 
by‹
 
±r
 [
š‹¼u±_b©ch_couÁ
], 0

819 
ÿÎ
 
š‹¼u±_b©ch_´oûss_İtimized


821 ; 
R‘uº
 
nÚ
-
z”o
 
to
 
šdiÿ‹
 
immedŸ‹
 
wÜk
 
was
 
dÚe


822 
mov
 
ax
, 1

823 
jmp
 .
cßËsû_dÚe


825 .
cßËscšg_aùive
:

826 ; 
AÎ
 
wÜk
 
deã¼ed
 -  0

827 
xÜ
 
ax
,‡x

829 .
cßËsû_dÚe
:

830 
pİ
 
dx


831 
pİ
 
cx


832 
pİ
 
bx


833 
»t


834 
š‹¼u±_cßËsû_ªd_b©ch_3c509b
 
ENDP


836 ; 
Proûss
 
urg’t
 
š‹¼u±s
 
	$Úly
 (
mšim®
 
wÜk
)

837 
´oûss_urg’t_3c509b_š‹¼u±s
 
PROC


838 ; 
Proûss
 
Úly
 
the
 
mo¡
 
urg’t
 
š‹¼u±s
 
š
 <20Âµ
s


839 ; 
Ev”ythšg
 
is
 
deã¼ed
 
com´eh’sive
 
´oûssšg


840 
push
 
ax


841 
push
 
dx


842 
push
 
bx


844 ; 
G‘
 
h¬dw¬e
 
¡©us
 
w™h
 
mšim®
 
ov”h—d


845 
mov
 
bx
, 0

846 
shl
 
bx
, 1

847 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
]

848 
add
 
dx
, 0E
h


849 
š
 
ax
, 
dx


851 ; 
Check
 
Úly
 
ü™iÿl
 
”rÜ
 
cÚd™iÚs
 
th©
 
Ãed
 
immedŸ‹
 
©‹ÁiÚ


852 
‹¡
 
ax
, 0002
h
 ; 
ADAPTER_FAILURE


853 
jz
 .
no_ü™iÿl_”rÜ


855 ; 
Mšim®
 
”rÜ
 
hªdlšg
 - 
ju¡
 
acknowËdge
 
ªd
 
log


856 
ÿÎ
 
acknowËdge_3c509b_ü™iÿl_”rÜ


857 
šc
 
dwÜd
 
±r
 [
ü™iÿl_”rÜs
]

859 .
no_ü™iÿl_”rÜ
:

860 ; 
AÎ
 
Ùh”
 
š‹¼u±
 
´oûssšg
 
is
 
deã¼ed


861 ; 
This
 
k“ps
 
ISR
 
time
 
to
 
absŞu‹
 
mšimum


863 
pİ
 
bx


864 
pİ
 
dx


865 
pİ
 
ax


866 
»t


867 
´oûss_urg’t_3c509b_š‹¼u±s
 
ENDP


869 ; 
O±imized
 
EOI
 
£ndšg
 
w™h
 
»duûd
 
PIC
 
acûss


870 
£nd_eoi_fÜ_3c509b_İtimized
 
PROC


871 ; 
UÉ¿
-
ç¡
 
EOI
 
w™h
 
mšim®
 
PIC
 
acûss


872 
push
 
ax


873 
push
 
bx


874 
push
 
dx


876 ; 
G‘
 
IRQ
 
numb”
 
w™h
 
İtimized
 
lookup


877 
mov
 
bl
, 
by‹
 
±r
 [
nic_œq_numb”s
] ; 
NIC
 0 
IRQ


878 
cmp
 
bl
, 
IRQ_NONE


879 
je
 .
no_eoi_Ãeded


881 ; 
O±imized
 
PIC
 
EOI
 
£qu’û


882 
mov
 
®
, 
PIC_EOI


883 
cmp
 
bl
, 8

884 
jl
 .
ma¡”_pic_eoi


886 ; 
SÏve
 
PIC
 - 
u£
 
İtimized
 
EOI


887 
mov
 
dx
, 
PIC2_COMMAND


888 
out
 
dx
, 
®
 ; 
EOI
 
to
 
¦ave


889 
mov
 
dx
, 
PIC1_COMMAND


890 
out
 
dx
, 
®
 ; 
EOI
 
to
 
ma¡”


891 
jmp
 .
eoi_com¶‘e


893 .
ma¡”_pic_eoi
:

894 ; 
Ma¡”
 
PIC
 
Úly


895 
mov
 
dx
, 
PIC1_COMMAND


896 
out
 
dx
, 
®


898 .
eoi_com¶‘e
:

899 .
no_eoi_Ãeded
:

900 
pİ
 
dx


901 
pİ
 
bx


902 
pİ
 
ax


903 
»t


904 
£nd_eoi_fÜ_3c509b_İtimized
 
ENDP


906 ; 
O±imized
 
b©ch
 
´oûssšg
 
w™h
 
CPU
-
¥ecific
 
š¡ruùiÚs


907 
š‹¼u±_b©ch_´oûss_İtimized
 
PROC


908 ; 
Proûss
 
š‹¼u±
 
b©ch
 
w™h
 
CPU
-
¥ecific
 
İtimiz©iÚs


909 ; 
T¬g‘
: 
Proûss
 
up
 
to
 10 
š‹¼u±s
 
š
 <30Âµ
s


910 
push
 
bx


911 
push
 
cx


912 
push
 
dx


914 
mov
 
ş
, 0 ; 
Proûs£d
 
couÁ


915 
mov
 
bl
, 
®
 ; 
IÁ”ru±
 
mask


917 ; 
Check
 486+ 
BSF
 
š¡ruùiÚ
 
İtimiz©iÚ


918 
‹¡
 
wÜd
 
±r
 [
ıu_ÿ·b™›s
], 
CPU_CAP_BSF


919 
jnz
 .
u£_bsf_b©ch


921 ; 
G’”ic
 
b™
 
sÿÂšg
 286/386

922 
mov
 
dl
, 1

924 .
g’”ic_b©ch_loİ
:

925 
‹¡
 
bl
, 
dl


926 
jz
 .
Ãxt_g’”ic_b™


928 ; 
Proûss
 
š‹¼u±
 
	$b™
 (
mšim®
 
wÜk
 
Úly
)

929 
ÿÎ
 
´oûss_š‹¼u±_b™_mšim®


930 
šc
 
ş


932 ; 
Check
 
b©ch
 
lim™


933 
cmp
 
ş
, 
MAX_EVENTS_PER_IRQ


934 
j«
 .
b©ch_com¶‘e


936 .
Ãxt_g’”ic_b™
:

937 
shl
 
dl
, 1

938 
jnz
 .
g’”ic_b©ch_loİ


939 
jmp
 .
b©ch_com¶‘e


941 .
u£_bsf_b©ch
:

942 ; 486+ 
İtimized
 
b™
 
sÿÂšg


943 
‹¡
 
bl
, bl

944 
jz
 .
b©ch_com¶‘e


946 .
bsf_b©ch_loİ
:

947 ; 
Fšd
 
fœ¡
 
£t
 
b™
 
usšg
 
BSF


948 
db
 0F
h
, 0BCh, 0D3h ; 
BSF
 
DX
, 
BX


949 
jz
 .
b©ch_com¶‘e


951 ; 
Proûss
 
š‹¼u±
 
b™


952 
ÿÎ
 
´oûss_š‹¼u±_b™_mšim®


953 
šc
 
ş


955 ; 
CË¬
 
´oûs£d
 
b™


956 
push
 
ax


957 
mov
 
®
, 1

958 
shl
 
®
, 
dl


959 
nÙ
 
®


960 
ªd
 
bl
, 
®


961 
pİ
 
ax


963 ; 
Check
 
b©ch
 
lim™


964 
cmp
 
ş
, 
MAX_EVENTS_PER_IRQ


965 
jb
 .
bsf_b©ch_loİ


967 .
b©ch_com¶‘e
:

968 ; 
Upd©e
 
b©ch
 
¡©i¡ics


969 
mov
 [
š‹¼u±_b©ch_couÁ
], 
ş


970 
cmp
 
ş
, 1

971 
jbe
 .
no_b©ch_¡©s


972 
šc
 
dwÜd
 
±r
 [
b©ched_š‹¼u±s
]

974 .
no_b©ch_¡©s
:

975 
pİ
 
dx


976 
pİ
 
cx


977 
pİ
 
bx


978 
»t


979 
š‹¼u±_b©ch_´oûss_İtimized
 
ENDP


981 ; 
Mšim®
 
š‹¼u±
 
b™
 
	$´oûssšg
 (
deãrs
 
h—vy
 
wÜk
)

982 
´oûss_š‹¼u±_b™_mšim®
 
PROC


983 ; 
Proûss
 
sšgË
 
š‹¼u±
 
b™
 
w™h
 
mšim®
 
ov”h—d


984 ; 
IÅut
: 
DL
 = 
b™
 
pos™iÚ


985 ; 
Deãrs
 
®l
 
h—vy
 
´oûssšg
 
to
 
DOS
 
idË
 
hªdËr


986 
push
 
ax


987 
push
 
bx


989 ; 
Ju¡
 
acknowËdge
 
the
 
š‹¼u±
 
cÚd™iÚ
 
š
 
h¬dw¬e


990 ; 
AÎ
 
aùu®
 
·ck‘
 
´oûssšg
 
is
 
deã¼ed


991 
cmp
 
dl
, 0 ; 
RX
 
Com¶‘e


992 
je
 .
ack_rx_mšim®


993 
cmp
 
dl
, 1 ; 
TX
 
Com¶‘e


994 
je
 .
ack_tx_mšim®


995 
jmp
 .
ack_g’”ic


997 .
ack_rx_mšim®
:

998 ; 
Mšim®
 
RX
 
acknowËdgm’t


999 
mov
 
bx
, 0

1000 
shl
 
bx
, 1

1001 
mov
 
ax
, [
hw_io_ba£s
 + 
bx
]

1002 
add
 
ax
, 0C
h
 ; 
RX_STATUS


1003 
mov
 
dx
, 
ax


1004 
š
 
ax
, 
dx
 ; 
R—d
 
to
 
acknowËdge


1005 
jmp
 .
ack_dÚe


1007 .
ack_tx_mšim®
:

1008 ; 
Mšim®
 
TX
 
acknowËdgm’t


1009 
mov
 
bx
, 0

1010 
shl
 
bx
, 1

1011 
mov
 
ax
, [
hw_io_ba£s
 + 
bx
]

1012 
add
 
ax
, 0A
h
 ; 
TX_STATUS


1013 
mov
 
dx
, 
ax


1014 
š
 
®
, 
dx
 ; 
R—d
 
to
 
acknowËdge


1015 
jmp
 .
ack_dÚe


1017 .
ack_g’”ic
:

1018 ; 
G’”ic
 
š‹¼u±
 
acknowËdgm’t


1019 
nİ
 ; 
PÏûhŞd”


1021 .
ack_dÚe
:

1022 
pİ
 
bx


1023 
pİ
 
ax


1024 
»t


1025 
´oûss_š‹¼u±_b™_mšim®
 
ENDP


1027 ; 
Cr™iÿl
 
”rÜ
 
	$hªdlšg
 (
mšim®
 
ISR
 
wÜk
)

1028 
acknowËdge_3c509b_ü™iÿl_”rÜ
 
PROC


1029 ; 
HªdË
 
ü™iÿl
 
”rÜs
 
w™h
 
mšim®
 
ISR
 
ov”h—d


1030 
push
 
ax


1031 
push
 
dx


1032 
push
 
bx


1034 ; 
G‘
 
I
/
O
 
ba£


1035 
mov
 
bx
, 0

1036 
shl
 
bx
, 1

1037 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
]

1039 ; 
CË¬
 
ad­‹r
 
çu»
 
b™


1040 
add
 
dx
, 0E
h
 ; 
Commªd
 

1041 
mov
 
ax
, (13 
shl
 11è
Ü
 0002
h
 ; 
AckIÁr
 | 
Ad­‹rFau»


1042 
out
 
dx
, 
ax


1044 
pİ
 
bx


1045 
pİ
 
dx


1046 
pİ
 
ax


1047 
»t


1048 
acknowËdge_3c509b_ü™iÿl_”rÜ
 
ENDP


1050 ; 
As£mbly
 
š‹rçû
 
³rfÜmªû
 
mÚ™Üšg


1051 
³rfÜmªû_mÚ™Ü_»cÜd_§m¶e_asm
 
PROC


1052 ; 
RecÜd
 
³rfÜmªû
 
§m¶e
 
äom
 
as£mbly
 
cÚ‹xt


1053 ; 
IÅut
: 
CL
 = 
š‹¼u±
 
ty³
, 
CH
 = 
b©ch
 
size


1054 
push
 
ax


1055 
push
 
bx


1056 
push
 
dx


1058 ; 
This
 
would
 
ÿÎ
 
C
 
³rfÜmªû
 
mÚ™Üšg
 
funùiÚ


1059 ; 
FÜ
 
now
, 
ju¡
 
upd©e
 
basic
 
couÁ”s


1060 
šc
 
dwÜd
 
±r
 [
tÙ®_š‹¼u±s
]

1061 
cmp
 
ch
, 1

1062 
jbe
 .
no_b©ch_»cÜded


1063 
šc
 
dwÜd
 
±r
 [
b©ched_š‹¼u±s
]

1065 .
no_b©ch_»cÜded
:

1066 
pİ
 
dx


1067 
pİ
 
bx


1068 
pİ
 
ax


1069 
»t


1070 
³rfÜmªû_mÚ™Ü_»cÜd_§m¶e_asm
 
ENDP


1072 ; 
Origš®
 
funùiÚ
 
k•t
 
com·tib™y


1073 
check_3c509b_š‹¼u±_sourû
 
PROC


1074 ; 
Quick
 
check
 
the
 3C509B 
aùu®ly
 
g’”©ed
 
this
 
š‹¼u±


1075 ; 
R‘uºs
: 
CY
 
ş—r
 
ours
, CY 
£t
 
nÙ
 ours

1076 ; 
R—d
 3C509B 
¡©us
 
ªd
 
check
 
IÁL©ch
 
b™


1077 
push
 
dx


1078 
push
 
ax


1080 ; 
G‘
 
I
/
O
 
ba£
 
add»ss
 
NIC
 0 (3C509B)

1081 
mov
 
dx
, [
hw_io_ba£s
] ; 
G‘
 
I
/
O
 
ba£
 
fœ¡
 
NIC


1082 
‹¡
 
dx
, dx ; 
Check
 
v®id


1083 
jz
 .
nÙ_ours
 ; 
No
 
I
/
O
 
ba£
 = 
nÙ
 
our
 
š‹¼u±


1085 ; 
R—d
 
¡©us
 (
Wšdow
-
šd•’d’t
, 
®ways
 
acûssibË
)

1086 
add
 
dx
, 0E
h
 ; 
Stus
 
off£t


1087 
š
 
ax
, 
dx
 ; 
R—d
 
	`¡©us
 (16-
b™
 3C509B)

1089 ; 
Check
 
IÁL©ch
 
	`b™
 (
b™
 0è- 
šdiÿ‹s
 
š‹¼u±
 
occu¼ed


1090 
‹¡
 
®
, 01
h
 ; 
Te¡
 
IÁL©ch
 
b™


1091 
jz
 .
nÙ_ours
 ; 
No
 
IÁL©ch
 = 
nÙ
 
our
 
š‹¼u±


1093 ; 
Add™iÚ®
 
v®id©iÚ
 - 
check
 
v®id
 
š‹¼u±
 
»asÚs


1094 ; 
	$IÁReq
 (
b™
 6è
should
 
®so
 
be
 
£t
 
a
 
»®
 
š‹¼u±


1095 
‹¡
 
®
, 40
h
 ; 
Te¡
 
IÁReq
 
b™


1096 
jz
 .
nÙ_ours
 ; 
No
 
IÁReq
 = 
¥urious


1098 ; 
This
 
is
 
our
 
š‹¼u±


1099 
pİ
 
ax


1100 
pİ
 
dx


1101 
şc
 ; 
CË¬
 
ÿ¼y
 = 
ours


1102 
»t


1104 .
nÙ_ours
:

1105 
pİ
 
ax


1106 
pİ
 
dx


1107 
¡c
 ; 
S‘
 
ÿ¼y
 = 
nÙ
 
ours


1108 
»t


1109 
check_3c509b_š‹¼u±_sourû
 
ENDP


1111 
acknowËdge_3c509b_š‹¼u±
 
PROC


1112 ; 
AcknowËdge
 
the
 3C509B 
h¬dw¬e
 
š‹¼u±
 
usšg
 
´İ”
 
commªd
 
£qu’û


1113 ; 
This
 
ş—rs
 
the
 
š‹¼u±
 
cÚd™iÚ
 
š
h
NIC


1114 
push
 
dx


1115 
push
 
ax


1117 ; 
G‘
 
I
/
O
 
ba£
 
add»ss
 
NIC
 0 (3C509B)

1118 
mov
 
dx
, [
hw_io_ba£s
] ; 
G‘
 
I
/
O
 
ba£
 
fœ¡
 
NIC


1119 
‹¡
 
dx
, dx ; 
Check
 
v®id


1120 
jz
 .
no_ack
 ; 
No
 
I
/
O
 
ba£
 = 
nÙhšg
 
to
 
ack


1122 ; 
R—d
 
cu¼’t
 
¡©us
 
to
 
£e
 
wh©
 
Ãeds
Ø
be
 
acknowËdged


1123 
add
 
dx
, 0E
h
 ; 
Stus
/
Commªd
 

1124 
š
 
ax
, 
dx
 ; 
R—d
 
cu¼’t
 
¡©us


1126 ; 
AcknowËdge
 
š‹¼u±
 
usšg
 
AckIÁr
 
	`commªd
 (13 << 11)

1127 ; 
N“d
 
to
 
acknowËdge
 
IÁReq
 | 
IÁL©ch
 
b™s
 
as
 
³r
 
Lšux
 
driv”


1128 ; 
From
 
Lšux
 
driv”
: 
	`outw
(
AckIÁr
 | 
IÁReq
 | 
IÁL©ch
, 
ißddr
 + 
EL3_CMD
)

1129 
mov
 
ax
, (13 
shl
 11è
Ü
 0041
h
 ; 
AckIÁr
 | 
IÁReq
 | 
IÁL©ch


1130 
out
 
dx
, 
ax
 ; 
S’d
 
acknowËdge
 
commªd


1132 .
no_ack
:

1133 
pİ
 
ax


1134 
pİ
 
dx


1135 
»t


1136 
acknowËdge_3c509b_š‹¼u±
 
ENDP


1138 
£nd_eoi_fÜ_3c509b
 
PROC


1139 ; 
S’d
 
End
-
Of
-
IÁ”ru±
 
to
 
the
 
­´İrŸ‹
 
PIC
 
ba£d
 
Ú
 
aùu®
 
IRQ
 
assignm’t


1140 ; 
This
 
fixes
 
the
 
ü™iÿl
 
g­
 
id’tif›d
 
š
 
deãnsive
 
´og¿mmšg
 
»v›w


1141 
push
 
ax


1142 
push
 
bx


1143 
push
 
dx


1145 ; 
G‘
 
the
 
aùu®
 
IRQ
 
numb”
 3C509B (
assumšg
 
™
's NIC 0)

1146 
mov
 
bl
, 
by‹
 
±r
 [
nic_œq_numb”s
] ; 
G‘
 
IRQ
 
NIC
 0

1147 
cmp
 
bl
, 
IRQ_NONE


1148 
je
 .
no_œq_assigÃd
 ; 
Sk
 
EOI
 
no
 
IRQ
 
assigÃd


1150 ; 
Check
 
this
 
is
 
a
 
¦ave
 
PIC
 
	`IRQ
 (8-15)

1151 
cmp
 
bl
, 8

1152 
jl
 .
ma¡”_pic_Úly
 ; 
IRQ
 0-7: 
ma¡”
 
PIC
 
Úly


1154 ; 
IRQ
 8-15: 
S’d
 
EOI
 
to
 
¦ave
 
PIC
 
fœ¡
, 
th’
 
ma¡”
 PIC

1155 ; 
This
 
is
 
the
 
cÜ»ù
 
£qu’û
 
¦ave
 
IRQs


1156 
mov
 
®
, 
PIC_EOI


1157 
mov
 
dx
, 
PIC2_COMMAND


1158 
out
 
dx
, 
®
 ; 
EOI
 
to
 
¦ave
 
PIC


1160 ; 
Now
 
£nd
 
EOI
 
to
 
ma¡”
 
PIC


1161 
mov
 
dx
, 
PIC1_COMMAND


1162 
out
 
dx
, 
®
 ; 
EOI
 
to
 
ma¡”
 
PIC


1163 
jmp
 .
eoi_com¶‘e


1165 .
ma¡”_pic_Úly
:

1166 ; 
IRQ
 0-7: 
S’d
 
EOI
 
to
 
ma¡”
 
PIC
 
Úly


1167 
mov
 
®
, 
PIC_EOI


1168 
mov
 
dx
, 
PIC1_COMMAND


1169 
out
 
dx
, 
®


1171 .
eoi_com¶‘e
:

1172 .
no_œq_assigÃd
:

1173 
pİ
 
dx


1174 
pİ
 
bx


1175 
pİ
 
ax


1176 
»t


1177 
£nd_eoi_fÜ_3c509b
 
ENDP


1179 
´oûss_3c509b_·ck‘s_immedŸ‹
 
PROC


1180 ; 
Em”g’cy
 
·ck‘
 
´oûssšg
 
wh’
 
deã¼ed
 
queue
 
is
 
fuÎ


1181 ; 
This
 
is
 
ÿÎed
 
dœeùly
 
äom
 
ISR
 
wh’
 
we
 
ÿn
't deferhe work

1182 
push
 
ax


1183 
push
 
bx


1184 
push
 
cx


1186 ; 
C®l
 
the
 
Üigš®
 
h¬dw¬e
 
hªdËr
 
as
 
çÎback


1187 
ÿÎ
 
h¬dw¬e_hªdË_3c509b_œq


1189 
pİ
 
cx


1190 
pİ
 
bx


1191 
pİ
 
ax


1192 
»t


1193 
´oûss_3c509b_·ck‘s_immedŸ‹
 
ENDP


1196 ; 
Deã¼ed
 
wÜk
 
	`funùiÚs
 (
ÿÎed
 
äom
 
DOS
 
idË
 
cÚ‹xt
)

1199 
PUBLIC
 
´oûss_3c509b_·ck‘s


1200 
´oûss_3c509b_·ck‘s
 
PROC


1201 ; 
This
 
funùiÚ
 
is
 
ÿÎed
 
äom
 
the
 
INT
 28
h
 
hªdËr
 
wh’
 
DOS
 i 
idË


1202 ; 
It
 
ÿn
 
§ãly
 
ÿÎ
 
DOS
 
funùiÚs
 
ªd
 dØ
h—vy
 
´oûssšg


1203 
push
 
ax


1204 
push
 
bx


1205 
push
 
cx


1206 
push
 
dx


1207 
push
 
si


1208 
push
 
di


1209 
push
 
ds


1210 
push
 
es


1212 ; 
S‘
 
up
 
our
 
d©a
 
£gm’t


1213 
mov
 
ax
, 
_DATA


1214 
mov
 
ds
, 
ax


1215 
ASSUME
 
DS
:
_DATA


1217 ; 
Proûss
 3C509B 
·ck‘s
 
w™h
 
fuÎ
 
funùiÚ®™y


1218 ; 
C®Ëd
 
äom
 
DOS
 
idË
 
cÚ‹xt
 - 
§ã
 
to
 dØ
h—vy
 
´oûssšg


1219 
push
 
ax


1220 
push
 
bx


1221 
push
 
cx


1222 
push
 
dx


1224 ; 
Check
 
h¬dw¬e
 
has
 
·ck‘s
 
to
 
´oûss


1225 
mov
 
dx
, 300
h
 ; 3C509B 
ba£
 
I
/
O
 
add»ss


1226 
add
 
dx
, 08
h
 ; 
RX_STATUS
 

1227 
š
 
ax
, 
dx
 ; 
R—d
 
RX
 
¡©us


1228 
‹¡
 
ax
, 8000
h
 ; 
RX_INCOMPLETE
 
b™


1229 
jnz
 .
no_·ck‘s
 ; 
No
 
com¶‘e
 
·ck‘s


1231 ; 
Proûss
 
up
 
to
 10 
·ck‘s
 
³r
 
	$ÿÎ
 (
š‹¼u±
 
b©chšg
)

1232 
mov
 
cx
, 10 ; 
Maximum
 
·ck‘s
 
to
 
´oûss


1234 .
·ck‘_loİ
:

1235 ; 
Check
 
·ck‘
 
is
 
avaabË


1236 
š
 
ax
, 
dx
 ; 
Re
-
»ad
 
RX
 
¡©us


1237 
‹¡
 
ax
, 8000
h
 ; 
Check
 
RX_INCOMPLETE


1238 
jnz
 .
·ck‘s_dÚe
 ; 
No
 
mÜe
 
·ck‘s


1240 ; 
G‘
 
·ck‘
 
size


1241 
ªd
 
ax
, 07FF
h
 ; 
Mask
 
to
 
g‘
 
·ck‘
 
size


1242 
cmp
 
ax
, 60 ; 
Mšimum
 
Eth”Ãt
 
äame
 
size


1243 
jb
 .
sk_·ck‘
 ; 
Inv®id
 
·ck‘
 
size


1244 
cmp
 
ax
, 1514 ; 
Maximum
 
Eth”Ãt
 
äame
 
size


1245 
ja
 .
sk_·ck‘
 ; 
Inv®id
 
·ck‘
 
size


1247 ; 
R—d
 
·ck‘
 
d©a
 
äom
 
FIFO


1248 
push
 
cx


1249 
push
 
ax
 ; 
Save
 
·ck‘
 
size


1251 ; 
AÎoÿ‹
 
bufãr
 
	`·ck‘
 (
sim¶if›d
 - 
should
 
u£
 bufã¸
poŞ
)

1252 ; 
FÜ
 
now
, 
assume
 
we
 
have
 
a
 
»ûive
 
bufãr


1253 
mov
 
bx
, 
OFFSET
 
‹mp_rx_bufãr


1255 ; 
R—d
 
·ck‘
 
äom
 3C509B 
FIFO


1256 
sub
 
dx
, 08
h
 ; 
Back
 
to
 
ba£
 
add»ss


1257 
add
 
dx
, 00
h
 ; 
DATA_REGISTER


1259 
pİ
 
cx
 ; 
Re¡Üe
 
·ck‘
 
size
 
to
 
CX


1260 
shr
 
cx
, 1 ; 
CÚv”t
 
by‹s
 
to
 
wÜds


1262 .
»ad_loİ
:

1263 
š
 
ax
, 
dx
 ; 
R—d
 
wÜd
 
äom
 
FIFO


1264 
mov
 [
bx
], 
ax
 ; 
StÜe
 
š
 
bufãr


1265 
add
 
bx
, 2 ; 
Advªû
 
bufãr
 
poš‹r


1266 
loİ
 .
»ad_loİ
 ; 
CÚtšue
 
»adšg


1268 ; 
HªdË
 
odd
 
by‹
 
·ck‘
 
size
 
was
 odd

1269 
pİ
 
ax
 ; 
Re¡Üe
 
Üigš®
 
·ck‘
 
size


1270 
‹¡
 
ax
, 1 ; 
Check
 
odd
 
size


1271 
jz
 .
ev’_size


1273 
š
 
ax
, 
dx
 ; 
R—d
 
fš®
 
wÜd


1274 
mov
 [
bx
], 
®
 ; 
StÜe
 
Úly
 
the
 
by‹
 
we
 
Ãed


1276 .
ev’_size
:

1277 ; 
C®l
 
·ck‘
 
»ûive
 
hªdËr


1278 
push
 
cx


1279 
mov
 
ax
, 0 ; 
NIC
 
	$šdex
 (3C509B = 0)

1280 
mov
 
bx
, 
OFFSET
 
‹mp_rx_bufãr
 ; 
Pack‘
 
bufãr


1281 
ÿÎ
 
·ck‘_İs_»ûive
 ; 
Proûss
 
the
 
·ck‘


1282 
pİ
 
cx


1284 ; 
Upd©e
 
¡©i¡ics


1285 
šc
 
wÜd
 
±r
 [
œq_couÁ
] ; 
Inüem’t
 
·ck‘
 
couÁ


1287 
pİ
 
cx
 ; 
Re¡Üe
 
loİ
 
couÁ”


1288 
dec
 
cx
 ; 
Deüem’t
 
»maššg
 
couÁ


1289 
jnz
 .
·ck‘_loİ
 ; 
Proûss
 
Ãxt
 
·ck‘


1291 
jmp
 .
·ck‘s_dÚe


1293 .
sk_·ck‘
:

1294 ; 
Sk
 
m®fÜmed
 
·ck‘
 
by
 
»adšg
 
ªd
 
disÿrdšg


1295 
sub
 
dx
, 08
h
 ; 
Back
 
to
 
ba£


1296 
add
 
dx
, 0C
h
 ; 
COMMAND
 

1297 
mov
 
ax
, 4000
h
 ; 
RX_DISCARD
 
commªd


1298 
out
 
dx
, 
ax
 ; 
Disÿrd
 
cu¼’t
 
·ck‘


1300 ; 
CÚtšue
 
w™h
 
Ãxt
 
·ck‘


1301 
add
 
dx
, 4 ; 
Back
 
to
 
RX_STATUS


1302 
loİ
 .
·ck‘_loİ


1304 .
·ck‘s_dÚe
:

1305 .
no_·ck‘s
:

1306 
pİ
 
dx


1307 
pİ
 
cx


1308 
pİ
 
bx


1309 
pİ
 
ax


1311 
pİ
 
es


1312 
pİ
 
ds


1313 
pİ
 
di


1314 
pİ
 
si


1315 
pİ
 
dx


1316 
pİ
 
cx


1317 
pİ
 
bx


1318 
pİ
 
ax


1319 
»t


1320 
´oûss_3c509b_·ck‘s
 
ENDP


1323 ; 
nic_œq_hªdËr_3c515
 - 
IÁ”ru±
 
hªdËr
 3C515-
TX
 
NIC


1324 ; 
This
 
is
 
the
 
aùu®
 
IRQ
 
hªdËr
 
š¡®Ëd
 
š
h
š‹¼u±
 
veùÜ


1326 ; 
IÅut
: 
	`NÚe
 (
š‹¼u±
 
cÚ‹xt
)

1327 ; 
Ouut
: 
NÚe


1328 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
§ved
/
»¡Üed
)

1330 
nic_œq_hªdËr_3c515
 
PROC


1331 ; ==ğ
DEFENSIVE
 
ISR
 
PROLOG
 ===

1332 ; 
Save
 
mšim®
 
»gi¡”s
 
fœ¡


1333 
push
 
ax


1334 
push
 
ds


1336 ; 
S‘
 
up
 
our
 
d©a
 
£gm’t


1337 
mov
 
ax
, 
_DATA


1338 
mov
 
ds
, 
ax


1339 
ASSUME
 
DS
:
_DATA


1341 ; 
Sw™ch
 
to
 
´iv©e
 
¡ack
 
usšg
 
deãnsive
 
maüo


1342 
mov
 
ax
, 
_DATA
 ; 
S‘
 
up
 
d©a
 
£gm’t
 
fœ¡


1343 
SAFE_STACK_SWITCH_3C515


1345 ; 
Now
 
§ve
 
®l
 
»gi¡”s
 
Ú
 
our
 
§ã
 
¡ack


1346 
pusha


1347 
push
 
es


1348 
push
 
ds


1350 ; ==ğ
MINIMAL
 
ISR
 
WORK
 
ONLY
 ===

1351 ; 
Quick
 
h¬dw¬e
 
check
 - 
is
 
this
 
š‹¼u±
 
»®ly
 
ours
?

1352 
ÿÎ
 
check_3c515_š‹¼u±_sourû


1353 
jc
 .
nÙ_our_š‹¼u±


1355 ; 
Proûss
 
š‹¼u±s
 
w™h
 
DMA
-
aw¬e
 
	`b©chšg
 (
max
 10 
ev’ts
 
³r
 
š‹¼u±
)

1356 ; 3C515-
TX
 
has
 
mÜe
 
com¶ex
 
š‹¼u±
 
hªdlšg
 
due
 
to
 
DMA
 
ÿ·b™›s


1357 
ÿÎ
 
nic_´oûss_š‹¼u±_b©ch_3c515


1359 ; 
S’d
 
EOI
 
to
 
PIC
 
aá”
 
´oûssšg
 
b©ch


1360 
ÿÎ
 
£nd_eoi_fÜ_3c515


1362 ; 
Inüem’t
 
š‹¼u±
 
couÁ”
 
dŸgno¡ics


1363 
šc
 
wÜd
 
±r
 [
œq_couÁ
+2] ; 
NIC
 1 
couÁ”


1365 ; ==ğ
DEFER
 
HEAVY
 
WORK
 ===

1366 ; 
Always
 
queue
 
deã¼ed
 
wÜk
 
com´eh’sive
 
DMA
 
ªd
 
·ck‘
 
´oûssšg


1367 ; 
The
 
b©chšg
 
above
 
hªdËs
 
immedŸ‹
 
š‹¼u±
 
acknowËdgm’t


1368 
mov
 
ax
, [
deã¼ed_3c515_wÜk
] ; 
FunùiÚ
 
to
 
ÿÎ
 
Ï‹r


1369 
ÿÎ
 
queue_deã¼ed_wÜk


1370 
jc
 .
queue_fuÎ
 ; 
HªdË
 
queue
 
ov”æow


1372 
jmp
 .
i¤_ex™


1374 .
nÙ_our_š‹¼u±
:

1375 ; 
This
 
š‹¼u±
 
wa¢
'ˆour - dÚ'
t
 
£nd
 
EOI


1376 
šc
 
wÜd
 
±r
 [
¥urious_œq_couÁ
]

1377 
jmp
 .
i¤_ex™


1379 .
queue_fuÎ
:

1380 ; 
WÜk
 
queue
 
is
 
fuÎ
 - 
´oûss
 
	`immedŸ‹ly
 (
nÙ
 
id—l
 
but
 
Ãûs§ry
)

1381 ; 
This
 
is
 
our
 
çÎback
 
wh’
 
deã¼ed
 
´oûssšg
 
çs


1382 
ÿÎ
 
´oûss_3c515_·ck‘s_immedŸ‹


1384 .
i¤_ex™
:

1385 ; ==ğ
DEFENSIVE
 
ISR
 
EPILOG
 ===

1386 ; 
Re¡Üe
 
®l
 
»gi¡”s


1387 
pİ
 
ds


1388 
pİ
 
es


1389 
pİa


1391 ; 
Re¡Üe
 
ÿÎ”
's stack using defensive macro

1392 
RESTORE_CALLER_STACK_IRQ


1394 ; 
Re¡Üe
 
mšim®
 
»gi¡”s


1395 
pİ
 
ds


1396 
pİ
 
ax


1398 
œ‘


1399 
nic_œq_hªdËr_3c515
 
ENDP


1402 ; 
SuµÜt
 
funùiÚs
 
’hªûd
 3C515 
š‹¼u±
 
hªdlšg


1405 
check_3c515_š‹¼u±_sourû
 
PROC


1406 ; 
Quick
 
check
 
the
 3C515 
aùu®ly
 
g’”©ed
 
this
 
š‹¼u±


1407 ; 
R‘uºs
: 
CY
 
ş—r
 
ours
, CY 
£t
 
nÙ
 ours

1408 
push
 
ax


1409 
push
 
bx


1410 
push
 
dx


1412 ; 
G‘
 
the
 
I
/
O
 
ba£
 3C515 (
assumšg
 
NIC
 1)

1413 
mov
 
bx
, 1

1414 
shl
 
bx
, 1 ; 
WÜd
 
off£t


1415 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
] ; 
G‘
 
I
/
O
 
ba£


1416 
‹¡
 
dx
, dx

1417 
jz
 .
nÙ_ours
 ; 
No
 
I
/
O
 
ba£
 = 
nÙ
 
ours


1419 ; 
R—d
 
¡©us
 (
§me
 
as
 
commªd
 
add»ss
)

1420 
add
 
dx
, 0E
h
 ; 
Stus
/
Commªd
 

1421 
š
 
ax
, 
dx


1423 ; 
Check
 
ªy
 
š‹¼u±
 
¡©us
 
b™s
 
šşudšg
 
DMA


1424 ; 
IÁ”ru±
 
	$Ïtch
 (
b™
 0)

1425 
‹¡
 
ax
, 0001
h
 ; 
INT_LATCH


1426 
jnz
 .
our_š‹¼u±


1428 ; 
Check
 
¡ªd¬d
 
š‹¼u±
 
b™s


1429 
‹¡
 
ax
, 0004
h
 ; 
TX_COMPLETE


1430 
jnz
 .
our_š‹¼u±


1431 
‹¡
 
ax
, 0010
h
 ; 
RX_COMPLETE


1432 
jnz
 .
our_š‹¼u±


1433 
‹¡
 
ax
, 0002
h
 ; 
ADAPTER_FAILURE


1434 
jnz
 .
our_š‹¼u±


1435 
‹¡
 
ax
, 0080
h
 ; 
STATS_FULL


1436 
jnz
 .
our_š‹¼u±


1438 ; 
Check
 
DMA
-
¥ecific
 
¡©us
 
	$b™s
 (3C515 
¥ecŸl
 
ã©u»s
)

1439 
‹¡
 
ax
, 0100
h
 ; 
	$DMA_DONE
 (
b™
 8)

1440 
jnz
 .
our_š‹¼u±


1441 
‹¡
 
ax
, 0200
h
 ; 
	$DOWN_COMPLETE
 (
TX
 
DMA
, 
b™
 9)

1442 
jnz
 .
our_š‹¼u±


1443 
‹¡
 
ax
, 0400
h
 ; 
	$UP_COMPLETE
 (
RX
 
DMA
, 
b™
 10)

1444 
jnz
 .
our_š‹¼u±


1446 ; 
Check
 
š‹¼u±
 
»que¡
 
b™


1447 
‹¡
 
ax
, 0040
h
 ; 
INT_REQ


1448 
jnz
 .
our_š‹¼u±


1450 .
nÙ_ours
:

1451 ; 
NÙ
 
our
 
š‹¼u±


1452 
¡c
 ; 
S‘
 
ÿ¼y
 = 
nÙ
 
ours


1453 
jmp
 .
ex™


1455 .
our_š‹¼u±
:

1456 ; 
This
 
is
 
our
 
š‹¼u±


1457 
şc
 ; 
CË¬
 
ÿ¼y
 = 
ours


1459 .
ex™
:

1460 
pİ
 
dx


1461 
pİ
 
bx


1462 
pİ
 
ax


1463 
»t


1464 
check_3c515_š‹¼u±_sourû
 
ENDP


1466 .
check_dma
:

1467 ; 
Check
 
DMA
 
¡©us
 DMA 
com¶‘iÚ
 
š‹¼u±s


1468 ; 
This
 
is
 
¥ecific
 
to
 3C515-
TX
 
bus
 
ma¡”šg
 
ÿ·b™y


1469 
sub
 
dx
, 08
h
 ; 
Back
 
to
 
ba£


1470 
add
 
dx
, 20
h
 ; 
DMA_STATUS
 

1471 
š
 
®
, 
dx
 ; 
R—d
 
DMA
 
¡©us


1472 
‹¡
 
®
, 03
h
 ; 
DMA
 
com¶‘iÚ
 
b™s


1473 
jnz
 .
is_ours
 ; 
DMA
 
š‹¼u±
 
is
 
ours


1475 ; 
NÙ
 
our
 
š‹¼u±


1476 
¡c


1477 
jmp
 .
v®id©ed_3c515


1479 .
is_ours
:

1480 
şc
 ; 
CË¬
 
ÿ¼y
 = 
our
 
š‹¼u±


1482 .
v®id©ed_3c515
:

1483 
pİ
 
cx


1484 
pİ
 
bx


1485 
pİ
 
dx


1486 
»t


1487 
check_3c515_š‹¼u±_sourû
 
ENDP


1489 
acknowËdge_3c515_š‹¼u±
 
PROC


1490 ; 
AcknowËdge
 
the
 3C515 
h¬dw¬e
 
š‹¼u±
 
w™h
 
DMA
 
hªdlšg


1491 ; 
This
 
ş—rs
 
the
 
š‹¼u±
 
cÚd™iÚ
 
š
h
NIC


1492 
push
 
ax


1493 
push
 
bx


1494 
push
 
dx


1495 
push
 
cx


1497 ; 
G‘
 
the
 
I
/
O
 
ba£
 3C515 (
assumšg
 
NIC
 1)

1498 
mov
 
bx
, 1

1499 
shl
 
bx
, 1 ; 
WÜd
 
off£t


1500 
mov
 
dx
, [
hw_io_ba£s
 + 
bx
] ; 
G‘
 
I
/
O
 
ba£


1501 
‹¡
 
dx
, dx

1502 
jz
 .
no_ack_Ãeded
 ; 
No
 
I
/
O
 
ba£
 = 
nÙhšg
 
to
 
ack


1504 ; 
R—d
 
cu¼’t
 
¡©us
 
to
 
£e
 
wh©
 
Ãeds
 
acknowËdgšg


1505 
push
 
dx


1506 
add
 
dx
, 0E
h
 ; 
Stus
 

1507 
š
 
ax
, 
dx


1508 
mov
 
cx
, 
ax
 ; 
Save
 
¡©us
 
ACK


1509 
pİ
 
dx


1511 ; 
AcknowËdge
 
š‹¼u±
 
usšg
 
ACK_INTR
 
commªd


1512 ; 
Bud
 
acknowËdgm’t
 
mask
 
ba£d
 
Ú
 
aùive
 
š‹¼u±
 
sourûs


1513 
mov
 
ax
, 0 ; 
S¹
 
w™h
 
no
 
ACK
 
b™s


1515 ; 
Check
 
ªd
 
acknowËdge
 
¡ªd¬d
 
š‹¼u±s


1516 
‹¡
 
cx
, 0004
h
 ; 
TX_COMPLETE


1517 
jz
 .
no_tx_com¶‘e


1518 
Ü
 
ax
, 0004
h
 ; 
Add
 
TX_COMPLETE
 
to
 
ACK


1519 .
no_tx_com¶‘e
:

1521 
‹¡
 
cx
, 0010
h
 ; 
RX_COMPLETE


1522 
jz
 .
no_rx_com¶‘e


1523 
Ü
 
ax
, 0010
h
 ; 
Add
 
RX_COMPLETE
 
to
 
ACK


1524 .
no_rx_com¶‘e
:

1526 
‹¡
 
cx
, 0002
h
 ; 
ADAPTER_FAILURE


1527 
jz
 .
no_ad­‹r_çu»


1528 
Ü
 
ax
, 0002
h
 ; 
Add
 
ADAPTER_FAILURE
 
to
 
ACK


1529 .
no_ad­‹r_çu»
:

1531 
‹¡
 
cx
, 0080
h
 ; 
STATS_FULL


1532 
jz
 .
no_¡©s_fuÎ


1533 
Ü
 
ax
, 0080
h
 ; 
Add
 
STATS_FULL
 
to
 
ACK


1534 .
no_¡©s_fuÎ
:

1536 ; 
Check
 
ªd
 
acknowËdge
 
DMA
 
	`š‹¼u±s
 (3C515-
TX
 
¥ecific
)

1537 
‹¡
 
cx
, 0100
h
 ; 
DMA_DONE


1538 
jz
 .
no_dma_dÚe


1539 
Ü
 
ax
, 0100
h
 ; 
Add
 
DMA_DONE
 
to
 
ACK


1540 .
no_dma_dÚe
:

1542 
‹¡
 
cx
, 0200
h
 ; 
	$DOWN_COMPLETE
 (
TX
 
DMA
)

1543 
jz
 .
no_down_com¶‘e


1544 
Ü
 
ax
, 0200
h
 ; 
Add
 
DOWN_COMPLETE
 
to
 
ACK


1545 .
no_down_com¶‘e
:

1547 
‹¡
 
cx
, 0400
h
 ; 
	$UP_COMPLETE
 (
RX
 
DMA
)

1548 
jz
 .
no_up_com¶‘e


1549 
Ü
 
ax
, 0400
h
 ; 
Add
 
UP_COMPLETE
 
to
 
ACK


1550 .
no_up_com¶‘e
:

1552 ; 
S’d
 
acknowËdgm’t
 
commªd
 
we
 
have
 
b™s
 
to
 
acknowËdge


1553 
‹¡
 
ax
,‡x

1554 
jz
 .
no_ack_Ãeded
 ; 
NÙhšg
 
to
 
acknowËdge


1556 ; 
U£
 
ACK_INTR
 
	`commªd
 (13 << 11è
w™h
 
š‹¼u±
 
b™s


1557 
push
 
dx


1558 
add
 
dx
, 0E
h
 ; 
Commªd
 

1559 
Ü
 
ax
, (13 << 11è; 
ACK_INTR
 
commªd


1560 
out
 
dx
, 
ax
 ; 
S’d
 
acknowËdgm’t


1561 
pİ
 
dx


1563 ; 
FÜ
 
DMA
 
š‹¼u±s
, 
we
 
may
 
Ãed
 
add™iÚ®
 
hªdlšg


1564 
‹¡
 
cx
, 0700
h
 ; 
Any
 
DMA
 
	$b™s
 (8, 9, 10)

1565 
jz
 .
no_dma_hªdlšg


1567 ; 
Add™iÚ®
 
DMA
 
ş—nup
 
Ãeded


1568 ; 
S–eù
 
wšdow
 7 
DMA
 
cÚŒŞ


1569 
push
 
dx


1570 
add
 
dx
, 0E
h
 ; 
Commªd
 

1571 
mov
 
ax
, (1 << 11è| 7 ; 
S–eù
 
wšdow
 7

1572 
out
 
dx
, 
ax


1573 
pİ
 
dx


1575 ; 
R—d
 
DMA
 
¡©us
 
ªd
 
ş—r
 
ªy
 
³ndšg
 DMA 
İ”©iÚs


1576 ; 
CËª
 
up
 
DMA
 
desütÜs
 
ªd
 
ä“
 
bufãrs


1577 
push
 
si


1578 
push
 
di


1579 
push
 
ax


1581 ; 
Stİ
 
DMA
 
’gše


1582 
add
 
dx
, 0x400 ; 
Wšdow
 7 
DMA
 
cÚŒŞ
 
ba£


1583 
mov
 
ax
, 0x5000 ; 
CMD_DOWN_STALL


1584 
out
 
dx
, 
ax


1585 
ÿÎ
 
io_d–ay


1587 ; 
CË¬
 
desütÜ
 
poš‹rs


1588 
add
 
dx
, 4 ; 
Down
 
li¡
 
poš‹r
 

1589 
xÜ
 
ax
,‡x

1590 
out
 
dx
, 
ax
 ; 
CË¬
 
low
 
wÜd


1591 
add
 
dx
, 2

1592 
out
 
dx
, 
ax
 ; 
CË¬
 
high
 
wÜd


1594 ; 
F»e
 
ªy
 
³ndšg
 
DMA
 
bufãrs


1595 
ÿÎ
 
ä“_dma_bufãrs


1597 ; 
Re
-
’abË
 
DMA
 
Ãeded


1598 
sub
 
dx
, 6 ; 
Back
 
to
 
cÚŒŞ
 

1599 
mov
 
ax
, 0x5002 ; 
CMD_DOWN_UNSTALL


1600 
out
 
dx
, 
ax


1602 
pİ
 
ax


1603 
pİ
 
di


1604 
pİ
 
si


1606 ; 
R‘uº
 
to
 
wšdow
 1 
nÜm®
 
İ”©iÚ


1607 
push
 
dx


1608 
add
 
dx
, 0E
h
 ; 
Commªd
 

1609 
mov
 
ax
, (1 << 11è| 1 ; 
S–eù
 
wšdow
 1

1610 
out
 
dx
, 
ax


1611 
pİ
 
dx


1613 .
no_dma_hªdlšg
:

1614 .
no_ack_Ãeded
:

1615 
pİ
 
cx


1616 
pİ
 
dx


1617 
pİ
 
bx


1618 
pİ
 
ax


1619 
»t


1620 
acknowËdge_3c515_š‹¼u±
 
ENDP


1622 
£nd_eoi_fÜ_3c515
 
PROC


1623 ; 
S’d
 
End
-
Of
-
IÁ”ru±
 
to
 
the
 
­´İrŸ‹
 
PIC
 
ba£d
 
Ú
 
aùu®
 
IRQ
 
assignm’t


1624 ; 
This
 
fixes
 
the
 
ü™iÿl
 
g­
 
id’tif›d
 
š
 
deãnsive
 
´og¿mmšg
 
»v›w


1625 
push
 
ax


1626 
push
 
bx


1627 
push
 
dx


1629 ; 
G‘
 
the
 
aùu®
 
IRQ
 
numb”
 3C515 (
assumšg
 
™
's NIC 1)

1630 
mov
 
bl
, 
by‹
 
±r
 [
nic_œq_numb”s
+1] ; 
G‘
 
IRQ
 
NIC
 1

1631 
cmp
 
bl
, 
IRQ_NONE


1632 
je
 .
no_œq_assigÃd
 ; 
Sk
 
EOI
 
no
 
IRQ
 
assigÃd


1634 ; 
Check
 
this
 
is
 
a
 
¦ave
 
PIC
 
	`IRQ
 (8-15)

1635 
cmp
 
bl
, 8

1636 
jl
 .
ma¡”_pic_Úly
 ; 
IRQ
 0-7: 
ma¡”
 
PIC
 
Úly


1638 ; 
IRQ
 8-15: 
S’d
 
EOI
 
to
 
¦ave
 
PIC
 
fœ¡
, 
th’
 
ma¡”
 PIC

1639 ; 
This
 
is
 
the
 
cÜ»ù
 
£qu’û
 
¦ave
 
IRQs


1640 
mov
 
®
, 
PIC_EOI


1641 
mov
 
dx
, 
PIC2_COMMAND


1642 
out
 
dx
, 
®
 ; 
EOI
 
to
 
¦ave
 
PIC


1644 ; 
Now
 
£nd
 
EOI
 
to
 
ma¡”
 
PIC


1645 
mov
 
dx
, 
PIC1_COMMAND


1646 
out
 
dx
, 
®
 ; 
EOI
 
to
 
ma¡”
 
PIC


1647 
jmp
 .
eoi_com¶‘e


1649 .
ma¡”_pic_Úly
:

1650 ; 
IRQ
 0-7: 
S’d
 
EOI
 
to
 
ma¡”
 
PIC
 
Úly


1651 
mov
 
®
, 
PIC_EOI


1652 
mov
 
dx
, 
PIC1_COMMAND


1653 
out
 
dx
, 
®


1655 .
eoi_com¶‘e
:

1656 .
no_œq_assigÃd
:

1657 
pİ
 
dx


1658 
pİ
 
bx


1659 
pİ
 
ax


1660 
»t


1661 
£nd_eoi_fÜ_3c515
 
ENDP


1663 
´oûss_3c515_·ck‘s_immedŸ‹
 
PROC


1664 ; 
Em”g’cy
 
·ck‘
 
´oûssšg
 
wh’
 
deã¼ed
 
queue
 
is
 
fuÎ


1665 ; 
This
 
is
 
ÿÎed
 
dœeùly
 
äom
 
ISR
 
wh’
 
we
 
ÿn
't deferhe work

1666 
push
 
ax


1667 
push
 
bx


1668 
push
 
cx


1670 ; 
C®l
 
the
 
Üigš®
 
h¬dw¬e
 
hªdËr
 
as
 
çÎback


1671 
ÿÎ
 
h¬dw¬e_hªdË_3c515_œq


1673 
pİ
 
cx


1674 
pİ
 
bx


1675 
pİ
 
ax


1676 
»t


1677 
´oûss_3c515_·ck‘s_immedŸ‹
 
ENDP


1679 
PUBLIC
 
´oûss_3c515_·ck‘s


1680 
´oûss_3c515_·ck‘s
 
PROC


1681 ; 
This
 
funùiÚ
 
is
 
ÿÎed
 
äom
 
the
 
INT
 28
h
 
hªdËr
 
wh’
 
DOS
 i 
idË


1682 ; 
It
 
ÿn
 
§ãly
 
ÿÎ
 
DOS
 
funùiÚs
 
ªd
 dØ
h—vy
 
´oûssšg


1683 
push
 
ax


1684 
push
 
bx


1685 
push
 
cx


1686 
push
 
dx


1687 
push
 
si


1688 
push
 
di


1689 
push
 
ds


1690 
push
 
es


1692 ; 
S‘
 
up
 
our
 
d©a
 
£gm’t


1693 
mov
 
ax
, 
_DATA


1694 
mov
 
ds
, 
ax


1695 
ASSUME
 
DS
:
_DATA


1697 ; 
Proûss
 3C515-
TX
 
·ck‘s
 
w™h
 
DMA
 
hªdlšg


1698 ; 
C®Ëd
 
äom
 
DOS
 
idË
 
cÚ‹xt
 - 
§ã
 
to
 dØ
h—vy
 
´oûssšg


1699 
push
 
ax


1700 
push
 
bx


1701 
push
 
cx


1702 
push
 
dx


1704 ; 
S–eù
 
­´İrŸ‹
 
wšdow
 3C515-
TX


1705 
mov
 
dx
, 320
h
 ; 3C515-
TX
 
ba£
 
I
/
O
 
add»ss


1706 
add
 
dx
, 0E
h
 ; 
Commªd
 

1707 
mov
 
ax
, 7000
h
 ; 
S–eù
 
Wšdow
 7 (
DŸgno¡ics
)

1708 
out
 
dx
, 
ax


1710 ; 
Check
 
DMA
 
¡©us
 
com¶‘ed
 
Œªsãrs


1711 
sub
 
dx
, 0E
h
 ; 
Back
 
to
 
ba£


1712 
add
 
dx
, 20
h
 ; 
DMA_STATUS
 

1713 
š
 
®
, 
dx
 ; 
R—d
 
DMA
 
¡©us


1715 ; 
Proûss
 
RX
 
DMA
 
com¶‘iÚs


1716 
‹¡
 
®
, 01
h
 ; 
RX_DMA_COMPLETE


1717 
jz
 .
check_tx_dma


1719 ; 
Proûss
 
»ûived
 
·ck‘s
 
äom
 
DMA
 
ršg


1720 
ÿÎ
 
´oûss_3c515_rx_dma_ršg


1722 .
check_tx_dma
:

1723 
‹¡
 
®
, 02
h
 ; 
TX_DMA_COMPLETE


1724 
jz
 .
check_fifo_·ck‘s


1726 ; 
Proûss
 
Œªsm™‹d
 
·ck‘
 
com¶‘iÚs


1727 
ÿÎ
 
´oûss_3c515_tx_com¶‘iÚs


1729 .
check_fifo_·ck‘s
:

1730 ; 
Also
 
check
 
nÚ
-
DMA
 
	$·ck‘s
 (
FIFO
 
mode
)

1731 
sub
 
dx
, 20
h
 ; 
Back
 
to
 
ba£


1732 
add
 
dx
, 0E
h
 ; 
Commªd
 

1733 
mov
 
ax
, 1000
h
 ; 
S–eù
 
Wšdow
 1 (
O³¿tšg
)

1734 
out
 
dx
, 
ax


1736 ; 
Check
 
RX
 
¡©us
 
š
 
İ”©šg
 
wšdow


1737 
sub
 
dx
, 0E
h
 ; 
Back
 
to
 
ba£


1738 
add
 
dx
, 08
h
 ; 
RX_STATUS
 

1739 
š
 
ax
, 
dx
 ; 
R—d
 
RX
 
¡©us


1741 ; 
Proûss
 
up
 
to
 10 
·ck‘s
 
³r
 
	$ÿÎ
 (
š‹¼u±
 
b©chšg
)

1742 
mov
 
cx
, 10 ; 
Maximum
 
·ck‘s
 
to
 
´oûss


1744 .
fifo_·ck‘_loİ
:

1745 
‹¡
 
ax
, 8000
h
 ; 
Check
 
RX_INCOMPLETE


1746 
jnz
 .
fifo_dÚe
 ; 
No
 
mÜe
 
FIFO
 
·ck‘s


1748 ; 
G‘
 
·ck‘
 
size
 
äom
 
¡©us


1749 
ªd
 
ax
, 1FFF
h
 ; 
Mask
 
to
 
g‘
 
·ck‘
 
size


1750 
cmp
 
ax
, 60 ; 
Mšimum
 
äame
 
size


1751 
jb
 .
sk_fifo_·ck‘


1752 
cmp
 
ax
, 1514 ; 
Maximum
 
äame
 
size


1753 
ja
 .
sk_fifo_·ck‘


1755 ; 
R—d
 
·ck‘
 
äom
 
	`FIFO
 (
sim¬
 
to
 3C509B 
but
 
w™h
 3C515-
TX
 
¥ecifics
)

1756 
push
 
cx


1757 
push
 
ax
 ; 
Save
 
·ck‘
 
size


1759 ; 
U£
 32-
b™
 
Œªsãrs
 
	`avaabË
 (3C515-
TX
 
suµÜts
 
this
)

1760 
mov
 
bx
, 
OFFSET
 
‹mp_rx_bufãr


1761 
sub
 
dx
, 08
h
 ; 
Back
 
to
 
ba£


1762 
add
 
dx
, 00
h
 ; 
	`DATA_REGISTER
 (32-
b™
 
ÿ·bË
)

1764 
pİ
 
cx
 ; 
Re¡Üe
 
·ck‘
 
size


1765 
push
 
cx
 ; 
Save
 
Ï‹r


1767 ; 
U£
 32-
b™
 
Œªsãrs
 
effic›ncy


1768 
shr
 
cx
, 2 ; 
CÚv”t
 
by‹s
 
to
 
dwÜds


1770 .
»ad_dwÜd_loİ
:

1771 
š
 
—x
, 
dx
 ; 
R—d
 
dwÜd
 
äom
 
FIFO


1772 
mov
 [
bx
], 
—x
 ; 
StÜe
 
š
 
bufãr


1773 
add
 
bx
, 4 ; 
Advªû
 
bufãr
 
poš‹r


1774 
loİ
 .
»ad_dwÜd_loİ


1776 ; 
HªdË
 
»maššg
 
by‹s


1777 
pİ
 
ax
 ; 
Re¡Üe
 
·ck‘
 
size


1778 
ªd
 
ax
, 3 ; 
G‘
 
»mašd”
 
by‹s


1779 
jz
 .
dwÜd_®igÃd


1781 
š
 
—x
, 
dx
 ; 
R—d
 
fš®
 
dwÜd


1782 
mov
 
cx
, 
ax
 ; 
By‹
 
couÁ
 
to
 
CX


1784 .
by‹_cİy
:

1785 
mov
 [
bx
], 
®
 ; 
StÜe
 
by‹


1786 
shr
 
—x
, 8 ; 
Next
 
by‹


1787 
šc
 
bx


1788 
dec
 
cx


1789 
jnz
 .
by‹_cİy


1791 .
dwÜd_®igÃd
:

1792 ; 
C®l
 
·ck‘
 
»ûive
 
hªdËr


1793 
mov
 
ax
, 1 ; 
NIC
 
	`šdex
 (3C515-
TX
 = 1)

1794 
mov
 
bx
, 
OFFSET
 
‹mp_rx_bufãr


1795 
ÿÎ
 
·ck‘_İs_»ûive


1797 ; 
Upd©e
 
¡©i¡ics


1798 
šc
 
wÜd
 
±r
 [
œq_couÁ
+2] ; 
NIC
 1 
·ck‘
 
couÁ


1800 
pİ
 
cx
 ; 
Re¡Üe
 
loİ
 
couÁ”


1801 
dec
 
cx


1802 
jnz
 .
fifo_·ck‘_loİ


1804 
jmp
 .
fifo_dÚe


1806 .
sk_fifo_·ck‘
:

1807 ; 
Disÿrd
 
m®fÜmed
 
FIFO
 
·ck‘


1808 
sub
 
dx
, 08
h
 ; 
Back
 
to
 
ba£


1809 
add
 
dx
, 0E
h
 ; 
Commªd
 

1810 
mov
 
ax
, 4000
h
 ; 
RX_DISCARD
 
commªd


1811 
out
 
dx
, 
ax


1813 
add
 
dx
, 08
h
-0Eh ; 
Back
 
to
 
RX_STATUS


1814 
loİ
 .
fifo_·ck‘_loİ


1816 .
fifo_dÚe
:

1817 
pİ
 
dx


1818 
pİ
 
cx


1819 
pİ
 
bx


1820 
pİ
 
ax


1822 
pİ
 
es


1823 
pİ
 
ds


1824 
pİ
 
di


1825 
pİ
 
si


1826 
pİ
 
dx


1827 
pİ
 
cx


1828 
pİ
 
bx


1829 
pİ
 
ax


1830 
»t


1831 
´oûss_3c515_·ck‘s
 
ENDP


1834 ; 
nic_commÚ_œq_hªdËr
 - 
CommÚ
 
š‹¼u±
 
´oûssšg


1835 ; 
C®Ëd
 
by
 
bÙh
 
NIC
-
¥ecific
 
hªdËrs
 
to
 
³rfÜm
 
commÚ
 
sks


1837 ; 
IÅut
: 
AL
 = 
NIC
 
šdex
, 
BX
 = 
š‹¼u±
 
¡©us
 
æags


1838 ; 
Ouut
: 
AX
 = 0 
hªdËd
, 
nÚ
-
z”o
 
¥urious


1839 ; 
U£s
: 
AÎ
 
»gi¡”s


1841 
nic_commÚ_œq_hªdËr
 
PROC


1842 
push
 
bp


1843 
mov
 
bp
, 
¥


1844 
push
 
cx


1845 
push
 
dx


1846 
push
 
si


1847 
push
 
di


1849 ; 
V®id©e
 
š‹¼u±
 
¡©us
, 
hªdË
 
commÚ
 iÁ”ru± 
cÚd™iÚs
, 
ªd
 
di¥©ch
 
to
 
·ck‘
 
´oûssšg


1851 ; 
Check
 
»ûive
 
š‹¼u±


1852 
‹¡
 
bl
, 
IRQ_RX_COMPLETE


1853 
jz
 .
no_rx


1855 ; 
HªdË
 
·ck‘
 
»û±iÚ


1856 
ÿÎ
 
·ck‘_İs_»ûive


1857 ; 
Check
  
v®ue
 
ªd
 
hªdË
 
”rÜs


1858 
‹¡
 
ax
,‡x

1859 
jz
 .
rx_sucûss


1861 ; 
HªdË
 
»ûive
 
”rÜ


1862 
šc
 
wÜd
 
±r
 [
rx_”rÜ_couÁ
]

1863 
push
 
ax


1864 
ÿÎ
 
log_rx_”rÜ


1865 
pİ
 
ax


1866 
jmp
 .
no_rx


1868 .
rx_sucûss
:

1869 
šc
 
wÜd
 
±r
 [
rx_·ck‘_couÁ
]

1871 .
no_rx
:

1872 ; 
Check
 
Œªsm™
 
com¶‘iÚ


1873 
‹¡
 
bl
, 
IRQ_TX_COMPLETE


1874 
jz
 .
no_tx


1876 ; 
HªdË
 
Œªsm™
 
com¶‘iÚ


1877 
push
 
si


1878 
push
 
di


1879 
push
 
dx


1881 ; 
G‘
 
TX
 
¡©us
 
äom
 
h¬dw¬e


1882 
mov
 
dx
, [
cu¼’t_ioba£
]

1883 
‹¡
 
dx
, dx

1884 
jz
 .
no_ioba£_tx


1885 
add
 
dx
, 0x0B ; 
TX_STATUS
 
off£t


1886 
š
 
®
, 
dx


1888 ; 
Check
 
”rÜs


1889 
‹¡
 
®
, 0xF8 ; 
E¼Ü
 
	`b™s
 (
b™s
 3-7)

1890 
jz
 .
tx_sucûss


1892 ; 
HªdË
 
TX
 
”rÜ


1893 
šc
 
wÜd
 
±r
 [
tx_”rÜ_couÁ
]

1894 
push
 
ax


1895 
ÿÎ
 
hªdË_tx_”rÜ


1896 
pİ
 
ax


1897 
jmp
 .
tx_dÚe


1899 .
tx_sucûss
:

1900 ; 
F»e
 
Œªsm™
 
bufãr


1901 
mov
 
si
, [
cu¼’t_tx_bufãr
]

1902 
‹¡
 
si
, si

1903 
jz
 .
no_bufãr_to_ä“


1904 
ÿÎ
 
ä“_tx_bufãr


1905 
mov
 
wÜd
 
±r
 [
cu¼’t_tx_bufãr
], 0

1907 .
no_bufãr_to_ä“
:

1908 ; 
Upd©e
 
¡©i¡ics


1909 
šc
 
wÜd
 
±r
 [
tx_·ck‘_couÁ
]

1911 .
tx_dÚe
:

1912 ; 
CË¬
 
TX
 
¡©us


1913 
out
 
dx
, 
®
 ; 
Wr™e
 
back
 
to
 
ş—r


1915 .
no_ioba£_tx
:

1916 
pİ
 
dx


1917 
pİ
 
di


1918 
pİ
 
si


1920 .
no_tx
:

1921 ; 
Check
 
”rÜs


1922 
‹¡
 
bl
, 
IRQ_RX_ERROR


1923 
jz
 .
no_rx_”rÜ


1925 ; 
HªdË
 
»ûive
 
”rÜs


1926 
push
 
ax


1927 
push
 
dx


1929 ; 
G‘
 
d‘aed
 
”rÜ
 
¡©us


1930 
mov
 
dx
, [
cu¼’t_ioba£
]

1931 
‹¡
 
dx
, dx

1932 
jz
 .
no_ioba£_rx_”r


1933 
add
 
dx
, 0x08 ; 
RX_STATUS
 

1934 
š
 
ax
, 
dx


1936 ; 
CÏssify
 
”rÜ
 
ty³


1937 
‹¡
 
ax
, 0x4000 ; 
G’”®
 
”rÜ
 
b™


1938 
jz
 .
no_rx_”r


1940 ; 
Upd©e
 
”rÜ
 
couÁ”s
 
ba£d
 
Ú
 
ty³


1941 
‹¡
 
ax
, 0x0800 ; 
Ov”size
 
·ck‘


1942 
jz
 .
nÙ_ov”size


1943 
šc
 
wÜd
 
±r
 [
rx_ov”size_”rÜs
]

1944 .
nÙ_ov”size
:

1945 
‹¡
 
ax
, 0x2800 ; 
CRC
 
”rÜ


1946 
jz
 .
nÙ_üc


1947 
šc
 
wÜd
 
±r
 [
rx_üc_”rÜs
]

1948 .
nÙ_üc
:

1949 
‹¡
 
ax
, 0x2000 ; 
F¿mšg
 
”rÜ


1950 
jz
 .
nÙ_äamšg


1951 
šc
 
wÜd
 
±r
 [
rx_äamšg_”rÜs
]

1952 .
nÙ_äamšg
:

1954 ; 
Log
 
”rÜ
 
debuggšg


1955 
push
 
ax


1956 
ÿÎ
 
log_rx_”rÜ_d‘as


1957 
pİ
 
ax


1959 ; 
Disÿrd
 
bad
 
·ck‘


1960 
mov
 
dx
, [
cu¼’t_ioba£
]

1961 
add
 
dx
, 0x0E ; 
Commªd
 

1962 
mov
 
ax
, 0x4000 ; 
RX_DISCARD
 
commªd


1963 
out
 
dx
, 
ax


1965 .
no_rx_”r
:

1966 .
no_ioba£_rx_”r
:

1967 
pİ
 
dx


1968 
pİ
 
ax


1970 .
no_rx_”rÜ
:

1971 
‹¡
 
bl
, 
IRQ_TX_ERROR


1972 
jz
 .
no_tx_”rÜ


1974 ; 
HªdË
 
Œªsm™
 
”rÜs


1975 
push
 
ax


1976 
push
 
bx


1977 
push
 
cx


1978 
push
 
dx


1980 ; 
G‘
 
TX
 
”rÜ
 
d‘as


1981 
mov
 
dx
, [
cu¼’t_ioba£
]

1982 
‹¡
 
dx
, dx

1983 
jz
 .
no_ioba£_tx_”r


1984 
add
 
dx
, 0x0B ; 
TX_STATUS
 

1985 
š
 
®
, 
dx


1986 
mov
 
bl
, 
®
 ; 
Save
 
¡©us


1988 ; 
CÏssify
 
”rÜ


1989 
‹¡
 
bl
, 0x80 ; 
Max
 
cŞlisiÚs


1990 
jz
 .
nÙ_max_cŞl


1991 
šc
 
wÜd
 
±r
 [
tx_max_cŞl_”rÜs
]

1992 
mov
 
ş
, 1 ; 
S‘
 
»Œy
 
æag


1993 
jmp
 .
check_»Œy


1995 .
nÙ_max_cŞl
:

1996 
‹¡
 
bl
, 0x20 ; 
Und”run


1997 
jz
 .
nÙ_und”run


1998 
šc
 
wÜd
 
±r
 [
tx_und”run_”rÜs
]

1999 
mov
 
ş
, 0 ; 
DÚ
't„etry underrun

2000 
jmp
 .
check_»Œy


2002 .
nÙ_und”run
:

2003 
‹¡
 
bl
, 0x40 ; 
Jabb”


2004 
jz
 .
nÙ_jabb”


2005 
šc
 
wÜd
 
±r
 [
tx_jabb”_”rÜs
]

2006 
mov
 
ş
, 0 ; 
DÚ
't„etry jabber

2008 .
nÙ_jabb”
:

2009 
mov
 
ş
, 0 ; 
DeçuÉ
: 
no
 
»Œy


2011 .
check_»Œy
:

2012 ; 
R‘ry
 
ŒªsmissiÚ
 
­´İrŸ‹


2013 
‹¡
 
ş
, cl

2014 
jz
 .
no_»Œy


2016 ; 
Check
 
»Œy
 
couÁ


2017 
mov
 
®
, [
cu¼’t_tx_»Œ›s
]

2018 
cmp
 
®
, 3 ; 
Max
 
»Œ›s


2019 
j«
 .
no_»Œy


2021 ; 
R‘ry
 
ŒªsmissiÚ


2022 
šc
 
by‹
 
±r
 [
cu¼’t_tx_»Œ›s
]

2023 
ÿÎ
 
»Œy_ŒªsmissiÚ


2024 
jmp
 .
tx_”rÜ_dÚe


2026 .
no_»Œy
:

2027 ; 
F»e
 
çed
 
TX
 
bufãr


2028 
ÿÎ
 
ä“_cu¼’t_tx_bufãr


2029 
mov
 
by‹
 
±r
 [
cu¼’t_tx_»Œ›s
], 0

2031 .
tx_”rÜ_dÚe
:

2032 ; 
CË¬
 
TX
 
¡©us


2033 
mov
 
dx
, [
cu¼’t_ioba£
]

2034 
add
 
dx
, 0x0B

2035 
out
 
dx
, 
bl
 ; 
Wr™e
 
¡©us
 
to
 
ş—r


2037 .
no_ioba£_tx_”r
:

2038 
pİ
 
dx


2039 
pİ
 
cx


2040 
pİ
 
bx


2041 
pİ
 
ax


2043 .
no_tx_”rÜ
:

2044 ; 
Sucûss
 - 
š‹¼u±
 
hªdËd


2045 
mov
 
ax
, 0

2047 
pİ
 
di


2048 
pİ
 
si


2049 
pİ
 
dx


2050 
pİ
 
cx


2051 
pİ
 
bp


2052 
»t


2053 
nic_commÚ_œq_hªdËr
 
ENDP


2056 ; 
nic_£t_»ûive_mode
 - 
S‘
 
NIC
 
»ûive
 
mode


2058 ; 
IÅut
: 
AL
 = 
NIC
 
šdex
, 
BL
 = 
»ûive
 
mode


2059 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


2060 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


2062 
nic_£t_»ûive_mode
 
PROC


2063 
push
 
bp


2064 
mov
 
bp
, 
¥


2065 
push
 
cx


2066 
push
 
dx


2068 ; 
V®id©e
 
·¿m‘”s
 
ªd
 
upd©e
 
š‹º®
 
¡©e


2070 ; 
V®id©e
 
NIC
 
šdex


2071 
cmp
 
®
, 
MAX_NICS


2072 
j«
 .
šv®id_nic


2074 ; 
V®id©e
 
»ûive
 
mode


2075 
cmp
 
bl
, 1

2076 
jb
 .
šv®id_mode


2077 
cmp
 
bl
, 6

2078 
ja
 .
šv®id_mode


2080 ; 
StÜe
 
Ãw
 
»ûive
 
mode


2081 
mov
 [
cu¼’t_»ûive_mode
], 
bl


2083 ; 
Prog¿m
 
NIC
 
h¬dw¬e
 
»gi¡”s
 
»ûive
 
mode


2084 
push
 
si


2085 
push
 
di


2087 ; 
G‘
 
I
/
O
 
ba£
 
this
 
NIC


2088 
movzx
 
si
, 
®
 ; 
NIC
 
šdex


2089 
shl
 
si
, 1 ; 
WÜd
 
off£t


2090 
mov
 
di
, 
OFFSET
 
nic_ioba£_bË


2091 
mov
 
dx
, [
di
 + 
si
] ; 
G‘
 
I
/
O
 
ba£


2092 
‹¡
 
dx
, dx

2093 
jz
 .
no_ioba£_mode


2095 ; 
S–eù
 
Wšdow
 1 
RX
 
cÚŒŞ


2096 
add
 
dx
, 0x0E ; 
Commªd
 

2097 
mov
 
ax
, 0x0801 ; 
SELECT_WINDOW
 | 1

2098 
out
 
dx
, 
ax


2099 
ÿÎ
 
io_d–ay


2101 ; 
S‘
 
RX
 
f‹r
 
ba£d
 
Ú
 
mode


2102 
mov
 
dx
, [
di
 + 
si
] ; 
Re¡Üe
 
ba£


2103 
add
 
dx
, 0x0E ; 
Commªd
 

2104 
mov
 
ax
, 0x0800 ; 
SET_RX_FILTER
 
ba£
 
commªd


2106 ; 
CÚfigu»
 
ba£d
 
Ú
 
mode


2107 
cmp
 
bl
, 1 ; 
Mode
 1: 
Off


2108 
je
 .
mode_off


2109 
cmp
 
bl
, 2 ; 
Mode
 2: 
	$Dœeù
 (
¡©iÚ
 
Úly
)

2110 
je
 .
mode_dœeù


2111 
cmp
 
bl
, 3 ; 
Mode
 3: 
Brßdÿ¡


2112 
je
 .
mode_brßdÿ¡


2113 
cmp
 
bl
, 4 ; 
Mode
 4: 
MuÉiÿ¡


2114 
je
 .
mode_muÉiÿ¡


2115 
cmp
 
bl
, 5 ; 
Mode
 5: 
AÎ
 
muÉiÿ¡


2116 
je
 .
mode_®l_muÉi


2117 
cmp
 
bl
, 6 ; 
Mode
 6: 
Promiscuous


2118 
je
 .
mode_´omiscuous


2119 
jmp
 .
šv®id_mode
 ; 
Should
 
have
 
b“n
 
ÿught
 
—¾›r


2121 .
mode_off
:

2122 
Ü
 
ax
, 0x00 ; 
No
 
·ck‘s


2123 
jmp
 .
£t_f‹r


2125 .
mode_dœeù
:

2126 
Ü
 
ax
, 0x01 ; 
StiÚ
 
add»ss
 
Úly


2127 
jmp
 .
£t_f‹r


2129 .
mode_brßdÿ¡
:

2130 
Ü
 
ax
, 0x05 ; 
StiÚ
 + 
brßdÿ¡


2131 
jmp
 .
£t_f‹r


2133 .
mode_muÉiÿ¡
:

2134 
Ü
 
ax
, 0x03 ; 
StiÚ
 + 
muÉiÿ¡


2135 
jmp
 .
£t_f‹r


2137 .
mode_®l_muÉi
:

2138 
Ü
 
ax
, 0x07 ; 
StiÚ
 + 
®l
 
muÉiÿ¡


2139 
jmp
 .
£t_f‹r


2141 .
mode_´omiscuous
:

2142 
Ü
 
ax
, 0x0F ; 
AÎ
 
·ck‘s


2144 .
£t_f‹r
:

2145 
out
 
dx
, 
ax
 ; 
S‘
 
the
 
f‹r


2146 
ÿÎ
 
io_d–ay


2148 .
no_ioba£_mode
:

2149 
pİ
 
di


2150 
pİ
 
si


2152 ; 
Sucûss


2153 
mov
 
ax
, 0

2154 
jmp
 .
ex™


2156 .
šv®id_nic
:

2157 
mov
 
ax
, 1

2158 
jmp
 .
ex™


2160 .
šv®id_mode
:

2161 
mov
 
ax
, 2

2162 
jmp
 .
ex™


2164 .
ex™
:

2165 
pİ
 
dx


2166 
pİ
 
cx


2167 
pİ
 
bp


2168 
»t


2169 
nic_£t_»ûive_mode
 
ENDP


2172 ; 
g‘_œq_¡©s
 - 
G‘
 
š‹¼u±
 
¡©i¡ics


2174 ; 
IÅut
: 
ES
:
DI
 = 
bufãr
 
to
 
»ûive
 
¡©i¡ics


2175 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


2176 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
SI
, 
DI


2178 
g‘_œq_¡©s
 
PROC


2179 
push
 
bp


2180 
mov
 
bp
, 
¥


2181 
push
 
bx


2182 
push
 
cx


2183 
push
 
si


2185 ; 
V®id©e
 
bufãr
 
poš‹r
 
ªd
 
cİy
 
¡©i¡ics


2186 
push
 
ds


2187 
push
 
es


2188 
push
 
di


2190 ; 
G‘
 
u£r
 
bufãr
 
poš‹r
 
äom
 
¡ack


2191 
mov
 
di
, [
bp
+4] ; 
Off£t


2192 
mov
 
ax
, [
bp
+6] ; 
Segm’t


2193 
‹¡
 
ax
,‡x ; 
Check
 
nuÎ
 
£gm’t


2194 
jz
 .
šv®id_bufãr


2195 
mov
 
es
, 
ax
 ; 
ES
:
DI
 = 
u£r
 
bufãr


2197 ; 
Cİy
 
com´eh’sive
 
¡©i¡ics
 
to
 
u£r
 
bufãr


2198 
push
 
si


2199 
push
 
cx


2201 ; 
Cİy
 
³r
-
NIC
 
š‹¼u±
 
couÁs


2202 
mov
 
si
, 
OFFSET
 
œq_couÁ


2203 
mov
 
cx
, 
MAX_NICS
 ; 
Numb”
 
of
 
NICs


2204 .
cİy_œq_couÁs
:

2205 
movsw
 ; 
Cİy
 
wÜd


2206 
loİ
 .
cİy_œq_couÁs


2208 ; 
Cİy
 
¥urious
 
š‹¼u±
 
couÁ


2209 
mov
 
ax
, [
¥urious_œq_couÁ
]

2210 
¡osw


2212 ; 
Cİy
 
·ck‘
 
couÁ”s


2213 
mov
 
ax
, [
rx_·ck‘_couÁ
]

2214 
¡osw


2215 
mov
 
ax
, [
tx_·ck‘_couÁ
]

2216 
¡osw


2218 ; 
Cİy
 
”rÜ
 
couÁ”s


2219 
mov
 
ax
, [
rx_”rÜ_couÁ
]

2220 
¡osw


2221 
mov
 
ax
, [
tx_”rÜ_couÁ
]

2222 
¡osw


2224 ; 
Cİy
 
d‘aed
 
”rÜ
 
¡©i¡ics


2225 
mov
 
ax
, [
rx_ov”size_”rÜs
]

2226 
¡osw


2227 
mov
 
ax
, [
rx_üc_”rÜs
]

2228 
¡osw


2229 
mov
 
ax
, [
rx_äamšg_”rÜs
]

2230 
¡osw


2231 
mov
 
ax
, [
tx_max_cŞl_”rÜs
]

2232 
¡osw


2233 
mov
 
ax
, [
tx_und”run_”rÜs
]

2234 
¡osw


2235 
mov
 
ax
, [
tx_jabb”_”rÜs
]

2236 
¡osw


2238 
pİ
 
cx


2239 
pİ
 
si


2241 
xÜ
 
ax
,‡x ; 
Sucûss


2242 
jmp
 .
¡©s_dÚe


2244 .
šv®id_bufãr
:

2245 
mov
 
ax
, -1 ; 
E¼Ü
 
code


2247 .
¡©s_dÚe
:

2248 
pİ
 
di


2249 
pİ
 
es


2250 
pİ
 
ds


2252 ; 
Cİy
 
š‹¼u±
 
couÁs


2253 
mov
 
si
, 
OFFSET
 
œq_couÁ


2254 
mov
 
cx
, 
MAX_NICS


2255 .
cİy_loİ
:

2256 
mov
 
ax
, [
si
]

2257 
¡osw
 ; 
StÜe
 
to
 
ES
:
DI


2258 
add
 
si
, 2

2259 
loİ
 .
cİy_loİ


2261 ; 
Cİy
 
¥urious
 
š‹¼u±
 
couÁ


2262 
mov
 
ax
, [
¥urious_œq_couÁ
]

2263 
¡osw


2265 ; 
Sucûss


2266 
mov
 
ax
, 0

2268 
pİ
 
si


2269 
pİ
 
cx


2270 
pİ
 
bx


2271 
pİ
 
bp


2272 
»t


2273 
g‘_œq_¡©s
 
ENDP


2276 ; 3C509B
_œq_hªdËr
 - 3C509B-
¥ecific
 
š‹¼u±
 
£rviû
 
routše


2278 ; 
This
 
is
 
the
 
aùu®
 
ISR
 
th©
 
g‘s
 
ÿÎed
 
by
h
h¬dw¬e
 
š‹¼u±


2279 ; 
IÅut
: 
	`NÚe
 (
ÿÎed
 
by
 
š‹¼u±
)

2280 ; 
Ouut
: 
NÚe


2281 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
§ves
 
ªd
 
»¡Ües
)

2283 
_3C509B_œq_hªdËr
 
PROC
 
FAR


2284 ; 
Save
 
®l
 
	$»gi¡”s
 (
¡ªd¬d
 
ISR
 
´Şogue
)

2285 
push
 
ax


2286 
push
 
bx


2287 
push
 
cx


2288 
push
 
dx


2289 
push
 
si


2290 
push
 
di


2291 
push
 
bp


2292 
push
 
ds


2293 
push
 
es


2295 ; 
S‘up
 
d©a
 
£gm’t


2296 
mov
 
ax
, @
d©a


2297 
mov
 
ds
, 
ax


2299 ; 
G‘
 
NIC
 
cÚ‹xt
 
ªd
 
´oûss
 
š‹¼u±s


2300 
mov
 
si
, 0 ; 
NIC
 0 
	$šdex
 (3C509B)

2301 
ÿÎ
 
g‘_nic_ioba£
 ; 
G‘
 
I
/
O
 
ba£
 
add»ss


2302 
mov
 
dx
, 
ax
 ; 
DX
 = 
I
/
O
 
ba£


2303 
‹¡
 
dx
, dx ; 
Check
 
cÚfigu»d


2304 
jz
 .
nÙ_our_š‹¼u±


2306 
add
 
dx
, 0E
h
 ; 
INT_STATUS
 
off£t


2307 
š
 
ax
, 
dx
 ; 
R—d
 
š‹¼u±
 
¡©us


2308 
‹¡
 
ax
, 00FF
h
 ; 
Check
 
ªy
 
š‹¼u±s


2309 
jz
 .
nÙ_our_š‹¼u±


2311 
mov
 
bx
, 
ax
 ; 
Save
 
š‹¼u±
 
¡©us


2312 
ÿÎ
 
´oûss_3c509b_š‹¼u±s
 ; 
Proûss
 
the
 
š‹¼u±s


2313 
jmp
 .
£nd_eoi


2315 .
nÙ_our_š‹¼u±
:

2316 ; 
I‹¿‹
 
through
 
®l
 
cÚfigu»d
 
NICs
 
to
 
fšd
 
š‹¼u±
 
sourû


2317 
xÜ
 
si
, s˜; 
S¹
 
w™h
 
NIC
 0

2318 .
check_nic_loİ
:

2319 
cmp
 
si
, 
MAX_NICS


2320 
j«
 .
no_š‹¼u±_sourû


2322 ; 
Check
 
NIC
 
is
 
cÚfigu»d


2323 
mov
 
®
, [
nic_œq_numb”s
 + 
si
]

2324 
cmp
 
®
, 
IRQ_NONE


2325 
je
 .
Ãxt_nic


2327 ; 
Check
 
š‹¼u±
 
¡©us
 
this
 
NIC


2328 
ÿÎ
 
check_nic_š‹¼u±_¡©us


2329 
‹¡
 
ax
,‡x

2330 
jnz
 .
found_š‹¼u±


2332 .
Ãxt_nic
:

2333 
šc
 
si


2334 
jmp
 .
check_nic_loİ


2336 .
found_š‹¼u±
:

2337 ; 
SI
 
cÚšs
 
NIC
 
šdex
 
w™h
 
š‹¼u±


2338 
ÿÎ
 
hªdË_nic_š‹¼u±


2339 
jmp
 .
£nd_eoi


2341 .
no_š‹¼u±_sourû
:

2342 ; 
No
 
v®id
 
š‹¼u±
 
sourû
 
found
 - 
¥urious
 interrupt

2343 
šc
 
wÜd
 
±r
 [
¥urious_œq_couÁ
]

2345 .
£nd_eoi
:

2346 ; 
AcknowËdge
 
š‹¼u±
 
©
 
PIC


2347 
mov
 
bl
, [
nic_œq_numb”s
] ; 
G‘
 
IRQ
 
NIC
 0

2348 
cmp
 
bl
, 
IRQ_NONE


2349 
je
 .
sk_eoi


2350 
cmp
 
bl
, 8

2351 
jb
 .
ma¡”_pic_Úly


2353 ; 
SÏve
 
PIC
 
	`š‹¼u±
 (
IRQ
 8-15)

2354 
mov
 
®
, 0x60 ; 
S³cific
 
EOI
 
commªd


2355 
add
 
®
, 
bl


2356 
sub
 
®
, 8 ; 
Adju¡
 
¦ave


2357 
out
 
PIC2_COMMAND
, 
®
 ; 
S’d
 
to
 
¦ave
 
PIC


2358 
ÿÎ
 
io_d–ay


2359 
mov
 
®
, 0x62 ; 
EOI
 
	$IRQ2
 (
ÿsÿde
)

2360 
out
 
PIC1_COMMAND
, 
®
 ; 
S’d
 
to
 
ma¡”
 
PIC


2361 
jmp
 .
eoi_dÚe


2363 .
ma¡”_pic_Úly
:

2364 ; 
Ma¡”
 
PIC
 
	`š‹¼u±
 (
IRQ
 0-7)

2365 
mov
 
®
, 0x60 ; 
S³cific
 
EOI
 
commªd


2366 
add
 
®
, 
bl
 ; 
Add
 
IRQ
 
numb”


2367 
out
 
PIC1_COMMAND
, 
®
 ; 
S’d
 
EOI
 
to
 
ma¡”
 
PIC


2369 .
eoi_dÚe
:

2370 .
sk_eoi
:

2372 ; 
Re¡Üe
 
®l
 
	$»gi¡”s
 (
¡ªd¬d
 
ISR
 
•ogue
)

2373 
pİ
 
es


2374 
pİ
 
ds


2375 
pİ
 
bp


2376 
pİ
 
di


2377 
pİ
 
si


2378 
pİ
 
dx


2379 
pİ
 
cx


2380 
pİ
 
bx


2381 
pİ
 
ax


2383 
œ‘
 ; 
R‘uº
 
äom
 
š‹¼u±


2384 
_3C509B_œq_hªdËr
 
ENDP


2387 ; 
š¡®l_3c509b_œq
 - 
In¡®l
 3C509B 
š‹¼u±
 
hªdËr


2389 ; 
IÅut
: 
AL
 = 
IRQ
 
	`numb”
 (3, 5, 7, 9-12, 15)

2390 ; 
BX
 = 
NIC
 
šdex


2391 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


2392 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
ES


2394 
š¡®l_3c509b_œq
 
PROC


2395 
push
 
bp


2396 
mov
 
bp
, 
¥


2397 
push
 
bx


2398 
push
 
cx


2399 
push
 
dx


2400 
push
 
es


2402 ; 
V®id©e
 
IRQ
 
numb”


2403 
cmp
 
®
, 
IRQ_MIN


2404 
jb
 .
šv®id_œq


2405 
cmp
 
®
, 
IRQ_MAX


2406 
ja
 .
šv®id_œq


2408 ; 
Check
 
šv®id
 
IRQ
 
	$v®ues
 (4, 6, 8, 13, 14)

2409 
cmp
 
®
, 4

2410 
je
 .
šv®id_œq


2411 
cmp
 
®
, 6

2412 
je
 .
šv®id_œq


2413 
cmp
 
®
, 8

2414 
je
 .
šv®id_œq


2415 
cmp
 
®
, 13

2416 
je
 .
šv®id_œq


2417 
cmp
 
®
, 14

2418 
je
 .
šv®id_œq


2420 ; 
V®id©e
 
NIC
 
šdex


2421 
cmp
 
bl
, 
MAX_NICS


2422 
j«
 .
šv®id_nic


2424 ; 
StÜe
 
IRQ
 
numb”
 
this
 
NIC


2425 
mov
 
ah
, 0

2426 
mov
 
si
, 
bx


2427 
mov
 [
nic_œq_numb”s
 + 
si
], 
®


2429 ; 
C®cuÏ‹
 
š‹¼u±
 
veùÜ
 
numb”


2430 
mov
 
ş
, 
®


2431 
add
 
ş
, 8 ; 
H¬dw¬e
 
IRQs
 
¡¬t
 
©
 
INT
 08
h


2433 ; 
G‘
 
cu¼’t
 
š‹¼u±
 
veùÜ


2434 
mov
 
ah
, 35
h
 ; 
DOS
 
g‘
 
š‹¼u±
 
veùÜ


2435 
mov
 
®
, 
ş


2436 21
h
 ; 
ES
:
BX
 = 
cu¼’t
 
veùÜ


2438 ; 
Save
 
Üigš®
 
veùÜ


2439 
mov
 
si
, 
bx


2440 
shl
 
si
, 2 ; 
Each
 
veùÜ
 
is
 4 
by‹s


2441 
mov
 [
Üigš®_œq_veùÜs
 + 
si
], 
bx


2442 
mov
 [
Üigš®_œq_veùÜs
 + 
si
 + 2], 
es


2444 ; 
In¡®l
 
our
 
hªdËr


2445 
mov
 
ah
, 25
h
 ; 
DOS
 
£t
 
š‹¼u±
 
veùÜ


2446 
mov
 
®
, 
ş


2447 
mov
 
dx
, 
OFFSET
 
_3C509B_œq_hªdËr


2448 
push
 
ds


2449 
push
 
cs


2450 
pİ
 
ds


2451 21
h


2452 
pİ
 
ds


2454 ; 
M¬k
 
IRQ
 
as
 
š¡®Ëd


2455 
mov
 
si
, 
bx


2456 
mov
 [
œq_š¡®Ëd
 + 
si
], 1

2458 ; 
EÇbË
 
IRQ
 
©
 
PIC


2459 
ÿÎ
 
’abË_œq_©_pic


2461 ; 
Sucûss


2462 
mov
 
ax
, 0

2463 
jmp
 .
ex™


2465 .
šv®id_œq
:

2466 
mov
 
ax
, 1

2467 
jmp
 .
ex™


2469 .
šv®id_nic
:

2470 
mov
 
ax
, 2

2471 
jmp
 .
ex™


2473 .
ex™
:

2474 
pİ
 
es


2475 
pİ
 
dx


2476 
pİ
 
cx


2477 
pİ
 
bx


2478 
pİ
 
bp


2479 
»t


2480 
š¡®l_3c509b_œq
 
ENDP


2483 ; 
’abË_œq_©_pic
 - 
EÇbË
 
IRQ
 
©
 
the
 
Prog¿mmabË
 
IÁ”ru±
 
CÚŒŞËr


2485 ; 
IÅut
: 
AL
 = 
IRQ
 
numb”


2486 ; 
Ouut
: 
NÚe


2487 ; 
U£s
: 
AX
, 
DX


2489 
’abË_œq_©_pic
 
PROC


2490 
push
 
ax


2491 
push
 
dx


2493 
cmp
 
®
, 8

2494 
jb
 .
ma¡”_pic


2496 ; 
SÏve
 
	`PIC
 (
IRQ
 8-15)

2497 
sub
 
®
, 8

2498 
mov
 
ş
, 
®


2499 
mov
 
®
, 1

2500 
shl
 
®
, 
ş


2501 
nÙ
 
®


2502 
š
 
®
, 
PIC2_DATA


2503 
ªd
 
®
,‡l

2504 
out
 
PIC2_DATA
, 
®


2506 ; 
Also
 
’abË
 
IRQ
 2 
Ú
 
	$ma¡”
 (
ÿsÿde
)

2507 
š
 
®
, 
PIC1_DATA


2508 
ªd
 
®
, 11111011b ; 
CË¬
 
b™
 2

2509 
out
 
PIC1_DATA
, 
®


2510 
jmp
 .
dÚe


2512 .
ma¡”_pic
:

2513 ; 
Ma¡”
 
	`PIC
 (
IRQ
 0-7)

2514 
mov
 
ş
, 
®


2515 
mov
 
®
, 1

2516 
shl
 
®
, 
ş


2517 
nÙ
 
®


2518 
š
 
®
, 
PIC1_DATA


2519 
ªd
 
®
,‡l

2520 
out
 
PIC1_DATA
, 
®


2522 .
dÚe
:

2523 
pİ
 
dx


2524 
pİ
 
ax


2525 
»t


2526 
’abË_œq_©_pic
 
ENDP


2529 ; 
nic_œq_hªdËr_3c509b_b©ched
 - 
Enhªûd
 3C509B 
š‹¼u±
 
hªdËr
 
w™h
 
b©chšg


2530 ; 
This
 
is
 
the
 
’hªûd
 
ISR
 
th©
 
u£s
 
š‹¼u±
 
b©chšg
 
b‘‹r
 
³rfÜmªû


2532 ; 
IÅut
: 
	`NÚe
 (
š‹¼u±
 
cÚ‹xt
)

2533 ; 
Ouut
: 
NÚe


2534 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
§ved
/
»¡Üed
)

2536 
nic_œq_hªdËr_3c509b_b©ched
 
PROC


2537 ; 
Check
 
CPU
 
ã©u»s
 
ªd
 
u£
 
­´İrŸ‹
 
§všg


2538 
ÿÎ
 
g‘_ıu_ã©u»s


2539 
‹¡
 
ax
, 1 ; 
Check
 
PUSHA
 
	`suµÜt
 (286+)

2540 
jz
 .
§ve_mªu®_3c509b


2542 ; 
U£
 
PUSHA
 286+ 
CPUs


2543 
pusha


2544 
push
 
ds


2545 
push
 
es


2546 
jmp
 .
»gi¡”s_§ved_3c509b


2548 .
§ve_mªu®_3c509b
:

2549 ; 
Mªu®
 
§všg
 8086/8088

2550 
push
 
ax


2551 
push
 
bx


2552 
push
 
cx


2553 
push
 
dx


2554 
push
 
si


2555 
push
 
di


2556 
push
 
ds


2557 
push
 
es


2559 .
»gi¡”s_§ved_3c509b
:

2560 ; 
S‘
 
up
 
our
 
d©a
 
£gm’t


2561 
push
 
cs


2562 
pİ
 
ds


2563 
ASSUME
 
DS
:
_TEXT


2565 ; 
Inüem’t
 
š‹¼u±
 
couÁ”


2566 
šc
 
wÜd
 
±r
 [
œq_couÁ
] ; 
Assumšg
 
NIC
 0

2568 ; 
C®l
 
’hªûd
 
b©ched
 
š‹¼u±
 
hªdËr


2569 ; 
Proûss
 
muÉË
 
ev’ts
 
³r
 
š‹¼u±
 
to
 
»duû
 
ov”h—d


2570 
mov
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
], 0

2571 
mov
 
si
, 0 ; 
NIC
 
šdex
 3C509B

2572 
ÿÎ
 
g‘_nic_ioba£


2573 
mov
 
dx
, 
ax
 ; 
DX
 = 
I
/
O
 
ba£


2574 
‹¡
 
dx
, dx

2575 
jz
 .
no_nic_3c509b


2577 .
b©ch_loİ_3c509b
:

2578 ; 
Check
 
b©ch
 
lim™


2579 
mov
 
®
, [
b©ch_couÁ_3c509b
]

2580 
cmp
 
®
, 
MAX_EVENTS_PER_IRQ


2581 
j«
 .
b©ch_dÚe_3c509b


2583 ; 
R—d
 
š‹¼u±
 
¡©us


2584 
push
 
dx


2585 
add
 
dx
, 0x0E ; 
INT_STATUS
 

2586 
š
 
ax
, 
dx
 ; 
R—d
 
¡©us


2587 
pİ
 
dx


2588 
‹¡
 
ax
, 0x00FF ; 
Any
 
š‹¼u±s
 
³ndšg
?

2589 
jz
 .
b©ch_dÚe_3c509b


2591 ; 
Proûss
 
this
 
š‹¼u±
 
ev’t


2592 
push
 
ax


2593 
push
 
dx


2594 
mov
 
bx
, 
ax
 ; 
Stus
 
š
 
BX


2595 
ÿÎ
 
´oûss_3c509b_ev’t


2596 
pİ
 
dx


2597 
pİ
 
ax


2599 ; 
AcknowËdge
 
´oûs£d
 
š‹¼u±s


2600 
push
 
dx


2601 
add
 
dx
, 0x0E

2602 
mov
 
bx
, 
ax


2603 
ªd
 
bx
, 0x00FF ; 
Mask
 
to
 
v®id
 
b™s


2604 
Ü
 
bx
, 0x6800 ; 
ACK_INTR
 
commªd


2605 
mov
 
ax
, 
bx


2606 
out
 
dx
, 
ax


2607 
pİ
 
dx


2609 ; 
Inüem’t
 
b©ch
 
couÁ”


2610 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
]

2611 
jmp
 .
b©ch_loİ_3c509b


2613 .
b©ch_dÚe_3c509b
:

2614 ; 
If
 
we
 
´oûs£d
 
ev’ts
, 
sucûss


2615 
cmp
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
], 0

2616 
je
 .
Œy_h¬dw¬e_hªdËr


2617 
xÜ
 
ax
,‡x ; 
Sucûss


2618 
jmp
 .
hªdËr_dÚe_3c509b


2620 .
Œy_h¬dw¬e_hªdËr
:

2621 ; 
F®l
 
back
 
to
 
h¬dw¬e
 
hªdËr
 
no
 
b©ched
 
´oûssšg


2622 
ÿÎ
 
h¬dw¬e_hªdË_3c509b_œq


2623 
jmp
 .
hªdËr_dÚe_3c509b


2625 .
no_nic_3c509b
:

2626 
mov
 
ax
, 1 ; 
NÙ
 
our
 
š‹¼u±


2628 .
hªdËr_dÚe_3c509b
:

2629 ; 
AX
 
cÚšs
 
»suÉ


2630 
cmp
 
ax
, 0

2631 
jÃ
 .
¥urious_š‹¼u±_3c509b


2633 ; 
S’d
 
EOI
 
to
 
š‹¼u±
 
cÚŒŞËr


2634 ; 
Check
 
IRQ
 
is
 
Ú
 
¦ave
 
PIC


2635 
mov
 
bl
, [
nic_œq_numb”s
] ; 
G‘
 
IRQ
 
NIC
 0 (3C509B)

2636 
cmp
 
bl
, 8

2637 
jb
 .
ma¡”_eoi_3c509b


2639 ; 
SÏve
 
PIC
 
	`EOI
 (
IRQ
 8-15)

2640 
mov
 
®
, 0x60 ; 
S³cific
 
EOI


2641 
add
 
®
, 
bl


2642 
sub
 
®
, 8 ; 
Adju¡
 
¦ave


2643 
out
 
PIC2_COMMAND
, 
®
 ; 
S’d
 
to
 
¦ave
 
PIC


2644 
ÿÎ
 
io_d–ay


2645 
mov
 
®
, 0x62 ; 
EOI
 
	$IRQ2
 (
ÿsÿde
)

2646 
out
 
PIC1_COMMAND
, 
®
 ; 
S’d
 
to
 
ma¡”
 
PIC


2647 
jmp
 .
»¡Üe_ªd_ex™_3c509b


2649 .
ma¡”_eoi_3c509b
:

2650 ; 
Ma¡”
 
PIC
 
	`EOI
 (
IRQ
 0-7)

2651 
mov
 
®
, 0x60 ; 
S³cific
 
EOI


2652 
add
 
®
, 
bl


2653 
out
 
PIC1_COMMAND
, 
®
 ; 
S’d
 
EOI
 
to
 
ma¡”
 
PIC


2655 
jmp
 .
»¡Üe_ªd_ex™_3c509b


2657 .
¥urious_š‹¼u±_3c509b
:

2658 ; 
HªdË
 
¥urious
 
š‹¼u±


2659 
šc
 
wÜd
 
±r
 [
¥urious_œq_couÁ
]

2661 .
»¡Üe_ªd_ex™_3c509b
:

2662 ; 
Re¡Üe
 
»gi¡”s


2663 
ÿÎ
 
g‘_ıu_ã©u»s


2664 
‹¡
 
ax
, 1 ; 
Check
 
POPA
 
	`suµÜt
 (286+)

2665 
jz
 .
»¡Üe_mªu®_3c509b


2667 ; 
U£
 
POPA
 286+ 
CPUs


2668 
pİ
 
es


2669 
pİ
 
ds


2670 
pİa


2671 
œ‘


2673 .
»¡Üe_mªu®_3c509b
:

2674 ; 
Mªu®
 
»¡Ü©iÚ
 8086/8088

2675 
pİ
 
es


2676 
pİ
 
ds


2677 
pİ
 
di


2678 
pİ
 
si


2679 
pİ
 
dx


2680 
pİ
 
cx


2681 
pİ
 
bx


2682 
pİ
 
ax


2683 
œ‘


2684 
nic_œq_hªdËr_3c509b_b©ched
 
ENDP


2687 ; 
nic_œq_hªdËr_3c515_b©ched
 - 
Enhªûd
 3C515 
š‹¼u±
 
hªdËr
 
w™h
 
b©chšg


2688 ; 
This
 
is
 
the
 
’hªûd
 
ISR
 
th©
 
u£s
 
š‹¼u±
 
b©chšg
 
b‘‹r
 
³rfÜmªû


2690 ; 
IÅut
: 
	`NÚe
 (
š‹¼u±
 
cÚ‹xt
)

2691 ; 
Ouut
: 
NÚe


2692 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
§ved
/
»¡Üed
)

2694 
nic_œq_hªdËr_3c515_b©ched
 
PROC


2695 ; 
Check
 
CPU
 
ã©u»s
 
ªd
 
u£
 
­´İrŸ‹
 
§všg


2696 
ÿÎ
 
g‘_ıu_ã©u»s


2697 
‹¡
 
ax
, 1 ; 
Check
 
PUSHA
 
	`suµÜt
 (286+)

2698 
jz
 .
§ve_mªu®_3c515


2700 ; 
U£
 
PUSHA
 286+ 
CPUs


2701 
pusha


2702 
push
 
ds


2703 
push
 
es


2704 
jmp
 .
»gi¡”s_§ved_3c515


2706 .
§ve_mªu®_3c515
:

2707 ; 
Mªu®
 
§všg
 8086/8088

2708 
push
 
ax


2709 
push
 
bx


2710 
push
 
cx


2711 
push
 
dx


2712 
push
 
si


2713 
push
 
di


2714 
push
 
ds


2715 
push
 
es


2717 .
»gi¡”s_§ved_3c515
:

2718 ; 
S‘
 
up
 
our
 
d©a
 
£gm’t


2719 
push
 
cs


2720 
pİ
 
ds


2721 
ASSUME
 
DS
:
_TEXT


2723 ; 
Inüem’t
 
š‹¼u±
 
couÁ”


2724 
šc
 
wÜd
 
±r
 [
œq_couÁ
+2] ; 
Assumšg
 
NIC
 1

2726 ; 
C®l
 
’hªûd
 
b©ched
 
š‹¼u±
 
hªdËr
 3C515

2727 ; 
Proûss
 
muÉË
 
ev’ts
 
w™h
 
DMA
 
suµÜt


2728 
mov
 
by‹
 
±r
 [
b©ch_couÁ_3c515
], 0

2729 
mov
 
si
, 1 ; 
NIC
 
šdex
 3C515

2730 
ÿÎ
 
g‘_nic_ioba£


2731 
mov
 
dx
, 
ax
 ; 
DX
 = 
I
/
O
 
ba£


2732 
‹¡
 
dx
, dx

2733 
jz
 .
no_nic_3c515


2735 .
b©ch_loİ_3c515
:

2736 ; 
Check
 
b©ch
 
lim™


2737 
mov
 
®
, [
b©ch_couÁ_3c515
]

2738 
cmp
 
®
, 
MAX_EVENTS_PER_IRQ


2739 
j«
 .
b©ch_dÚe_3c515


2741 ; 
R—d
 
š‹¼u±
 
	`¡©us
 (32-
b™
 3C515)

2742 
push
 
dx


2743 
add
 
dx
, 0x0E ; 
INT_STATUS
 

2744 
š
 
ax
, 
dx
 ; 
R—d
 
¡©us


2745 
pİ
 
dx


2747 ; 
Check
 
DMA
 
š‹¼u±s
 
	$fœ¡
 (
high”
 
´iÜ™y
)

2748 
‹¡
 
ax
, 0x0600 ; 
UP_COMPLETE
 | 
DOWN_COMPLETE


2749 
jz
 .
check_nÜm®_3c515


2751 ; 
Proûss
 
DMA
 
ev’ts


2752 
push
 
ax


2753 
push
 
dx


2754 
‹¡
 
ax
, 0x0200 ; 
	$UP_COMPLETE
 (
RX
 
DMA
)

2755 
jz
 .
check_down_dma


2756 
ÿÎ
 
´oûss_3c515_rx_dma_ršg


2758 .
check_down_dma
:

2759 
‹¡
 
ax
, 0x0400 ; 
	$DOWN_COMPLETE
 (
TX
 
DMA
)

2760 
jz
 .
dma_dÚe


2761 
ÿÎ
 
´oûss_3c515_tx_com¶‘iÚs


2763 .
dma_dÚe
:

2764 
pİ
 
dx


2765 
pİ
 
ax


2767 ; 
AcknowËdge
 
DMA
 
š‹¼u±s


2768 
push
 
dx


2769 
add
 
dx
, 0x0E

2770 
mov
 
bx
, 
ax


2771 
ªd
 
bx
, 0x0600 ; 
DMA
 
š‹¼u±
 
b™s


2772 
Ü
 
bx
, 0x6800 ; 
ACK_INTR
 
commªd


2773 
mov
 
ax
, 
bx


2774 
out
 
dx
, 
ax


2775 
pİ
 
dx


2777 
jmp
 .
Ãxt_b©ch_3c515


2779 .
check_nÜm®_3c515
:

2780 ; 
Check
 
nÜm®
 
š‹¼u±s


2781 
‹¡
 
ax
, 0x00FF ; 
Snd¬d
 
š‹¼u±
 
b™s


2782 
jz
 .
b©ch_dÚe_3c515


2784 ; 
Proûss
 
¡ªd¬d
 
š‹¼u±s


2785 
push
 
ax


2786 
push
 
dx


2787 
mov
 
bx
, 
ax


2788 
ÿÎ
 
´oûss_3c515_ev’t


2789 
pİ
 
dx


2790 
pİ
 
ax


2792 ; 
AcknowËdge
 
´oûs£d
 
š‹¼u±s


2793 
push
 
dx


2794 
add
 
dx
, 0x0E

2795 
mov
 
bx
, 
ax


2796 
ªd
 
bx
, 0x00FF

2797 
Ü
 
bx
, 0x6800

2798 
mov
 
ax
, 
bx


2799 
out
 
dx
, 
ax


2800 
pİ
 
dx


2802 .
Ãxt_b©ch_3c515
:

2803 ; 
Inüem’t
 
b©ch
 
couÁ”


2804 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c515
]

2805 
jmp
 .
b©ch_loİ_3c515


2807 .
b©ch_dÚe_3c515
:

2808 ; 
Check
 
we
 
´oûs£d
 
ªy
 
ev’ts


2809 
cmp
 
by‹
 
±r
 [
b©ch_couÁ_3c515
], 0

2810 
je
 .
Œy_h¬dw¬e_3c515


2811 
xÜ
 
ax
,‡x ; 
Sucûss


2812 
jmp
 .
hªdËr_dÚe_3c515


2814 .
Œy_h¬dw¬e_3c515
:

2815 ; 
F®l
 
back
 
to
 
h¬dw¬e
 
hªdËr


2816 
ÿÎ
 
h¬dw¬e_hªdË_3c515_œq


2817 
jmp
 .
hªdËr_dÚe_3c515


2819 .
no_nic_3c515
:

2820 
mov
 
ax
, 1 ; 
NÙ
 
our
 
š‹¼u±


2822 .
hªdËr_dÚe_3c515
:

2823 ; 
AX
 
cÚšs
 
»suÉ


2824 
cmp
 
ax
, 0

2825 
jÃ
 .
¥urious_š‹¼u±_3c515


2827 ; 
S’d
 
EOI
 
to
 
š‹¼u±
 
cÚŒŞËr


2828 ; 
Check
 
IRQ
 
is
 
Ú
 
¦ave
 
PIC


2829 
mov
 
bl
, [
nic_œq_numb”s
+1] ; 
G‘
 
IRQ
 
NIC
 1 (3C515)

2830 
cmp
 
bl
, 8

2831 
jb
 .
ma¡”_eoi_3c515


2833 ; 
SÏve
 
PIC
 
	`EOI
 (
IRQ
 8-15)

2834 
mov
 
®
, 0x60 ; 
S³cific
 
EOI


2835 
add
 
®
, 
bl


2836 
sub
 
®
, 8 ; 
Adju¡
 
¦ave


2837 
out
 
PIC2_COMMAND
, 
®
 ; 
S’d
 
to
 
¦ave
 
PIC


2838 
ÿÎ
 
io_d–ay


2839 
mov
 
®
, 0x62 ; 
EOI
 
	$IRQ2
 (
ÿsÿde
)

2840 
out
 
PIC1_COMMAND
, 
®
 ; 
S’d
 
to
 
ma¡”
 
PIC


2841 
jmp
 .
»¡Üe_ªd_ex™_3c515


2843 .
ma¡”_eoi_3c515
:

2844 ; 
Ma¡”
 
PIC
 
	`EOI
 (
IRQ
 0-7)

2845 
mov
 
®
, 0x60 ; 
S³cific
 
EOI


2846 
add
 
®
, 
bl


2847 
out
 
PIC1_COMMAND
, 
®
 ; 
S’d
 
EOI
 
to
 
ma¡”
 
PIC


2849 
jmp
 .
»¡Üe_ªd_ex™_3c515


2851 .
¥urious_š‹¼u±_3c515
:

2852 ; 
HªdË
 
¥urious
 
š‹¼u±


2853 
šc
 
wÜd
 
±r
 [
¥urious_œq_couÁ
]

2855 .
»¡Üe_ªd_ex™_3c515
:

2856 ; 
Re¡Üe
 
»gi¡”s


2857 
ÿÎ
 
g‘_ıu_ã©u»s


2858 
‹¡
 
ax
, 1 ; 
Check
 
POPA
 
	`suµÜt
 (286+)

2859 
jz
 .
»¡Üe_mªu®_3c515


2861 ; 
U£
 
POPA
 286+ 
CPUs


2862 
pİ
 
es


2863 
pİ
 
ds


2864 
pİa


2865 
œ‘


2867 .
»¡Üe_mªu®_3c515
:

2868 ; 
Mªu®
 
»¡Ü©iÚ
 8086/8088

2869 
pİ
 
es


2870 
pİ
 
ds


2871 
pİ
 
di


2872 
pİ
 
si


2873 
pİ
 
dx


2874 
pİ
 
cx


2875 
pİ
 
bx


2876 
pİ
 
ax


2877 
œ‘


2878 
nic_œq_hªdËr_3c515_b©ched
 
ENDP


2881 ; 
CORE
 
IRQ
 
MANAGEMENT
 
SUPPORT
 
FUNCTIONS
 - 
Pha£
 2 
Im¶em’tiÚ


2882 ; 
Sub
-
Ag’t
 4: 
IRQ
 
CÜe
 
S³cŸli¡


2886 ; 
v®id©e_œq_¿nges
 - 
V®id©e
 
IRQ
 
assignm’ts
 
¬e
 
w™hš
 
®lowed
 
¿nges


2888 ; 
V®id©es
 
th©
 
®l
 
cÚfigu»d
 
IRQ
 
numb”s
 
¬e
 
š
 
®lowed
 
¿nges
:

2889 ; 
IRQ
 3, 5, 7, 9-12, 15 (
exşudes
 4,6,8,13,14 
which
 
¬e
 
sy¡em
 
»£rved
)

2891 ; 
IÅut
: 
NÚe


2892 ; 
Ouut
: 
CY
 
ş—r
 
v®id
, CY 
£t
 
šv®id


2893 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
SI


2895 
v®id©e_œq_¿nges
 
PROC


2896 
push
 
bx


2897 
push
 
cx


2898 
push
 
si


2900 
mov
 
cx
, 
MAX_NICS


2901 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


2903 .
check_loİ
:

2904 
mov
 
bl
, [
si
]

2905 
cmp
 
bl
, 
IRQ_NONE


2906 
je
 .
Ãxt_nic
 ; 
Sk
 
uÇssigÃd
 
IRQs


2908 ; 
Check
 
IRQ
 
is
 
š
 
v®id
 
¿nge


2909 
ÿÎ
 
is_v®id_œq_numb”


2910 
jc
 .
šv®id_¿nge


2912 .
Ãxt_nic
:

2913 
šc
 
si


2914 
loİ
 .
check_loİ


2916 
şc
 ; 
AÎ
 
IRQs
 
v®id


2917 
jmp
 .
ex™


2919 .
šv®id_¿nge
:

2920 
¡c
 ; 
Inv®id
 
IRQ
 
d‘eùed


2922 .
ex™
:

2923 
pİ
 
si


2924 
pİ
 
cx


2925 
pİ
 
bx


2926 
»t


2927 
v®id©e_œq_¿nges
 
ENDP


2930 ; 
is_v®id_œq_numb”
 - 
Check
 
sšgË
 
IRQ
 
numb”
 
is
 
v®id
 
NICs


2932 ; 
V®id
 
IRQ
 
numb”s
: 3, 5, 7, 9, 10, 11, 12, 15

2933 ; 
	$Inv®id
 (
sy¡em
 
»£rved
): 0-2, 4, 6, 8, 13, 14

2935 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”
 
to
 
v®id©e


2936 ; 
Ouut
: 
CY
 
ş—r
 
v®id
, CY 
£t
 
šv®id


2937 ; 
U£s
: 
	`NÚe
 (
´e£rves
 
®l
 
»gi¡”s
)

2939 
is_v®id_œq_numb”
 
PROC


2940 ; 
Check
 
basic
 
¿nge
 
fœ¡


2941 
cmp
 
bl
, 3

2942 
jb
 .
šv®id


2943 
cmp
 
bl
, 15

2944 
ja
 .
šv®id


2946 ; 
Check
 
¥ecific
 
fÜbidd’
 
v®ues


2947 
cmp
 
bl
, 4

2948 
je
 .
šv®id
 ; 
IRQ
 4 - 
COM1
/
COM3


2949 
cmp
 
bl
, 6

2950 
je
 .
šv®id
 ; 
IRQ
 6 - 
Flİpy


2951 
cmp
 
bl
, 8

2952 
je
 .
šv®id
 ; 
IRQ
 8 - 
RTC


2953 
cmp
 
bl
, 13

2954 
je
 .
šv®id
 ; 
IRQ
 13 - 
M©h
 
CİroûssÜ


2955 
cmp
 
bl
, 14

2956 
je
 .
šv®id
 ; 
IRQ
 14 - 
Prim¬y
 
IDE


2958 ; 
If
 
we
 
g‘
 
h”e
, 
IRQ
 
is
 
v®id


2959 
şc


2960 
»t


2962 .
šv®id
:

2963 
¡c


2964 
»t


2965 
is_v®id_œq_numb”
 
ENDP


2968 ; 
š™_pic_¡©e
 - 
In™Ÿlize
 
PIC
 
¡©e
 
Œackšg


2970 ; 
S‘s
 
up
 
š™Ÿl
 
¡©e
 
PIC
 
mªagem’t
 
ªd
 
»ads
 
cu¼’t
 
š‹¼u±
 
masks


2972 ; 
IÅut
: 
NÚe


2973 ; 
Ouut
: 
CY
 
ş—r
 
sucûssful
, CY 
£t
 
çed


2974 ; 
U£s
: 
AX
, 
DX


2976 
š™_pic_¡©e
 
PROC


2977 
push
 
ax


2978 
push
 
dx


2980 ; 
R—d
 
cu¼’t
 
PIC
 
masks
 
backup


2981 
mov
 
dx
, 
PIC1_DATA


2982 
š
 
®
, 
dx


2983 ; 
StÜe
 
ma¡”
 
PIC
 
mask
 
	$»¡Ü©iÚ
 (
would
 
Ãed
 
¡Üage
 
v¬ŸbË
)

2985 
mov
 
dx
, 
PIC2_DATA


2986 
š
 
®
, 
dx


2987 ; 
StÜe
 
¦ave
 
PIC
 
mask
 
	`»¡Ü©iÚ
 (
would
 
Ãed
 
¡Üage
 
v¬ŸbË
)

2989 ; 
In™Ÿlize
 
PIC
 
Œackšg
 
¡ruùu»s


2990 ; (
Im¶em’tiÚ
 
would
 
š™Ÿlize
 
Œackšg
 
¬¿ys
 
h”e
)

2992 
şc
 ; 
Sucûss


2994 
pİ
 
dx


2995 
pİ
 
ax


2996 
»t


2997 
š™_pic_¡©e
 
ENDP


3000 ; 
d‘eù_œq_cÚæiùs
 - 
D‘eù
 
pÙ’tŸl
 
IRQ
 
cÚæiùs


3002 ; 
Sÿns
 
pÙ’tŸl
 
IRQ
 
cÚæiùs
 
by
 
checkšg
 
wh©
 
deviûs
 
might
 
be


3003 ; 
usšg
 
the
 
IRQ
 
numb”s
 
we
 
wªt
 
to
 
assign


3005 ; 
IÅut
: 
NÚe


3006 ; 
Ouut
: 
AX
 = 
cÚæiù
 
	`mask
 (
b™s
 
£t
 
cÚæiùšg
 
IRQs
)

3007 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
SI


3009 
d‘eù_œq_cÚæiùs
 
PROC


3010 
push
 
bx


3011 
push
 
cx


3012 
push
 
si


3014 
xÜ
 
ax
,‡x ; 
CË¬
 
cÚæiù
 
mask


3015 
mov
 
cx
, 
MAX_NICS


3016 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


3018 .
cÚæiù_loİ
:

3019 
mov
 
bl
, [
si
]

3020 
cmp
 
bl
, 
IRQ_NONE


3021 
je
 .
Ãxt_cÚæiù


3023 ; 
Check
 
IRQ
 
might
 
	$cÚæiù
 (
sim¶if›d
 
check
)

3024 
ÿÎ
 
check_sšgË_œq_cÚæiù


3025 
jnc
 .
no_cÚæiù


3027 ; 
S‘
 
b™
 
š
 
cÚæiù
 
mask


3028 
mov
 
bh
, 1

3029 
mov
 
ş
, 
bl


3030 
shl
 
bh
, 
ş


3031 
Ü
 
®
, 
bh


3033 .
no_cÚæiù
:

3034 .
Ãxt_cÚæiù
:

3035 
šc
 
si


3036 
loİ
 .
cÚæiù_loİ


3038 
pİ
 
si


3039 
pİ
 
cx


3040 
pİ
 
bx


3041 
»t


3042 
d‘eù_œq_cÚæiùs
 
ENDP


3045 ; 
check_sšgË_œq_cÚæiù
 - 
Check
 
cÚæiùs
 
Ú
 
sšgË
 
IRQ


3047 ; 
P”fÜms
 
a
 
basic
 
cÚæiù
 
check
 ¨
sšgË
 
IRQ
 
numb”


3049 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”
 
to
 
check


3050 ; 
Ouut
: 
CY
 
ş—r
 
no
 
cÚæiù
, CY 
£t
 
pÙ’tŸl
 conflict

3051 ; 
U£s
: 
NÚe


3053 
check_sšgË_œq_cÚæiù
 
PROC


3054 ; 
This
 
is
 
a
 
sim¶if›d
 
cÚæiù
 
check


3055 ; 
In
 
fuÎ
 
im¶em’tiÚ
, 
would
 
check
:

3056 ; - 
H¬dw¬e
 
deviû
 
d‘eùiÚ


3057 ; - 
Oth”
 
TSRs
 
usšg
 
§me
 
IRQ


3058 ; - 
Sy¡em
 
deviû
 
assignm’ts


3060 ; 
FÜ
 
now
, 
assume
 
no
 
	$cÚæiùs
 (
cÚ£rv©ive
 
­´ßch
)

3061 
şc


3062 
»t


3063 
check_sšgË_œq_cÚæiù
 
ENDP


3066 ; 
auto_d‘eù_œqs
 - 
Auto
-
d‘eù
 
avaabË
 
IRQ
 
assignm’ts


3068 ; 
A‰em±s
 
to
 
autom©iÿÎy
 
d‘eù
 
good
 
IRQ
 
assignm’ts
 
NICs


3069 ; 
by
 
´obšg
 
h¬dw¬e
 
ªd
 
checkšg
 
avaab™y


3071 ; 
IÅut
: 
NÚe


3072 ; 
Ouut
: 
CY
 
ş—r
 
sucûssful
, CY 
£t
 
çed


3073 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
SI


3075 
auto_d‘eù_œqs
 
PROC


3076 
push
 
bx


3077 
push
 
cx


3078 
push
 
si


3080 ; 
Probe
 
commÚ
 
NIC
 
IRQ
 
assignm’ts
 
š
 
´iÜ™y
 
Üd”


3081 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


3083 ; 
Try
 
IRQ
 10 
fœ¡
 
	$NIC
 (
mo¡
 
commÚ
)

3084 
mov
 
bl
, 10

3085 
ÿÎ
 
is_œq_avaabË


3086 
jc
 .
Œy_œq11_fœ¡


3087 
mov
 [
si
], 
bl


3088 
jmp
 .
d‘eù_£cÚd


3090 .
Œy_œq11_fœ¡
:

3091 
mov
 
bl
, 11

3092 
ÿÎ
 
is_œq_avaabË


3093 
jc
 .
Œy_œq5_fœ¡


3094 
mov
 [
si
], 
bl


3095 
jmp
 .
d‘eù_£cÚd


3097 .
Œy_œq5_fœ¡
:

3098 
mov
 
bl
, 5

3099 
ÿÎ
 
is_œq_avaabË


3100 
jc
 .
autod‘eù_çed


3101 
mov
 [
si
], 
bl


3103 .
d‘eù_£cÚd
:

3104 ; 
Try
 
to
 
fšd
 
IRQ
 
£cÚd
 
NIC


3105 
šc
 
si


3106 
mov
 
bl
, 11

3107 
cmp
 
bl
, [
si
-1] ; 
DÚ
't use same‡s first NIC

3108 
je
 .
Œy_œq12_£cÚd


3109 
ÿÎ
 
is_œq_avaabË


3110 
jc
 .
Œy_œq12_£cÚd


3111 
mov
 [
si
], 
bl


3112 
jmp
 .
autod‘eù_sucûss


3114 .
Œy_œq12_£cÚd
:

3115 
mov
 
bl
, 12

3116 
cmp
 
bl
, [
si
-1] ; 
DÚ
't use same‡s first NIC

3117 
je
 .
Œy_œq9_£cÚd


3118 
ÿÎ
 
is_œq_avaabË


3119 
jc
 .
Œy_œq9_£cÚd


3120 
mov
 [
si
], 
bl


3121 
jmp
 .
autod‘eù_sucûss


3123 .
Œy_œq9_£cÚd
:

3124 
mov
 
bl
, 9

3125 
cmp
 
bl
, [
si
-1] ; 
DÚ
't use same‡s first NIC

3126 
je
 .
autod‘eù_·¹Ÿl


3127 
ÿÎ
 
is_œq_avaabË


3128 
jc
 .
autod‘eù_·¹Ÿl


3129 
mov
 [
si
], 
bl


3130 
jmp
 .
autod‘eù_sucûss


3132 .
autod‘eù_·¹Ÿl
:

3133 ; 
OÆy
 
fœ¡
 
NIC
 
d‘eùed
, 
m¬k
 
£cÚd
 
as
 
uÇssigÃd


3134 
mov
 
by‹
 
±r
 [
si
], 
IRQ_NONE


3135 
jmp
 .
autod‘eù_sucûss


3137 .
autod‘eù_sucûss
:

3138 
şc


3139 
jmp
 .
ex™


3141 .
autod‘eù_çed
:

3142 
¡c


3144 .
ex™
:

3145 
pİ
 
si


3146 
pİ
 
cx


3147 
pİ
 
bx


3148 
»t


3149 
auto_d‘eù_œqs
 
ENDP


3152 ; 
is_œq_avaabË
 - 
Check
 
IRQ
 
is
 
avaabË
 
u£


3154 ; 
Te¡s
 
ª
 
IRQ
 
lše
 
­³¬s
 
to
 
be
 
avaabË
 
by
 
checkšg
 
v¬ious
 
šdiÿtÜs


3156 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”
 
to
 
‹¡


3157 ; 
Ouut
: 
CY
 
ş—r
 
avaabË
, CY 
£t
 
š
 
u£


3158 ; 
U£s
: 
AX
, 
DX


3160 
is_œq_avaabË
 
PROC


3161 
push
 
ax


3162 
push
 
dx


3164 ; 
Fœ¡
 
v®id©e
 
the
 
IRQ
 
numb”


3165 
ÿÎ
 
is_v®id_œq_numb”


3166 
jc
 .
nÙ_avaabË


3168 ; 
Check
 
PIC
 
mask
 - 
IRQ
 
is
 
’abËd
, 
som‘hšg
 
might
 
be
 
usšg
 
™


3169 
ÿÎ
 
»ad_pic_mask


3170 
jc
 .
nÙ_avaabË


3172 ; 
Add™iÚ®
 
avaab™y
 
checks
 
could
 
be
 
added
 
h”e
:

3173 ; - 
Check
 
š‹¼u±
 
veùÜ
 
nÚ
- 
hªdËr


3174 ; - 
Probe
 
deviû
 
»¥Ú£
 
Ú
 
IRQ


3175 ; - 
Check
 
known
 
sy¡em
 
deviû
 
assignm’ts


3177 
şc
 ; 
Assume
 
avaabË


3178 
jmp
 .
ex™


3180 .
nÙ_avaabË
:

3181 
¡c


3183 .
ex™
:

3184 
pİ
 
dx


3185 
pİ
 
ax


3186 
»t


3187 
is_œq_avaabË
 
ENDP


3190 ; 
»ad_pic_mask
 - 
R—d
 
PIC
 
š‹¼u±
 
mask
 
IRQ


3192 ; 
R—ds
 
the
 
cu¼’t
 
š‹¼u±
 
mask
 
b™
 
¥ecif›d
 
IRQ


3194 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”


3195 ; 
Ouut
: 
CY
 
ş—r
 
	`masked
 (
di§bËd
), CY 
£t
 
’abËd


3196 ; 
U£s
: 
AX
, 
DX


3198 
»ad_pic_mask
 
PROC


3199 
push
 
ax


3200 
push
 
dx


3202 
cmp
 
bl
, 8

3203 
jl
 .
»ad_ma¡”


3205 ; 
R—d
 
¦ave
 
PIC
 
mask


3206 
mov
 
dx
, 
PIC2_DATA


3207 
š
 
®
, 
dx


3208 
sub
 
bl
, 8 ; 
CÚv”t
 
to
 
¦ave
 
	`IRQ
 (0-7)

3209 
jmp
 .
‹¡_b™


3211 .
»ad_ma¡”
:

3212 ; 
R—d
 
ma¡”
 
PIC
 
mask


3213 
mov
 
dx
, 
PIC1_DATA


3214 
š
 
®
, 
dx


3216 .
‹¡_b™
:

3217 ; 
Te¡
 
the
 
b™
 
this
 
IRQ


3218 
mov
 
ş
, 
bl


3219 
shr
 
®
, 
ş


3220 
ªd
 
®
, 1

3221 
cmp
 
®
, 0

3222 
je
 .
œq_’abËd
 ; 
B™
 0 = 
’abËd


3224 ; 
IRQ
 
is
 
	$masked
 (
di§bËd
)

3225 
şc


3226 
jmp
 .
ex™


3228 .
œq_’abËd
:

3229 ; 
IRQ
 
is
 
	$’abËd
 (
pÙ’tŸÎy
 
š
 
u£
)

3230 
¡c


3232 .
ex™
:

3233 
pİ
 
dx


3234 
pİ
 
ax


3235 
»t


3236 
»ad_pic_mask
 
ENDP


3239 ; 
­¶y_deçuÉ_œqs
 - 
Aµly
  
IRQ
 
assignm’ts


3241 ; 
S‘s
 
up
  
IRQ
 
assignm’ts
 
wh’
‡uto-
d‘eùiÚ
 
çs


3243 ; 
IÅut
: 
NÚe


3244 ; 
Ouut
: 
NÚe


3245 ; 
U£s
: 
AL
, 
SI


3247 
­¶y_deçuÉ_œqs
 
PROC


3248 
push
 
ax


3249 
push
 
si


3251 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


3252 
mov
 
by‹
 
±r
 [
si
], 10 ; 
DeçuÉ
 
IRQ
 10 
fœ¡
 
NIC


3253 
mov
 
by‹
 
±r
 [
si
+1], 11 ; 
DeçuÉ
 
IRQ
 11 
£cÚd
 
NIC


3255 
pİ
 
si


3256 
pİ
 
ax


3257 
»t


3258 
­¶y_deçuÉ_œqs
 
ENDP


3261 ; 
v®id©e_sšgË_œq_numb”
 - 
V®id©e
 
sšgË
 
IRQ
 
š
 
š¡®l_nic_œq
 
cÚ‹xt


3263 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”
, 
AL
 = 
NIC
 
šdex


3264 ; 
Ouut
: 
CY
 
ş—r
 
v®id
, CY 
£t
 
šv®id


3265 ; 
U£s
: 
	`NÚe
 (
´e£rves
 
®l
 
»gi¡”s
)

3267 
v®id©e_sšgË_œq_numb”
 
PROC


3268 
push
 
bx


3269 
ÿÎ
 
is_v®id_œq_numb”
 ; 
BL
 
®»ady
 
cÚšs
 
IRQ


3270 
pİ
 
bx


3271 
»t


3272 
v®id©e_sšgË_œq_numb”
 
ENDP


3275 ; 
check_œq_cÚæiù
 - 
Check
 
IRQ
 
cÚæiù
 
duršg
 
š¡®ÏtiÚ


3277 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”
, 
AL
 = 
NIC
 
šdex


3278 ; 
Ouut
: 
CY
 
ş—r
 
no
 
cÚæiù
, CY 
£t
 conflict

3279 ; 
U£s
: 
BX


3281 
check_œq_cÚæiù
 
PROC


3282 
ÿÎ
 
check_sšgË_œq_cÚæiù


3283 
»t


3284 
check_œq_cÚæiù
 
ENDP


3287 ; 
§ve_Üigš®_veùÜ
 - 
Save
 
Üigš®
 
š‹¼u±
 
veùÜ
 
befÜe
 
š¡®ÏtiÚ


3289 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”
, 
AL
 = 
NIC
 
šdex


3290 ; 
Ouut
: 
CY
 
ş—r
 
sucûssful
, CY 
£t
 
çed


3291 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
ES


3293 
§ve_Üigš®_veùÜ
 
PROC


3294 
push
 
ax


3295 
push
 
bx


3296 
push
 
cx


3297 
push
 
dx


3298 
push
 
es


3300 ; 
CÚv”t
 
IRQ
 
to
 
š‹¼u±
 
veùÜ
 
numb”


3301 
mov
 
ş
, 
bl


3302 
cmp
 
bl
, 8

3303 
jl
 .
ma¡”_œq


3305 ; 
SÏve
 
	`IRQ
 (8-15è-> 
INT
 70
h
-77h

3306 
add
 
ş
, 70
h
 - 8

3307 
jmp
 .
g‘_veùÜ


3309 .
ma¡”_œq
:

3310 ; 
Ma¡”
 
	`IRQ
 (0-7è-> 
INT
 08
h
-0Fh

3311 
add
 
ş
, 08
h


3313 .
g‘_veùÜ
:

3314 ; 
G‘
 
cu¼’t
 
veùÜ


3315 
mov
 
ah
, 35
h


3316 
mov
 
®
, 
ş


3317 21
h
 ; 
R‘uºs
 
ES
:
BX


3319 ; 
StÜe
 
Üigš®
 
	`veùÜ
 (
sim¶if›d
 - 
would
 
Ãed
 
´İ”
 
¡Üage
)

3320 ; 
In
 
fuÎ
 
im¶em’tiÚ
: 
¡Üe
 
ES
:
BX
 
š
 
Üigš®_œq_veùÜs
 
¬¿y


3322 
şc
 ; 
Sucûss


3324 
pİ
 
es


3325 
pİ
 
dx


3326 
pİ
 
cx


3327 
pİ
 
bx


3328 
pİ
 
ax


3329 
»t


3330 
§ve_Üigš®_veùÜ
 
ENDP


3333 ; 
š¡®l_œq_hªdËr
 - 
In¡®l
 
­´İrŸ‹
 
IRQ
 
hªdËr
 
NIC
 
ty³


3335 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”
, 
AL
 = 
NIC
 
šdex


3336 ; 
Ouut
: 
CY
 
ş—r
 
sucûssful
, CY 
£t
 
çed


3337 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


3339 
š¡®l_œq_hªdËr
 
PROC


3340 
push
 
ax


3341 
push
 
bx


3342 
push
 
cx


3343 
push
 
dx


3345 ; 
CÚv”t
 
IRQ
 
to
 
š‹¼u±
 
veùÜ


3346 
mov
 
ş
, 
bl


3347 
cmp
 
bl
, 8

3348 
jl
 .
ma¡”_œq_š¡®l


3350 
add
 
ş
, 70
h
 - 8 ; 
SÏve
 
IRQ
 
veùÜ


3351 
jmp
 .
š¡®l_veùÜ


3353 .
ma¡”_œq_š¡®l
:

3354 
add
 
ş
, 08
h
 ; 
Ma¡”
 
IRQ
 
veùÜ


3356 .
š¡®l_veùÜ
:

3357 ; 
D‘”mše
 
hªdËr
 
ba£d
 
Ú
 
NIC
 
šdex
/
ty³


3358 
cmp
 
®
, 0

3359 
je
 .
š¡®l_3c509b


3361 ; 
In¡®l
 3C515 
hªdËr


3362 
mov
 
dx
, 
OFFSET
 
nic_œq_hªdËr_3c515


3363 
jmp
 .
do_š¡®l


3365 .
š¡®l_3c509b
:

3366 ; 
In¡®l
 3C509B 
hªdËr


3367 
mov
 
dx
, 
OFFSET
 
nic_œq_hªdËr_3c509b


3369 .
do_š¡®l
:

3370 ; 
In¡®l
 
the
 
veùÜ


3371 
push
 
ds


3372 
mov
 
ax
, 
cs


3373 
mov
 
ds
, 
ax


3374 
mov
 
ah
, 25
h


3375 
mov
 
®
, 
ş


3376 21
h


3377 
pİ
 
ds


3379 
şc
 ; 
Sucûss


3381 
pİ
 
dx


3382 
pİ
 
cx


3383 
pİ
 
bx


3384 
pİ
 
ax


3385 
»t


3386 
š¡®l_œq_hªdËr
 
ENDP


3389 ; 
’abË_pic_œq
 - 
EÇbË
 
IRQ
 
©
 
PIC
 
Ëv–


3391 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”


3392 ; 
Ouut
: 
CY
 
ş—r
 
sucûssful
, CY 
£t
 
çed


3393 ; 
U£s
: 
AX
, 
CX
, 
DX


3395 
’abË_pic_œq
 
PROC


3396 
push
 
ax


3397 
push
 
cx


3398 
push
 
dx


3400 
cmp
 
bl
, 8

3401 
jl
 .
’abË_ma¡”


3403 ; 
EÇbË
 
¦ave
 
IRQ


3404 
mov
 
ş
, 
bl


3405 
sub
 
ş
, 8 ; 
CÚv”t
 
to
 
¦ave
 
b™
 
pos™iÚ


3406 
mov
 
®
, 1

3407 
shl
 
®
, 
ş
 ; 
C»©e
 
b™
 
mask


3408 
nÙ
 
®
 ; 
Inv”t
 
ş—ršg
 
b™


3410 
mov
 
dx
, 
PIC2_DATA


3411 
push
 
ax


3412 
š
 
®
, 
dx
 ; 
R—d
 
cu¼’t
 
mask


3413 
pİ
 
cx


3414 
ªd
 
®
, 
ş
 ; 
CË¬
 
the
 
IRQ
 
	$b™
 (
’abË
)

3415 
out
 
dx
, 
®
 ; 
Wr™e
 
back
 
mask


3417 ; 
Also
 
’su»
 
IRQ
 2 (
ÿsÿde
è
is
 
’abËd
 
Ú
 
ma¡”
 
PIC


3418 
mov
 
dx
, 
PIC1_DATA


3419 
š
 
®
, 
dx


3420 
ªd
 
®
, 11111011b ; 
CË¬
 
b™
 2 (
’abË
 
IRQ
 2)

3421 
out
 
dx
, 
®


3422 
jmp
 .
’abË_dÚe


3424 .
’abË_ma¡”
:

3425 ; 
EÇbË
 
ma¡”
 
IRQ


3426 
mov
 
ş
, 
bl


3427 
mov
 
®
, 1

3428 
shl
 
®
, 
ş
 ; 
C»©e
 
b™
 
mask


3429 
nÙ
 
®
 ; 
Inv”t
 
ş—ršg
 
b™


3431 
mov
 
dx
, 
PIC1_DATA


3432 
push
 
ax


3433 
š
 
®
, 
dx
 ; 
R—d
 
cu¼’t
 
mask


3434 
pİ
 
cx


3435 
ªd
 
®
, 
ş
 ; 
CË¬
 
the
 
IRQ
 
	$b™
 (
’abË
)

3436 
out
 
dx
, 
®
 ; 
Wr™e
 
back
 
mask


3438 .
’abË_dÚe
:

3439 
şc
 ; 
Sucûss


3441 
pİ
 
dx


3442 
pİ
 
cx


3443 
pİ
 
ax


3444 
»t


3445 
’abË_pic_œq
 
ENDP


3448 ; 
di§bË_pic_œq
 - 
Di§bË
 
IRQ
 
©
 
PIC
 
Ëv–


3450 ; 
IÅut
: 
BL
 = 
IRQ
 
numb”


3451 ; 
Ouut
: 
NÚe


3452 ; 
U£s
: 
AX
, 
CX
, 
DX


3454 
di§bË_pic_œq
 
PROC


3455 
push
 
ax


3456 
push
 
cx


3457 
push
 
dx


3459 
cmp
 
bl
, 8

3460 
jl
 .
di§bË_ma¡”


3462 ; 
Di§bË
 
¦ave
 
IRQ


3463 
mov
 
ş
, 
bl


3464 
sub
 
ş
, 8 ; 
CÚv”t
 
to
 
¦ave
 
b™
 
pos™iÚ


3465 
mov
 
®
, 1

3466 
shl
 
®
, 
ş
 ; 
C»©e
 
b™
 
mask


3468 
mov
 
dx
, 
PIC2_DATA


3469 
push
 
ax


3470 
š
 
®
, 
dx
 ; 
R—d
 
cu¼’t
 
mask


3471 
pİ
 
cx


3472 
Ü
 
®
, 
ş
 ; 
S‘
 
the
 
IRQ
 
	$b™
 (
di§bË
)

3473 
out
 
dx
, 
®
 ; 
Wr™e
 
back
 
mask


3474 
jmp
 .
di§bË_dÚe


3476 .
di§bË_ma¡”
:

3477 ; 
Di§bË
 
ma¡”
 
IRQ


3478 
mov
 
ş
, 
bl


3479 
mov
 
®
, 1

3480 
shl
 
®
, 
ş
 ; 
C»©e
 
b™
 
mask


3482 
mov
 
dx
, 
PIC1_DATA


3483 
push
 
ax


3484 
š
 
®
, 
dx
 ; 
R—d
 
cu¼’t
 
mask


3485 
pİ
 
cx


3486 
Ü
 
®
, 
ş
 ; 
S‘
 
the
 
IRQ
 
	$b™
 (
di§bË
)

3487 
out
 
dx
, 
®
 ; 
Wr™e
 
back
 
mask


3489 .
di§bË_dÚe
:

3490 
pİ
 
dx


3491 
pİ
 
cx


3492 
pİ
 
ax


3493 
»t


3494 
di§bË_pic_œq
 
ENDP


3497 ; 
upd©e_œq_Œackšg
 - 
Upd©e
 
IRQ
 
Œackšg
 
aá”
 
sucûssful
 
š¡®ÏtiÚ


3499 ; 
IÅut
: 
AL
 = 
NIC
 
šdex
, 
BL
 = 
IRQ
 
numb”


3500 ; 
Ouut
: 
NÚe


3501 ; 
U£s
: 
SI


3503 
upd©e_œq_Œackšg
 
PROC


3504 
push
 
si


3506 ; 
M¬k
 
IRQ
 
as
 
š¡®Ëd


3507 
mov
 
si
, 
OFFSET
 
œq_š¡®Ëd


3508 
mov
 
ah
, 0

3509 
add
 
si
, 
ax


3510 
mov
 
by‹
 
±r
 [
si
], 1

3512 
pİ
 
si


3513 
»t


3514 
upd©e_œq_Œackšg
 
ENDP


3517 ; 
g‘_nic_œq_numb”
 - 
G‘
 
IRQ
 
numb”
 
NIC
 
šdex


3519 ; 
IÅut
: 
AL
 = 
NIC
 
šdex


3520 ; 
Ouut
: 
BL
 = 
IRQ
 
numb”
, 
CY
 
£t
 
nÙ
 
assigÃd


3521 ; 
U£s
: 
BX
, 
SI


3523 
g‘_nic_œq_numb”
 
PROC


3524 
push
 
si


3526 
mov
 
si
, 
OFFSET
 
nic_œq_numb”s


3527 
mov
 
ah
, 0

3528 
add
 
si
, 
ax


3529 
mov
 
bl
, [
si
]

3531 
cmp
 
bl
, 
IRQ_NONE


3532 
je
 .
nÙ_assigÃd


3534 
şc
 ; 
Sucûss


3535 
jmp
 .
ex™


3537 .
nÙ_assigÃd
:

3538 
¡c
 ; 
NÙ
 
assigÃd


3540 .
ex™
:

3541 
pİ
 
si


3542 
»t


3543 
g‘_nic_œq_numb”
 
ENDP


3546 ; 
»¡Üe_Üigš®_veùÜ
 - 
Re¡Üe
 
Üigš®
 
š‹¼u±
 
veùÜ


3548 ; 
IÅut
: 
AL
 = 
NIC
 
šdex
, 
BL
 = 
IRQ
 
numb”


3549 ; 
Ouut
: 
NÚe


3550 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
ES


3552 
»¡Üe_Üigš®_veùÜ
 
PROC


3553 
push
 
ax


3554 
push
 
bx


3555 
push
 
cx


3556 
push
 
dx


3557 
push
 
es


3559 ; 
CÚv”t
 
IRQ
 
to
 
veùÜ
 
numb”


3560 
mov
 
ş
, 
bl


3561 
cmp
 
bl
, 8

3562 
jl
 .
ma¡”_»¡Üe


3564 
add
 
ş
, 70
h
 - 8 ; 
SÏve
 
veùÜ


3565 
jmp
 .
do_»¡Üe


3567 .
ma¡”_»¡Üe
:

3568 
add
 
ş
, 08
h
 ; 
Ma¡”
 
veùÜ


3570 .
do_»¡Üe
:

3571 ; 
Re¡Üe
 
	`veùÜ
 (
sim¶if›d
 - 
would
 
»ad
 
äom
 
¡Üage
)

3572 ; 
In
 
fuÎ
 
im¶em’tiÚ
: 
»¡Üe
 
äom
 
Üigš®_œq_veùÜs
 
¬¿y


3574 
pİ
 
es


3575 
pİ
 
dx


3576 
pİ
 
cx


3577 
pİ
 
bx


3578 
pİ
 
ax


3579 
»t


3580 
»¡Üe_Üigš®_veùÜ
 
ENDP


3583 ; 
ş—r_œq_Œackšg
 - 
CË¬
 
IRQ
 
Œackšg
 
šfÜm©iÚ


3585 ; 
IÅut
: 
AL
 = 
NIC
 
šdex


3586 ; 
Ouut
: 
NÚe


3587 ; 
U£s
: 
SI


3589 
ş—r_œq_Œackšg
 
PROC


3590 
push
 
si


3592 ; 
CË¬
 
š¡®Ëd
 
æag


3593 
mov
 
si
, 
OFFSET
 
œq_š¡®Ëd


3594 
mov
 
ah
, 0

3595 
add
 
si
, 
ax


3596 
mov
 
by‹
 
±r
 [
si
], 0

3598 
pİ
 
si


3599 
»t


3600 
ş—r_œq_Œackšg
 
ENDP


3603 ; 
upd©e_unš¡®l_Œackšg
 - 
Upd©e
 
Œackšg
 
aá”
 
unš¡®l


3605 ; 
IÅut
: 
AL
 = 
NIC
 
šdex


3606 ; 
Ouut
: 
NÚe


3607 ; 
U£s
: 
NÚe


3609 
upd©e_unš¡®l_Œackšg
 
PROC


3610 ; 
NÙhšg
 
add™iÚ®
 
Ãeded
 
basic
 
im¶em’tiÚ


3611 
»t


3612 
upd©e_unš¡®l_Œackšg
 
ENDP


3615 ; 
PUBLIC
 
ENTRY
 
POINTS
 
FOR
 
PIC
 
MANAGEMENT


3619 ; 
£nd_eoi_ma¡”
 - 
S’d
 
EOI
 
to
 
ma¡”
 
PIC
 
Úly


3621 ; 
Public
 
funùiÚ
 
£ndšg
 
EOI
 
to
 
ma¡”
 
	`PIC
 (
IRQ
 0-7)

3623 ; 
IÅut
: 
NÚe


3624 ; 
Ouut
: 
NÚe


3625 ; 
U£s
: 
AX
, 
	`DX
 (
but
 
´e£rves
 
them
)

3627 
PUBLIC
 
£nd_eoi_ma¡”


3628 
£nd_eoi_ma¡”
 
PROC


3629 
push
 
ax


3630 
push
 
dx


3632 
mov
 
®
, 
PIC_EOI


3633 
mov
 
dx
, 
PIC1_COMMAND


3634 
out
 
dx
, 
®


3636 
pİ
 
dx


3637 
pİ
 
ax


3638 
»t


3639 
£nd_eoi_ma¡”
 
ENDP


3642 ; 
£nd_eoi_¦ave
 - 
S’d
 
EOI
 
to
 
bÙh
 
¦ave
 
ªd
 
ma¡”
 
PICs


3644 ; 
Public
 
funùiÚ
 
£ndšg
 
EOI
 
¦ave
 
PIC
 
	`š‹¼u±s
 (
IRQ
 8-15)

3645 ; 
Mu¡
 
£nd
 
EOI
 
to
 
¦ave
 
fœ¡
, 
th’
 
	`ma¡”
 (
ÿsÿde
)

3647 ; 
IÅut
: 
NÚe


3648 ; 
Ouut
: 
NÚe


3649 ; 
U£s
: 
AX
, 
	`DX
 (
but
 
´e£rves
 
them
)

3651 
PUBLIC
 
£nd_eoi_¦ave


3652 
£nd_eoi_¦ave
 
PROC


3653 
push
 
ax


3654 
push
 
dx


3656 ; 
S’d
 
EOI
 
to
 
¦ave
 
PIC
 
fœ¡


3657 
mov
 
®
, 
PIC_EOI


3658 
mov
 
dx
, 
PIC2_COMMAND


3659 
out
 
dx
, 
®


3661 ; 
Th’
 
£nd
 
EOI
 
to
 
ma¡”
 
	$PIC
 (
ÿsÿde
)

3662 
mov
 
dx
, 
PIC1_COMMAND


3663 
out
 
dx
, 
®


3665 
pİ
 
dx


3666 
pİ
 
ax


3667 
»t


3668 
£nd_eoi_¦ave
 
ENDP


3671 ; 
£nd_eoi_fÜ_œq
 - 
S’d
 
­´İrŸ‹
 
EOI
 
ba£d
 
Ú
 
IRQ
 
numb”


3673 ; 
Public
 
funùiÚ
 
th©
 
autom©iÿÎy
 
£nds
 
EOI
 
to
 
cÜ»ù
 
	`PIC
(
s
)

3675 ; 
IÅut
: 
AL
 = 
IRQ
 
	`numb”
 (0-15)

3676 ; 
Ouut
: 
NÚe


3677 ; 
U£s
: 
AX
, 
	`DX
 (
but
 
´e£rves
 
Üigš®
 AX)

3679 
PUBLIC
 
£nd_eoi_fÜ_œq


3680 
£nd_eoi_fÜ_œq
 
PROC


3681 
push
 
ax


3682 
push
 
dx


3684 
cmp
 
®
, 8

3685 
jl
 .
ma¡”_eoi


3687 ; 
IRQ
 8-15: 
S’d
 
to
 
bÙh
 
PICs


3688 
ÿÎ
 
£nd_eoi_¦ave


3689 
jmp
 .
eoi_dÚe


3691 .
ma¡”_eoi
:

3692 ; 
IRQ
 0-7: 
S’d
 
to
 
ma¡”
 
Úly


3693 
ÿÎ
 
£nd_eoi_ma¡”


3695 .
eoi_dÚe
:

3696 
pİ
 
dx


3697 
pİ
 
ax


3698 
»t


3699 
£nd_eoi_fÜ_œq
 
ENDP


3702 ; 
’abË_œq_lše
 - 
Public
 
funùiÚ
 
to
 
’abË
 
¥ecific
 
IRQ


3704 ; 
IÅut
: 
AL
 = 
IRQ
 
	`numb”
 (0-15)

3705 ; 
Ouut
: 
CY
 
ş—r
 
sucûssful
, CY 
£t
 
çed


3706 ; 
U£s
: 
	`BX
 (
´e£rves
 
Ùh”
 
»gi¡”s
)

3708 
PUBLIC
 
’abË_œq_lše


3709 
’abË_œq_lše
 
PROC


3710 
push
 
bx


3712 
mov
 
bl
, 
®


3713 
ÿÎ
 
’abË_pic_œq


3715 
pİ
 
bx


3716 
»t


3717 
’abË_œq_lše
 
ENDP


3720 ; 
di§bË_œq_lše
 - 
Public
 
funùiÚ
 
to
 
di§bË
 
¥ecific
 
IRQ


3722 ; 
IÅut
: 
AL
 = 
IRQ
 
	`numb”
 (0-15)

3723 ; 
Ouut
: 
NÚe


3724 ; 
U£s
: 
	`BX
 (
´e£rves
 
Ùh”
 
»gi¡”s
)

3726 
PUBLIC
 
di§bË_œq_lše


3727 
di§bË_œq_lše
 
PROC


3728 
push
 
bx


3730 
mov
 
bl
, 
®


3731 
ÿÎ
 
di§bË_pic_œq


3733 
pİ
 
bx


3734 
»t


3735 
di§bË_œq_lše
 
ENDP


3738 ; 
SuµÜtšg
 
funùiÚs
 3C515-
TX
 
DMA
 
´oûssšg


3741 
´oûss_3c515_rx_dma_ršg
 
PROC


3742 ; 
Proûss
 
»ûived
 
·ck‘s
 
äom
 
DMA
 
desütÜ
 
ršg


3743 ; 
This
 
hªdËs
 
bus
-
ma¡”
 
DMA
 
com¶‘iÚ
 3C515-
TX


3744 
push
 
ax


3745 
push
 
bx


3746 
push
 
cx


3747 
push
 
dx


3748 
push
 
si


3750 ; 
G‘
 
DMA
 
desütÜ
 
ršg
 
¡©us


3751 ; 
FuÎ
 
DMA
 
desütÜ
 
ršg
 
im¶em’tiÚ


3752 
push
 
es


3753 
push
 
di


3754 
push
 
bx


3756 ; 
G‘
 
desütÜ
 
ršg
 
poš‹r


3757 
mov
 
si
, [
rx_dma_ršg_±r
]

3758 
‹¡
 
si
, si

3759 
jz
 .
no_ršg_cÚfigu»d


3761 
Ës
 
di
, [
rx_dma_ršg_ba£
] ; 
ES
:
DI
 = 
ršg
 
ba£


3762 
mov
 
cx
, 
MAX_EVENTS_PER_IRQ
 ; 
Proûss
 
lim™


3764 .
´oûss_desütÜs
:

3765 ; 
Check
 
desütÜ
 
¡©us


3766 
mov
 
ax
, 
es
:[
di
] ; 
Stus
 
wÜd


3767 
‹¡
 
ax
, 0x8000 ; 
Com¶‘e
 
b™


3768 
jz
 .
no_mÜe_rx
 ; 
NÙ
 
com¶‘e
, 
dÚe


3770 ; 
ExŒaù
 
·ck‘
 
Ëngth


3771 
ªd
 
ax
, 0x1FFF ; 13-
b™
 
Ëngth
 
f›ld


3772 
push
 
ax
 ; 
Save
 
Ëngth


3774 ; 
G‘
 
·ck‘
 
bufãr
 
add»ss


3775 
mov
 
bx
, 
es
:[
di
+4] ; 
Bufãr
 
low
 
wÜd


3776 
mov
 
dx
, 
es
:[
di
+6] ; 
Bufãr
 
high
 
wÜd


3778 ; 
Proûss
 
the
 
·ck‘


3779 
push
 
cx


3780 
push
 
di


3781 
push
 
dx


3782 
push
 
bx


3783 
push
 
ax
 ; 
L’gth


3784 
ÿÎ
 
´oûss_dma_·ck‘


3785 
add
 
¥
, 6 ; 
CËª
 
up
 
¡ack


3786 
pİ
 
di


3787 
pİ
 
cx


3788 
pİ
 
ax
 ; 
Re¡Üe
 
Ëngth


3790 ; 
M¬k
 
desütÜ
 
as
 
ä“


3791 
mov
 
wÜd
 
±r
 
es
:[
di
], 0 ; 
CË¬
 
¡©us


3793 ; 
AÎoÿ‹
 
Ãw
 
bufãr
 
this
 
desütÜ


3794 
push
 
cx


3795 
ÿÎ
 
®loÿ‹_rx_bufãr


3796 
jc
 .
®loc_çed


3798 ; 
Upd©e
 
desütÜ
 
w™h
 
Ãw
 
bufãr


3799 
mov
 
es
:[
di
+4], 
ax
 ; 
Bufãr
 
low


3800 
mov
 
es
:[
di
+6], 
dx
 ; 
Bufãr
 
high


3801 
mov
 
wÜd
 
±r
 
es
:[
di
+8], 1600 ; 
Max
 
size


3802 
mov
 
wÜd
 
±r
 
es
:[
di
], 0x8000 ; 
Give
 
to
 
NIC


3804 .
®loc_çed
:

3805 
pİ
 
cx


3807 ; 
Advªû
 
to
 
Ãxt
 
desütÜ


3808 
add
 
di
, 16 ; 
DesütÜ
 
size


3809 
cmp
 
di
, [
rx_dma_ršg_’d
]

3810 
jb
 .
no_w¿p


3811 
Ës
 
di
, [
rx_dma_ršg_ba£
] ; 
W¿p
 
to
 
¡¬t


3812 .
no_w¿p
:

3814 
loİ
 .
´oûss_desütÜs


3816 .
no_mÜe_rx
:

3817 ; 
Upd©e
 
ršg
 
poš‹r


3818 
mov
 [
rx_dma_ršg_±r
], 
di


3820 ; 
Refl
 
ªy
 
em±y
 
desütÜs


3821 
ÿÎ
 
»fl_rx_desütÜs


3823 .
no_ršg_cÚfigu»d
:

3824 
pİ
 
bx


3825 
pİ
 
di


3826 
pİ
 
es


3828 ; 
FÜ
 
now
, 
ju¡
 
acknowËdge
 
DMA
 
com¶‘iÚ


3829 
mov
 
dx
, 320
h
 ; 3C515-
TX
 
ba£


3830 
add
 
dx
, 20
h
 ; 
DMA_STATUS


3831 
š
 
®
, 
dx
 ; 
R—d
 
¡©us


3832 
‹¡
 
®
, 01
h
 ; 
RX_DMA_COMPLETE


3833 
jz
 .
no_rx_dma


3835 ; 
CË¬
 
RX
 
DMA
 
com¶‘iÚ
 
b™


3836 
mov
 
®
, 01
h


3837 
out
 
dx
, 
®
 ; 
Wr™e
 1 
to
 
ş—r


3839 .
no_rx_dma
:

3840 
pİ
 
si


3841 
pİ
 
dx


3842 
pİ
 
cx


3843 
pİ
 
bx


3844 
pİ
 
ax


3845 
»t


3846 
´oûss_3c515_rx_dma_ršg
 
ENDP


3848 
´oûss_3c515_tx_com¶‘iÚs
 
PROC


3849 ; 
Proûss
 
com¶‘ed
 
Œªsm™
 
DMA
 
Œªsãrs


3850 
push
 
ax


3851 
push
 
dx


3853 ; 
CË¬
 
TX
 
DMA
 
com¶‘iÚ
 
¡©us


3854 
mov
 
dx
, 320
h
 ; 3C515-
TX
 
ba£


3855 
add
 
dx
, 20
h
 ; 
DMA_STATUS


3856 
š
 
®
, 
dx
 ; 
R—d
 
¡©us


3857 
‹¡
 
®
, 02
h
 ; 
TX_DMA_COMPLETE


3858 
jz
 .
no_tx_dma


3860 ; 
CË¬
 
TX
 
DMA
 
com¶‘iÚ
 
b™


3861 
mov
 
®
, 02
h


3862 
out
 
dx
, 
®
 ; 
Wr™e
 1 
to
 
ş—r


3864 ; 
Proûss
 
com¶‘ed
 
TX
 
desütÜs


3865 
push
 
es


3866 
push
 
di


3867 
push
 
si


3868 
push
 
bx


3870 ; 
G‘
 
TX
 
desütÜ
 
ršg


3871 
mov
 
si
, [
tx_dma_ršg_±r
]

3872 
‹¡
 
si
, si

3873 
jz
 .
no_tx_ršg


3875 
Ës
 
di
, [
tx_dma_ršg_ba£
] ; 
ES
:
DI
 = 
TX
 
ršg


3876 
mov
 
cx
, 
MAX_EVENTS_PER_IRQ


3878 .
´oûss_tx_desc
:

3879 ; 
Check
 
desütÜ
 
¡©us


3880 
mov
 
ax
, 
es
:[
di
]

3881 
‹¡
 
ax
, 0x8000 ; 
Com¶‘e
 
b™


3882 
jz
 .
no_mÜe_tx


3884 ; 
Check
 
”rÜs


3885 
‹¡
 
ax
, 0x4000 ; 
E¼Ü
 
b™


3886 
jz
 .
tx_sucûss_dma


3888 ; 
HªdË
 
TX
 
”rÜ


3889 
šc
 
wÜd
 
±r
 [
tx_”rÜ_couÁ
]

3890 
ÿÎ
 
log_tx_dma_”rÜ


3891 
jmp
 .
ä“_tx_bufãr_dma


3893 .
tx_sucûss_dma
:

3894 ; 
Upd©e
 
sucûss
 
¡©i¡ics


3895 
šc
 
wÜd
 
±r
 [
tx_·ck‘_couÁ
]

3896 
mov
 
bx
, 
ax


3897 
ªd
 
bx
, 0x1FFF ; 
ExŒaù
 
Ëngth


3898 
add
 
wÜd
 
±r
 [
tx_by‹s_lo
], 
bx


3899 
adc
 
wÜd
 
±r
 [
tx_by‹s_hi
], 0

3901 .
ä“_tx_bufãr_dma
:

3902 ; 
F»e
 
the
 
Œªsm™‹d
 
bufãr


3903 
mov
 
ax
, 
es
:[
di
+4] ; 
Bufãr
 
low


3904 
mov
 
dx
, 
es
:[
di
+6] ; 
Bufãr
 
high


3905 
ÿÎ
 
ä“_tx_bufãr_addr


3907 ; 
CË¬
 
desütÜ


3908 
mov
 
dwÜd
 
±r
 
es
:[
di
], 0

3909 
mov
 
dwÜd
 
±r
 
es
:[
di
+4], 0

3910 
mov
 
dwÜd
 
±r
 
es
:[
di
+8], 0

3912 ; 
SigÇl
 
TX
 
com¶‘e


3913 
ÿÎ
 
sigÇl_tx_com¶‘e


3915 ; 
Advªû
 
to
 
Ãxt
 
desütÜ


3916 
add
 
di
, 16

3917 
cmp
 
di
, [
tx_dma_ršg_’d
]

3918 
jb
 .
no_tx_w¿p


3919 
Ës
 
di
, [
tx_dma_ršg_ba£
]

3920 .
no_tx_w¿p
:

3922 
loİ
 .
´oûss_tx_desc


3924 .
no_mÜe_tx
:

3925 ; 
Upd©e
 
TX
 
ršg
 
poš‹r


3926 
mov
 [
tx_dma_ršg_±r
], 
di


3928 .
no_tx_ršg
:

3929 
pİ
 
bx


3930 
pİ
 
si


3931 
pİ
 
di


3932 
pİ
 
es


3934 .
no_tx_dma
:

3935 
pİ
 
dx


3936 
pİ
 
ax


3937 
»t


3938 
´oûss_3c515_tx_com¶‘iÚs
 
ENDP


3941 ; 
Enhªûd
 
š‹¼u±
 
hªdËrs
 
w™h
 
	`b©chšg
 (
max
 10 
ev’ts
 
³r
 interrupt)

3944 
nic_´oûss_š‹¼u±_b©ch_3c509b
 
PROC


3945 ; 
Proûss
 3C509B 
š‹¼u±s
 
w™h
 
b©chšg
 
to
 
´ev’t
 
š‹¼u±
 
¡Üms


3946 ; 
Lim™s
 
´oûssšg
 
to
 
MAX_EVENTS_PER_IRQ
 
ev’ts
 
³r
 
š‹¼u±


3947 
push
 
ax


3948 
push
 
bx


3949 
push
 
cx


3950 
push
 
dx


3952 ; 
In™Ÿlize
 
b©ch
 
couÁ”


3953 
mov
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
], 0

3954 
mov
 
dx
, 300
h
 ; 3C509B 
ba£
 
I
/
O


3956 .
b©ch_loİ
:

3957 ; 
Check
 
we
've hithe batching†imit

3958 
cmp
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
], 
MAX_EVENTS_PER_IRQ


3959 
j«
 .
b©ch_com¶‘e
 ; 
H™
 
lim™
, 
deãr
 
»¡


3961 ; 
Check
 
š‹¼u±
 
cÚd™iÚs


3962 
add
 
dx
, 0E
h
 ; 
INT_STATUS
 

3963 
š
 
®
, 
dx
 ; 
R—d
 
š‹¼u±
 
¡©us


3964 
‹¡
 
®
, 3F
h
 ; 
Any
 
š‹¼u±
 
b™s
 
£t
?

3965 
jz
 .
b©ch_com¶‘e
 ; 
No
 
mÜe
 
š‹¼u±s


3967 ; 
Proûss
 
—ch
 
š‹¼u±
 
ty³
 
w™h
 
mšim®
 
wÜk


3968 
‹¡
 
®
, 01
h
 ; 
RX_COMPLETE


3969 
jz
 .
check_b©ch_tx


3971 ; 
Mšim®
 
RX
 
´oûssšg
 - 
ju¡
 
acknowËdge


3972 
ÿÎ
 
acknowËdge_3c509b_rx_mšim®


3973 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
]

3975 .
check_b©ch_tx
:

3976 
‹¡
 
®
, 02
h
 ; 
TX_COMPLETE


3977 
jz
 .
check_b©ch_”rÜs


3979 ; 
Mšim®
 
TX
 
´oûssšg
 - 
ju¡
 
acknowËdge


3980 
ÿÎ
 
acknowËdge_3c509b_tx_mšim®


3981 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
]

3983 .
check_b©ch_”rÜs
:

3984 
‹¡
 
®
, 0C
h
 ; 
TX_ERROR
 
Ü
 
RX_ERROR


3985 
jz
 .
b©ch_cÚtšue


3987 ; 
Mšim®
 
”rÜ
 
´oûssšg
 - 
acknowËdge
 
ªd
 
couÁ


3988 
ÿÎ
 
acknowËdge_3c509b_”rÜ_mšim®


3989 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
]

3991 .
b©ch_cÚtšue
:

3992 
sub
 
dx
, 0E
h
 ; 
Back
 
to
 
ba£


3993 
jmp
 .
b©ch_loİ
 ; 
Check
 
mÜe
 
ev’ts


3995 .
b©ch_com¶‘e
:

3996 ; 
If
 
we
 
h™
 
the
 
b©chšg
 
lim™
, 
queue
 
mÜe
 
wÜk
 
Ï‹r


3997 
cmp
 
by‹
 
±r
 [
b©ch_couÁ_3c509b
], 
MAX_EVENTS_PER_IRQ


3998 
jb
 .
b©chšg_dÚe


4000 ; 
Queue
 
deã¼ed
 
wÜk
 
to
 
´oûss
 
»maššg
 
š‹¼u±s


4001 
mov
 
ax
, 
OFFSET
 
´oûss_3c509b_·ck‘s


4002 
ÿÎ
 
queue_deã¼ed_wÜk


4004 .
b©chšg_dÚe
:

4005 
pİ
 
dx


4006 
pİ
 
cx


4007 
pİ
 
bx


4008 
pİ
 
ax


4009 
»t


4010 
nic_´oûss_š‹¼u±_b©ch_3c509b
 
ENDP


4012 
nic_´oûss_š‹¼u±_b©ch_3c515
 
PROC


4013 ; 
Proûss
 3C515-
TX
 
š‹¼u±s
 
w™h
 
b©chšg


4014 
push
 
ax


4015 
push
 
bx


4016 
push
 
cx


4017 
push
 
dx


4019 ; 
In™Ÿlize
 
b©ch
 
couÁ”


4020 
mov
 
by‹
 
±r
 [
b©ch_couÁ_3c515
], 0

4021 
mov
 
dx
, 320
h
 ; 3C515-
TX
 
ba£
 
I
/
O


4023 .
b©ch_loİ_3c515
:

4024 ; 
Check
 
b©chšg
 
lim™


4025 
cmp
 
by‹
 
±r
 [
b©ch_couÁ_3c515
], 
MAX_EVENTS_PER_IRQ


4026 
j«
 .
b©ch_com¶‘e_3c515


4028 ; 
S–eù
 
IÁStus
 
wšdow


4029 
add
 
dx
, 0E
h
 ; 
Commªd
 

4030 
mov
 
ax
, 7000
h
 ; 
Wšdow
 7

4031 
out
 
dx
, 
ax


4033 ; 
Check
 
š‹¼u±
 
¡©us


4034 
sub
 
dx
, 0E
h
 ; 
Back
 
to
 
ba£


4035 
add
 
dx
, 08
h
 ; 
IÁStus
 

4036 
š
 
ax
, 
dx
 ; 
R—d
 
š‹¼u±
 
¡©us


4037 
‹¡
 
ax
, 003F
h
 ; 
Any
 
¡ªd¬d
 
š‹¼u±s
?

4038 
jz
 .
check_3c515_dma
 ; 
Check
 
DMA
 
š‹¼u±s


4040 ; 
Proûss
 
¡ªd¬d
 
š‹¼u±s
 
mšim®ly


4041 
‹¡
 
ax
, 0001
h
 ; 
RxCom¶‘e


4042 
jz
 .
check_3c515_tx


4044 
ÿÎ
 
acknowËdge_3c515_rx_mšim®


4045 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c515
]

4047 .
check_3c515_tx
:

4048 
‹¡
 
ax
, 0002
h
 ; 
TxCom¶‘e


4049 
jz
 .
check_3c515_dma


4051 
ÿÎ
 
acknowËdge_3c515_tx_mšim®


4052 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c515
]

4054 .
check_3c515_dma
:

4055 ; 
Check
 
DMA
 
š‹¼u±s


4056 
sub
 
dx
, 08
h
 ; 
Back
 
to
 
ba£


4057 
add
 
dx
, 20
h
 ; 
DMA_STATUS


4058 
š
 
®
, 
dx
 ; 
R—d
 
DMA
 
¡©us


4059 
‹¡
 
®
, 03
h
 ; 
Any
 
DMA
 
š‹¼u±s
?

4060 
jz
 .
b©ch_cÚtšue_3c515


4062 ; 
AcknowËdge
 
DMA
 
š‹¼u±s
 
mšim®ly


4063 
out
 
dx
, 
®
 ; 
Wr™e
 
back
 
to
 
ş—r


4064 
šc
 
by‹
 
±r
 [
b©ch_couÁ_3c515
]

4066 .
b©ch_cÚtšue_3c515
:

4067 
sub
 
dx
, 20
h
 ; 
Back
 
to
 
ba£


4068 
jmp
 .
b©ch_loİ_3c515


4070 .
b©ch_com¶‘e_3c515
:

4071 ; 
Queue
 
deã¼ed
 
wÜk
 
we
 
h™
 
the
 
lim™


4072 
cmp
 
by‹
 
±r
 [
b©ch_couÁ_3c515
], 
MAX_EVENTS_PER_IRQ


4073 
jb
 .
b©chšg_dÚe_3c515


4075 
mov
 
ax
, 
OFFSET
 
´oûss_3c515_·ck‘s


4076 
ÿÎ
 
queue_deã¼ed_wÜk


4078 .
b©chšg_dÚe_3c515
:

4079 
pİ
 
dx


4080 
pİ
 
cx


4081 
pİ
 
bx


4082 
pİ
 
ax


4083 
»t


4084 
nic_´oûss_š‹¼u±_b©ch_3c515
 
ENDP


4087 ; 
Mšim®
 
acknowËdgm’t
 
funùiÚs
 
š‹¼u±
 
b©chšg


4090 
acknowËdge_3c509b_rx_mšim®
 
PROC


4091 ; 
Mšim®
 
RX
 
acknowËdgm’t
 
b©chšg


4092 
push
 
dx


4093 
push
 
ax


4094 
mov
 
dx
, 300
h


4095 
add
 
dx
, 0C
h
 ; 
RX_STATUS


4096 
š
 
ax
, 
dx
 ; 
R—d
 
to
 
acknowËdge


4097 
pİ
 
ax


4098 
pİ
 
dx


4099 
»t


4100 
acknowËdge_3c509b_rx_mšim®
 
ENDP


4102 
acknowËdge_3c509b_tx_mšim®
 
PROC


4103 ; 
Mšim®
 
TX
 
acknowËdgm’t
 
b©chšg


4104 
push
 
dx


4105 
push
 
ax


4106 
mov
 
dx
, 300
h


4107 
add
 
dx
, 0A
h
 ; 
TX_STATUS


4108 
š
 
®
, 
dx
 ; 
R—d
 
to
 
acknowËdge


4109 
pİ
 
ax


4110 
pİ
 
dx


4111 
»t


4112 
acknowËdge_3c509b_tx_mšim®
 
ENDP


4114 
acknowËdge_3c509b_”rÜ_mšim®
 
PROC


4115 ; 
Mšim®
 
”rÜ
 
acknowËdgm’t
 
b©chšg


4116 
push
 
dx


4117 
push
 
ax


4118 
mov
 
dx
, 300
h


4119 
add
 
dx
, 0E
h
 ; 
INT_STATUS


4120 
š
 
®
, 
dx
 ; 
R—d
 
to
 
ş—r


4121 
pİ
 
ax


4122 
pİ
 
dx


4123 
»t


4124 
acknowËdge_3c509b_”rÜ_mšim®
 
ENDP


4126 
acknowËdge_3c515_rx_mšim®
 
PROC


4127 ; 
Mšim®
 3C515-
TX
 
RX
 
acknowËdgm’t


4128 
push
 
dx


4129 
push
 
ax


4130 
mov
 
dx
, 320
h


4131 
add
 
dx
, 08
h
 ; 
	$IÁStus
 (
Wšdow
 7 
assumed
)

4132 
š
 
ax
, 
dx


4133 
ªd
 
ax
, 0001
h
 ; 
IsŞ©e
 
RxCom¶‘e


4134 
out
 
dx
, 
ax
 ; 
Wr™e
 1 
to
 
ş—r


4135 
pİ
 
ax


4136 
pİ
 
dx


4137 
»t


4138 
acknowËdge_3c515_rx_mšim®
 
ENDP


4140 
acknowËdge_3c515_tx_mšim®
 
PROC


4141 ; 
Mšim®
 3C515-
TX
 TX 
acknowËdgm’t


4142 
push
 
dx


4143 
push
 
ax


4144 
mov
 
dx
, 320
h


4145 
add
 
dx
, 08
h
 ; 
	$IÁStus
 (
Wšdow
 7 
assumed
)

4146 
š
 
ax
, 
dx


4147 
ªd
 
ax
, 0002
h
 ; 
IsŞ©e
 
TxCom¶‘e


4148 
out
 
dx
, 
ax
 ; 
Wr™e
 1 
to
 
ş—r


4149 
pİ
 
ax


4150 
pİ
 
dx


4151 
»t


4152 
acknowËdge_3c515_tx_mšim®
 
ENDP


4155 ; 
H–³r
 
FunùiÚs
 
IÁ”ru±
 
Hªdlšg


4158 ; 
I
/
O
 
d–ay
 
ISA
 
bus
 
timšg


4159 
io_d–ay
 
PROC


4160 
push
 
ax


4161 
š
 
®
, 80
h
 ; 
R—d
 
äom
 
unu£d
 
pÜt


4162 
š
 
®
, 80
h
 ; 
Two
 
»ads
 ~1Âµ
s
 
d–ay


4163 
pİ
 
ax


4164 
»t


4165 
io_d–ay
 
ENDP


4167 ; 
G‘
 
NIC
 
I
/
O
 
ba£
 
add»ss


4168 
g‘_nic_ioba£
 
PROC


4169 ; 
IÅut
: 
SI
 = 
NIC
 
šdex


4170 ; 
Ouut
: 
AX
 = 
I
/
O
 
ba£
 
add»ss


4171 
push
 
bx


4172 
movzx
 
bx
, 
si


4173 
shl
 
bx
, 1 ; 
WÜd
 
off£t


4174 
mov
 
ax
, [
nic_ioba£_bË
 + 
bx
]

4175 
pİ
 
bx


4176 
»t


4177 
g‘_nic_ioba£
 
ENDP


4179 ; 
Check
 
NIC
 
š‹¼u±
 
¡©us


4180 
check_nic_š‹¼u±_¡©us
 
PROC


4181 ; 
IÅut
: 
SI
 = 
NIC
 
šdex


4182 ; 
Ouut
: 
AX
 = 1 
š‹¼u±
 
³ndšg
, 0 
nÙ


4183 
push
 
dx


4184 
push
 
bx


4186 
ÿÎ
 
g‘_nic_ioba£


4187 
‹¡
 
ax
,‡x

4188 
jz
 .
no_š‹¼u±


4189 
mov
 
dx
, 
ax


4191 ; 
R—d
 
š‹¼u±
 
¡©us
 

4192 
add
 
dx
, 0x0E ; 
INT_STATUS
 
off£t


4193 
š
 
ax
, 
dx


4194 
‹¡
 
ax
, 0x00FF ; 
Check
 
ªy
 
š‹¼u±s


4195 
jz
 .
no_š‹¼u±


4197 
mov
 
ax
, 1 ; 
IÁ”ru±
 
³ndšg


4198 
jmp
 .
¡©us_dÚe


4200 .
no_š‹¼u±
:

4201 
xÜ
 
ax
,‡x ; 
No
 
š‹¼u±


4203 .
¡©us_dÚe
:

4204 
pİ
 
bx


4205 
pİ
 
dx


4206 
»t


4207 
check_nic_š‹¼u±_¡©us
 
ENDP


4209 ; 
HªdË
 
NIC
 
š‹¼u±


4210 
hªdË_nic_š‹¼u±
 
PROC


4211 ; 
IÅut
: 
SI
 = 
NIC
 
šdex
 
w™h
 
š‹¼u±


4212 
push
 
ax


4213 
push
 
bx


4214 
push
 
dx


4216 ; 
D‘”mše
 
NIC
 
ty³
 
ªd
 
ÿÎ
 
­´İrŸ‹
 
hªdËr


4217 
cmp
 
si
, 0

4218 
je
 .
hªdË_3c509b


4219 
cmp
 
si
, 1

4220 
je
 .
hªdË_3c515


4221 
jmp
 .
dÚe


4223 .
hªdË_3c509b
:

4224 
ÿÎ
 
h¬dw¬e_hªdË_3c509b_œq


4225 
jmp
 .
dÚe


4227 .
hªdË_3c515
:

4228 
ÿÎ
 
h¬dw¬e_hªdË_3c515_œq


4230 .
dÚe
:

4231 
pİ
 
dx


4232 
pİ
 
bx


4233 
pİ
 
ax


4234 
»t


4235 
hªdË_nic_š‹¼u±
 
ENDP


4237 ; 
Proûss
 3C509B 
š‹¼u±s


4238 
´oûss_3c509b_š‹¼u±s
 
PROC


4239 ; 
IÅut
: 
BX
 = 
š‹¼u±
 
¡©us
, 
DX
 = 
I
/
O
 
ba£


4240 
push
 
ax


4241 
push
 
cx


4243 ; 
Proûss
 
—ch
 
š‹¼u±
 
ty³


4244 
‹¡
 
bx
, 0x0001 ; 
RX_COMPLETE


4245 
jz
 .
no_rx


4246 
ÿÎ
 
hªdË_rx_š‹¼u±_3c509b


4247 .
no_rx
:

4248 
‹¡
 
bx
, 0x0004 ; 
TX_COMPLETE


4249 
jz
 .
no_tx


4250 
ÿÎ
 
hªdË_tx_š‹¼u±_3c509b


4251 .
no_tx
:

4252 
‹¡
 
bx
, 0x0080 ; 
ADAPTER_FAIL


4253 
jz
 .
no_ç


4254 
ÿÎ
 
hªdË_ad­‹r_çu»_3c509b


4255 .
no_ç
:

4257 ; 
AcknowËdge
 
®l
 
´oûs£d
 
š‹¼u±s


4258 
mov
 
ax
, 
bx


4259 
ªd
 
ax
, 0x00FF

4260 
Ü
 
ax
, 0x6800 ; 
ACK_INTR
 
commªd


4261 
add
 
dx
, 0x0E

4262 
out
 
dx
, 
ax


4264 
pİ
 
cx


4265 
pİ
 
ax


4266 
»t


4267 
´oûss_3c509b_š‹¼u±s
 
ENDP


4269 ; 
Proûss
 
sšgË
 3C509B 
ev’t


4270 
´oûss_3c509b_ev’t
 
PROC


4271 ; 
IÅut
: 
BX
 = 
š‹¼u±
 
¡©us
, 
DX
 = 
I
/
O
 
ba£


4272 
push
 
ax


4274 ; 
Sim¬
 
to
 
´oûss_3c509b_š‹¼u±s
 
but
 
sšgË
 
ev’t


4275 
‹¡
 
bx
, 0x0001

4276 
jz
 .
check_tx


4277 
ÿÎ
 
hªdË_rx_š‹¼u±_3c509b


4278 
jmp
 .
ev’t_dÚe


4280 .
check_tx
:

4281 
‹¡
 
bx
, 0x0004

4282 
jz
 .
check_”rÜ


4283 
ÿÎ
 
hªdË_tx_š‹¼u±_3c509b


4284 
jmp
 .
ev’t_dÚe


4286 .
check_”rÜ
:

4287 
‹¡
 
bx
, 0x00F8 ; 
Any
 
”rÜ
 
b™s


4288 
jz
 .
ev’t_dÚe


4289 
ÿÎ
 
hªdË_”rÜ_š‹¼u±_3c509b


4291 .
ev’t_dÚe
:

4292 
pİ
 
ax


4293 
»t


4294 
´oûss_3c509b_ev’t
 
ENDP


4296 ; 
Proûss
 
sšgË
 3C515 
ev’t


4297 
´oûss_3c515_ev’t
 
PROC


4298 ; 
IÅut
: 
BX
 = 
š‹¼u±
 
¡©us
, 
DX
 = 
I
/
O
 
ba£


4299 
push
 
ax


4301 ; 
Check
 
DMA
 
ev’ts
 
fœ¡


4302 
‹¡
 
bx
, 0x0200 ; 
UP_COMPLETE


4303 
jz
 .
check_down


4304 
ÿÎ
 
´oûss_3c515_rx_dma_ršg


4305 
jmp
 .
ev’t_dÚe_515


4307 .
check_down
:

4308 
‹¡
 
bx
, 0x0400 ; 
DOWN_COMPLETE


4309 
jz
 .
check_nÜm®


4310 
ÿÎ
 
´oûss_3c515_tx_com¶‘iÚs


4311 
jmp
 .
ev’t_dÚe_515


4313 .
check_nÜm®
:

4314 ; 
Proûss
 
nÜm®
 
š‹¼u±s


4315 
‹¡
 
bx
, 0x0001 ; 
RX_COMPLETE


4316 
jz
 .
check_tx_515


4317 
ÿÎ
 
hªdË_rx_š‹¼u±_3c515


4318 
jmp
 .
ev’t_dÚe_515


4320 .
check_tx_515
:

4321 
‹¡
 
bx
, 0x0004 ; 
TX_COMPLETE


4322 
jz
 .
ev’t_dÚe_515


4323 
ÿÎ
 
hªdË_tx_š‹¼u±_3c515


4325 .
ev’t_dÚe_515
:

4326 
pİ
 
ax


4327 
»t


4328 
´oûss_3c515_ev’t
 
ENDP


4330 ; 
Loggšg
 
	`funùiÚs
 (
¡ubs
 - 
im¶em’t
 
ba£d
 
Ú
 
your
 
loggšg
 
sy¡em
)

4331 
log_rx_”rÜ
 
PROC


4332 
»t


4333 
log_rx_”rÜ
 
ENDP


4335 
log_rx_”rÜ_d‘as
 
PROC


4336 
»t


4337 
log_rx_”rÜ_d‘as
 
ENDP


4339 
log_tx_dma_”rÜ
 
PROC


4340 
»t


4341 
log_tx_dma_”rÜ
 
ENDP


4343 
hªdË_tx_”rÜ
 
PROC


4344 
»t


4345 
hªdË_tx_”rÜ
 
ENDP


4347 ; 
Bufãr
 
mªagem’t
 
funùiÚs


4348 
ä“_tx_bufãr
 
PROC


4349 ; 
IÅut
: 
SI
 = 
bufãr
 
poš‹r


4350 
»t


4351 
ä“_tx_bufãr
 
ENDP


4353 
ä“_cu¼’t_tx_bufãr
 
PROC


4354 
push
 
si


4355 
mov
 
si
, [
cu¼’t_tx_bufãr
]

4356 
‹¡
 
si
, si

4357 
jz
 .
no_bufãr


4358 
ÿÎ
 
ä“_tx_bufãr


4359 
mov
 
wÜd
 
±r
 [
cu¼’t_tx_bufãr
], 0

4360 .
no_bufãr
:

4361 
pİ
 
si


4362 
»t


4363 
ä“_cu¼’t_tx_bufãr
 
ENDP


4365 
ä“_tx_bufãr_addr
 
PROC


4366 ; 
IÅut
: 
DX
:
AX
 = 
bufãr
 
add»ss


4367 
»t


4368 
ä“_tx_bufãr_addr
 
ENDP


4370 
ä“_dma_bufãrs
 
PROC


4371 
»t


4372 
ä“_dma_bufãrs
 
ENDP


4374 
®loÿ‹_rx_bufãr
 
PROC


4375 ; 
Ouut
: 
DX
:
AX
 = 
bufãr
 
add»ss
, 
CF
 = 
”rÜ


4376 
xÜ
 
dx
, dx

4377 
mov
 
ax
, 
‹mp_rx_bufãr


4378 
şc


4379 
»t


4380 
®loÿ‹_rx_bufãr
 
ENDP


4382 
»fl_rx_desütÜs
 
PROC


4383 
»t


4384 
»fl_rx_desütÜs
 
ENDP


4386 ; 
T¿nsmissiÚ
 
»Œy


4387 
»Œy_ŒªsmissiÚ
 
PROC


4388 
»t


4389 
»Œy_ŒªsmissiÚ
 
ENDP


4391 ; 
DMA
 
·ck‘
 
´oûssšg


4392 
´oûss_dma_·ck‘
 
PROC


4393 ; 
IÅut
: 
Sck
 
has
 
bufãr
 
add»ss
 
ªd
 
Ëngth


4394 
»t


4395 
´oûss_dma_·ck‘
 
ENDP


4397 ; 
SigÇl
 
TX
 
com¶‘iÚ


4398 
sigÇl_tx_com¶‘e
 
PROC


4399 
»t


4400 
sigÇl_tx_com¶‘e
 
ENDP


4402 ; 
IÁ”ru±
 
hªdËrs
 
¥ecific
 
ev’ts


4403 
hªdË_rx_š‹¼u±_3c509b
 
PROC


4404 
»t


4405 
hªdË_rx_š‹¼u±_3c509b
 
ENDP


4407 
hªdË_tx_š‹¼u±_3c509b
 
PROC


4408 
»t


4409 
hªdË_tx_š‹¼u±_3c509b
 
ENDP


4411 
hªdË_ad­‹r_çu»_3c509b
 
PROC


4412 
»t


4413 
hªdË_ad­‹r_çu»_3c509b
 
ENDP


4415 
hªdË_”rÜ_š‹¼u±_3c509b
 
PROC


4416 
»t


4417 
hªdË_”rÜ_š‹¼u±_3c509b
 
ENDP


4419 
hªdË_rx_š‹¼u±_3c515
 
PROC


4420 
»t


4421 
hªdË_rx_š‹¼u±_3c515
 
ENDP


4423 
hªdË_tx_š‹¼u±_3c515
 
PROC


4424 
»t


4425 
hªdË_tx_š‹¼u±_3c515
 
ENDP


4428 ; 
STACK
 
OVERFLOW
 
PROTECTION
 
FUNCTIONS


4432 ; 
check_ÿÇry_¬—
 - 
G’”ic
 16-
b™
 
ÿÇry
 
¬—
 
check”


4433 ; 
IN
: 
DS
:
SI
 = 
¡¬t
 
of
 
ÿÇry
 
¬—


4434 ; 
CX
 = 
numb”
 
of
 
wÜds
 
to
 
	`check
 (
nÙ
 
dwÜds
!)

4435 ; 
OUT
: 
AL
 = 1 (
ZF
=1è
®l
 
good
, AL = 0 (ZF=0è
Ú
 
fœ¡
 
mism©ch


4436 ; 
Clobb”s
: 
AX
, 
DX
, 
SI
, 
CX
. 
FÏgs
 
»æeù
 
	`AL
 (
vŸ
 
OR
 
AL
,AL).

4437 ; 
P»£rves
: 
BX
, 
DI
, 
ES
, 
BP


4438 ; 
NÙe
: 
DesigÃd
 8086, 
u£s
 16-
b™
 
İs
 
Úly
.

4440 
check_ÿÇry_¬—
 
PROC


4441 
mov
 
dx
, 
CANARY_WORD_LO
 ; 
Ex³ùed
 
·‰”n


4442 @@
Ãxt
:

4443 
cmp
 
cx
, 0

4444 
je
 @
ok


4446 ; 
Com·»
 
cu¼’t
 
wÜd
 
w™h
 
ex³ùed
 
·‰”n


4447 
cmp
 
wÜd
 
±r
 [
si
], 
dx


4448 
jÃ
 @
bad


4450 
add
 
si
, 2 ; 
Next
 
wÜd


4451 
dec
 
cx


4452 
jmp
 @@
Ãxt


4454 @
ok
:

4455 
mov
 
®
, 1

4456 
Ü
 
®
,‡l

4457 
»t


4459 @
bad
:

4460 
xÜ
 
®
,‡l

4461 
Ü
 
®
,‡l

4462 
»t


4463 
check_ÿÇry_¬—
 
ENDP


4466 ; 
check_¡ack_ÿÇr›s
 - 
V®id©e
 
IRQ
 
¡ack
 
ÿÇry
 
	`·‰”ns
 (16-
b™
 
com·tibË
)

4468 ; 
Checks
 
®l
 
¡ack
 
ÿÇry
 
·‰”ns
 
cÜru±iÚ
 
šdiÿtšg
 
ov”æow
.

4469 ; 
Should
 
be
 
ÿÎed
 
³riodiÿÎy
 
ªd
 
aá”
 
su¥eùed
 
¡ack
-
š‹nsive
 
İ”©iÚs
.

4471 ; 
IÅut
: 
	`NÚe
 (
DS
 
mu¡
 
be
 
DGROUP
/
_DATA
)

4472 ; 
Ouut
: 
AX
 = 
numb”
 
of
 
cÜru±ed
 
ÿÇry
 
	`¬—s
 (0 = 
®l
 
OK
)

4473 ; 
U£s
: 
AX
, 
CX
, 
DX
, 
SI


4475 
PUBLIC
 
check_¡ack_ÿÇr›s


4476 
check_¡ack_ÿÇr›s
 
PROC


4477 
push
 
cx


4478 
push
 
dx


4479 
push
 
si


4481 
xÜ
 
ax
,‡x ; 
CouÁ
 
of
 
cÜru±ed
 
ÿÇry
 
¬—s


4483 ; 
Check
 3C509B 
¡ack
 
ÿÇr›s


4484 
mov
 
si
, 
OFFSET
 
œq_¡ack_3c509b_ÿÇry


4485 
mov
 
cx
, 8 ; 8 
wÜds
 
to
 
check


4486 
ÿÎ
 
check_ÿÇry_¬—


4487 
Ü
 
®
,‡È; 
Check
 
»suÉ


4488 
jnz
 .3c509b
_ok


4489 
šc
 
ax
 ; 
CouÁ
 
	$cÜru±iÚ
 (
AX
 
was
 0)

4490 
šc
 
wÜd
 
±r
 [
¡ack_ov”æow_3c509b
] ; 
Upd©e
 
ov”æow
 
couÁ”


4492 ; 
EMERGENCY
: 3C509B 
¡ack
 
ÿÇry
 
cÜru±iÚ
 
d‘eùed


4493 
push
 
ax
 ; 
Save
 
cÜru±iÚ
 
couÁ


4494 
mov
 
®
, 3 ; 
IRQ
 3C509B (
exam¶e
)

4495 
ÿÎ
 
em”g’cy_ÿÇry_»¥Ú£


4496 
pİ
 
ax
 ; 
Re¡Üe
 
cÜru±iÚ
 
couÁ


4498 .3c509b
_ok
:

4499 ; 
Check
 3C515 
¡ack
 
ÿÇr›s


4500 
mov
 
si
, 
OFFSET
 
œq_¡ack_3c515_ÿÇry


4501 
mov
 
cx
, 8 ; 8 
wÜds
 
to
 
check


4502 
push
 
ax
 ; 
Save
 
cÜru±iÚ
 
couÁ


4503 
ÿÎ
 
check_ÿÇry_¬—


4504 
pİ
 
dx
 ; 
Re¡Üe
 
cÜru±iÚ
 
couÁ
 
to
 
DX


4505 
Ü
 
®
,‡È; 
Check
 
»suÉ


4506 
jnz
 .3c515
_ok


4507 
šc
 
dx
 ; 
CouÁ
 
cÜru±iÚ


4508 
šc
 
wÜd
 
±r
 [
¡ack_ov”æow_3c515
] ; 
Upd©e
 
ov”æow
 
couÁ”


4510 ; 
EMERGENCY
: 3C515 
¡ack
 
ÿÇry
 
cÜru±iÚ
 
d‘eùed


4511 
push
 
dx
 ; 
Save
 
cÜru±iÚ
 
couÁ


4512 
mov
 
®
, 5 ; 
IRQ
 3C515 (
exam¶e
)

4513 
ÿÎ
 
em”g’cy_ÿÇry_»¥Ú£


4514 
pİ
 
dx
 ; 
Re¡Üe
 
cÜru±iÚ
 
couÁ


4516 .3c515
_ok
:

4517 
mov
 
ax
, 
dx
 ; 
R‘uº
 
tÙ®
 
cÜru±iÚ
 
couÁ


4519 
pİ
 
si


4520 
pİ
 
dx


4521 
pİ
 
cx


4522 
»t


4523 
check_¡ack_ÿÇr›s
 
ENDP


4526 ; 
š™Ÿlize_¡ack_ÿÇr›s
 - 
In™Ÿlize
 
®l
 
¡ack
 
ÿÇry
 
	`·‰”ns
 (16-
b™
 
com·tibË
)

4528 ; 
C®l
 
this
 
duršg
 
driv”
 
š™Ÿliz©iÚ
 
to
 
£t
 
up
 
¡ack
 
ov”æow
 
d‘eùiÚ
.

4530 ; 
IÅut
: 
	`NÚe
 (
DS
 
mu¡
 
be
 
DGROUP
/
_DATA
)

4531 ; 
Ouut
: 
NÚe


4532 ; 
U£s
: 
AX
, 
CX
, 
DI


4534 
PUBLIC
 
š™Ÿlize_¡ack_ÿÇr›s


4535 
š™Ÿlize_¡ack_ÿÇr›s
 
PROC


4536 
push
 
ax


4537 
push
 
cx


4538 
push
 
di


4540 ; 
In™Ÿlize
 3C509B 
ÿÇr›s
 
w™h
 16-
b™
 
wÜd
 
·‰”n


4541 
mov
 
di
, 
OFFSET
 
œq_¡ack_3c509b_ÿÇry


4542 
mov
 
ax
, 
CANARY_WORD_LO
 ; 16-
b™
 
ÿÇry
 
·‰”n


4543 
mov
 
cx
, 8 ; 8 
	$wÜds
 (16 
by‹s
 
tÙ®
)

4544 
»p
 
¡osw


4546 ; 
In™Ÿlize
 3C515 
ÿÇr›s
 
w™h
 16-
b™
 
wÜd
 
·‰”n


4547 
mov
 
di
, 
OFFSET
 
œq_¡ack_3c515_ÿÇry


4548 
mov
 
ax
, 
CANARY_WORD_LO
 ; 16-
b™
 
ÿÇry
 
·‰”n


4549 
mov
 
cx
, 8 ; 8 
	$wÜds
 (16 
by‹s
 
tÙ®
)

4550 
»p
 
¡osw


4552 ; 
CË¬
 
ov”æow
 
couÁ”s


4553 
mov
 
wÜd
 
±r
 [
¡ack_ov”æow_3c509b
], 0

4554 
mov
 
wÜd
 
±r
 [
¡ack_ov”æow_3c515
], 0

4556 
pİ
 
di


4557 
pİ
 
cx


4558 
pİ
 
ax


4559 
»t


4560 
š™Ÿlize_¡ack_ÿÇr›s
 
ENDP


4563 ; 
em”g’cy_ÿÇry_»¥Ú£
 - 
Em”g’cy
 
»¥Ú£
 
to
 
¡ack
 
ÿÇry
 
cÜru±iÚ


4565 ; 
C®Ëd
 
wh’
 
¡ack
 
ÿÇry
 
cÜru±iÚ
 
is
 
d‘eùed
. 
Im¶em’ts
 
immedŸ‹


4566 ; 
´Ùeùive
 
m—su»s
 
to
 
´ev’t
 
fu¹h”
 
damage
.

4568 ; 
IÅut
: 
AL
 = 
IRQ
 
numb”
 
of
 
afãùed
 
	`¡ack
 (
u£d
 
maskšg
)

4569 ; 
Ouut
: 
	`NÚe
 (
may
 
nÙ
  
š
 
£v”e
 
ÿ£s
)

4570 ; 
P»£rves
: 
AÎ
 
»gi¡”s
 
ªd
 
	`æags
 (
vŸ
 
push
/
pİ
)

4571 ; 
Side
 
Efãùs
:

4572 ; - 
S’ds
 
EOI
 
to
 
bÙh
 
PICs
 
uncÚd™iÚ®ly


4573 ; - 
Masks
 
the
 
¥ecif›d
 
IRQ
 
©
 
PIC
 
Ëv–


4574 ; - 
Inüem’ts
 
em”g’cy_ÿÇry_couÁ


4575 ; - 
Reš™Ÿlizes
 
cÜru±ed
 
ÿÇry
 
·‰”n


4576 ; - 
May
 
’‹r
 
šfš™e
 
loİ
 
couÁ
 >= 10

4577 ; 
NÙe
: 
This
 
is
 
ª
 
em”g’cy
 
funùiÚ
 - 
assumes
 
cÜru±iÚ
 
š
 
´og»ss


4578 ; 
U£s
 
SEG
 
dœeùive
 
´İ”
 
£gm’t
 
	`add»ssšg
 (
DS
-
šd•’d’t
)

4580 
PUBLIC
 
em”g’cy_ÿÇry_»¥Ú£


4581 
em”g’cy_ÿÇry_»¥Ú£
 
PROC


4582 
pushf


4583 
şi
 ; 
Ensu»
 
š‹¼u±s
 
di§bËd
 
duršg
 
em”g’cy


4584 
push
 
ax


4585 
push
 
dx


4586 
push
 
cx
 ; 
Save
 
	$CX
 (
u£d
 
by
 
»p
 
¡osw
)

4587 
push
 
di
 ; 
Save
 
	$DI
 (
u£d
 
by
 
»p
 
¡osw
)

4588 
push
 
es
 ; 
Wl
 
modify
 
ES
 
»p
 
¡osw


4590 ; 
P»£rve
 
IRQ
 
numb”
 
š
 
DL
 
befÜe
 
şobb”šg
 
AL


4591 
mov
 
dl
, 
®
 ; 
DL
 = 
IRQ
 
numb”
 
Ï‹r
 
u£


4593 ; 
CRITICAL
: 
S’d
 
EOI
 
fœ¡
 
to
 
´ev’t
 
PIC
 
lockup


4594 ; 
UncÚd™iÚ®ly
 
£nd
 
to
 
bÙh
 
PICs
 
robu¡Ãss
 
š
 
em”g’cy
 
·th


4595 
mov
 
®
, 20
h
 ; 
NÚ
-
¥ecific
 
EOI
 
commªd


4596 
out
 0A0
h
, 
®
 ; 
S’d
 
to
 
¦ave
 
	$PIC
 (
§ã
 
nÙ
 
­¶iÿbË
)

4597 
out
 020
h
, 
®
 ; 
S’d
 
to
 
ma¡”
 
	`PIC
 (
®ways
 
Ãeded
)

4599 ; 
EMERGENCY
 
STEP
 1: 
Mask
 
the
 
afãùed
 
IRQ
 
to
 
´ev’t
 
fu¹h”
 
Ã¡šg


4600 ; 
Re¡Üe
 
IRQ
 
numb”
 
to
 
AL
 
mask_œq
 
ÿÎ


4601 
mov
 
®
, 
dl
 ; 
Re¡Üe
 
IRQ
 
numb”
 
äom
 
DL


4602 
ÿÎ
 
mask_œq
 ; 
Mask
 
IRQ
 
š
 
AL
 
©
 
PIC
 
Ëv–


4604 ; 
EMERGENCY
 
STEP
 2: 
S‘
 
·nic
 
æag
 
dŸgno¡ic
 
»pÜtšg


4605 ; 
Lßd
 
´İ”
 
£gm’t
 
em”g’cy_ÿÇry_couÁ


4606 
mov
 
ax
, 
SEG
 
em”g’cy_ÿÇry_couÁ


4607 
mov
 
es
, 
ax


4608 
šc
 
wÜd
 
±r
 
es
:[
em”g’cy_ÿÇry_couÁ
]

4610 ; 
EMERGENCY
 
STEP
 3: 
Reš™Ÿlize
 
the
 
cÜru±ed
 
ÿÇry
 
w™h
 
´İ”
 
ES
:
DI
/
DF
 
£tup


4611 
şd
 ; 
CË¬
 
DF
 
fÜw¬d
 
¡ršg
 
İ”©iÚs


4613 ; 
Check
 
which
 
ÿÇry
 
to
 
»š™Ÿlize
 
ba£d
 
Ú
 
	$IRQ
 (
´e£rved
 
š
 
DL
)

4614 
cmp
 
dl
, 5 ; 
Assumšg
 
IRQ
 5 3C515

4615 
je
 .
»š™_3c515


4617 ; 
Reš™
 3C509B 
	$ÿÇry
 ( )

4618 
mov
 
ax
, 
SEG
 
œq_¡ack_3c509b_ÿÇry


4619 
mov
 
es
, 
ax
 ; 
ES
 = 
£gm’t
 
of
 
ÿÇry
 
bufãr


4620 
mov
 
di
, 
OFFSET
 
œq_¡ack_3c509b_ÿÇry


4621 
mov
 
ax
, 
CANARY_WORD_LO


4622 
mov
 
cx
, 8 ; 8 
wÜds
 = 16 
by‹s


4623 
»p
 
¡osw
 ; 
ES
:
DI
 
´İ”ly
 
£t
, 
DF
 
ş—»d


4624 
jmp
 .
»cov”y_com¶‘e


4626 .
»š™_3c515
:

4627 ; 
Reš™
 3C515 
ÿÇry


4628 
mov
 
ax
, 
SEG
 
œq_¡ack_3c515_ÿÇry


4629 
mov
 
es
, 
ax
 ; 
ES
 = 
£gm’t
 
of
 
ÿÇry
 
bufãr


4630 
mov
 
di
, 
OFFSET
 
œq_¡ack_3c515_ÿÇry


4631 
mov
 
ax
, 
CANARY_WORD_LO


4632 
mov
 
cx
, 8 ; 8 
wÜds
 = 16 
by‹s


4633 
»p
 
¡osw
 ; 
ES
:
DI
 
´İ”ly
 
£t
, 
DF
 
ş—»d


4635 .
»cov”y_com¶‘e
:

4636 ; 
Check
 
this
 
is
 
a
 
£v”e
 
»quœšg
 
h®t


4637 ; 
Lßd
 
´İ”
 
£gm’t
 
couÁ”
 
check


4638 
mov
 
ax
, 
SEG
 
em”g’cy_ÿÇry_couÁ


4639 
mov
 
es
, 
ax


4640 
cmp
 
wÜd
 
±r
 
es
:[
em”g’cy_ÿÇry_couÁ
], 10

4641 
jb
 .
dÚe
 ; 
Less
 
thª
 10 
cÜru±iÚs
, 

4643 ; 
SEVERE
 
CORRUPTION
: 
Too
 
mªy
 
ÿÇry
 
çu»s
, 
sy¡em
 
un¡abË


4644 ; 
Fl
 
sm®Ër
 
§ã
 
¬—
 
to
 
avoid
 
ov”æow


4645 
mov
 
ax
, 
SEG
 
œq_¡ack_3c509b_ÿÇry


4646 
mov
 
es
, 
ax


4647 
mov
 
di
, 
OFFSET
 
œq_¡ack_3c509b_ÿÇry


4648 
mov
 
ax
, 0BEEF
h
 ; 
Em”g’cy
 
·‰”n


4649 
mov
 
cx
, 8 ; 
Fl
 
Úly
 16 
	$by‹s
 (
§ã
 
w™hš
 
ÿÇry
 
bufãr
)

4650 
»p
 
¡osw
 ; 
ES
:
DI
 
£t
, 
DF
 
ş—»d


4652 ; 
F»eze
 
sy¡em
 
w™h
 
š‹¼u±s
 
di§bËd


4653 
şi


4654 .
em”g’cy_h®t
:

4655 
jmp
 .
em”g’cy_h®t
 ; 
Infš™e
 
loİ
 
w™h
 
IF
=0

4657 .
dÚe
:

4658 
pİ
 
es


4659 
pİ
 
di
 ; 
Re¡Üe
 
DI


4660 
pİ
 
cx
 ; 
Re¡Üe
 
CX


4661 
pİ
 
dx


4662 
pİ
 
ax


4663 
pİf
 ; 
Re¡Üe
 
Üigš®
 
š‹¼u±
 
æag


4664 
»t


4665 
em”g’cy_ÿÇry_»¥Ú£
 
ENDP


4667 
_TEXT
 
ENDS


	@/Users/jvindahl/Development/3com-packet-driver/src/asm/packet_api.asm

1 ; @
fe
 
	g·ck‘_­i
.
	gasm


2 ; @
br›f
 
Pack‘
 
Driv”
 
API
 
š‹¼u±
 
	ghªdËr


4 ; 3C
om
 
Pack‘
 
	gDriv”
 - 
SuµÜt
 3C515-
TX
 
	gªd
 3C509B 
	gNICs


6 ; 
This
 
fe
 
is
 
·¹
 
of
 
	gthe
 3C
om
 
Pack‘
 
Driv”
 
	g´ojeù
.

9 .
MODEL
 
	gSMALL


12 
	gšşude
 'tsr_defensive.inc'

14 ; 
Pack‘
 
Driv”
 
API
 
FunùiÚ
 
	$Numb”s
 (
INT
 60
h
)

15 
API_DRIVER_INFO
 
EQU
 1 ; 
G‘
 
driv”
 
šfÜm©iÚ


16 
API_ACCESS_TYPE
 
EQU
 2 ; 
Acûss
 
·ck‘
 
ty³


17 
API_RELEASE_TYPE
 
EQU
 3 ; 
R–—£
 
·ck‘
 
ty³


18 
API_SEND_PKT
 
EQU
 4 ; 
S’d
 
·ck‘


19 
API_TERMINATE
 
EQU
 5 ; 
T”mš©e
 
driv”


20 
API_GET_ADDRESS
 
EQU
 6 ; 
G‘
 
¡©iÚ
 
add»ss


21 
API_RESET_IFACE
 
EQU
 7 ; 
Re£t
 
š‹rçû


22 
API_GET_PARAMETERS
 
EQU
 8 ; 
G‘
 
š‹rçû
 
·¿m‘”s


23 
API_AS_SEND_PKT
 
EQU
 9 ; 
AÉ”Çtive
 
£nd
 
	$·ck‘
 (
ex‹nded
)

24 
API_SET_RCV_MODE
 
EQU
 20 ; 
S‘
 
»ûive
 
mode


25 
API_GET_RCV_MODE
 
EQU
 21 ; 
G‘
 
»ûive
 
mode


26 
API_SET_MULTICAST
 
EQU
 22 ; 
S‘
 
muÉiÿ¡
 
li¡


27 
API_GET_MULTICAST
 
EQU
 23 ; 
G‘
 
muÉiÿ¡
 
li¡


28 
API_GET_STATISTICS
 
EQU
 24 ; 
G‘
 
¡©i¡ics


29 
API_SET_ADDRESS
 
EQU
 25 ; 
S‘
 
¡©iÚ
 
add»ss


31 ; 
Pha£
 3 
Group
 3B 
Ex‹nded
 
API
 
FunùiÚs


32 
API_SET_HANDLE_PRIORITY
 
EQU
 32 ; 
S‘
 
hªdË
 
	$´iÜ™y
 (
AH
=20
h
)

33 
API_GET_ROUTING_INFO
 
EQU
 33 ; 
G‘
 
routšg
 
	$šfÜm©iÚ
 (
AH
=21
h
)

34 
API_SET_LOAD_BALANCE
 
EQU
 34 ; 
S‘
 
lßd
 
	$b®ªcšg
 (
AH
=22
h
)

35 
API_GET_NIC_STATUS
 
EQU
 35 ; 
G‘
 
NIC
 
	$¡©us
 (
AH
=23
h
)

36 
API_SET_QOS_PARAMS
 
EQU
 36 ; 
S‘
 
QoS
 
	$·¿m‘”s
 (
AH
=24
h
)

37 
API_GET_FLOW_STATS
 
EQU
 37 ; 
G‘
 
æow
 
	$¡©i¡ics
 (
AH
=25
h
)

38 
API_SET_NIC_PREFERENCE
 
EQU
 38 ; 
S‘
 
NIC
 
	$´eã»nû
 (
AH
=26
h
)

39 
API_GET_HANDLE_INFO
 
EQU
 39 ; 
G‘
 
hªdË
 
	$šfo
 (
AH
=27
h
)

40 
API_SET_BANDWIDTH_LIMIT
 
EQU
 40 ; 
S‘
 
bªdwidth
 
	$lim™
 (
AH
=28
h
)

41 
API_GET_ERROR_INFO
 
EQU
 41 ; 
G‘
 
”rÜ
 
	`šfo
 (
AH
=29
h
)

43 ; 
Pack‘
 
Driv”
 
¥ecifiÿtiÚ
 
cÚ¡ªts


44 
DRIVER_SIGNATURE
 
EQU
 'PK' ; 
Driv”
 
sigÇtu»
 
d‘eùiÚ


46 ; 
R‘uº
 
Codes


47 
PKT_SUCCESS
 
EQU
 0 ; 
O³¿tiÚ
 
sucûssful


48 
PKT_ERROR_BAD_HANDLE
 
EQU
 1 ; 
Bad
 
hªdË


49 
PKT_ERROR_NO_CLASS
 
EQU
 2 ; 
No
 
š‹rçûs
 
of
 
¥ecif›d
 
şass
 
found


50 
PKT_ERROR_NO_TYPE
 
EQU
 3 ; 
No
 
š‹rçûs
 
of
 
¥ecif›d
 
ty³
 
found


51 
PKT_ERROR_NO_NUMBER
 
EQU
 4 ; 
No
 
š‹rçûs
 
of
 
¥ecif›d
 
numb”
 
found


52 
PKT_ERROR_BAD_TYPE
 
EQU
 5 ; 
Bad
 
·ck‘
 
ty³
 
¥ecif›d


53 
PKT_ERROR_NO_MULTICAST
 
EQU
 6 ; 
IÁ”çû
 
dÛ¢
't support multicast

54 
PKT_ERROR_CANT_TERMINATE
 
EQU
 7 ; 
Cª
'terminate driver

55 
PKT_ERROR_BAD_MODE
 
EQU
 8 ; 
Bad
 
mode
 
¥ecif›d


56 
PKT_ERROR_NO_SPACE
 
EQU
 9 ; 
No
 
¥aû
 
Ãw
 
·ck‘
 
ty³


57 
PKT_ERROR_TYPE_INUSE
 
EQU
 10 ; 
Ty³
 
®»ady
 
š
 
u£


58 
PKT_ERROR_BAD_COMMAND
 
EQU
 11 ; 
Bad
 
commªd
 
numb”


59 
PKT_ERROR_CANT_SEND
 
EQU
 12 ; 
Cª
't send…acket

60 
PKT_ERROR_CANT_SET
 
EQU
 13 ; 
Cª
't set station‡ddress

61 
PKT_ERROR_BAD_ADDRESS
 
EQU
 14 ; 
Bad
 
add»ss
 
¥ecif›d


63 ; 
Reûive
 
Modes


64 
RCV_MODE_OFF
 
EQU
 1 ; 
Tuº
 
off
 
»ûiv”


65 
RCV_MODE_DIRECT
 
EQU
 2 ; 
Reûive
 
Úly
 
·ck‘s
 
to
 
this
 
add»ss


66 
RCV_MODE_BROADCAST
 
EQU
 3 ; 
Reûive
 
dœeù
 + 
brßdÿ¡
 
·ck‘s


67 
RCV_MODE_MULTICAST
 
EQU
 4 ; 
Reûive
 
dœeù
 + 
brßdÿ¡
 + 
muÉiÿ¡


68 
RCV_MODE_PROMISCUOUS
 
EQU
 6 ; 
Reûive
 
®l
 
·ck‘s


70 ; 
Maximum
 
numb”
 
of
 
hªdËs
 
ªd
 
ÿÎback
 
chašs


71 
MAX_HANDLES
 
EQU
 16 ; 
Maximum
 
·ck‘
 
ty³
 
hªdËs


72 
MAX_TYPE_CALLBACKS
 
EQU
 8 ; 
Maximum
 
ÿÎbacks
 
³r
 
·ck‘
 
ty³


73 
MAX_PACKET_TYPES
 
EQU
 32 ; 
Maximum
 
Œacked
 
·ck‘
 
ty³s


75 ; 
D©a
 
£gm’t


76 
_DATA
 
SEGMENT


77 
ASSUME
 
DS
:
_DATA


79 ; 
API
 
¡©e
 
v¬ŸbËs


80 
­i_š™Ÿlized
 
db
 0 ; 
API
 
š™Ÿliz©iÚ
 
æag


81 
driv”_sigÇtu»
 
db
 'PKT DRVR' ; 
Driv”
 
sigÇtu»
 
d‘eùiÚ


82 
driv”_v”siÚ
 
db
 11 ; 
Driv”
 
	$v”siÚ
 (1.1)

83 
driv”_ty³
 
db
 1 ; 
Driv”
 
	$ty³
 (
DIX
 
Eth”Ãt
)

84 
driv”_numb”
 
db
 0 ; 
Driv”
 
numb”


85 
driv”_Çme
 
db
 'TCPIP$', 0 ; 
Driv”
 
Çme


87 ; 
Enhªûd
 
HªdË
 
ªd
 
C®lback
 
Mªagem’t


88 
hªdË_bË
 
dw
 
MAX_HANDLES
 
	`dup
(0è; 
HªdË
 
to
 
·ck‘
 
ty³
 
m­pšg


89 
hªdË_ÿÎbacks
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
C®lback
 
add»s£s
 
—ch
 
hªdË


90 
hªdË_š‹rçûs
 
db
 
MAX_HANDLES
 
	`dup
(0è; 
IÁ”çû
 
numb”
 
—ch
 
hªdË


91 
hªdË_modes
 
db
 
MAX_HANDLES
 
	`dup
(0è; 
Reûive
 
mode
 
—ch
 
hªdË


92 
Ãxt_hªdË
 
dw
 1 ; 
Next
 
avaabË
 
hªdË


93 
aùive_hªdËs
 
dw
 0 ; 
Numb”
 
of
 
aùive
 
hªdËs


95 ; 
Enhªûd
 
C®lback
 
Chaš
 
	$Mªagem’t
 (
Group
 3B 
MuÉËxšg
)

96 
ÿÎback_chašs
 
dd
 
MAX_PACKET_TYPES
 * 
MAX_TYPE_CALLBACKS
 
	`dup
(0è; 
C®lback
 
chaš
 
¡Üage


97 
ÿÎback_´iÜ™›s
 
db
 
MAX_PACKET_TYPES
 * 
MAX_TYPE_CALLBACKS
 
	`dup
(0è; 
C®lback
 
´iÜ™›s


98 
ÿÎback_f‹rs
 
dw
 
MAX_PACKET_TYPES
 * 
MAX_TYPE_CALLBACKS
 
	`dup
(0è; 
Pack‘
 
f‹rs


99 
ÿÎback_”rÜ_couÁs
 
dw
 
MAX_PACKET_TYPES
 * 
MAX_TYPE_CALLBACKS
 
	`dup
(0è; 
E¼Ü
 
couÁs


100 
ÿÎback_Ï¡_”rÜs
 
dd
 
MAX_PACKET_TYPES
 * 
MAX_TYPE_CALLBACKS
 
	`dup
(0è; 
La¡
 
”rÜ
 
times


101 
·ck‘_ty³_bË
 
dw
 
MAX_PACKET_TYPES
 
	`dup
(0è; 
Aùive
 
·ck‘
 
ty³s


102 
ty³_ÿÎback_couÁs
 
db
 
MAX_PACKET_TYPES
 
	`dup
(0è; 
Numb”
 
of
 
ÿÎbacks
 
³r
 
ty³


103 
ty³_hªdË_m­pšg
 
dw
 
MAX_PACKET_TYPES
 
	`dup
(0FFFF
h
è; 
Prim¬y
 
hªdË
 
³r
 
ty³


105 ; 
C®lback
 
Saãty
 
ªd
 
Timeout
 
Mªagem’t


106 
ÿÎback_timeout_ticks
 
dd
 0 ; 
Tim”
 
ÿÎback
 
	$timeouts
 (
­´ox
 100
ms
)

107 
ÿÎback_tim”_aùive
 
db
 0 ; 
Tim”
 
aùive
 
æag


108 
ÿÎback_¡ack_d•th
 
db
 0 ; 
C®lback
 
Ã¡šg
 
d•th


109 
max_ÿÎback_d•th
 
EQU
 3 ; 
Maximum
 
ÿÎback
 
Ã¡šg


110 
max_ÿÎback_”rÜs
 
EQU
 10 ; 
Maximum
 
”rÜs
 
befÜe
 
di§blšg
 
ÿÎback


112 ; 
Pha£
 3 
Ex‹nded
 
HªdË
 
Mªagem’t


113 
ex‹nded_­i_’abËd
 
db
 0 ; 
Ex‹nded
 
API
 
’abËd
 
æag


114 
vœtu®_œq_’abËd
 
db
 0 ; 
Vœtu®
 
š‹¼u±
 
’abËd


115 
hªdË_´iÜ™›s
 
db
 
MAX_HANDLES
 
	`dup
(128è; 
HªdË
 
	$´iÜ™›s
 (128 = )

116 
hªdË_æags
 
dw
 
MAX_HANDLES
 
	`dup
(0è; 
Ex‹nded
 
hªdË
 
æags


117 
´eã¼ed_nics
 
db
 
MAX_HANDLES
 
	`dup
(0FF
h
è; 
P»ã¼ed
 
NIC
 
³r
 
	$hªdË
 (0xFF = 
no
 
´eã»nû
)

118 
bªdwidth_lim™s
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
Bªdwidth
 
lim™s
 
³r
 
hªdË


120 ; 
Lßd
 
B®ªcšg
 
S‹


121 
lb_mode
 
db
 0 ; 
Lßd
 
b®ªcšg
 
	`mode
 (0=
round
-
robš
)

122 
lb_´im¬y_nic
 
db
 0 ; 
Prim¬y
 
NIC
 
lßd
 
b®ªcšg


123 
lb_£cÚd¬y_nic
 
db
 1 ; 
SecÚd¬y
 
NIC
 
lßd
 
b®ªcšg


124 
lb_Ï¡_u£d
 
db
 0 ; 
La¡
 
u£d
 
NIC
 
round
-
robš


125 
lb_weights
 
dw
 2 
	`dup
(100è; 
NIC
 
	`weights
 (
equ®
 
by
 )

127 ; 
QoS
 
Mªagem’t


128 
qos_’abËd
 
db
 0 ; 
QoS
 
’abËd
 
æag


129 
deçuÉ_qos_şass
 
db
 1 ; 
DeçuÉ
 
QoS
 
	$şass
 (
¡ªd¬d
)

130 
qos_·ck‘_couÁ
 
dw
 0 ; 
Pack‘s
 
š
 
QoS
 
queue


132 ; 
IÁ”çû
 
šfÜm©iÚ


133 
š‹rçû_couÁ
 
db
 2 ; 
Numb”
 
of
 
	$š‹rçûs
 (
max
 2 
our
 
NICs
)

134 
cu¼’t_rcv_mode
 
db
 
RCV_MODE_DIRECT
 ; 
Cu¼’t
 
»ûive
 
mode


135 
nic_utiz©iÚ
 
dw
 2 
	`dup
(0è; 
NIC
 
utiz©iÚ
 
³rûÁages


136 
nic_”rÜ_couÁs
 
dw
 2 
	`dup
(0è; 
E¼Ü
 
couÁs
 
³r
 
NIC


138 ; 
Vœtu®
 
IÁ”ru±
 
Mªagem’t


139 
vœtu®_hªdËrs
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
Vœtu®
 
š‹¼u±
 
hªdËrs


140 
vœtu®_cÚ‹xts
 
dw
 
MAX_HANDLES
 
	`dup
(0è; 
Vœtu®
 
hªdËr
 
cÚ‹xts


141 
muÉËx_couÁ
 
dw
 0 ; 
MuÉËxed
 
d–iv”y
 
couÁ


143 ; 
Deãnsive
 
´og¿mmšg
 
	$d©a
 (
»quœed
 
by
 
t¤_deãnsive
.
šc
 
maüos
)

144 
­i_ÿÎ”_ss
 
dw
 ? ; 
Saved
 
ÿÎ”
 
¡ack
 
£gm’t
 
API
 
ÿÎs


145 
­i_ÿÎ”_¥
 
dw
 ? ; 
Saved
 
ÿÎ”
 
¡ack
 
poš‹r
 
API
 
ÿÎs


146 
­i_ü™iÿl_Ã¡šg
 
db
 0 ; 
API
 
ü™iÿl
 
£ùiÚ
 
Ã¡šg


147 
­i_šdos_£gm’t
 
dw
 0 ; 
InDOS
 
æag
 
£gm’t


148 
­i_šdos_off£t
 
dw
 0 ; 
InDOS
 
æag
 
off£t


150 ; 
Priv©e
 
API
 
hªdËr
 
	$¡ack
 (2
KB
)

151 
­i_¡ack
 
db
 2048 
	`dup
(?)

152 
­i_¡ack_tİ
 
equ
 
$
 - 2

154 ; 
MuÉiÿ¡
 
add»ss
 
mªagem’t


155 
muÉiÿ¡_li¡
 
db
 16 * 6 
	`dup
(0è; 
Up
 
to
 16 
muÉiÿ¡
 
add»s£s


156 
muÉiÿ¡_couÁ
 
db
 0 ; 
Cu¼’t
 
numb”
 
of
 
muÉiÿ¡
 
add»s£s


158 ; 
StiÚ
 
add»ss
 
¡Üage


159 
¡©iÚ_add»ss
 
db
 6 
	`dup
(0è; 
Cu¼’t
 
¡©iÚ
 
MAC
 
add»ss


161 ; 
Sti¡ics
 
Œackšg
 
³r
 
hªdË


162 
hªdË_tx_·ck‘s
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
Pack‘s
 
Œªsm™‹d
 
³r
 
hªdË


163 
hªdË_tx_by‹s
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
By‹s
 
Œªsm™‹d
 
³r
 
hªdË


164 
hªdË_rx_·ck‘s
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
Pack‘s
 
»ûived
 
³r
 
hªdË


165 
hªdË_rx_by‹s
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
By‹s
 
»ûived
 
³r
 
hªdË


166 
hªdË_tÙ®_Ï‹ncy
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
AccumuÏ‹d
 
Ï‹ncy
 
av”agšg


167 
hªdË_Ï‹ncy_v¬Ÿnû
 
dd
 
MAX_HANDLES
 
	`dup
(0è; 
L©’cy
 
v¬Ÿnû
 
j™‹r


169 ; 
PriÜ™y
 
queue
 
mªagem’t


170 
PRIORITY_QUEUE_SIZE
 
equ
 64 ; 
Mu¡
 
be
 
pow”
 
of
 2

171 
PRIORITY_QUEUE_MASK
 
equ
 63 ; 
Size
 - 1 
w¿p
-
¬ound


172 
´iÜ™y_queue
 
db
 
PRIORITY_QUEUE_SIZE
 * 8 
	`dup
(0è; 8 
by‹s
 
³r
 
’Œy


173 
´iÜ™y_queue_h—d
 
dw
 0 ; 
Queue
 
h—d
 
šdex


174 
´iÜ™y_queue_
 
dw
 0 ; 
Queue
 

 
šdex


176 ; 
Tim”
 
mªagem’t


177 
tim”_hooked
 
db
 0 ; 
Tim”
 
š‹¼u±
 
hooked
 
æag


178 
ÿÎback_timed_out
 
db
 0 ; 
C®lback
 
timeout
 
æag


179 
Şd_tim”_hªdËr
 
dd
 0 ; 
Origš®
 
INT
 1C
h
 
hªdËr


180 
ÿÎback_¡¬t_time
 
dd
 0 ; 
C®lback
 
¡¬t
 
time¡amp


182 ; 
P”fÜmªû
 
İtimiz©iÚ


183 
­i_ıu_ty³
 
db
 0 ; 
CPU
 
	$ty³
 (0=8086, 1=286, 2=386, 3=486)

184 
­i_pusha_th»shŞd
 
db
 8 ; 
Th»shŞd
 
PUSHA
 
vs
 
šdividu®
 
pushes


185 
Ï¡_funùiÚ
 
db
 0 ; 
La¡
 
API
 
funùiÚ
 
ÿÎed


186 
ç¡_·th_h™s
 
dd
 0 ; 
Fa¡
 
·th
 
İtimiz©iÚ
 
h™s


187 
ç¡_·th_mis£s
 
dd
 0 ; 
Fa¡
 
·th
 
İtimiz©iÚ
 
mis£s


189 
_DATA
 
ENDS


191 ; 
Code
 
£gm’t


192 
_TEXT
 
SEGMENT


193 
ASSUME
 
CS
:
_TEXT
, 
DS
:
_DATA


195 ; 
Public
 
funùiÚ
 
expÜts


196 
PUBLIC
 
·ck‘_­i_š™


197 
PUBLIC
 
·ck‘_št_hªdËr


198 
PUBLIC
 
­i_driv”_šfo


199 
PUBLIC
 
­i_acûss_ty³


200 
PUBLIC
 
­i_»Ëa£_ty³


201 
PUBLIC
 
­i_£nd_·ck‘


202 
PUBLIC
 
­i_‹rmš©e


203 
PUBLIC
 
­i_g‘_add»ss


204 
PUBLIC
 
­i_»£t_š‹rçû


205 
PUBLIC
 
­i_g‘_·¿m‘”s


206 
PUBLIC
 
­i_as_£nd_·ck‘


207 
PUBLIC
 
­i_£t_rcv_mode


208 
PUBLIC
 
­i_g‘_rcv_mode


209 
PUBLIC
 
­i_£t_muÉiÿ¡


210 
PUBLIC
 
­i_g‘_muÉiÿ¡


211 
PUBLIC
 
­i_g‘_¡©i¡ics


212 
PUBLIC
 
­i_£t_add»ss


213 
PUBLIC
 
·ck‘_d–iv”_to_hªdËr


214 
PUBLIC
 
İtim®_»gi¡”_§ve


215 
PUBLIC
 
İtim®_»gi¡”_»¡Üe


216 
PUBLIC
 
ç¡_­i_di¥©ch


217 
PUBLIC
 
ç¡_»gi¡”_»¡Üe


218 
PUBLIC
 
­i_³rfÜmªû_m‘rics


220 ; 
Ex‹º®
 
»ã»nûs


221 
EXTRN
 
h¬dw¬e_£nd_·ck‘_asm
:
PROC
 ; 
From
 
h¬dw¬e
.
asm


222 
EXTRN
 
h¬dw¬e_g‘_add»ss
:
PROC
 ; 
From
 
h¬dw¬e
.
asm


223 
EXTRN
 
g‘_ıu_ty³
:
PROC
 ; 
From
 
ıu_d‘eù
.
asm


225 ; 
C
 
funùiÚ
 
bridges
 - 
Bridge
 
to
 
vbË
 
di¥©ch
 
sy¡em


226 
EXTRN
 
_·ck‘_£nd
:
PROC
 ; 
From
 
·ck‘_İs
.
c
 - 
C
 
ÿÎšg
 
cÚv’tiÚ


227 
EXTRN
 
_pd_g‘_add»ss
:
PROC
 ; 
From
 
­i
.
c
 - 
C
 
ÿÎšg
 
cÚv’tiÚ


228 
EXTRN
 
_pd_£t_rcv_mode
:
PROC
 ; 
From
 
­i
.
c
 - 
C
 
ÿÎšg
 
cÚv’tiÚ


229 
EXTRN
 
_pd_g‘_¡©i¡ics
:
PROC
 ; 
From
 
­i
.
c
 - 
C
 
ÿÎšg
 
cÚv’tiÚ


231 ; 
Deãnsive
 
´og¿mmšg
 
š‹g¿tiÚ


232 
EXTRN
 
dos_is_§ã
:
PROC
 ; 
From
 
deãnsive_š‹g¿tiÚ
.
asm


233 
EXTRN
 
nic_£t_»ûive_mode
:
PROC
 ; 
From
 
nic_œq
.
asm


235 ; 
P”fÜmªû
 
İtimiz©iÚ
 
d©a


236 
­i_ıu_ty³
 
db
 0 ; 
Cached
 
CPU
 
ty³
 
İtimiz©iÚ


237 
­i_pusha_th»shŞd
 
db
 4 ; 
U£
 
PUSHA
 
wh’
 
§všg
 >ğ
this
 
mªy
 
»gi¡”s


238 
Ï¡_funùiÚ
 
db
 0 ; 
La¡
 
API
 
funùiÚ
 
	$ÿÎed
 (
´ediùiÚ
)

239 
ç¡_·th_h™s
 
dd
 0 ; 
Fa¡
 
·th
 
u§ge
 
¡©i¡ics


240 
ç¡_·th_mis£s
 
dd
 0 ; 
Fa¡
 
·th
 
miss
 
¡©i¡ics


243 ; 
·ck‘_­i_š™
 - 
In™Ÿlize
 
Pack‘
 
Driv”
 
API


245 ; 
IÅut
: 
NÚe


246 ; 
Ouut
: 
AX
 = 0 
sucûss
, 
nÚ
-
z”o
 
”rÜ


247 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX


249 
·ck‘_­i_š™
 
PROC


250 
push
 
bp


251 
mov
 
bp
, 
¥


252 
push
 
bx


253 
push
 
cx


254 
push
 
dx


256 ; 
In™Ÿlize
 
hªdË
 
bË
 
w™h
 
®l
 
’Œ›s
 
m¬ked
 
ä“


257 ; 
S‘
 
up
  
»ûive
 
mode
 
®l
 
š‹rçûs


258 ; 
V”ify
 
h¬dw¬e
 
is
 
»ady
 
ªd
 
»¥Údšg
 
to
 
commªds


260 ; 
CË¬
 
hªdË
 
bË


261 
mov
 
cx
, 
MAX_HANDLES


262 
mov
 
bx
, 
OFFSET
 
hªdË_bË


263 
xÜ
 
ax
,‡x

264 .
ş—r_loİ
:

265 
mov
 [
bx
], 
ax


266 
add
 
bx
, 2

267 
loİ
 .
ş—r_loİ


269 ; 
M¬k
 
API
 
as
 
š™Ÿlized


270 
mov
 
by‹
 
±r
 [
­i_š™Ÿlized
], 1

272 ; 
Sucûss


273 
mov
 
ax
, 
PKT_SUCCESS


275 
pİ
 
dx


276 
pİ
 
cx


277 
pİ
 
bx


278 
pİ
 
bp


279 
»t


280 
·ck‘_­i_š™
 
ENDP


283 ; 
·ck‘_št_hªdËr
 - 
Maš
 
INT
 60
h
 
·ck‘
 
driv”
 
š‹¼u±
 
hªdËr


284 ; 
This
 
is
 
the
 
maš
 
’Œy
 
pošt
 
®l
 
Pack‘
 
Driv”
 
API
 
ÿÎs


286 ; 
IÅut
: 
AH
 = 
funùiÚ
 
numb”
, 
Ùh”
 
»gi¡”s
 
³r
 function

287 ; 
Ouut
: 
D•’ds
 
Ú
 
funùiÚ
, 
CF
 
£t
 oÀ
”rÜ


288 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
´e£rved
 
as
 
Ãeded
)

290 
·ck‘_št_hªdËr
 
PROC


291 ; ==ğ
DEFENSIVE
 
API
 
PROLOG
 ===

292 ; 
Quick
 
sigÇtu»
 
check
 
	$fœ¡
 (
no
 
¡ack
 
Ãeded
 
this
)

293 
cmp
 
ax
, 1234
h


294 
jÃ
 .
nÙ_sigÇtu»_check


295 
mov
 
ax
, 
DRIVER_SIGNATURE
 ; 
R‘uº
 'PK' 
sigÇtu»


296 
œ‘


298 .
nÙ_sigÇtu»_check
:

299 ; 
Save
 
mšim®
 
»gi¡”s
 
fœ¡


300 
push
 
ax


301 
push
 
ds


303 ; 
S‘
 
up
 
our
 
d©a
 
£gm’t


304 
mov
 
ax
, 
_DATA


305 
mov
 
ds
, 
ax


306 
ASSUME
 
DS
:
_DATA


308 ; 
Check
 
API
 
is
 
š™Ÿlized


309 
cmp
 
by‹
 
±r
 [
­i_š™Ÿlized
], 0

310 
je
 .
nÙ_š™Ÿlized


312 ; 
Sw™ch
 
to
 
´iv©e
 
¡ack
 
	$§ãty
 (
API
 
ÿÎs
 
ÿn
 
be
 
Ëngthy
)

313 
şi
 ; 
Cr™iÿl
 
£ùiÚ
 
¡¬t


314 
mov
 [
­i_ÿÎ”_ss
], 
ss
 ; 
Save
 
ÿÎ”
's stack

315 
mov
 [
­i_ÿÎ”_¥
], 
¥


316 
mov
 
ax
, 
_DATA
 ; 
U£
 
our
 
d©a
 
£gm’t
 
as
 
¡ack
 segment

317 
mov
 
ss
, 
ax


318 
mov
 
¥
, 
OFFSET
 
­i_¡ack_tİ
 ; 
Sw™ch
 
to
 
´iv©e
 
¡ack


319 
¡i
 ; 
Cr™iÿl
 
£ùiÚ
 
’d


321 ; 
Save
 
»gi¡”s
 
İtim®ly
 
ba£d
 
Ú
 
CPU
 
ty³
 
ªd
 
u§ge


322 ; 
U£
 
PUSHA
 
decisiÚ
 
m©rix
: U£ PUSHA 
wh’
 
§všg
 â‰¥4 
»gi¡”s


323 ; 286: 
PUSHA
=19 
cyşes
 
vs
 8Ã—
PUSH
=24 
	`cyşes
 (5 
cyşe
 
§všgs
)

324 ; 386: 
PUSHA
=11 
cyşes
 
vs
 8Ã—
PUSH
=16 
	`cyşes
 (5 
cyşe
 
§všgs
)

325 ; 486: 
PUSHA
=5 
cyşes
 
vs
 8Ã—
PUSH
=8 
	$cyşes
 (3 
cyşe
 
³ÇÉy
, 
but
 
acû±abË
)

327 
ÿÎ
 
İtim®_»gi¡”_§ve


328 
pushf
 ; 
Save
 
ÿÎ”
's flags

330 ; ==ğ
DOS
 
SAFETY
 
CHECK
 ===

331 ; 
FÜ
 
funùiÚs
 
th©
 
might
 
Ãed
 
DOS
, 
check
 
™
's safe

332 ; (
This
 
is
 
a
 
sim¶if›d
 
check
 - 
fuÎ
 
im¶em’tiÚ
 
would
 
be
 
³r
-
funùiÚ
)

333 
cmp
 
ah
, 
API_TERMINATE
 ; 
T”mš©e
 
might
 
Ãed
 
DOS


334 
je
 .
check_dos_§ãty


335 
cmp
 
ah
, 
API_GET_PARAMETERS
 ; 
Some
 
·¿m‘”
 
ÿÎs
 
might
 
Ãed
 
DOS


336 
je
 .
check_dos_§ãty


337 
jmp
 .
dos_check_com¶‘e


339 .
check_dos_§ãty
:

340 
ÿÎ
 
dos_is_§ã


341 
jnz
 .
dos_busy_”rÜ
 ; 
DOS
 
is
 
busy
 - 
ÿÂÙ
 
£rviû
 
this
 
ÿÎ


343 .
dos_check_com¶‘e
:

345 ; 
Fa¡
 
·th
 
di¥©ch
 
commÚ
 
funùiÚs


346 ; 
Mo¡
 
commÚ
: 
	`SEND_PKT
 (4), 
	`ACCESS_TYPE
 (2), 
	`DRIVER_INFO
 (1)

348 ; 
Fa¡
 
di¥©ch
 
bË
 
lookup
 
³rfÜmªû


349 
ÿÎ
 
ç¡_­i_di¥©ch


350 
‹¡
 
ax
,‡x

351 
jz
 .
di¥©ch_hªdËd
 ; 
FunùiÚ
 
hªdËd
 
by
 
ç¡
 
·th


353 ; 
F®l
 
back
 
to
 
fuÎ
 
di¥©ch
 
Ëss
 
commÚ
 
funùiÚs


354 
cmp
 
ah
, 
API_DRIVER_INFO


355 
je
 .
ÿÎ_driv”_šfo


356 
cmp
 
ah
, 
API_ACCESS_TYPE


357 
je
 .
ÿÎ_acûss_ty³


358 
cmp
 
ah
, 
API_RELEASE_TYPE


359 
je
 .
ÿÎ_»Ëa£_ty³


360 
cmp
 
ah
, 
API_SEND_PKT


361 
je
 .
ÿÎ_£nd_·ck‘


362 
cmp
 
ah
, 
API_TERMINATE


363 
je
 .
ÿÎ_‹rmš©e


364 
cmp
 
ah
, 
API_GET_ADDRESS


365 
je
 .
ÿÎ_g‘_add»ss


366 
cmp
 
ah
, 
API_RESET_IFACE


367 
je
 .
ÿÎ_»£t_š‹rçû


368 
cmp
 
ah
, 
API_GET_PARAMETERS


369 
je
 .
ÿÎ_g‘_·¿m‘”s


370 
cmp
 
ah
, 
API_AS_SEND_PKT


371 
je
 .
ÿÎ_as_£nd_·ck‘


372 
cmp
 
ah
, 
API_SET_RCV_MODE


373 
je
 .
ÿÎ_£t_rcv_mode


374 
cmp
 
ah
, 
API_GET_RCV_MODE


375 
je
 .
ÿÎ_g‘_rcv_mode


376 
cmp
 
ah
, 
API_SET_MULTICAST


377 
je
 .
ÿÎ_£t_muÉiÿ¡


378 
cmp
 
ah
, 
API_GET_MULTICAST


379 
je
 .
ÿÎ_g‘_muÉiÿ¡


380 
cmp
 
ah
, 
API_GET_STATISTICS


381 
je
 .
ÿÎ_g‘_¡©i¡ics


382 
cmp
 
ah
, 
API_SET_ADDRESS


383 
je
 .
ÿÎ_£t_add»ss


385 ; 
Pha£
 3 
Ex‹nded
 
FunùiÚs


386 
cmp
 
ah
, 
API_SET_HANDLE_PRIORITY


387 
je
 .
ÿÎ_£t_hªdË_´iÜ™y


388 
cmp
 
ah
, 
API_GET_ROUTING_INFO


389 
je
 .
ÿÎ_g‘_routšg_šfo


390 
cmp
 
ah
, 
API_SET_LOAD_BALANCE


391 
je
 .
ÿÎ_£t_lßd_b®ªû


392 
cmp
 
ah
, 
API_GET_NIC_STATUS


393 
je
 .
ÿÎ_g‘_nic_¡©us


394 
cmp
 
ah
, 
API_SET_QOS_PARAMS


395 
je
 .
ÿÎ_£t_qos_·¿ms


396 
cmp
 
ah
, 
API_GET_FLOW_STATS


397 
je
 .
ÿÎ_g‘_æow_¡©s


398 
cmp
 
ah
, 
API_SET_NIC_PREFERENCE


399 
je
 .
ÿÎ_£t_nic_´eã»nû


400 
cmp
 
ah
, 
API_GET_HANDLE_INFO


401 
je
 .
ÿÎ_g‘_hªdË_šfo


402 
cmp
 
ah
, 
API_SET_BANDWIDTH_LIMIT


403 
je
 .
ÿÎ_£t_bªdwidth_lim™


404 
cmp
 
ah
, 
API_GET_ERROR_INFO


405 
je
 .
ÿÎ_g‘_”rÜ_šfo


407 ; 
Unknown
 
funùiÚ


408 
mov
 
dh
, 
PKT_ERROR_BAD_COMMAND


409 
jmp
 .
”rÜ_ex™


411 .
ÿÎ_driv”_šfo
:

412 
ÿÎ
 
­i_driv”_šfo


413 
jmp
 .
sucûss_ex™


415 .
ÿÎ_acûss_ty³
:

416 
ÿÎ
 
­i_acûss_ty³


417 
jmp
 .
check_ex™


419 .
ÿÎ_»Ëa£_ty³
:

420 
ÿÎ
 
­i_»Ëa£_ty³


421 
jmp
 .
check_ex™


423 .
ÿÎ_£nd_·ck‘
:

424 
ÿÎ
 
­i_£nd_·ck‘


425 
jmp
 .
check_ex™


427 .
ÿÎ_‹rmš©e
:

428 
ÿÎ
 
­i_‹rmš©e


429 
jmp
 .
check_ex™


431 .
ÿÎ_g‘_add»ss
:

432 
ÿÎ
 
­i_g‘_add»ss


433 
jmp
 .
check_ex™


435 .
ÿÎ_»£t_š‹rçû
:

436 
ÿÎ
 
­i_»£t_š‹rçû


437 
jmp
 .
check_ex™


439 .
ÿÎ_g‘_·¿m‘”s
:

440 
ÿÎ
 
­i_g‘_·¿m‘”s


441 
jmp
 .
check_ex™


443 .
ÿÎ_as_£nd_·ck‘
:

444 
ÿÎ
 
­i_as_£nd_·ck‘


445 
jmp
 .
check_ex™


447 .
ÿÎ_£t_rcv_mode
:

448 
ÿÎ
 
­i_£t_rcv_mode


449 
jmp
 .
check_ex™


451 .
ÿÎ_g‘_rcv_mode
:

452 
ÿÎ
 
­i_g‘_rcv_mode


453 
jmp
 .
check_ex™


455 .
ÿÎ_£t_muÉiÿ¡
:

456 
ÿÎ
 
­i_£t_muÉiÿ¡


457 
jmp
 .
check_ex™


459 .
ÿÎ_g‘_muÉiÿ¡
:

460 
ÿÎ
 
­i_g‘_muÉiÿ¡


461 
jmp
 .
check_ex™


463 .
ÿÎ_g‘_¡©i¡ics
:

464 
ÿÎ
 
­i_g‘_¡©i¡ics


465 
jmp
 .
check_ex™


467 .
ÿÎ_£t_add»ss
:

468 
ÿÎ
 
­i_£t_add»ss


469 
jmp
 .
check_ex™


471 ; 
Pha£
 3 
Ex‹nded
 
FunùiÚ
 
Di¥©ch”s


472 .
ÿÎ_£t_hªdË_´iÜ™y
:

473 
ÿÎ
 
­i_£t_hªdË_´iÜ™y_asm


474 
jmp
 .
check_ex™


476 .
ÿÎ_g‘_routšg_šfo
:

477 
ÿÎ
 
­i_g‘_routšg_šfo_asm


478 
jmp
 .
check_ex™


480 .
ÿÎ_£t_lßd_b®ªû
:

481 
ÿÎ
 
­i_£t_lßd_b®ªû_asm


482 
jmp
 .
check_ex™


484 .
ÿÎ_g‘_nic_¡©us
:

485 
ÿÎ
 
­i_g‘_nic_¡©us_asm


486 
jmp
 .
check_ex™


488 .
ÿÎ_£t_qos_·¿ms
:

489 
ÿÎ
 
­i_£t_qos_·¿ms_asm


490 
jmp
 .
check_ex™


492 .
ÿÎ_g‘_æow_¡©s
:

493 
ÿÎ
 
­i_g‘_æow_¡©s_asm


494 
jmp
 .
check_ex™


496 .
ÿÎ_£t_nic_´eã»nû
:

497 
ÿÎ
 
­i_£t_nic_´eã»nû_asm


498 
jmp
 .
check_ex™


500 .
ÿÎ_g‘_hªdË_šfo
:

501 
ÿÎ
 
­i_g‘_hªdË_šfo_asm


502 
jmp
 .
check_ex™


504 .
ÿÎ_£t_bªdwidth_lim™
:

505 
ÿÎ
 
­i_£t_bªdwidth_lim™_asm


506 
jmp
 .
check_ex™


508 .
ÿÎ_g‘_”rÜ_šfo
:

509 
ÿÎ
 
­i_g‘_”rÜ_šfo_asm


510 
jmp
 .
check_ex™


512 .
check_ex™
:

513 ; 
Check
  
v®ue
 
š
 
DH


514 
cmp
 
dh
, 
PKT_SUCCESS


515 
je
 .
sucûss_ex™


516 
jmp
 .
”rÜ_ex™


518 .
dos_busy_”rÜ
:

519 ; 
DOS
 
is
 
busy
 - 
ÿÂÙ
 
£rviû
 
this
 
ÿÎ
 
right
 
now


520 
mov
 
dh
, 
PKT_ERROR_BAD_COMMAND
 ; 
R‘uº
 
”rÜ


521 
¡c


522 
jmp
 .
deãnsive_ex™


524 .
sucûss_ex™
:

525 ; 
CË¬
 
ÿ¼y
 
æag
 
sucûss


526 
şc


527 
jmp
 .
deãnsive_ex™


529 .
”rÜ_ex™
:

530 ; 
S‘
 
ÿ¼y
 
æag
 
”rÜ


531 
¡c


532 
jmp
 .
deãnsive_ex™


534 .
nÙ_š™Ÿlized
:

535 ; 
API
 
nÙ
 
š™Ÿlized
 - 
»¡Üe
 
mšim®
 
»gi¡”s
 
ªd
 
ex™


536 
mov
 
ax
, 
PKT_ERROR_BAD_COMMAND


537 
mov
 
dh
, 
®


538 
¡c


539 
pİ
 
ds


540 
pİ
 
ax


541 
œ‘


543 .
deãnsive_ex™
:

544 .
di¥©ch_hªdËd
:

545 ; 
FunùiÚ
 
was
 
hªdËd
 
by
 
ç¡
 
·th
, 
»¡Üe
 
mšim®
 
»gi¡”s


546 
ÿÎ
 
ç¡_»gi¡”_»¡Üe


547 
jmp
 .
fš®_ex™


549 .
deãnsive_ex™
:

550 ; ==ğ
DEFENSIVE
 
API
 
EPILOG
 ===

551 ; 
Re¡Üe
 
®l
 
»gi¡”s
 
š
 
»v”£
 
Üd”


552 
pİf
 ; 
Re¡Üe
 
ÿÎ”
's flags

553 
ÿÎ
 
İtim®_»gi¡”_»¡Üe


555 ; 
Re¡Üe
 
ÿÎ”
's stack

556 
şi
 ; 
Cr™iÿl
 
£ùiÚ
 
¡¬t


557 
mov
 
ss
, [
­i_ÿÎ”_ss
]

558 
mov
 
¥
, [
­i_ÿÎ”_¥
]

559 
¡i
 ; 
Cr™iÿl
 
£ùiÚ
 
’d


561 ; 
Re¡Üe
 
mšim®
 
»gi¡”s


562 .
fš®_ex™
:

563 
pİ
 
ds


564 
pİ
 
ax


566 
œ‘
 ; 
R‘uº
 
äom
 
š‹¼u±


567 
·ck‘_št_hªdËr
 
ENDP


570 ; 
­i_driv”_šfo
 - 
G‘
 
driv”
 
	`šfÜm©iÚ
 (
FunùiÚ
 1)

572 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”


573 ; 
Ouut
: 
BX
 = 
driv”
 
v”siÚ
, 
CH
 = 
şass
, 
DH
 = 
”rÜ
 
code


574 ; 
CL
 = 
ty³
, 
DL
 = 
numb”
, 
DS
:
SI
 = 
driv”
 
Çme


575 ; 
U£s
: 
AÎ
 
ouut
 
»gi¡”s


577 
­i_driv”_šfo
 
PROC


578 
push
 
bp


579 
mov
 
bp
, 
¥


581 ; 
Check
 
high
 
³rfÜmªû
 
driv”
 
	$check
 (
AL
 = 0xFF)

582 
cmp
 
®
, 0FF
h


583 
je
 .
high_³rfÜmªû_check


585 ; 
Check
 
š‹rçû
 
	`numb”
 (
we
 
suµÜt
 0-
ba£d
 
šdexšg
)

586 
cmp
 
®
, [
š‹rçû_couÁ
]

587 
j«
 .
bad_numb”


589 ; 
R‘uº
 
driv”
 
šfÜm©iÚ
 
³r
 
Pack‘
 
Driv”
 
¥ecifiÿtiÚ


590 
mov
 
bx
, 0100
h
 ; 
V”siÚ
 1.0 (
BCD
 
fÜm©
)

591 
mov
 
ch
, 1 ; 
CÏss
 1 (
DIX
 
Eth”Ãt
)

592 
mov
 
ş
, 1 ; 
Ty³
 1 (10Ba
£
-
T
)

593 
mov
 
dl
, 
®
 ; 
IÁ”çû
 
	$numb”
 (
·s£d
 
back
)

594 
mov
 
si
, 
OFFSET
 
driv”_Çme
 ; 
DS
:
SI
 
pošts
 
to
 
driv”
 
Çme


595 
mov
 
dh
, 
PKT_SUCCESS


596 
jmp
 .
ex™


598 .
high_³rfÜmªû_check
:

599 ; 
R‘uº
 
ÿ·b™›s
 
high
 
³rfÜmªû
 
check


600 
mov
 
bx
, 0100
h
 ; 
V”siÚ
 1.0

601 
mov
 
ch
, 1 ; 
CÏss
 1 (
DIX
 
Eth”Ãt
)

602 
mov
 
ş
, 1 ; 
Ty³
 1

603 
mov
 
dl
, 1 ; 
Basic
 
funùiÚs
 
suµÜ‹d


604 
mov
 
dh
, 
PKT_SUCCESS


605 
jmp
 .
ex™


607 .
bad_numb”
:

608 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


609 
jmp
 .
ex™


611 .
ex™
:

612 
pİ
 
bp


613 
»t


614 
­i_driv”_šfo
 
ENDP


617 ; 
­i_acûss_ty³
 - 
Acûss
 
·ck‘
 
	`ty³
 (
FunùiÚ
 2)

619 ; 
IÅut
: 
AL
 = 
š‹rçû
, 
BX
 = 
·ck‘
 
ty³
, 
DL
 =…ack‘y³ 
Ëngth


620 ; 
CX
 = 
bufãr
 
size
, 
ES
:
DI
 = 
»ûiv”
 
add»ss


621 ; 
Ouut
: 
AX
 = 
hªdË
, 
DH
 = 
”rÜ
 
code


622 ; 
U£s
: 
AX
, 
DH


624 
­i_acûss_ty³
 
PROC


625 
push
 
bp


626 
mov
 
bp
, 
¥


627 
push
 
bx


628 
push
 
cx


629 
push
 
si


630 
push
 
di


632 ; 
V®id©e
 
š‹rçû
 
	$numb”
 (
AL
)

633 
cmp
 
®
, [
š‹rçû_couÁ
]

634 
j«
 .
bad_š‹rçû


636 ; 
V®id©e
 
·ck‘
 
ty³
 
	$Ëngth
 (
DL
)

637 
cmp
 
dl
, 0

638 
je
 .
u£_bx_ty³
 ; 
U£
 
BX
 
as
 
·ck‘
 
ty³
 
DL
=0

639 
cmp
 
dl
, 8 ; 
Maximum
 
ty³
 
‹m¶©e
 
Ëngth


640 
ja
 .
bad_ty³


642 .
u£_bx_ty³
:

643 ; 
Fšd
 
avaabË
 
hªdË
 
¦Ù


644 
mov
 
si
, 
OFFSET
 
hªdË_bË


645 
mov
 
cx
, 
MAX_HANDLES


646 
mov
 
ax
, 1 ; 
S¹
 
w™h
 
hªdË
 1

648 .
fšd_hªdË
:

649 
cmp
 
wÜd
 
±r
 [
si
], 0 ; 
Check
 
hªdË
 
¦Ù
 
is
 
ä“


650 
je
 .
found_hªdË


651 
add
 
si
, 2 ; 
Move
 
to
 
Ãxt
 
hªdË
 
¦Ù


652 
šc
 
ax
 ; 
Inüem’t
 
hªdË
 
numb”


653 
loİ
 .
fšd_hªdË


655 ; 
No
 
ä“
 
hªdËs
 
avaabË


656 
mov
 
dh
, 
PKT_ERROR_NO_SPACE


657 
jmp
 .
ex™


659 .
found_hªdË
:

660 ; 
AÎoÿ‹
 
hªdË
 
’Œy
 
w™h
 
ÿÎback
 
chašs


661 ; 
StÜe
 
basic
 
hªdË
 
šfÜm©iÚ


662 
mov
 [
si
], 
bx
 ; 
StÜe
 
·ck‘
 
ty³
 
š
 
hªdË
 
bË


664 ; 
C®cuÏ‹
 
ÿÎback
 
bË
 
	`šdex
 (
hªdË
 - 1) * 4

665 
dec
 
ax
 ; 
CÚv”t
 
to
 0-
ba£d
 
šdex


666 
push
 
ax
 ; 
Save
 
hªdË
 
šdex


667 
shl
 
ax
, 2 ; 
MuÉly
 
by
 4 
dwÜd
 
off£t


668 
mov
 
si
, 
ax


670 ; 
StÜe
 
ÿÎback
 
š
 
hªdË
 
w™h
 
v®id©iÚ


671 ; 
V®id©e
 
ÿÎback
 
add»ss
 
befÜe
 
¡Üšg


672 
push
 
bx


673 
push
 
cx


675 ; 
Check
 
ÿÎback
 
add»ss
 
is
 
	$v®id
 (
nÙ
 
nuÎ
,‚Ù 
š
 
low
 
memÜy
)

676 
‹¡
 
di
, di

677 
jz
 .
šv®id_ÿÎback


678 
mov
 
bx
, 
es


679 
‹¡
 
bx
, bx

680 
jz
 .
šv®id_ÿÎback


681 
cmp
 
bx
, 0040
h
 ; 
DÚ
't‡llow callbacks in interrupt vectors

682 
jb
 .
šv®id_ÿÎback


684 ; 
StÜe
 
v®id©ed
 
ÿÎback
 
add»ss


685 
mov
 
wÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
si
], 
di
 ; 
Off£t


686 
mov
 
wÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
si
 + 2], 
es
 ; 
Segm’t


688 ; 
In™Ÿlize
 
ÿÎback
 
chaš
 
mªagem’t
 
this
 
·ck‘
 
ty³


689 
ÿÎ
 
š™Ÿlize_ÿÎback_chaš


691 
pİ
 
cx


692 
pİ
 
bx


694 ; 
StÜe
 
š‹rçû
 
numb”
 
ªd
 
š™Ÿlize
 
hªdË
 
¡©e


695 
pİ
 
si
 ; 
Re¡Üe
 0-
ba£d
 
hªdË
 
šdex


696 
mov
 [
hªdË_š‹rçûs
 + 
si
], 
®
 ; 
IÁ”çû
 
numb”


697 
mov
 
by‹
 
±r
 [
hªdË_modes
 + 
si
], 
RCV_MODE_DIRECT
 ; 
DeçuÉ
 
mode


698 
mov
 
by‹
 
±r
 [
hªdË_´iÜ™›s
 + 
si
], 128 ; 
DeçuÉ
 
´iÜ™y


699 
mov
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0 ; 
CË¬
 
æags


700 
jmp
 .
hªdË_®loÿ‹d


702 .
šv®id_ÿÎback
:

703 ; 
Inv®id
 
ÿÎback
 
add»ss


704 
pİ
 
cx


705 
pİ
 
bx


706 
pİ
 
si
 ; 
CËª
 
up
 
¡ack


707 
mov
 
dh
, 
PKT_ERROR_BAD_ADDRESS


708 
jmp
 .
ex™


710 .
hªdË_®loÿ‹d
:"}

712 ; 
Inüem’t
 
aùive
 
hªdË
 
couÁ


713 
šc
 
wÜd
 
±r
 [
aùive_hªdËs
]

715 
mov
 
ax
, [
Ãxt_hªdË
] ; 
R‘uº
 
hªdË
 
numb”


716 
šc
 
wÜd
 
±r
 [
Ãxt_hªdË
] ; 
P»·»
 
Ãxt
 
hªdË


717 
mov
 
dh
, 
PKT_SUCCESS


718 
jmp
 .
ex™


720 .
bad_š‹rçû
:

721 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


722 
jmp
 .
ex™


724 .
bad_ty³
:

725 
mov
 
dh
, 
PKT_ERROR_BAD_TYPE


726 
jmp
 .
ex™


728 .
ex™
:

729 
pİ
 
di


730 
pİ
 
si


731 
pİ
 
cx


732 
pİ
 
bx


733 
pİ
 
bp


734 
»t


735 
­i_acûss_ty³
 
ENDP


738 ; 
­i_»Ëa£_ty³
 - 
R–—£
 
·ck‘
 
	`ty³
 (
FunùiÚ
 3)

740 ; 
IÅut
: 
BX
 = 
hªdË


741 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


742 ; 
U£s
: 
DH


744 
­i_»Ëa£_ty³
 
PROC


745 
push
 
bp


746 
mov
 
bp
, 
¥


747 
push
 
ax


748 
push
 
si


749 
push
 
di


751 ; 
V®id©e
 
hªdË
 
¿nge


752 
cmp
 
bx
, 1

753 
jb
 .
bad_hªdË


754 
cmp
 
bx
, 
MAX_HANDLES


755 
ja
 .
bad_hªdË


757 ; 
Check
 
hªdË
 
is
 
aùu®ly
 
®loÿ‹d


758 
dec
 
bx
 ; 
CÚv”t
 
to
 0-
ba£d
 
šdex


759 
mov
 
si
, 
bx


760 
shl
 
si
, 1 ; 
CÚv”t
 
to
 
wÜd
 
off£t
 
hªdË
 
bË


761 
add
 
si
, 
OFFSET
 
hªdË_bË


762 
cmp
 
wÜd
 
±r
 [
si
], 0 ; 
Check
 
hªdË
 
is
 
®loÿ‹d


763 
je
 .
bad_hªdË


765 ; 
Remove
 
hªdË
 
äom
 
bË
 
w™h
 
ÿÎback
 
chaš
 
ş—nup


766 ; 
G‘
 
·ck‘
 
ty³
 
befÜe
 
ş—ršg


767 
push
 
ax


768 
mov
 
ax
, 
wÜd
 
±r
 [
si
] ; 
G‘
 
·ck‘
 
ty³


769 
push
 
ax
 ; 
Save
 
·ck‘
 
ty³
 
ÿÎback
 
chaš
 
ş—nup


771 ; 
F»e
 
the
 
hªdË
 
’Œy


772 
mov
 
wÜd
 
±r
 [
si
], 0 ; 
CË¬
 
·ck‘
 
ty³


774 ; 
CË¬
 
ÿÎback
 
add»ss


775 
mov
 
ax
, 
bx
 ; 
G‘
 0-
ba£d
 
šdex


776 
shl
 
ax
, 2 ; 
CÚv”t
 
to
 
dwÜd
 
off£t


777 
mov
 
di
, 
ax


779 ; 
G‘
 
ÿÎback
 
add»ss
 
befÜe
 
ş—ršg
 
chaš
 
ş—nup


780 
mov
 
dx
, 
wÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
di
] ; 
G‘
 
ÿÎback
 
off£t


781 
push
 
wÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
di
 + 2] ; 
Save
 
ÿÎback
 
£gm’t


782 
push
 
dx
 ; 
Save
 
ÿÎback
 
off£t


784 
mov
 
dwÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
di
], 0 ; 
CË¬
 
ÿÎback


786 ; 
Remove
 
ÿÎback
 
äom
 
·ck‘
 
ty³
 c®lback 
chaš


787 
pİ
 
dx
 ; 
Re¡Üe
 
ÿÎback
 
off£t


788 
pİ
 
ax
 ; 
Re¡Üe
 
ÿÎback
 
£gm’t


789 
pİ
 
cx
 ; 
Re¡Üe
 
·ck‘
 
ty³


790 
ÿÎ
 
»move_ÿÎback_äom_chaš
 ; 
CËª
 
up
 
ÿÎback
 
chašs


792 
pİ
 
ax
 ; 
Re¡Üe
 
Üigš®
 
AX


794 ; 
CË¬
 
š‹rçû
 
ªd
 
mode
 
šfo


795 
mov
 
by‹
 
±r
 [
hªdË_š‹rçûs
 + 
bx
], 0 ; 
CË¬
 
š‹rçû


796 
mov
 
by‹
 
±r
 [
hªdË_modes
 + 
bx
], 0 ; 
CË¬
 
mode


797 
mov
 
by‹
 
±r
 [
hªdË_´iÜ™›s
 + 
bx
], 128 ; 
Re£t
 
´iÜ™y


798 
mov
 
wÜd
 
±r
 [
hªdË_æags
 + 
bx
 * 2], 0 ; 
CË¬
 
æags
"}

800 ; 
Deüem’t
 
aùive
 
hªdË
 
couÁ


801 
cmp
 
wÜd
 
±r
 [
aùive_hªdËs
], 0

802 
je
 .
couÁ_ok
 ; 
DÚ
't underflow

803 
dec
 
wÜd
 
±r
 [
aùive_hªdËs
]

805 .
couÁ_ok
:

806 
mov
 
dh
, 
PKT_SUCCESS


807 
jmp
 .
ex™


809 .
bad_hªdË
:

810 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


811 
jmp
 .
ex™


813 .
ex™
:

814 
pİ
 
di


815 
pİ
 
si


816 
pİ
 
ax


817 
pİ
 
bp


818 
»t


819 
­i_»Ëa£_ty³
 
ENDP


822 ; 
­i_£nd_·ck‘
 - 
S’d
 
	`·ck‘
 (
FunùiÚ
 4)

824 ; 
IÅut
: 
DS
:
SI
 = 
·ck‘
 
to
 
£nd
, 
CX
 =…ack‘ 
Ëngth


825 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


826 ; 
U£s
: 
DH


828 
­i_£nd_·ck‘
 
PROC


829 
push
 
bp


830 
mov
 
bp
, 
¥


831 
push
 
ax


832 
push
 
bx


834 ; 
V®id©e
 
·ck‘
 
Ëngth
 
m“ts
 
mšimum
/
maximum
 
»quœem’ts


835 ; 
C®l
 
h¬dw¬e
-
¥ecific
 
£nd
 
routše
 
ba£d
 
Ú
 
NIC
 
ty³


836 ; 
HªdË
 
muÉË
 
NICs
 
w™h
 
lßd
 
b®ªcšg
 
ªd
 
routšg


838 ; 
V®id©e
 
·ck‘
 
·¿m‘”s
 
w™h
 
’hªûd
 
checks


839 ; 
Com´eh’sive
 
·ck‘
 
v®id©iÚ
 
§ãty


841 ; 
V®id©e
 
·ck‘
 
Ëngth


842 
‹¡
 
cx
, cx ; 
Check
 
z”o
 
Ëngth


843 
jz
 .
bad_Ëngth


844 
cmp
 
cx
, 60 ; 
Mšimum
 
Eth”Ãt
 
äame
 
size


845 
jb
 .
bad_Ëngth


846 
cmp
 
cx
, 1514 ; 
Maximum
 
Eth”Ãt
 
äame
 
size


847 
ja
 .
bad_Ëngth


849 ; 
V®id©e
 
·ck‘
 
bufãr
 
poš‹r


850 
‹¡
 
si
, s˜; 
Check
 
nuÎ
 
off£t


851 
jz
 .
bad_bufãr


853 ; 
V®id©e
 
d©a
 
	$£gm’t
 (
basic
 
check
)

854 
push
 
ax


855 
mov
 
ax
, 
ds


856 
‹¡
 
ax
,‡x ; 
Check
 
nuÎ
 
£gm’t


857 
jz
 .
bad_bufãr_£g


859 ; 
Check
 
we
 
ÿn
 
»ad
 
the
 
fœ¡
 
by‹
 
§ãly


860 
push
 
es


861 
push
 
di


862 
mov
 
es
, 
ax
 ; 
S‘
 
ES
 
to
 
DS


863 
mov
 
di
, 
si
 ; 
Pošt
 
to
 
·ck‘
 
¡¬t


864 
mov
 
®
, 
es
:[
di
] ; 
Try
 
to
 
»ad
 
fœ¡
 
by‹


865 
pİ
 
di


866 
pİ
 
es


867 
pİ
 
ax


868 
jmp
 .
v®id©iÚ_com¶‘e


870 .
bad_bufãr_£g
:

871 
pİ
 
ax


872 .
bad_bufãr
:

873 
mov
 
dh
, 
PKT_ERROR_BAD_ADDRESS


874 
jmp
 .
ex™


876 .
v®id©iÚ_com¶‘e
:"}

878 ; 
Bridge
 
to
 
C
 
·ck‘_£nd
 
funùiÚ
 
vŸ
 
vbË
 
di¥©ch


879 ; 
CÚv”t
 
DOS
 
ÿÎšg
 
cÚv’tiÚ
 
to
 
C
 calling convention

880 ; 
DOS
 
šput
: 
DS
:
SI
 = 
·ck‘
 
bufãr
, 
CX
 =…ack‘ 
Ëngth


881 ; 
C
 
sigÇtu»
: 
	`·ck‘_£nd
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
, 
ušt16_t
 
hªdË
)

883 ; 
Push
 
·¿m‘”s
 
C
 
ÿÎšg
 
	$cÚv’tiÚ
 (
right
 
to
 
Ëá
)

884 
push
 0 ; 
hªdË
 
	`·¿m‘”
 (
ušt16_t
è- 
u£
 0 

885 
push
 
cx
 ; 
Ëngth
 
	$·¿m‘”
 (
size_t
)

886 
push
 
si
 ; 
·ck‘
 
bufãr
 
	$off£t
 (cÚ¡ 
ušt8_t
 *)

887 
push
 
ds
 ; 
·ck‘
 
bufãr
 
£gm’t


889 ; 
C®l
 
C
 
funùiÚ


890 
ÿÎ
 
_·ck‘_£nd


891 
add
 
¥
, 8 ; 
CËª
 
	`¡ack
 (4 
·¿m‘”s
 Ã— 2 
by‹s
 
—ch
)

893 ; 
CÚv”t
 
C
  
v®ue
 
to
 
DOS
 
·ck‘
 
driv”
 
”rÜ
 
code


894 ; 
C
 
»tuºs
: 0=
sucûss
, 
Ãg©ive
=
”rÜ


895 
cmp
 
ax
, 0

896 
jl
 .
£nd_”rÜ
 ; 
Jump
 
	$Ãg©ive
 (
”rÜ
)

898 
mov
 
dh
, 
PKT_SUCCESS


899 
jmp
 .
ex™


901 .
bad_Ëngth
:

902 
mov
 
dh
, 
PKT_ERROR_CANT_SEND


903 
jmp
 .
ex™


905 .
£nd_”rÜ
:

906 
mov
 
dh
, 
PKT_ERROR_CANT_SEND


907 
jmp
 .
ex™


909 .
ex™
:

910 
pİ
 
bx


911 
pİ
 
ax


912 
pİ
 
bp


913 
»t


914 
­i_£nd_·ck‘
 
ENDP


917 ; 
­i_‹rmš©e
 - 
T”mš©e
 
	`driv”
 (
FunùiÚ
 5)

919 ; 
IÅut
: 
BX
 = 
	`hªdË
 (
mu¡
 
be
 
§me
 
as
 
»tuºed
 
by
 
acûss_ty³
)

920 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


921 ; 
U£s
: 
DH


923 
­i_‹rmš©e
 
PROC


924 
push
 
bp


925 
mov
 
bp
, 
¥


927 ; 
V®id©e
 
‹rmš©iÚ
 
»que¡
 
äom
 
authÜized
 
ÿÎ”


928 ; 
Check
 
§ã
 
to
 
	`‹rmš©e
 (
no
 
aùive
 
cÚÃùiÚs
)

929 ; 
Re¡Üe
 
Üigš®
 
š‹¼u±
 
veùÜs
 
befÜe
 
ex™


930 ; 
F»e
 
®loÿ‹d
 
memÜy
 
blocks
 
ªd
 
ş—nup
 
»sourûs


932 ; 
FÜ
 
now
, 
»fu£
 
	$‹rmš©iÚ
 (
driv”
 
¡ays
 
»sid’t
)

933 
mov
 
dh
, 
PKT_ERROR_CANT_TERMINATE


935 
pİ
 
bp


936 
»t


937 
­i_‹rmš©e
 
ENDP


940 ; 
­i_g‘_add»ss
 - 
G‘
 
¡©iÚ
 
	`add»ss
 (
FunùiÚ
 6)

942 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”
, 
CX
 = 
bufãr
 
size
, 
ES
:
DI
 = buffer

943 ; 
Ouut
: 
CX
 = 
add»ss
 
Ëngth
, 
DH
 = 
”rÜ
 
code


944 ; 
U£s
: 
CX
, 
DH


946 
­i_g‘_add»ss
 
PROC


947 
push
 
bp


948 
mov
 
bp
, 
¥


949 
push
 
ax


950 
push
 
bx


951 
push
 
si


953 ; 
V®id©e
 
š‹rçû
 
numb”
 
is
 
w™hš
 
suµÜ‹d
 
¿nge


954 ; 
G‘
 
MAC
 
add»ss
 
äom
 
h¬dw¬e
 
»gi¡”s
 
Ü
 
EEPROM


955 ; 
Cİy
 
MAC
 
add»ss
 
to
 
u£r
-
´ovided
 
bufãr
 
w™h
 
v®id©iÚ


957 ; 
Check
 
š‹rçû
 
numb”


958 
cmp
 
®
, [
š‹rçû_couÁ
]

959 
j«
 .
bad_numb”


961 ; 
Check
 
bufãr
 
	$size
 (
Ãed
 6 
by‹s
 
Eth”Ãt
 
MAC
)

962 
cmp
 
cx
, 6

963 
jb
 .
bad_bufãr


965 ; 
Bridge
 
to
 
C
 
pd_g‘_add»ss
 
funùiÚ
 
vŸ
 
vbË
 
di¥©ch


966 ; 
CÚv”t
 
DOS
 
ÿÎšg
 
cÚv’tiÚ
 
to
 
C
 calling convention

967 ; 
DOS
 
šput
: 
AL
 = 
š‹rçû
 
numb”
, 
ES
:
DI
 = 
bufãr
, 
CX
 = bufã¸
size


968 ; 
C
 
sigÇtu»
: 
	`pd_g‘_add»ss
(
ušt16_t
 
hªdË
, 
pd_add»ss_t
 *
addr
)

970 ; 
CÚv”t
 
	$AL
 (
š‹rçû
 
numb”
è
to
 
hªdË
 - 
now
 
u£
 
AL
 
as
 handle

971 
mov
 
ah
, 0 ; 
Z”o
 
ex‹nd
 
AL
 
to
 
AX
 
hªdË


973 ; 
Push
 
·¿m‘”s
 
C
 
ÿÎšg
 
	$cÚv’tiÚ
 (
right
 
to
 
Ëá
)

974 
push
 
di
 ; 
bufãr
 
	$off£t
 (
pd_add»ss_t
 *
addr
)

975 
push
 
es
 ; 
bufãr
 
£gm’t


976 
push
 
ax
 ; 
	`hªdË
 (
äom
 
AL
, 
z”o
-
ex‹nded
)

978 ; 
C®l
 
C
 
funùiÚ


979 
ÿÎ
 
_pd_g‘_add»ss


980 
add
 
¥
, 6 ; 
CËª
 
	`¡ack
 (3 
·¿m‘”s
 Ã— 2 
by‹s
 
—ch
)

982 ; 
CÚv”t
 
C
  
to
 
DOS
 
”rÜ
 
code


983 ; 
C
 
»tuºs
: 0=
sucûss
, 
Ãg©ive
=
”rÜ


984 
cmp
 
ax
, 0

985 
jl
 .
g‘_”rÜ
 ; 
Jump
 
	`Ãg©ive
 (
”rÜ
)

987 ; 
Sucûss
 - 
add»ss
 
should
 
be
 
cİ›d
 
by
 
C
 
funùiÚ


988 
mov
 
cx
, 6 ; 
Add»ss
 
	$Ëngth
 (
Eth”Ãt
 
MAC
)

989 
mov
 
dh
, 
PKT_SUCCESS


990 
jmp
 .
ex™


992 .
bad_numb”
:

993 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


994 
jmp
 .
ex™


996 .
bad_bufãr
:

997 
mov
 
dh
, 
PKT_ERROR_BAD_ADDRESS


998 
jmp
 .
ex™


1000 .
g‘_”rÜ
:

1001 
mov
 
dh
, 
PKT_ERROR_BAD_ADDRESS


1002 
jmp
 .
ex™


1004 .
ex™
:

1005 
pİ
 
si


1006 
pİ
 
bx


1007 
pİ
 
ax


1008 
pİ
 
bp


1009 
»t


1010 
­i_g‘_add»ss
 
ENDP


1013 ; 
­i_»£t_š‹rçû
 - 
Re£t
 
	`š‹rçû
 (
FunùiÚ
 7)

1015 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”


1016 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1017 ; 
U£s
: 
DH


1019 
­i_»£t_š‹rçû
 
PROC


1020 
push
 
bp


1021 
mov
 
bp
, 
¥


1023 ; 
V®id©e
 
š‹rçû
 
numb”


1024 
cmp
 
®
, [
š‹rçû_couÁ
]

1025 
j«
 .
bad_š‹rçû


1027 ; 
FunùiÚ
 7 (
RESET
è- 
Com¶‘e
 
h¬dw¬e
 
ªd
 
soáw¬e
 
»£t


1028 ; 
Re£t
 
ÿÎback
 
chašs
, 
hªdË
 
¡©e
, 
ªd
 
h¬dw¬e
 
¥ecif›d
 
š‹rçû


1029 
push
 
si


1030 
push
 
di


1031 
push
 
cx


1032 
push
 
bx


1034 ; 
CË¬
 
ÿÎback
 
chašs
 
assocŸ‹d
 
w™h
 
this
 
š‹rçû


1035 
mov
 
si
, 0 ; 
S¹
 
w™h
 
fœ¡
 
hªdË


1036 
mov
 
cx
, 
MAX_HANDLES


1038 .
»£t_hªdË_loİ
:

1039 ; 
Check
 
hªdË
 
is
 
®loÿ‹d
 
ªd
 
m©ches
 
š‹rçû


1040 
cmp
 
wÜd
 
±r
 [
hªdË_bË
 + 
si
 * 2], 0

1041 
je
 .
Ãxt_hªdË


1043 
cmp
 
by‹
 
±r
 [
hªdË_š‹rçûs
 + 
si
], 
®


1044 
jÃ
 .
Ãxt_hªdË


1046 ; 
CË¬
 
ÿÎback
 
this
 
hªdË


1047 
push
 
ax


1048 
mov
 
ax
, 
si


1049 
shl
 
ax
, 2 ; 
CÚv”t
 
to
 
dwÜd
 
off£t


1050 
mov
 
di
, 
ax


1051 
mov
 
dwÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
di
], 0

1052 
pİ
 
ax


1054 ; 
Re£t
 
hªdË
 
´iÜ™›s
 
ªd
 
æags


1055 
mov
 
by‹
 
±r
 [
hªdË_´iÜ™›s
 + 
si
], 128 ; 
Re£t
 
to
  
´iÜ™y


1056 
mov
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0 ; 
CË¬
 
®l
 
æags


1058 .
Ãxt_hªdË
:

1059 
šc
 
si


1060 
loİ
 .
»£t_hªdË_loİ


1062 ; 
Re£t
 
h¬dw¬e
-
¥ecific
 
¡©e
 
the
 
¥ecif›d
 
NIC


1063 ; 
P”fÜm
 
com¶‘e
 
h¬dw¬e
 
»£t
 
£qu’û


1064 
push
 
ax


1065 
push
 
dx


1067 ; 
D‘”mše
 
which
 
NIC
 
to
 
»£t
 
ba£d
 
Ú
 
š‹rçû
 
numb”


1068 
cmp
 
®
, 0

1069 
je
 .
»£t_nic0


1070 
cmp
 
®
, 1

1071 
je
 .
»£t_nic1


1072 
jmp
 .
sk_hw_»£t


1074 .
»£t_nic0
:

1075 ; 
Re£t
 
fœ¡
 
	`NIC
 (
assumed
 
to
 
be
 
©
 
¡ªd¬d
 
I
/
O
 
ba£
)

1076 
mov
 
dx
, 0x300 ; 
Snd¬d
 3C509B 
ba£
 
add»ss


1077 
ÿÎ
 
»£t_3c509b_h¬dw¬e


1078 
jmp
 .
hw_»£t_dÚe


1080 .
»£t_nic1
:

1081 ; 
Re£t
 
£cÚd
 
NIC


1082 
mov
 
dx
, 0x310 ; 
SecÚd¬y
 
NIC
 
ba£
 
add»ss


1083 
ÿÎ
 
»£t_3c515_h¬dw¬e


1085 .
hw_»£t_dÚe
:

1086 ; 
CË¬
 
·ck‘
 
bufãrs
 
this
 
š‹rçû


1087 
ÿÎ
 
ş—r_š‹rçû_bufãrs


1089 ; 
Re£t
 
š‹rçû
 
¡©i¡ics


1090 
movzx
 
si
, 
®


1091 
shl
 
si
, 1 ; 
WÜd
 
off£t


1092 
mov
 
wÜd
 
±r
 [
nic_”rÜ_couÁs
 + 
si
], 0

1093 
mov
 
wÜd
 
±r
 [
nic_utiz©iÚ
 + 
si
], 0

1095 .
sk_hw_»£t
:

1096 
pİ
 
dx


1097 
pİ
 
ax


1099 
pİ
 
bx


1100 
pİ
 
cx


1101 
pİ
 
di


1102 
pİ
 
si


1104 
mov
 
dh
, 
PKT_SUCCESS


1105 
jmp
 .
ex™


1107 .
bad_š‹rçû
:

1108 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1110 .
ex™
:

1111 
pİ
 
bp


1112 
»t


1113 
­i_»£t_š‹rçû
 
ENDP


1116 ; 
­i_g‘_·¿m‘”s
 - 
G‘
 
š‹rçû
 
	`·¿m‘”s
 (
FunùiÚ
 8)

1118 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”


1119 ; 
Ouut
: 
DH
 = 
”rÜ
 
code
, 
Ùh”
 
»gi¡”s
 
w™h
 
·¿m‘”
 
d©a


1120 ; 
U£s
: 
MuÉË
 
»gi¡”s


1122 
­i_g‘_·¿m‘”s
 
PROC


1123 
push
 
bp


1124 
mov
 
bp
, 
¥


1126 ; 
V®id©e
 
š‹rçû
 
numb”


1127 
cmp
 
®
, [
š‹rçû_couÁ
]

1128 
j«
 .
bad_š‹rçû


1130 ; 
FunùiÚ
 9 (
GET_PARAMETERS
è- 
R‘uº
 
com´eh’sive
 
š‹rçû
 
·¿m‘”s


1131 ; 
R‘uº
 
®l
 
š‹rçû
 
·¿m‘”s
 
³r
 
Pack‘
 
Driv”
 
S³cifiÿtiÚ


1132 
push
 
bx


1133 
push
 
si


1135 ; 
Basic
 
Eth”Ãt
 
·¿m‘”s


1136 
mov
 
cx
, 6 ; 
Add»ss
 
	$Ëngth
 (
MAC
 
add»ss
)

1137 
mov
 
dx
, 14 ; 
H—d”
 
	`Ëngth
 (
Eth”Ãt
 
h—d”
)

1139 ; 
Ex‹nded
 
·¿m‘”s
 
muÉËxšg
 
ÿ·b™›s


1140 
mov
 
bx
, 
MAX_TYPE_CALLBACKS
 ; 
Maximum
 
ÿÎbacks
 
³r
 
·ck‘
 
ty³


1141 
mov
 
si
, 
MAX_HANDLES
 ; 
Maximum
 
hªdËs
 
suµÜ‹d


1143 ; 
Add™iÚ®
 
·¿m‘”s
 
š
 
unu£d
 
»gi¡”s


1144 ; 
BH
 = 
muÉËxšg
 
’abËd
 
æag


1145 
mov
 
bh
, 1 ; 
MuÉËxšg
 
suµÜ‹d


1147 ; 
BL
 = 
ex‹nded
 
ã©u»s
 
suµÜ‹d


1148 
mov
 
bl
, 00001111b ; 
PriÜ™y
=1, 
QoS
=1, 
LßdB®ªû
=1, 
F‹ršg
=1

1150 
pİ
 
si


1151 
pİ
 
bx


1152 
mov
 
dh
, 
PKT_SUCCESS


1153 
jmp
 .
ex™


1155 .
bad_š‹rçû
:

1156 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1158 .
ex™
:

1159 
pİ
 
bp


1160 
»t


1161 
­i_g‘_·¿m‘”s
 
ENDP


1164 ; 
­i_as_£nd_·ck‘
 - 
AÉ”Çtive
 
£nd
 
	`·ck‘
 (
FunùiÚ
 9)

1166 ; 
IÅut
: 
CX
 = 
Ëngth
, 
DS
:
SI
 = 
·ck‘
 
d©a


1167 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1168 ; 
U£s
: 
DH


1170 
­i_as_£nd_·ck‘
 
PROC


1171 
push
 
bp


1172 
mov
 
bp
, 
¥


1174 ; 
FÜ
 
now
, 
ju¡
 
ÿÎ
 
»guÏr
 
£nd
 
·ck‘


1175 
ÿÎ
 
­i_£nd_·ck‘


1177 
pİ
 
bp


1178 
»t


1179 
­i_as_£nd_·ck‘
 
ENDP


1182 ; 
­i_£t_rcv_mode
 - 
S‘
 
»ûive
 
	`mode
 (
FunùiÚ
 20)

1184 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”
, 
CX
 = 
mode


1185 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1186 ; 
U£s
: 
DH


1188 
­i_£t_rcv_mode
 
PROC


1189 
push
 
bp


1190 
mov
 
bp
, 
¥


1191 
push
 
bx


1193 ; 
V®id©e
 
š‹rçû
 
numb”


1194 
cmp
 
®
, [
š‹rçû_couÁ
]

1195 
j«
 .
bad_š‹rçû


1197 ; 
V®id©e
 
mode


1198 
cmp
 
cx
, 
RCV_MODE_PROMISCUOUS


1199 
ja
 .
bad_mode


1201 ; 
StÜe
 
cu¼’t
 
»ûive
 
mode


1202 
mov
 [
cu¼’t_rcv_mode
], 
ş


1204 ; 
Bridge
 
to
 
C
 
pd_£t_rcv_mode
 
funùiÚ
 
vŸ
 
vbË
 
di¥©ch


1205 ; 
CÚv”t
 
DOS
 
ÿÎšg
 
cÚv’tiÚ
 
to
 
C
 calling convention

1206 ; 
DOS
 
šput
: 
AL
 = 
š‹rçû
 
numb”
, 
CX
 = 
mode


1207 ; 
C
 
sigÇtu»
: 
	$pd_£t_rcv_mode
(
ušt16_t
 
hªdË
, *
·¿ms
)

1209 
sub
 
¥
, 2 ; 
AÎoÿ‹
 
¥aû
 
mode
 
·¿m‘”
 
Ú
 
¡ack


1210 
mov
 [
bp
-4], 
cx
 ; 
StÜe
 
mode
 
Ú
 
	`¡ack
 (
accouÁ
 
pushed
 
bx
)

1212 ; 
CÚv”t
 
	$AL
 (
š‹rçû
 
numb”
è
to
 
hªdË


1213 
mov
 
ah
, 0 ; 
Z”o
 
ex‹nd
 
AL
 
to
 
AX
 
hªdË


1215 ; 
Push
 
·¿m‘”s
 
C
 
ÿÎšg
 
	$cÚv’tiÚ
 (
right
 
to
 
Ëá
)

1216 
Ëa
 
dx
, [
bp
-4] ; 
G‘
 
add»ss
 
of
 
mode
 
·¿m‘”


1217 
push
 
dx
 ; 
·¿ms
 
	$poš‹r
 (*
·¿ms
)

1218 
push
 
ax
 ; 
	`hªdË
 (
ušt16_t
 
hªdË
)

1220 ; 
C®l
 
C
 
funùiÚ


1221 
ÿÎ
 
_pd_£t_rcv_mode


1222 
add
 
¥
, 4 ; 
CËª
 
	`¡ack
 (2 
·¿m‘”s
 Ã— 2 
by‹s
 
—ch
)

1224 ; 
CÚv”t
 
C
  
to
 
DOS
 
”rÜ
 
code


1225 
cmp
 
ax
, 0

1226 
jl
 .
mode_”rÜ
 ; 
Jump
 
	$Ãg©ive
 (
”rÜ
)

1228 
add
 
¥
, 2 ; 
Re¡Üe
 
¡ack
 
	$poš‹r
 (
d—Îoÿ‹
 
mode
 
v¬ŸbË
)

1229 
mov
 
dh
, 
PKT_SUCCESS


1230 
jmp
 .
ex™


1232 .
mode_”rÜ
:

1233 
add
 
¥
, 2 ; 
Re¡Üe
 
¡ack
 
	$poš‹r
 (
d—Îoÿ‹
 
mode
 
v¬ŸbË
)

1234 
mov
 
dh
, 
PKT_ERROR_BAD_MODE


1235 
jmp
 .
ex™


1237 .
bad_š‹rçû
:

1238 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1239 
jmp
 .
ex™


1241 .
bad_mode
:

1242 
mov
 
dh
, 
PKT_ERROR_BAD_MODE


1244 .
ex™
:

1245 
pİ
 
bx


1246 
pİ
 
bp


1247 
»t


1248 
­i_£t_rcv_mode
 
ENDP


1251 ; 
­i_g‘_rcv_mode
 - 
G‘
 
»ûive
 
	`mode
 (
FunùiÚ
 21)

1253 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”


1254 ; 
Ouut
: 
AX
 = 
mode
, 
DH
 = 
”rÜ
 
code


1255 ; 
U£s
: 
AX
, 
DH


1257 
­i_g‘_rcv_mode
 
PROC


1258 
push
 
bp


1259 
mov
 
bp
, 
¥


1261 ; 
V®id©e
 
š‹rçû
 
numb”


1262 
cmp
 
®
, [
š‹rçû_couÁ
]

1263 
j«
 .
bad_š‹rçû


1265 ; 
R‘uº
 
cu¼’t
 
»ûive
 
mode


1266 
mov
 
®
, [
cu¼’t_rcv_mode
]

1267 
mov
 
ah
, 0

1268 
mov
 
dh
, 
PKT_SUCCESS


1269 
jmp
 .
ex™


1271 .
bad_š‹rçû
:

1272 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1274 .
ex™
:

1275 
pİ
 
bp


1276 
»t


1277 
­i_g‘_rcv_mode
 
ENDP


1280 ; 
­i_£t_muÉiÿ¡
 - 
S‘
 
muÉiÿ¡
 
	`li¡
 (
FunùiÚ
 22)

1282 ; 
IÅut
: 
AL
 = 
š‹rçû
, 
CX
 = 
couÁ
, 
DS
:
SI
 = 
add»ss
 
li¡


1283 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1284 ; 
U£s
: 
DH


1286 
­i_£t_muÉiÿ¡
 
PROC


1287 
push
 
bp


1288 
mov
 
bp
, 
¥


1290 ; 
V®id©e
 
š‹rçû
 
numb”


1291 
cmp
 
®
, [
š‹rçû_couÁ
]

1292 
j«
 .
bad_š‹rçû


1294 ; 
Im¶em’t
 
muÉiÿ¡
 
add»ss
 
mªagem’t


1295 
push
 
bx


1296 
push
 
si


1297 
push
 
di


1298 
push
 
es


1300 ; 
V®id©e
 
	$couÁ
 (
max
 16 
muÉiÿ¡
 
add»s£s
 
typiÿl
 3C
om
)

1301 
cmp
 
cx
, 16

1302 
ja
 .
too_mªy


1304 ; 
AÎoÿ‹
 
¥aû
 
muÉiÿ¡
 
li¡
 
Ãeded


1305 
‹¡
 
cx
, cx

1306 
jz
 .
ş—r_muÉiÿ¡


1308 ; 
Cİy
 
muÉiÿ¡
 
add»s£s
 
to
 
š‹º®
 
bufãr


1309 
push
 
cx
 ; 
Save
 
couÁ


1310 
push
 
ds


1311 
push
 
si
 ; 
Save
 
sourû


1313 ; 
Pošt
 
to
 
muÉiÿ¡
 
¡Üage
 
¬—


1314 
mov
 
di
, 
OFFSET
 
muÉiÿ¡_li¡


1315 
push
 
cs


1316 
pİ
 
es
 ; 
ES
:
DI
 = 
de¡š©iÚ


1318 ; 
C®cuÏ‹
 
by‹s
 
to
 
	$cİy
 (6 
by‹s
 
³r
 
MAC
 
add»ss
)

1319 
mov
 
ax
, 
cx


1320 
mov
 
bx
, 6

1321 
mul
 
bx
 ; 
AX
 = 
by‹s
 
to
 
cİy


1322 
mov
 
cx
, 
ax


1323 
shr
 
cx
, 1 ; 
CÚv”t
 
to
 
wÜds


1325 ; 
Cİy
 
add»s£s


1326 
şd


1327 
»p
 
movsw


1328 
‹¡
 
ax
, 1 ; 
Odd
 
by‹
?

1329 
jz
 .
cİy_dÚe


1330 
movsb
 ; 
Cİy
 
Ï¡
 
by‹


1332 .
cİy_dÚe
:

1333 
pİ
 
si


1334 
pİ
 
ds


1335 
pİ
 
cx
 ; 
Re¡Üe
 
couÁ


1337 ; 
StÜe
 
couÁ


1338 
mov
 [
muÉiÿ¡_couÁ
], 
ş


1340 ; 
Prog¿m
 
h¬dw¬e
 
w™h
 
muÉiÿ¡
 
li¡


1341 
ÿÎ
 
£t_h¬dw¬e_muÉiÿ¡


1343 
mov
 
dh
, 
PKT_SUCCESS


1344 
jmp
 .
ş—nup


1346 .
ş—r_muÉiÿ¡
:

1347 ; 
CË¬
 
®l
 
muÉiÿ¡
 
add»s£s


1348 
mov
 
by‹
 
±r
 [
muÉiÿ¡_couÁ
], 0

1349 
ÿÎ
 
ş—r_h¬dw¬e_muÉiÿ¡


1350 
mov
 
dh
, 
PKT_SUCCESS


1351 
jmp
 .
ş—nup


1353 .
too_mªy
:

1354 
mov
 
dh
, 
PKT_ERROR_NO_MULTICAST


1356 .
ş—nup
:

1357 
pİ
 
es


1358 
pİ
 
di


1359 
pİ
 
si


1360 
pİ
 
bx


1361 
jmp
 .
ex™


1363 .
bad_š‹rçû
:

1364 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1366 .
ex™
:

1367 
pİ
 
bp


1368 
»t


1369 
­i_£t_muÉiÿ¡
 
ENDP


1372 ; 
­i_g‘_muÉiÿ¡
 - 
G‘
 
muÉiÿ¡
 
	`li¡
 (
FunùiÚ
 23)

1374 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”


1375 ; 
Ouut
: 
CX
 = 
couÁ
, 
DS
:
SI
 = 
add»ss
 
li¡
, 
DH
 = 
”rÜ
 
code


1376 ; 
U£s
: 
CX
, 
DH


1378 
­i_g‘_muÉiÿ¡
 
PROC


1379 
push
 
bp


1380 
mov
 
bp
, 
¥


1382 ; 
V®id©e
 
š‹rçû
 
numb”


1383 
cmp
 
®
, [
š‹rçû_couÁ
]

1384 
j«
 .
bad_š‹rçû


1386 ; 
R‘uº
 
aùu®
 
muÉiÿ¡
 
li¡


1387 
push
 
si


1388 
push
 
di


1389 
push
 
es


1391 ; 
G‘
 
muÉiÿ¡
 
couÁ


1392 
movzx
 
cx
, 
by‹
 
±r
 [
muÉiÿ¡_couÁ
]

1393 
‹¡
 
cx
, cx

1394 
jz
 .
no_muÉiÿ¡


1396 ; 
S‘
 
up
 
sourû
 
poš‹r


1397 
push
 
cs


1398 
pİ
 
es


1399 
mov
 
di
, 
OFFSET
 
muÉiÿ¡_li¡


1401 ; 
DS
:
SI
 
should
 
pošt
 
to
 
ÿÎ”
's buffer (already set)

1402 ; 
Cİy
 
muÉiÿ¡
 
add»s£s
 
to
 
ÿÎ”
's buffer

1403 
push
 
cx
 ; 
Save
 
couÁ


1404 
mov
 
ax
, 
cx


1405 
mov
 
bx
, 6

1406 
mul
 
bx
 ; 
AX
 = 
by‹s
 
to
 
cİy


1407 
mov
 
cx
, 
ax


1408 
shr
 
cx
, 1 ; 
CÚv”t
 
to
 
wÜds


1410 
push
 
ds


1411 
push
 
si


1413 ; 
Sw­
 
sourû
 
ªd
 
de¡š©iÚ
 
cİy


1414 
push
 
es


1415 
push
 
di


1416 
pİ
 
si


1417 
pİ
 
ds
 ; 
DS
:
SI
 = 
our
 
li¡


1418 ; 
ES
:
DI
 = 
ÿÎ”
's buffer (from original DS:SI)

1419 
pİ
 
di


1420 
pİ
 
es


1422 
şd


1423 
»p
 
movsw


1424 
‹¡
 
ax
, 1

1425 
jz
 .
cİy_com¶‘e


1426 
movsb


1428 .
cİy_com¶‘e
:

1429 
pİ
 
cx
 ; 
Re¡Üe
 
couÁ


1431 .
no_muÉiÿ¡
:

1432 
mov
 
dh
, 
PKT_SUCCESS


1434 
pİ
 
es


1435 
pİ
 
di


1436 
pİ
 
si


1437 
jmp
 .
ex™


1439 .
bad_š‹rçû
:

1440 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1442 .
ex™
:

1443 
pİ
 
bp


1444 
»t


1445 
­i_g‘_muÉiÿ¡
 
ENDP


1448 ; 
­i_g‘_¡©i¡ics
 - 
G‘
 
driv”
 
	`¡©i¡ics
 (
FunùiÚ
 24)

1450 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”


1451 ; 
Ouut
: 
Sti¡ics
 
š
 
»gi¡”s
, 
DH
 = 
”rÜ
 
code


1452 ; 
U£s
: 
MuÉË
 
»gi¡”s


1454 
­i_g‘_¡©i¡ics
 
PROC


1455 
push
 
bp


1456 
mov
 
bp
, 
¥


1458 ; 
V®id©e
 
š‹rçû
 
numb”


1459 
cmp
 
®
, [
š‹rçû_couÁ
]

1460 
j«
 .
bad_š‹rçû


1462 ; 
Bridge
 
to
 
C
 
pd_g‘_¡©i¡ics
 
funùiÚ
 
vŸ
 
vbË
 
di¥©ch


1463 ; 
CÚv”t
 
DOS
 
ÿÎšg
 
cÚv’tiÚ
 
to
 
C
 calling convention

1464 ; 
DOS
 
šput
: 
AL
 = 
š‹rçû
 
numb”


1465 ; 
C
 
sigÇtu»
: 
	`pd_g‘_¡©i¡ics
(
ušt16_t
 
hªdË
, 
pd_¡©i¡ics_t
 *
¡©s
)

1467 ; 
We
 
Ãed
 
a
 
bufãr
 
¡©i¡ics
 - 
u£
 
¡ack
 
¥aû


1468 
sub
 
¥
, 32 ; 
AÎoÿ‹
 32 
by‹s
 
¡©i¡ics
 
¡ruùu»


1470 ; 
CÚv”t
 
	$AL
 (
š‹rçû
 
numb”
è
to
 
hªdË


1471 
mov
 
ah
, 0 ; 
Z”o
 
ex‹nd
 
AL
 
to
 
AX
 
hªdË


1473 ; 
Push
 
·¿m‘”s
 
C
 
ÿÎšg
 
	$cÚv’tiÚ
 (
right
 
to
 
Ëá
)

1474 
Ëa
 
dx
, [
bp
-32] ; 
G‘
 
add»ss
 
of
 
¡©i¡ics
 
bufãr
 
Ú
 
¡ack


1475 
push
 
dx
 ; 
¡©s
 
bufãr
 
	$off£t
 (
pd_¡©i¡ics_t
 *
¡©s
)

1476 
push
 
ss
 ; 
¡©s
 
bufãr
 
	$£gm’t
 (
¡ack
 
£gm’t
)

1477 
push
 
ax
 ; 
	`hªdË
 (
ušt16_t
 
hªdË
)

1479 ; 
C®l
 
C
 
funùiÚ


1480 
ÿÎ
 
_pd_g‘_¡©i¡ics


1481 
add
 
¥
, 6 ; 
CËª
 
	`¡ack
 (3 
·¿m‘”s
 Ã— 2 
by‹s
 
—ch
)

1483 ; 
CÚv”t
 
C
  
to
 
DOS
 
”rÜ
 
code


1484 
cmp
 
ax
, 0

1485 
jl
 .
¡©s_”rÜ
 ; 
Jump
 
	`Ãg©ive
 (
”rÜ
)

1487 ; 
Sucûss
 - 
exŒaù
 
key
 
¡©i¡ics
 
äom
 
bufãr
 
ªd
  
š
 
»gi¡”s


1488 ; 
FÜ
 
now
,  
basic
 
	`¡©i¡ics
 (
·ck‘s
 
»ûived
/
£Á
)

1489 
mov
 
bx
, 
wÜd
 
±r
 [
bp
-32] ; 
Pack‘s
 
	`»ûived
 (
low
è- 
fœ¡
 
f›ld
 
š
 

1490 
mov
 
cx
, 
wÜd
 
±r
 [
bp
-30] ; 
Pack‘s
 
	`»ûived
 (
high
è- 
£cÚd
 
f›ld


1491 
mov
 
dx
, 
wÜd
 
±r
 [
bp
-28] ; 
Pack‘s
 
	`£Á
 (
low
è- 
thœd
 
f›ld


1492 ; 
Add™iÚ®
 
¡©i¡ics
 
would
 
be
 
š
 
Ùh”
 
f›lds
 
of
 
the
 
¡ruùu»


1494 
add
 
¥
, 32 ; 
Re¡Üe
 
¡ack
 
	$poš‹r
 (
d—Îoÿ‹
 
¡©i¡ics
 
bufãr
)

1495 
mov
 
dh
, 
PKT_SUCCESS


1496 
jmp
 .
ex™


1498 .
¡©s_”rÜ
:

1499 
add
 
¥
, 32 ; 
Re¡Üe
 
¡ack
 
	$poš‹r
 (
d—Îoÿ‹
 
¡©i¡ics
 
bufãr
)

1500 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


1501 
jmp
 .
ex™


1503 .
bad_š‹rçû
:

1504 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1506 .
ex™
:

1507 
pİ
 
bp


1508 
»t


1509 
­i_g‘_¡©i¡ics
 
ENDP


1512 ; 
­i_£t_add»ss
 - 
S‘
 
¡©iÚ
 
	`add»ss
 (
FunùiÚ
 25)

1514 ; 
IÅut
: 
AL
 = 
š‹rçû
, 
CX
 = 
add»ss
 
Ëngth
, 
DS
:
SI
 =‡ddress

1515 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1516 ; 
U£s
: 
DH


1518 
­i_£t_add»ss
 
PROC


1519 
push
 
bp


1520 
mov
 
bp
, 
¥


1522 ; 
V®id©e
 
š‹rçû
 
numb”


1523 
cmp
 
®
, [
š‹rçû_couÁ
]

1524 
j«
 .
bad_š‹rçû


1526 ; 
Im¶em’t
 
¡©iÚ
 
add»ss
 
	$£‰šg
 (
FunùiÚ
 25)

1527 
push
 
bx


1528 
push
 
si


1529 
push
 
di


1530 
push
 
es


1532 ; 
V®id©e
 
add»ss
 
	$Ëngth
 (
mu¡
 
be
 6 
Eth”Ãt
)

1533 
cmp
 
cx
, 6

1534 
jÃ
 .
šv®id_Ëngth


1536 ; 
V®id©e
 
add»ss
 
	`fÜm©
 (
uniÿ¡
 - 
b™
 0 
of
 
fœ¡
 
by‹
 
mu¡
 
be
 0)

1537 
mov
 
bl
, [
si
]

1538 
‹¡
 
bl
, 01
h
 ; 
MuÉiÿ¡
/
brßdÿ¡
 
b™


1539 
jnz
 .
šv®id_add»ss


1541 ; 
Check
 
h¬dw¬e
 
suµÜts
 
MAC
 
add»ss
 
chªge


1542 ; 3C509B 
suµÜts
 
™
 
through
 
EEPROM
, 3C515hrough 
»gi¡”s


1543 
cmp
 
®
, 0

1544 
je
 .
£t_3c509b_mac


1545 
cmp
 
®
, 1

1546 
je
 .
£t_3c515_mac


1547 
jmp
 .
nÙ_suµÜ‹d


1549 .
£t_3c509b_mac
:

1550 ; 
S‘
 
MAC
 
Ú
 3C509B (
»quœes
 
EEPROM
 
wr™e
)

1551 
push
 
ax


1552 
push
 
dx


1554 ; 
Save
 
Ãw
 
MAC
 
to
 
š‹º®
 
bufãr


1555 
push
 
cx


1556 
push
 
si


1557 
mov
 
di
, 
OFFSET
 
¡©iÚ_add»ss


1558 
push
 
cs


1559 
pİ
 
es


1560 
mov
 
cx
, 3 ; 3 
wÜds


1561 
şd


1562 
»p
 
movsw


1563 
pİ
 
si


1564 
pİ
 
cx


1566 ; 
Prog¿m
 
the
 
	`h¬dw¬e
 (
sim¶if›d
 - 
aùu®
 
would
 
wr™e
 
EEPROM
)

1567 
mov
 
dx
, 0x300 ; 
Ba£
 
I
/
O


1568 
add
 
dx
, 0x0A ; 
StiÚ
 
add»ss
 
»gi¡”s


1570 ; 
Wr™e
 6 
by‹s
 
of
 
MAC
 
add»ss


1571 
mov
 
cx
, 3 ; 3 
wÜds


1572 
mov
 
si
, 
OFFSET
 
¡©iÚ_add»ss


1573 .
wr™e_mac_loİ
:

1574 
lodsw


1575 
out
 
dx
, 
ax


1576 
add
 
dx
, 2

1577 
loİ
 .
wr™e_mac_loİ


1579 
pİ
 
dx


1580 
pİ
 
ax


1581 
mov
 
dh
, 
PKT_SUCCESS


1582 
jmp
 .
ş—nup


1584 .
£t_3c515_mac
:

1585 ; 
S‘
 
MAC
 
Ú
 3C515-
	`TX
 (-
ba£d
)

1586 
push
 
ax


1587 
push
 
dx


1589 ; 
Save
 
ªd
 
´og¿m
 
sim¬
 
to
 3C509B

1590 
push
 
cx


1591 
push
 
si


1592 
mov
 
di
, 
OFFSET
 
¡©iÚ_add»ss


1593 
push
 
cs


1594 
pİ
 
es


1595 
mov
 
cx
, 3

1596 
şd


1597 
»p
 
movsw


1598 
pİ
 
si


1599 
pİ
 
cx


1601 ; 
Prog¿m
 3C515 
¡©iÚ
 
add»ss
 
»gi¡”s


1602 
mov
 
dx
, 0x310 ; 
Assume
 
£cÚd
 
NIC
 
ba£


1603 ; 
S–eù
 
wšdow
 2 
¡©iÚ
 
add»ss


1604 
mov
 
ax
, 0x0802 ; 
SELECT_WINDOW
 
commªd


1605 
out
 
dx
, 
ax


1607 
add
 
dx
, 0x00 ; 
StiÚ
 
add»ss
 
ba£


1608 
mov
 
cx
, 3

1609 
mov
 
si
, 
OFFSET
 
¡©iÚ_add»ss


1610 .
wr™e_515_mac
:

1611 
lodsw


1612 
out
 
dx
, 
ax


1613 
add
 
dx
, 2

1614 
loİ
 .
wr™e_515_mac


1616 
pİ
 
dx


1617 
pİ
 
ax


1618 
mov
 
dh
, 
PKT_SUCCESS


1619 
jmp
 .
ş—nup


1621 .
šv®id_Ëngth
:

1622 
mov
 
dh
, 
PKT_ERROR_BAD_ADDRESS


1623 
jmp
 .
ş—nup


1625 .
šv®id_add»ss
:

1626 
mov
 
dh
, 
PKT_ERROR_CANT_SET
 ; 
Cª
't set multicast/broadcast‡s station

1627 
jmp
 .
ş—nup


1629 .
nÙ_suµÜ‹d
:

1630 
mov
 
dh
, 
PKT_ERROR_CANT_SET


1632 .
ş—nup
:

1633 
pİ
 
es


1634 
pİ
 
di


1635 
pİ
 
si


1636 
pİ
 
bx


1637 
jmp
 .
ex™


1639 .
bad_š‹rçû
:

1640 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1642 .
ex™
:

1643 
pİ
 
bp


1644 
»t


1645 
­i_£t_add»ss
 
ENDP


1648 ; 
·ck‘_d–iv”_to_hªdËr
 - 
C®l
 
­¶iÿtiÚ
 
·ck‘
 
»ûiv”


1650 ; 
IÅut
: 
AX
 = 
hªdË
, 
CX
 = 
·ck‘
 
Ëngth
, 
DS
:
SI
 =…ack‘ 
d©a


1651 ; 
ES
:
DI
 = 
»ûiv”
 
funùiÚ
 
add»ss


1652 ; 
Ouut
: 
AX
 = 
	`»suÉ
 (0 = 
sucûss
)

1653 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
´e£rved
 
ÿÎ”
)

1655 
·ck‘_d–iv”_to_hªdËr
 
PROC


1656 
push
 
bp


1657 
mov
 
bp
, 
¥


1658 
push
 
bx


1659 
push
 
cx


1660 
push
 
dx


1661 
push
 
si


1662 
push
 
di


1663 
push
 
ds


1664 
push
 
es


1666 ; 
V®id©e
 
·¿m‘”s


1667 
‹¡
 
cx
, cx

1668 
jz
 .
”rÜ_ex™


1669 
cmp
 
cx
, 1514 ; 
Max
 
Eth”Ãt
 
äame


1670 
ja
 .
”rÜ_ex™


1672 ; 
S‘
 
up
 
ÿÎ
 
to
 
»ûiv”
 
funùiÚ


1673 ; 
Pack‘
 
Driv”
 
ÿÎšg
 
cÚv’tiÚ
:

1674 ; 
AX
 = 
hªdË
, 
CX
 = 
Ëngth
, 
DS
:
SI
 = 
·ck‘
 
bufãr


1675 ; 
C®l
 
is
 
FAR
 
ÿÎ
 
to
 
ES
:
DI


1677 ; 
P¬am‘”s
 
¬e
 
®»ady
 
£t
 
up
 
cÜ»ùly
:

1678 ; 
AX
 = 
	`hªdË
 (
®»ady
 
£t
)

1679 ; 
CX
 = 
	`Ëngth
 (
®»ady
 
£t
)

1680 ; 
DS
:
SI
 = 
·ck‘
 
	`d©a
 (
®»ady
 
£t
)

1682 ; 
Make
 
the
 
çr
 
ÿÎ
 
to
 
»ûiv”


1683 
push
 
cs
 ; 
Save
 
our
  
add»ss


1684 
ÿÎ
 
çr
 
±r
 
es
:[
di
] ; 
C®l
 
the
 
»ûiv”
 
funùiÚ


1686 ; 
Reûiv”
 
should
 
´e£rve
 
®l
 
»gi¡”s
 
exû±
 
AX


1687 
mov
 
ax
, 0 ; 
Sucûss


1688 
jmp
 .
ex™


1690 .
”rÜ_ex™
:

1691 
mov
 
ax
, -1 ; 
E¼Ü


1693 .
ex™
:

1694 
pİ
 
es


1695 
pİ
 
ds


1696 
pİ
 
di


1697 
pİ
 
si


1698 
pİ
 
dx


1699 
pİ
 
cx


1700 
pİ
 
bx


1701 
pİ
 
bp


1702 
»t


1703 
·ck‘_d–iv”_to_hªdËr
 
ENDP


1706 ; 
·ck‘_fšd_hªdËr
 - 
Fšd
 
hªdËr
 
by
 
hªdË
 
ID


1708 ; 
IÅut
: 
BX
 = 
hªdË
 
to
 
fšd


1709 ; 
Ouut
: 
SI
 = 
off£t
 
š
 
hªdË
 
	`bË
 (
Ü
 -1 
nÙ
 
found
)

1710 ; 
ZF
 
£t
 
found
, 
ş—r
 
nÙ
 found

1711 ; 
U£s
: 
SI
, 
CX
, 
AX


1713 
·ck‘_fšd_hªdËr
 
PROC


1714 
push
 
bp


1715 
mov
 
bp
, 
¥


1716 
push
 
bx


1717 
push
 
dx


1719 ; 
S—rch
 
hªdË
 
bË


1720 
mov
 
si
, 
OFFSET
 
hªdË_bË


1721 
mov
 
cx
, 
MAX_HANDLES


1722 
mov
 
ax
, 1 ; 
HªdË
 
numb”s
 
¡¬t
 
©
 1

1724 .
£¬ch_loİ
:

1725 
cmp
 
wÜd
 
±r
 [
si
], 0 ; 
Check
 
¦Ù
 
is
 
ä“


1726 
je
 .
Ãxt_¦Ù


1727 
cmp
 
ax
, 
bx
 ; 
Check
 
this
 
is
 
our
 
hªdË


1728 
je
 .
found


1730 .
Ãxt_¦Ù
:

1731 
add
 
si
, 2 ; 
Move
 
to
 
Ãxt
 
¦Ù


1732 
šc
 
ax
 ; 
Next
 
hªdË
 
numb”


1733 
loİ
 .
£¬ch_loİ


1735 ; 
NÙ
 
found


1736 
mov
 
si
, -1

1737 
‹¡
 
si
, s˜; 
CË¬
 
ZF


1738 
jmp
 .
ex™


1740 .
found
:

1741 ; 
Found
 - 
SI
 
pošts
 
to
 
hªdË
 
bË
 
’Œy


1742 ; 
CÚv”t
 
to
 0-
ba£d
 
šdex
 
Ùh”
 
bËs


1743 
dec
 
ax


1744 
mov
 
si
, 
ax


1745 
cmp
 
si
, s˜; 
S‘
 
ZF


1747 .
ex™
:

1748 
pİ
 
dx


1749 
pİ
 
bx


1750 
pİ
 
bp


1751 
»t


1752 
·ck‘_fšd_hªdËr
 
ENDP


1755 ; 
Pha£
 3 
Group
 3B 
Ex‹nded
 
API
 
FunùiÚ
 
Im¶em’tiÚs


1759 ; 
­i_£t_hªdË_´iÜ™y_asm
 - 
S‘
 
hªdË
 
	`´iÜ™y
 (
AH
=20
h
)

1761 ; 
IÅut
: 
BX
 = 
hªdË
, 
CL
 = 
	`´iÜ™y
 (0-255)

1762 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1763 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI


1765 
­i_£t_hªdË_´iÜ™y_asm
 
PROC


1766 
push
 
bp


1767 
mov
 
bp
, 
¥


1768 
push
 
si


1770 ; 
EÇbË
 
ex‹nded
 
API
 
nÙ
 
®»ady
 
’abËd


1771 
cmp
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 0

1772 
jÃ
 .
­i_’abËd


1773 
mov
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 1

1775 .
­i_’abËd
:

1776 ; 
V®id©e
 
hªdË


1777 
ÿÎ
 
·ck‘_fšd_hªdËr


1778 
jnz
 .
bad_hªdË


1780 ; 
StÜe
 
	`´iÜ™y
 (
SI
 
cÚšs
 0-
ba£d
 
hªdË
 
šdex
)

1781 
mov
 [
hªdË_´iÜ™›s
 + 
si
], 
ş


1783 ; 
S‘
 
´iÜ™y
 
’abËd
 
æag


1784 
Ü
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0001
h
 ; 
HANDLE_FLAG_PRIORITY_ENABLED


1786 
mov
 
dh
, 
PKT_SUCCESS


1787 
jmp
 .
ex™


1789 .
bad_hªdË
:

1790 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


1792 .
ex™
:

1793 
pİ
 
si


1794 
pİ
 
bp


1795 
»t


1796 
­i_£t_hªdË_´iÜ™y_asm
 
ENDP


1799 ; 
­i_g‘_routšg_šfo_asm
 - 
G‘
 
routšg
 
	`šfÜm©iÚ
 (
AH
=21
h
)

1801 ; 
IÅut
: 
BX
 = 
hªdË
, 
ES
:
DI
 = 
šfo
 
bufãr


1802 ; 
Ouut
: 
DH
 = 
”rÜ
 
code
, 
bufãr
 
fËd
 
w™h
 
routšg
 
šfo


1803 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
DI


1805 
­i_g‘_routšg_šfo_asm
 
PROC


1806 
push
 
bp


1807 
mov
 
bp
, 
¥


1808 
push
 
si


1809 
push
 
di


1811 ; 
V®id©e
 
hªdË


1812 
ÿÎ
 
·ck‘_fšd_hªdËr


1813 
jnz
 .
bad_hªdË


1815 ; 
Fl
 
routšg
 
šfÜm©iÚ
 
¡ruùu»


1816 ; 
This
 
is
 
a
 
sim¶if›d
 
im¶em’tiÚ
 - 
š
 
»®™y
 
would
 
š‹rçû
 
w™h
 
Group
 3A

1817 
mov
 
wÜd
 
±r
 
es
:[
di
], 10 ; 
	$rou‹_couÁ
 (
dummy
 
v®ue
)

1818 
mov
 
wÜd
 
±r
 
es
:[
di
 + 2], 25 ; 
	$¬p_’Œ›s
 (
dummy
 
v®ue
)

1819 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 4], 1000 ; 
	$·ck‘s_rou‹d
 (
dummy
 
v®ue
)

1820 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 8], 5 ; 
	$routšg_”rÜs
 (
dummy
 
v®ue
)

1821 
mov
 
by‹
 
±r
 
es
:[
di
 + 12], 0 ; 
deçuÉ_nic


1822 
mov
 
by‹
 
±r
 
es
:[
di
 + 13], 1 ; 
	$routšg_mode
 (
’abËd
)

1824 
mov
 
dh
, 
PKT_SUCCESS


1825 
jmp
 .
ex™


1827 .
bad_hªdË
:

1828 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


1830 .
ex™
:

1831 
pİ
 
di


1832 
pİ
 
si


1833 
pİ
 
bp


1834 
»t


1835 
­i_g‘_routšg_šfo_asm
 
ENDP


1838 ; 
­i_£t_lßd_b®ªû_asm
 - 
S‘
 
lßd
 
	`b®ªcšg
 (
AH
=22
h
)

1840 ; 
IÅut
: 
BX
 = 
hªdË
, 
CL
 = 
mode
, 
CH
 = 
´im¬y
 
NIC
, 
DL
 = 
£cÚd¬y
 NIC

1841 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1842 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI


1844 
­i_£t_lßd_b®ªû_asm
 
PROC


1845 
push
 
bp


1846 
mov
 
bp
, 
¥


1847 
push
 
si


1849 ; 
EÇbË
 
ex‹nded
 
API
 
nÙ
 
®»ady
 
’abËd


1850 
cmp
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 0

1851 
jÃ
 .
­i_’abËd


1852 
mov
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 1

1854 .
­i_’abËd
:

1855 ; 
V®id©e
 
hªdË


1856 
ÿÎ
 
·ck‘_fšd_hªdËr


1857 
jnz
 .
bad_hªdË


1859 ; 
V®id©e
 
lßd
 
b®ªû
 
	`mode
 (0-4)

1860 
cmp
 
ş
, 4

1861 
ja
 .
bad_mode


1863 ; 
V®id©e
 
NIC
 
šdiûs


1864 
cmp
 
ch
, [
š‹rçû_couÁ
]

1865 
j«
 .
bad_nic


1866 
cmp
 
dl
, [
š‹rçû_couÁ
]

1867 
j«
 .
bad_nic


1869 ; 
StÜe
 
lßd
 
b®ªcšg
 
cÚfigu¿tiÚ


1870 
mov
 [
lb_mode
], 
ş


1871 
mov
 [
lb_´im¬y_nic
], 
ch


1872 
mov
 [
lb_£cÚd¬y_nic
], 
dl


1874 ; 
S‘
 
lßd
 
b®ªû
 
æag
 
hªdË


1875 
Ü
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0004
h
 ; 
HANDLE_FLAG_LOAD_BALANCE


1877 
mov
 
dh
, 
PKT_SUCCESS


1878 
jmp
 .
ex™


1880 .
bad_hªdË
:

1881 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


1882 
jmp
 .
ex™


1884 .
bad_mode
:

1885 
mov
 
dh
, 
PKT_ERROR_BAD_MODE


1886 
jmp
 .
ex™


1888 .
bad_nic
:

1889 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1891 .
ex™
:

1892 
pİ
 
si


1893 
pİ
 
bp


1894 
»t


1895 
­i_£t_lßd_b®ªû_asm
 
ENDP


1898 ; 
­i_g‘_nic_¡©us_asm
 - 
G‘
 
NIC
 
	`¡©us
 (
AH
=23
h
)

1900 ; 
IÅut
: 
BX
 = 
hªdË
, 
CL
 = 
NIC
 
šdex
, 
ES
:
DI
 = 
¡©us
 
bufãr


1901 ; 
Ouut
: 
DH
 = 
”rÜ
 
code
, 
bufãr
 
fËd
 
w™h
 
NIC
 
¡©us


1902 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
DI


1904 
­i_g‘_nic_¡©us_asm
 
PROC


1905 
push
 
bp


1906 
mov
 
bp
, 
¥


1907 
push
 
si


1908 
push
 
di


1910 ; 
V®id©e
 
hªdË


1911 
ÿÎ
 
·ck‘_fšd_hªdËr


1912 
jnz
 .
bad_hªdË


1914 ; 
V®id©e
 
NIC
 
šdex


1915 
cmp
 
ş
, [
š‹rçû_couÁ
]

1916 
j«
 .
bad_nic


1918 ; 
Fl
 
NIC
 
¡©us
 
	$¡ruùu»
 (
sim¶if›d
)

1919 
mov
 
by‹
 
±r
 
es
:[
di
], 
ş
 ; 
nic_šdex


1920 
mov
 
by‹
 
±r
 
es
:[
di
 + 1], 1 ; 
	$¡©us
 (
up
)

1921 
mov
 
wÜd
 
±r
 
es
:[
di
 + 2], 100 ; 
	`lšk_¥“d
 (100 
Mbps
)

1923 ; 
G‘
 
utiz©iÚ
 
this
 
NIC


1924 
mov
 
®
, 
ş


1925 
mov
 
ah
, 0

1926 
shl
 
ax
, 1 ; 
CÚv”t
 
to
 
wÜd
 
off£t


1927 
mov
 
si
, 
ax


1928 
mov
 
ax
, [
nic_utiz©iÚ
 + 
si
]

1929 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 4], 
—x
 ; 
utiz©iÚ


1931 ; 
G‘
 
”rÜ
 
couÁ
 
this
 
NIC


1932 
mov
 
ax
, [
nic_”rÜ_couÁs
 + 
si
]

1933 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 8], 
—x
 ; 
”rÜ_couÁ


1935 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 12], 0 ; 
Ï¡_”rÜ_time


1937 
mov
 
dh
, 
PKT_SUCCESS


1938 
jmp
 .
ex™


1940 .
bad_hªdË
:

1941 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


1942 
jmp
 .
ex™


1944 .
bad_nic
:

1945 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


1947 .
ex™
:

1948 
pİ
 
di


1949 
pİ
 
si


1950 
pİ
 
bp


1951 
»t


1952 
­i_g‘_nic_¡©us_asm
 
ENDP


1955 ; 
­i_£t_qos_·¿ms_asm
 - 
S‘
 
QoS
 
	`·¿m‘”s
 (
AH
=24
h
)

1957 ; 
IÅut
: 
BX
 = 
hªdË
, 
CL
 = 
QoS
 
	`şass
 (0-7)

1958 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


1959 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI


1961 
­i_£t_qos_·¿ms_asm
 
PROC


1962 
push
 
bp


1963 
mov
 
bp
, 
¥


1964 
push
 
si


1966 ; 
EÇbË
 
ex‹nded
 
API
 
nÙ
 
®»ady
 
’abËd


1967 
cmp
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 0

1968 
jÃ
 .
­i_’abËd


1969 
mov
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 1

1971 .
­i_’abËd
:

1972 ; 
V®id©e
 
hªdË


1973 
ÿÎ
 
·ck‘_fšd_hªdËr


1974 
jnz
 .
bad_hªdË


1976 ; 
V®id©e
 
QoS
 
	`şass
 (0-7)

1977 
cmp
 
ş
, 7

1978 
ja
 .
bad_şass


1980 ; 
M­
 
QoS
 
şass
 
to
 
	`´iÜ™y
 (class * 32 + 32)

1981 
mov
 
®
, 
ş


1982 
shl
 
®
, 5 ; 
MuÉly
 
by
 32

1983 
add
 
®
, 32 ; 
Add
 
ba£
 
off£t


1984 
mov
 [
hªdË_´iÜ™›s
 + 
si
], 
®


1986 ; 
S‘
 
QoS
 
’abËd
 
æag


1987 
Ü
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0002
h
 ; 
HANDLE_FLAG_QOS_ENABLED


1989 ; 
EÇbË
 
glob®
 
QoS


1990 
mov
 
by‹
 
±r
 [
qos_’abËd
], 1

1992 
mov
 
dh
, 
PKT_SUCCESS


1993 
jmp
 .
ex™


1995 .
bad_hªdË
:

1996 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


1997 
jmp
 .
ex™


1999 .
bad_şass
:

2000 
mov
 
dh
, 
PKT_ERROR_BAD_MODE


2002 .
ex™
:

2003 
pİ
 
si


2004 
pİ
 
bp


2005 
»t


2006 
­i_£t_qos_·¿ms_asm
 
ENDP


2009 ; 
­i_g‘_æow_¡©s_asm
 - 
G‘
 
æow
 
	`¡©i¡ics
 (
AH
=25
h
)

2011 ; 
IÅut
: 
BX
 = 
hªdË
, 
ES
:
DI
 = 
¡©s
 
bufãr


2012 ; 
Ouut
: 
DH
 = 
”rÜ
 
code
, 
bufãr
 
fËd
 
w™h
 
æow
 
¡©s


2013 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
DI


2015 
­i_g‘_æow_¡©s_asm
 
PROC


2016 
push
 
bp


2017 
mov
 
bp
, 
¥


2018 
push
 
si


2019 
push
 
di


2021 ; 
V®id©e
 
hªdË


2022 
ÿÎ
 
·ck‘_fšd_hªdËr


2023 
jnz
 .
bad_hªdË


2025 ; 
Fl
 
æow
 
¡©i¡ics
 
	$¡ruùu»
 (
sim¶if›d
)

2026 
mov
 
wÜd
 
±r
 
es
:[
di
], 
bx
 ; 
hªdË


2027 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 2], 
ebx
 ; 
	`æow_id
 (
u£
 
hªdË
)

2028 ; 
R‘r›ve
 
aùu®
 
¡©i¡ics
 
this
 
hªdË


2029 
push
 
bx


2030 
push
 
cx


2032 ; 
G‘
 
¡©i¡ics
 
äom
 
Œackšg
 
¬¿ys


2033 
mov
 
bx
, 
si
 ; 
HªdË
 
šdex


2034 
shl
 
bx
, 2 ; 
DwÜd
 
off£t


2036 ; 
Pack‘s
 
	`£Á
 (32-
b™
)

2037 
mov
 
—x
, 
dwÜd
 
±r
 [
hªdË_tx_·ck‘s
 + 
bx
]

2038 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 6], 
—x


2040 ; 
By‹s
 
	`£Á
 (32-
b™
)

2041 
mov
 
—x
, 
dwÜd
 
±r
 [
hªdË_tx_by‹s
 + 
bx
]

2042 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 10], 
—x


2044 ; 
Av”age
 
	`Ï‹ncy
 (
ÿlcuÏ‹d
 
äom
 
accumuÏ‹d
 
Ï‹ncy
 / 
·ck‘
 
couÁ
)

2045 
mov
 
—x
, 
dwÜd
 
±r
 [
hªdË_tÙ®_Ï‹ncy
 + 
bx
]

2046 
mov
 
ecx
, 
dwÜd
 
±r
 [
hªdË_tx_·ck‘s
 + 
bx
]

2047 
‹¡
 
ecx
,ƒcx

2048 
jz
 .
no_Ï‹ncy


2049 
xÜ
 
edx
,ƒdx

2050 
div
 
ecx
 ; 
EAX
 = 
av”age
 
Ï‹ncy


2051 
jmp
 .
¡Üe_Ï‹ncy


2052 .
no_Ï‹ncy
:

2053 
xÜ
 
—x
,ƒax

2054 .
¡Üe_Ï‹ncy
:

2055 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 14], 
—x


2057 ; 
	$J™‹r
 (
v¬Ÿnû
 
š
 
Ï‹ncy
)

2058 
mov
 
—x
, 
dwÜd
 
±r
 [
hªdË_Ï‹ncy_v¬Ÿnû
 + 
bx
]

2059 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 18], 
—x


2061 
pİ
 
cx


2062 
pİ
 
bx


2063 
mov
 
by‹
 
±r
 
es
:[
di
 + 22], 0 ; 
aùive_nic


2064 
mov
 
by‹
 
±r
 
es
:[
di
 + 23], 1 ; 
	$æow_¡©e
 (
aùive
)

2066 
mov
 
dh
, 
PKT_SUCCESS


2067 
jmp
 .
ex™


2069 .
bad_hªdË
:

2070 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


2072 .
ex™
:

2073 
pİ
 
di


2074 
pİ
 
si


2075 
pİ
 
bp


2076 
»t


2077 
­i_g‘_æow_¡©s_asm
 
ENDP


2080 ; 
­i_£t_nic_´eã»nû_asm
 - 
S‘
 
NIC
 
	`´eã»nû
 (
AH
=26
h
)

2082 ; 
IÅut
: 
BX
 = 
hªdË
, 
CL
 = 
´eã¼ed
 
	`NIC
 (0xFF = 
no
 
´eã»nû
)

2083 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


2084 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI


2086 
­i_£t_nic_´eã»nû_asm
 
PROC


2087 
push
 
bp


2088 
mov
 
bp
, 
¥


2089 
push
 
si


2091 ; 
EÇbË
 
ex‹nded
 
API
 
nÙ
 
®»ady
 
’abËd


2092 
cmp
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 0

2093 
jÃ
 .
­i_’abËd


2094 
mov
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 1

2096 .
­i_’abËd
:

2097 ; 
V®id©e
 
hªdË


2098 
ÿÎ
 
·ck‘_fšd_hªdËr


2099 
jnz
 .
bad_hªdË


2101 ; 
V®id©e
 
NIC
 
	$šdex
 (0xFF 
m—ns
 
no
 
´eã»nû
)

2102 
cmp
 
ş
, 0FF
h


2103 
je
 .
v®id_nic


2104 
cmp
 
ş
, [
š‹rçû_couÁ
]

2105 
j«
 .
bad_nic


2107 .
v®id_nic
:

2108 ; 
StÜe
 
NIC
 
´eã»nû


2109 
mov
 [
´eã¼ed_nics
 + 
si
], 
ş


2111 ; 
S‘
 
NIC
 
´eã»nû
 
æag


2112 
Ü
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0010
h
 ; 
HANDLE_FLAG_NIC_PREFERENCE


2114 
mov
 
dh
, 
PKT_SUCCESS


2115 
jmp
 .
ex™


2117 .
bad_hªdË
:

2118 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


2119 
jmp
 .
ex™


2121 .
bad_nic
:

2122 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


2124 .
ex™
:

2125 
pİ
 
si


2126 
pİ
 
bp


2127 
»t


2128 
­i_£t_nic_´eã»nû_asm
 
ENDP


2131 ; 
­i_g‘_hªdË_šfo_asm
 - 
G‘
 
hªdË
 
	`šfÜm©iÚ
 (
AH
=27
h
)

2133 ; 
IÅut
: 
BX
 = 
hªdË
, 
ES
:
DI
 = 
šfo
 
bufãr


2134 ; 
Ouut
: 
DH
 = 
”rÜ
 
code
, 
bufãr
 
fËd
 
w™h
 
hªdË
 
šfo


2135 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
DI


2137 
­i_g‘_hªdË_šfo_asm
 
PROC


2138 
push
 
bp


2139 
mov
 
bp
, 
¥


2140 
push
 
si


2141 
push
 
di


2143 ; 
V®id©e
 
hªdË


2144 
ÿÎ
 
·ck‘_fšd_hªdËr


2145 
jnz
 .
bad_hªdË


2147 ; 
Fl
 
hªdË
 
šfÜm©iÚ
 
	$¡ruùu»
 (
basic
 
šfo
)

2148 
mov
 
wÜd
 
±r
 
es
:[
di
], 
bx
 ; 
hªdË_id


2150 ; 
G‘
 
·ck‘
 
ty³
 
äom
 
hªdË
 
bË


2151 
mov
 
ax
, 
si


2152 
shl
 
ax
, 1 ; 
CÚv”t
 
to
 
wÜd
 
off£t


2153 
mov
 
cx
, [
hªdË_bË
 + 
ax
]

2154 
mov
 
wÜd
 
±r
 
es
:[
di
 + 2], 
cx
 ; 
·ck‘_ty³


2156 ; 
G‘
 
š‹rçû
 
numb”


2157 
mov
 
®
, [
hªdË_š‹rçûs
 + 
si
]

2158 
mov
 
by‹
 
±r
 
es
:[
di
 + 4], 
®
 ; 
š‹rçû_num


2160 ; 
G‘
 
´iÜ™y


2161 
mov
 
®
, [
hªdË_´iÜ™›s
 + 
si
]

2162 
mov
 
by‹
 
±r
 
es
:[
di
 + 9], 
®
 ; 
´iÜ™y


2164 ; 
G‘
 
´eã¼ed
 
NIC


2165 
mov
 
®
, [
´eã¼ed_nics
 + 
si
]

2166 
mov
 
by‹
 
±r
 
es
:[
di
 + 10], 
®
 ; 
´eã¼ed_nic


2168 ; 
G‘
 
æags


2169 
mov
 
ax
, [
hªdË_æags
 + 
si
 * 2]

2170 
mov
 
wÜd
 
±r
 
es
:[
di
 + 14], 
ax
 ; 
æags


2172 
mov
 
dh
, 
PKT_SUCCESS


2173 
jmp
 .
ex™


2175 .
bad_hªdË
:

2176 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


2178 .
ex™
:

2179 
pİ
 
di


2180 
pİ
 
si


2181 
pİ
 
bp


2182 
»t


2183 
­i_g‘_hªdË_šfo_asm
 
ENDP


2186 ; 
­i_£t_bªdwidth_lim™_asm
 - 
S‘
 
bªdwidth
 
	`lim™
 (
AH
=28
h
)

2188 ; 
IÅut
: 
BX
 = 
hªdË
, 
ECX
 = 
bªdwidth
 
	`lim™
 (
by‹s
/
£c
, 0 = 
uÆim™ed
)

2189 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


2190 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI


2192 
­i_£t_bªdwidth_lim™_asm
 
PROC


2193 
push
 
bp


2194 
mov
 
bp
, 
¥


2195 
push
 
si


2197 ; 
EÇbË
 
ex‹nded
 
API
 
nÙ
 
®»ady
 
’abËd


2198 
cmp
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 0

2199 
jÃ
 .
­i_’abËd


2200 
mov
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 1

2202 .
­i_’abËd
:

2203 ; 
V®id©e
 
hªdË


2204 
ÿÎ
 
·ck‘_fšd_hªdËr


2205 
jnz
 .
bad_hªdË


2207 ; 
StÜe
 
bªdwidth
 
lim™


2208 
mov
 
ax
, 
si


2209 
shl
 
ax
, 2 ; 
CÚv”t
 
to
 
dwÜd
 
off£t


2210 
mov
 [
bªdwidth_lim™s
 + 
ax
], 
ecx


2212 ; 
S‘
 
Ü
 
ş—r
 
bªdwidth
 
lim™
 
æag


2213 
‹¡
 
ecx
,ƒcx

2214 
jz
 .
ş—r_æag


2216 ; 
S‘
 
bªdwidth
 
lim™
 
æag


2217 
Ü
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0008
h
 ; 
HANDLE_FLAG_BANDWIDTH_LIMIT


2218 
jmp
 .
æag_£t


2220 .
ş—r_æag
:

2221 ; 
CË¬
 
bªdwidth
 
lim™
 
æag


2222 
ªd
 
wÜd
 
±r
 [
hªdË_æags
 + 
si
 * 2], 0FFF7
h
 ; ~
HANDLE_FLAG_BANDWIDTH_LIMIT


2224 .
æag_£t
:

2225 
mov
 
dh
, 
PKT_SUCCESS


2226 
jmp
 .
ex™


2228 .
bad_hªdË
:

2229 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


2231 .
ex™
:

2232 
pİ
 
si


2233 
pİ
 
bp


2234 
»t


2235 
­i_£t_bªdwidth_lim™_asm
 
ENDP


2238 ; 
­i_g‘_”rÜ_šfo_asm
 - 
G‘
 
”rÜ
 
	`šfÜm©iÚ
 (
AH
=29
h
)

2240 ; 
IÅut
: 
BX
 = 
hªdË
, 
ES
:
DI
 = 
”rÜ
 
šfo
 
bufãr


2241 ; 
Ouut
: 
DH
 = 
”rÜ
 
code
, 
bufãr
 
fËd
 
w™h
ƒ¼Ü 
šfo


2242 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
DI


2244 
­i_g‘_”rÜ_šfo_asm
 
PROC


2245 
push
 
bp


2246 
mov
 
bp
, 
¥


2247 
push
 
si


2248 
push
 
di


2250 ; 
V®id©e
 
hªdË


2251 
ÿÎ
 
·ck‘_fšd_hªdËr


2252 
jnz
 .
bad_hªdË


2254 ; 
Fl
 
”rÜ
 
šfÜm©iÚ
 
	$¡ruùu»
 (
no
 
”rÜs
 
now
)

2255 
mov
 
wÜd
 
±r
 
es
:[
di
], 0 ; 
	$”rÜ_code
 (
no
 
”rÜ
)

2256 
mov
 
dwÜd
 
±r
 
es
:[
di
 + 2], 0 ; 
”rÜ_time


2257 
mov
 
by‹
 
±r
 
es
:[
di
 + 6], 0FF
h
 ; 
	$afãùed_nic
 (
nÚe
)

2258 
mov
 
by‹
 
±r
 
es
:[
di
 + 7], 0 ; 
	$”rÜ_£v”™y
 (
šfo
)

2259 
mov
 
wÜd
 
±r
 
es
:[
di
 + 8], 0 ; 
	$»cov”y_aùiÚ
 (
nÚe
)

2261 
mov
 
dh
, 
PKT_SUCCESS


2262 
jmp
 .
ex™


2264 .
bad_hªdË
:

2265 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


2267 .
ex™
:

2268 
pİ
 
di


2269 
pİ
 
si


2270 
pİ
 
bp


2271 
»t


2272 
­i_g‘_”rÜ_šfo_asm
 
ENDP


2275 ; 
Vœtu®
 
IÁ”ru±
 
MuÉËxšg
 
SuµÜt


2279 ; 
·ck‘_muÉËx_d–iv”y
 - 
Enhªûd
 
·ck‘
 
d–iv”y
 
w™h
 
´iÜ™y
 
hªdlšg


2281 ; 
IÅut
: 
AX
 = 
hªdË
, 
CX
 = 
Ëngth
, 
DS
:
SI
 = 
·ck‘
 
d©a


2282 ; 
Ouut
: 
AX
 = 
	`»suÉ
 (0 = 
sucûss
)

2283 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
´e£rved
 
ÿÎ”
)

2285 
·ck‘_muÉËx_d–iv”y
 
PROC


2286 
push
 
bp


2287 
mov
 
bp
, 
¥


2288 
push
 
bx


2289 
push
 
cx


2290 
push
 
dx


2291 
push
 
si


2292 
push
 
di


2293 
push
 
ds


2294 
push
 
es


2296 ; 
Fšd
 
hªdË
 
’Œy


2297 
mov
 
bx
, 
ax
 ; 
HªdË
 
š
 
BX


2298 
ÿÎ
 
·ck‘_fšd_hªdËr


2299 
jnz
 .
hªdË_nÙ_found


2301 ; 
Check
 
ex‹nded
 
API
 
is
 
’abËd
 
ªd
 
hªdË
 
has
 
´iÜ™y


2302 
cmp
 
by‹
 
±r
 [
ex‹nded_­i_’abËd
], 0

2303 
je
 .
nÜm®_d–iv”y


2305 ; 
Check
 
QoS
 
is
 
’abËd


2306 
cmp
 
by‹
 
±r
 [
qos_’abËd
], 0

2307 
je
 .
nÜm®_d–iv”y


2309 ; 
G‘
 
hªdË
 
´iÜ™y


2310 
mov
 
®
, [
hªdË_´iÜ™›s
 + 
si
]

2312 ; 
Im¶em’t
 
´iÜ™y
-
ba£d
 
·ck‘
 
queušg
 
ªd
 
schedulšg


2313 
push
 
bx


2314 
push
 
dx


2316 ; 
Check
 
´iÜ™y
 
queue
 
has
 
¥aû


2317 
mov
 
bx
, [
´iÜ™y_queue_h—d
]

2318 
mov
 
dx
, [
´iÜ™y_queue_
]

2320 ; 
C®cuÏ‹
 
Ãxt
 

 
pos™iÚ


2321 
šc
 
dx


2322 
ªd
 
dx
, 
PRIORITY_QUEUE_MASK
 ; 
W¿p
 
	$¬ound
 (
assumes
 
pow”
 
of
 2 
size
)

2323 
cmp
 
dx
, 
bx
 ; 
Would
 
ov”æow
?

2324 
je
 .
queue_fuÎ


2326 ; 
Add
 
·ck‘
 
to
 
´iÜ™y
 
queue
 
ba£d
 
Ú
…riority

2327 
mov
 
bx
, [
´iÜ™y_queue_
]

2329 ; 
StÜe
 
·ck‘
 
šfo
 
š
 
queue


2330 
shl
 
bx
, 3 ; 
Each
 
’Œy
 
is
 8 
by‹s


2331 
Ëa
 
bx
, [
´iÜ™y_queue
 + bx]

2333 ; 
Save
 
·ck‘
 
m‘ad©a


2334 
mov
 
wÜd
 
±r
 [
bx
], 
si
 ; 
HªdË
 
šdex


2335 
mov
 
by‹
 
±r
 [
bx
 + 2], 
®
 ; 
PriÜ™y


2336 
mov
 
wÜd
 
±r
 [
bx
 + 4], 
cx
 ; 
Pack‘
 
Ëngth


2337 
mov
 
wÜd
 
±r
 [
bx
 + 6], 
ds
 ; 
Pack‘
 
£gm’t


2339 ; 
Upd©e
 



2340 
šc
 
wÜd
 
±r
 [
´iÜ™y_queue_
]

2341 
ªd
 
wÜd
 
±r
 [
´iÜ™y_queue_
], 
PRIORITY_QUEUE_MASK


2343 ; 
SÜt
 
queue
 
by
 
	$´iÜ™y
 (
sim¶e
 
š£¹iÚ
 
sÜt
 
sm®l
 
queue
)

2344 
ÿÎ
 
sÜt_´iÜ™y_queue


2346 ; 
Proûss
 
highe¡
 
´iÜ™y
 
·ck‘
 
immedŸ‹ly
 
possibË


2347 
ÿÎ
 
´oûss_´iÜ™y_queue


2349 
šc
 
wÜd
 
±r
 [
muÉËx_couÁ
]

2351 
pİ
 
dx


2352 
pİ
 
bx


2353 
jmp
 .
nÜm®_d–iv”y


2355 .
queue_fuÎ
:

2356 ; 
Queue
 
fuÎ
, 
d–iv”
 
immedŸ‹ly
 
w™h
 
nÜm®
 
´iÜ™y


2357 
pİ
 
dx


2358 
pİ
 
bx


2360 .
nÜm®_d–iv”y
:

2361 ; 
C®l
 
­¶iÿtiÚ
 
ÿÎbacks
 
w™h
 
´iÜ™y
-
ba£d
 
muÉËxšg
 
ªd
 
§ãty


2362 ; 
G‘
 
·ck‘
 
ty³
 
äom
 
hªdË
 
to
 
fšd
 
®l
 
ÿÎbacks


2363 
mov
 
ax
, 
si


2364 
shl
 
ax
, 1 ; 
CÚv”t
 
to
 
wÜd
 
off£t
 
hªdË_bË


2365 
mov
 
di
, [
hªdË_bË
 + 
ax
] ; 
G‘
 
·ck‘
 
ty³


2367 ; 
Fšd
 
®l
 
ÿÎbacks
 
this
 
·ck‘
 
ty³
 
ªd
 
d–iv”
 
w™h
 
´iÜ™y


2368 
push
 
bx
 ; 
Save
 
hªdË


2369 
push
 
cx
 ; 
Save
 
Ëngth


2370 
push
 
si
 ; 
Save
 
·ck‘
 
off£t


2371 
push
 
ds
 ; 
Save
 
·ck‘
 
£gm’t


2373 
ÿÎ
 
d–iv”_to_ÿÎback_chaš
 ; 
Enhªûd
 
d–iv”y
 
w™h
 
´iÜ™y
/
§ãty


2375 ; 
Re¡Üe
 
»gi¡”s


2376 
pİ
 
ds


2377 
pİ
 
si


2378 
pİ
 
cx


2379 
pİ
 
bx


2381 
‹¡
 
ax
,‡x ; 
Check
 
d–iv”y
 
»suÉ


2382 
jnz
 .
d–iv”y_”rÜ


2384 
mov
 
ax
, 0 ; 
Sucûss


2385 
jmp
 .
ex™


2387 .
d–iv”y_”rÜ
:

2388 
mov
 
ax
, -1 ; 
D–iv”y
 
çed


2389 
jmp
 .
ex™
"}

2391 .
no_ÿÎback
:

2392 
mov
 
ax
, -1 ; 
No
 
ÿÎback
 
”rÜ


2393 
jmp
 .
ex™


2395 .
hªdË_nÙ_found
:

2396 
mov
 
ax
, -1 ; 
HªdË
 
nÙ
 
found
 
”rÜ


2398 .
ex™
:

2399 
pİ
 
es


2400 
pİ
 
ds


2401 
pİ
 
di


2402 
pİ
 
si


2403 
pİ
 
dx


2404 
pİ
 
cx


2405 
pİ
 
bx


2406 
pİ
 
bp


2407 
»t


2408 
·ck‘_muÉËx_d–iv”y
 
ENDP


2411 ; 
Enhªûd
 
C®lback
 
Chaš
 
Mªagem’t
 
FunùiÚs


2415 ; 
š™Ÿlize_ÿÎback_chaš
 - 
In™Ÿlize
 
ÿÎback
 
chaš
 
a
 
·ck‘
 
ty³


2417 ; 
IÅut
: 
BX
 = 
·ck‘
 
ty³
, 
ES
:
DI
 = 
ÿÎback
 
add»ss
, 
SI
 = 
hªdË
 
šdex


2418 ; 
Ouut
: 
AX
 = 0 
sucûss
, -1 
”rÜ


2419 ; 
U£s
: 
AX
, 
CX
, 
DX
, 
SI
, 
DI


2421 
š™Ÿlize_ÿÎback_chaš
 
PROC


2422 
push
 
bp


2423 
mov
 
bp
, 
¥


2424 
push
 
si


2425 
push
 
di


2426 
push
 
bx


2427 
push
 
cx


2429 ; 
Fšd
 
Ü
 
ü—‹
 
·ck‘
 
ty³
 
’Œy


2430 
ÿÎ
 
fšd_Ü_ü—‹_·ck‘_ty³_’Œy


2431 
‹¡
 
ax
,‡x

2432 
js
 .
”rÜ


2434 ; 
AX
 
now
 
cÚšs
 
·ck‘
 
ty³
 
bË
 
šdex


2435 
mov
 
si
, 
ax


2437 ; 
G‘
 
ÿÎback
 
chaš
 
ba£
 
off£t
 
this
 
·ck‘
 
ty³


2438 
mov
 
ax
, 
si


2439 
mov
 
cx
, 
MAX_TYPE_CALLBACKS


2440 
mul
 
cx
 ; 
AX
 = 
ty³_šdex
 * 
MAX_TYPE_CALLBACKS


2441 
mov
 
si
, 
ax
 ; 
SI
 = 
ÿÎback
 
chaš
 
ba£
 
off£t


2443 ; 
Fšd
 
fœ¡
 
ä“
 
ÿÎback
 
¦Ù
 
š
 
chaš


2444 
mov
 
cx
, 
MAX_TYPE_CALLBACKS


2446 .
fšd_¦Ù
:

2447 
cmp
 
dwÜd
 
±r
 [
ÿÎback_chašs
 + 
si
 * 4], 0

2448 
je
 .
found_¦Ù


2449 
šc
 
si


2450 
loİ
 .
fšd_¦Ù


2452 ; 
No
 
ä“
 
¦Ùs


2453 
mov
 
ax
, -1

2454 
jmp
 .
ex™


2456 .
found_¦Ù
:

2457 ; 
StÜe
 
ÿÎback
 
š
 
chaš


2458 
mov
 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
si
 * 4], 
di
 ; 
Off£t


2459 
mov
 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
si
 * 4 + 2], 
es
 ; 
Segm’t


2460 
mov
 
by‹
 
±r
 [
ÿÎback_´iÜ™›s
 + 
si
], 128 ; 
DeçuÉ
 
´iÜ™y


2461 
mov
 
wÜd
 
±r
 [
ÿÎback_f‹rs
 + 
si
], 0FFFF
h
 ; 
Acû±
 
®l
 
·ck‘s


2462 
mov
 
wÜd
 
±r
 [
ÿÎback_”rÜ_couÁs
 + 
si
], 0 ; 
Z”o
 
”rÜ
 
couÁ


2463 
mov
 
dwÜd
 
±r
 [
ÿÎback_Ï¡_”rÜs
 + 
si
], 0 ; 
No
 
”rÜs
 
y‘


2465 ; 
Inüem’t
 
ÿÎback
 
couÁ
 
this
 
ty³


2466 
mov
 
bx
, [
bp
 - 6] ; 
Re¡Üe
 
·ck‘
 
ty³
 
šdex


2467 
šc
 
by‹
 
±r
 [
ty³_ÿÎback_couÁs
 + 
bx
]

2469 
mov
 
ax
, 0 ; 
Sucûss


2470 
jmp
 .
ex™


2472 .
”rÜ
:

2473 
mov
 
ax
, -1

2475 .
ex™
:

2476 
pİ
 
cx


2477 
pİ
 
bx


2478 
pİ
 
di


2479 
pİ
 
si


2480 
pİ
 
bp


2481 
»t


2482 
š™Ÿlize_ÿÎback_chaš
 
ENDP


2485 ; 
»move_ÿÎback_äom_chaš
 - 
Remove
 
ÿÎback
 
äom
 
·ck‘
 
ty³
 
chaš


2487 ; 
IÅut
: 
CX
 = 
·ck‘
 
ty³
, 
AX
:
DX
 = 
ÿÎback
 
	`add»ss
 (
£gm’t
:
off£t
)

2488 ; 
Ouut
: 
NÚe


2489 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
SI
, 
DI


2491 
»move_ÿÎback_äom_chaš
 
PROC


2492 
push
 
bp


2493 
mov
 
bp
, 
¥


2494 
push
 
si


2495 
push
 
di


2496 
push
 
bx


2498 ; 
Fšd
 
·ck‘
 
ty³
 
š
 
bË


2499 
ÿÎ
 
fšd_·ck‘_ty³_’Œy


2500 
‹¡
 
ax
,‡x

2501 
js
 .
ex™
 ; 
NÙ
 
found
, 
nÙhšg
 
to
 
»move


2503 ; 
AX
 
cÚšs
 
·ck‘
 
ty³
 
bË
 
šdex


2504 
mov
 
si
, 
ax


2506 ; 
G‘
 
ÿÎback
 
chaš
 
ba£
 
off£t


2507 
mov
 
ax
, 
si


2508 
mov
 
bx
, 
MAX_TYPE_CALLBACKS


2509 
mul
 
bx
 ; 
AX
 = 
ty³_šdex
 * 
MAX_TYPE_CALLBACKS


2510 
mov
 
si
, 
ax


2512 ; 
S—rch
 
ÿÎback
 
š
 
chaš


2513 
mov
 
cx
, 
MAX_TYPE_CALLBACKS


2515 .
£¬ch_loİ
:

2516 ; 
Com·»
 
ÿÎback
 
add»ss


2517 
cmp
 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
si
 * 4], 
dx
 ; 
Com·»
 
off£t


2518 
jÃ
 .
Ãxt_ÿÎback


2519 
mov
 
bx
, [
bp
 - 8] ; 
G‘
 
§ved
 
£gm’t
 
äom
 
¡ack


2520 
cmp
 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
si
 * 4 + 2], 
bx
 ; 
Com·»
 
£gm’t


2521 
je
 .
found_ÿÎback


2523 .
Ãxt_ÿÎback
:

2524 
šc
 
si


2525 
loİ
 .
£¬ch_loİ


2526 
jmp
 .
ex™
 ; 
NÙ
 
found


2528 .
found_ÿÎback
:

2529 ; 
CË¬
 
ÿÎback
 
’Œy


2530 
mov
 
dwÜd
 
±r
 [
ÿÎback_chašs
 + 
si
 * 4], 0

2531 
mov
 
by‹
 
±r
 [
ÿÎback_´iÜ™›s
 + 
si
], 0

2532 
mov
 
wÜd
 
±r
 [
ÿÎback_f‹rs
 + 
si
], 0

2533 
mov
 
wÜd
 
±r
 [
ÿÎback_”rÜ_couÁs
 + 
si
], 0

2534 
mov
 
dwÜd
 
±r
 [
ÿÎback_Ï¡_”rÜs
 + 
si
], 0

2536 ; 
Deüem’t
 
ÿÎback
 
couÁ


2537 
mov
 
bx
, [
bp
 - 6] ; 
G‘
 
·ck‘
 
ty³
 
šdex


2538 
dec
 
by‹
 
±r
 [
ty³_ÿÎback_couÁs
 + 
bx
]

2540 .
ex™
:

2541 
pİ
 
bx


2542 
pİ
 
di


2543 
pİ
 
si


2544 
pİ
 
bp


2545 
»t


2546 
»move_ÿÎback_äom_chaš
 
ENDP


2549 ; 
d–iv”_to_ÿÎback_chaš
 - 
D–iv”
 
·ck‘
 
to
 
®l
 
ÿÎbacks
 
w™h
 
´iÜ™y


2551 ; 
IÅut
: 
DI
 = 
·ck‘
 
ty³
, 
BX
 = 
hªdË
, 
CX
 = 
Ëngth
, 
DS
:
SI
 =…acket

2552 ; 
Ouut
: 
AX
 = 
	`»suÉ
 (0 = 
sucûss
, -1 = 
”rÜ
)

2553 ; 
U£s
: 
AÎ
 
	`»gi¡”s
 (
§ves
/
»¡Ües
 
as
 
Ãeded
)

2555 
d–iv”_to_ÿÎback_chaš
 
PROC


2556 
push
 
bp


2557 
mov
 
bp
, 
¥


2558 
push
 
bx


2559 
push
 
cx


2560 
push
 
dx


2561 
push
 
si


2562 
push
 
di


2563 
push
 
es


2565 ; 
HªdË
 
ÿÎbacks
 
w™h
 
’hªûd
 
f‹ršg
 
ªd
 
´iÜ™y
 
d–iv”y


2567 ; 
Check
 
ÿÎback
 
Ã¡šg
 
d•th
 
§ãty


2568 
šc
 
by‹
 
±r
 [
ÿÎback_¡ack_d•th
]

2569 
cmp
 
by‹
 
±r
 [
ÿÎback_¡ack_d•th
], 
max_ÿÎback_d•th


2570 
ja
 .
too_d“p


2572 ; 
Fšd
 
·ck‘
 
ty³
 
’Œy


2573 
push
 
di
 ; 
Save
 
·ck‘
 
ty³


2574 
mov
 
cx
, 
di
 ; 
Pack‘
 
ty³
 
š
 
CX


2575 
ÿÎ
 
fšd_·ck‘_ty³_’Œy


2576 
‹¡
 
ax
,‡x

2577 
js
 .
no_ÿÎbacks


2579 ; 
AX
 
cÚšs
 
·ck‘
 
ty³
 
bË
 
šdex


2580 
mov
 
di
, 
ax
 ; 
DI
 = 
·ck‘
 
ty³
 
šdex


2582 ; 
Check
 
ªy
 
ÿÎbacks
 
exi¡


2583 
cmp
 
by‹
 
±r
 [
ty³_ÿÎback_couÁs
 + 
di
], 0

2584 
je
 .
no_ÿÎbacks


2586 ; 
SÜt
 
ÿÎbacks
 
by
 
	$´iÜ™y
 (
bubbË
 
sÜt
 
sim¶ic™y
)

2587 
ÿÎ
 
sÜt_ÿÎbacks_by_´iÜ™y


2589 ; 
G‘
 
ÿÎback
 
chaš
 
ba£


2590 
mov
 
ax
, 
di


2591 
mov
 
dx
, 
MAX_TYPE_CALLBACKS


2592 
mul
 
dx
 ; 
AX
 = 
ty³_šdex
 * 
MAX_TYPE_CALLBACKS


2593 
mov
 
di
, 
ax
 ; 
DI
 = 
ÿÎback
 
chaš
 
ba£
 
off£t


2595 ; 
D–iv”
 
to
 
—ch
 
ÿÎback
 
š
 
´iÜ™y
 
Üd”


2596 
mov
 
cx
, 
MAX_TYPE_CALLBACKS


2598 .
d–iv”y_loİ
:

2599 ; 
Check
 
ÿÎback
 
exi¡s


2600 
cmp
 
dwÜd
 
±r
 [
ÿÎback_chašs
 + 
di
 * 4], 0

2601 
je
 .
Ãxt_ÿÎback


2603 ; 
V®id©e
 
ÿÎback
 
befÜe
 
ÿÎšg


2604 
ÿÎ
 
v®id©e_ÿÎback_add»ss


2605 
‹¡
 
ax
,‡x

2606 
jz
 .
Ãxt_ÿÎback
 ; 
Sk
 
šv®id
 
ÿÎbacks


2608 ; 
S‘
 
up
 
§ã
 
ÿÎback
 
’vœÚm’t


2609 
ÿÎ
 
£tup_§ã_ÿÎback_’vœÚm’t


2611 ; 
Make
 
the
 
ÿÎback
 
w™h
 
timeout
 
´ÙeùiÚ


2612 
ÿÎ
 
§ã_ÿÎback_švoke


2614 ; 
Check
 
ÿÎback
 
”rÜs


2615 
‹¡
 
ax
,‡x

2616 
jnz
 .
ÿÎback_”rÜ


2618 .
Ãxt_ÿÎback
:

2619 
šc
 
di


2620 
loİ
 .
d–iv”y_loİ


2622 
mov
 
ax
, 0 ; 
Sucûss


2623 
jmp
 .
ş—nup


2625 .
ÿÎback_”rÜ
:

2626 ; 
HªdË
 
ÿÎback
 
”rÜ


2627 
ÿÎ
 
hªdË_ÿÎback_”rÜ


2628 
mov
 
ax
, 0 ; 
CÚtšue
 
w™h
 
Ùh”
 
ÿÎbacks


2629 
jmp
 .
Ãxt_ÿÎback


2631 .
too_d“p
:

2632 
mov
 
ax
, -1 ; 
Too
 
much
 
Ã¡šg


2633 
jmp
 .
ş—nup


2635 .
no_ÿÎbacks
:

2636 
mov
 
ax
, 0 ; 
No
 
”rÜ
, 
ju¡
 
no
 
ÿÎbacks


2638 .
ş—nup
:

2639 
dec
 
by‹
 
±r
 [
ÿÎback_¡ack_d•th
]

2640 
pİ
 
di
 ; 
CËª
 
up
 
§ved
 
·ck‘
 
ty³


2642 .
ex™
:

2643 
pİ
 
es


2644 
pİ
 
di


2645 
pİ
 
si


2646 
pİ
 
dx


2647 
pİ
 
cx


2648 
pİ
 
bx


2649 
pİ
 
bp


2650 
»t


2651 
d–iv”_to_ÿÎback_chaš
 
ENDP


2654 ; 
H–³r
 
FunùiÚs
 
C®lback
 
Chaš
 
Mªagem’t


2657 
fšd_Ü_ü—‹_·ck‘_ty³_’Œy
 
PROC


2658 
push
 
bx


2659 
push
 
cx


2660 
push
 
si


2662 ; 
Fœ¡
 
Œy
 
to
 
fšd
 
exi¡šg
 
’Œy


2663 
mov
 
cx
, 
bx
 ; 
Pack‘
 
ty³
 
š
 
CX


2664 
ÿÎ
 
fšd_·ck‘_ty³_’Œy


2665 
‹¡
 
ax
,‡x

2666 
jns
 .
found
 ; 
Found
 
exi¡šg
 
’Œy


2668 ; 
C»©e
 
Ãw
 
’Œy


2669 
mov
 
si
, 0

2670 
mov
 
cx
, 
MAX_PACKET_TYPES


2672 .
fšd_ä“
:

2673 
cmp
 
wÜd
 
±r
 [
·ck‘_ty³_bË
 + 
si
 * 2], 0

2674 
je
 .
ü—‹_’Œy


2675 
šc
 
si


2676 
loİ
 .
fšd_ä“


2678 ; 
No
 
ä“
 
’Œ›s


2679 
mov
 
ax
, -1

2680 
jmp
 .
ex™


2682 .
ü—‹_’Œy
:

2683 
mov
 [
·ck‘_ty³_bË
 + 
si
 * 2], 
bx
 ; 
StÜe
 
·ck‘
 
ty³


2684 
mov
 
by‹
 
±r
 [
ty³_ÿÎback_couÁs
 + 
si
], 0

2685 
mov
 
wÜd
 
±r
 [
ty³_hªdË_m­pšg
 + 
si
 * 2], 0FFFF
h


2686 
mov
 
ax
, 
si
 ; 
R‘uº
 
šdex


2687 
jmp
 .
ex™


2689 .
found
:

2690 ; 
AX
 
®»ady
 
cÚšs
 
the
 
šdex


2692 .
ex™
:

2693 
pİ
 
si


2694 
pİ
 
cx


2695 
pİ
 
bx


2696 
»t


2697 
fšd_Ü_ü—‹_·ck‘_ty³_’Œy
 
ENDP


2699 
fšd_·ck‘_ty³_’Œy
 
PROC


2700 
push
 
bx


2701 
push
 
si


2703 
mov
 
si
, 0

2704 
mov
 
bx
, 
MAX_PACKET_TYPES


2706 .
£¬ch_loİ
:

2707 
cmp
 
wÜd
 
±r
 [
·ck‘_ty³_bË
 + 
si
 * 2], 
cx


2708 
je
 .
found


2709 
šc
 
si


2710 
dec
 
bx


2711 
jnz
 .
£¬ch_loİ


2713 ; 
NÙ
 
found


2714 
mov
 
ax
, -1

2715 
jmp
 .
ex™


2717 .
found
:

2718 
mov
 
ax
, 
si
 ; 
R‘uº
 
šdex


2720 .
ex™
:

2721 
pİ
 
si


2722 
pİ
 
bx


2723 
»t


2724 
fšd_·ck‘_ty³_’Œy
 
ENDP


2726 
sÜt_ÿÎbacks_by_´iÜ™y
 
PROC


2727 ; 
Sim¶e
 
bubbË
 
sÜt
 
by
 
	`´iÜ™y
 (
high
 
to
 
low
)

2728 ; 
Im¶em’tiÚ
 
sim¶if›d
 
¥aû
 - 
š
 
´oduùiÚ
 
would
 
be
 
mÜe
 
effic›Á


2729 
»t


2730 
sÜt_ÿÎbacks_by_´iÜ™y
 
ENDP


2732 
v®id©e_ÿÎback_add»ss
 
PROC


2733 
push
 
bx


2734 
push
 
cx


2735 
push
 
es


2737 ; 
G‘
 
ÿÎback
 
add»ss


2738 
mov
 
bx
, 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
di
 * 4] ; 
Off£t


2739 
mov
 
cx
, 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
di
 * 4 + 2] ; 
Segm’t


2741 ; 
Basic
 
v®id©iÚ


2742 
‹¡
 
bx
, bx

2743 
jz
 .
šv®id


2744 
‹¡
 
cx
, cx

2745 
jz
 .
šv®id


2746 
cmp
 
cx
, 0040
h
 ; 
DÚ
't‡llow callbacks in†ow memory

2747 
jb
 .
šv®id


2749 ; 
Check
 
cÜru±iÚ
 
·‰”ns


2750 
cmp
 
bx
, 0FFFF
h


2751 
je
 .
šv®id


2752 
cmp
 
cx
, 0FFFF
h


2753 
je
 .
šv®id


2755 
mov
 
ax
, 1 ; 
V®id


2756 
jmp
 .
ex™


2758 .
šv®id
:

2759 
mov
 
ax
, 0 ; 
Inv®id


2761 .
ex™
:

2762 
pİ
 
es


2763 
pİ
 
cx


2764 
pİ
 
bx


2765 
»t


2766 
v®id©e_ÿÎback_add»ss
 
ENDP


2768 
£tup_§ã_ÿÎback_’vœÚm’t
 
PROC


2769 ; 
Sw™ch
 
to
 
´iv©e
 
driv”
 
¡ack


2770 
şi


2771 
mov
 [
­i_ÿÎ”_ss
], 
ss


2772 
mov
 [
­i_ÿÎ”_¥
], 
¥


2773 
mov
 
ax
, 
_DATA


2774 
mov
 
ss
, 
ax


2775 
mov
 
¥
, 
OFFSET
 
­i_¡ack_tİ


2776 
¡i


2777 
»t


2778 
£tup_§ã_ÿÎback_’vœÚm’t
 
ENDP


2780 
§ã_ÿÎback_švoke
 
PROC


2781 
push
 
bp


2782 
mov
 
bp
, 
¥


2784 ; 
S¹
 
timeout
 
tim”


2785 
ÿÎ
 
¡¬t_ÿÎback_tim”


2787 ; 
S‘
 
up
 
·ck‘
 
driv”
 
ÿÎšg
 
cÚv’tiÚ


2788 ; 
AX
 = 
hªdË
, 
CX
 = 
Ëngth
, 
DS
:
SI
 = 
·ck‘
 
d©a


2790 ; 
G‘
 
ÿÎback
 
add»ss


2791 
push
 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
di
 * 4 + 2] ; 
Segm’t


2792 
push
 
wÜd
 
±r
 [
ÿÎback_chašs
 + 
di
 * 4] ; 
Off£t


2794 ; 
Make
 
çr
 
ÿÎ


2795 
ÿÎ
 
çr
 
±r
 [
bp
 - 4]

2797 ; 
Check
 
timeout


2798 
ÿÎ
 
check_ÿÎback_tim”


2800 ; 
CËª
 
up
 
¡ack


2801 
add
 
¥
, 4

2803 ; 
Re¡Üe
 
ÿÎ”
 
¡ack


2804 
şi


2805 
mov
 
ss
, [
­i_ÿÎ”_ss
]

2806 
mov
 
¥
, [
­i_ÿÎ”_¥
]

2807 
¡i


2809 
mov
 
ax
, 0 ; 
Sucûss


2811 
pİ
 
bp


2812 
»t


2813 
§ã_ÿÎback_švoke
 
ENDP


2815 
¡¬t_ÿÎback_tim”
 
PROC


2816 ; 
S‘
 
up
 
timeout
 
tim”
 
usšg
 
DOS
im” 
	`š‹¼u±
 (
INT
 1C
h
 - 18.2 
Hz
)

2817 
push
 
ax


2818 
push
 
dx


2819 
push
 
es


2821 ; 
C®cuÏ‹
 
ticks
 100
ms
 
	`timeout
 (18.2icks/
£c
 = ~2icks 100ms)

2822 
mov
 
ax
, 2 ; 2 
ticks
 = ~110
ms


2823 
mov
 [
ÿÎback_timeout_ticks
], 
ax


2825 ; 
Hook
 
INT
 1C
h
 
nÙ
 
®»ady
 
hooked


2826 
cmp
 
by‹
 
±r
 [
tim”_hooked
], 0

2827 
jÃ
 .
®»ady_hooked


2829 ; 
Save
 
Şd
 
INT
 1C
h
 
veùÜ


2830 
mov
 
ax
, 351C
h
 ; 
G‘
 
š‹¼u±
 
veùÜ


2831 21
h


2832 
mov
 
wÜd
 
±r
 [
Şd_tim”_hªdËr
], 
bx


2833 
mov
 
wÜd
 
±r
 [
Şd_tim”_hªdËr
 + 2], 
es


2835 ; 
In¡®l
 
our
 
tim”
 
hªdËr


2836 
push
 
ds


2837 
mov
 
dx
, 
OFFSET
 
tim”_tick_hªdËr


2838 
push
 
cs


2839 
pİ
 
ds


2840 
mov
 
ax
, 251C
h
 ; 
S‘
 
š‹¼u±
 
veùÜ


2841 21
h


2842 
pİ
 
ds


2844 
mov
 
by‹
 
±r
 [
tim”_hooked
], 1

2846 .
®»ady_hooked
:

2847 
mov
 
by‹
 
±r
 [
ÿÎback_tim”_aùive
], 1

2848 
mov
 
dwÜd
 
±r
 [
ÿÎback_¡¬t_time
], 0 ; 
Re£t
 
tim”


2850 
pİ
 
es


2851 
pİ
 
dx


2852 
pİ
 
ax


2853 
»t


2854 
¡¬t_ÿÎback_tim”
 
ENDP


2856 
check_ÿÎback_tim”
 
PROC


2857 ; 
Check
 
ÿÎback
 
has
 
timed
 
out


2858 
push
 
ax


2860 
cmp
 
by‹
 
±r
 [
ÿÎback_tim”_aùive
], 0

2861 
je
 .
nÙ_aùive


2863 ; 
Check
 
timeout
 
³riod
 
–­£d


2864 
mov
 
ax
, [
ÿÎback_timeout_ticks
]

2865 
cmp
 
ax
, 0

2866 
jÃ
 .
nÙ_timed_out


2868 ; 
Timeout
 
occu¼ed


2869 
mov
 
by‹
 
±r
 [
ÿÎback_tim”_aùive
], 0

2870 
¡c
 ; 
S‘
 
ÿ¼y
 
to
 
šdiÿ‹
 
timeout


2871 
jmp
 .
ex™


2873 .
nÙ_timed_out
:

2874 
şc
 ; 
CË¬
 
ÿ¼y
 - 
no
 
timeout


2875 
jmp
 .
ex™


2877 .
nÙ_aùive
:

2878 
şc
 ; 
Tim”
 
nÙ
 
aùive


2880 .
ex™
:

2881 
pİ
 
ax


2882 
»t


2883 
check_ÿÎback_tim”
 
ENDP


2886 ; 
tim”_tick_hªdËr
 - 
INT
 1C
h
 
tim”
 
tick
 
hªdËr


2888 
tim”_tick_hªdËr
 
PROC
 
FAR


2889 
push
 
ax


2890 
push
 
ds


2892 ; 
S‘
 
up
 
our
 
d©a
 
£gm’t


2893 
push
 
cs


2894 
pİ
 
ds


2896 ; 
Check
 
ÿÎback
 
tim”
 
is
 
aùive


2897 
cmp
 
by‹
 
±r
 [
ÿÎback_tim”_aùive
], 0

2898 
je
 .
chaš_to_Şd


2900 ; 
Deüem’t
 
timeout
 
couÁ”


2901 
mov
 
ax
, [
ÿÎback_timeout_ticks
]

2902 
‹¡
 
ax
,‡x

2903 
jz
 .
chaš_to_Şd


2904 
dec
 
ax


2905 
mov
 [
ÿÎback_timeout_ticks
], 
ax


2907 ; 
If
 
»ached
 
z”o
, 
ÿÎback
 
has
 
timed
 
out


2908 
‹¡
 
ax
,‡x

2909 
jnz
 .
chaš_to_Şd


2911 ; 
M¬k
 
timeout
 
occu¼ed


2912 
mov
 
by‹
 
±r
 [
ÿÎback_timed_out
], 1

2914 .
chaš_to_Şd
:

2915 
pİ
 
ds


2916 
pİ
 
ax


2918 ; 
Chaš
 
to
 
Üigš®
 
hªdËr


2919 
jmp
 
dwÜd
 
±r
 
cs
:[
Şd_tim”_hªdËr
]

2920 
tim”_tick_hªdËr
 
ENDP


2922 
hªdË_ÿÎback_”rÜ
 
PROC


2923 ; 
Inüem’t
 
”rÜ
 
couÁ
 
this
 
ÿÎback


2924 
šc
 
wÜd
 
±r
 [
ÿÎback_”rÜ_couÁs
 + 
di
]

2926 ; 
If
 
too
 
mªy
 
”rÜs
, 
di§bË
 
ÿÎback


2927 
cmp
 
wÜd
 
±r
 [
ÿÎback_”rÜ_couÁs
 + 
di
], 
max_ÿÎback_”rÜs


2928 
jb
 .
ex™


2930 ; 
Di§bË
 
ÿÎback
 
by
 
ş—ršg
 
™


2931 
mov
 
dwÜd
 
±r
 [
ÿÎback_chašs
 + 
di
 * 4], 0

2933 .
ex™
:

2934 
»t


2935 
hªdË_ÿÎback_”rÜ
 
ENDP


2938 ; 
IÁ”ru±
 
HªdËr
 
O±imiz©iÚ
 
FunùiÚs


2942 ; 
İtim®_»gi¡”_§ve
 - 
O±im®ly
 
§ve
 
»gi¡”s
 
ba£d
 
Ú
 
CPU
 
ty³


2944 ; 
IÅut
: 
NÚe


2945 ; 
Ouut
: 
Regi¡”s
 
§ved
 
to
 
¡ack


2946 ; 
U£s
: 
	`Sck
 (
»gi¡”s
 
¬e
 
§ved
)

2948 
İtim®_»gi¡”_§ve
 
PROC


2949 ; 
Check
 
CPU
 
ty³
 
to
 
d‘”mše
 
İtim®
 
§ve
 
¡¿‹gy


2950 
mov
 
®
, [
­i_ıu_ty³
]

2951 
‹¡
 
®
,‡l

2952 
jnz
 .
ıu_known


2954 ; 
Cache
 
CPU
 
ty³
 
Ú
 
fœ¡
 
ÿÎ


2955 
ÿÎ
 
g‘_ıu_ty³


2956 
mov
 [
­i_ıu_ty³
], 
®


2958 .
ıu_known
:

2959 
cmp
 
®
, 1 ; 286?

2960 
jb
 .
u£_šdividu®_push
 ; 8086 - 
no
 
PUSHA


2962 ; 286+ - 
U£
 
	`PUSHA
 (
§ves
 5 
cyşes
 
Ú
 286, 5 cycles on 386)

2963 ; 
FÜ
 486, 
PUSHA
 
is
 
¦ighy
 
	$¦ow”
 (3 
cyşes
 
³ÇÉy
è
but
 
acû±abË


2964 ; 
the
 
code
 
sim¶ic™y
 
ªd
 
»duûd
 
I
-
ÿche
 
´essu»


2965 
pusha


2966 
push
 
es


2967 
push
 
ds


2968 
»t


2970 .
u£_šdividu®_push
:

2971 ; 8086 - 
U£
 
šdividu®
 
pushes


2972 
push
 
ax


2973 
push
 
bx


2974 
push
 
cx


2975 
push
 
dx


2976 
push
 
si


2977 
push
 
di


2978 
push
 
bp


2979 
push
 
es


2980 
push
 
ds


2981 
»t


2982 
İtim®_»gi¡”_§ve
 
ENDP


2985 ; 
İtim®_»gi¡”_»¡Üe
 - 
O±im®ly
 
»¡Üe
 
»gi¡”s
 
ba£d
 
Ú
 
CPU
 
ty³


2987 ; 
IÅut
: 
NÚe


2988 ; 
Ouut
: 
Regi¡”s
 
»¡Üed
 
äom
 
¡ack


2989 ; 
U£s
: 
	`Sck
 (
»gi¡”s
 
¬e
 
»¡Üed
)

2991 
İtim®_»gi¡”_»¡Üe
 
PROC


2992 
mov
 
®
, [
­i_ıu_ty³
]

2993 
cmp
 
®
, 1 ; 286+?

2994 
jb
 .
u£_šdividu®_pİ


2996 ; 286+ - 
U£
 
POPA


2997 
pİ
 
ds


2998 
pİ
 
es


2999 
pİa


3000 
»t


3002 .
u£_šdividu®_pİ
:

3003 ; 8086 - 
U£
 
šdividu®
 
	$pİs
 (
»v”£
 
Üd”
)

3004 
pİ
 
ds


3005 
pİ
 
es


3006 
pİ
 
bp


3007 
pİ
 
di


3008 
pİ
 
si


3009 
pİ
 
dx


3010 
pİ
 
cx


3011 
pİ
 
bx


3012 
pİ
 
ax


3013 
»t


3014 
İtim®_»gi¡”_»¡Üe
 
ENDP


3017 ; 
ç¡_­i_di¥©ch
 - 
Fa¡
 
·th
 
di¥©ch
 
commÚ
 
API
 
funùiÚs


3019 ; 
IÅut
: 
AH
 = 
funùiÚ
 
numb”


3020 ; 
Ouut
: 
AX
 = 0 
hªdËd
, 
nÚ
-
z”o
 
Ãeds
 
fuÎ
 
di¥©ch


3021 ; 
U£s
: 
AX
, 
	`BX
 (
Ùh”
 
»gi¡”s
 
´e£rved
)

3023 
ç¡_­i_di¥©ch
 
PROC


3024 
push
 
bx


3025 
push
 
cx


3027 ; 
Check
 
mo¡
 
commÚ
 
funùiÚs
 
ªd
 
hªdË
 
them
 
w™h
 
mšim®
 
ov”h—d


3028 ; 
FunùiÚ
 
u§ge
 
	$äequ’cy
 (
typiÿl
): 
	`SEND_PKT
(4)=60%, 
	`ACCESS_TYPE
(2)=20%,

3029 ; 
	`DRIVER_INFO
(1)=10%, 
Ùh”s
=10%

3031 
cmp
 
ah
, 
API_SEND_PKT
 ; 
Mo¡
 
commÚ
 - 
·ck‘
 
£ndšg


3032 
je
 .
ç¡_£nd_·ck‘


3034 
cmp
 
ah
, 
API_ACCESS_TYPE
 ; 
SecÚd
 
mo¡
 
commÚ
 - 
ty³
 
»gi¡¿tiÚ


3035 
je
 .
ç¡_acûss_ty³


3037 
cmp
 
ah
, 
API_DRIVER_INFO
 ; 
Thœd
 
mo¡
 
commÚ
 - 
driv”
 
qu”›s


3038 
je
 .
ç¡_driv”_šfo


3040 
cmp
 
ah
, 
API_RELEASE_TYPE
 ; 
CommÚ
 - 
ty³
 
»Ëa£


3041 
je
 .
ç¡_»Ëa£_ty³


3043 ; 
NÙ
 
a
 
ç¡
-
·th
 
funùiÚ


3044 
šc
 
dwÜd
 
±r
 [
ç¡_·th_mis£s
]

3045 
mov
 
ax
, 1 ; 
SigÇl
 
Ãed
 
fuÎ
 
di¥©ch


3046 
jmp
 .
ç¡_di¥©ch_ex™


3048 .
ç¡_£nd_·ck‘
:

3049 ; 
Fa¡
 
·th
 
·ck‘
 
	`£ndšg
 (
mo¡
 
³rfÜmªû
 
ü™iÿl
)

3050 ; 
Sk
 
ex‹nsive
 
v®id©iÚ
 
³rfÜmªû
, 
»ly
 
Ú
 
h¬dw¬e
 validation

3052 ; 
Quick
 
·¿m‘”
 
v®id©iÚ


3053 
‹¡
 
cx
, cx ; 
Z”o
 
Ëngth
?

3054 
jz
 .
ç¡_£nd_”rÜ


3055 
cmp
 
cx
, 1514 ; 
Too
 
Ïrge
?

3056 
ja
 .
ç¡_£nd_”rÜ


3058 ; 
C®l
 
İtimized
 
£nd
 
routše
 
dœeùly


3059 
ÿÎ
 
­i_£nd_·ck‘_ç¡


3060 
jmp
 .
ç¡_£nd_com¶‘e


3062 .
ç¡_£nd_”rÜ
:

3063 
mov
 
dh
, 
PKT_ERROR_CANT_SEND


3064 
¡c


3065 
jmp
 .
ç¡_£nd_com¶‘e


3067 .
ç¡_£nd_com¶‘e
:

3068 
šc
 
dwÜd
 
±r
 [
ç¡_·th_h™s
]

3069 
mov
 
by‹
 
±r
 [
Ï¡_funùiÚ
], 
API_SEND_PKT


3070 
mov
 
ax
, 0 ; 
SigÇl
 
hªdËd


3071 
jmp
 .
ç¡_di¥©ch_ex™


3073 .
ç¡_acûss_ty³
:

3074 ; 
Fa¡
 
·th
 
ty³
 
	`acûss
 (
£cÚd
 
mo¡
 
commÚ
)

3076 ; 
Quick
 
v®id©iÚ


3077 
cmp
 
®
, [
š‹rçû_couÁ
]

3078 
j«
 .
ç¡_acûss_”rÜ


3080 ; 
C®l
 
ç¡
 
acûss
 
ty³
 
routše


3081 
ÿÎ
 
­i_acûss_ty³_ç¡


3082 
jmp
 .
ç¡_acûss_com¶‘e


3084 .
ç¡_acûss_”rÜ
:

3085 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


3086 
¡c


3087 
jmp
 .
ç¡_acûss_com¶‘e


3089 .
ç¡_acûss_com¶‘e
:

3090 
šc
 
dwÜd
 
±r
 [
ç¡_·th_h™s
]

3091 
mov
 
by‹
 
±r
 [
Ï¡_funùiÚ
], 
API_ACCESS_TYPE


3092 
mov
 
ax
, 0 ; 
SigÇl
 
hªdËd


3093 
jmp
 .
ç¡_di¥©ch_ex™


3095 .
ç¡_driv”_šfo
:

3096 ; 
Fa¡
 
·th
 
driv”
 
	$šfo
 (
thœd
 
mo¡
 
commÚ
)

3097 
ÿÎ
 
­i_driv”_šfo_ç¡


3099 
šc
 
dwÜd
 
±r
 [
ç¡_·th_h™s
]

3100 
mov
 
by‹
 
±r
 [
Ï¡_funùiÚ
], 
API_DRIVER_INFO


3101 
mov
 
ax
, 0 ; 
SigÇl
 
hªdËd


3102 
jmp
 .
ç¡_di¥©ch_ex™


3104 .
ç¡_»Ëa£_ty³
:

3105 ; 
Fa¡
 
·th
 
ty³
 
»Ëa£


3106 
ÿÎ
 
­i_»Ëa£_ty³_ç¡


3108 
šc
 
dwÜd
 
±r
 [
ç¡_·th_h™s
]

3109 
mov
 
by‹
 
±r
 [
Ï¡_funùiÚ
], 
API_RELEASE_TYPE


3110 
mov
 
ax
, 0 ; 
SigÇl
 
hªdËd


3112 .
ç¡_di¥©ch_ex™
:

3113 
pİ
 
cx


3114 
pİ
 
bx


3115 
»t


3116 
ç¡_­i_di¥©ch
 
ENDP


3119 ; 
ç¡_»gi¡”_»¡Üe
 - 
Mšim®
 
»¡Üe
 
ç¡
 
·th
 
funùiÚs


3121 ; 
IÅut
: 
NÚe


3122 ; 
Ouut
: 
Es£ÁŸl
 
»gi¡”s
 
»¡Üed


3123 ; 
U£s
: 
Sck


3125 
ç¡_»gi¡”_»¡Üe
 
PROC


3126 ; 
Fa¡
 
·th
 
funùiÚs
 
u£
 
mšim®
 
»gi¡”s
, 
so
 
»¡Üe
 
İtim®ly


3127 ; 
OÆy
 
»¡Üe
 
wh©
 
was
 
§ved
 
by
 
İtim®_»gi¡”_§ve


3129 
mov
 
®
, [
­i_ıu_ty³
]

3130 
cmp
 
®
, 1 ; 286+?

3131 
j«
 .
ç¡_pİa


3133 ; 8086 - 
šdividu®
 
pİs


3134 
pİ
 
ds


3135 
pİ
 
es


3136 
add
 
¥
, 14 ; 
Sk
 
the
 7 
g’”®
 
pu½o£
 
	$»gi¡”s
 (2 
by‹s
 
—ch
)

3137 
»t


3139 .
ç¡_pİa
:

3140 ; 286+ - 
u£
 
POPA


3141 
pİ
 
ds


3142 
pİ
 
es


3143 
add
 
¥
, 16 ; 
Sk
 
PUSHA
 
§ved
 
	`»gi¡”s
 (8 
»gi¡”s
 Ã— 2 
by‹s
)

3144 
»t


3145 
ç¡_»gi¡”_»¡Üe
 
ENDP


3148 ; 
Fa¡
 
P©h
 
API
 
FunùiÚ
 
Im¶em’tiÚs


3152 ; 
­i_£nd_·ck‘_ç¡
 - 
Fa¡
 
·th
 
·ck‘
 
£ndšg
 
w™h
 
mšim®
 
ov”h—d


3154 ; 
IÅut
: 
DS
:
SI
 = 
·ck‘
, 
CX
 = 
	`Ëngth
 (
®»ady
 
v®id©ed
)

3155 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


3156 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
	`DX
 (
mšim®
 
u§ge
)

3158 
­i_£nd_·ck‘_ç¡
 
PROC


3159 ; 
Mšim®
 
v®id©iÚ
 - 
assume
 
·¿m‘”s
 
¬e
 
good


3160 ; 
U£
 
dœeù
 
h¬dw¬e
 
ÿÎ
 
to
 
by·ss
 
C
 
Ïy”
 
ov”h—d


3162 
push
 
si


3163 
push
 
di


3165 ; 
Quick
 
NIC
 
	$£ËùiÚ
 (
assume
 
NIC
 0 
ç¡
 
·th
)

3166 
mov
 
®
, 0 ; 
U£
 
´im¬y
 
NIC


3168 ; 
C®l
 
h¬dw¬e
 
£nd
 
dœeùly
 
w™h
 
mšim®
 
£tup


3169 
ÿÎ
 
h¬dw¬e_£nd_·ck‘_asm


3170 
‹¡
 
ax
,‡x

3171 
jnz
 .
ç¡_£nd_çed


3173 
mov
 
dh
, 
PKT_SUCCESS


3174 
jmp
 .
ç¡_£nd_dÚe


3176 .
ç¡_£nd_çed
:

3177 
mov
 
dh
, 
PKT_ERROR_CANT_SEND


3179 .
ç¡_£nd_dÚe
:

3180 
pİ
 
di


3181 
pİ
 
si


3182 
»t


3183 
­i_£nd_·ck‘_ç¡
 
ENDP


3186 ; 
­i_acûss_ty³_ç¡
 - 
Fa¡
 
·th
 
ty³
 
acûss
 
w™h
 
mšim®
 
v®id©iÚ


3188 ; 
IÅut
: 
AL
 = 
š‹rçû
, 
BX
 = 
·ck‘
 
ty³
, 
ES
:
DI
 = 
»ûiv”


3189 ; 
Ouut
: 
AX
 = 
hªdË
, 
DH
 = 
”rÜ
 
code


3190 ; 
U£s
: 
AX
, 
BX
, 
	`SI
 (
mšim®
 
u§ge
)

3192 
­i_acûss_ty³_ç¡
 
PROC


3193 
push
 
si


3195 ; 
Fšd
 
ä“
 
hªdË
 
	$quickly
 (
lš—r
 
£¬ch
)

3196 
mov
 
si
, 
OFFSET
 
hªdË_bË


3197 
mov
 
ax
, 1 ; 
S¹
 
w™h
 
hªdË
 1

3199 .
ç¡_fšd_hªdË
:

3200 
cmp
 
wÜd
 
±r
 [
si
], 0 ; 
F»e
 
¦Ù
?

3201 
je
 .
ç¡_found_hªdË


3202 
add
 
si
, 2

3203 
šc
 
ax


3204 
cmp
 
ax
, 
MAX_HANDLES


3205 
ja
 .
ç¡_no_hªdËs


3206 
jmp
 .
ç¡_fšd_hªdË


3208 .
ç¡_no_hªdËs
:

3209 
mov
 
dh
, 
PKT_ERROR_NO_SPACE


3210 
jmp
 .
ç¡_acûss_dÚe


3212 .
ç¡_found_hªdË
:

3213 ; 
AÎoÿ‹
 
hªdË
 
w™h
 
mšim®
 
£tup


3214 
mov
 [
si
], 
bx
 ; 
StÜe
 
·ck‘
 
ty³


3216 ; 
StÜe
 
	$ÿÎback
 (
mšim®
 
v®id©iÚ
)

3217 
dec
 
ax
 ; 
CÚv”t
 
to
 0-
ba£d
 
šdex


3218 
push
 
ax


3219 
shl
 
ax
, 2 ; 
DwÜd
 
off£t


3220 
mov
 
si
, 
ax


3222 ; 
Basic
 
ÿÎback
 
v®id©iÚ


3223 
‹¡
 
di
, di

3224 
jz
 .
ç¡_šv®id_ÿÎback


3225 
mov
 
cx
, 
es


3226 
‹¡
 
cx
, cx

3227 
jz
 .
ç¡_šv®id_ÿÎback


3229 ; 
StÜe
 
ÿÎback


3230 
mov
 
wÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
si
], 
di


3231 
mov
 
wÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
si
 + 2], 
es


3233 
pİ
 
ax


3234 
šc
 
ax
 ; 
CÚv”t
 
back
 
to
 1-
ba£d
 
hªdË


3235 
šc
 
wÜd
 
±r
 [
aùive_hªdËs
]

3236 
mov
 
dh
, 
PKT_SUCCESS


3237 
jmp
 .
ç¡_acûss_dÚe


3239 .
ç¡_šv®id_ÿÎback
:

3240 
pİ
 
ax
 ; 
CËª
 
up
 
¡ack


3241 
mov
 
dh
, 
PKT_ERROR_BAD_ADDRESS


3243 .
ç¡_acûss_dÚe
:

3244 
pİ
 
si


3245 
»t


3246 
­i_acûss_ty³_ç¡
 
ENDP


3249 ; 
­i_driv”_šfo_ç¡
 - 
Fa¡
 
·th
 
driv”
 
šfo
 
w™h
 
mšim®
 
´oûssšg


3251 ; 
IÅut
: 
AL
 = 
š‹rçû
 
numb”


3252 ; 
Ouut
: 
BX
, 
CH
, 
CL
, 
DL
, 
DS
:
SI
 
³r
 
¥ec
, 
DH
 = 
”rÜ
 
code


3253 ; 
U£s
: 
AX
, 
BX
, 
CX
, 
DX
, 
	`SI
 (
¡ªd¬d
 
£t
)

3255 
­i_driv”_šfo_ç¡
 
PROC


3256 ; 
Quick
 
š‹rçû
 
v®id©iÚ


3257 
cmp
 
®
, [
š‹rçû_couÁ
]

3258 
j«
 .
ç¡_šfo_bad_numb”


3260 ; 
R‘uº
 
¡ªd¬d
 
driv”
 
šfo
 
quickly


3261 
mov
 
bx
, 0100
h
 ; 
V”siÚ
 1.0

3262 
mov
 
ch
, 1 ; 
CÏss
 1 (
DIX
 
Eth”Ãt
)

3263 
mov
 
ş
, 1 ; 
Ty³
 1

3264 
mov
 
dl
, 
®
 ; 
IÁ”çû
 
numb”


3265 
mov
 
si
, 
OFFSET
 
driv”_Çme
 ; 
Driv”
 
Çme


3266 
mov
 
dh
, 
PKT_SUCCESS


3267 
»t


3269 .
ç¡_šfo_bad_numb”
:

3270 
mov
 
dh
, 
PKT_ERROR_NO_NUMBER


3271 
»t


3272 
­i_driv”_šfo_ç¡
 
ENDP


3275 ; 
­i_»Ëa£_ty³_ç¡
 - 
Fa¡
 
·th
 
ty³
 
»Ëa£
 
w™h
 
mšim®
 
ş—nup


3277 ; 
IÅut
: 
BX
 = 
hªdË


3278 ; 
Ouut
: 
DH
 = 
”rÜ
 
code


3279 ; 
U£s
: 
AX
, 
BX
, 
	`SI
 (
mšim®
 
u§ge
)

3281 
­i_»Ëa£_ty³_ç¡
 
PROC


3282 
push
 
si


3284 ; 
Quick
 
hªdË
 
v®id©iÚ


3285 
cmp
 
bx
, 1

3286 
jb
 .
ç¡_»l_bad_hªdË


3287 
cmp
 
bx
, 
MAX_HANDLES


3288 
ja
 .
ç¡_»l_bad_hªdË


3290 ; 
Check
 
hªdË
 
is
 
®loÿ‹d


3291 
dec
 
bx
 ; 
CÚv”t
 
to
 0-
ba£d


3292 
mov
 
si
, 
bx


3293 
shl
 
si
, 1 ; 
WÜd
 
off£t


3294 
cmp
 
wÜd
 
±r
 [
hªdË_bË
 + 
si
], 0

3295 
je
 .
ç¡_»l_bad_hªdË


3297 ; 
F»e
 
the
 
hªdË
 
quickly


3298 
mov
 
wÜd
 
±r
 [
hªdË_bË
 + 
si
], 0

3300 ; 
CË¬
 
ÿÎback


3301 
shl
 
bx
, 2 ; 
DwÜd
 
off£t
 
ÿÎback
 
bË


3302 
mov
 
dwÜd
 
±r
 [
hªdË_ÿÎbacks
 + 
bx
], 0

3304 ; 
Deüem’t
 
couÁ


3305 
cmp
 
wÜd
 
±r
 [
aùive_hªdËs
], 0

3306 
je
 .
ç¡_»l_couÁ_ok


3307 
dec
 
wÜd
 
±r
 [
aùive_hªdËs
]

3309 .
ç¡_»l_couÁ_ok
:

3310 
mov
 
dh
, 
PKT_SUCCESS


3311 
jmp
 .
ç¡_»l_dÚe


3313 .
ç¡_»l_bad_hªdË
:

3314 
mov
 
dh
, 
PKT_ERROR_BAD_HANDLE


3316 .
ç¡_»l_dÚe
:

3317 
pİ
 
si


3318 
»t


3319 
­i_»Ëa£_ty³_ç¡
 
ENDP


3322 ; 
­i_³rfÜmªû_m‘rics
 - 
G‘
 
API
 
³rfÜmªû
 
m‘rics


3324 ; 
IÅut
: 
ES
:
DI
 = 
bufãr
 
m‘rics


3325 ; 
Ouut
: 
Bufãr
 
fËd
 
w™h
 
³rfÜmªû
 
d©a


3326 ; 
U£s
: 
AX
, 
CX
, 
SI
, 
DI


3328 
­i_³rfÜmªû_m‘rics
 
PROC


3329 
push
 
si


3330 
push
 
cx


3332 ; 
Cİy
 
³rfÜmªû
 
m‘rics


3333 
mov
 
—x
, [
ç¡_·th_h™s
]

3334 
¡osd


3335 
mov
 
—x
, [
ç¡_·th_mis£s
]

3336 
¡osd


3338 ; 
Add
 
CPU
 
İtimiz©iÚ
 
šfo


3339 
mov
 
®
, [
­i_ıu_ty³
]

3340 
¡osb


3341 
mov
 
®
, [
­i_pusha_th»shŞd
]

3342 
¡osb


3343 
mov
 
®
, [
Ï¡_funùiÚ
]

3344 
¡osb


3346 ; 
C®cuÏ‹
 
h™
 
	`¿tio
 (
h™s
 * 100 / (h™ + 
mis£s
))

3347 
mov
 
—x
, [
ç¡_·th_h™s
]

3348 
mov
 
ecx
, 100

3349 
mul
 
ecx
 ; 
h™s
 * 100

3350 
mov
 
ecx
, [
ç¡_·th_h™s
]

3351 
add
 
ecx
, [
ç¡_·th_mis£s
] ; 
tÙ®
 
ÿÎs


3352 
‹¡
 
ecx
,ƒcx

3353 
jz
 .
no_ÿÎs


3354 
div
 
ecx
 ; 
h™
 
¿tio
 
³rûÁage


3355 
jmp
 .
¡Üe_¿tio


3357 .
no_ÿÎs
:

3358 
xÜ
 
—x
,ƒax

3360 .
¡Üe_¿tio
:

3361 
¡osw
 ; 
StÜe
 
h™
 
¿tio
 
as
 
wÜd


3363 
pİ
 
cx


3364 
pİ
 
si


3365 
»t


3366 
­i_³rfÜmªû_m‘rics
 
ENDP


3369 ; 
H¬dw¬e
 
»£t
 
h–³r
 
funùiÚs


3372 
»£t_3c509b_h¬dw¬e
 
PROC


3373 ; 
Re£t
 3C509B 
NIC
 
h¬dw¬e


3374 
push
 
ax


3376 ; 
Issue
 
glob®
 
»£t
 
commªd


3377 
mov
 
ax
, 0x0000 ; 
GLOBAL_RESET
 
commªd


3378 
add
 
dx
, 0x0E ; 
Commªd
 

3379 
out
 
dx
, 
ax


3381 ; 
Wa™
 
»£t
 
to
 
	$com¶‘e
 (
mšimum
 1
ms
)

3382 
mov
 
cx
, 1000

3383 .
»£t_d–ay
:

3384 
š
 
®
, 0x80 ; 
I
/
O
 
d–ay


3385 
loİ
 .
»£t_d–ay


3387 ; 
Re
-
’abË
 
ad­‹r


3388 
mov
 
ax
, 0x0100 ; 
RX_ENABLE


3389 
out
 
dx
, 
ax


3390 
mov
 
ax
, 0x0200 ; 
TX_ENABLE


3391 
out
 
dx
, 
ax


3393 
pİ
 
ax


3394 
»t


3395 
»£t_3c509b_h¬dw¬e
 
ENDP


3397 
»£t_3c515_h¬dw¬e
 
PROC


3398 ; 
Re£t
 3C515-
TX
 
ISA
 
NIC
 
h¬dw¬e


3399 
push
 
ax


3400 
push
 
cx


3402 ; 
Issue
 
glob®
 
»£t
 
commªd


3403 
mov
 
ax
, 0x0000 ; 
GLOBAL_RESET


3404 
add
 
dx
, 0x0E ; 
Commªd
 

3405 
out
 
dx
, 
ax


3407 ; 
ISA
 
timšg
 
	`d–ay
 (~10
ms
 
»£t
)

3408 
mov
 
cx
, 10000 ; 10
ms
 
d–ay


3409 .
»£t_d–ay
:

3410 
out
 80
h
, 
®
 ; 
ISA
 
I
/
O
 
	`d–ay
 (~1u
s
)

3411 
loİ
 .
»£t_d–ay


3413 ; 
Re
-
’abË
 
	$ad­‹r
 (
ISA
 
bus
 
ma¡”
 
mode
)

3414 
sub
 
dx
, 0x0E ; 
Back
 
to
 
ba£


3415 
add
 
dx
, 0x0E ; 
Commªd
 

3417 ; 
EÇbË
 
RX


3418 
mov
 
ax
, 0x0100 ; 
RX_ENABLE


3419 
out
 
dx
, 
ax


3421 ; 
EÇbË
 
TX


3422 
mov
 
ax
, 0x0200 ; 
TX_ENABLE


3423 
out
 
dx
, 
ax


3425 ; 
EÇbË
 
ISA
 
bus
 
ma¡”šg
 
suµÜ‹d


3426 
mov
 
ax
, 0x2000 ; 
BUS_MASTER_ENABLE


3427 
out
 
dx
, 
ax


3429 
pİ
 
cx


3430 
pİ
 
ax


3431 
»t


3432 
»£t_3c515_h¬dw¬e
 
ENDP


3434 
ş—r_š‹rçû_bufãrs
 
PROC


3435 ; 
CË¬
 
®l
 
bufãrs
 
assocŸ‹d
 
w™h
 
ª
 
š‹rçû


3436 
push
 
cx


3437 
push
 
si


3438 
push
 
di


3440 ; 
CË¬
 
RX
 
bufãrs


3441 
mov
 
cx
, 32 ; 
Assume
 32 
RX
 
bufãrs


3442 
xÜ
 
si
, si

3443 .
ş—r_rx
:

3444 ; 
M¬k
 
bufãr
 
as
 
ä“


3445 
mov
 
by‹
 
±r
 [
rx_bufãr_¡©us
 + 
si
], 0

3446 
šc
 
si


3447 
loİ
 .
ş—r_rx


3449 ; 
CË¬
 
TX
 
bufãrs


3450 
mov
 
cx
, 16 ; 
Assume
 16 
TX
 
bufãrs


3451 
xÜ
 
si
, si

3452 .
ş—r_tx
:

3453 
mov
 
by‹
 
±r
 [
tx_bufãr_¡©us
 + 
si
], 0

3454 
šc
 
si


3455 
loİ
 .
ş—r_tx


3457 
pİ
 
di


3458 
pİ
 
si


3459 
pİ
 
cx


3460 
»t


3461 
ş—r_š‹rçû_bufãrs
 
ENDP


3464 ; 
MuÉiÿ¡
 
h¬dw¬e
 
´og¿mmšg


3467 
£t_h¬dw¬e_muÉiÿ¡
 
PROC


3468 ; 
Prog¿m
 
h¬dw¬e
 
w™h
 
muÉiÿ¡
 
add»s£s


3469 
push
 
ax


3470 
push
 
cx


3471 
push
 
dx


3472 
push
 
si


3474 ; 
S–eù
 
­´İrŸ‹
 
wšdow
 
muÉiÿ¡
 
»gi¡”s


3475 
mov
 
dx
, 0x300 ; 
Ba£
 
I
/
O


3476 
mov
 
ax
, 0x0803 ; 
SELECT_WINDOW
 3

3477 
add
 
dx
, 0x0E

3478 
out
 
dx
, 
ax


3480 ; 
Prog¿m
 
muÉiÿ¡
 
hash
 
	`bË
 (
sim¶if›d
)

3481 ; 
R—l
 
im¶em’tiÚ
 
would
 
ÿlcuÏ‹
 
hash
 
—ch
 
add»ss


3482 
mov
 
cx
, [
muÉiÿ¡_couÁ
]

3483 
‹¡
 
cx
, cx

3484 
jz
 .
ş—r_®l


3486 ; 
EÇbË
 
®l
 
muÉiÿ¡
 
sim¶ic™y


3487 
mov
 
ax
, 0xFFFF

3488 
sub
 
dx
, 0x0E

3489 
add
 
dx
, 0x06 ; 
MuÉiÿ¡
 
f‹r
 

3490 
out
 
dx
, 
ax


3491 
jmp
 .
dÚe


3493 .
ş—r_®l
:

3494 ; 
Di§bË
 
muÉiÿ¡


3495 
xÜ
 
ax
,‡x

3496 
sub
 
dx
, 0x0E

3497 
add
 
dx
, 0x06

3498 
out
 
dx
, 
ax


3500 .
dÚe
:

3501 
pİ
 
si


3502 
pİ
 
dx


3503 
pİ
 
cx


3504 
pİ
 
ax


3505 
»t


3506 
£t_h¬dw¬e_muÉiÿ¡
 
ENDP


3508 
ş—r_h¬dw¬e_muÉiÿ¡
 
PROC


3509 ; 
CË¬
 
®l
 
muÉiÿ¡
 
add»s£s
 
äom
 
h¬dw¬e


3510 
push
 
ax


3511 
push
 
dx


3513 
mov
 
dx
, 0x300 ; 
Ba£
 
I
/
O


3514 
mov
 
ax
, 0x0803 ; 
SELECT_WINDOW
 3

3515 
add
 
dx
, 0x0E

3516 
out
 
dx
, 
ax


3518 ; 
CË¬
 
muÉiÿ¡
 
f‹r


3519 
xÜ
 
ax
,‡x

3520 
sub
 
dx
, 0x0E

3521 
add
 
dx
, 0x06

3522 
out
 
dx
, 
ax


3524 
pİ
 
dx


3525 
pİ
 
ax


3526 
»t


3527 
ş—r_h¬dw¬e_muÉiÿ¡
 
ENDP


3530 ; 
PriÜ™y
 
queue
 
mªagem’t


3533 
sÜt_´iÜ™y_queue
 
PROC


3534 ; 
Sim¶e
 
bubbË
 
sÜt
 
sm®l
 
´iÜ™y
 
queue


3535 
push
 
ax


3536 
push
 
bx


3537 
push
 
cx


3538 
push
 
dx


3539 
push
 
si


3540 
push
 
di


3542 
mov
 
cx
, [
´iÜ™y_queue_
]

3543 
sub
 
cx
, [
´iÜ™y_queue_h—d
]

3544 
ªd
 
cx
, 
PRIORITY_QUEUE_MASK


3545 
cmp
 
cx
, 1

3546 
jbe
 .
dÚe
 ; 0 
Ü
 1 
™ems
, 
®»ady
 
sÜ‹d


3548 .
ou‹r_loİ
:

3549 
xÜ
 
dx
, dx ; 
No
 
sw­s
 
æag


3550 
mov
 
si
, [
´iÜ™y_queue_h—d
]

3552 .
šÃr_loİ
:

3553 
mov
 
di
, 
si


3554 
šc
 
di


3555 
ªd
 
di
, 
PRIORITY_QUEUE_MASK


3557 
cmp
 
di
, [
´iÜ™y_queue_
]

3558 
je
 .
check_sw­³d


3560 ; 
Com·»
 
´iÜ™›s


3561 
shl
 
si
, 3 ; 8 
by‹s
 
³r
 
’Œy


3562 
shl
 
di
, 3

3563 
mov
 
®
, [
´iÜ™y_queue
 + 
si
 + 2] ; 
PriÜ™y
 
of
 
fœ¡


3564 
cmp
 
®
, [
´iÜ™y_queue
 + 
di
 + 2] ; 
PriÜ™y
 
of
 
£cÚd


3565 
jbe
 .
no_sw­


3567 ; 
Sw­
 
	$’Œ›s
 (8 
by‹s
 
—ch
)

3568 
push
 
cx


3569 
mov
 
cx
, 4 ; 4 
wÜds
 = 8 
by‹s


3570 
Ëa
 
si
, [
´iÜ™y_queue
 + si]

3571 
Ëa
 
di
, [
´iÜ™y_queue
 + di]

3572 .
sw­_loİ
:

3573 
mov
 
ax
, [
si
]

3574 
xchg
 
ax
, [
di
]

3575 
mov
 [
si
], 
ax


3576 
add
 
si
, 2

3577 
add
 
di
, 2

3578 
loİ
 .
sw­_loİ


3579 
pİ
 
cx


3581 
mov
 
dx
, 1 ; 
S‘
 
sw­³d
 
æag


3583 .
no_sw­
:

3584 
shr
 
si
, 3 ; 
Back
 
to
 
šdex


3585 
šc
 
si


3586 
ªd
 
si
, 
PRIORITY_QUEUE_MASK


3587 
jmp
 .
šÃr_loİ


3589 .
check_sw­³d
:

3590 
‹¡
 
dx
, dx

3591 
jnz
 .
ou‹r_loİ
 ; 
If
 
sw­³d
, dØ
ªÙh”
 
·ss


3593 .
dÚe
:

3594 
pİ
 
di


3595 
pİ
 
si


3596 
pİ
 
dx


3597 
pİ
 
cx


3598 
pİ
 
bx


3599 
pİ
 
ax


3600 
»t


3601 
sÜt_´iÜ™y_queue
 
ENDP


3603 
´oûss_´iÜ™y_queue
 
PROC


3604 ; 
Proûss
 
·ck‘s
 
äom
 
´iÜ™y
 
queue


3605 
push
 
ax


3606 
push
 
bx


3607 
push
 
cx


3608 
push
 
si


3610 ; 
Check
 
queue
 
has
 
·ck‘s


3611 
mov
 
ax
, [
´iÜ™y_queue_h—d
]

3612 
cmp
 
ax
, [
´iÜ™y_queue_
]

3613 
je
 .
em±y


3615 ; 
G‘
 
highe¡
 
´iÜ™y
 
	$·ck‘
 (
©
 
h—d
 
aá”
 
sÜtšg
)

3616 
mov
 
si
, 
ax


3617 
shl
 
si
, 3 ; 8 
by‹s
 
³r
 
’Œy


3618 
Ëa
 
si
, [
´iÜ™y_queue
 + si]

3620 ; 
Lßd
 
·ck‘
 
šfo


3621 
mov
 
bx
, [
si
] ; 
HªdË


3622 
mov
 
®
, [
si
 + 2] ; 
PriÜ™y


3623 
mov
 
cx
, [
si
 + 4] ; 
L’gth


3624 
push
 
wÜd
 
±r
 [
si
 + 6] ; 
Segm’t


3625 
pİ
 
ds


3627 ; 
Proûss
 
	`·ck‘
 (
sim¶if›d
 - 
would
 
ÿÎ
 
aùu®
 
hªdËr
)

3630 ; 
Remove
 
äom
 
queue


3631 
šc
 
wÜd
 
±r
 [
´iÜ™y_queue_h—d
]

3632 
ªd
 
wÜd
 
±r
 [
´iÜ™y_queue_h—d
], 
PRIORITY_QUEUE_MASK


3634 .
em±y
:

3635 
pİ
 
si


3636 
pİ
 
cx


3637 
pİ
 
bx


3638 
pİ
 
ax


3639 
»t


3640 
´oûss_´iÜ™y_queue
 
ENDP


3643 ; 
Bufãr
 
¡©us
 
	`¬¿ys
 (
should
 
be
 
š
 
d©a
 
£ùiÚ
 
but
 
addšg
 
h”e
 
com¶‘’ess
)

3645 
rx_bufãr_¡©us
 
db
 32 
	`dup
(0è; 
RX
 
bufãr
 
¡©us
 
æags


3646 
tx_bufãr_¡©us
 
db
 16 
	`dup
(0è; 
TX
 
bufãr
 
¡©us
 
æags


3648 
_TEXT
 
ENDS


	@/Users/jvindahl/Development/3com-packet-driver/src/c/3c509b.c

11 
	~"../šşude/3c509b.h
"

12 
	~"../šşude/h¬dw¬e.h
"

13 
	~"../šşude/loggšg.h
"

14 
	~"../šşude/memÜy.h
"

15 
	~"../šşude/commÚ.h
"

16 
	~"../šşude/bufãr_®loc.h
"

17 
	~"../šşude/·ck‘_İs.h
"

18 
	~"../šşude/medŸ_cÚŒŞ.h
"

19 
	~"../šşude/nic_defs.h
"

20 
	~"../šşude/š‹¼u±_m™ig©iÚ.h
"

21 
	~"../šşude/hw_checksum.h
"

22 
	~"../šşude/dœeù_pio_’hªûd.h
"

23 
	~<¡ršg.h
>

26 
_3c509b_š™
(
nic_šfo_t
 *
nic
);

27 
_3c509b_ş—nup
(
nic_šfo_t
 *
nic
);

28 
_3c509b_»£t
(
nic_šfo_t
 *
nic
);

29 
_3c509b_cÚfigu»
(
nic_šfo_t
 *
nic
, cÚ¡ *
cÚfig
);

30 
_3c509b_£nd_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
);

31 
_3c509b_»ûive_·ck‘
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ëngth
);

32 
boŞ
 
_3c509b_check_š‹¼u±
(
nic_šfo_t
 *
nic
);

33 
_3c509b_hªdË_š‹¼u±
(
nic_šfo_t
 *
nic
);

34 
_3c509b_’abË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

35 
_3c509b_di§bË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

36 
boŞ
 
_3c509b_g‘_lšk_¡©us
(
nic_šfo_t
 *
nic
);

37 
_3c509b_g‘_lšk_¥“d
(
nic_šfo_t
 *
nic
);

38 
_3c509b_£t_´omiscuous
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË
);

39 
_3c509b_£t_muÉiÿ¡
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
mc_li¡
, 
couÁ
);

40 
_3c509b_£lf_‹¡
(
nic_šfo_t
 *
nic
);

43 
_3c509b_£Ëù_wšdow
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
wšdow
);

44 
_3c509b_wa™_fÜ_cmd_busy
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
);

45 
ušt16_t
 
_3c509b_»ad_“´om
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
add»ss
);

46 
_3c509b_wr™e_“´om
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
add»ss
, 
ušt16_t
 
d©a
);

47 
_3c509b_»ad_mac_äom_“´om
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
mac
);

48 
_3c509b_£tup_medŸ
(
nic_šfo_t
 *
nic
);

49 
_3c509b_£tup_rx_f‹r
(
nic_šfo_t
 *
nic
);

52 
nic_İs_t
 
	g_3c509b_İs
 = {

53 .
š™
 = 
_3c509b_š™
,

54 .
	gş—nup
 = 
_3c509b_ş—nup
,

55 .
	g»£t
 = 
_3c509b_»£t
,

56 .
	gcÚfigu»
 = ((*)(
nic_šfo
 *, cÚ¡ *))
	g_3c509b_cÚfigu»
,

57 .
	g£nd_·ck‘
 = 
_3c509b_£nd_·ck‘_dœeù_pio
,

58 .
	g»ûive_·ck‘
 = 
_3c509b_»ûive_·ck‘
,

59 .
	gcheck_š‹¼u±
 = 
_3c509b_check_š‹¼u±
,

60 .
	ghªdË_š‹¼u±
 = 
_3c509b_hªdË_š‹¼u±
,

61 .
	g’abË_š‹¼u±s
 = 
_3c509b_’abË_š‹¼u±s
,

62 .
	gdi§bË_š‹¼u±s
 = 
_3c509b_di§bË_š‹¼u±s
,

63 .
	gg‘_lšk_¡©us
 = 
_3c509b_g‘_lšk_¡©us
,

64 .
	gg‘_lšk_¥“d
 = 
_3c509b_g‘_lšk_¥“d
,

65 .
	g£t_´omiscuous
 = 
_3c509b_£t_´omiscuous
,

66 .
	g£t_muÉiÿ¡
 = 
_3c509b_£t_muÉiÿ¡
,

67 .
	g£lf_‹¡
 = 
_3c509b_£lf_‹¡


71 
ušt16_t
 
_3c509b_»ad_»g
(
nic_šfo_t
 *
nic
, ušt16_ˆ
»g
);

72 
_3c509b_wr™e_»g
(
nic_šfo_t
 *
nic
, 
ušt16_t
 
»g
, ušt16_ˆ
v®ue
);

73 
_3c509b_wr™e_commªd
(
nic_šfo_t
 *
nic
, 
ušt16_t
 
commªd
);

74 
_3c509b_wa™_fÜ_commªd
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
);

77 
nic_İs_t
* 
	$g‘_3c509b_İs
() {

78  &
_3c509b_İs
;

79 
	}
}

82 
	$_3c509b_š™
(
nic_šfo_t
 *
nic
) {

83 ià(!
nic
) {

84  
ERROR_INVALID_PARAM
;

87 
	`LOG_DEBUG
("In™Ÿlizšg 3C509B‡ˆI/O 0x%X", 
nic
->
io_ba£
);

90 
»suÉ
 = 
	`_3c509b_»£t
(
nic
);

91 ià(
»suÉ
 !ğ
SUCCESS
) {

92 
	`LOG_ERROR
("3C509B„e£ˆçed: %d", 
»suÉ
);

93  
»suÉ
;

97 
»suÉ
 = 
	`_3c509b_»ad_mac_äom_“´om
(
nic
,‚ic->
mac
);

98 ià(
»suÉ
 !ğ
SUCCESS
) {

99 
	`LOG_ERROR
("FaedØ»ad MAC‡dd»s äom EEPROM: %d", 
»suÉ
);

100  
»suÉ
;

104 
	`memıy
(
nic
->
³rm_mac
,‚ic->
mac
, 
ETH_ALEN
);

107 
»suÉ
 = 
	`_3c509b_£tup_medŸ
(
nic
);

108 ià(
»suÉ
 !ğ
SUCCESS
) {

109 
	`LOG_ERROR
("FaedØ£tu°medŸ: %d", 
»suÉ
);

110  
»suÉ
;

114 
»suÉ
 = 
	`_3c509b_£tup_rx_f‹r
(
nic
);

115 ià(
»suÉ
 !ğ
SUCCESS
) {

116 
	`LOG_ERROR
("FaedØ£tu°RX f‹r: %d", 
»suÉ
);

117  
»suÉ
;

121 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

124 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_SET_INTR_ENB
 |

125 (
_3C509B_IMASK_TX_COMPLETE
 | 
_3C509B_IMASK_RX_COMPLETE
 | 
_3C509B_IMASK_ADAPTER_FAILURE
));

128 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_ENABLE
);

129 
»suÉ
 = 
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 1000);

130 ià(
»suÉ
 !ğ
SUCCESS
) {

131 
	`LOG_ERROR
("RXƒnable commandimeout");

132  
»suÉ
;

135 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_TX_ENABLE
);

136 
»suÉ
 = 
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 1000);

137 ià(
»suÉ
 !ğ
SUCCESS
) {

138 
	`LOG_ERROR
("TXƒnable commandimeout");

139  
»suÉ
;

144 
nic
->
lšk_up
 = 
	`_3c509b_g‘_lšk_¡©us
(nic);

145 
nic
->
¥“d
 = 
	`_3c509b_g‘_lšk_¥“d
(nic);

148 
	`dœeù_pio_š™_ıu_d‘eùiÚ
();

149 
	`LOG_DEBUG
("CPU-optimized PIO initialized:†evel %d, 32-bit support: %s",

150 
	`dœeù_pio_g‘_İtimiz©iÚ_Ëv–
(),

151 
	`dœeù_pio_g‘_ıu_suµÜt_šfo
() ? "Yes" : "No");

154 
»suÉ
 = 
	`hw_checksum_š™
();

155 ià(
»suÉ
 !ğ
SUCCESS
) {

156 
	`LOG_WARNING
("H¬dw¬checksum in™Ÿliz©iÚ faed: %d, cÚtšušg w™houˆİtimiz©iÚ", 
»suÉ
);

159 
	`LOG_DEBUG
("Hardware checksum module initialized with CPU optimization");

162 
	`LOG_INFO
("3C509B initialized successfully,†ink %s, speed %d Mbps",

163 
nic
->
lšk_up
 ? "UP" : "DOWN",‚ic->
¥“d
);

165  
SUCCESS
;

166 
	}
}

168 
	$_3c509b_ş—nup
(
nic_šfo_t
 *
nic
) {

169 ià(!
nic
) {

170  
ERROR_INVALID_PARAM
;

173 
	`LOG_DEBUG
("CËªšg u°3C509B‡ˆI/O 0x%X", 
nic
->
io_ba£
);

176 
	`_3c509b_di§bË_š‹¼u±s
(
nic
);

179 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_DISABLE
);

180 
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 500);

182 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_TX_DISABLE
);

183 
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 500);

186 
	`medŸ_cÚŒŞ_ş—nup
(
nic
);

188  
SUCCESS
;

189 
	}
}

191 
	$_3c509b_»£t
(
nic_šfo_t
 *
nic
) {

192 ià(!
nic
) {

193  
ERROR_INVALID_PARAM
;

196 
	`LOG_DEBUG
("Re£‰šg 3C509B‡ˆI/O 0x%X", 
nic
->
io_ba£
);

199 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_TOTAL_RESET
);

202 
	`md–ay
(1);

205  
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 5000);

206 
	}
}

208 
	$_3c509b_cÚfigu»
(
nic_šfo_t
 *
nic
, cÚ¡ *
cÚfig
) {

209 ià(!
nic
) {

210  
ERROR_INVALID_PARAM
;

214 
	`LOG_DEBUG
("Configuring 3C509B");

217 
nic
->
¥“d
 = 10;

218 
nic
->
fuÎ_du¶ex
 = 
çl£
;

219 
nic
->
mtu
 = 
_3C509B_MAX_MTU
;

221  
SUCCESS
;

222 
	}
}

224 
	$_3c509b_£nd_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
) {

225 ià(!
nic
 || !
·ck‘
 || 
Ëngth
 == 0) {

226  
ERROR_INVALID_PARAM
;

229 ià(
Ëngth
 > 
nic
->
mtu
) {

230 
	`LOG_ERROR
("Pack‘oØÏrge: %zu > %d", 
Ëngth
, 
nic
->
mtu
);

231  
ERROR_INVALID_PARAM
;

235 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

238 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

239 ià(!(
¡©us
 & 
_3C509B_STATUS_TX_AVAILABLE
)) {

240 
	`LOG_DEBUG
("TX‚Ù‡vaabË, stus=0x%X", 
¡©us
);

241  
ERROR_BUSY
;

245 
ušt16_t
 
tx_ä“
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_TX_FREE
);

246 ià(
tx_ä“
 < (
ušt16_t
)
Ëngth
) {

247 
	`LOG_DEBUG
("Insuffic›Á TX FIFO s·û:‚“d %zu, hav%d", 
Ëngth
, 
tx_ä“
);

248  
ERROR_BUSY
;

252 
ušt16_t
 
tx_fifo
 = 
nic
->
io_ba£
 + 
_3C509B_TX_FIFO
;

253 
	`outw
(
tx_fifo
, (
ušt16_t
)
Ëngth
);

256 
size_t
 
wÜds
 = 
Ëngth
 / 2;

257 cÚ¡ 
ušt16_t
 *
·ck‘_wÜds
 = (cÚ¡ ušt16_t*)
·ck‘
;

259 
size_t
 
i
 = 0; i < 
wÜds
; i++) {

260 
	`outw
(
tx_fifo
, 
·ck‘_wÜds
[
i
]);

264 ià(
Ëngth
 & 1) {

265 
	`outb
(
tx_fifo
, 
·ck‘
[
Ëngth
 - 1]);

269 
nic
->
tx_·ck‘s
++;

270 
nic
->
tx_by‹s
 +ğ
Ëngth
;

272 
	`LOG_TRACE
("S’ˆ·ck‘ oà%zu by‹s", 
Ëngth
);

274  
SUCCESS
;

275 
	}
}

277 
	$_3c509b_»ûive_·ck‘
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ëngth
) {

278 ià(!
nic
 || !
bufãr
 || !
Ëngth
) {

279  
ERROR_INVALID_PARAM
;

283 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

286 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

287 ià(!(
¡©us
 & 
_3C509B_STATUS_RX_COMPLETE
)) {

288 *
Ëngth
 = 0;

289  
ERROR_NO_DATA
;

293 
ušt16_t
 
rx_¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_RX_STATUS
);

294 
ušt16_t
 
·ck‘_Ëngth
 = 
rx_¡©us
 & 
_3C509B_RXSTAT_LEN_MASK
;

297 ià(
rx_¡©us
 & (
_3C509B_RXSTAT_ERROR
 | 
_3C509B_RXSTAT_INCOMPLETE
)) {

298 
	`LOG_DEBUG
("RXƒ¼Ü: stus=0x%X", 
rx_¡©us
);

301 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_DISCARD
);

303 
nic
->
rx_”rÜs
++;

304 *
Ëngth
 = 0;

305  
ERROR_IO
;

309 ià(
·ck‘_Ëngth
 > *
Ëngth
) {

310 
	`LOG_WARNING
("RX bufã¸toØsm®l:‚“d %d, hav%zu", 
·ck‘_Ëngth
, *
Ëngth
);

313 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_DISCARD
);

315 *
Ëngth
 = 
·ck‘_Ëngth
;

316  
ERROR_NO_MEMORY
;

320 
ušt16_t
 
rx_fifo
 = 
nic
->
io_ba£
 + 
_3C509B_RX_FIFO
;

323 
size_t
 
wÜds
 = 
·ck‘_Ëngth
 / 2;

324 
ušt16_t
 *
bufãr_wÜds
 = (ušt16_t*)
bufãr
;

326 
size_t
 
i
 = 0; i < 
wÜds
; i++) {

327 
bufãr_wÜds
[
i
] = 
	`šw
(
rx_fifo
);

331 ià(
·ck‘_Ëngth
 & 1) {

332 
bufãr
[
·ck‘_Ëngth
 - 1] = 
	`šb
(
rx_fifo
);

336 
nic
->
rx_·ck‘s
++;

337 
nic
->
rx_by‹s
 +ğ
·ck‘_Ëngth
;

339 *
Ëngth
 = 
·ck‘_Ëngth
;

341 
	`LOG_TRACE
("Reûived…ack‘ oà%d by‹s", 
·ck‘_Ëngth
);

343  
SUCCESS
;

344 
	}
}

349 
	$_3c509b_»ûive_·ck‘_bufã»d
(
nic_šfo_t
 *
nic
) {

350 
bufãr_desc_t
 *
rx_bufãr
 = 
NULL
;

351 
ušt16_t
 
¡©us
, 
rx_¡©us
, 
·ck‘_Ëngth
;

352 
ušt16_t
 
rx_fifo
;

353 
size_t
 
wÜds
;

354 
»suÉ
 = 
SUCCESS
;

356 ià(!
nic
) {

357  
ERROR_INVALID_PARAM
;

361 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

364 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

365 ià(!(
¡©us
 & 
_3C509B_STATUS_RX_COMPLETE
)) {

366  
ERROR_NO_DATA
;

370 
rx_¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_RX_STATUS
);

371 
·ck‘_Ëngth
 = 
rx_¡©us
 & 
_3C509B_RXSTAT_LEN_MASK
;

374 ià(
rx_¡©us
 & (
_3C509B_RXSTAT_ERROR
 | 
_3C509B_RXSTAT_INCOMPLETE
)) {

375 
	`LOG_DEBUG
("RXƒ¼Ü: stus=0x%X", 
rx_¡©us
);

378 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_DISCARD
);

380 
nic
->
rx_”rÜs
++;

381  
ERROR_IO
;

385 
rx_bufãr
 = 
	`rx_cİyb»ak_®loc
(
·ck‘_Ëngth
);

386 ià(!
rx_bufãr
) {

387 
	`LOG_ERROR
("FaedØ®loÿ‹ RX bufã¸fÜ %d by‹…ack‘", 
·ck‘_Ëngth
);

390 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_DISCARD
);

392 
nic
->
rx_drİ³d
++;

393  
ERROR_NO_MEMORY
;

397 
rx_fifo
 = 
nic
->
io_ba£
 + 
_3C509B_RX_FIFO
;

400 
wÜds
 = 
·ck‘_Ëngth
 / 2;

401 
ušt16_t
 *
bufãr_wÜds
 = (ušt16_t*)
rx_bufãr
->
d©a
;

403 
size_t
 
i
 = 0; i < 
wÜds
; i++) {

404 
bufãr_wÜds
[
i
] = 
	`šw
(
rx_fifo
);

408 ià(
·ck‘_Ëngth
 & 1) {

409 ((
ušt8_t
*)
rx_bufãr
->
d©a
)[
·ck‘_Ëngth
 - 1] = 
	`šb
(
rx_fifo
);

413 
rx_bufãr
->
u£d
 = 
·ck‘_Ëngth
;

414 
	`bufãr_£t_¡©e
(
rx_bufãr
, 
BUFFER_STATE_IN_USE
);

417 ià(
·ck‘_Ëngth
 >= 34) {

418 
checksum_»suÉ
 = 
	`hw_checksum_v”ify_šbound_·ck‘
((
ušt8_t
*)
rx_bufãr
->
d©a
, 
·ck‘_Ëngth
);

419 ià(
checksum_»suÉ
 < 0) {

420 
	`LOG_DEBUG
("Checksum verification failed for inbound…acket");

422 } ià(
checksum_»suÉ
 > 0) {

423 
	`LOG_DEBUG
("Checksum verification…assed for inbound…acket");

428 
»suÉ
 = 
	`·ck‘_´oûss_»ûived
((
ušt8_t
*)
rx_bufãr
->
d©a
, 
·ck‘_Ëngth
, 
nic
->
šdex
);

429 ià(
»suÉ
 !ğ
SUCCESS
) {

430 
	`LOG_WARNING
("Pack‘…roûssšg faed: %d", 
»suÉ
);

431 
nic
->
rx_drİ³d
++;

434 
nic
->
rx_·ck‘s
++;

435 
nic
->
rx_by‹s
 +ğ
·ck‘_Ëngth
;

437 
	`LOG_TRACE
("Proûs£d„eûived…ack‘ oà%d by‹s", 
·ck‘_Ëngth
);

441 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

443  
»suÉ
;

444 
	}
}

446 
boŞ
 
	$_3c509b_check_š‹¼u±
(
nic_šfo_t
 *
nic
) {

447 ià(!
nic
) {

448  
çl£
;

452 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

455  (
¡©us
 & 
_3C509B_STATUS_INT_LATCH
) != 0;

456 
	}
}

458 
	$_3c509b_hªdË_š‹¼u±
(
nic_šfo_t
 *
nic
) {

459 ià(!
nic
) {

464 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

466 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

468 
	`LOG_TRACE
("3C509B iÁ”ru±: stus=0x%X", 
¡©us
);

471 ià(
¡©us
 & 
_3C509B_STATUS_TX_COMPLETE
) {

473 
	`LOG_TRACE
("TX complete");

476 
ušt16_t
 
tx_¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_TX_STATUS
);

479 ià(
tx_¡©us
 & (
_3C509B_TXSTAT_JABBER
 | 
_3C509B_TXSTAT_UNDERRUN
 | 
_3C509B_TXSTAT_MAXCOLL
)) {

480 
	`LOG_DEBUG
("TXƒ¼Ü: stus=0x%X", 
tx_¡©us
);

481 
nic
->
tx_”rÜs
++;

486 ià(
¡©us
 & 
_3C509B_STATUS_RX_COMPLETE
) {

487 
	`LOG_TRACE
("RX complete -…rocessing buffered");

490 
rx_»suÉ
 = 
	`_3c509b_»ûive_·ck‘_bufã»d
(
nic
);

491 ià(
rx_»suÉ
 !ğ
SUCCESS
 &&„x_»suÉ !ğ
ERROR_NO_DATA
) {

492 
	`LOG_DEBUG
("RX…roûssšg faed: %d", 
rx_»suÉ
);

497 ià(
¡©us
 & 
_3C509B_STATUS_ADAPTER_FAILURE
) {

498 
	`LOG_ERROR
("3C509B‡dapter failure detected");

501 
nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

505 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_ACK_INTR
 | (
¡©us
 & 0x00FF));

506 
	}
}

514 
	$_3c509b_´oûss_sšgË_ev’t
(
nic_šfo_t
 *
nic
, 
š‹¼u±_ev’t_ty³_t
 *
ev’t_ty³
) {

515 ià(!
nic
 || !
ev’t_ty³
) {

516  
ERROR_INVALID_PARAM
;

520 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

522 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

527 ià(
¡©us
 & 
_3C509B_STATUS_ADAPTER_FAILURE
) {

528 *
ev’t_ty³
 = 
EVENT_TYPE_RX_ERROR
;

529 
	`LOG_ERROR
("3C509B‡dapter failure detected");

531 
nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

534 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_ACK_INTR
 | 
_3C509B_STATUS_ADAPTER_FAILURE
);

540 ià(
¡©us
 & 
_3C509B_STATUS_TX_COMPLETE
) {

541 *
ev’t_ty³
 = 
EVENT_TYPE_TX_COMPLETE
;

544 
ušt16_t
 
tx_¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_TX_STATUS
);

546 ià(
tx_¡©us
 & (
_3C509B_TXSTAT_JABBER
 | 
_3C509B_TXSTAT_UNDERRUN
 | 
_3C509B_TXSTAT_MAXCOLL
)) {

547 
	`LOG_DEBUG
("TXƒ¼Ü: stus=0x%X", 
tx_¡©us
);

548 
nic
->
tx_”rÜs
++;

549 *
ev’t_ty³
 = 
EVENT_TYPE_TX_ERROR
;

553 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_ACK_INTR
 | 
_3C509B_STATUS_TX_COMPLETE
);

559 ià(
¡©us
 & 
_3C509B_STATUS_RX_COMPLETE
) {

560 *
ev’t_ty³
 = 
EVENT_TYPE_RX_COMPLETE
;

563 
rx_»suÉ
 = 
	`_3c509b_»ûive_·ck‘_bufã»d
(
nic
);

564 ià(
rx_»suÉ
 !ğ
SUCCESS
 &&„x_»suÉ !ğ
ERROR_NO_DATA
) {

565 
	`LOG_DEBUG
("RX…roûssšg faed: %d", 
rx_»suÉ
);

566 *
ev’t_ty³
 = 
EVENT_TYPE_RX_ERROR
;

570 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_ACK_INTR
 | 
_3C509B_STATUS_RX_COMPLETE
);

577 
	}
}

584 
	$_3c509b_check_š‹¼u±_b©ched
(
nic_šfo_t
 *
nic
) {

585 ià(!
nic
) {

586  
ERROR_INVALID_PARAM
;

590 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

592 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

595 ià(
¡©us
 & (
_3C509B_STATUS_TX_COMPLETE
 |

596 
_3C509B_STATUS_RX_COMPLETE
 |

597 
_3C509B_STATUS_ADAPTER_FAILURE
)) {

602 
	}
}

609 
	$_3c509b_hªdË_š‹¼u±_b©ched
(
nic_šfo_t
 *
nic
) {

610 
š‹¼u±_m™ig©iÚ_cÚ‹xt_t
 *
im_ùx
;

612 ià(!
nic
 || !nic->
´iv©e_d©a
) {

613  
ERROR_INVALID_PARAM
;

619 
im_ùx
 = (
š‹¼u±_m™ig©iÚ_cÚ‹xt_t
 *)
nic
->
´iv©e_d©a
;

621 ià(!
	`is_š‹¼u±_m™ig©iÚ_’abËd
(
im_ùx
)) {

623 
	`_3c509b_hªdË_š‹¼u±
(
nic
);

628  
	`´oûss_b©ched_š‹¼u±s_3c509b
(
im_ùx
);

629 
	}
}

631 
	$_3c509b_’abË_š‹¼u±s
(
nic_šfo_t
 *
nic
) {

632 ià(!
nic
) {

633  
ERROR_INVALID_PARAM
;

637 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

638 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_SET_INTR_ENB
 |

639 (
_3C509B_IMASK_TX_COMPLETE
 | 
_3C509B_IMASK_RX_COMPLETE
 | 
_3C509B_IMASK_ADAPTER_FAILURE
));

641  
SUCCESS
;

642 
	}
}

644 
	$_3c509b_di§bË_š‹¼u±s
(
nic_šfo_t
 *
nic
) {

645 ià(!
nic
) {

646  
ERROR_INVALID_PARAM
;

650 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

651 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_SET_INTR_ENB
 | 0);

653  
SUCCESS
;

654 
	}
}

656 
boŞ
 
	$_3c509b_g‘_lšk_¡©us
(
nic_šfo_t
 *
nic
) {

657 ià(!
nic
) {

658  
çl£
;

662 
lšk_¡©us
 = 
	`check_medŸ_lšk_¡©us
(
nic
);

663 ià(
lšk_¡©us
 < 0) {

664 
	`LOG_DEBUG
("Link status check failed, falling backo basic detection");

667 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_4
);

668 
ušt16_t
 
medŸ_¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_W4_NETDIAG
);

671  (
medŸ_¡©us
 & 0x0800) != 0;

674  
lšk_¡©us
 ? 
Œue
 : 
çl£
;

675 
	}
}

677 
	$_3c509b_g‘_lšk_¥“d
(
nic_šfo_t
 *
nic
) {

678 ià(!
nic
) {

684 
	}
}

686 
	$_3c509b_£t_´omiscuous
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË
) {

687 ià(!
nic
) {

688  
ERROR_INVALID_PARAM
;

692 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

694 
ušt16_t
 
f‹r
 = 
_3C509B_RX_FILTER_STATION
 | 
_3C509B_RX_FILTER_BROADCAST
;

695 ià(
’abË
) {

696 
f‹r
 |ğ
_3C509B_RX_FILTER_PROM
;

699 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_SET_RX_FILTER
 | 
f‹r
);

701 
	`LOG_DEBUG
("3C509B…romiscuou mod%s", 
’abË
 ? "enabled" : "disabled");

703  
SUCCESS
;

704 
	}
}

706 
	$_3c509b_£t_muÉiÿ¡
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
mc_li¡
, 
couÁ
) {

707 ià(!
nic
) {

708  
ERROR_INVALID_PARAM
;

712 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

714 
ušt16_t
 
f‹r
 = 
_3C509B_RX_FILTER_STATION
 | 
_3C509B_RX_FILTER_BROADCAST
;

715 ià(
couÁ
 > 0) {

716 
f‹r
 |ğ
_3C509B_RX_FILTER_MULTICAST
;

719 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_SET_RX_FILTER
 | 
f‹r
);

721 
	`LOG_DEBUG
("3C509B muÉiÿ¡ f‹¸upd©ed w™h %d‡dd»s£s", 
couÁ
);

723  
SUCCESS
;

724 
	}
}

726 
	$_3c509b_£lf_‹¡
(
nic_šfo_t
 *
nic
) {

727 ià(!
nic
) {

728  
ERROR_INVALID_PARAM
;

731 
	`LOG_DEBUG
("Running 3C509B self-test");

736 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_0
);

738 
ušt16_t
 
Üigš®_v®ue
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_W0_CONFIG_CTRL
);

739 
	`_3c509b_wr™e_»g
(
nic
, 
_3C509B_W0_CONFIG_CTRL
, 0x5AA5);

740 
ušt16_t
 
‹¡_v®ue
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_W0_CONFIG_CTRL
);

741 
	`_3c509b_wr™e_»g
(
nic
, 
_3C509B_W0_CONFIG_CTRL
, 
Üigš®_v®ue
);

743 ià(
‹¡_v®ue
 != 0x5AA5) {

744 
	`LOG_ERROR
("3C509B„egi¡”e¡ faed: wrÙ0x5AA5,„—d 0x%X", 
‹¡_v®ue
);

745  
ERROR_HARDWARE
;

748 
	`LOG_INFO
("3C509B self-test…assed");

750  
SUCCESS
;

751 
	}
}

754 
ušt16_t
 
	$_3c509b_»ad_»g
(
nic_šfo_t
 *
nic
, 
ušt16_t
 
»g
) {

755  
	`šw
(
nic
->
io_ba£
 + 
»g
);

756 
	}
}

758 
	$_3c509b_wr™e_»g
(
nic_šfo_t
 *
nic
, 
ušt16_t
 
»g
, ušt16_ˆ
v®ue
) {

759 
	`outw
(
nic
->
io_ba£
 + 
»g
, 
v®ue
);

760 
	}
}

762 
	$_3c509b_wa™_fÜ_commªd
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
) {

763 
timeout_ms
 > 0) {

764 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

766 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

767  
SUCCESS
;

770 
	`ud–ay
(1000);

771 
timeout_ms
--;

774 
	`LOG_ERROR
("3C509B commandimeout");

775  
ERROR_TIMEOUT
;

776 
	}
}

783 
	$_3c509b_£Ëù_wšdow
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
wšdow
) {

785 
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 100);

788 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_SELECT_WINDOW
 | 
wšdow
);

789 
	}
}

794 
	$_3c509b_wa™_fÜ_cmd_busy
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
) {

795 
timeout_ms
 > 0) {

796 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C509B_STATUS_REG
);

797 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

798  
SUCCESS
;

800 
	`ud–ay
(1000);

801 
timeout_ms
--;

803  
ERROR_TIMEOUT
;

804 
	}
}

809 
	$_3c509b_wr™e_commªd
(
nic_šfo_t
 *
nic
, 
ušt16_t
 
commªd
) {

811 
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 100);

814 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
commªd
);

815 
	}
}

820 
ušt16_t
 
	$_3c509b_»ad_“´om
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
add»ss
) {

822 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_0
);

825 
	`_3c509b_wr™e_»g
(
nic
, 
_3C509B_EEPROM_CMD
, 
_3C509B_EEPROM_READ
 | 
add»ss
);

828 
	`ud–ay
(
_3C509B_EEPROM_READ_DELAY
);

831  
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_EEPROM_DATA
);

832 
	}
}

837 
	$_3c509b_wr™e_“´om
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
add»ss
, 
ušt16_t
 
d©a
) {

839 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_0
);

842 
	`_3c509b_wr™e_»g
(
nic
, 
_3C509B_EEPROM_DATA
, 
d©a
);

845 
	`_3c509b_wr™e_»g
(
nic
, 
_3C509B_EEPROM_CMD
, 
_3C509B_EEPROM_WRITE
 | 
add»ss
);

848 
	`ud–ay
(
_3C509B_EEPROM_READ_DELAY
 * 10);

849 
	}
}

854 
	$_3c509b_»ad_mac_äom_“´om
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
mac
) {

855 ià(!
nic
 || !
mac
) {

856  
ERROR_INVALID_PARAM
;

860 
i
 = 0; i < 3; i++) {

861 
ušt16_t
 
wÜd
 = 
	`_3c509b_»ad_“´om
(
nic
, 
i
);

862 
mac
[
i
 * 2] = 
wÜd
 & 0xFF;

863 
mac
[
i
 * 2 + 1] = (
wÜd
 >> 8) & 0xFF;

866 
	`LOG_INFO
("3C509B MAC‡ddress: %02X:%02X:%02X:%02X:%02X:%02X",

867 
mac
[0], mac[1], mac[2], mac[3], mac[4], mac[5]);

869  
SUCCESS
;

870 
	}
}

875 
	$_3c509b_£tup_medŸ
(
nic_šfo_t
 *
nic
) {

876 ià(!
nic
) {

877  
ERROR_INVALID_PARAM
;

880 
	`LOG_DEBUG
("Setting up media for 3C509B usingƒnhanced media control");

883 
»suÉ
 = 
	`medŸ_cÚŒŞ_š™
(
nic
);

884 ià(
»suÉ
 !ğ
SUCCESS
) {

885 
	`LOG_ERROR
("FaedØš™ŸlizmedŸ cÚŒŞ: %d", 
»suÉ
);

886  
»suÉ
;

890 
	`NIC_INFO_INIT_DEFAULTS
(
nic
);

893 
nic
->
medŸ_ÿ·b™›s
 = 
MEDIA_CAPS_3C509B_COMBO
;

894 
nic
->
v¬ŸÁ_id
 = 
VARIANT_3C509B_COMBO
;

897 ià(
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_AUTO_SELECT
) {

898 
	`LOG_INFO
("Attempting‡uto-detection for combo card");

900 
medŸ_d‘eù_cÚfig_t
 
d‘eù_cÚfig
 = 
MEDIA_DETECT_CONFIG_DEFAULT
;

901 
medŸ_ty³_t
 
d‘eùed
 = 
	`auto_d‘eù_medŸ
(
nic
, &
d‘eù_cÚfig
);

903 ià(
d‘eùed
 !ğ
MEDIA_TYPE_UNKNOWN
) {

904 
	`LOG_INFO
("Auto-d‘eùed medŸ: %s", 
	`medŸ_ty³_to_¡ršg
(
d‘eùed
));

905 
nic
->
cu¼’t_medŸ
 = 
d‘eùed
;

906 
nic
->
medŸ_cÚfig_sourû
 = 
MEDIA_CONFIG_AUTO_DETECT
;

908 
	`LOG_WARNING
("Auto-detection failed, using default media");

909 
nic
->
cu¼’t_medŸ
 = 
MEDIA_TYPE_10BASE_T
;

910 
nic
->
medŸ_cÚfig_sourû
 = 
MEDIA_CONFIG_DEFAULT
;

914 
nic
->
cu¼’t_medŸ
 = 
	`g‘_deçuÉ_medŸ_fÜ_nic
(nic);

915 
nic
->
medŸ_cÚfig_sourû
 = 
MEDIA_CONFIG_DEFAULT
;

916 
	`LOG_INFO
("Usšg deçuÉ medŸ: %s", 
	`medŸ_ty³_to_¡ršg
(
nic
->
cu¼’t_medŸ
));

920 ià(
nic
->
cu¼’t_medŸ
 !ğ
MEDIA_TYPE_UNKNOWN
) {

921 
»suÉ
 = 
	`£Ëù_medŸ_Œªsûiv”
(
nic
,‚ic->
cu¼’t_medŸ
, 0);

922 ià(
»suÉ
 !ğ
SUCCESS
) {

923 
	`LOG_ERROR
("Failedo configure media %s: %d",

924 
	`medŸ_ty³_to_¡ršg
(
nic
->
cu¼’t_medŸ
), 
»suÉ
);

927 ià(
nic
->
cu¼’t_medŸ
 !ğ
MEDIA_TYPE_10BASE_T
 &&

928 
	`is_medŸ_suµÜ‹d_by_nic
(
nic
, 
MEDIA_TYPE_10BASE_T
)) {

929 
	`LOG_INFO
("Falling backo 10BaseT");

930 
»suÉ
 = 
	`£Ëù_medŸ_Œªsûiv”
(
nic
, 
MEDIA_TYPE_10BASE_T
,

931 
MEDIA_CTRL_FLAG_FORCE
);

932 ià(
»suÉ
 =ğ
SUCCESS
) {

933 
nic
->
cu¼’t_medŸ
 = 
MEDIA_TYPE_10BASE_T
;

934 
nic
->
medŸ_cÚfig_sourû
 = 
MEDIA_CONFIG_DRIVER_FORCED
;

940 ià(
»suÉ
 !ğ
SUCCESS
) {

941 
	`LOG_ERROR
("Media setup failed completely");

942  
»suÉ
;

946 
lšk_‹¡_»suÉ_t
 
‹¡_»suÉ
;

947 
»suÉ
 = 
	`‹¡_lšk_b—t
(
nic
,‚ic->
cu¼’t_medŸ
, 2000, &
‹¡_»suÉ
);

948 ià(
»suÉ
 =ğ
SUCCESS
) {

949 
	`LOG_INFO
("MedŸ†ške¡…as£d: qu®™y=%d%%", 
‹¡_»suÉ
.
sigÇl_qu®™y
);

950 
nic
->
medŸ_d‘eùiÚ_¡©e
 |ğ
MEDIA_DETECT_COMPLETED
;

952 
	`LOG_WARNING
("Media†inkest failed, but continuing");

953 
nic
->
medŸ_d‘eùiÚ_¡©e
 |ğ
MEDIA_DETECT_FAILED
;

956 
	`LOG_INFO
("3C509B medŸ s‘u°com¶‘e: %s", 
	`medŸ_ty³_to_¡ršg
(
nic
->
cu¼’t_medŸ
));

957  
SUCCESS
;

958 
	}
}

963 
	$_3c509b_£tup_rx_f‹r
(
nic_šfo_t
 *
nic
) {

964 ià(!
nic
) {

965  
ERROR_INVALID_PARAM
;

969 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

972 
ušt16_t
 
f‹r
 = 
_3C509B_RX_FILTER_STATION
 | 
_3C509B_RX_FILTER_BROADCAST
;

973 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_SET_RX_FILTER
 | 
f‹r
);

976 
	`_3c509b_wa™_fÜ_cmd_busy
(
nic
, 1000);

979 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_2
);

982 
i
 = 0; i < 
ETH_ALEN
; i++) {

983 
	`_3c509b_wr™e_»g
(
nic
, 
i
,‚ic->
mac
[i]);

986 
	`LOG_DEBUG
("3C509B RX filter‡nd station‡ddress configured");

988  
SUCCESS
;

989 
	}
}

997 
dœeù_pio_outsw
(cÚ¡ * 
¤c_bufãr
, 
ušt16_t
 
d¡_pÜt
, ušt16_ˆ
wÜd_couÁ
);

998 
£nd_·ck‘_dœeù_pio_asm
(cÚ¡ * 
¡ack_bufãr
, 
ušt16_t
 
Ëngth
, ušt16_ˆ
io_ba£
);

999 
dœeù_pio_h—d”_ªd_·ylßd
(
ušt16_t
 
io_pÜt
, cÚ¡ 
ušt8_t
* 
de¡_mac
,

1000 cÚ¡ 
ušt8_t
* 
¤c_mac
, 
ušt16_t
 
‘h”ty³
,

1001 cÚ¡ * 
·ylßd
, 
ušt16_t
 
·ylßd_Ën
);

1010 
	$£nd_·ck‘_dœeù_pio
(cÚ¡ * 
¡ack_bufãr
, 
ušt16_t
 
Ëngth
, ušt16_ˆ
io_ba£
) {

1011 
ušt16_t
 
tx_fifo
;

1013 ià(!
¡ack_bufãr
 || 
Ëngth
 =ğ0 ||†’gth > 
_3C509B_MAX_MTU
) {

1014 
	`LOG_ERROR
("Invalid…arameters for direct PIO send");

1015  
ERROR_INVALID_PARAM
;

1019 
tx_fifo
 = 
io_ba£
 + 
_3C509B_TX_FIFO
;

1022 
	`outw
(
tx_fifo
, 
Ëngth
);

1025 ià(
	`should_u£_’hªûd_pio
(
Ëngth
)) {

1027  
	`£nd_·ck‘_dœeù_pio_’hªûd
(
¡ack_bufãr
, 
Ëngth
, 
io_ba£
);

1028 } ià(
Ëngth
 >= 32) {

1030  
	`£nd_·ck‘_dœeù_pio_asm
(
¡ack_bufãr
, 
Ëngth
, 
io_ba£
);

1033 
size_t
 
wÜds
 = 
Ëngth
 / 2;

1034 cÚ¡ 
ušt16_t
 *
·ck‘_wÜds
 = (cÚ¡ ušt16_t*)
¡ack_bufãr
;

1036 
size_t
 
i
 = 0; i < 
wÜds
; i++) {

1037 
	`outw
(
tx_fifo
, 
·ck‘_wÜds
[
i
]);

1041 ià(
Ëngth
 & 1) {

1042 cÚ¡ 
ušt8_t
 *
·ck‘_by‹s
 = (cÚ¡ ušt8_t*)
¡ack_bufãr
;

1043 
	`outb
(
tx_fifo
, 
·ck‘_by‹s
[
Ëngth
 - 1]);

1046  
SUCCESS
;

1048 
	}
}

1059 
	$£nd_·ck‘_dœeù_pio_w™h_h—d”
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
de¡_mac
,

1060 
ušt16_t
 
‘h”ty³
, cÚ¡ * 
·ylßd
, ušt16_ˆ
·ylßd_Ën
) {

1061 
ušt16_t
 
tÙ®_Ëngth
, 
tx_fifo
;

1063 ià(!
nic
 || !
de¡_mac
 || !
·ylßd
 || 
·ylßd_Ën
 == 0) {

1064  
ERROR_INVALID_PARAM
;

1068 
tÙ®_Ëngth
 = 
ETH_HEADER_LEN
 + 
·ylßd_Ën
;

1069 ià(
tÙ®_Ëngth
 > 
nic
->
mtu
) {

1070 
	`LOG_ERROR
("F¿mtoØÏrge: %d > %d", 
tÙ®_Ëngth
, 
nic
->
mtu
);

1071  
ERROR_INVALID_PARAM
;

1075 ià(
tÙ®_Ëngth
 < 
ETH_MIN_FRAME
) {

1076 
tÙ®_Ëngth
 = 
ETH_MIN_FRAME
;

1080 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

1083 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

1084 ià(!(
¡©us
 & 
_3C509B_STATUS_TX_AVAILABLE
)) {

1085 
	`LOG_DEBUG
("TX‚Ù‡vaabË, stus=0x%X", 
¡©us
);

1086  
ERROR_BUSY
;

1090 
ušt16_t
 
tx_ä“
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_TX_FREE
);

1091 ià(
tx_ä“
 < 
tÙ®_Ëngth
) {

1092 
	`LOG_DEBUG
("Insuffic›Á TX FIFO s·û:‚“d %d, hav%d", 
tÙ®_Ëngth
, 
tx_ä“
);

1093  
ERROR_BUSY
;

1097 
tx_fifo
 = 
nic
->
io_ba£
 + 
_3C509B_TX_FIFO
;

1100 
	`outw
(
tx_fifo
, 
tÙ®_Ëngth
);

1103 
	`dœeù_pio_h—d”_ªd_·ylßd
(
tx_fifo
, 
de¡_mac
, 
nic
->
mac
, 
‘h”ty³
, 
·ylßd
, 
·ylßd_Ën
);

1106 
ušt16_t
 
aùu®_Ëngth
 = 
ETH_HEADER_LEN
 + 
·ylßd_Ën
;

1107 ià(
aùu®_Ëngth
 < 
ETH_MIN_FRAME
) {

1108 
ušt16_t
 
·d_by‹s
 = 
ETH_MIN_FRAME
 - 
aùu®_Ëngth
;

1109 
ušt16_t
 
·d_wÜds
 = 
·d_by‹s
 / 2;

1112 
ušt16_t
 
i
 = 0; i < 
·d_wÜds
; i++) {

1113 
	`outw
(
tx_fifo
, 0);

1117 ià(
·d_by‹s
 & 1) {

1118 
	`outb
(
tx_fifo
, 0);

1123 
nic
->
tx_·ck‘s
++;

1124 
nic
->
tx_by‹s
 +ğ
tÙ®_Ëngth
;

1126 
	`LOG_TRACE
("S’ˆ·ck‘ oà%d by‹ vŸ dœeù PIO w™h h—d”", 
tÙ®_Ëngth
);

1128  
SUCCESS
;

1129 
	}
}

1138 
	$_3c509b_£nd_·ck‘_dœeù_pio
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
) {

1139 ià(!
nic
 || !
·ck‘
 || 
Ëngth
 == 0) {

1140  
ERROR_INVALID_PARAM
;

1143 ià(
Ëngth
 > 
nic
->
mtu
) {

1144 
	`LOG_ERROR
("Pack‘oØÏrge: %zu > %d", 
Ëngth
, 
nic
->
mtu
);

1145  
ERROR_INVALID_PARAM
;

1149 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

1152 
ušt16_t
 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

1153 ià(!(
¡©us
 & 
_3C509B_STATUS_TX_AVAILABLE
)) {

1154 
	`LOG_DEBUG
("TX‚Ù‡vaabË, stus=0x%X", 
¡©us
);

1155  
ERROR_BUSY
;

1159 
ušt16_t
 
tx_ä“
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_TX_FREE
);

1160 ià(
tx_ä“
 < (
ušt16_t
)
Ëngth
) {

1161 
	`LOG_DEBUG
("Insuffic›Á TX FIFO s·û:‚“d %zu, hav%d", 
Ëngth
, 
tx_ä“
);

1162  
ERROR_BUSY
;

1166 
ušt8_t
 *
tx_·ck‘
 = (ušt8_ˆ*)
·ck‘
;

1167 ià(
Ëngth
 >= 34) {

1168 
checksum_»suÉ
 = 
	`hw_checksum_´oûss_outbound_·ck‘
(
tx_·ck‘
, 
Ëngth
);

1169 ià(
checksum_»suÉ
 != 0) {

1170 
	`LOG_DEBUG
("Checksum calculation completed for outbound…acket");

1179 
»suÉ
 = 
	`£nd_·ck‘_dœeù_pio
(
·ck‘
, (
ušt16_t
)
Ëngth
, 
nic
->
io_ba£
);

1180 ià(
»suÉ
 !ğ
SUCCESS
) {

1181 
	`LOG_ERROR
("Dœeù PIO¿nsmissiÚ faed: %d", 
»suÉ
);

1182  
»suÉ
;

1186 
nic
->
tx_·ck‘s
++;

1187 
nic
->
tx_by‹s
 +ğ
Ëngth
;

1189 
	`LOG_TRACE
("S’ˆ·ck‘ oà%zu by‹ vŸ dœeù PIO", 
Ëngth
);

1191  
SUCCESS
;

1192 
	}
}

1204 
	$_3c509b_š™Ÿlize_ÿche_coh”’cy
(
nic_šfo_t
 *
nic
) {

1205 
coh”’cy_ª®ysis_t
 
ª®ysis
;

1206 
ch£t_d‘eùiÚ_»suÉ_t
 
ch£t_»suÉ
;

1208 ià(!
nic
) {

1209 
	`LOG_ERROR
("Invalid NIC…ointer for cache coherency initialization");

1210  
ERROR_INVALID_PARAM
;

1213 
	`LOG_INFO
("Initializing cache coherency management for 3C509B...");

1216 
ª®ysis
 = 
	`³rfÜm_com¶‘e_coh”’cy_ª®ysis
();

1218 ià(
ª®ysis
.
£Ëùed_t›r
 =ğ
TIER_DISABLE_BUS_MASTER
) {

1219 
	`LOG_WARNING
("Cache coherency‡nalysis„ecommends disabling bus mastering");

1220 
	`LOG_WARNING
("3C509B uses PIO-only operation -his is optimal forhis system");

1221 
nic
->
¡©us
 |ğ
NIC_STATUS_CACHE_COHERENCY_OK
;

1222  
SUCCESS
;

1226 
ch£t_»suÉ
 = 
	`d‘eù_sy¡em_ch£t
();

1229 
boŞ
 
ÿche_š™_»suÉ
 = 
	`š™Ÿlize_ÿche_mªagem’t
(
ª®ysis
.
£Ëùed_t›r
);

1230 ià(!
ÿche_š™_»suÉ
) {

1231 
	`LOG_ERROR
("Failedo initialize cache management system");

1232  
ERROR_HARDWARE
;

1236 
boŞ
 
»cÜd_»suÉ
 = 
	`»cÜd_ch£t_‹¡_»suÉ
(&
ª®ysis
, &
ch£t_»suÉ
);

1237 ià(!
»cÜd_»suÉ
) {

1238 
	`LOG_WARNING
("Failedo„ecordest„esults in chipset database");

1242 
nic
->
ÿche_coh”’cy_t›r
 = 
ª®ysis
.
£Ëùed_t›r
;

1243 
nic
->
ÿche_mªagem’t_avaabË
 = 
Œue
;

1244 
nic
->
¡©us
 |ğ
NIC_STATUS_CACHE_COHERENCY_OK
;

1246 
	`LOG_INFO
("Cache coherency initialized:ier %d, confidence %d%%",

1247 
ª®ysis
.
£Ëùed_t›r
,‡Çlysis.
cÚfid’û
);

1250 ià(
	`should_ofãr_³rfÜmªû_guidªû
(&
ª®ysis
)) {

1251 
	`di¥Ïy_³rfÜmªû_İpÜtun™y_ª®ysis
();

1254  
SUCCESS
;

1255 
	}
}

1262 
	$_3c509b_dma_´•¬e_bufãrs
(*
bufãr
, 
size_t
 
Ëngth
) {

1263 
dma_İ”©iÚ_t
 
İ”©iÚ
;

1265 ià(!
bufãr
 || 
Ëngth
 == 0) {

1270 
İ”©iÚ
.
bufãr
 = buffer;

1271 
İ”©iÚ
.
Ëngth
 =†ength;

1272 
İ”©iÚ
.
dœeùiÚ
 = 
DMA_DIRECTION_FROM_DEVICE
;

1273 
İ”©iÚ
.
deviû_ty³
 = 
DMA_DEVICE_NETWORK
;

1276 
	`ÿche_mªagem’t_dma_´•¬e
(&
İ”©iÚ
);

1277 
	}
}

1284 
	$_3c509b_dma_com¶‘e_bufãrs
(*
bufãr
, 
size_t
 
Ëngth
) {

1285 
dma_İ”©iÚ_t
 
İ”©iÚ
;

1287 ià(!
bufãr
 || 
Ëngth
 == 0) {

1292 
İ”©iÚ
.
bufãr
 = buffer;

1293 
İ”©iÚ
.
Ëngth
 =†ength;

1294 
İ”©iÚ
.
dœeùiÚ
 = 
DMA_DIRECTION_FROM_DEVICE
;

1295 
İ”©iÚ
.
deviû_ty³
 = 
DMA_DEVICE_NETWORK
;

1298 
	`ÿche_mªagem’t_dma_com¶‘e
(&
İ”©iÚ
);

1299 
	}
}

1310 
	$_3c509b_»ûive_·ck‘_ÿche_§ã
(
nic_šfo_t
 *
nic
) {

1311 
bufãr_desc_t
 *
rx_bufãr
 = 
NULL
;

1312 
ušt16_t
 
¡©us
, 
rx_¡©us
, 
·ck‘_Ëngth
;

1313 
ušt16_t
 
rx_fifo
;

1314 
size_t
 
wÜds
;

1315 
»suÉ
 = 
SUCCESS
;

1317 ià(!
nic
) {

1318  
ERROR_INVALID_PARAM
;

1322 ià(!
nic
->
ÿche_mªagem’t_avaabË
) {

1323 
	`LOG_DEBUG
("Cache management‚ot‡vailable, using†egacy„eceive");

1324  
	`_3c509b_»ûive_·ck‘_bufã»d
(
nic
);

1328 
	`_3c509b_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_1
);

1331 
¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_STATUS_REG
);

1332 ià(!(
¡©us
 & 
_3C509B_STATUS_RX_COMPLETE
)) {

1333  
ERROR_NO_DATA
;

1337 
rx_¡©us
 = 
	`_3c509b_»ad_»g
(
nic
, 
_3C509B_RX_STATUS
);

1338 
·ck‘_Ëngth
 = 
rx_¡©us
 & 
_3C509B_RXSTAT_LEN_MASK
;

1341 ià(
rx_¡©us
 & (
_3C509B_RXSTAT_ERROR
 | 
_3C509B_RXSTAT_INCOMPLETE
)) {

1342 
	`LOG_DEBUG
("RXƒ¼Ü: stus=0x%X", 
rx_¡©us
);

1343 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_DISCARD
);

1344 
nic
->
rx_”rÜs
++;

1345  
ERROR_IO
;

1349 
rx_bufãr
 = 
	`rx_cİyb»ak_®loc
(
·ck‘_Ëngth
);

1350 ià(!
rx_bufãr
) {

1351 
	`LOG_ERROR
("FaedØ®loÿ‹ cache-§ã RX bufã¸fÜ %d by‹…ack‘", 
·ck‘_Ëngth
);

1352 
	`_3c509b_wr™e_commªd
(
nic
, 
_3C509B_CMD_RX_DISCARD
);

1353 
nic
->
rx_drİ³d
++;

1354  
ERROR_NO_MEMORY
;

1358 
	`_3c509b_dma_´•¬e_bufãrs
(
rx_bufãr
->
d©a
, 
·ck‘_Ëngth
);

1361 
rx_fifo
 = 
nic
->
io_ba£
 + 
_3C509B_RX_FIFO
;

1362 
wÜds
 = 
·ck‘_Ëngth
 / 2;

1363 
ušt16_t
 *
bufãr_wÜds
 = (ušt16_t*)
rx_bufãr
->
d©a
;

1365 
size_t
 
i
 = 0; i < 
wÜds
; i++) {

1366 
bufãr_wÜds
[
i
] = 
	`šw
(
rx_fifo
);

1369 ià(
·ck‘_Ëngth
 & 1) {

1370 ((
ušt8_t
*)
rx_bufãr
->
d©a
)[
·ck‘_Ëngth
 - 1] = 
	`šb
(
rx_fifo
);

1374 
	`_3c509b_dma_com¶‘e_bufãrs
(
rx_bufãr
->
d©a
, 
·ck‘_Ëngth
);

1377 
rx_bufãr
->
u£d
 = 
·ck‘_Ëngth
;

1378 
	`bufãr_£t_¡©e
(
rx_bufãr
, 
BUFFER_STATE_IN_USE
);

1381 ià(
·ck‘_Ëngth
 >= 34) {

1382 
checksum_»suÉ
 = 
	`hw_checksum_v”ify_šbound_·ck‘
((
ušt8_t
*)
rx_bufãr
->
d©a
, 
·ck‘_Ëngth
);

1383 ià(
checksum_»suÉ
 < 0) {

1384 
	`LOG_DEBUG
("Checksum verification failed for inbound…acket");

1389 
»suÉ
 = 
	`·ck‘_´oûss_»ûived
((
ušt8_t
*)
rx_bufãr
->
d©a
, 
·ck‘_Ëngth
, 
nic
->
šdex
);

1390 ià(
»suÉ
 !ğ
SUCCESS
) {

1391 
	`LOG_WARNING
("Pack‘…roûssšg faed: %d", 
»suÉ
);

1392 
nic
->
rx_drİ³d
++;

1394 
nic
->
rx_·ck‘s
++;

1395 
nic
->
rx_by‹s
 +ğ
·ck‘_Ëngth
;

1396 
	`LOG_TRACE
("Proûs£d cache-§ã„eûived…ack‘ oà%d by‹s", 
·ck‘_Ëngth
);

1400 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

1402  
»suÉ
;

1403 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/3c515.c

23 
	~"3c515.h
"

24 
	~"“´om.h
"

25 
	~"medŸ_cÚŒŞ.h
"

26 
	~"’hªûd_ršg_cÚ‹xt.h
"

27 
	~"”rÜ_hªdlšg.h
"

28 
	~"loggšg.h
"

29 
	~"š‹¼u±_m™ig©iÚ.h
"

30 
	~"../šşude/hw_checksum.h
"

31 
	~"../šşude/dma.h
"

32 
	~"../šşude/ÿche_coh”’cy.h
"

33 
	~"../šşude/ÿche_mªagem’t.h
"

34 
	~"../šşude/ch£t_d‘eù.h
"

35 
	~"../šşude/ch£t_d©aba£.h
"

36 
	~<¡dlib.h
>

37 
	~<¡ršg.h
>

39 
	#TX_RING_SIZE
 16

40 
	#RX_RING_SIZE
 16

41 
	#BUFFER_SIZE
 1600

42 
	#EEPROM_SIZE
 0x40

43 

	)

45 
	#RESET_TIMEOUT_MS
 1000

	)

46 
	#CONFIG_STABILIZATION_MS
 100

	)

47 
	#LINK_CHECK_INTERVAL_MS
 500

	)

48 
	#STATS_UPDATE_INTERVAL_MS
 1000

	)

49 
	#CONFIG_VALIDATION_INTERVAL_MS
 5000

	)

52 
	#DUPLEX_HALF
 0

	)

53 
	#DUPLEX_FULL
 1

	)

54 
	#DUPLEX_AUTO
 2

	)

57 
	#SPEED_10MBPS
 10

	)

58 
	#SPEED_100MBPS
 100

	)

59 
	#SPEED_AUTO
 0

	)

65 
ušt8_t
 
	mmedŸ_ty³
;

66 
ušt8_t
 
	mdu¶ex_mode
;

67 
ušt8_t
 
	mŒªsûiv”_ty³
;

68 
ušt16_t
 
	mlšk_¥“d
;

69 
ušt8_t
 
	mlšk_aùive
;

70 
ušt8_t
 
	mauto_ÃgÙŸtiÚ
;

71 
ušt16_t
 
	madv”ti£d_modes
;

72 } 
	tmedŸ_cÚfig_t
;

79 
ušt16_t
 
	mio_ba£
;

80 
ušt8_t
 
	mœq
;

83 
_3c515_tx_tx_desc_t
 *
	mtx_desc_ršg
;

84 
_3c515_tx_rx_desc_t
 *
	mrx_desc_ršg
;

85 
ušt32_t
 
	mtx_šdex
;

86 
ušt32_t
 
	mrx_šdex
;

87 
ušt8_t
 *
	mbufãrs
;

90 
“´om_cÚfig_t
 
	m“´om_cÚfig
;

91 
medŸ_cÚfig_t
 
	mmedŸ_cÚfig
;

94 
ušt8_t
 
	mh¬dw¬e_»ady
;

95 
ušt8_t
 
	mdriv”_aùive
;

96 
ušt32_t
 
	mÏ¡_cÚfig_v®id©iÚ
;

97 
ušt32_t
 
	mÏ¡_¡©s_upd©e
;

98 
ušt32_t
 
	mÏ¡_lšk_check
;

101 
ušt32_t
 
	mtx_·ck‘s
;

102 
ušt32_t
 
	mrx_·ck‘s
;

103 
ušt32_t
 
	mtx_by‹s
;

104 
ušt32_t
 
	mrx_by‹s
;

105 
ušt32_t
 
	mtx_”rÜs
;

106 
ušt32_t
 
	mrx_”rÜs
;

107 
ušt32_t
 
	mlšk_chªges
;

108 
ušt32_t
 
	mcÚfig_”rÜs
;

111 
ušt16_t
 
	mš‹¼u±_mask
;

112 
ušt8_t
 
	mfuÎ_du¶ex_’abËd
;

113 
ušt8_t
 
	mdma_’abËd
;

114 
ušt8_t
 
	m¡©s_’abËd
;

115 
ušt8_t
 
	mlšk_mÚ™Üšg_’abËd
;

118 
nic_cÚ‹xt_t
 *
	m”rÜ_cÚ‹xt
;

121 
ušt8_t
 
	mÿche_coh”’cy_t›r
;

122 
ušt8_t
 
	mÿche_mªagem’t_avaabË
;

123 
coh”’cy_ª®ysis_t
 
	mcoh”’cy_ª®ysis
;

124 } 
	tnic_cÚ‹xt_t
;

127 
»ad_ªd_·r£_“´om
(
nic_cÚ‹xt_t
 *
ùx
);

128 
cÚfigu»_medŸ_ty³
(
nic_cÚ‹xt_t
 *
ùx
, 
medŸ_cÚfig_t
 *
medŸ
);

129 
cÚfigu»_fuÎ_du¶ex
(
nic_cÚ‹xt_t
 *
ùx
);

130 
£tup_š‹¼u±_mask
(
nic_cÚ‹xt_t
 *
ùx
);

131 
cÚfigu»_bus_ma¡”_dma
(
nic_cÚ‹xt_t
 *
ùx
);

132 
’abË_h¬dw¬e_¡©i¡ics
(
nic_cÚ‹xt_t
 *
ùx
);

133 
£tup_lšk_mÚ™Üšg
(
nic_cÚ‹xt_t
 *
ùx
);

134 
v®id©e_h¬dw¬e_cÚfigu¿tiÚ
(
nic_cÚ‹xt_t
 *
ùx
);

135 
»£t_nic_h¬dw¬e
(
nic_cÚ‹xt_t
 *
ùx
);

136 
d–ay_mli£cÚds
(
ušt32_t
 
ms
);

137 
ušt32_t
 
g‘_sy¡em_time_ms
();

140 
mii_»ad_»gi¡”
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 
phy_addr
, ušt8_ˆ
»g_addr
);

141 
mii_wr™e_»gi¡”
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 
phy_addr
, ušt8_ˆ
»g_addr
, 
ušt16_t
 
v®ue
);

142 
¡¬t_autÚegÙŸtiÚ
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 
adv”ti£d_modes
);

143 
check_autÚegÙŸtiÚ_com¶‘e
(
nic_cÚ‹xt_t
 *
ùx
);

144 
g‘_autÚegÙŸtiÚ_»suÉ
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 *
¥“d
, 
boŞ
 *
fuÎ_du¶ex
);

145 
cÚfigu»_mii_Œªsûiv”
(
nic_cÚ‹xt_t
 *
ùx
);

148 
_3c515_š™Ÿlize_ÿche_coh”’cy
(
nic_cÚ‹xt_t
 *
ùx
);

149 
_3c515_dma_´•¬e_bufãrs
(*
bufãr
, 
size_t
 
Ëngth
, 
boŞ
 
is_»ûive
);

150 
_3c515_dma_com¶‘e_bufãrs
(*
bufãr
, 
size_t
 
Ëngth
, 
boŞ
 
is_»ûive
);

153 
	#MII_CONTROL_REG
 0x00

	)

154 
	#MII_STATUS_REG
 0x01

	)

155 
	#MII_PHY_ID1_REG
 0x02

	)

156 
	#MII_PHY_ID2_REG
 0x03

	)

157 
	#MII_AUTONEG_ADV_REG
 0x04

	)

158 
	#MII_AUTONEG_LINK_REG
 0x05

	)

159 
	#MII_AUTONEG_EXP_REG
 0x06

	)

162 
	#MII_CTRL_RESET
 0x8000

	)

163 
	#MII_CTRL_LOOPBACK
 0x4000

	)

164 
	#MII_CTRL_SPEED_100
 0x2000

	)

165 
	#MII_CTRL_AUTONEG_EN
 0x1000

	)

166 
	#MII_CTRL_POWER_DOWN
 0x0800

	)

167 
	#MII_CTRL_ISOLATE
 0x0400

	)

168 
	#MII_CTRL_RESTART_AN
 0x0200

	)

169 
	#MII_CTRL_FULL_DUPLEX
 0x0100

	)

170 
	#MII_CTRL_COLLISION_TEST
 0x0080

	)

173 
	#MII_STAT_100_T4
 0x8000

	)

174 
	#MII_STAT_100_TX_FD
 0x4000

	)

175 
	#MII_STAT_100_TX_HD
 0x2000

	)

176 
	#MII_STAT_10_FD
 0x1000

	)

177 
	#MII_STAT_10_HD
 0x0800

	)

178 
	#MII_STAT_AUTONEG_COMP
 0x0020

	)

179 
	#MII_STAT_REMOTE_FAULT
 0x0010

	)

180 
	#MII_STAT_AUTONEG_CAP
 0x0008

	)

181 
	#MII_STAT_LINK_UP
 0x0004

	)

182 
	#MII_STAT_JABBER
 0x0002

	)

183 
	#MII_STAT_EXTENDED
 0x0001

	)

186 
	#MII_ADV_NEXT_PAGE
 0x8000

	)

187 
	#MII_ADV_REMOTE_FAULT
 0x2000

	)

188 
	#MII_ADV_PAUSE
 0x0400

	)

189 
	#MII_ADV_100_T4
 0x0200

	)

190 
	#MII_ADV_100_TX_FD
 0x0100

	)

191 
	#MII_ADV_100_TX_HD
 0x0080

	)

192 
	#MII_ADV_10_FD
 0x0040

	)

193 
	#MII_ADV_10_HD
 0x0020

	)

194 
	#MII_ADV_SELECTOR_FIELD
 0x001F

	)

197 
	#_3C515_W4_PHY_CTRL
 0x08

	)

198 
	#_3C515_W4_PHY_STATUS
 0x0A

	)

199 
	#_3C515_W4_PHY_ID_LOW
 0x0C

	)

200 
	#_3C515_W4_PHY_ID_HIGH
 0x0E

	)

203 
	#PHY_CTRL_MGMT_CLK
 0x0001

	)

204 
	#PHY_CTRL_MGMT_DATA
 0x0002

	)

205 
	#PHY_CTRL_MGMT_DIR
 0x0004

	)

206 
	#PHY_CTRL_MGMT_OE
 0x0008

	)

209 
	#DMA_DESC_ALIGNMENT
 16

	)

210 
	#DMA_BUFFER_ALIGNMENT
 4

	)

211 
	#MAX_DMA_FRAGMENT_SIZE
 1536

	)

212 
	#DMA_COHERENCY_SYNC
 0x0001

	)

215 
nic_cÚ‹xt_t
 
	gg_nic_cÚ‹xt
;

216 
boŞ
 
	gg_driv”_š™Ÿlized
 = 
çl£
;

219 *
	$®loÿ‹_desütÜ_ršg
(
size
, 
size_t
 
desc_size
) {

220 *
ršg
 = 
	`m®loc
(
size
 * 
desc_size
);

221 ià(
ršg
) {

222 
	`mem£t
(
ršg
, 0, 
size
 * 
desc_size
);

224  
ršg
;

225 
	}
}

237 
	$com¶‘e_3c515_š™Ÿliz©iÚ
(
nic_cÚ‹xt_t
 *
ùx
) {

238 
»suÉ
;

239 
medŸ_cÚfig_t
 
medŸ
;

241 ià(!
ùx
) {

242 
	`LOG_ERROR
("Invalid NIC context for initialization");

246 
	`LOG_INFO
("Starting complete 3C515-TX hardware initialization");

249 
	`mem£t
(&
medŸ
, 0, (
medŸ_cÚfig_t
));

252 
	`LOG_DEBUG
("Step 1: Reading EEPROM configuration");

253 
»suÉ
 = 
	`»ad_ªd_·r£_“´om
(
ùx
);

254 ià(
»suÉ
 < 0) {

255 
	`LOG_ERROR
("FaedØ»ad EEPROM cÚfigu¿tiÚ: %d", 
»suÉ
);

256 
ùx
->
cÚfig_”rÜs
++;

257  
»suÉ
;

261 
	`LOG_DEBUG
("Step 2: Resetting hardware");

262 
»suÉ
 = 
	`»£t_nic_h¬dw¬e
(
ùx
);

263 ià(
»suÉ
 < 0) {

264 
	`LOG_ERROR
("FaedØ»£ˆNIC h¬dw¬e: %d", 
»suÉ
);

265 
ùx
->
cÚfig_”rÜs
++;

266  
»suÉ
;

270 
	`LOG_DEBUG
("Step 3: Configuring MIIransceiver‡nd‡uto-negotiation");

271 
»suÉ
 = 
	`cÚfigu»_mii_Œªsûiv”
(
ùx
);

272 ià(
»suÉ
 < 0) {

273 
	`LOG_ERROR
("FaedØcÚfigu» MII¿nsûiv”: %d", 
»suÉ
);

274 
ùx
->
cÚfig_”rÜs
++;

275  
»suÉ
;

279 
	`LOG_DEBUG
("Step 4: Configuring mediaype");

280 
»suÉ
 = 
	`cÚfigu»_medŸ_ty³
(
ùx
, &
medŸ
);

281 ià(
»suÉ
 < 0) {

282 
	`LOG_ERROR
("FaedØcÚfigu» medŸy³: %d", 
»suÉ
);

283 
ùx
->
cÚfig_”rÜs
++;

284  
»suÉ
;

288 
	`LOG_DEBUG
("Step 4: Configuring full-duplex support");

289 ià(
medŸ
.
du¶ex_mode
 =ğ
DUPLEX_FULL
) {

290 
»suÉ
 = 
	`cÚfigu»_fuÎ_du¶ex
(
ùx
);

291 ià(
»suÉ
 < 0) {

292 
	`LOG_WARNING
("FaedØcÚfigu» fuÎ-du¶ex: %d", 
»suÉ
);

294 
medŸ
.
du¶ex_mode
 = 
DUPLEX_HALF
;

299 
	`LOG_DEBUG
("Step 5: Setting up interrupt mask");

300 
»suÉ
 = 
	`£tup_š‹¼u±_mask
(
ùx
);

301 ià(
»suÉ
 < 0) {

302 
	`LOG_ERROR
("FaedØ£tu°š‹¼u± mask: %d", 
»suÉ
);

303 
ùx
->
cÚfig_”rÜs
++;

304  
»suÉ
;

308 
	`LOG_DEBUG
("Step 6: Configuring bus master DMA");

309 
»suÉ
 = 
	`cÚfigu»_bus_ma¡”_dma
(
ùx
);

310 ià(
»suÉ
 < 0) {

311 
	`LOG_ERROR
("FaedØcÚfigu» bu ma¡” DMA: %d", 
»suÉ
);

312 
ùx
->
cÚfig_”rÜs
++;

313  
»suÉ
;

317 
	`LOG_DEBUG
("Step 7: Enabling hardware statistics");

318 
»suÉ
 = 
	`’abË_h¬dw¬e_¡©i¡ics
(
ùx
);

319 ià(
»suÉ
 < 0) {

320 
	`LOG_WARNING
("FaedØ’abË h¬dw¬¡©i¡ics: %d", 
»suÉ
);

325 
	`LOG_DEBUG
("Step 8: Setting up†ink monitoring");

326 
»suÉ
 = 
	`£tup_lšk_mÚ™Üšg
(
ùx
);

327 ià(
»suÉ
 < 0) {

328 
	`LOG_WARNING
("FaedØ£tu°lšk mÚ™Üšg: %d", 
»suÉ
);

333 
	`LOG_DEBUG
("Step 9: Initializing cache coherency management");

334 
»suÉ
 = 
	`_3c515_š™Ÿlize_ÿche_coh”’cy
(
ùx
);

335 ià(
»suÉ
 < 0) {

336 
	`LOG_ERROR
("Cachcoh”’cy in™Ÿliz©iÚ faed: %d", 
»suÉ
);

337 
ùx
->
cÚfig_”rÜs
++;

338  
»suÉ
;

342 
	`LOG_DEBUG
("Step 10: Validating hardware configuration");

343 
»suÉ
 = 
	`v®id©e_h¬dw¬e_cÚfigu¿tiÚ
(
ùx
);

344 ià(
»suÉ
 < 0) {

345 
	`LOG_ERROR
("H¬dw¬cÚfigu¿tiÚ v®id©iÚ faed: %d", 
»suÉ
);

346 
ùx
->
cÚfig_”rÜs
++;

347  
»suÉ
;

351 
ùx
->
medŸ_cÚfig
 = 
medŸ
;

352 
ùx
->
h¬dw¬e_»ady
 = 1;

353 
ùx
->
driv”_aùive
 = 1;

354 
ùx
->
Ï¡_cÚfig_v®id©iÚ
 = 
	`g‘_sy¡em_time_ms
();

356 
	`LOG_INFO
("Complete 3C515-TX hardware initialization successful");

357 
	`LOG_INFO
(" Media: %s, Speed: %d Mbps, Duplex: %s",

358 (
medŸ
.
medŸ_ty³
 =ğ
XCVR_10ba£T
) ? "10BaseT" :

359 (
medŸ
.
medŸ_ty³
 =ğ
XCVR_100ba£Tx
) ? "100BaseTX" : "Auto",

360 
medŸ
.
lšk_¥“d
,

361 (
medŸ
.
du¶ex_mode
 =ğ
DUPLEX_FULL
) ? "Full" : "Half");

362 
	`LOG_INFO
(" Full Duplex: %s, DMA: %s, Statistics: %s",

363 
ùx
->
fuÎ_du¶ex_’abËd
 ? "Enabled" : "Disabled",

364 
ùx
->
dma_’abËd
 ? "Enabled" : "Disabled",

365 
ùx
->
¡©s_’abËd
 ? "Enabled" : "Disabled");

368 
	}
}

373 
	$»ad_ªd_·r£_“´om
(
nic_cÚ‹xt_t
 *
ùx
) {

374 
»suÉ
;

377 
»suÉ
 = 
	`»ad_3c515_“´om
(
ùx
->
io_ba£
, &ùx->
“´om_cÚfig
);

378 ià(
»suÉ
 !ğ
EEPROM_SUCCESS
) {

379 
	`LOG_ERROR
("FaedØ»ad 3C515-TX EEPROM: %s", 
	`“´om_”rÜ_to_¡ršg
(
»suÉ
));

384 ià(!
ùx
->
“´om_cÚfig
.
d©a_v®id
) {

385 
	`LOG_ERROR
("EEPROM data validation failed");

389 
	`LOG_DEBUG
("EEPROM configuration„ead successfully");

390 
	`LOG_DEBUG
(" MAC: %02X:%02X:%02X:%02X:%02X:%02X",

391 
ùx
->
“´om_cÚfig
.
mac_add»ss
[0], ctx->eeprom_config.mac_address[1],

392 
ùx
->
“´om_cÚfig
.
mac_add»ss
[2], ctx->eeprom_config.mac_address[3],

393 
ùx
->
“´om_cÚfig
.
mac_add»ss
[4], ctx->eeprom_config.mac_address[5]);

394 
	`LOG_DEBUG
(" MedŸ Ty³: %s", 
	`“´om_medŸ_ty³_to_¡ršg
(
ùx
->
“´om_cÚfig
.
medŸ_ty³
));

395 
	`LOG_DEBUG
(" Capabilities: 100Mbps=%s, FullDuplex=%s, AutoSelect=%s",

396 
ùx
->
“´om_cÚfig
.
¥“d_100mbps_ÿp
 ? "Yes" : "No",

397 
ùx
->
“´om_cÚfig
.
fuÎ_du¶ex_ÿp
 ? "Yes" : "No",

398 
ùx
->
“´om_cÚfig
.
auto_£Ëù
 ? "Yes" : "No");

401 
	}
}

406 
	$cÚfigu»_medŸ_ty³
(
nic_cÚ‹xt_t
 *
ùx
, 
medŸ_cÚfig_t
 *
medŸ
) {

407 ià(!
medŸ
) {

412 
medŸ
->
medŸ_ty³
 = 
ùx
->
“´om_cÚfig
.media_type;

413 
medŸ
->
auto_ÃgÙŸtiÚ
 = 
ùx
->
“´om_cÚfig
.
auto_£Ëù
;

416 ià(
ùx
->
“´om_cÚfig
.
¥“d_100mbps_ÿp
) {

417 
medŸ
->
lšk_¥“d
 = 
ùx
->
“´om_cÚfig
.
auto_£Ëù
 ? 
SPEED_AUTO
 : 
SPEED_100MBPS
;

419 
medŸ
->
lšk_¥“d
 = 
SPEED_10MBPS
;

423 ià(
ùx
->
“´om_cÚfig
.
fuÎ_du¶ex_ÿp
) {

424 
medŸ
->
du¶ex_mode
 = 
ùx
->
“´om_cÚfig
.
auto_£Ëù
 ? 
DUPLEX_AUTO
 : 
DUPLEX_FULL
;

426 
medŸ
->
du¶ex_mode
 = 
DUPLEX_HALF
;

430 
medŸ
->
medŸ_ty³
) {

431 
EEPROM_MEDIA_10BASE_T
:

432 
medŸ
->
Œªsûiv”_ty³
 = 
XCVR_10ba£T
;

434 
EEPROM_MEDIA_100BASE_TX
:

435 
medŸ
->
Œªsûiv”_ty³
 = 
XCVR_100ba£Tx
;

437 
EEPROM_MEDIA_AUI
:

438 
medŸ
->
Œªsûiv”_ty³
 = 
XCVR_AUI
;

440 
EEPROM_MEDIA_BNC
:

441 
medŸ
->
Œªsûiv”_ty³
 = 
XCVR_10ba£2
;

444 
medŸ
->
Œªsûiv”_ty³
 = 
XCVR_DeçuÉ
;

449 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_4
);

450 
	`d–ay_mli£cÚds
(10);

453 
ušt16_t
 
medŸ_ù¾
 = 0;

454 
medŸ
->
Œªsûiv”_ty³
) {

455 
XCVR_10ba£T
:

456 
medŸ_ù¾
 = 
_3C515_TX_MEDIA_10TP
 | 
_3C515_TX_MEDIA_LNK
;

458 
XCVR_AUI
:

459 
medŸ_ù¾
 = 
_3C515_TX_MEDIA_SQE
;

462 
medŸ_ù¾
 = 
_3C515_TX_MEDIA_10TP
;

466 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_W4_MEDIA
, 
medŸ_ù¾
);

467 
	`d–ay_mli£cÚds
(
CONFIG_STABILIZATION_MS
);

469 
	`LOG_DEBUG
("Mediaype configured: Type=%d, Speed=%d, Duplex=%d",

470 
medŸ
->
medŸ_ty³
, medŸ->
lšk_¥“d
, medŸ->
du¶ex_mode
);

473 
	}
}

478 
	$cÚfigu»_fuÎ_du¶ex
(
nic_cÚ‹xt_t
 *
ùx
) {

479 ià(!
ùx
->
“´om_cÚfig
.
fuÎ_du¶ex_ÿp
) {

480 
	`LOG_DEBUG
("Full-duplex‚ot supported by hardware");

485 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_3
);

486 
	`d–ay_mli£cÚds
(10);

489 
ušt16_t
 
mac_ù¾
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_W3_MAC_CTRL
);

492 
mac_ù¾
 |ğ
_3C515_TX_FULL_DUPLEX_BIT
;

495 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_W3_MAC_CTRL
, 
mac_ù¾
);

496 
	`d–ay_mli£cÚds
(
CONFIG_STABILIZATION_MS
);

499 
ušt16_t
 
v”ify_ù¾
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_W3_MAC_CTRL
);

500 ià(!(
v”ify_ù¾
 & 
_3C515_TX_FULL_DUPLEX_BIT
)) {

501 
	`LOG_ERROR
("Failedoƒnable full-duplex mode");

505 
ùx
->
fuÎ_du¶ex_’abËd
 = 1;

506 
	`LOG_DEBUG
("Full-duplex modeƒnabled successfully");

509 
	}
}

514 
	$£tup_š‹¼u±_mask
(
nic_cÚ‹xt_t
 *
ùx
) {

516 
ušt16_t
 
št_mask
 = 
_3C515_TX_IMASK_TX_COMPLETE
 |

517 
_3C515_TX_IMASK_RX_COMPLETE
 |

518 
_3C515_TX_IMASK_ADAPTER_FAILURE
 |

519 
_3C515_TX_IMASK_UP_COMPLETE
 |

520 
_3C515_TX_IMASK_DOWN_COMPLETE
 |

521 
_3C515_TX_IMASK_DMA_DONE
 |

522 
_3C515_TX_IMASK_STATS_FULL
;

525 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_1
);

526 
	`d–ay_mli£cÚds
(10);

529 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

530 
_3C515_TX_CMD_SET_INTR_ENB
 | 
št_mask
);

533 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

534 
_3C515_TX_CMD_SET_STATUS_ENB
 | 
št_mask
);

536 
ùx
->
š‹¼u±_mask
 = 
št_mask
;

538 
	`LOG_DEBUG
("IÁ”ru± mask cÚfigu»d: 0x%04X", 
št_mask
);

541 
	}
}

546 
	$cÚfigu»_bus_ma¡”_dma
(
nic_cÚ‹xt_t
 *
ùx
) {

548 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_7
);

549 
	`d–ay_mli£cÚds
(10);

552 ià(!
ùx
->
tx_desc_ršg
) {

553 
ùx
->
tx_desc_ršg
 = 
	`®loÿ‹_desütÜ_ršg
(
TX_RING_SIZE
, (
_3c515_tx_tx_desc_t
));

554 ià(!
ùx
->
tx_desc_ršg
) {

555 
	`LOG_ERROR
("Failedo‡llocate TX descriptor„ing");

560 ià(!
ùx
->
rx_desc_ršg
) {

561 
ùx
->
rx_desc_ršg
 = 
	`®loÿ‹_desütÜ_ršg
(
RX_RING_SIZE
, (
_3c515_tx_rx_desc_t
));

562 ià(!
ùx
->
rx_desc_ršg
) {

563 
	`LOG_ERROR
("Failedo‡llocate RX descriptor„ing");

569 ià(!
ùx
->
bufãrs
) {

570 
ùx
->
bufãrs
 = 
	`m®loc
((
TX_RING_SIZE
 + 
RX_RING_SIZE
è* 
BUFFER_SIZE
);

571 ià(!
ùx
->
bufãrs
) {

572 
	`LOG_ERROR
("Failedo‡llocate buffer memory");

575 
	`mem£t
(
ùx
->
bufãrs
, 0, (
TX_RING_SIZE
 + 
RX_RING_SIZE
è* 
BUFFER_SIZE
);

579 
i
 = 0; i < 
TX_RING_SIZE
; i++) {

580 
ùx
->
tx_desc_ršg
[
i
].
Ãxt
 = (˜+ 1 < 
TX_RING_SIZE
) ?

581 (
ušt32_t
)&
ùx
->
tx_desc_ršg
[
i
 + 1] : 0;

582 
ùx
->
tx_desc_ršg
[
i
].
addr
 = (
ušt32_t
)(ùx->
bufãrs
 + i * 
BUFFER_SIZE
);

583 
ùx
->
tx_desc_ršg
[
i
].
¡©us
 = 0;

584 
ùx
->
tx_desc_ršg
[
i
].
Ëngth
 = 
BUFFER_SIZE
;

587 
i
 = 0; i < 
RX_RING_SIZE
; i++) {

588 
ùx
->
rx_desc_ršg
[
i
].
Ãxt
 = (˜+ 1 < 
RX_RING_SIZE
) ?

589 (
ušt32_t
)&
ùx
->
rx_desc_ršg
[
i
 + 1] : 0;

590 
ùx
->
rx_desc_ršg
[
i
].
addr
 = (
ušt32_t
)(ùx->
bufãrs
 + (
TX_RING_SIZE
 + iè* 
BUFFER_SIZE
);

591 
ùx
->
rx_desc_ršg
[
i
].
¡©us
 = 0;

592 
ùx
->
rx_desc_ršg
[
i
].
Ëngth
 = 
BUFFER_SIZE
;

596 
	`ou
(
ùx
->
io_ba£
 + 
_3C515_TX_DOWN_LIST_PTR
, (
ušt32_t
)ùx->
tx_desc_ršg
);

597 
	`ou
(
ùx
->
io_ba£
 + 
_3C515_TX_UP_LIST_PTR
, (
ušt32_t
)ùx->
rx_desc_ršg
);

599 
ùx
->
dma_’abËd
 = 1;

600 
ùx
->
tx_šdex
 = 0;

601 
ùx
->
rx_šdex
 = 0;

603 
	`LOG_DEBUG
("Bus master DMA configured successfully");

604 
	`LOG_DEBUG
(" TX Ršg: 0x%08X (%d desütÜs)", (
ušt32_t
)
ùx
->
tx_desc_ršg
, 
TX_RING_SIZE
);

605 
	`LOG_DEBUG
(" RX Ršg: 0x%08X (%d desütÜs)", (
ušt32_t
)
ùx
->
rx_desc_ršg
, 
RX_RING_SIZE
);

608 
	}
}

613 
	$’abË_h¬dw¬e_¡©i¡ics
(
nic_cÚ‹xt_t
 *
ùx
) {

615 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_6
);

616 
	`d–ay_mli£cÚds
(10);

619 
i
 = 0; i <ğ
_3C515_TX_W6_BADSSD
; i++) {

620 ()
	`šb
(
ùx
->
io_ba£
 + 
i
);

624 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_STATS_ENABLE
);

626 
ùx
->
¡©s_’abËd
 = 1;

627 
ùx
->
Ï¡_¡©s_upd©e
 = 
	`g‘_sy¡em_time_ms
();

629 
	`LOG_DEBUG
("Hardware statistics collectionƒnabled");

632 
	}
}

637 
	$£tup_lšk_mÚ™Üšg
(
nic_cÚ‹xt_t
 *
ùx
) {

639 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_4
);

640 
	`d–ay_mli£cÚds
(10);

643 
ušt16_t
 
medŸ_¡©us
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_W4_MEDIA
);

644 
ùx
->
medŸ_cÚfig
.
lšk_aùive
 = (
medŸ_¡©us
 & 
_3C515_TX_MEDIA_LNKBEAT
) ? 1 : 0;

646 
ùx
->
lšk_mÚ™Üšg_’abËd
 = 1;

647 
ùx
->
Ï¡_lšk_check
 = 
	`g‘_sy¡em_time_ms
();

649 
	`LOG_DEBUG
("Link monitoringƒnabled, current status: %s",

650 
ùx
->
medŸ_cÚfig
.
lšk_aùive
 ? "Up" : "Down");

653 
	}
}

658 
	$v®id©e_h¬dw¬e_cÚfigu¿tiÚ
(
nic_cÚ‹xt_t
 *
ùx
) {

659 
ušt16_t
 
§ved_wšdow
;

662 
§ved_wšdow
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_STATUS_REG
) >> 13;

665 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_0
);

666 
	`d–ay_mli£cÚds
(5);

669 
ušt16_t
 
“´om_‹¡
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_W0_EEPROM_DATA
);

670 ià(
“´om_‹¡
 == 0xFFFF ||ƒeprom_test == 0x0000) {

671 
	`LOG_WARNING
("EEPROM d©¨»gi¡” v®id©iÚ su¥icious: 0x%04X", 
“´om_‹¡
);

675 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_3
);

676 
	`d–ay_mli£cÚds
(5);

678 
ušt16_t
 
mac_ù¾
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_W3_MAC_CTRL
);

679 ià(
ùx
->
fuÎ_du¶ex_’abËd
 && !(
mac_ù¾
 & 
_3C515_TX_FULL_DUPLEX_BIT
)) {

680 
	`LOG_ERROR
("Full-duplex validation failed");

685 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_7
);

686 
	`d–ay_mli£cÚds
(5);

688 
ušt32_t
 
tx_±r
 = 
	`šl
(
ùx
->
io_ba£
 + 
_3C515_TX_DOWN_LIST_PTR
);

689 
ušt32_t
 
rx_±r
 = 
	`šl
(
ùx
->
io_ba£
 + 
_3C515_TX_UP_LIST_PTR
);

691 ià(
tx_±r
 !ğ(
ušt32_t
)
ùx
->
tx_desc_ršg
 || 
rx_±r
 !ğ(ušt32_t)ùx->
rx_desc_ršg
) {

692 
	`LOG_ERROR
("DMA descriptor validation failed: TX=0x%08X (exp 0x%08X), RX=0x%08X (exp 0x%08X)",

693 
tx_±r
, (
ušt32_t
)
ùx
->
tx_desc_ršg
, 
rx_±r
, (ušt32_t)ùx->
rx_desc_ršg
);

698 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
§ved_wšdow
);

700 
	`LOG_DEBUG
("Hardware configuration validation…assed");

703 
	}
}

708 
	$»£t_nic_h¬dw¬e
(
nic_cÚ‹xt_t
 *
ùx
) {

709 
ušt32_t
 
timeout_¡¬t
 = 
	`g‘_sy¡em_time_ms
();

712 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TOTAL_RESET
);

715 (
	`g‘_sy¡em_time_ms
(è- 
timeout_¡¬t
è< 
RESET_TIMEOUT_MS
) {

716 
ušt16_t
 
¡©us
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

717 ià(!(
¡©us
 & 
_3C515_TX_STATUS_CMD_IN_PROGRESS
)) {

718 
	`LOG_DEBUG
("Hardware„eset completed in %u ms",

719 
	`g‘_sy¡em_time_ms
(è- 
timeout_¡¬t
);

720 
	`d–ay_mli£cÚds
(
CONFIG_STABILIZATION_MS
);

723 
	`d–ay_mli£cÚds
(10);

726 
	`LOG_ERROR
("H¬dw¬»£ˆtimeouˆaá” %d ms", 
RESET_TIMEOUT_MS
);

728 
	}
}

733 
	$d–ay_mli£cÚds
(
ušt32_t
 
ms
) {

735 
ušt32_t
 
i
 = 0; i < 
ms
; i++) {

736 vŞ©
ušt32_t
 
j
 = 0; j < 1000; j++) {

740 
	}
}

745 
ušt32_t
 
	$g‘_sy¡em_time_ms
() {

747 
ušt32_t
 
couÁ”
 = 0;

748  ++
couÁ”
;

749 
	}
}

754 
	$³riodic_cÚfigu¿tiÚ_v®id©iÚ
(
nic_cÚ‹xt_t
 *
ùx
) {

755 
ušt32_t
 
cu¼’t_time
 = 
	`g‘_sy¡em_time_ms
();

757 ià(!
ùx
 || !ùx->
h¬dw¬e_»ady
) {

762 ià((
cu¼’t_time
 - 
ùx
->
Ï¡_cÚfig_v®id©iÚ
è< 
CONFIG_VALIDATION_INTERVAL_MS
) {

766 
	`LOG_DEBUG
("Performing…eriodic configuration validation");

769 
»suÉ
 = 
	`v®id©e_h¬dw¬e_cÚfigu¿tiÚ
(
ùx
);

770 ià(
»suÉ
 < 0) {

771 
	`LOG_ERROR
("Periodic configuration validation failed");

772 
ùx
->
cÚfig_”rÜs
++;

773  
»suÉ
;

777 ià(
ùx
->
lšk_mÚ™Üšg_’abËd
) {

778 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_4
);

779 
ušt16_t
 
medŸ_¡©us
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_TX_W4_MEDIA
);

780 
ušt8_t
 
Ãw_lšk_¡©us
 = (
medŸ_¡©us
 & 
_3C515_TX_MEDIA_LNKBEAT
) ? 1 : 0;

782 ià(
Ãw_lšk_¡©us
 !ğ
ùx
->
medŸ_cÚfig
.
lšk_aùive
) {

783 
	`LOG_INFO
("Link status changed: %s -> %s",

784 
ùx
->
medŸ_cÚfig
.
lšk_aùive
 ? "Up" : "Down",

785 
Ãw_lšk_¡©us
 ? "Up" : "Down");

786 
ùx
->
medŸ_cÚfig
.
lšk_aùive
 = 
Ãw_lšk_¡©us
;

787 
ùx
->
lšk_chªges
++;

792 ià(
ùx
->
¡©s_’abËd
 &&

793 (
cu¼’t_time
 - 
ùx
->
Ï¡_¡©s_upd©e
è>ğ
STATS_UPDATE_INTERVAL_MS
) {

795 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_6
);

798 
ùx
->
tx_”rÜs
 +ğ
	`šb
(ùx->
io_ba£
 + 
_3C515_TX_W6_TX_CARR_ERRS
);

799 
ùx
->
tx_”rÜs
 +ğ
	`šb
(ùx->
io_ba£
 + 
_3C515_TX_W6_TX_HRTBT_ERRS
);

800 
ùx
->
rx_”rÜs
 +ğ
	`šb
(ùx->
io_ba£
 + 
_3C515_TX_W6_RX_FIFO_ERRS
);

802 
ùx
->
Ï¡_¡©s_upd©e
 = 
cu¼’t_time
;

805 
ùx
->
Ï¡_cÚfig_v®id©iÚ
 = 
cu¼’t_time
;

807 
	`LOG_DEBUG
("Periodic configuration validation completed successfully");

810 
	}
}

815 
	$_3c515_’hªûd_š™
(
ušt16_t
 
io_ba£
, 
ušt8_t
 
œq
) {

816 
nic_cÚ‹xt_t
 *
ùx
 = &
g_nic_cÚ‹xt
;

817 
»suÉ
;

819 ià(
g_driv”_š™Ÿlized
) {

820 
	`LOG_WARNING
("Driver‡lready initialized, cleaning up first");

821 
	`_3c515_’hªûd_ş—nup
();

824 
	`LOG_INFO
("Initializingƒnhanced 3C515-TX driver");

827 
	`mem£t
(
ùx
, 0, (
nic_cÚ‹xt_t
));

830 
ùx
->
io_ba£
 = io_base;

831 
ùx
->
œq
 = irq;

834 
»suÉ
 = 
	`com¶‘e_3c515_š™Ÿliz©iÚ
(
ùx
);

835 ià(
»suÉ
 < 0) {

836 
	`LOG_ERROR
("Com¶‘h¬dw¬š™Ÿliz©iÚ faed: %d", 
»suÉ
);

837  
»suÉ
;

841 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TX_ENABLE
);

842 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_RX_ENABLE
);

845 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_START_DMA_UP
);

847 
g_driv”_š™Ÿlized
 = 
Œue
;

849 
	`LOG_INFO
("Enhanced 3C515-TX driver initialized successfully");

850 
	`LOG_INFO
(" I/O Ba£: 0x%04X, IRQ: %d", 
io_ba£
, 
œq
);

851 
	`LOG_INFO
(" MAC: %02X:%02X:%02X:%02X:%02X:%02X",

852 
ùx
->
“´om_cÚfig
.
mac_add»ss
[0], ctx->eeprom_config.mac_address[1],

853 
ùx
->
“´om_cÚfig
.
mac_add»ss
[2], ctx->eeprom_config.mac_address[3],

854 
ùx
->
“´om_cÚfig
.
mac_add»ss
[4], ctx->eeprom_config.mac_address[5]);

857 
	}
}

862 
	$_3c515_’hªûd_ş—nup
() {

863 
nic_cÚ‹xt_t
 *
ùx
 = &
g_nic_cÚ‹xt
;

865 ià(!
g_driv”_š™Ÿlized
) {

869 
	`LOG_INFO
("Cleaning upƒnhanced 3C515-TX driver");

872 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TX_DISABLE
);

873 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_RX_DISABLE
);

876 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_DOWN_STALL
);

877 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_UP_STALL
);

880 ià(
ùx
->
tx_desc_ršg
) {

881 
	`ä“
(
ùx
->
tx_desc_ršg
);

882 
ùx
->
tx_desc_ršg
 = 
NULL
;

885 ià(
ùx
->
rx_desc_ršg
) {

886 
	`ä“
(
ùx
->
rx_desc_ršg
);

887 
ùx
->
rx_desc_ršg
 = 
NULL
;

890 ià(
ùx
->
bufãrs
) {

891 
	`ä“
(
ùx
->
bufãrs
);

892 
ùx
->
bufãrs
 = 
NULL
;

896 
	`LOG_INFO
("Final driver statistics:");

897 
	`LOG_INFO
(" TX: %u…ackets, %u bytes, %uƒrrors",

898 
ùx
->
tx_·ck‘s
, ctx->
tx_by‹s
, ctx->
tx_”rÜs
);

899 
	`LOG_INFO
(" RX: %u…ackets, %u bytes, %uƒrrors",

900 
ùx
->
rx_·ck‘s
, ctx->
rx_by‹s
, ctx->
rx_”rÜs
);

901 
	`LOG_INFO
(" Link changes: %u, Configƒrrors: %u",

902 
ùx
->
lšk_chªges
, ctx->
cÚfig_”rÜs
);

904 
ùx
->
driv”_aùive
 = 0;

905 
ùx
->
h¬dw¬e_»ady
 = 0;

906 
g_driv”_š™Ÿlized
 = 
çl£
;

908 
	`LOG_INFO
("Enhanced 3C515-TX driver cleanup completed");

909 
	}
}

914 
	$g‘_h¬dw¬e_cÚfig_šfo
(
nic_cÚ‹xt_t
 *
ùx
, *
bufãr
, 
size_t
 
bufãr_size
) {

915 ià(!
ùx
 || !
bufãr
 || 
bufãr_size
 < 512) {

919 
wr™‹n
 = 0;

921 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

924 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

925 "I/O Ba£: 0x%04X\n", 
ùx
->
io_ba£
);

926 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

927 "IRQ: %d\n", 
ùx
->
œq
);

928 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

930 
ùx
->
“´om_cÚfig
.
mac_add»ss
[0], ctx->eeprom_config.mac_address[1],

931 
ùx
->
“´om_cÚfig
.
mac_add»ss
[2], ctx->eeprom_config.mac_address[3],

932 
ùx
->
“´om_cÚfig
.
mac_add»ss
[4], ctx->eeprom_config.mac_address[5]);

934 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

936 
	`“´om_medŸ_ty³_to_¡ršg
(
ùx
->
medŸ_cÚfig
.
medŸ_ty³
));

937 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

938 "Lšk S³ed: %d Mbps\n", 
ùx
->
medŸ_cÚfig
.
lšk_¥“d
);

939 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

941 (
ùx
->
medŸ_cÚfig
.
du¶ex_mode
 =ğ
DUPLEX_FULL
) ? "Full" : "Half");

942 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

944 
ùx
->
medŸ_cÚfig
.
lšk_aùive
 ? "Up" : "Down");

946 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

947 "FuÎ Du¶ex: %s\n", 
ùx
->
fuÎ_du¶ex_’abËd
 ? "Enabled" : "Disabled");

948 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

949 "DMA: %s\n", 
ùx
->
dma_’abËd
 ? "Enabled" : "Disabled");

950 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

951 "Sti¡ics: %s\n", 
ùx
->
¡©s_’abËd
 ? "Enabled" : "Disabled");

952 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

953 "Lšk MÚ™Üšg: %s\n", 
ùx
->
lšk_mÚ™Üšg_’abËd
 ? "Enabled" : "Disabled");

955 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

956 "IÁ”ru± Mask: 0x%04X\n", 
ùx
->
š‹¼u±_mask
);

958 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

960 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

961 "TX Pack‘s: %u\n", 
ùx
->
tx_·ck‘s
);

962 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

963 "RX Pack‘s: %u\n", 
ùx
->
rx_·ck‘s
);

964 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

965 "TX E¼Üs: %u\n", 
ùx
->
tx_”rÜs
);

966 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

967 "RX E¼Üs: %u\n", 
ùx
->
rx_”rÜs
);

968 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

969 "Lšk Chªges: %u\n", 
ùx
->
lšk_chªges
);

970 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

971 "CÚfig E¼Üs: %u\n", 
ùx
->
cÚfig_”rÜs
);

973  
wr™‹n
;

974 
	}
}

979 
nic_cÚ‹xt_t
 *
	$g‘_3c515_cÚ‹xt
() {

980  
g_driv”_š™Ÿlized
 ? &
g_nic_cÚ‹xt
 : 
NULL
;

981 
	}
}

988 
	$_3c515_š™
(
nic_šfo_t
 *
nic
) {

989 
i
;

992 
nic
->
tx_desc_ršg
 = 
	`®loÿ‹_desütÜ_ršg
(
TX_RING_SIZE
, (
_3c515_tx_tx_desc_t
));

993 ià(!
nic
->
tx_desc_ršg
)  -1;

996 
nic
->
rx_desc_ršg
 = 
	`®loÿ‹_desütÜ_ršg
(
RX_RING_SIZE
, (
_3c515_tx_rx_desc_t
));

997 ià(!
nic
->
rx_desc_ršg
)  -1;

1000 
nic
->
bufãrs
 = 
	`m®loc
((
TX_RING_SIZE
 + 
RX_RING_SIZE
è* 
BUFFER_SIZE
);

1001 ià(!
nic
->
bufãrs
)  -1;

1004 
i
 = 0; i < 
TX_RING_SIZE
; i++) {

1005 
nic
->
tx_desc_ršg
[
i
].
Ãxt
 = (˜+ 1 < 
TX_RING_SIZE
) ?

1006 (
ušt32_t
)&
nic
->
tx_desc_ršg
[
i
 + 1] : 0;

1007 
nic
->
tx_desc_ršg
[
i
].
addr
 = (
ušt32_t
)Òic->
bufãrs
 + i * 
BUFFER_SIZE
);

1008 
nic
->
tx_desc_ršg
[
i
].
¡©us
 = 0;

1009 
nic
->
tx_desc_ršg
[
i
].
Ëngth
 = 
BUFFER_SIZE
;

1013 
i
 = 0; i < 
RX_RING_SIZE
; i++) {

1014 
nic
->
rx_desc_ršg
[
i
].
Ãxt
 = (˜+ 1 < 
RX_RING_SIZE
) ?

1015 (
ušt32_t
)&
nic
->
rx_desc_ršg
[
i
 + 1] : 0;

1016 
nic
->
rx_desc_ršg
[
i
].
addr
 = (
ušt32_t
)Òic->
bufãrs
 + (
TX_RING_SIZE
 + iè* 
BUFFER_SIZE
);

1017 
nic
->
rx_desc_ršg
[
i
].
¡©us
 = 0;

1018 
nic
->
rx_desc_ršg
[
i
].
Ëngth
 = 
BUFFER_SIZE
;

1022 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TOTAL_RESET
);

1025 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_7
);

1026 
	`ou
(
nic
->
io_ba£
 + 
_3C515_TX_DOWN_LIST_PTR
, (
ušt32_t
êic->
tx_desc_ršg
);

1027 
	`ou
(
nic
->
io_ba£
 + 
_3C515_TX_UP_LIST_PTR
, (
ušt32_t
êic->
rx_desc_ršg
);

1030 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TX_ENABLE
);

1031 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_RX_ENABLE
);

1033 
nic
->
tx_šdex
 = 0;

1034 
nic
->
rx_šdex
 = 0;

1037 
»suÉ
 = 
	`hw_checksum_š™
();

1038 ià(
»suÉ
 != 0) {

1039 
	`LOG_WARNING
("H¬dw¬checksum in™Ÿliz©iÚ faed: %d, cÚtšušg w™houˆİtimiz©iÚ", 
»suÉ
);

1042 
	`LOG_DEBUG
("Hardware checksum module initialized with CPU optimization");

1046 
»suÉ
 = 
	`dma_š™
();

1047 ià(
»suÉ
 != 0) {

1048 
	`LOG_WARNING
("DMA subsy¡em in™Ÿliz©iÚ faed: %d, usšg sšgË-bufã¸mode", 
»suÉ
);

1051 
	`LOG_DEBUG
("DMA subsystem initialized with CPU-aware memory management");

1054 
dma_bufãr_poŞ_cÚfig_t
 
poŞ_cÚfig
 = {

1055 .
max_bufãrs
 = 32,

1056 .
bufãr_size
 = 
BUFFER_SIZE
,

1057 .
®ignm’t
 = 16,

1058 .
u£_locked_memÜy
 = 
Œue


1061 
»suÉ
 = 
	`dma_»gi¡”_bufãr_poŞ
(0, &
poŞ_cÚfig
);

1062 ià(
»suÉ
 != 0) {

1063 
	`LOG_WARNING
("DMA bufã¸poŞ„egi¡¿tiÚ faed: %d", 
»suÉ
);

1068 
	}
}

1077 
	$_3c515_£nd_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ën
) {

1078 
_3c515_tx_tx_desc_t
 *
desc
 = &
nic
->
tx_desc_ršg
[nic->
tx_šdex
];

1081 ià(
desc
->
¡©us
 & 
_3C515_TX_TX_DESC_COMPLETE
)  -1;

1084 
dma_äagm’t_t
 
äagm’ts
[4];

1085 
äag_couÁ
 = 
	`dma_ª®yze_·ck‘_äagm’tiÚ
(
·ck‘
, 
Ën
, 
äagm’ts
, 4);

1087 ià(
äag_couÁ
 > 1) {

1089 
	`LOG_DEBUG
("Usšg sÿ‰”-g©h” DMA fÜ %d f¿gm’ts", 
äag_couÁ
);

1091 
sg_»suÉ
 = 
	`dma_£nd_sÿ‰”_g©h”
(
nic
->
šdex
, 
·ck‘
, 
Ën
, 
äagm’ts
, 
äag_couÁ
);

1092 ià(
sg_»suÉ
 == 0) {

1094 
nic
->
tx_šdex
 = (nic->tx_šdex + 1è% 
TX_RING_SIZE
;

1097 
	`LOG_DEBUG
("Sÿ‰”-g©h” faed (%d), f®lšg backØcÚsŞid©iÚ", 
sg_»suÉ
);

1104 
	`_3c515_dma_´•¬e_bufãrs
((*)
desc
->
addr
, 
Ën
, 
çl£
);

1107 
	`memıy
((*)
desc
->
addr
, 
·ck‘
, 
Ën
);

1110 
	`_3c515_dma_com¶‘e_bufãrs
((*)
desc
->
addr
, 
Ën
, 
çl£
);

1113 
ušt8_t
 *
tx_bufãr
 = (ušt8_ˆ*)
desc
->
addr
;

1114 ià(
Ën
 >= 34) {

1115 
checksum_»suÉ
 = 
	`hw_checksum_´oûss_outbound_·ck‘
(
tx_bufãr
, 
Ën
);

1116 ià(
checksum_»suÉ
 != 0) {

1117 
	`LOG_DEBUG
("Checksum calculation completed for outbound…acket");

1122 
desc
->
Ëngth
 = 
Ën
;

1123 
desc
->
¡©us
 = 
_3C515_TX_TX_INTR_BIT
;

1126 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_START_DMA_DOWN
);

1129 
nic
->
tx_šdex
 = (nic->tx_šdex + 1è% 
TX_RING_SIZE
;

1132 
	}
}

1141 
	$_3c515_»ûive_·ck‘
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ën
) {

1142 
_3c515_tx_rx_desc_t
 *
desc
 = &
nic
->
rx_desc_ršg
[nic->
rx_šdex
];

1145 ià(!(
desc
->
¡©us
 & 
_3C515_TX_RX_DESC_COMPLETE
))  -1;

1147 ià(
desc
->
¡©us
 & 
_3C515_TX_RX_DESC_ERROR
) {

1148 
desc
->
¡©us
 = 0;

1149 
nic
->
rx_šdex
 = (nic->rx_šdex + 1è% 
RX_RING_SIZE
;

1154 *
Ën
 = 
desc
->
Ëngth
 & 
_3C515_TX_RX_DESC_LEN_MASK
;

1155 
	`_3c515_dma_´•¬e_bufãrs
((*)
desc
->
addr
, *
Ën
, 
Œue
);

1158 
	`memıy
(
bufãr
, (*)
desc
->
addr
, *
Ën
);

1161 
	`_3c515_dma_com¶‘e_bufãrs
((*)
desc
->
addr
, *
Ën
, 
Œue
);

1164 ià(*
Ën
 >= 34) {

1165 
checksum_»suÉ
 = 
	`hw_checksum_v”ify_šbound_·ck‘
(
bufãr
, *
Ën
);

1166 ià(
checksum_»suÉ
 < 0) {

1167 
	`LOG_DEBUG
("Checksum verification failed for inbound…acket");

1169 } ià(
checksum_»suÉ
 > 0) {

1170 
	`LOG_DEBUG
("Checksum verification…assed for inbound…acket");

1175 
desc
->
¡©us
 = 0;

1178 
nic
->
rx_šdex
 = (nic->rx_šdex + 1è% 
RX_RING_SIZE
;

1181 
	}
}

1187 
	$_3c515_hªdË_š‹¼u±
(
nic_šfo_t
 *
nic
) {

1188 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

1190 ià(
¡©us
 & 
_3C515_TX_STATUS_UP_COMPLETE
) {

1194 ià(
¡©us
 & 
_3C515_TX_STATUS_DOWN_COMPLETE
) {

1196 
i
 = 0; i < 
TX_RING_SIZE
; i++) {

1197 ià(
nic
->
tx_desc_ršg
[
i
].
¡©us
 & 
_3C515_TX_TX_DESC_COMPLETE
) {

1198 
nic
->
tx_desc_ršg
[
i
].
¡©us
 = 0;

1204 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_ACK_INTR
 | 
¡©us
);

1205 
	}
}

1212 
	$_3c515_check_š‹¼u±
(
nic_šfo_t
 *
nic
) {

1213 ià(!
nic
) {

1214  
ERROR_INVALID_PARAM
;

1217 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

1220 ià(
¡©us
 & (
_3C515_TX_STATUS_UP_COMPLETE
 |

1221 
_3C515_TX_STATUS_DOWN_COMPLETE
 |

1222 
_3C515_TX_STATUS_TX_COMPLETE
 |

1223 
_3C515_TX_STATUS_RX_COMPLETE
 |

1224 
_3C515_TX_STATUS_ADAPTER_FAILURE
 |

1225 
_3C515_TX_STATUS_STATS_FULL
)) {

1230 
	}
}

1238 
	$_3c515_´oûss_sšgË_ev’t
(
nic_šfo_t
 *
nic
, 
š‹¼u±_ev’t_ty³_t
 *
ev’t_ty³
) {

1239 ià(!
nic
 || !
ev’t_ty³
) {

1240  
ERROR_INVALID_PARAM
;

1243 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

1248 ià(
¡©us
 & 
_3C515_TX_STATUS_ADAPTER_FAILURE
) {

1249 *
ev’t_ty³
 = 
EVENT_TYPE_RX_ERROR
;

1250 
	`LOG_ERROR
("3C515‡dapter failure detected");

1253 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

1254 
_3C515_TX_CMD_ACK_INTR
 | 
_3C515_TX_STATUS_ADAPTER_FAILURE
);

1260 ià(
¡©us
 & 
_3C515_TX_STATUS_UP_COMPLETE
) {

1261 *
ev’t_ty³
 = 
EVENT_TYPE_DMA_COMPLETE
;

1264 
nic_3c515_cÚ‹xt_t
 *
ùx
 = (nic_3c515_cÚ‹xt_ˆ*)
nic
->
cÚ‹xt
;

1265 ià(
ùx
 && ctx->
ršg_mªag”
.
š™Ÿlized
) {

1267 
	`nic_3c515_hªdË_rx_com¶‘iÚ
(
ùx
) > 0) {

1273 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

1274 
_3C515_TX_CMD_ACK_INTR
 | 
_3C515_TX_STATUS_UP_COMPLETE
);

1280 ià(
¡©us
 & 
_3C515_TX_STATUS_DOWN_COMPLETE
) {

1281 *
ev’t_ty³
 = 
EVENT_TYPE_TX_COMPLETE
;

1284 
i
 = 0; i < 
TX_RING_SIZE
; i++) {

1285 ià(
nic
->
tx_desc_ršg
 &&

1286 (
nic
->
tx_desc_ršg
[
i
].
¡©us
 & 
_3C515_TX_TX_DESC_COMPLETE
)) {

1287 
nic
->
tx_desc_ršg
[
i
].
¡©us
 = 0;

1292 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

1293 
_3C515_TX_CMD_ACK_INTR
 | 
_3C515_TX_STATUS_DOWN_COMPLETE
);

1299 ià(
¡©us
 & 
_3C515_TX_STATUS_RX_COMPLETE
) {

1300 *
ev’t_ty³
 = 
EVENT_TYPE_RX_COMPLETE
;

1303 ià(
nic
->
İs
 &&‚ic->İs->
»ûive_·ck‘
) {

1304 
ušt8_t
 
rx_bufãr
[1514];

1305 
size_t
 
rx_Ëngth
 = (
rx_bufãr
);

1306 ià(
nic
->
İs
->
	`»ûive_·ck‘
Òic, 
rx_bufãr
, &
rx_Ëngth
) == 0) {

1308 
	`­i_´oûss_»ûived_·ck‘
(
rx_bufãr
, 
rx_Ëngth
, 
nic
->
šdex
);

1313 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

1314 
_3C515_TX_CMD_ACK_INTR
 | 
_3C515_TX_STATUS_RX_COMPLETE
);

1320 ià(
¡©us
 & 
_3C515_TX_STATUS_TX_COMPLETE
) {

1321 *
ev’t_ty³
 = 
EVENT_TYPE_TX_COMPLETE
;

1324 
nic_3c515_cÚ‹xt_t
 *
ùx
 = (nic_3c515_cÚ‹xt_ˆ*)
nic
->
cÚ‹xt
;

1325 ià(
ùx
 && ctx->
ršg_mªag”
.
š™Ÿlized
) {

1327 
	`nic_3c515_hªdË_tx_com¶‘iÚ
(
ùx
) > 0) {

1333 
	`¡©s_šüem’t_tx_·ck‘s
();

1334 
	`¡©s_add_tx_by‹s
(1514);

1337 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

1338 
_3C515_TX_CMD_ACK_INTR
 | 
_3C515_TX_STATUS_TX_COMPLETE
);

1344 ià(
¡©us
 & 
_3C515_TX_STATUS_STATS_FULL
) {

1345 *
ev’t_ty³
 = 
EVENT_TYPE_COUNTER_OVERFLOW
;

1348 ià(
nic
->
İs
 &&‚ic->İs->
g‘_¡©i¡ics
) {

1349 
pd_¡©i¡ics_t
 
hw_¡©s
;

1350 ià(
nic
->
İs
->
	`g‘_¡©i¡ics
Òic, &
hw_¡©s
) == 0) {

1353 
	`¡©s_add_rx_by‹s
(
hw_¡©s
.
by‹s_š
);

1354 
	`¡©s_add_tx_by‹s
(
hw_¡©s
.
by‹s_out
);

1356 ià(
hw_¡©s
.
·ck‘s_š
 > 0) {

1357 
	`¡©s_šüem’t_rx_·ck‘s
();

1359 ià(
hw_¡©s
.
·ck‘s_out
 > 0) {

1360 
	`¡©s_šüem’t_tx_·ck‘s
();

1362 ià(
hw_¡©s
.
”rÜs_š
 > 0 || hw_¡©s.
”rÜs_out
 > 0) {

1363 
	`¡©s_šüem’t_rx_”rÜs
();

1369 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

1370 
_3C515_TX_CMD_ACK_INTR
 | 
_3C515_TX_STATUS_STATS_FULL
);

1377 
	}
}

1384 
	$_3c515_hªdË_š‹¼u±_b©ched
(
nic_šfo_t
 *
nic
) {

1385 
š‹¼u±_m™ig©iÚ_cÚ‹xt_t
 *
im_ùx
;

1387 ià(!
nic
 || !nic->
´iv©e_d©a
) {

1388  
ERROR_INVALID_PARAM
;

1394 
im_ùx
 = (
š‹¼u±_m™ig©iÚ_cÚ‹xt_t
 *)
nic
->
´iv©e_d©a
;

1396 ià(!
	`is_š‹¼u±_m™ig©iÚ_’abËd
(
im_ùx
)) {

1398 
	`_3c515_hªdË_š‹¼u±
(
nic
);

1403  
	`´oûss_b©ched_š‹¼u±s_3c515
(
im_ùx
);

1404 
	}
}

1416 
	$_3c515_š™Ÿlize_ÿche_coh”’cy
(
nic_cÚ‹xt_t
 *
ùx
) {

1417 
coh”’cy_ª®ysis_t
 
ª®ysis
;

1418 
ch£t_d‘eùiÚ_»suÉ_t
 
ch£t_»suÉ
;

1420 ià(!
ùx
) {

1421 
	`LOG_ERROR
("Invalid NIC context for cache coherency initialization");

1425 
	`LOG_INFO
("Initializing cache coherency management for 3C515-TX...");

1428 
ª®ysis
 = 
	`³rfÜm_com¶‘e_coh”’cy_ª®ysis
();

1430 ià(
ª®ysis
.
£Ëùed_t›r
 =ğ
TIER_DISABLE_BUS_MASTER
) {

1431 
	`LOG_ERROR
("Cache coherency‡nalysis„ecommends disabling bus mastering");

1432 
	`LOG_ERROR
("3C515-TX„equires DMA operation - system incompatible");

1437 
ch£t_»suÉ
 = 
	`d‘eù_sy¡em_ch£t
();

1440 
boŞ
 
ÿche_š™_»suÉ
 = 
	`š™Ÿlize_ÿche_mªagem’t
(
ª®ysis
.
£Ëùed_t›r
);

1441 ià(!
ÿche_š™_»suÉ
) {

1442 
	`LOG_ERROR
("Failedo initialize cache management system");

1447 
boŞ
 
»cÜd_»suÉ
 = 
	`»cÜd_ch£t_‹¡_»suÉ
(&
ª®ysis
, &
ch£t_»suÉ
);

1448 ià(!
»cÜd_»suÉ
) {

1449 
	`LOG_WARNING
("Failedo„ecordest„esults in chipset database");

1453 
ùx
->
ÿche_coh”’cy_t›r
 = 
ª®ysis
.
£Ëùed_t›r
;

1454 
ùx
->
ÿche_mªagem’t_avaabË
 = 1;

1455 
ùx
->
coh”’cy_ª®ysis
 = 
ª®ysis
;

1457 
	`LOG_INFO
("Cache coherency initialized:ier %d, confidence %d%%",

1458 
ª®ysis
.
£Ëùed_t›r
,‡Çlysis.
cÚfid’û
);

1461 ià(
	`should_ofãr_³rfÜmªû_guidªû
(&
ª®ysis
)) {

1462 
	`di¥Ïy_³rfÜmªû_İpÜtun™y_ª®ysis
();

1466 
	}
}

1474 
	$_3c515_dma_´•¬e_bufãrs
(*
bufãr
, 
size_t
 
Ëngth
, 
boŞ
 
is_»ûive
) {

1475 
dma_İ”©iÚ_t
 
İ”©iÚ
;

1477 ià(!
bufãr
 || 
Ëngth
 == 0) {

1482 
İ”©iÚ
.
bufãr
 = buffer;

1483 
İ”©iÚ
.
Ëngth
 =†ength;

1484 
İ”©iÚ
.
dœeùiÚ
 = 
is_»ûive
 ? 
DMA_DIRECTION_FROM_DEVICE
 : 
DMA_DIRECTION_TO_DEVICE
;

1485 
İ”©iÚ
.
deviû_ty³
 = 
DMA_DEVICE_NETWORK
;

1488 
	`ÿche_mªagem’t_dma_´•¬e
(&
İ”©iÚ
);

1489 
	}
}

1497 
	$_3c515_dma_com¶‘e_bufãrs
(*
bufãr
, 
size_t
 
Ëngth
, 
boŞ
 
is_»ûive
) {

1498 
dma_İ”©iÚ_t
 
İ”©iÚ
;

1500 ià(!
bufãr
 || 
Ëngth
 == 0) {

1505 
İ”©iÚ
.
bufãr
 = buffer;

1506 
İ”©iÚ
.
Ëngth
 =†ength;

1507 
İ”©iÚ
.
dœeùiÚ
 = 
is_»ûive
 ? 
DMA_DIRECTION_FROM_DEVICE
 : 
DMA_DIRECTION_TO_DEVICE
;

1508 
İ”©iÚ
.
deviû_ty³
 = 
DMA_DEVICE_NETWORK
;

1511 
	`ÿche_mªagem’t_dma_com¶‘e
(&
İ”©iÚ
);

1512 
	}
}

1519 
	~"../šşude/dma_desütÜs.h
"

1522 
advªûd_dma_cÚ‹xt_t
 
	gg_advªûd_dma_cÚ‹xt
;

1523 
boŞ
 
	gg_advªûd_dma_š™Ÿlized
 = 
çl£
;

1532 
	$advªûd_dma_š™
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 
io_ba£
, 
ušt8_t
 
œq
) {

1533 ià(!
ùx
) {

1534 
	`LOG_ERROR
("Invalid DMA context for initialization");

1538 
	`LOG_INFO
("Initializing‡dvanced DMA system for 3C515-TX");

1541 
	`mem£t
(
ùx
, 0, (
advªûd_dma_cÚ‹xt_t
));

1544 
ùx
->
io_ba£
 = io_base;

1545 
ùx
->
œq
 = irq;

1548 
»suÉ
 = 
	`dma_š™_desütÜ_ršgs
(
ùx
);

1549 ià(
»suÉ
 != 0) {

1550 
	`LOG_ERROR
("FaedØš™ŸlizdesütÜ„šgs: %d", 
»suÉ
);

1551  
»suÉ
;

1555 
ùx
->
com¶‘iÚ_Œack”
.
tx_com¶‘iÚ_³ndšg
 = 
çl£
;

1556 
ùx
->
com¶‘iÚ_Œack”
.
rx_com¶‘iÚ_³ndšg
 = 
çl£
;

1557 
ùx
->
com¶‘iÚ_Œack”
.
Ï¡_tx_aùiv™y
 = 
	`g‘_sy¡em_time_ms
();

1558 
ùx
->
com¶‘iÚ_Œack”
.
Ï¡_rx_aùiv™y
 = 
	`g‘_sy¡em_time_ms
();

1561 
ùx
->
bus_ma¡”šg_’abËd
 = 
Œue
;

1562 
ùx
->
sÿ‰”_g©h”_’abËd
 = 
Œue
;

1563 
ùx
->
z”o_cİy_’abËd
 = 
Œue
;

1564 
ùx
->
ÿche_coh”’cy_’abËd
 = 
Œue
;

1567 ià(
ùx
->
ÿche_coh”’cy_’abËd
) {

1568 
ùx
->
ÿche_cÚ‹xt
 = 
	`g‘_ÿche_coh”’cy_cÚ‹xt
();

1569 ià(!
ùx
->
ÿche_cÚ‹xt
) {

1570 
	`LOG_WARNING
("Cache coherency context‚ot‡vailable");

1571 
ùx
->
ÿche_coh”’cy_’abËd
 = 
çl£
;

1576 
	`dma_»£t_³rfÜmªû_¡©s
(
ùx
);

1578 
	`LOG_INFO
("Advanced DMA system initialized successfully");

1579 
	`LOG_INFO
(" Bus mastering: %s, Scatter-gather: %s",

1580 
ùx
->
bus_ma¡”šg_’abËd
 ? "Enabled" : "Disabled",

1581 
ùx
->
sÿ‰”_g©h”_’abËd
 ? "Enabled" : "Disabled");

1582 
	`LOG_INFO
(" Zero-copy: %s, Cache coherency: %s",

1583 
ùx
->
z”o_cİy_’abËd
 ? "Enabled" : "Disabled",

1584 
ùx
->
ÿche_coh”’cy_’abËd
 ? "Enabled" : "Disabled");

1587 
	}
}

1594 
	$dma_š™_desütÜ_ršgs
(
advªûd_dma_cÚ‹xt_t
 *
ùx
) {

1595 ià(!
ùx
) {

1599 
	`LOG_DEBUG
("Initializing DMA descriptor„ings");

1602 
ùx
->
ršg_mªag”
.
tx_h—d
 = 0;

1603 
ùx
->
ršg_mªag”
.
tx_
 = 0;

1604 
ùx
->
ršg_mªag”
.
tx_couÁ
 = 0;

1606 
i
 = 0; i < 
DMA_TX_RING_SIZE
; i++) {

1607 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
i
];

1610 
	`mem£t
(
desc
, 0, (
’hªûd_tx_desc_t
));

1613 ià(
i
 =ğ
DMA_TX_RING_SIZE
 - 1) {

1614 
desc
->
Ãxt
 = (
ušt32_t
)&
ùx
->
ršg_mªag”
.
tx_ršg
[0];

1616 
desc
->
Ãxt
 = (
ušt32_t
)&
ùx
->
ršg_mªag”
.
tx_ršg
[
i
 + 1];

1620 
desc
->
äagm’ts
 = 
NULL
;

1621 
desc
->
äagm’t_couÁ
 = 0;

1622 
desc
->
coh”’t_memÜy
 = 
ùx
->
ÿche_coh”’cy_’abËd
;

1626 
ùx
->
ršg_mªag”
.
rx_h—d
 = 0;

1627 
ùx
->
ršg_mªag”
.
rx_
 = 0;

1628 
ùx
->
ršg_mªag”
.
rx_couÁ
 = 0;

1630 
i
 = 0; i < 
DMA_RX_RING_SIZE
; i++) {

1631 
’hªûd_rx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
rx_ršg
[
i
];

1634 
	`mem£t
(
desc
, 0, (
’hªûd_rx_desc_t
));

1637 ià(
i
 =ğ
DMA_RX_RING_SIZE
 - 1) {

1638 
desc
->
Ãxt
 = (
ušt32_t
)&
ùx
->
ršg_mªag”
.
rx_ršg
[0];

1640 
desc
->
Ãxt
 = (
ušt32_t
)&
ùx
->
ršg_mªag”
.
rx_ršg
[
i
 + 1];

1644 
desc
->
coh”’t_memÜy
 = 
ùx
->
ÿche_coh”’cy_’abËd
;

1645 
desc
->
z”o_cİy_–igibË
 = 
ùx
->
z”o_cİy_’abËd
;

1649 
ùx
->
ršg_mªag”
.
bufãr_size
 = 
DMA_MAX_FRAGMENT_SIZE
;

1651 
ùx
->
ršg_mªag”
.
tx_bufãrs
 = 
	`m®loc
(
DMA_TX_RING_SIZE
 * ctx->ršg_mªag”.
bufãr_size
);

1652 ià(!
ùx
->
ršg_mªag”
.
tx_bufãrs
) {

1653 
	`LOG_ERROR
("Failedo‡llocate TX buffer…ool");

1657 
ùx
->
ršg_mªag”
.
rx_bufãrs
 = 
	`m®loc
(
DMA_RX_RING_SIZE
 * ctx->ršg_mªag”.
bufãr_size
);

1658 ià(!
ùx
->
ršg_mªag”
.
rx_bufãrs
) {

1659 
	`ä“
(
ùx
->
ršg_mªag”
.
tx_bufãrs
);

1660 
	`LOG_ERROR
("Failedo‡llocate RX buffer…ool");

1665 
	`mem£t
(
ùx
->
ršg_mªag”
.
tx_bufãrs
, 0, 
DMA_TX_RING_SIZE
 * ctx->ršg_mªag”.
bufãr_size
);

1666 
	`mem£t
(
ùx
->
ršg_mªag”
.
rx_bufãrs
, 0, 
DMA_RX_RING_SIZE
 * ctx->ršg_mªag”.
bufãr_size
);

1669 
i
 = 0; i < 
DMA_TX_RING_SIZE
; i++) {

1670 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
i
];

1671 
desc
->
addr
 = (
ušt32_t
)((
ušt8_t
 *)
ùx
->
ršg_mªag”
.
tx_bufãrs
 +

1672 (
i
 * 
ùx
->
ršg_mªag”
.
bufãr_size
));

1673 
desc
->
Ëngth
 = 
ùx
->
ršg_mªag”
.
bufãr_size
;

1676 
i
 = 0; i < 
DMA_RX_RING_SIZE
; i++) {

1677 
’hªûd_rx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
rx_ršg
[
i
];

1678 
desc
->
addr
 = (
ušt32_t
)((
ušt8_t
 *)
ùx
->
ršg_mªag”
.
rx_bufãrs
 +

1679 (
i
 * 
ùx
->
ršg_mªag”
.
bufãr_size
));

1680 
desc
->
Ëngth
 = 
ùx
->
ršg_mªag”
.
bufãr_size
;

1681 
desc
->
bufãr_vœtu®
 = (
ušt8_t
 *)
ùx
->
ršg_mªag”
.
rx_bufãrs
 +

1682 (
i
 * 
ùx
->
ršg_mªag”
.
bufãr_size
);

1686 
ùx
->
ršg_mªag”
.
tx_ršg_physiÿl
 = (
ušt32_t
)ùx->ršg_mªag”.
tx_ršg
;

1687 
ùx
->
ršg_mªag”
.
rx_ršg_physiÿl
 = (
ušt32_t
)ùx->ršg_mªag”.
rx_ršg
;

1690 
ùx
->
ršg_mªag”
.
š™Ÿlized
 = 
Œue
;

1691 
ùx
->
ršg_mªag”
.
g’”©iÚ
 = 1;

1693 
	`LOG_DEBUG
("DMA descriptor„ings initialized successfully");

1694 
	`LOG_DEBUG
(" TX„šg: %d desütÜ © 0x%08X", 
DMA_TX_RING_SIZE
, 
ùx
->
ršg_mªag”
.
tx_ršg_physiÿl
);

1695 
	`LOG_DEBUG
(" RX„šg: %d desütÜ © 0x%08X", 
DMA_RX_RING_SIZE
, 
ùx
->
ršg_mªag”
.
rx_ršg_physiÿl
);

1698 
	}
}

1706 
’hªûd_tx_desc_t
 *
	$dma_®loc_tx_desütÜ
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 *
desc_šdex
) {

1707 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || !
desc_šdex
) {

1708  
NULL
;

1712 ià(
ùx
->
ršg_mªag”
.
tx_couÁ
 >ğ
DMA_TX_RING_SIZE
) {

1713 
ùx
->
³rfÜmªû_¡©s
.
tx_»Œ›s
++;

1714  
NULL
;

1718 
ušt16_t
 
šdex
 = 
ùx
->
ršg_mªag”
.
tx_h—d
;

1719 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
šdex
];

1722 ià(
desc
->
¡©us
 & 
DMA_DESC_OWNED_BY_NIC
) {

1723 
ùx
->
³rfÜmªû_¡©s
.
tx_»Œ›s
++;

1724  
NULL
;

1728 *
desc_šdex
 = 
šdex
;

1729 
ùx
->
ršg_mªag”
.
tx_h—d
 = (ùx->ršg_mªag”.tx_h—d + 1è% 
DMA_TX_RING_SIZE
;

1730 
ùx
->
ršg_mªag”
.
tx_couÁ
++;

1733 
desc
->
¡©us
 = 
DMA_DESC_OWNED_BY_HOST
;

1734 
desc
->
äagm’t_couÁ
 = 0;

1735 
desc
->
tÙ®_Ëngth
 = 0;

1736 
desc
->
time¡amp_¡¬t
 = 
	`g‘_sy¡em_time_ms
();

1737 
desc
->
»Œy_couÁ
 = 0;

1738 
desc
->
”rÜ_æags
 = 0;

1740 
ùx
->
³rfÜmªû_¡©s
.
tx_desütÜs_u£d
++;

1742 
	`LOG_TRACE
("Allocated TX descriptor %d (head‚ow %d, count %d)",

1743 
šdex
, 
ùx
->
ršg_mªag”
.
tx_h—d
, ctx->ršg_mªag”.
tx_couÁ
);

1745  
desc
;

1746 
	}
}

1756 
	$dma_£tup_sg_tx
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
’hªûd_tx_desc_t
 *
desc
,

1757 
dma_äagm’t_desc_t
 *
äagm’ts
, 
ušt16_t
 
äagm’t_couÁ
) {

1758 ià(!
ùx
 || !
desc
 || !
äagm’ts
 || 
äagm’t_couÁ
 == 0) {

1762 ià(
äagm’t_couÁ
 > 
DMA_MAX_FRAGMENTS
) {

1763 
	`LOG_ERROR
("ToØmªy f¿gm’ts: %d (max %d)", 
äagm’t_couÁ
, 
DMA_MAX_FRAGMENTS
);

1767 
	`LOG_DEBUG
("S‘tšg u°sÿ‰”-g©h” TX w™h %d f¿gm’ts", 
äagm’t_couÁ
);

1770 
ušt32_t
 
tÙ®_Ëngth
 = 0;

1771 
ušt16_t
 
i
 = 0; i < 
äagm’t_couÁ
; i++) {

1772 
tÙ®_Ëngth
 +ğ
äagm’ts
[
i
].
Ëngth
;

1775 ià(
tÙ®_Ëngth
 > 
_3C515_TX_MAX_MTU
) {

1776 
	`LOG_ERROR
("TÙ®…ack‘†’gth %dƒxûed MTU %d", 
tÙ®_Ëngth
, 
_3C515_TX_MAX_MTU
);

1781 
desc
->
addr
 = 
äagm’ts
[0].
physiÿl_addr
;

1782 
desc
->
Ëngth
 = 
äagm’ts
[0].length;

1783 
desc
->
tÙ®_Ëngth
 =otal_length;

1784 
desc
->
äagm’t_couÁ
 = fragment_count;

1786 ià(
äagm’t_couÁ
 == 1) {

1788 
desc
->
¡©us
 |ğ
DMA_DESC_FIRST_FRAG
 | 
DMA_DESC_LAST_FRAG
;

1789 
desc
->
äagm’ts
 = 
NULL
;

1792 
desc
->
¡©us
 |ğ
DMA_DESC_FIRST_FRAG
;

1795 
desc
->
äagm’ts
 = 
	`m®loc
((
dma_äagm’t_desc_t
è* (
äagm’t_couÁ
 - 1));

1796 ià(!
desc
->
äagm’ts
) {

1797 
	`LOG_ERROR
("Failedo‡llocate fragment storage");

1801 
ušt16_t
 
i
 = 1; i < 
äagm’t_couÁ
; i++) {

1802 
desc
->
äagm’ts
[
i
-1] = fragments[i];

1803 ià(
i
 =ğ
äagm’t_couÁ
 - 1) {

1804 
desc
->
äagm’ts
[
i
-1].
æags
 |ğ
DMA_DESC_LAST_FRAG
;

1805 
desc
->
äagm’ts
[
i
-1].
Ãxt
 = 
NULL
;

1807 
desc
->
äagm’ts
[
i
-1].
Ãxt
 = &desc->fragments[i];

1811 
ùx
->
³rfÜmªû_¡©s
.
sg_tx_·ck‘s
++;

1812 
ùx
->
³rfÜmªû_¡©s
.
tÙ®_äagm’ts
 +ğ
äagm’t_couÁ
;

1816 ià(
ùx
->
ÿche_coh”’cy_’abËd
) {

1817 
coh”’cy_»suÉ
 = 
	`dma_´•¬e_coh”’t_bufãr
(
ùx
, (*)
desc
->
addr
,

1818 
desc
->
Ëngth
, 0);

1819 ià(
coh”’cy_»suÉ
 != 0) {

1820 
	`LOG_WARNING
("Cachcoh”’cy…»·¿tiÚ faed: %d", 
coh”’cy_»suÉ
);

1825 
desc
->
¡©us
 |ğ
DMA_DESC_OWNED_BY_NIC
 | 
DMA_DESC_INTERRUPT
;

1827 
ùx
->
³rfÜmªû_¡©s
.
tx_by‹s_Œªsã¼ed
 +ğ
tÙ®_Ëngth
;

1829 
	`LOG_TRACE
("Scatter-gather TX setup complete: %d fragments, %dotal bytes",

1830 
äagm’t_couÁ
, 
tÙ®_Ëngth
);

1833 
	}
}

1841 
	$dma_check_tx_com¶‘iÚ
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 *
com¶‘ed_mask
) {

1842 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || !
com¶‘ed_mask
) {

1846 
com¶‘ed_couÁ
 = 0;

1847 *
com¶‘ed_mask
 = 0;

1850 
ušt16_t
 
check_šdex
 = 
ùx
->
ršg_mªag”
.
tx_
;

1851 
i
 = 0; i < 
ùx
->
ršg_mªag”
.
tx_couÁ
; i++) {

1852 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
check_šdex
];

1855 ià((
desc
->
¡©us
 & 
DMA_DESC_OWNED_BY_NIC
) == 0) {

1857 *
com¶‘ed_mask
 |ğ(1 << 
check_šdex
);

1858 
com¶‘ed_couÁ
++;

1861 
desc
->
time¡amp_com¶‘e
 = 
	`g‘_sy¡em_time_ms
();

1864 ià(
desc
->
¡©us
 & 
DMA_DESC_ERROR_MASK
) {

1865 
desc
->
”rÜ_æags
 = desc->
¡©us
;

1866 
ùx
->
³rfÜmªû_¡©s
.
dma_”rÜs
++;

1867 
	`LOG_WARNING
("TX descriptor %d completed withƒrrors: 0x%08X",

1868 
check_šdex
, 
desc
->
¡©us
);

1872 
check_šdex
 = (check_šdex + 1è% 
DMA_TX_RING_SIZE
;

1875 ià(
com¶‘ed_couÁ
 > 0) {

1876 
ùx
->
com¶‘iÚ_Œack”
.
Ï¡_tx_aùiv™y
 = 
	`g‘_sy¡em_time_ms
();

1877 
	`LOG_TRACE
("Found %d com¶‘ed TX desütÜs", 
com¶‘ed_couÁ
);

1880  
com¶‘ed_couÁ
;

1881 
	}
}

1889 
	$dma_hªdË_tx_com¶‘iÚ
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 
desc_šdex
) {

1890 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || 
desc_šdex
 >ğ
DMA_TX_RING_SIZE
) {

1894 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
desc_šdex
];

1896 
	`LOG_TRACE
("Hªdlšg TX com¶‘iÚ fÜ desütÜ %d", 
desc_šdex
);

1899 ià(
ùx
->
ÿche_coh”’cy_’abËd
) {

1900 
coh”’cy_»suÉ
 = 
	`dma_com¶‘e_coh”’t_bufãr
(
ùx
, (*)
desc
->
addr
,

1901 
desc
->
Ëngth
, 0);

1902 ià(
coh”’cy_»suÉ
 != 0) {

1903 
	`LOG_WARNING
("Cachcoh”’cy com¶‘iÚ faed: %d", 
coh”’cy_»suÉ
);

1908 ià(
desc
->
äagm’ts
) {

1909 
	`ä“
(
desc
->
äagm’ts
);

1910 
desc
->
äagm’ts
 = 
NULL
;

1914 ià(
desc
->
äagm’t_couÁ
 > 1) {

1915 
ùx
->
³rfÜmªû_¡©s
.
avg_äagm’ts_³r_·ck‘
 =

1916 (
ùx
->
³rfÜmªû_¡©s
.
avg_äagm’ts_³r_·ck‘
 + 
desc
->
äagm’t_couÁ
) / 2;

1920 ià(
ùx
->
com¶‘iÚ_Œack”
.
tx_com¶‘iÚ_hªdËr
) {

1921 
ùx
->
com¶‘iÚ_Œack”
.
	`tx_com¶‘iÚ_hªdËr
(
desc
);

1925 ià(
desc_šdex
 =ğ
ùx
->
ršg_mªag”
.
tx_
) {

1926 
ùx
->
ršg_mªag”
.
tx_
 = (ùx->ršg_mªag”.tx_ + 1è% 
DMA_TX_RING_SIZE
;

1927 
ùx
->
ršg_mªag”
.
tx_couÁ
--;

1930 
	`LOG_TRACE
("TX descriptor %d completion handled (tail‚ow %d, count %d)",

1931 
desc_šdex
, 
ùx
->
ršg_mªag”
.
tx_
, ctx->ršg_mªag”.
tx_couÁ
);

1934 
	}
}

1941 
ušt32_t
 
	$dma_check_timeouts
(
advªûd_dma_cÚ‹xt_t
 *
ùx
) {

1942 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
) {

1946 
ušt32_t
 
timeout_mask
 = 0;

1947 
ušt32_t
 
cu¼’t_time
 = 
	`g‘_sy¡em_time_ms
();

1950 
ušt16_t
 
check_šdex
 = 
ùx
->
ršg_mªag”
.
tx_
;

1951 
i
 = 0; i < 
ùx
->
ršg_mªag”
.
tx_couÁ
; i++) {

1952 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
check_šdex
];

1955 ià((
desc
->
¡©us
 & 
DMA_DESC_OWNED_BY_NIC
) &&

1956 ((
cu¼’t_time
 - 
desc
->
time¡amp_¡¬t
è> 
DMA_TIMEOUT_TX
)) {

1957 
timeout_mask
 |ğ(1 << 
check_šdex
);

1958 
desc
->
”rÜ_æags
 |ğ
DMA_COMPLETION_TIMEOUT
;

1959 
ùx
->
³rfÜmªû_¡©s
.
tx_timeouts
++;

1961 
	`LOG_WARNING
("TX descriptor %dimed out (started‡t %d,‚ow %d)",

1962 
check_šdex
, 
desc
->
time¡amp_¡¬t
, 
cu¼’t_time
);

1965 
check_šdex
 = (check_šdex + 1è% 
DMA_TX_RING_SIZE
;

1969 
check_šdex
 = 
ùx
->
ršg_mªag”
.
rx_
;

1970 
i
 = 0; i < 
ùx
->
ršg_mªag”
.
rx_couÁ
; i++) {

1971 
’hªûd_rx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
rx_ršg
[
check_šdex
];

1974 ià((
desc
->
¡©us
 & 
DMA_DESC_OWNED_BY_NIC
) &&

1975 ((
cu¼’t_time
 - 
desc
->
»ûive_time¡amp
è> 
DMA_TIMEOUT_RX
)) {

1976 
timeout_mask
 |ğ(1 << (16 + 
check_šdex
));

1977 
desc
->
”rÜ_æags
 |ğ
DMA_COMPLETION_TIMEOUT
;

1978 
ùx
->
³rfÜmªû_¡©s
.
rx_timeouts
++;

1980 
	`LOG_WARNING
("RX desütÜ %dimed out", 
check_šdex
);

1983 
check_šdex
 = (check_šdex + 1è% 
DMA_RX_RING_SIZE
;

1987 ià(
timeout_mask
 & 0xFFFF) {

1988 
ùx
->
com¶‘iÚ_Œack”
.
tx_timeout_couÁ
++;

1990 ià(
timeout_mask
 & 0xFFFF0000) {

1991 
ùx
->
com¶‘iÚ_Œack”
.
rx_timeout_couÁ
++;

1994  
timeout_mask
;

1995 
	}
}

2003 
	$dma_»cov”_tx_timeout
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 
desc_šdex
) {

2004 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || 
desc_šdex
 >ğ
DMA_TX_RING_SIZE
) {

2008 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
desc_šdex
];

2010 
	`LOG_WARNING
("Recov”šg from TXimeouˆÚ desütÜ %d", 
desc_šdex
);

2013 
¡®l_»suÉ
 = 
	`dma_¡®l_’gšes
(
ùx
, 
Œue
, 
çl£
);

2014 ià(
¡®l_»suÉ
 != 0) {

2015 
	`LOG_ERROR
("FaedØ¡®ÈTXƒngšfÜimeouˆ»cov”y: %d", 
¡®l_»suÉ
);

2016  
¡®l_»suÉ
;

2020 
desc
->
¡©us
 &ğ~
DMA_DESC_OWNED_BY_NIC
;

2021 
desc
->
”rÜ_æags
 |ğ
DMA_COMPLETION_ABORTED
;

2022 
desc
->
»Œy_couÁ
++;

2025 ià(
ùx
->
ÿche_coh”’cy_’abËd
) {

2026 
	`dma_com¶‘e_coh”’t_bufãr
(
ùx
, (*)
desc
->
addr
, desc->
Ëngth
, 0);

2030 ià(
desc
->
äagm’ts
) {

2031 
	`ä“
(
desc
->
äagm’ts
);

2032 
desc
->
äagm’ts
 = 
NULL
;

2036 
ùx
->
³rfÜmªû_¡©s
.
tx_»Œ›s
++;

2039 
un¡®l_»suÉ
 = 
	`dma_un¡®l_’gšes
(
ùx
, 
Œue
, 
çl£
);

2040 ià(
un¡®l_»suÉ
 != 0) {

2041 
	`LOG_ERROR
("FaedØun¡®ÈTXƒngšaá”imeouˆ»cov”y: %d", 
un¡®l_»suÉ
);

2045 ià(
desc_šdex
 =ğ
ùx
->
ršg_mªag”
.
tx_
) {

2046 
ùx
->
ršg_mªag”
.
tx_
 = (ùx->ršg_mªag”.tx_ + 1è% 
DMA_TX_RING_SIZE
;

2047 
ùx
->
ršg_mªag”
.
tx_couÁ
--;

2050 
	`LOG_INFO
("TXimeouˆ»cov”y com¶‘ed fÜ desütÜ %d", 
desc_šdex
);

2053 
	}
}

2062 
boŞ
 
	$dma_is_z”o_cİy_tx_–igibË
(cÚ¡ *
·ck‘_d©a
, 
ušt32_t
 
·ck‘_Ëngth
,

2063 
ušt32_t
 
®ignm’t_»quœem’t
) {

2064 ià(!
·ck‘_d©a
 || 
·ck‘_Ëngth
 == 0) {

2065  
çl£
;

2069 ià(((
ušt32_t
)
·ck‘_d©a
 % 
®ignm’t_»quœem’t
) != 0) {

2070  
çl£
;

2074 ià(
·ck‘_Ëngth
 < 
_3C515_TX_MIN_PACKET_SIZE
 ||…ack‘_Ëngth > 
_3C515_TX_MAX_MTU
) {

2075  
çl£
;

2079 
ušt32_t
 
addr
 = (ušt32_t)
·ck‘_d©a
;

2080 ià(
addr
 > 0xFFFFFF) {

2081  
çl£
;

2084  
Œue
;

2085 
	}
}

2095 
	$dma_£tup_z”o_cİy_tx
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
’hªûd_tx_desc_t
 *
desc
,

2096 cÚ¡ *
·ck‘_d©a
, 
ušt32_t
 
·ck‘_Ëngth
) {

2097 ià(!
ùx
 || !
desc
 || !
·ck‘_d©a
 || 
·ck‘_Ëngth
 == 0) {

2101 ià(!
	`dma_is_z”o_cİy_tx_–igibË
(
·ck‘_d©a
, 
·ck‘_Ëngth
, 
DMA_BUFFER_ALIGN
)) {

2102 
	`LOG_DEBUG
("Packet‚otƒligible for zero-copy TX");

2106 
	`LOG_DEBUG
("Setting up zero-copy TX operation");

2109 
desc
->
addr
 = (
ušt32_t
)
·ck‘_d©a
;

2110 
desc
->
Ëngth
 = 
·ck‘_Ëngth
;

2111 
desc
->
tÙ®_Ëngth
 = 
·ck‘_Ëngth
;

2112 
desc
->
äagm’t_couÁ
 = 1;

2113 
desc
->
äagm’ts
 = 
NULL
;

2116 ià(
ùx
->
ÿche_coh”’cy_’abËd
) {

2117 
coh”’cy_»suÉ
 = 
	`dma_´•¬e_coh”’t_bufãr
(
ùx
, (*)
·ck‘_d©a
,

2118 
·ck‘_Ëngth
, 0);

2119 ià(
coh”’cy_»suÉ
 != 0) {

2120 
	`LOG_WARNING
("Cache coherency…reparation failed for zero-copy TX: %d",

2121 
coh”’cy_»suÉ
);

2126 
desc
->
¡©us
 |ğ
DMA_DESC_OWNED_BY_NIC
 | 
DMA_DESC_INTERRUPT
 |

2127 
DMA_DESC_FIRST_FRAG
 | 
DMA_DESC_LAST_FRAG
;

2130 
ùx
->
³rfÜmªû_¡©s
.
z”o_cİy_tx
++;

2131 
ùx
->
³rfÜmªû_¡©s
.
tx_by‹s_Œªsã¼ed
 +ğ
·ck‘_Ëngth
;

2133 
	`LOG_TRACE
("Z”o-cİy TX s‘u°com¶‘e: %d by‹ © 0x%08X", 
·ck‘_Ëngth
, 
desc
->
addr
);

2136 
	}
}

2144 
	$dma_upd©e_³rfÜmªû_¡©s
(
advªûd_dma_cÚ‹xt_t
 *
ùx
,

2145 
ušt32_t
 
tx_by‹s
, ušt32_ˆ
rx_by‹s
) {

2146 ià(!
ùx
) {

2150 
ùx
->
³rfÜmªû_¡©s
.
tx_by‹s_Œªsã¼ed
 +ğ
tx_by‹s
;

2151 
ùx
->
³rfÜmªû_¡©s
.
rx_by‹s_Œªsã¼ed
 +ğ
rx_by‹s
;

2154 ià(
ùx
->
ÿche_coh”’cy_’abËd
) {

2155 
ùx
->
³rfÜmªû_¡©s
.
ıu_cyşes_§ved
 +ğ(
tx_by‹s
 + 
rx_by‹s
) / 4;

2159 
ùx
->
³rfÜmªû_¡©s
.
bus_utiz©iÚ
 =

2160 ((
ùx
->
³rfÜmªû_¡©s
.
tx_by‹s_Œªsã¼ed
 + ctx->³rfÜmªû_¡©s.
rx_by‹s_Œªsã¼ed
) * 100) /

2162 
	}
}

2168 
	$dma_»£t_³rfÜmªû_¡©s
(
advªûd_dma_cÚ‹xt_t
 *
ùx
) {

2169 ià(!
ùx
) {

2173 
	`mem£t
(&
ùx
->
³rfÜmªû_¡©s
, 0, (
dma_³rfÜmªû_¡©s_t
));

2174 
	`LOG_DEBUG
("DMA…erformance statistics„eset");

2175 
	}
}

2184 
	$dma_g‘_³rfÜmªû_»pÜt
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, *
bufãr
, 
size_t
 
bufãr_size
) {

2185 ià(!
ùx
 || !
bufãr
 || 
bufãr_size
 < 512) {

2189 
wr™‹n
 = 0;

2191 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2194 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2195 "TX DesütÜ U£d: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
tx_desütÜs_u£d
);

2196 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2197 "RX DesütÜ U£d: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
rx_desütÜs_u£d
);

2198 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2199 "TX By‹ T¿nsã¼ed: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
tx_by‹s_Œªsã¼ed
);

2200 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2201 "RX By‹ T¿nsã¼ed: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
rx_by‹s_Œªsã¼ed
);

2203 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2205 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2206 "SG TX Pack‘s: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
sg_tx_·ck‘s
);

2207 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2208 "SG RX Pack‘s: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
sg_rx_·ck‘s
);

2209 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2210 "TÙ® F¿gm’ts: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
tÙ®_äagm’ts
);

2211 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2212 "Avg F¿gm’ts/Pack‘: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
avg_äagm’ts_³r_·ck‘
);

2214 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2216 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2217 "Z”o-Cİy TX: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
z”o_cİy_tx
);

2218 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2219 "Z”o-Cİy RX: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
z”o_cİy_rx
);

2221 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2223 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2224 "TX Timeouts: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
tx_timeouts
);

2225 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2226 "RX Timeouts: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
rx_timeouts
);

2227 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2228 "TX R‘r›s: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
tx_»Œ›s
);

2229 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2230 "RX R‘r›s: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
rx_»Œ›s
);

2231 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2232 "DMA E¼Üs: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
dma_”rÜs
);

2234 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2236 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2237 "Bu Utiz©iÚ: %u%%\n", 
ùx
->
³rfÜmªû_¡©s
.
bus_utiz©iÚ
);

2238 
wr™‹n
 +ğ
	`¢´štf
(
bufãr
 + wr™‹n, 
bufãr_size
 - written,

2239 "CPU Cyşe Saved: %u\n", 
ùx
->
³rfÜmªû_¡©s
.
ıu_cyşes_§ved
);

2241  
wr™‹n
;

2242 
	}
}

2252 
	$advªûd_dma_ş—nup
(
advªûd_dma_cÚ‹xt_t
 *
ùx
) {

2253 ià(!
ùx
) {

2257 
	`LOG_INFO
("Cleaning up‡dvanced DMA system");

2260 
	`dma_¡İ_Œªsãr
(
ùx
, 
Œue
,rue);

2263 ià(
ùx
->
ršg_mªag”
.
tx_bufãrs
) {

2264 
	`ä“
(
ùx
->
ršg_mªag”
.
tx_bufãrs
);

2265 
ùx
->
ršg_mªag”
.
tx_bufãrs
 = 
NULL
;

2268 ià(
ùx
->
ršg_mªag”
.
rx_bufãrs
) {

2269 
	`ä“
(
ùx
->
ršg_mªag”
.
rx_bufãrs
);

2270 
ùx
->
ršg_mªag”
.
rx_bufãrs
 = 
NULL
;

2274 
i
 = 0; i < 
DMA_TX_RING_SIZE
; i++) {

2275 
’hªûd_tx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
tx_ršg
[
i
];

2276 ià(
desc
->
äagm’ts
) {

2277 
	`ä“
(
desc
->
äagm’ts
);

2278 
desc
->
äagm’ts
 = 
NULL
;

2283 
ùx
->
ršg_mªag”
.
š™Ÿlized
 = 
çl£
;

2284 
ùx
->
bus_ma¡”šg_’abËd
 = 
çl£
;

2285 
ùx
->
sÿ‰”_g©h”_’abËd
 = 
çl£
;

2286 
ùx
->
z”o_cİy_’abËd
 = 
çl£
;

2287 
ùx
->
ÿche_coh”’cy_’abËd
 = 
çl£
;

2289 
	`LOG_INFO
("Advanced DMA system cleanup completed");

2290 
	}
}

2298 
’hªûd_rx_desc_t
 *
	$dma_®loc_rx_desütÜ
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 *
desc_šdex
) {

2299 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || !
desc_šdex
) {

2300  
NULL
;

2304 ià(
ùx
->
ršg_mªag”
.
rx_couÁ
 >ğ
DMA_RX_RING_SIZE
) {

2305 
ùx
->
³rfÜmªû_¡©s
.
rx_»Œ›s
++;

2306  
NULL
;

2310 
ušt16_t
 
šdex
 = 
ùx
->
ršg_mªag”
.
rx_h—d
;

2311 
’hªûd_rx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
rx_ršg
[
šdex
];

2314 ià(
desc
->
¡©us
 & 
DMA_DESC_OWNED_BY_NIC
) {

2315 
ùx
->
³rfÜmªû_¡©s
.
rx_»Œ›s
++;

2316  
NULL
;

2320 *
desc_šdex
 = 
šdex
;

2321 
ùx
->
ršg_mªag”
.
rx_h—d
 = (ùx->ršg_mªag”.rx_h—d + 1è% 
DMA_RX_RING_SIZE
;

2322 
ùx
->
ršg_mªag”
.
rx_couÁ
++;

2325 
desc
->
¡©us
 = 
DMA_DESC_OWNED_BY_HOST
;

2326 
desc
->
»ûived_Ëngth
 = 0;

2327 
desc
->
»ûive_time¡amp
 = 
	`g‘_sy¡em_time_ms
();

2328 
desc
->
”rÜ_æags
 = 0;

2329 
desc
->
»Œy_couÁ
 = 0;

2331 
ùx
->
³rfÜmªû_¡©s
.
rx_desütÜs_u£d
++;

2333 
	`LOG_TRACE
("Allocated RX descriptor %d (head‚ow %d, count %d)",

2334 
šdex
, 
ùx
->
ršg_mªag”
.
rx_h—d
, ctx->ršg_mªag”.
rx_couÁ
);

2336  
desc
;

2337 
	}
}

2345 
	$dma_check_rx_com¶‘iÚ
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 *
com¶‘ed_mask
) {

2346 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || !
com¶‘ed_mask
) {

2350 
com¶‘ed_couÁ
 = 0;

2351 *
com¶‘ed_mask
 = 0;

2354 
ušt16_t
 
check_šdex
 = 
ùx
->
ršg_mªag”
.
rx_
;

2355 
i
 = 0; i < 
ùx
->
ršg_mªag”
.
rx_couÁ
; i++) {

2356 
’hªûd_rx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
rx_ršg
[
check_šdex
];

2359 ià((
desc
->
¡©us
 & 
DMA_DESC_OWNED_BY_NIC
) == 0) {

2361 *
com¶‘ed_mask
 |ğ(1 << 
check_šdex
);

2362 
com¶‘ed_couÁ
++;

2365 
desc
->
»ûived_Ëngth
 = desc->
¡©us
 & 
_3C515_TX_RX_DESC_LEN_MASK
;

2368 ià(
desc
->
¡©us
 & 
DMA_DESC_ERROR_MASK
) {

2369 
desc
->
”rÜ_æags
 = desc->
¡©us
;

2370 
ùx
->
³rfÜmªû_¡©s
.
dma_”rÜs
++;

2371 
	`LOG_WARNING
("RX descriptor %d completed withƒrrors: 0x%08X",

2372 
check_šdex
, 
desc
->
¡©us
);

2376 
check_šdex
 = (check_šdex + 1è% 
DMA_RX_RING_SIZE
;

2379 ià(
com¶‘ed_couÁ
 > 0) {

2380 
ùx
->
com¶‘iÚ_Œack”
.
Ï¡_rx_aùiv™y
 = 
	`g‘_sy¡em_time_ms
();

2381 
	`LOG_TRACE
("Found %d com¶‘ed RX desütÜs", 
com¶‘ed_couÁ
);

2384  
com¶‘ed_couÁ
;

2385 
	}
}

2393 
	$dma_hªdË_rx_com¶‘iÚ
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 
desc_šdex
) {

2394 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || 
desc_šdex
 >ğ
DMA_RX_RING_SIZE
) {

2398 
’hªûd_rx_desc_t
 *
desc
 = &
ùx
->
ršg_mªag”
.
rx_ršg
[
desc_šdex
];

2400 
	`LOG_TRACE
("Hªdlšg RX com¶‘iÚ fÜ desütÜ %d", 
desc_šdex
);

2403 ià(
ùx
->
ÿche_coh”’cy_’abËd
) {

2404 
coh”’cy_»suÉ
 = 
	`dma_com¶‘e_coh”’t_bufãr
(
ùx
, 
desc
->
bufãr_vœtu®
,

2405 
desc
->
»ûived_Ëngth
, 1);

2406 ià(
coh”’cy_»suÉ
 != 0) {

2407 
	`LOG_WARNING
("Cachcoh”’cy com¶‘iÚ faed: %d", 
coh”’cy_»suÉ
);

2412 
ùx
->
³rfÜmªû_¡©s
.
rx_by‹s_Œªsã¼ed
 +ğ
desc
->
»ûived_Ëngth
;

2415 ià(
ùx
->
com¶‘iÚ_Œack”
.
rx_com¶‘iÚ_hªdËr
) {

2416 
ùx
->
com¶‘iÚ_Œack”
.
	`rx_com¶‘iÚ_hªdËr
(
desc
);

2420 
desc
->
¡©us
 = 
DMA_DESC_OWNED_BY_NIC
;

2423 ià(
desc_šdex
 =ğ
ùx
->
ršg_mªag”
.
rx_
) {

2424 
ùx
->
ršg_mªag”
.
rx_
 = (ùx->ršg_mªag”.rx_ + 1è% 
DMA_RX_RING_SIZE
;

2425 
ùx
->
ršg_mªag”
.
rx_couÁ
--;

2428 
	`LOG_TRACE
("RX descriptor %d completion handled (tail‚ow %d, count %d)",

2429 
desc_šdex
, 
ùx
->
ršg_mªag”
.
rx_
, ctx->ršg_mªag”.
rx_couÁ
);

2432 
	}
}

2435 
dma_¡®l_’gšes
(
ušt16_t
 
io_ba£
, 
boŞ
 
tx_¡®l
, boŞ 
rx_¡®l
);

2436 
dma_un¡®l_’gšes
(
ušt16_t
 
io_ba£
, 
boŞ
 
tx_un¡®l
, boŞ 
rx_un¡®l
);

2437 
dma_¡¬t_Œªsãr
(
ušt16_t
 
io_ba£
, 
boŞ
 
tx_¡¬t
, boŞ 
rx_¡¬t
);

2438 
dma_¡İ_Œªsãr
(
ušt16_t
 
io_ba£
, 
boŞ
 
tx_¡İ
, boŞ 
rx_¡İ
);

2439 
dma_g‘_’gše_¡©us
(
ušt16_t
 
io_ba£
, 
ušt32_t
 *
tx_¡©us
, ušt32_ˆ*
rx_¡©us
);

2440 
dma_´•¬e_coh”’t_bufãr
(*
bufãr
, 
ušt32_t
 
Ëngth
, 
dœeùiÚ
);

2441 
dma_com¶‘e_coh”’t_bufãr
(*
bufãr
, 
ušt32_t
 
Ëngth
, 
dœeùiÚ
);

2450 
	$dma_¡®l_’gšes
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
boŞ
 
tx_¡®l
, boŞ 
rx_¡®l
) {

2451 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
) {

2455  
	`dma_¡®l_’gšes
(
ùx
->
io_ba£
, 
tx_¡®l
, 
rx_¡®l
);

2456 
	}
}

2465 
	$dma_un¡®l_’gšes
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
boŞ
 
tx_un¡®l
, boŞ 
rx_un¡®l
) {

2466 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
) {

2470  
	`dma_un¡®l_’gšes
(
ùx
->
io_ba£
, 
tx_un¡®l
, 
rx_un¡®l
);

2471 
	}
}

2480 
	$dma_¡¬t_Œªsãr
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
boŞ
 
tx_¡¬t
, boŞ 
rx_¡¬t
) {

2481 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
) {

2485  
	`dma_¡¬t_Œªsãr
(
ùx
->
io_ba£
, 
tx_¡¬t
, 
rx_¡¬t
);

2486 
	}
}

2495 
	$dma_¡İ_Œªsãr
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
boŞ
 
tx_¡İ
, boŞ 
rx_¡İ
) {

2496 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
) {

2501 
	`_3C515_TX_SELECT_WINDOW
(
ùx
->
io_ba£
, 
_3C515_TX_WINDOW_7
);

2503 ià(
tx_¡İ
) {

2504 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TX_DISABLE
);

2507 ià(
rx_¡İ
) {

2508 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_RX_DISABLE
);

2512 
	}
}

2521 
	$dma_g‘_’gše_¡©us
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, 
ušt32_t
 *
tx_¡©us
, ušt32_ˆ*
rx_¡©us
) {

2522 ià(!
ùx
 || !ùx->
ršg_mªag”
.
š™Ÿlized
 || !
tx_¡©us
 || !
rx_¡©us
) {

2526  
	`dma_g‘_’gše_¡©us
(
ùx
->
io_ba£
, 
tx_¡©us
, 
rx_¡©us
);

2527 
	}
}

2537 
	$dma_´•¬e_coh”’t_bufãr
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, *
bufãr
,

2538 
ušt32_t
 
Ëngth
, 
dœeùiÚ
) {

2539 ià(!
ùx
 || !
bufãr
 || 
Ëngth
 == 0) {

2543 ià(!
ùx
->
ÿche_coh”’cy_’abËd
) {

2547  
	`dma_´•¬e_coh”’t_bufãr
(
bufãr
, 
Ëngth
, 
dœeùiÚ
);

2548 
	}
}

2558 
	$dma_com¶‘e_coh”’t_bufãr
(
advªûd_dma_cÚ‹xt_t
 *
ùx
, *
bufãr
,

2559 
ušt32_t
 
Ëngth
, 
dœeùiÚ
) {

2560 ià(!
ùx
 || !
bufãr
 || 
Ëngth
 == 0) {

2564 ià(!
ùx
->
ÿche_coh”’cy_’abËd
) {

2568  
	`dma_com¶‘e_coh”’t_bufãr
(
bufãr
, 
Ëngth
, 
dœeùiÚ
);

2569 
	}
}

2579 
	$dma_cÚsŞid©e_äagm’ts
(
dma_äagm’t_desc_t
 *
äagm’ts
, 
ušt16_t
 
äagm’t_couÁ
,

2580 *
de¡_bufãr
, 
ušt32_t
 
de¡_size
) {

2581 ià(!
äagm’ts
 || 
äagm’t_couÁ
 =ğ0 || !
de¡_bufãr
 || 
de¡_size
 == 0) {

2585 
ušt32_t
 
tÙ®_by‹s
 = 0;

2586 
ušt8_t
 *
de¡
 = (ušt8_ˆ*)
de¡_bufãr
;

2588 
ušt16_t
 
i
 = 0; i < 
äagm’t_couÁ
; i++) {

2589 ià(
tÙ®_by‹s
 + 
äagm’ts
[
i
].
Ëngth
 > 
de¡_size
) {

2590 
	`LOG_WARNING
("Fragment consolidation wouldƒxceed buffer size");

2595 
	`memıy
(
de¡
 + 
tÙ®_by‹s
, (*)
äagm’ts
[
i
].
physiÿl_addr
, f¿gm’ts[i].
Ëngth
);

2596 
tÙ®_by‹s
 +ğ
äagm’ts
[
i
].
Ëngth
;

2599 
	`LOG_TRACE
("CÚsŞid©ed %d f¿gm’t štØ%d by‹s", 
äagm’t_couÁ
, 
tÙ®_by‹s
);

2601  
tÙ®_by‹s
;

2602 
	}
}

2608 
advªûd_dma_cÚ‹xt_t
 *
	$g‘_advªûd_dma_cÚ‹xt
() {

2609  
g_advªûd_dma_š™Ÿlized
 ? &
g_advªûd_dma_cÚ‹xt
 : 
NULL
;

2610 
	}
}

2618 
	$š™Ÿlize_glob®_advªûd_dma
(
ušt16_t
 
io_ba£
, 
ušt8_t
 
œq
) {

2619 ià(
g_advªûd_dma_š™Ÿlized
) {

2620 
	`LOG_WARNING
("Advanced DMA‡lready initialized, cleaning up first");

2621 
	`advªûd_dma_ş—nup
(&
g_advªûd_dma_cÚ‹xt
);

2622 
g_advªûd_dma_š™Ÿlized
 = 
çl£
;

2625 
»suÉ
 = 
	`advªûd_dma_š™
(&
g_advªûd_dma_cÚ‹xt
, 
io_ba£
, 
œq
);

2626 ià(
»suÉ
 == 0) {

2627 
g_advªûd_dma_š™Ÿlized
 = 
Œue
;

2628 
	`LOG_INFO
("Global‡dvanced DMA system initialized");

2631  
»suÉ
;

2632 
	}
}

2646 
	$mii_»ad_»gi¡”
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 
phy_addr
, ušt8_ˆ
»g_addr
) {

2647 
ušt16_t
 
v®ue
 = 0;

2648 
i
;

2650 ià(!
ùx
) {

2651 
	`LOG_ERROR
("Invalid context for MII„ead");

2656 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_SELECT_WINDOW
 | 
_3C515_TX_WINDOW_4
);

2657 
	`d–ay_mli£cÚds
(1);

2660 
i
 = 0; i < 32; i++) {

2661 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
);

2662 
	`ud–ay
(1);

2663 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2664 
	`ud–ay
(1);

2665 }\
n


2666  \
n
 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
);

2667 
	`ud–ay
(1);

2668 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2669 
	`ud–ay
(1);

2671 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
);

2672 
	`ud–ay
(1);

2673 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2674 
	`ud–ay
(1);

2677 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
);

2678 
	`ud–ay
(1);

2679 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2680 
	`ud–ay
(1);

2682 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
);

2683 
	`ud–ay
(1);

2684 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2685 
	`ud–ay
(1);

2688 
i
 = 4; i >= 0; i--) {

2689 
ušt16_t
 
b™
 = (
phy_addr
 & (1 << 
i
)è? 
PHY_CTRL_MGMT_DATA
 : 0;

2690 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
);

2691 
	`ud–ay
(1);

2692 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2693 
	`ud–ay
(1);

2697 
i
 = 4; i >= 0; i--) {

2698 
ušt16_t
 
b™
 = (
»g_addr
 & (1 << 
i
)è? 
PHY_CTRL_MGMT_DATA
 : 0;

2699 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
);

2700 
	`ud–ay
(1);

2701 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2702 
	`ud–ay
(1);

2706 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 0);

2707 
	`ud–ay
(1);

2708 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_CLK
);

2709 
	`ud–ay
(1);

2711 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 0);

2712 
	`ud–ay
(1);

2713 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_CLK
);

2714 
	`ud–ay
(1);

2717 
i
 = 15; i >= 0; i--) {

2718 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 0);

2719 
	`ud–ay
(1);

2721 
ušt16_t
 
¡©us
 = 
	`šw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_STATUS
);

2722 ià(
¡©us
 & 
PHY_CTRL_MGMT_DATA
) {

2723 
v®ue
 |ğ(1 << 
i
);

2726 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_CLK
);

2727 
	`ud–ay
(1);

2731 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 0);

2733 
	`LOG_DEBUG
("MII„—d: PHY=0x%02X, Reg=0x%02X, V®ue=0x%04X", 
phy_addr
, 
»g_addr
, 
v®ue
);

2735  
v®ue
;

2736 
	}
}

2746 
	$mii_wr™e_»gi¡”
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 
phy_addr
, ušt8_ˆ
»g_addr
, 
ušt16_t
 
v®ue
) {

2747 
i
;

2749 ià(!
ùx
) {

2750 
	`LOG_ERROR
("Invalid context for MII write");

2755 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_SELECT_WINDOW
 | 
_3C515_TX_WINDOW_4
);

2756 
	`d–ay_mli£cÚds
(1);

2759 
i
 = 0; i < 32; i++) {

2760 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
);

2761 
	`ud–ay
(1);

2762 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2763 
	`ud–ay
(1);

2767 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
);

2768 
	`ud–ay
(1);

2769 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2770 
	`ud–ay
(1);

2772 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
);

2773 
	`ud–ay
(1);

2774 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2775 
	`ud–ay
(1);

2778 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
);

2779 
	`ud–ay
(1);

2780 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2781 
	`ud–ay
(1);

2783 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
);

2784 
	`ud–ay
(1);

2785 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2786 
	`ud–ay
(1);

2789 
i
 = 4; i >= 0; i--) {

2790 
ušt16_t
 
b™
 = (
phy_addr
 & (1 << 
i
)è? 
PHY_CTRL_MGMT_DATA
 : 0;

2791 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
);

2792 
	`ud–ay
(1);

2793 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2794 
	`ud–ay
(1);

2798 
i
 = 4; i >= 0; i--) {

2799 
ušt16_t
 
b™
 = (
»g_addr
 & (1 << 
i
)è? 
PHY_CTRL_MGMT_DATA
 : 0;

2800 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
);

2801 
	`ud–ay
(1);

2802 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2803 
	`ud–ay
(1);

2807 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
);

2808 
	`ud–ay
(1);

2809 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_DATA
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2810 
	`ud–ay
(1);

2812 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
);

2813 
	`ud–ay
(1);

2814 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2815 
	`ud–ay
(1);

2818 
i
 = 15; i >= 0; i--) {

2819 
ušt16_t
 
b™
 = (
v®ue
 & (1 << 
i
)è? 
PHY_CTRL_MGMT_DATA
 : 0;

2820 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
);

2821 
	`ud–ay
(1);

2822 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 
b™
 | 
PHY_CTRL_MGMT_OE
 | 
PHY_CTRL_MGMT_CLK
);

2823 
	`ud–ay
(1);

2827 
	`outw
(
ùx
->
io_ba£
 + 
_3C515_W4_PHY_CTRL
, 0);

2829 
	`LOG_DEBUG
("MII wr™e: PHY=0x%02X, Reg=0x%02X, V®ue=0x%04X", 
phy_addr
, 
»g_addr
, 
v®ue
);

2832 
	}
}

2840 
	$¡¬t_autÚegÙŸtiÚ
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 
adv”ti£d_modes
) {

2841 
»suÉ
;

2842 
ušt16_t
 
cÚŒŞ_»g
;

2844 ià(!
ùx
) {

2845 
	`LOG_ERROR
("Invalid context for‡uto-negotiation start");

2849 
	`LOG_DEBUG
("S¹šg‡uto-ÃgÙŸtiÚ w™h modes: 0x%04X", 
adv”ti£d_modes
);

2852 
»suÉ
 = 
	`mii_»ad_»gi¡”
(
ùx
, 0x18, 
MII_CONTROL_REG
);

2853 ià(
»suÉ
 < 0) {

2854 
	`LOG_ERROR
("Failedo„ead MII control„egister");

2855  
»suÉ
;

2857 
cÚŒŞ_»g
 = 
»suÉ
;

2860 
»suÉ
 = 
	`mii_wr™e_»gi¡”
(
ùx
, 0x18, 
MII_AUTONEG_ADV_REG
, 
adv”ti£d_modes
);

2861 ià(
»suÉ
 < 0) {

2862 
	`LOG_ERROR
("Failedo write‡uto-negotiation‡dvertisement");

2863  
»suÉ
;

2867 
cÚŒŞ_»g
 |ğ
MII_CTRL_AUTONEG_EN
 | 
MII_CTRL_RESTART_AN
;

2868 
»suÉ
 = 
	`mii_wr™e_»gi¡”
(
ùx
, 0x18, 
MII_CONTROL_REG
, 
cÚŒŞ_»g
);

2869 ià(
»suÉ
 < 0) {

2870 
	`LOG_ERROR
("Failedo start‡uto-negotiation");

2871  
»suÉ
;

2874 
	`LOG_DEBUG
("Auto-negotiation started successfully");

2876 
	}
}

2883 
	$check_autÚegÙŸtiÚ_com¶‘e
(
nic_cÚ‹xt_t
 *
ùx
) {

2884 
»suÉ
;

2886 ià(!
ùx
) {

2890 
»suÉ
 = 
	`mii_»ad_»gi¡”
(
ùx
, 0x18, 
MII_STATUS_REG
);

2891 ià(
»suÉ
 < 0) {

2892  
»suÉ
;

2895  (
»suÉ
 & 
MII_STAT_AUTONEG_COMP
) ? 1 : 0;

2896 
	}
}

2905 
	$g‘_autÚegÙŸtiÚ_»suÉ
(
nic_cÚ‹xt_t
 *
ùx
, 
ušt16_t
 *
¥“d
, 
boŞ
 *
fuÎ_du¶ex
) {

2906 
adv_»g
, 
lšk_»g
, 
commÚ_modes
;

2908 ià(!
ùx
 || !
¥“d
 || !
fuÎ_du¶ex
) {

2913 
adv_»g
 = 
	`mii_»ad_»gi¡”
(
ùx
, 0x18, 
MII_AUTONEG_ADV_REG
);

2914 ià(
adv_»g
 < 0) {

2915 
	`LOG_ERROR
("Failedo„ead‡dvertisement„egister");

2916  
adv_»g
;

2919 
lšk_»g
 = 
	`mii_»ad_»gi¡”
(
ùx
, 0x18, 
MII_AUTONEG_LINK_REG
);

2920 ià(
lšk_»g
 < 0) {

2921 
	`LOG_ERROR
("Failedo„ead†ink…artner„egister");

2922  
lšk_»g
;

2926 
commÚ_modes
 = 
adv_»g
 & 
lšk_»g
;

2929 ià(
commÚ_modes
 & 
MII_ADV_100_TX_FD
) {

2930 *
¥“d
 = 100;

2931 *
fuÎ_du¶ex
 = 
Œue
;

2932 } ià(
commÚ_modes
 & 
MII_ADV_100_TX_HD
) {

2933 *
¥“d
 = 100;

2934 *
fuÎ_du¶ex
 = 
çl£
;

2935 } ià(
commÚ_modes
 & 
MII_ADV_10_FD
) {

2936 *
¥“d
 = 10;

2937 *
fuÎ_du¶ex
 = 
Œue
;

2938 } ià(
commÚ_modes
 & 
MII_ADV_10_HD
) {

2939 *
¥“d
 = 10;

2940 *
fuÎ_du¶ex
 = 
çl£
;

2942 
	`LOG_ERROR
("No common‡uto-negotiation modes found");

2946 
	`LOG_INFO
("Auto-negotiation complete: %d Mbps %s-duplex",

2947 *
¥“d
, *
fuÎ_du¶ex
 ? "Full" : "Half");

2950 
	}
}

2957 
	$cÚfigu»_mii_Œªsûiv”
(
nic_cÚ‹xt_t
 *
ùx
) {

2958 
»suÉ
, 
timeout
;

2959 
ušt16_t
 
phy_id1
, 
phy_id2
, 
¥“d
 = 100;

2960 
boŞ
 
fuÎ_du¶ex
 = 
Œue
;

2961 
ušt16_t
 
adv”ti£_modes
;

2963 ià(!
ùx
) {

2964 
	`LOG_ERROR
("Invalid context for MII configuration");

2968 
	`LOG_DEBUG
("Configuring MIIransceiver for 3C515-TX");

2971 
»suÉ
 = 
	`mii_»ad_»gi¡”
(
ùx
, 0x18, 
MII_PHY_ID1_REG
);

2972 ià(
»suÉ
 < 0) {

2973 
	`LOG_ERROR
("Failedo„ead PHY ID1");

2974  
»suÉ
;

2976 
phy_id1
 = 
»suÉ
;

2978 
»suÉ
 = 
	`mii_»ad_»gi¡”
(
ùx
, 0x18, 
MII_PHY_ID2_REG
);

2979 ià(
»suÉ
 < 0) {

2980 
	`LOG_ERROR
("Failedo„ead PHY ID2");

2981  
»suÉ
;

2983 
phy_id2
 = 
»suÉ
;

2985 
	`LOG_INFO
("MII PHY d‘eùed: ID1=0x%04X, ID2=0x%04X", 
phy_id1
, 
phy_id2
);

2988 
»suÉ
 = 
	`mii_wr™e_»gi¡”
(
ùx
, 0x18, 
MII_CONTROL_REG
, 
MII_CTRL_RESET
);

2989 ià(
»suÉ
 < 0) {

2990 
	`LOG_ERROR
("Failedo„eset PHY");

2991  
»suÉ
;

2995 
timeout
 = 1000;

2997 
	`d–ay_mli£cÚds
(10);

2998 
»suÉ
 = 
	`mii_»ad_»gi¡”
(
ùx
, 0x18, 
MII_CONTROL_REG
);

2999 ià(
»suÉ
 < 0) {

3000 
	`LOG_ERROR
("Failedo„ead control„egister during„eset");

3001  
»suÉ
;

3003 } (
»suÉ
 & 
MII_CTRL_RESET
è&& --
timeout
 > 0);

3005 ià(
timeout
 <= 0) {

3006 
	`LOG_ERROR
("PHY„esetimeout");

3010 
	`LOG_DEBUG
("PHY„eset complete");

3013 
adv”ti£_modes
 = 
MII_ADV_SELECTOR_FIELD
 | 
MII_ADV_10_HD
 | 
MII_ADV_10_FD
 |

3014 
MII_ADV_100_TX_HD
 | 
MII_ADV_100_TX_FD
 | 
MII_ADV_PAUSE
;

3017 
»suÉ
 = 
	`¡¬t_autÚegÙŸtiÚ
(
ùx
, 
adv”ti£_modes
);

3018 ià(
»suÉ
 < 0) {

3019 
	`LOG_ERROR
("Failedo start‡uto-negotiation");

3020  
»suÉ
;

3024 
timeout
 = 3000;

3026 
	`d–ay_mli£cÚds
(10);

3027 
»suÉ
 = 
	`check_autÚegÙŸtiÚ_com¶‘e
(
ùx
);

3028 ià(
»suÉ
 < 0) {

3029 
	`LOG_ERROR
("Failedo check‡uto-negotiation status");

3030  
»suÉ
;

3032 } 
»suÉ
 =ğ0 && --
timeout
 > 0);

3034 ià(
timeout
 <= 0) {

3035 
	`LOG_WARNING
("Auto-negotiationimeout, using fallback configuration");

3036 
¥“d
 = 100;

3037 
fuÎ_du¶ex
 = 
Œue
;

3040 
»suÉ
 = 
	`g‘_autÚegÙŸtiÚ_»suÉ
(
ùx
, &
¥“d
, &
fuÎ_du¶ex
);

3041 ià(
»suÉ
 < 0) {

3042 
	`LOG_WARNING
("Failedo get‡uto-negotiation„esults, using fallback");

3043 
¥“d
 = 100;

3044 
fuÎ_du¶ex
 = 
Œue
;

3049 
ùx
->
medŸ_cÚfig
.
lšk_¥“d
 = 
¥“d
;

3050 
ùx
->
medŸ_cÚfig
.
du¶ex_mode
 = 
fuÎ_du¶ex
 ? 
DUPLEX_FULL
 : 
DUPLEX_HALF
;

3051 
ùx
->
medŸ_cÚfig
.
auto_ÃgÙŸtiÚ
 = 1;

3052 
ùx
->
medŸ_cÚfig
.
lšk_aùive
 = 1;

3054 
	`LOG_INFO
("MIIransceiver configured: %d Mbps %s-duplex",

3055 
¥“d
, 
fuÎ_du¶ex
 ? "Full" : "Half");

3058 
	}
}

3063 
	$ş—nup_glob®_advªûd_dma
() {

3064 ià(
g_advªûd_dma_š™Ÿlized
) {

3065 
	`advªûd_dma_ş—nup
(&
g_advªûd_dma_cÚ‹xt
);

3066 
g_advªûd_dma_š™Ÿlized
 = 
çl£
;

3067 
	`LOG_INFO
("Global‡dvanced DMA system cleaned up");

3069 
	}
}

3082 
	$_3c515_£nd_·ck‘_ÿche_§ã
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ën
) {

3083 
_3c515_tx_tx_desc_t
 *
desc
;

3085 ià(!
nic
 || !
·ck‘
 || 
Ën
 == 0) {

3090 
nic_cÚ‹xt_t
 *
ùx
 = &
g_nic_cÚ‹xt
;

3091 ià(!
ùx
->
ÿche_mªagem’t_avaabË
) {

3092 
	`LOG_DEBUG
("Cache management‚ot‡vailable, using†egacy send");

3093  
	`_3c515_£nd_·ck‘
(
nic
, 
·ck‘
, 
Ën
);

3096 
desc
 = &
nic
->
tx_desc_ršg
[nic->
tx_šdex
];

3099 ià(
desc
->
¡©us
 & 
_3C515_TX_TX_DESC_COMPLETE
) {

3104 
	`_3c515_dma_´•¬e_bufãrs
((*)
desc
->
addr
, 
Ën
, 
çl£
);

3107 
	`memıy
((*)
desc
->
addr
, 
·ck‘
, 
Ën
);

3110 
	`_3c515_dma_com¶‘e_bufãrs
((*)
desc
->
addr
, 
Ën
, 
çl£
);

3113 
ušt8_t
 *
tx_bufãr
 = (ušt8_ˆ*)
desc
->
addr
;

3114 ià(
Ën
 >= 34) {

3115 
checksum_»suÉ
 = 
	`hw_checksum_´oûss_outbound_·ck‘
(
tx_bufãr
, 
Ën
);

3116 ià(
checksum_»suÉ
 != 0) {

3117 
	`LOG_DEBUG
("Checksum calculation completed for cache-safe outbound…acket");

3122 
desc
->
Ëngth
 = 
Ën
;

3123 
desc
->
¡©us
 = 
_3C515_TX_TX_INTR_BIT
;

3126 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_START_DMA_DOWN
);

3129 
nic
->
tx_šdex
 = (nic->tx_šdex + 1è% 
TX_RING_SIZE
;

3131 
	`LOG_TRACE
("S’ˆÿche-§ã…ack‘ oà%zu by‹ vŸ DMA", 
Ën
);

3134 
	}
}

3143 
	$_3c515_»ûive_·ck‘_ÿche_§ã
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ën
) {

3144 
_3c515_tx_rx_desc_t
 *
desc
;

3146 ià(!
nic
 || !
bufãr
 || !
Ën
) {

3151 
nic_cÚ‹xt_t
 *
ùx
 = &
g_nic_cÚ‹xt
;

3152 ià(!
ùx
->
ÿche_mªagem’t_avaabË
) {

3153 
	`LOG_DEBUG
("Cache management‚ot‡vailable, using†egacy„eceive");

3154  
	`_3c515_»ûive_·ck‘
(
nic
, 
bufãr
, 
Ën
);

3157 
desc
 = &
nic
->
rx_desc_ršg
[nic->
rx_šdex
];

3160 ià(!(
desc
->
¡©us
 & 
_3C515_TX_RX_DESC_COMPLETE
)) {

3164 ià(
desc
->
¡©us
 & 
_3C515_TX_RX_DESC_ERROR
) {

3165 
desc
->
¡©us
 = 0;

3166 
nic
->
rx_šdex
 = (nic->rx_šdex + 1è% 
RX_RING_SIZE
;

3170 *
Ën
 = 
desc
->
Ëngth
 & 
_3C515_TX_RX_DESC_LEN_MASK
;

3173 
	`_3c515_dma_´•¬e_bufãrs
((*)
desc
->
addr
, *
Ën
, 
Œue
);

3176 
	`memıy
(
bufãr
, (*)
desc
->
addr
, *
Ën
);

3179 
	`_3c515_dma_com¶‘e_bufãrs
((*)
desc
->
addr
, *
Ën
, 
Œue
);

3182 ià(*
Ën
 >= 34) {

3183 
checksum_»suÉ
 = 
	`hw_checksum_v”ify_šbound_·ck‘
(
bufãr
, *
Ën
);

3184 ià(
checksum_»suÉ
 < 0) {

3185 
	`LOG_DEBUG
("Checksum verification failed for cache-safe inbound…acket");

3190 
desc
->
¡©us
 = 0;

3193 
nic
->
rx_šdex
 = (nic->rx_šdex + 1è% 
RX_RING_SIZE
;

3195 
	`LOG_TRACE
("Reûived cache-§ã…ack‘ oà%zu by‹ vŸ DMA", *
Ën
);

3198 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/api.c

11 
	~<dos.h
>

12 
	~<¡dio.h
>

13 
	~<¡ršg.h
>

14 
	~"../šşude/­i.h
"

15 
	~"../šşude/h¬dw¬e.h
"

16 
	~"../šşude/·ck‘_İs.h
"

17 
	~"../šşude/loggšg.h
"

18 
	~"../šşude/¡©s.h
"

19 
	~"../šşude/routšg.h
"

20 
	~"../šşude/´oduùiÚ.h
"

23 
	#PD_MAX_HANDLES
 16

	)

24 
	#PD_MAX_TYPES
 8

	)

25 
	#PD_INVALID_HANDLE
 0xFFFF

	)

28 
	#PD_MAX_EXTENDED_HANDLES
 16

	)

29 
	#PD_DEFAULT_PRIORITY
 128

	)

30 
	#PD_MAX_BANDWIDTH
 0

	)

31 
	#PD_QOS_BUFFER_SIZE
 64

	)

32 
	#PD_FLOW_TIMEOUT_MS
 30000

	)

36 
ušt16_t
 
	mhªdË
;

37 
ušt16_t
 
	m·ck‘_ty³
;

38 
ušt8_t
 
	mşass
;

39 
ušt8_t
 
	mnumb”
;

40 
ušt8_t
 
	mty³
;

41 
ušt8_t
 
	mæags
;

42 
çr
 *
	m»ûiv”
;

43 
ušt32_t
 
	m·ck‘s_»ûived
;

44 
ušt32_t
 
	m·ck‘s_drİ³d
;

45 
ušt32_t
 
	m·ck‘s_£Á
;

46 
ušt32_t
 
	mby‹s_»ûived
;

47 
ušt32_t
 
	mby‹s_£Á
;

48 } 
	tpd_hªdË_t
;

51 
pd_hªdË_t
 
	ghªdËs
[
PD_MAX_HANDLES
];

52 
ex‹nded_·ck‘_hªdË_t
 
	gex‹nded_hªdËs
[
PD_MAX_EXTENDED_HANDLES
];

53 
	gÃxt_hªdË
 = 1;

54 
	g­i_š™Ÿlized
 = 0;

55 
	gex‹nded_­i_š™Ÿlized
 = 0;

56 
ušt16_t
 
	gdriv”_sigÇtu»
 = 0x3C0D;

59 
boŞ
 
	glßd_b®ªcšg_’abËd
 = 
çl£
;

60 
boŞ
 
	gqos_’abËd
 = 
çl£
;

61 
boŞ
 
	gvœtu®_š‹¼u±s_’abËd
 = 
çl£
;

62 
ušt32_t
 
	gglob®_bªdwidth_lim™
 = 0;

63 
pd_lßd_b®ªû_·¿ms_t
 
	gglob®_lb_cÚfig
;

64 
pd_qos_·¿ms_t
 
	gdeçuÉ_qos_·¿ms
;

67 
ušt32_t
 
	gnic_weights
[
MAX_NICS
] = {100, 100};

68 
ušt32_t
 
	gnic_utiz©iÚ
[
MAX_NICS
] = {0, 0};

69 
ušt32_t
 
	gnic_”rÜ_couÁs
[
MAX_NICS
] = {0, 0};

70 
ušt32_t
 
	gÏ¡_nic_u£d
 = 0;

74 
ušt8_t
 *
	m·ck‘_d©a
[
PD_QOS_BUFFER_SIZE
];

75 
ušt16_t
 
	m·ck‘_Ëngths
[
PD_QOS_BUFFER_SIZE
];

76 
ušt16_t
 
	mhªdË_ids
[
PD_QOS_BUFFER_SIZE
];

77 
ušt8_t
 
	m´iÜ™›s
[
PD_QOS_BUFFER_SIZE
];

78 
ušt8_t
 
	mh—d
;

79 
ušt8_t
 
	m
;

80 
ušt8_t
 
	mcouÁ
;

81 } 
	gqos_·ck‘_queue
;

84 
should_d–iv”_·ck‘
(cÚ¡ 
pd_hªdË_t
 *
hªdË
, 
ušt16_t
 
‘h_ty³
, cÚ¡ 
ušt8_t
 *
·ck‘
);

85 
d–iv”_·ck‘_to_hªdËr
(
pd_hªdË_t
 *
hªdË
, 
bufãr_desc_t
 *
bufãr
, 
ušt16_t
 
‘h_ty³
);

86 
ušt32_t
 
ÿlcuÏ‹_av”age_Ï‹ncy
(
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
);

87 
ušt32_t
 
ÿlcuÏ‹_j™‹r
(
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
);

90 
·ck‘_d–iv”_to_hªdËr
(
ušt16_t
 
hªdË
, ušt16_ˆ
Ëngth
,

91 cÚ¡ 
çr
 *
·ck‘_d©a
,

92 
çr
 *
»ûiv”_func
);

95 #´agm¨
code_£g
("COLD_TEXT", "CODE")

102 
	$­i_š™
(cÚ¡ 
cÚfig_t
 *
cÚfig
) {

103 
i
;

105 ià(!
cÚfig
) {

106 
	`log_”rÜ
("api_init: NULL config…arameter");

107  
API_ERR_INVALID_PARAM
;

110 
	`log_šfo
("Initializing Packet Driver API");

113 ià(
cÚfig
->
magic
 !ğ
CONFIG_MAGIC
) {

114 
	`log_”rÜ
("Inv®id cÚfigu¿tiÚ magic: 0x%04X", 
cÚfig
->
magic
);

115  
API_ERR_INVALID_PARAM
;

119 
	`mem£t
(
hªdËs
, 0, (handles));

120 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

121 
hªdËs
[
i
].
hªdË
 = 
PD_INVALID_HANDLE
;

124 
Ãxt_hªdË
 = 1;

125 
­i_š™Ÿlized
 = 1;

128 
»suÉ
 = 
	`­i_š™_ex‹nded_hªdËs
();

129 ià(
»suÉ
 !ğ
API_SUCCESS
) {

130 
	`log_w¬nšg
("Ex‹nded API in™Ÿliz©iÚ faed: %d", 
»suÉ
);

134 
	`log_šfo
("Packet Driver API initialized successfully");

135 
	`log_šfo
("Phase 3 Extended API: %s",

136 
ex‹nded_­i_š™Ÿlized
 ? "enabled" : "disabled");

138 
	}
}

144 
	$­i_ş—nup
() {

145 
i
;

147 ià(!
­i_š™Ÿlized
) {

151 
	`log_šfo
("Cleaning up Packet Driver API");

154 ià(
qos_’abËd
) {

155 
qos_’abËd
 = 
çl£
;

156 
	`mem£t
(&
qos_·ck‘_queue
, 0, (qos_packet_queue));

159 ià(
lßd_b®ªcšg_’abËd
) {

160 
lßd_b®ªcšg_’abËd
 = 
çl£
;

161 
	`mem£t
(&
glob®_lb_cÚfig
, 0, (global_lb_config));

165 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

166 ià(
hªdËs
[
i
].
hªdË
 !ğ
PD_INVALID_HANDLE
) {

167 
	`pd_»Ëa£_hªdË
(
hªdËs
[
i
].
hªdË
);

172 
	`­i_ş—nup_ex‹nded_hªdËs
();

174 
­i_š™Ÿlized
 = 0;

175 
	`log_šfo
("Packet Driver API cleanup completed");

178 
	}
}

187 
	$pd_acûss_ty³
(
ušt8_t
 
funùiÚ
, 
ušt16_t
 
hªdË
, *
·¿ms
) {

188 
	`log_debug
("PD Acûss: funùiÚ=0x%04X, hªdË=%04X", 
funùiÚ
, 
hªdË
);

191 ià(
funùiÚ
 < 
PD_FUNC_DRIVER_INFO
 ||

192 (
funùiÚ
 > 
PD_FUNC_SET_ADDRESS
 && funùiÚ < 
PD_FUNC_SET_HANDLE_PRIORITY
) ||

193 
funùiÚ
 > 
PD_FUNC_GET_ERROR_INFO
) {

194 
	`log_”rÜ
("Inv®id funùiÚ‚umb”: 0x%04X", 
funùiÚ
);

195  
API_ERR_BAD_FUNCTION
;

198 ià(!
­i_š™Ÿlized
) {

199 
	`log_”rÜ
("API‚ot initialized");

200  
API_ERR_NOT_INITIALIZED
;

203 
funùiÚ
) {

204 
PD_FUNC_DRIVER_INFO
:

205  
	`pd_g‘_driv”_šfo
(
·¿ms
);

206 
PD_FUNC_ACCESS_TYPE
:

207  
	`pd_hªdË_acûss_ty³
(
·¿ms
);

208 
PD_FUNC_RELEASE_TYPE
:

209  
	`pd_»Ëa£_hªdË
(
hªdË
);

210 
PD_FUNC_SEND_PKT
:

211  
	`pd_£nd_·ck‘
(
hªdË
, 
·¿ms
);

212 
PD_FUNC_TERMINATE
:

213  
	`pd_‹rmš©e
(
hªdË
);

214 
PD_FUNC_GET_ADDRESS
:

215  
	`pd_g‘_add»ss
(
hªdË
, 
·¿ms
);

216 
PD_FUNC_RESET_INTERFACE
:

217  
	`pd_»£t_š‹rçû
(
hªdË
);

218 
PD_FUNC_GET_PARAMETERS
:

219  
	`pd_g‘_·¿m‘”s
(
hªdË
, 
·¿ms
);

220 
PD_FUNC_SET_RCV_MODE
:

221  
	`pd_£t_rcv_mode
(
hªdË
, 
·¿ms
);

222 
PD_FUNC_GET_RCV_MODE
:

223  
	`pd_g‘_rcv_mode
(
hªdË
, 
·¿ms
);

224 
PD_FUNC_GET_STATISTICS
:

225  
	`pd_g‘_¡©i¡ics
(
hªdË
, 
·¿ms
);

226 
PD_FUNC_SET_ADDRESS
:

227  
	`pd_£t_add»ss
(
hªdË
, 
·¿ms
);

230 
PD_FUNC_SET_HANDLE_PRIORITY
:

231  
	`pd_£t_hªdË_´iÜ™y
(
hªdË
, 
·¿ms
);

232 
PD_FUNC_GET_ROUTING_INFO
:

233  
	`pd_g‘_routšg_šfo
(
hªdË
, 
·¿ms
);

234 
PD_FUNC_SET_LOAD_BALANCE
:

235  
	`pd_£t_lßd_b®ªû
(
hªdË
, 
·¿ms
);

236 
PD_FUNC_GET_NIC_STATUS
:

237  
	`pd_g‘_nic_¡©us
(
hªdË
, 
·¿ms
);

238 
PD_FUNC_SET_QOS_PARAMS
:

239  
	`pd_£t_qos_·¿ms
(
hªdË
, 
·¿ms
);

240 
PD_FUNC_GET_FLOW_STATS
:

241  
	`pd_g‘_æow_¡©s
(
hªdË
, 
·¿ms
);

242 
PD_FUNC_SET_NIC_PREFERENCE
:

243  
	`pd_£t_nic_´eã»nû
(
hªdË
, 
·¿ms
);

244 
PD_FUNC_GET_HANDLE_INFO
:

245  
	`pd_g‘_hªdË_šfo
(
hªdË
, 
·¿ms
);

246 
PD_FUNC_SET_BANDWIDTH_LIMIT
:

247  
	`pd_£t_bªdwidth_lim™
(
hªdË
, 
·¿ms
);

248 
PD_FUNC_GET_ERROR_INFO
:

249  
	`pd_g‘_”rÜ_šfo
(
hªdË
, 
·¿ms
);

252 
	`log_”rÜ
("UnknowÀ·ck‘ driv” funùiÚ: %d", 
funùiÚ
);

253  
API_ERR_BAD_FUNCTION
;

255 
	}
}

262 
	$pd_g‘_driv”_šfo
(*
šfo_±r
) {

263 
pd_driv”_šfo_t
 *
šfo
 = (pd_driv”_šfo_ˆ*)
šfo_±r
;

265 ià(!
šfo_±r
) {

266  
API_ERR_INVALID_PARAM
;

270 
šfo
->
v”siÚ
 = 0x0100;

271 
šfo
->
şass
 = 
PD_CLASS_ETHERNET
;

272 
šfo
->
ty³
 = 
PD_TYPE_3COM
;

273 
šfo
->
numb”
 = 0;

274 
šfo
->
basic
 = 1;

275 
šfo
->
ex‹nded
 = 1;

276 
šfo
->
high_³rfÜmªû
 = 0;

278 
	`¡ºıy
(
šfo
->
Çme
, "3Com Packet Driver", (info->name) - 1);

279 
šfo
->
Çme
[(info->name) - 1] = '\0';

281 
	`log_debug
("Driver info„equested");

283 
	}
}

290 
	$pd_hªdË_acûss_ty³
(*
·¿ms
) {

291 
pd_acûss_·¿ms_t
 *
acûss
 = (pd_acûss_·¿ms_ˆ*)
·¿ms
;

292 
i
, 
hªdË_idx
 = -1;

294 ià(!
·¿ms
) {

295  
API_ERR_INVALID_PARAM
;

298 
	`log_debug
("Acûs ty³: cÏss=%d,y³=%04X", 
acûss
->
şass
,‡cûss->
ty³
);

301 ià(
acûss
->
şass
 !ğ
PD_CLASS_ETHERNET
) {

302 
	`log_”rÜ
("UnsuµÜ‹d…ack‘ cÏss: %d", 
acûss
->
şass
);

303  
API_ERR_INVALID_PARAM
;

307 ià(
acûss
->
numb”
 >ğ
	`h¬dw¬e_g‘_nic_couÁ
()) {

308 
	`log_”rÜ
("Inv®id iÁ”çû‚umb”: %d", 
acûss
->
numb”
);

309  
API_ERR_NO_INTERFACE
;

313 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

314 ià(
hªdËs
[
i
].
hªdË
 =ğ
PD_INVALID_HANDLE
) {

315 
hªdË_idx
 = 
i
;

320 ià(
hªdË_idx
 < 0) {

321 
	`log_”rÜ
("No free handles‡vailable");

322  
API_ERR_NO_HANDLES
;

326 
hªdËs
[
hªdË_idx
].
hªdË
 = 
Ãxt_hªdË
++;

327 
hªdËs
[
hªdË_idx
].
·ck‘_ty³
 = 
acûss
->
ty³
;

328 
hªdËs
[
hªdË_idx
].
şass
 = 
acûss
->class;

329 
hªdËs
[
hªdË_idx
].
numb”
 = 
acûss
->number;

330 
hªdËs
[
hªdË_idx
].
ty³
 = 
acûss
->
basic
;

331 
hªdËs
[
hªdË_idx
].
»ûiv”
 = 
acûss
->receiver;

332 
hªdËs
[
hªdË_idx
].
·ck‘s_»ûived
 = 0;

333 
hªdËs
[
hªdË_idx
].
·ck‘s_drİ³d
 = 0;

334 
hªdËs
[
hªdË_idx
].
·ck‘s_£Á
 = 0;

335 
hªdËs
[
hªdË_idx
].
by‹s_»ûived
 = 0;

336 
hªdËs
[
hªdË_idx
].
by‹s_£Á
 = 0;

338 
	`log_šfo
("Allocated handle %04X forype %04X",

339 
hªdËs
[
hªdË_idx
].
hªdË
, 
acûss
->
ty³
);

341  
hªdËs
[
hªdË_idx
].
hªdË
;

342 
	}
}

349 
	$pd_»Ëa£_hªdË
(
ušt16_t
 
hªdË
) {

350 
i
;

352 
	`log_debug
("R–—sšg hªdË %04X", 
hªdË
);

355 
j
 = 0; j < 
PD_MAX_EXTENDED_HANDLES
; j++) {

356 ià(
ex‹nded_hªdËs
[
j
].
hªdË_id
 =ğ
hªdË
) {

357 
ex‹nded_hªdËs
[
j
].
hªdË_id
 = 
PD_INVALID_HANDLE
;

358 
	`mem£t
(&
ex‹nded_hªdËs
[
j
], 0, (extended_handles[j]));

359 
ex‹nded_hªdËs
[
j
].
hªdË_id
 = 
PD_INVALID_HANDLE
;

360 
ex‹nded_hªdËs
[
j
].
´iÜ™y
 = 
PD_DEFAULT_PRIORITY
;

361 
ex‹nded_hªdËs
[
j
].
´eã¼ed_nic
 = 0xFF;

367 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

368 ià(
hªdËs
[
i
].
hªdË
 == handle) {

369 
	`log_šfo
("Released handle %04X (rx=%lu, dropped=%lu)",

370 
hªdË
, 
hªdËs
[
i
].
·ck‘s_»ûived
,

371 
hªdËs
[
i
].
·ck‘s_drİ³d
);

373 
hªdËs
[
i
].
hªdË
 = 
PD_INVALID_HANDLE
;

374 
	`mem£t
(&
hªdËs
[
i
], 0, (handles[i]));

375 
hªdËs
[
i
].
hªdË
 = 
PD_INVALID_HANDLE
;

380 
	`log_”rÜ
("HªdË %04X‚Ù found", 
hªdË
);

381  
API_ERR_BAD_HANDLE
;

382 
	}
}

390 
	$pd_£nd_·ck‘
(
ušt16_t
 
hªdË
, *
·¿ms
) {

391 
pd_£nd_·¿ms_t
 *
£nd
 = (pd_£nd_·¿ms_ˆ*)
·¿ms
;

392 
bufãr_desc_t
 *
tx_bufãr
 = 
NULL
;

393 
»suÉ
;

394 
i
, 
hªdË_idx
 = -1;

395 
ušt8_t
 
š‹rçû_num
 = 0;

397 ià(!
·¿ms
 || !
£nd
->
bufãr
) {

398  
API_ERR_INVALID_PARAM
;

401 
	`log_debug
("S’d…ack‘: hªdË=%04X,†’=%d", 
hªdË
, 
£nd
->
Ëngth
);

404 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

405 ià(
hªdËs
[
i
].
hªdË
 == handle) {

406 
hªdË_idx
 = 
i
;

407 
š‹rçû_num
 = 
hªdËs
[
i
].
numb”
;

412 ià(
hªdË_idx
 < 0) {

413 
	`log_”rÜ
("Inv®id hªdË %04X", 
hªdË
);

414  
API_ERR_BAD_HANDLE
;

418 ià(
£nd
->
Ëngth
 < 60 || send->length > 1514) {

419 
	`log_”rÜ
("Inv®id…ack‘†’gth: %d", 
£nd
->
Ëngth
);

420  
API_ERR_INVALID_PARAM
;

424 
tx_bufãr
 = 
	`bufãr_®loc_‘h”Ãt_äame
(
£nd
->
Ëngth
, 
BUFFER_TYPE_TX
);

425 ià(!
tx_bufãr
) {

426 
	`log_”rÜ
("Failedo‡llocate TX buffer");

427  
API_ERR_INVALID_PARAM
;

431 
»suÉ
 = 
	`bufãr_£t_d©a
(
tx_bufãr
, 
£nd
->
bufãr
, s’d->
Ëngth
);

432 ià(
»suÉ
 < 0) {

433 
	`log_”rÜ
("Failedo copy…acket datao TX buffer");

434 
	`bufãr_ä“_ªy
(
tx_bufãr
);

435  
API_ERR_INVALID_PARAM
;

441 
»suÉ
 = 
	`­i_check_bªdwidth_lim™
(
hªdË
, 
£nd
->
Ëngth
);

442 ià(
»suÉ
 !ğ
API_SUCCESS
) {

443 
	`log_debug
("Bªdwidth†im™ƒxûeded fÜ hªdË %04X", 
hªdË
);

444 
	`bufãr_ä“_ªy
(
tx_bufãr
);

445  
»suÉ
;

449 
ušt8_t
 
£Ëùed_nic
 = 
š‹rçû_num
;

450 
»suÉ
 = 
	`­i_£Ëù_İtim®_nic
(
hªdË
, 
£nd
->
bufãr
, &
£Ëùed_nic
);

451 ià(
»suÉ
 =ğ
API_SUCCESS
 && 
£Ëùed_nic
 !ğ
š‹rçû_num
) {

453 
š‹rçû_num
 = 
£Ëùed_nic
;

456 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

457 ià(
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
è=ğ
API_SUCCESS
) {

458 
ext_hªdË
->
nic_sw™ches
++;

459 
ext_hªdË
->
š‹rçû_num
 = 
£Ëùed_nic
;

462 
	`log_debug
("IÁ–lig’ˆroutšg s–eùed NIC %d fÜ hªdË %04X", 
£Ëùed_nic
, 
hªdË
);

466 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

467 ià(!
nic
 || !nic->
İs
 || !nic->İs->
£nd_·ck‘
) {

468 
	`bufãr_ä“_ªy
(
tx_bufãr
);

469  
API_ERR_FUNCTION_NOT_SUPPORTED
;

472 
»suÉ
 = 
nic
->
İs
->
	`£nd_·ck‘
Òic, 
	`bufãr_g‘_d©a_±r
(
tx_bufãr
), 
£nd
->
Ëngth
);

475 
	`­i_upd©e_nic_utiz©iÚ
(
š‹rçû_num
, 
£nd
->
Ëngth
);

478 
	`bufãr_ä“_ªy
(
tx_bufãr
);

480 ià(
»suÉ
 < 0) {

481 
	`log_”rÜ
("H¬dw¬£nd faed: %d", 
»suÉ
);

482  
»suÉ
;

486 
	`¡©s_šüem’t_tx_·ck‘s
();

487 
	`¡©s_add_tx_by‹s
(
£nd
->
Ëngth
);

489 
	`log_debug
("Pack‘ s’ˆsucûssfuÎyhrough iÁ”çû %d", 
š‹rçû_num
);

491 
	}
}

498 
	$pd_‹rmš©e
(
ušt16_t
 
hªdË
) {

499 
	`log_šfo
("Driv””mš©iÚ„eque¡ed (hªdË=%04X)", 
hªdË
);

503 ià(
hªdË
 !ğ
PD_INVALID_HANDLE
 && 
	`pd_v®id©e_hªdË
(handle)) {

505  
	`pd_»Ëa£_hªdË
(
hªdË
);

509  
API_ERR_FUNCTION_NOT_SUPPORTED
;

510 
	}
}

518 
	$pd_g‘_add»ss
(
ušt16_t
 
hªdË
, *
·¿ms
) {

519 
pd_add»ss_·¿ms_t
 *
addr
 = (pd_add»ss_·¿ms_ˆ*)
·¿ms
;

520 
nic_šfo_t
 *
nic
;

522 ià(!
·¿ms
) {

523  
API_ERR_INVALID_PARAM
;

526 
	`log_debug
("G‘‡dd»ss: hªdË=%04X", 
hªdË
);

529 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

530  
API_ERR_BAD_HANDLE
;

534 
i
, 
š‹rçû_num
 = 0;

535 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

536 ià(
hªdËs
[
i
].
hªdË
 == handle) {

537 
š‹rçû_num
 = 
hªdËs
[
i
].
numb”
;

543 
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

544 ià(!
nic
) {

545  
API_ERR_NO_INTERFACE
;

548 ià(!
nic
->
İs
 || !nic->İs->
g‘_mac_add»ss
) {

549  
API_ERR_FUNCTION_NOT_SUPPORTED
;

552  
nic
->
İs
->
	`g‘_mac_add»ss
Òic, 
addr
->
add»ss
);

553 
	}
}

560 
	$pd_»£t_š‹rçû
(
ušt16_t
 
hªdË
) {

561 
nic_šfo_t
 *
nic
;

563 
	`log_debug
("Re£ˆš‹rçû: hªdË=%04X", 
hªdË
);

566 
i
, 
š‹rçû_num
 = 0;

567 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

568 ià(
hªdËs
[
i
].
hªdË
 == handle) {

569 
š‹rçû_num
 = 
hªdËs
[
i
].
numb”
;

574 ià(
i
 >ğ
PD_MAX_HANDLES
) {

575  
API_ERR_BAD_HANDLE
;

579 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

580  
API_ERR_BAD_HANDLE
;

584 
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

585 ià(!
nic
 || !nic->
İs
 || !nic->İs->
š™
) {

586  
API_ERR_NO_INTERFACE
;

589  
nic
->
İs
->
	`š™
(nic);

590 
	}
}

598 
	$pd_g‘_·¿m‘”s
(
ušt16_t
 
hªdË
, *
·¿ms
) {

599 
	`log_debug
("G‘…¬am‘”s: hªdË=%04X", 
hªdË
);

602 
pd_driv”_šfo_t
 *
driv”_·¿ms
 = (pd_driv”_šfo_ˆ*)
·¿ms
;

603 
driv”_·¿ms
->
v”siÚ
 = 0x0100;

604 
driv”_·¿ms
->
şass
 = 
PD_CLASS_ETHERNET
;

605 
driv”_·¿ms
->
ty³
 = 
PD_TYPE_3COM
;

606 
driv”_·¿ms
->
basic
 = 1;

607 
driv”_·¿ms
->
ex‹nded
 = 
ex‹nded_­i_š™Ÿlized
 ? 1 : 0;

608 
driv”_·¿ms
->
high_³rfÜmªû
 = 0;

610 ià(!
·¿ms
) {

611  
API_ERR_INVALID_PARAM
;

615 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

616  
API_ERR_BAD_HANDLE
;

621 
	}
}

629 
	$pd_£t_rcv_mode
(
ušt16_t
 
hªdË
, *
·¿ms
) {

630 
ušt16_t
 *
mode
 = (ušt16_ˆ*)
·¿ms
;

631 
i
, 
š‹rçû_num
 = 0;

632 
nic_šfo_t
 *
nic
;

634 
	`log_debug
("S‘„eûivmode: hªdË=%04X", 
hªdË
);

636 ià(!
·¿ms
) {

637  
API_ERR_INVALID_PARAM
;

641 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

642  
API_ERR_BAD_HANDLE
;

646 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

647 ià(
hªdËs
[
i
].
hªdË
 == handle) {

648 
š‹rçû_num
 = 
hªdËs
[
i
].
numb”
;

653 
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

654 ià(!
nic
) {

655  
API_ERR_NO_INTERFACE
;

658 ià(!
nic
->
İs
 || !nic->İs->
£t_»ûive_mode
) {

659  
API_ERR_FUNCTION_NOT_SUPPORTED
;

662  
nic
->
İs
->
	`£t_»ûive_mode
Òic, (
ušt8_t
)*
mode
);

663 
	}
}

671 
	$pd_g‘_rcv_mode
(
ušt16_t
 
hªdË
, *
·¿ms
) {

672 
	`log_debug
("G‘„eûivmode: hªdË=%04X", 
hªdË
);

675 
i
, 
š‹rçû_num
 = 0;

676 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

677 ià(
hªdËs
[
i
].
hªdË
 == handle) {

678 
š‹rçû_num
 = 
hªdËs
[
i
].
numb”
;

683 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

684 ià(
nic
 &&‚ic->
İs
 &&‚ic->İs->
g‘_»ûive_mode
) {

685 
ušt8_t
 
mode
;

686 
»suÉ
 = 
nic
->
İs
->
	`g‘_»ûive_mode
Òic, &
mode
);

687 ià(
»suÉ
 == 0) {

688 *(
ušt16_t
 *)
·¿ms
 = 
mode
;

690  
»suÉ
;

693 ià(!
·¿ms
) {

694  
API_ERR_INVALID_PARAM
;

698 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

699  
API_ERR_BAD_HANDLE
;

703 
	}
}

711 
	$pd_g‘_¡©i¡ics
(
ušt16_t
 
hªdË
, *
·¿ms
) {

712 
pd_¡©i¡ics_t
 *
¡©s
 = (pd_¡©i¡ics_ˆ*)
·¿ms
;

713 
i
, 
š‹rçû_num
 = 0;

714 
nic_šfo_t
 *
nic
;

716 ià(!
·¿ms
) {

717  
API_ERR_INVALID_PARAM
;

720 
	`log_debug
("G‘ sti¡ics: hªdË=%04X", 
hªdË
);

723 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

724  
API_ERR_BAD_HANDLE
;

728 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

729 ià(
hªdËs
[
i
].
hªdË
 == handle) {

730 
š‹rçû_num
 = 
hªdËs
[
i
].
numb”
;

733 
¡©s
->
·ck‘s_š
 = 
hªdËs
[
i
].
·ck‘s_»ûived
;

734 
¡©s
->
·ck‘s_out
 = 
hªdËs
[
i
].
·ck‘s_£Á
;

735 
¡©s
->
by‹s_š
 = 
hªdËs
[
i
].
by‹s_»ûived
;

736 
¡©s
->
by‹s_out
 = 
hªdËs
[
i
].
by‹s_£Á
;

737 
¡©s
->
”rÜs_š
 = 
hªdËs
[
i
].
·ck‘s_drİ³d
;

738 
¡©s
->
”rÜs_out
 = 0;

739 
¡©s
->
·ck‘s_lo¡
 = 
hªdËs
[
i
].
·ck‘s_drİ³d
;

742 
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

743 ià(
nic
 &&‚ic->
İs
 &&‚ic->İs->
g‘_¡©i¡ics
) {

745 
nic
->
İs
->
	`g‘_¡©i¡ics
Òic, 
¡©s
);

752  
API_ERR_BAD_HANDLE
;

753 
	}
}

761 
	$pd_£t_add»ss
(
ušt16_t
 
hªdË
, *
·¿ms
) {

762 
	`log_debug
("S‘‡dd»ss: hªdË=%04X", 
hªdË
);

766 
	`log_w¬nšg
("A‰em±Ø£ˆMAC‡dd»s Ú hªdË %04X (nÙ‡Îowed)", 
hªdË
);

768 ià(!
·¿ms
) {

769  
API_ERR_INVALID_PARAM
;

773 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

774  
API_ERR_BAD_HANDLE
;

778  
API_ERR_FUNCTION_NOT_SUPPORTED
;

779 
	}
}

786 
	$pd_v®id©e_hªdË
(
ušt16_t
 
hªdË
) {

787 
i
;

789 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

790 ià(
hªdËs
[
i
].
hªdË
 == handle) {

796 
	}
}

799 #´agm¨
code_£g
()

802 #´agm¨
code_£g
("_TEXT", "CODE")

811 
	$­i_´oûss_»ûived_·ck‘
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
, 
nic_id
) {

812 
i
, 
d–iv”ed
 = 0;

813 
ušt16_t
 
‘h_ty³
;

814 
bufãr_desc_t
 *
rx_bufãr
 = 
NULL
;

816 ià(!
·ck‘
 || 
Ëngth
 < 14) {

817  
API_ERR_INVALID_PARAM
;

820 ià(!
­i_š™Ÿlized
) {

821 
	`log_debug
("API‚ot initialized, dropping…acket");

822  
API_ERR_NOT_INITIALIZED
;

825 
	`log_debug
("Proûssšg„eûived…ack‘,†’gth=%d,‚ic=%d", 
Ëngth
, 
nic_id
);

828 
‘h_ty³
 = (
·ck‘
[12] << 8) |…acket[13];

831 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

832 ià(
hªdËs
[
i
].
hªdË
 !ğ
PD_INVALID_HANDLE
) {

834 ià(
	`should_d–iv”_·ck‘
(&
hªdËs
[
i
], 
‘h_ty³
, 
·ck‘
)) {

836 ià(!
rx_bufãr
) {

837 
rx_bufãr
 = 
	`bufãr_®loc_‘h”Ãt_äame
(
Ëngth
, 
BUFFER_TYPE_RX
);

838 ià(!
rx_bufãr
) {

839 
	`log_”rÜ
("Failedo‡llocate RX buffer for…acket delivery");

840  
API_ERR_INVALID_PARAM
;

843 
	`bufãr_£t_d©a
(
rx_bufãr
, 
·ck‘
, 
Ëngth
);

847 ià(
	`d–iv”_·ck‘_to_hªdËr
(&
hªdËs
[
i
], 
rx_bufãr
, 
‘h_ty³
)) {

848 
hªdËs
[
i
].
·ck‘s_»ûived
++;

849 
d–iv”ed
 = 1;

850 
	`log_debug
("D–iv”ed…ack‘ØhªdË %04X", 
hªdËs
[
i
].
hªdË
);

852 
hªdËs
[
i
].
·ck‘s_drİ³d
++;

853 
	`log_debug
("FaedØd–iv”…ack‘ØhªdË %04X", 
hªdËs
[
i
].
hªdË
);

860 ià(
rx_bufãr
) {

861 
	`bufãr_ä“_ªy
(
rx_bufãr
);

864 ià(!
d–iv”ed
) {

865 
	`log_debug
("NØhªdËr fÜ…ack‘y³ %04X", 
‘h_ty³
);

869 
	`¡©s_šüem’t_rx_·ck‘s
();

870 
	`¡©s_add_rx_by‹s
(
Ëngth
);

872  
d–iv”ed
 ? 0 : 
API_ERR_NO_HANDLERS
;

873 
	}
}

882 
	$should_d–iv”_·ck‘
(cÚ¡ 
pd_hªdË_t
 *
hªdË
, 
ušt16_t
 
‘h_ty³
, cÚ¡ 
ušt8_t
 *
·ck‘
) {

883 ià(!
hªdË
 || hªdË->hªdË =ğ
PD_INVALID_HANDLE
) {

888 ià(
hªdË
->
·ck‘_ty³
 !ğ0 && hªdË->·ck‘_ty³ !ğ
‘h_ty³
) {

894 ià(
hªdË
->
æags
 & 0x01) {

901 
	}
}

910 
	$d–iv”_·ck‘_to_hªdËr
(
pd_hªdË_t
 *
hªdË
, 
bufãr_desc_t
 *
bufãr
, 
ušt16_t
 
‘h_ty³
) {

911 
çr
 *
»ûiv”
;

912 
ušt16_t
 
Ëngth
;

913 
çr
 *
d©a_±r
;

914 
»suÉ
;

916 ià(!
hªdË
 || !
bufãr
) {

920 
»ûiv”
 = 
hªdË
->receiver;

921 ià(!
»ûiv”
) {

922 
	`log_debug
("HªdË %04X ha nØ»ûiv” funùiÚ", 
hªdË
->handle);

926 
Ëngth
 = (
ušt16_t
)
	`bufãr_g‘_u£d_size
(
bufãr
);

927 
d©a_±r
 = 
	`bufãr_g‘_d©a_±r
(
bufãr
);

930 
»suÉ
 = 
	`·ck‘_d–iv”_to_hªdËr
(
hªdË
->hªdË, 
Ëngth
, 
d©a_±r
, 
»ûiv”
);

932 ià(
»suÉ
 == 0) {

933 
	`log_debug
("SucûssfuÎy d–iv”ed…ack‘Ø»ûiv”‡ˆ%Fp", 
»ûiv”
);

936 
	`log_debug
("FaedØd–iv”…ack‘Ø»ûiv”‡ˆ%Fp", 
»ûiv”
);

939 
	}
}

942 #´agm¨
code_£g
()

945 #´agm¨
code_£g
("COLD_TEXT", "CODE")

953 
	$­i_š™_ex‹nded_hªdËs
() {

954 
i
;

956 ià(
ex‹nded_­i_š™Ÿlized
) {

957  
API_SUCCESS
;

961 
	`mem£t
(
ex‹nded_hªdËs
, 0, (extended_handles));

962 
i
 = 0; i < 
PD_MAX_EXTENDED_HANDLES
; i++) {

963 
ex‹nded_hªdËs
[
i
].
hªdË_id
 = 
PD_INVALID_HANDLE
;

964 
ex‹nded_hªdËs
[
i
].
´iÜ™y
 = 
PD_DEFAULT_PRIORITY
;

965 
ex‹nded_hªdËs
[
i
].
´eã¼ed_nic
 = 0xFF;

966 
ex‹nded_hªdËs
[
i
].
bªdwidth_lim™
 = 
PD_MAX_BANDWIDTH
;

967 
ex‹nded_hªdËs
[
i
].
æags
 = 0;

971 
glob®_lb_cÚfig
.
mode
 = 
LB_MODE_ROUND_ROBIN
;

972 
glob®_lb_cÚfig
.
´im¬y_nic
 = 0;

973 
glob®_lb_cÚfig
.
£cÚd¬y_nic
 = 1;

974 
glob®_lb_cÚfig
.
sw™ch_th»shŞd
 = 1000;

975 
glob®_lb_cÚfig
.
weight_´im¬y
 = 100;

976 
glob®_lb_cÚfig
.
weight_£cÚd¬y
 = 100;

979 
deçuÉ_qos_·¿ms
.
´iÜ™y_şass
 = 
QOS_CLASS_STANDARD
;

980 
deçuÉ_qos_·¿ms
.
mš_bªdwidth
 = 0;

981 
deçuÉ_qos_·¿ms
.
max_bªdwidth
 = 0;

982 
deçuÉ_qos_·¿ms
.
max_Ï‹ncy
 = 1000;

983 
deçuÉ_qos_·¿ms
.
drİ_pŞicy
 = 0;

986 
	`mem£t
(&
qos_·ck‘_queue
, 0, (qos_packet_queue));

988 
ex‹nded_­i_š™Ÿlized
 = 1;

989 
	`log_šfo
("Extended API initialized successfully");

991  
API_SUCCESS
;

992 
	}
}

998 
	$­i_ş—nup_ex‹nded_hªdËs
() {

999 
i
;

1001 ià(!
ex‹nded_­i_š™Ÿlized
) {

1002  
API_SUCCESS
;

1006 
i
 = 0; i < 
PD_MAX_EXTENDED_HANDLES
; i++) {

1007 
ex‹nded_hªdËs
[
i
].
hªdË_id
 = 
PD_INVALID_HANDLE
;

1008 
	`mem£t
(&
ex‹nded_hªdËs
[
i
], 0, (extended_handles[i]));

1012 
lßd_b®ªcšg_’abËd
 = 
çl£
;

1013 
qos_’abËd
 = 
çl£
;

1014 
vœtu®_š‹¼u±s_’abËd
 = 
çl£
;

1015 
	`mem£t
(&
glob®_lb_cÚfig
, 0, (global_lb_config));

1016 
	`mem£t
(&
deçuÉ_qos_·¿ms
, 0, (default_qos_params));

1017 
	`mem£t
(&
qos_·ck‘_queue
, 0, (qos_packet_queue));

1019 
ex‹nded_­i_š™Ÿlized
 = 0;

1020 
	`log_šfo
("Extended API cleanup completed");

1022  
API_SUCCESS
;

1023 
	}
}

1031 
	$­i_g‘_ex‹nded_hªdË
(
ušt16_t
 
hªdË
, 
ex‹nded_·ck‘_hªdË_t
 **
ext_hªdË
) {

1032 
i
;

1034 ià(!
ext_hªdË
) {

1035  
API_ERR_INVALID_PARAM
;

1038 *
ext_hªdË
 = 
NULL
;

1041 
i
 = 0; i < 
PD_MAX_EXTENDED_HANDLES
; i++) {

1042 ià(
ex‹nded_hªdËs
[
i
].
hªdË_id
 =ğ
hªdË
) {

1043 *
ext_hªdË
 = &
ex‹nded_hªdËs
[
i
];

1044  
API_SUCCESS
;

1048  
API_ERR_BAD_HANDLE
;

1049 
	}
}

1056 
	$­i_upg¿de_hªdË
(
ušt16_t
 
hªdË
) {

1057 
i
, 
basic_idx
 = -1, 
ext_idx
 = -1;

1059 ià(!
ex‹nded_­i_š™Ÿlized
) {

1060 
»suÉ
 = 
	`­i_š™_ex‹nded_hªdËs
();

1061 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1062  
»suÉ
;

1067 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

1068 ià(
hªdËs
[
i
].
hªdË
 == handle) {

1069 
basic_idx
 = 
i
;

1074 ià(
basic_idx
 < 0) {

1075  
API_ERR_BAD_HANDLE
;

1079 
i
 = 0; i < 
PD_MAX_EXTENDED_HANDLES
; i++) {

1080 ià(
ex‹nded_hªdËs
[
i
].
hªdË_id
 =ğ
PD_INVALID_HANDLE
) {

1081 
ext_idx
 = 
i
;

1086 ià(
ext_idx
 < 0) {

1087  
API_ERR_NO_HANDLES
;

1091 
ex‹nded_hªdËs
[
ext_idx
].
hªdË_id
 = 
hªdËs
[
basic_idx
].
hªdË
;

1092 
ex‹nded_hªdËs
[
ext_idx
].
·ck‘_ty³
 = 
hªdËs
[
basic_idx
].packet_type;

1093 
ex‹nded_hªdËs
[
ext_idx
].
š‹rçû_num
 = 
hªdËs
[
basic_idx
].
numb”
;

1094 
ex‹nded_hªdËs
[
ext_idx
].
»ûiv”_func
 = 
hªdËs
[
basic_idx
].
»ûiv”
;

1097 
ex‹nded_hªdËs
[
ext_idx
].
´iÜ™y
 = 
PD_DEFAULT_PRIORITY
;

1098 
ex‹nded_hªdËs
[
ext_idx
].
´eã¼ed_nic
 = 0xFF;

1099 
ex‹nded_hªdËs
[
ext_idx
].
bªdwidth_lim™
 = 
PD_MAX_BANDWIDTH
;

1100 
ex‹nded_hªdËs
[
ext_idx
].
æags
 = 
HANDLE_FLAG_ROUTING_AWARE
;

1101 
ex‹nded_hªdËs
[
ext_idx
].
routšg_´eã»nûs
 = 0;

1104 
ex‹nded_hªdËs
[
ext_idx
].
·ck‘s_rou‹d
 = 0;

1105 
ex‹nded_hªdËs
[
ext_idx
].
routšg_çu»s
 = 0;

1106 
ex‹nded_hªdËs
[
ext_idx
].
qos_drİs
 = 0;

1107 
ex‹nded_hªdËs
[
ext_idx
].
bªdwidth_drİs
 = 0;

1108 
ex‹nded_hªdËs
[
ext_idx
].
nic_sw™ches
 = 0;

1109 
ex‹nded_hªdËs
[
ext_idx
].
Ï¡_·ck‘_time
 = 0;

1110 
ex‹nded_hªdËs
[
ext_idx
].
by‹s_this_£cÚd
 = 0;

1111 
ex‹nded_hªdËs
[
ext_idx
].
time_wšdow_¡¬t
 = 0;

1113 
	`log_šfo
("Upg¿ded hªdË %04XØex‹nded hªdË", 
hªdË
);

1114  
API_SUCCESS
;

1115 
	}
}

1123 
	$pd_£t_hªdË_´iÜ™y
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1124 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1125 
ušt8_t
 *
´iÜ™y
 = (ušt8_ˆ*)
·¿ms
;

1126 
»suÉ
;

1128 ià(!
·¿ms
) {

1129  
API_ERR_INVALID_PARAM
;

1132 
	`log_debug
("S‘ hªdË…riÜ™y: hªdË=%04X,…riÜ™y=%d", 
hªdË
, *
´iÜ™y
);

1135 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1136 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1137 
»suÉ
 = 
	`­i_upg¿de_hªdË
(
hªdË
);

1138 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1139  
»suÉ
;

1141 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1142 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1143  
»suÉ
;

1147 
ext_hªdË
->
´iÜ™y
 = *priority;

1148 
ext_hªdË
->
æags
 |ğ
HANDLE_FLAG_PRIORITY_ENABLED
;

1150 
	`log_šfo
("S‘…riÜ™y %d fÜ hªdË %04X", *
´iÜ™y
, 
hªdË
);

1151  
API_SUCCESS
;

1152 
	}
}

1160 
	$pd_g‘_routšg_šfo
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1161 
pd_routšg_šfo_t
 *
šfo
 = (pd_routšg_šfo_ˆ*)
·¿ms
;

1162 cÚ¡ 
routšg_¡©s_t
 *
routšg_¡©s
;

1164 ià(!
·¿ms
) {

1165  
API_ERR_INVALID_PARAM
;

1168 
	`log_debug
("G‘„outšg info: hªdË=%04X", 
hªdË
);

1171 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

1172  
API_ERR_BAD_HANDLE
;

1176 
routšg_¡©s
 = 
	`routšg_g‘_¡©s
();

1177 ià(!
routšg_¡©s
) {

1178  
API_ERR_ROUTING_FAILED
;

1182 
šfo
->
rou‹_couÁ
 = 
g_routšg_bË
.
’Œy_couÁ
;

1183 
šfo
->
¬p_’Œ›s
 = 
g_¬p_ÿche
.
’Œy_couÁ
;

1184 
šfo
->
·ck‘s_rou‹d
 = 
routšg_¡©s
->packets_routed;

1185 
šfo
->
routšg_”rÜs
 = 
routšg_¡©s
->routing_errors;

1186 
šfo
->
deçuÉ_nic
 = 
g_routšg_bË
.default_nic;

1187 
šfo
->
routšg_mode
 = 
	`routšg_is_’abËd
() ? 1 : 0;

1188 
šfo
->
»£rved
 = 0;

1190  
API_SUCCESS
;

1191 
	}
}

1199 
	$pd_£t_lßd_b®ªû
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1200 
pd_lßd_b®ªû_·¿ms_t
 *
lb_·¿ms
 = (pd_lßd_b®ªû_·¿ms_ˆ*)
·¿ms
;

1201 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1202 
»suÉ
;

1204 ià(!
·¿ms
) {

1205  
API_ERR_INVALID_PARAM
;

1208 
	`log_debug
("S‘†ßd b®ªû: hªdË=%04X, mode=%d", 
hªdË
, 
lb_·¿ms
->
mode
);

1211 ià(
lb_·¿ms
->
mode
 > 
LB_MODE_FLOW_AWARE
) {

1212  
API_ERR_INVALID_PARAM
;

1216 ià(!
	`routšg_v®id©e_nic
(
lb_·¿ms
->
´im¬y_nic
) ||

1217 !
	`routšg_v®id©e_nic
(
lb_·¿ms
->
£cÚd¬y_nic
)) {

1218  
API_ERR_NIC_UNAVAILABLE
;

1222 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1223 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1224 
»suÉ
 = 
	`­i_upg¿de_hªdË
(
hªdË
);

1225 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1226  
»suÉ
;

1228 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1229 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1230  
»suÉ
;

1235 
	`memıy
(&
glob®_lb_cÚfig
, 
lb_·¿ms
, (
pd_lßd_b®ªû_·¿ms_t
));

1237 
ext_hªdË
->
æags
 |ğ
HANDLE_FLAG_LOAD_BALANCE
;

1238 
lßd_b®ªcšg_’abËd
 = 
Œue
;

1240 
	`log_šfo
("Lßd b®ªcšgƒÇbËd fÜ hªdË %04X (mode=%d)", 
hªdË
, 
lb_·¿ms
->
mode
);

1241  
API_SUCCESS
;

1242 
	}
}

1250 
	$pd_g‘_nic_¡©us
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1251 
pd_nic_¡©us_t
 *
¡©us
 = (pd_nic_¡©us_ˆ*)
·¿ms
;

1252 
nic_šfo_t
 *
nic
;

1254 ià(!
·¿ms
) {

1255  
API_ERR_INVALID_PARAM
;

1258 
	`log_debug
("G‘ NIC stus: hªdË=%04X,‚ic=%d", 
hªdË
, 
¡©us
->
nic_šdex
);

1261 ià(!
	`routšg_v®id©e_nic
(
¡©us
->
nic_šdex
)) {

1262  
API_ERR_NIC_UNAVAILABLE
;

1266 
nic
 = 
	`h¬dw¬e_g‘_nic
(
¡©us
->
nic_šdex
);

1267 ià(!
nic
) {

1268  
API_ERR_NIC_UNAVAILABLE
;

1272 
¡©us
->¡©u ğ
nic
->status;

1273 
¡©us
->
lšk_¥“d
 = 
nic
->link_speed;

1274 
¡©us
->
utiz©iÚ
 = 
nic_utiz©iÚ
[¡©us->
nic_šdex
];

1275 
¡©us
->
”rÜ_couÁ
 = 
nic_”rÜ_couÁs
[¡©us->
nic_šdex
];

1276 
¡©us
->
Ï¡_”rÜ_time
 = 
	`h¬dw¬e_g‘_Ï¡_”rÜ_time
(¡©us->
nic_šdex
);

1278 
¡©us
->status) {

1279 
NIC_STATUS_UP
:

1280 
	`¡rıy
(
¡©us
->
¡©us_‹xt
, "Link Up");

1282 
NIC_STATUS_DOWN
:

1283 
	`¡rıy
(
¡©us
->
¡©us_‹xt
, "Link Down");

1285 
NIC_STATUS_ERROR
:

1286 
	`¡rıy
(
¡©us
->
¡©us_‹xt
, "Error");

1288 
NIC_STATUS_DEGRADED
:

1289 
	`¡rıy
(
¡©us
->
¡©us_‹xt
, "Degraded");

1292 
	`¡rıy
(
¡©us
->
¡©us_‹xt
, "Unknown");

1296  
API_SUCCESS
;

1297 
	}
}

1305 
	$pd_£t_qos_·¿ms
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1306 
pd_qos_·¿ms_t
 *
qos_·¿ms
 = (pd_qos_·¿ms_ˆ*)
·¿ms
;

1307 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1308 
»suÉ
;

1310 ià(!
·¿ms
) {

1311  
API_ERR_INVALID_PARAM
;

1314 
	`log_debug
("S‘ QoS…¬ams: hªdË=%04X, cÏss=%d", 
hªdË
, 
qos_·¿ms
->
´iÜ™y_şass
);

1317 ià(
qos_·¿ms
->
´iÜ™y_şass
 > 
QOS_CLASS_NETWORK
) {

1318  
API_ERR_INVALID_PARAM
;

1322 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1323 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1324 
»suÉ
 = 
	`­i_upg¿de_hªdË
(
hªdË
);

1325 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1326  
»suÉ
;

1328 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1329 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1330  
»suÉ
;

1335 ià(
qos_·¿ms
->
max_bªdwidth
 > 0) {

1336 
ext_hªdË
->
bªdwidth_lim™
 = 
qos_·¿ms
->
max_bªdwidth
;

1337 
ext_hªdË
->
æags
 |ğ
HANDLE_FLAG_BANDWIDTH_LIMIT
;

1341 
ext_hªdË
->
´iÜ™y
 = (
qos_·¿ms
->
´iÜ™y_şass
 + 1) * 32;

1342 
ext_hªdË
->
æags
 |ğ
HANDLE_FLAG_QOS_ENABLED
;

1344 
qos_’abËd
 = 
Œue
;

1346 
	`log_šfo
("QoSƒnabled for handle %04X (class=%d,…riority=%d)",

1347 
hªdË
, 
qos_·¿ms
->
´iÜ™y_şass
, 
ext_hªdË
->
´iÜ™y
);

1348  
API_SUCCESS
;

1349 
	}
}

1357 
	$pd_g‘_æow_¡©s
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1358 
pd_æow_¡©s_t
 *
æow_¡©s
 = (pd_æow_¡©s_ˆ*)
·¿ms
;

1359 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1360 
»suÉ
;

1362 ià(!
·¿ms
) {

1363  
API_ERR_INVALID_PARAM
;

1366 
	`log_debug
("G‘ flow sts: hªdË=%04X", 
hªdË
);

1369 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1370 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1372 
i
 = 0; i < 
PD_MAX_HANDLES
; i++) {

1373 ià(
hªdËs
[
i
].
hªdË
 == handle) {

1374 
æow_¡©s
->
hªdË
 = handle;

1375 
æow_¡©s
->
æow_id
 = 
hªdË
;

1376 
æow_¡©s
->
·ck‘s_£Á
 = 
hªdËs
[
i
].packets_sent;

1377 
æow_¡©s
->
by‹s_£Á
 = 0;

1378 
æow_¡©s
->
avg_Ï‹ncy
 = 0;

1379 
æow_¡©s
->
j™‹r
 = 0;

1380 
æow_¡©s
->
aùive_nic
 = 
hªdËs
[
i
].
numb”
;

1381 
æow_¡©s
->
æow_¡©e
 = 
FLOW_STATE_ACTIVE
;

1382  
API_SUCCESS
;

1385  
API_ERR_BAD_HANDLE
;

1389 
æow_¡©s
->
hªdË
 = handle;

1390 
æow_¡©s
->
æow_id
 = 
hªdË
;

1391 
æow_¡©s
->
·ck‘s_£Á
 = 
ext_hªdË
->
·ck‘s_rou‹d
;

1392 
æow_¡©s
->
by‹s_£Á
 = 
ext_hªdË
->
by‹s_this_£cÚd
;

1393 
æow_¡©s
->
avg_Ï‹ncy
 = 
	`ÿlcuÏ‹_av”age_Ï‹ncy
(
ext_hªdË
);

1394 
æow_¡©s
->
j™‹r
 = 
	`ÿlcuÏ‹_j™‹r
(
ext_hªdË
);

1395 
æow_¡©s
->
aùive_nic
 = 
ext_hªdË
->
š‹rçû_num
;

1396 
æow_¡©s
->
æow_¡©e
 = (
ext_hªdË
->
æags
 & 
HANDLE_FLAG_ROUTING_AWARE
) ?

1397 
FLOW_STATE_ACTIVE
 : 
FLOW_STATE_INACTIVE
;

1399  
API_SUCCESS
;

1400 
	}
}

1408 
	$pd_£t_nic_´eã»nû
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1409 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1410 
ušt8_t
 *
´eã¼ed_nic
 = (ušt8_ˆ*)
·¿ms
;

1411 
»suÉ
;

1413 ià(!
·¿ms
) {

1414  
API_ERR_INVALID_PARAM
;

1417 
	`log_debug
("S‘ NIC…»ã»nû: hªdË=%04X,‚ic=%d", 
hªdË
, *
´eã¼ed_nic
);

1420 ià(*
´eã¼ed_nic
 !ğ0xFF && !
	`routšg_v®id©e_nic
(*preferred_nic)) {

1421  
API_ERR_NIC_UNAVAILABLE
;

1425 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1426 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1427 
»suÉ
 = 
	`­i_upg¿de_hªdË
(
hªdË
);

1428 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1429  
»suÉ
;

1431 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1432 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1433  
»suÉ
;

1437 
ext_hªdË
->
´eã¼ed_nic
 = *preferred_nic;

1438 
ext_hªdË
->
æags
 |ğ
HANDLE_FLAG_NIC_PREFERENCE
;

1440 
	`log_šfo
("S‘ NIC…»ã»nû %d fÜ hªdË %04X", *
´eã¼ed_nic
, 
hªdË
);

1441  
API_SUCCESS
;

1442 
	}
}

1450 
	$pd_g‘_hªdË_šfo
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1451 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1452 
ex‹nded_·ck‘_hªdË_t
 *
šfo
 = (ex‹nded_·ck‘_hªdË_ˆ*)
·¿ms
;

1453 
»suÉ
;

1455 ià(!
·¿ms
) {

1456  
API_ERR_INVALID_PARAM
;

1459 
	`log_debug
("G‘ hªdË info: hªdË=%04X", 
hªdË
);

1462 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1463 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1464  
API_ERR_BAD_HANDLE
;

1468 
	`memıy
(
šfo
, 
ext_hªdË
, (
ex‹nded_·ck‘_hªdË_t
));

1470  
API_SUCCESS
;

1471 
	}
}

1479 
	$pd_£t_bªdwidth_lim™
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1480 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1481 
ušt32_t
 *
bªdwidth_lim™
 = (ušt32_ˆ*)
·¿ms
;

1482 
»suÉ
;

1484 ià(!
·¿ms
) {

1485  
API_ERR_INVALID_PARAM
;

1488 
	`log_debug
("S‘ bªdwidth†im™: hªdË=%04X,†im™=%lu", 
hªdË
, *
bªdwidth_lim™
);

1491 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1492 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1493 
»suÉ
 = 
	`­i_upg¿de_hªdË
(
hªdË
);

1494 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1495  
»suÉ
;

1497 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1498 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1499  
»suÉ
;

1503 
ext_hªdË
->
bªdwidth_lim™
 = *bandwidth_limit;

1504 ià(*
bªdwidth_lim™
 > 0) {

1505 
ext_hªdË
->
æags
 |ğ
HANDLE_FLAG_BANDWIDTH_LIMIT
;

1507 
ext_hªdË
->
æags
 &ğ~
HANDLE_FLAG_BANDWIDTH_LIMIT
;

1510 
	`log_šfo
("S‘ bªdwidth†im™ %lu by‹s/£øfÜ hªdË %04X", *
bªdwidth_lim™
, 
hªdË
);

1511  
API_SUCCESS
;

1512 
	}
}

1520 
	$pd_g‘_”rÜ_šfo
(
ušt16_t
 
hªdË
, *
·¿ms
) {

1521 
pd_”rÜ_šfo_t
 *
”rÜ_šfo
 = (pd_”rÜ_šfo_ˆ*)
·¿ms
;

1523 ià(!
·¿ms
) {

1524  
API_ERR_INVALID_PARAM
;

1527 
	`log_debug
("G‘ƒ¼Ü info: hªdË=%04X", 
hªdË
);

1530 ià(!
	`pd_v®id©e_hªdË
(
hªdË
)) {

1531  
API_ERR_BAD_HANDLE
;

1535 
”rÜ_šfo
->
”rÜ_code
 = 0;

1536 
”rÜ_šfo
->
”rÜ_time
 = 0;

1537 
”rÜ_šfo
->
afãùed_nic
 = 0xFF;

1538 
”rÜ_šfo
->
”rÜ_£v”™y
 = 
ERROR_SEVERITY_INFO
;

1539 
”rÜ_šfo
->
»cov”y_aùiÚ
 = 0;

1540 
	`¡rıy
(
”rÜ_šfo
->
”rÜ_desütiÚ
, "Noƒrrors");

1542  
API_SUCCESS
;

1543 
	}
}

1554 
	$­i_£Ëù_İtim®_nic
(
ušt16_t
 
hªdË
, cÚ¡ 
ušt8_t
 *
·ck‘
, ušt8_ˆ*
£Ëùed_nic
) {

1555 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1556 
ušt8_t
 
de¡_nic
;

1557 
»suÉ
;

1559 ià(!
·ck‘
 || !
£Ëùed_nic
) {

1560  
API_ERR_INVALID_PARAM
;

1563 *
£Ëùed_nic
 = 0;

1566 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1567 ià(
»suÉ
 =ğ
API_SUCCESS
) {

1569 ià((
ext_hªdË
->
æags
 & 
HANDLE_FLAG_NIC_PREFERENCE
) &&

1570 
ext_hªdË
->
´eã¼ed_nic
 != 0xFF &&

1571 
	`routšg_v®id©e_nic
(
ext_hªdË
->
´eã¼ed_nic
)) {

1572 *
£Ëùed_nic
 = 
ext_hªdË
->
´eã¼ed_nic
;

1573  
API_SUCCESS
;

1577 ià((
ext_hªdË
->
æags
 & 
HANDLE_FLAG_LOAD_BALANCE
è&& 
lßd_b®ªcšg_’abËd
) {

1578  
	`­i_lßd_b®ªû_£Ëù_nic
(
hªdË
, 
·ck‘
, 
£Ëùed_nic
);

1583 ià(
	`routšg_is_’abËd
(è&& 
·ck‘
) {

1584 
·ck‘_bufãr_t
 
routšg_·ck‘
;

1585 
routšg_·ck‘
.
d©a
 = (
ušt8_t
 *)
·ck‘
;

1586 
routšg_·ck‘
.
Ëngth
 = 60;

1588 
rou‹_decisiÚ_t
 
decisiÚ
 = 
	`routšg_decide
(&
routšg_·ck‘
, 0, &
de¡_nic
);

1589 ià(
decisiÚ
 =ğ
ROUTE_DECISION_FORWARD
 && 
	`routšg_v®id©e_nic
(
de¡_nic
)) {

1590 *
£Ëùed_nic
 = 
de¡_nic
;

1593 ià(
ext_hªdË
) {

1594 
ext_hªdË
->
·ck‘s_rou‹d
++;

1596  
API_SUCCESS
;

1601  
	`­i_round_robš_£Ëù_nic
(
£Ëùed_nic
);

1602 
	}
}

1610 
	$­i_check_bªdwidth_lim™
(
ušt16_t
 
hªdË
, 
ušt32_t
 
·ck‘_size
) {

1611 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1612 
ušt32_t
 
cu¼’t_time
;

1613 
»suÉ
;

1616 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1617 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1618  
API_SUCCESS
;

1622 ià(!(
ext_hªdË
->
æags
 & 
HANDLE_FLAG_BANDWIDTH_LIMIT
) ||

1623 
ext_hªdË
->
bªdwidth_lim™
 == 0) {

1624  
API_SUCCESS
;

1629 
cu¼’t_time
 = 
	`g‘_sy¡em_time¡amp
();

1632 ià(
cu¼’t_time
 - 
ext_hªdË
->
time_wšdow_¡¬t
 >= 1000) {

1633 
ext_hªdË
->
by‹s_this_£cÚd
 = 0;

1634 
ext_hªdË
->
time_wšdow_¡¬t
 = 
cu¼’t_time
;

1638 ià(
ext_hªdË
->
by‹s_this_£cÚd
 + 
·ck‘_size
 >ƒxt_hªdË->
bªdwidth_lim™
) {

1639 
ext_hªdË
->
bªdwidth_drİs
++;

1640  
API_ERR_BANDWIDTH_EXCEEDED
;

1644 
ext_hªdË
->
by‹s_this_£cÚd
 +ğ
·ck‘_size
;

1646  
API_SUCCESS
;

1647 
	}
}

1654 
	$­i_hªdË_nic_çu»
(
ušt8_t
 
çed_nic
) {

1655 
hªdËs_afãùed
 = 0;

1657 ià(!
	`routšg_v®id©e_nic
(
çed_nic
)) {

1658  
API_ERR_INVALID_PARAM
;

1661 
	`log_”rÜ
("NIC %d faed, in™Ÿtšg„ecov”y", 
çed_nic
);

1664 ià(
çed_nic
 < 
MAX_NICS
) {

1665 
nic_”rÜ_couÁs
[
çed_nic
]++;

1669 
i
 = 0; i < 
PD_MAX_EXTENDED_HANDLES
; i++) {

1670 ià(
ex‹nded_hªdËs
[
i
].
hªdË_id
 !ğ
PD_INVALID_HANDLE
) {

1672 ià(
ex‹nded_hªdËs
[
i
].
´eã¼ed_nic
 =ğ
çed_nic
 ||

1673 
ex‹nded_hªdËs
[
i
].
š‹rçû_num
 =ğ
çed_nic
) {

1676 
ušt8_t
 
®‹º©e_nic
;

1677 
»suÉ
 = 
	`­i_£Ëù_İtim®_nic
(
ex‹nded_hªdËs
[
i
].
hªdË_id
, 
NULL
, &
®‹º©e_nic
);

1678 ià(
»suÉ
 =ğ
API_SUCCESS
 && 
®‹º©e_nic
 !ğ
çed_nic
) {

1679 
ex‹nded_hªdËs
[
i
].
š‹rçû_num
 = 
®‹º©e_nic
;

1680 
ex‹nded_hªdËs
[
i
].
nic_sw™ches
++;

1681 
hªdËs_afãùed
++;

1683 
	`log_šfo
("Switched handle %04X from NIC %do NIC %d",

1684 
ex‹nded_hªdËs
[
i
].
hªdË_id
, 
çed_nic
, 
®‹º©e_nic
);

1691 
	`­i_coÜdš©e_»cov”y_w™h_routšg
(
çed_nic
);

1693 
	`log_šfo
("NIC fau»„ecov”y com¶‘ed, %d hªdË afãùed", 
hªdËs_afãùed
);

1694  
API_SUCCESS
;

1695 
	}
}

1702 
	$­i_coÜdš©e_»cov”y_w™h_routšg
(
ušt8_t
 
çed_nic
) {

1704 ià(
	`routšg_is_’abËd
()) {

1707 
	`log_šfo
("CoÜdš©šg w™h„outšg sy¡em fÜ NIC %d fau»", 
çed_nic
);

1710 ià(
g_routšg_bË
.
deçuÉ_nic
 =ğ
çed_nic
) {

1712 
i
 = 0; i < 
	`h¬dw¬e_g‘_nic_couÁ
(); i++) {

1713 ià(
i
 !ğ
çed_nic
 && 
	`routšg_v®id©e_nic
(i)) {

1714 
	`routšg_£t_deçuÉ_rou‹
(
i
, 
g_routšg_bË
.
deçuÉ_decisiÚ
);

1715 
	`log_šfo
("Upd©ed deçuÉ„ou‹Øu£ NIC %d", 
i
);

1722  
API_SUCCESS
;

1723 
	}
}

1726 
	$­i_lßd_b®ªû_£Ëù_nic
(
ušt16_t
 
hªdË
, cÚ¡ 
ušt8_t
 *
·ck‘
, ušt8_ˆ*
£Ëùed_nic
) {

1727 
glob®_lb_cÚfig
.
mode
) {

1728 
LB_MODE_ROUND_ROBIN
:

1729  
	`­i_round_robš_£Ëù_nic
(
£Ëùed_nic
);

1731 
LB_MODE_WEIGHTED
:

1732  
	`­i_weigh‹d_£Ëù_nic
(
£Ëùed_nic
);

1734 
LB_MODE_PERFORMANCE
:

1735  
	`­i_³rfÜmªû_£Ëù_nic
(
£Ëùed_nic
);

1737 
LB_MODE_APPLICATION
:

1738  
	`­i_­¶iÿtiÚ_£Ëù_nic
(
hªdË
, 
£Ëùed_nic
);

1740 
LB_MODE_FLOW_AWARE
:

1741  
	`­i_æow_aw¬e_£Ëù_nic
(
hªdË
, 
·ck‘
, 
£Ëùed_nic
);

1744  
	`­i_round_robš_£Ëù_nic
(
£Ëùed_nic
);

1746 
	}
}

1748 
	$­i_round_robš_£Ëù_nic
(
ušt8_t
 *
£Ëùed_nic
) {

1749 
nic_couÁ
 = 
	`h¬dw¬e_g‘_nic_couÁ
();

1751 ià(
nic_couÁ
 <= 0) {

1752  
API_ERR_NIC_UNAVAILABLE
;

1756 
Ï¡_nic_u£d
 = (Ï¡_nic_u£d + 1è% 
nic_couÁ
;

1759 ià(
	`routšg_v®id©e_nic
(
Ï¡_nic_u£d
)) {

1760 *
£Ëùed_nic
 = 
Ï¡_nic_u£d
;

1761  
API_SUCCESS
;

1765 
i
 = 0; i < 
nic_couÁ
; i++) {

1766 ià(
	`routšg_v®id©e_nic
(
i
)) {

1767 *
£Ëùed_nic
 = 
i
;

1768 
Ï¡_nic_u£d
 = 
i
;

1769  
API_SUCCESS
;

1773  
API_ERR_NIC_UNAVAILABLE
;

1774 
	}
}

1776 
	$­i_weigh‹d_£Ëù_nic
(
ušt8_t
 *
£Ëùed_nic
) {

1777 
ušt32_t
 
tÙ®_weight
 = 
glob®_lb_cÚfig
.
weight_´im¬y
 + glob®_lb_cÚfig.
weight_£cÚd¬y
;

1778 
ušt32_t
 
£ËùiÚ_pošt
 = (
Ï¡_nic_u£d
 * 100è% 
tÙ®_weight
;

1780 ià(
£ËùiÚ_pošt
 < 
glob®_lb_cÚfig
.
weight_´im¬y
) {

1781 ià(
	`routšg_v®id©e_nic
(
glob®_lb_cÚfig
.
´im¬y_nic
)) {

1782 *
£Ëùed_nic
 = 
glob®_lb_cÚfig
.
´im¬y_nic
;

1783  
API_SUCCESS
;

1787 ià(
	`routšg_v®id©e_nic
(
glob®_lb_cÚfig
.
£cÚd¬y_nic
)) {

1788 *
£Ëùed_nic
 = 
glob®_lb_cÚfig
.
£cÚd¬y_nic
;

1789  
API_SUCCESS
;

1793  
	`­i_round_robš_£Ëù_nic
(
£Ëùed_nic
);

1794 
	}
}

1796 
	$­i_³rfÜmªû_£Ëù_nic
(
ušt8_t
 *
£Ëùed_nic
) {

1797 
ušt8_t
 
be¡_nic
 = 0;

1798 
ušt32_t
 
be¡_scÜe
 = 0xFFFFFFFF;

1800 
i
 = 0; i < 
	`h¬dw¬e_g‘_nic_couÁ
(); i++) {

1801 ià(!
	`routšg_v®id©e_nic
(
i
)) {

1806 
ušt32_t
 
scÜe
 = 
nic_utiz©iÚ
[
i
] + (
nic_”rÜ_couÁs
[i] * 10);

1808 ià(
scÜe
 < 
be¡_scÜe
) {

1809 
be¡_scÜe
 = 
scÜe
;

1810 
be¡_nic
 = 
i
;

1814 ià(
	`routšg_v®id©e_nic
(
be¡_nic
)) {

1815 *
£Ëùed_nic
 = 
be¡_nic
;

1816  
API_SUCCESS
;

1819  
API_ERR_NIC_UNAVAILABLE
;

1820 
	}
}

1822 
	$­i_­¶iÿtiÚ_£Ëù_nic
(
ušt16_t
 
hªdË
, 
ušt8_t
 *
£Ëùed_nic
) {

1823 
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
;

1824 
»suÉ
;

1827 
»suÉ
 = 
	`­i_g‘_ex‹nded_hªdË
(
hªdË
, &
ext_hªdË
);

1828 ià(
»suÉ
 !ğ
API_SUCCESS
) {

1830  
	`­i_round_robš_£Ëù_nic
(
£Ëùed_nic
);

1834 ià(
ext_hªdË
->
´iÜ™y
 > 192) {

1835 ià(
	`routšg_v®id©e_nic
(
glob®_lb_cÚfig
.
´im¬y_nic
)) {

1836 *
£Ëùed_nic
 = 
glob®_lb_cÚfig
.
´im¬y_nic
;

1837  
API_SUCCESS
;

1839 } ià(
ext_hªdË
->
´iÜ™y
 < 64) {

1840 ià(
	`routšg_v®id©e_nic
(
glob®_lb_cÚfig
.
£cÚd¬y_nic
)) {

1841 *
£Ëùed_nic
 = 
glob®_lb_cÚfig
.
£cÚd¬y_nic
;

1842  
API_SUCCESS
;

1847  
	`­i_³rfÜmªû_£Ëù_nic
(
£Ëùed_nic
);

1848 
	}
}

1850 
	$­i_æow_aw¬e_£Ëù_nic
(
ušt16_t
 
hªdË
, cÚ¡ 
ušt8_t
 *
·ck‘
, ušt8_ˆ*
£Ëùed_nic
) {

1851 ià(!
·ck‘
 || !
£Ëùed_nic
) {

1852  
API_ERR_INVALID_PARAM
;

1856 cÚ¡ 
ušt8_t
 *
de¡_mac
 = 
·ck‘
;

1859 
bridge_’Œy_t
 *
bridge_’Œy
 = 
	`bridge_lookup_mac
(
de¡_mac
);

1860 ià(
bridge_’Œy
 && 
	`routšg_v®id©e_nic
(bridge_’Œy->
nic_šdex
)) {

1861 *
£Ëùed_nic
 = 
bridge_’Œy
->
nic_šdex
;

1862  
API_SUCCESS
;

1866 
»suÉ
 = 
	`­i_³rfÜmªû_£Ëù_nic
(
£Ëùed_nic
);

1869 ià(
»suÉ
 =ğ
API_SUCCESS
 && 
	`routšg_is_’abËd
()) {

1870 
	`bridge_Ë¬n_mac
(
de¡_mac
, *
£Ëùed_nic
);

1873  
»suÉ
;

1874 
	}
}

1882 
	$­i_upd©e_nic_utiz©iÚ
(
ušt8_t
 
nic_šdex
, 
ušt32_t
 
·ck‘_size
) {

1883 ià(
nic_šdex
 >ğ
MAX_NICS
) {

1884  
API_ERR_INVALID_PARAM
;

1889 
nic_utiz©iÚ
[
nic_šdex
] = (nic_utiz©iÚ[nic_šdex] + 
·ck‘_size
) / 2;

1892 ià(
nic_utiz©iÚ
[
nic_šdex
] > 100) {

1893 
nic_utiz©iÚ
[
nic_šdex
] = 100;

1896  
API_SUCCESS
;

1897 
	}
}

1900 
ušt32_t
 
	$ÿlcuÏ‹_av”age_Ï‹ncy
(
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
) {

1901 ià(!
ext_hªdË
 ||ƒxt_hªdË->
·ck‘s_rou‹d
 == 0) {

1906 
	}
}

1908 
ušt32_t
 
	$ÿlcuÏ‹_j™‹r
(
ex‹nded_·ck‘_hªdË_t
 *
ext_hªdË
) {

1909 ià(!
ext_hªdË
) {

1914 
	}
}

1916 
ušt32_t
 
	$g‘_sy¡em_time¡amp
() {

1918 
ušt32_t
 
ticks
;

1920 
__asm__
 
	`__vŞ©e__
(

1925 : "=c" (
ticks
)

1930  
ticks
;

1931 
	}
}

1934 #´agm¨
code_£g
()

	@/Users/jvindahl/Development/3com-packet-driver/src/c/buffer_alloc.c

11 
	~"../šşude/bufãr_®loc.h
"

12 
	~"../šşude/nic_bufãr_poŞs.h
"

13 
	~"../šşude/loggšg.h
"

16 
bufãr_poŞ_t
 
	gg_tx_bufãr_poŞ
;

17 
bufãr_poŞ_t
 
	gg_rx_bufãr_poŞ
;

18 
bufãr_poŞ_t
 
	gg_dma_bufãr_poŞ
;

19 
bufãr_¡©s_t
 
	gg_bufãr_¡©s
;

22 
bufãr_poŞ_t
 
	gg_bufãr_poŞ_64
;

23 
bufãr_poŞ_t
 
	gg_bufãr_poŞ_128
;

24 
bufãr_poŞ_t
 
	gg_bufãr_poŞ_512
;

25 
bufãr_poŞ_t
 
	gg_bufãr_poŞ_1518
;

28 
rx_cİyb»ak_poŞ_t
 
	gg_rx_cİyb»ak_poŞ
 = {0};

31 
ušt32_t
 
	gg_ç¡_·th_®loÿtiÚs
 = 0;

32 
ušt32_t
 
	gg_ç¡_·th_ÿche_h™s
 = 0;

33 
ušt32_t
 
	gg_çÎback_®loÿtiÚs
 = 0;

36 
boŞ
 
	gg_bufãr_sy¡em_š™Ÿlized
 = 
çl£
;

37 
bufãr_”rÜ_t
 
	gg_Ï¡_”rÜ
 = 
BUFFER_ERROR_NONE
;

38 (*
g_”rÜ_hªdËr
)(
bufãr_”rÜ_t
 
”rÜ
, cÚ¡ * 
mes§ge
èğ
NULL
;

41 
	#BUFFER_MAGIC_VALID
 0xBEEFCAFE

	)

42 
	#BUFFER_MAGIC_FREE
 0xDEADBEEF

	)

45 
	`bufãr_£t_Ï¡_”rÜ
(
bufãr_”rÜ_t
 
”rÜ
);

46 
bufãr_desc_t
* 
	`bufãr_desc_ü—‹
(
ušt32_t
 
size
, 
bufãr_ty³_t
 
ty³
, ušt32_ˆ
æags
);

47 
	`bufãr_desc_de¡roy
(
bufãr_desc_t
 *
bufãr
);

48 
boŞ
 
	`bufãr_poŞ_has_¥aû
(cÚ¡ 
bufãr_poŞ_t
 *
poŞ
);

49 
	`bufãr_upd©e_¡©s_®loc
(
ušt32_t
 
size
);

50 
	`bufãr_upd©e_¡©s_ä“
(
ušt32_t
 
size
);

53 
	$bufãr_sy¡em_š™
() {

54 ià(
g_bufãr_sy¡em_š™Ÿlized
) {

55  
SUCCESS
;

59 
	`bufãr_¡©s_š™
(&
g_bufãr_¡©s
);

62 
ušt32_t
 
tÙ®_memÜy
 = 
	`memÜy_xms_avaabË
(è? (
	`memÜy_g‘_xms_size
() * 1024) : (512 * 1024);

63 
»suÉ
 = 
	`nic_bufãr_poŞ_mªag”_š™
(
tÙ®_memÜy
, 
MEMORY_TIER_AUTO
);

64 ià(
»suÉ
 !ğ
SUCCESS
) {

65 
	`log_w¬nšg
("FaedØš™Ÿliz³r-NIC bufã¸poŞs: %d, usšg†egacy…oŞs", 
»suÉ
);

69 
»suÉ
 = 
	`bufãr_š™_deçuÉ_poŞs
();

70 ià(
»suÉ
 !ğ
SUCCESS
) {

71  
»suÉ
;

74 
g_bufãr_sy¡em_š™Ÿlized
 = 
Œue
;

75 
g_Ï¡_”rÜ
 = 
BUFFER_ERROR_NONE
;

77 
	`log_šfo
("Buffer system initialized with…er-NIC buffer…ool support");

78  
SUCCESS
;

79 
	}
}

81 
	$bufãr_sy¡em_ş—nup
() {

82 ià(!
g_bufãr_sy¡em_š™Ÿlized
) {

87 
	`nic_bufãr_poŞ_mªag”_ş—nup
();

90 
	`bufãr_ş—nup_deçuÉ_poŞs
();

93 
	`bufãr_¡©s_š™
(&
g_bufãr_¡©s
);

95 
g_bufãr_sy¡em_š™Ÿlized
 = 
çl£
;

96 
	}
}

98 
	$bufãr_š™_deçuÉ_poŞs
() {

99 
»suÉ
;

100 
ıu_šfo_t
 
g_ıu_šfo
;

103 
ušt32_t
 
tx_bufãrs
 = 16;

104 
ušt32_t
 
rx_bufãrs
 = 32;

105 
ušt32_t
 
dma_bufãrs
 = 8;

108 
ušt32_t
 
poŞ_64_couÁ
 = 32;

109 
ušt32_t
 
poŞ_128_couÁ
 = 24;

110 
ušt32_t
 
poŞ_512_couÁ
 = 16;

111 
ušt32_t
 
poŞ_1518_couÁ
 = 12;

114 ià(
	`memÜy_xms_avaabË
()) {

115 
ušt32_t
 
xms_kb
 = 
	`memÜy_g‘_xms_size
();

116 ià(
xms_kb
 > 1024) {

118 
tx_bufãrs
 = 32;

119 
rx_bufãrs
 = 64;

120 
dma_bufãrs
 = 16;

123 
poŞ_64_couÁ
 = 48;

124 
poŞ_128_couÁ
 = 36;

125 
poŞ_512_couÁ
 = 24;

126 
poŞ_1518_couÁ
 = 18;

129 ià(
xms_kb
 > 4096) {

131 
poŞ_64_couÁ
 = 64;

132 
poŞ_128_couÁ
 = 48;

133 
poŞ_512_couÁ
 = 32;

134 
poŞ_1518_couÁ
 = 24;

139 
ušt32_t
 
tx_æags
 = 
BUFFER_FLAG_ALIGNED
;

140 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

141 
tx_æags
 |ğ
BUFFER_FLAG_ZERO_INIT
;

144 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_tx_bufãr_poŞ
, 
BUFFER_TYPE_TX
,

145 
TX_BUFFER_SIZE
, 
tx_bufãrs
, 
tx_æags
);

146 ià(
»suÉ
 !ğ
SUCCESS
) {

147 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

148  
»suÉ
;

152 
ušt32_t
 
rx_æags
 = 
BUFFER_FLAG_ALIGNED
 | 
BUFFER_FLAG_ZERO_INIT
;

154 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_rx_bufãr_poŞ
, 
BUFFER_TYPE_RX
,

155 
RX_BUFFER_SIZE
, 
rx_bufãrs
, 
rx_æags
);

156 ià(
»suÉ
 !ğ
SUCCESS
) {

157 
	`bufãr_poŞ_ş—nup
(&
g_tx_bufãr_poŞ
);

158 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

159  
»suÉ
;

163 
ušt32_t
 
dma_æags
 = 
BUFFER_FLAG_DMA_CAPABLE
 | 
BUFFER_FLAG_ALIGNED
;

164 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

165 
dma_æags
 |ğ
BUFFER_FLAG_PERSISTENT
;

168 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_dma_bufãr_poŞ
, 
BUFFER_TYPE_DMA_TX
,

169 
DMA_BUFFER_SIZE
, 
dma_bufãrs
, 
dma_æags
);

170 ià(
»suÉ
 !ğ
SUCCESS
) {

171 
	`bufãr_poŞ_ş—nup
(&
g_tx_bufãr_poŞ
);

172 
	`bufãr_poŞ_ş—nup
(&
g_rx_bufãr_poŞ
);

173 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

174  
»suÉ
;

178 
ušt32_t
 
size_poŞ_æags
 = 
BUFFER_FLAG_ALIGNED
;

179 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

180 
size_poŞ_æags
 |ğ
BUFFER_FLAG_ZERO_INIT
;

184 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_bufãr_poŞ_64
, 
BUFFER_TYPE_TX
,

185 64, 
poŞ_64_couÁ
, 
size_poŞ_æags
);

186 ià(
»suÉ
 !ğ
SUCCESS
) {

187 
	`log_w¬nšg
("Failedo initialize 64-byte buffer…ool, using fallback");

189 
	`log_šfo
("In™Ÿlized 64-by‹ bufã¸poŞ w™h %d bufãrs", 
poŞ_64_couÁ
);

193 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_bufãr_poŞ_128
, 
BUFFER_TYPE_TX
,

194 128, 
poŞ_128_couÁ
, 
size_poŞ_æags
);

195 ià(
»suÉ
 !ğ
SUCCESS
) {

196 
	`log_w¬nšg
("Failedo initialize 128-byte buffer…ool, using fallback");

198 
	`log_šfo
("In™Ÿlized 128-by‹ bufã¸poŞ w™h %d bufãrs", 
poŞ_128_couÁ
);

202 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_bufãr_poŞ_512
, 
BUFFER_TYPE_TX
,

203 512, 
poŞ_512_couÁ
, 
size_poŞ_æags
);

204 ià(
»suÉ
 !ğ
SUCCESS
) {

205 
	`log_w¬nšg
("Failedo initialize 512-byte buffer…ool, using fallback");

207 
	`log_šfo
("In™Ÿlized 512-by‹ bufã¸poŞ w™h %d bufãrs", 
poŞ_512_couÁ
);

211 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_bufãr_poŞ_1518
, 
BUFFER_TYPE_TX
,

212 1518, 
poŞ_1518_couÁ
, 
size_poŞ_æags
);

213 ià(
»suÉ
 !ğ
SUCCESS
) {

214 
	`log_w¬nšg
("Failedo initialize 1518-byte buffer…ool, using fallback");

216 
	`log_šfo
("In™Ÿlized 1518-by‹ bufã¸poŞ w™h %d bufãrs", 
poŞ_1518_couÁ
);

219 
	`log_šfo
("Initialized buffer…ools: TX=%d, RX=%d, DMA=%d",

220 
tx_bufãrs
, 
rx_bufãrs
, 
dma_bufãrs
);

221 
	`log_šfo
("Size-specific…ools: 64=%d, 128=%d, 512=%d, 1518=%d",

222 
poŞ_64_couÁ
, 
poŞ_128_couÁ
, 
poŞ_512_couÁ
, 
poŞ_1518_couÁ
);

224  
SUCCESS
;

225 
	}
}

227 
	$bufãr_ş—nup_deçuÉ_poŞs
() {

229 
	`bufãr_poŞ_ş—nup
(&
g_bufãr_poŞ_1518
);

230 
	`bufãr_poŞ_ş—nup
(&
g_bufãr_poŞ_512
);

231 
	`bufãr_poŞ_ş—nup
(&
g_bufãr_poŞ_128
);

232 
	`bufãr_poŞ_ş—nup
(&
g_bufãr_poŞ_64
);

235 
	`bufãr_poŞ_ş—nup
(&
g_dma_bufãr_poŞ
);

236 
	`bufãr_poŞ_ş—nup
(&
g_rx_bufãr_poŞ
);

237 
	`bufãr_poŞ_ş—nup
(&
g_tx_bufãr_poŞ
);

240 
	`log_šfo
("Buffer‡llocation statistics:");

241 
	`log_šfo
(" Fa¡…©h‡ÎoÿtiÚs: %lu", 
g_ç¡_·th_®loÿtiÚs
);

242 
	`log_šfo
(" Fa¡…©h cachh™s: %lu", 
g_ç¡_·th_ÿche_h™s
);

243 
	`log_šfo
(" F®lback‡ÎoÿtiÚs: %lu", 
g_çÎback_®loÿtiÚs
);

244 
	}
}

247 
	$bufãr_poŞ_š™
(
bufãr_poŞ_t
 *
poŞ
, 
bufãr_ty³_t
 
ty³
,

248 
ušt32_t
 
bufãr_size
, ušt32_ˆ
bufãr_couÁ
, ušt32_ˆ
æags
) {

249 ià(!
poŞ
) {

250 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

251  
ERROR_INVALID_PARAM
;

255 
poŞ
->
ä“_li¡
 = 
NULL
;

256 
poŞ
->
u£d_li¡
 = 
NULL
;

257 
poŞ
->
bufãr_size
 = buffer_size;

258 
poŞ
->
bufãr_couÁ
 = buffer_count;

259 
poŞ
->
ä“_couÁ
 = 0;

260 
poŞ
->
u£d_couÁ
 = 0;

261 
poŞ
->
³ak_u§ge
 = 0;

262 
poŞ
->
ty³
 =ype;

263 
poŞ
->
æags
 = flags;

264 
poŞ
->
memÜy_ba£
 = 
NULL
;

265 
poŞ
->
memÜy_size
 = 0;

266 
poŞ
->
š™Ÿlized
 = 
çl£
;

269 
ušt32_t
 
tÙ®_size
 = 
bufãr_couÁ
 * (
bufãr_size
 + (
bufãr_desc_t
));

270 
ušt32_t
 
mem_æags
 = 0;

273 ià(
æags
 & 
BUFFER_FLAG_ALIGNED
) {

274 
mem_æags
 |ğ
MEM_FLAG_ALIGNED
;

276 ià(
æags
 & 
BUFFER_FLAG_DMA_CAPABLE
) {

277 
mem_æags
 |ğ
MEM_FLAG_DMA_CAPABLE
;

279 ià(
æags
 & 
BUFFER_FLAG_ZERO_INIT
) {

280 
mem_æags
 |ğ
MEM_FLAG_ZERO
;

282 ià(
æags
 & 
BUFFER_FLAG_PERSISTENT
) {

283 
mem_æags
 |ğ
MEM_FLAG_PERSISTENT
;

287 ià(
æags
 & 
BUFFER_FLAG_DMA_CAPABLE
) {

288 
poŞ
->
memÜy_ba£
 = 
	`memÜy_®loc_dma
(
tÙ®_size
);

291 
poŞ
->
memÜy_ba£
 = 
	`memÜy_®loc
(
tÙ®_size
, 
MEM_TYPE_PACKET_BUFFER
, 
mem_æags
);

294 ià(!
poŞ
->
memÜy_ba£
) {

295 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

296  
ERROR_NO_MEMORY
;

299 
poŞ
->
memÜy_size
 = 
tÙ®_size
;

302 
ušt8_t
 *
cu¼’t_±r
 = (ušt8_t*)
poŞ
->
memÜy_ba£
;

304 
ušt32_t
 
i
 = 0; i < 
bufãr_couÁ
; i++) {

305 
bufãr_desc_t
 *
desc
 = (bufãr_desc_t*)
cu¼’t_±r
;

306 
cu¼’t_±r
 +ğ(
bufãr_desc_t
);

309 ià(
æags
 & 
BUFFER_FLAG_ALIGNED
) {

310 
ıu_šfo_t
 
g_ıu_šfo
;

311 
ušt32_t
 
®ignm’t
 = (
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) ? 4 : 2;

312 
cu¼’t_±r
 = (
ušt8_t
*)
	`ALIGN_UP
((
ušt32_t
)cu¼’t_±r, 
®ignm’t
);

316 
desc
->
d©a
 = 
cu¼’t_±r
;

317 
desc
->
size
 = 
bufãr_size
;

318 
desc
->
u£d
 = 0;

319 
desc
->
ty³
 =ype;

320 
desc
->
¡©e
 = 
BUFFER_STATE_FREE
;

321 
desc
->
æags
 = flags;

322 
desc
->
time¡amp
 = 0;

323 
desc
->
magic
 = 
BUFFER_MAGIC_FREE
;

324 
desc
->
Ãxt
 = 
poŞ
->
ä“_li¡
;

325 
desc
->
´ev
 = 
NULL
;

326 
desc
->
´iv©e_d©a
 = 
NULL
;

329 ià(
poŞ
->
ä“_li¡
) {

330 
poŞ
->
ä“_li¡
->
´ev
 = 
desc
;

332 
poŞ
->
ä“_li¡
 = 
desc
;

333 
poŞ
->
ä“_couÁ
++;

335 
cu¼’t_±r
 +ğ
bufãr_size
;

338 ià(
æags
 & 
BUFFER_FLAG_ALIGNED
) {

339 
ıu_šfo_t
 
g_ıu_šfo
;

340 
ušt32_t
 
®ignm’t
 = (
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) ? 4 : 2;

341 
cu¼’t_±r
 = (
ušt8_t
*)
	`ALIGN_UP
((
ušt32_t
)cu¼’t_±r, 
®ignm’t
);

345 
poŞ
->
š™Ÿlized
 = 
Œue
;

346  
SUCCESS
;

347 
	}
}

349 
	$bufãr_poŞ_ş—nup
(
bufãr_poŞ_t
 *
poŞ
) {

350 ià(!
poŞ
 || !poŞ->
š™Ÿlized
) {

355 ià(
poŞ
->
memÜy_ba£
) {

356 ià(
poŞ
->
æags
 & 
BUFFER_FLAG_DMA_CAPABLE
) {

357 
	`memÜy_ä“_dma
(
poŞ
->
memÜy_ba£
);

360 
	`memÜy_ä“
(
poŞ
->
memÜy_ba£
);

362 
poŞ
->
memÜy_ba£
 = 
NULL
;

366 
poŞ
->
ä“_li¡
 = 
NULL
;

367 
poŞ
->
u£d_li¡
 = 
NULL
;

368 
poŞ
->
ä“_couÁ
 = 0;

369 
poŞ
->
u£d_couÁ
 = 0;

370 
poŞ
->
memÜy_size
 = 0;

371 
poŞ
->
š™Ÿlized
 = 
çl£
;

372 
	}
}

375 
bufãr_desc_t
* 
	$bufãr_®loc
(
bufãr_poŞ_t
 *
poŞ
) {

376 ià(!
poŞ
 || !poŞ->
š™Ÿlized
) {

377 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

378  
NULL
;

381 ià(!
poŞ
->
ä“_li¡
) {

382 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_POOL_FULL
);

383  
NULL
;

387 
bufãr_desc_t
 *
bufãr
 = 
poŞ
->
ä“_li¡
;

388 
poŞ
->
ä“_li¡
 = 
bufãr
->
Ãxt
;

389 ià(
poŞ
->
ä“_li¡
) {

390 
poŞ
->
ä“_li¡
->
´ev
 = 
NULL
;

392 
poŞ
->
ä“_couÁ
--;

395 
bufãr
->
Ãxt
 = 
poŞ
->
u£d_li¡
;

396 
bufãr
->
´ev
 = 
NULL
;

397 ià(
poŞ
->
u£d_li¡
) {

398 
poŞ
->
u£d_li¡
->
´ev
 = 
bufãr
;

400 
poŞ
->
u£d_li¡
 = 
bufãr
;

401 
poŞ
->
u£d_couÁ
++;

404 ià(
poŞ
->
u£d_couÁ
 >…oŞ->
³ak_u§ge
) {

405 
poŞ
->
³ak_u§ge
 =…oŞ->
u£d_couÁ
;

409 
bufãr
->
¡©e
 = 
BUFFER_STATE_ALLOCATED
;

410 
bufãr
->
magic
 = 
BUFFER_MAGIC_VALID
;

411 
bufãr
->
u£d
 = 0;

412 
bufãr
->
time¡amp
 = 0;

415 ià(
bufãr
->
æags
 & 
BUFFER_FLAG_ZERO_INIT
) {

416 
	`memÜy_£t_İtimized
(
bufãr
->
d©a
, 0, bufãr->
size
);

419 
	`bufãr_upd©e_¡©s_®loc
(
bufãr
->
size
);

421  
bufãr
;

422 
	}
}

424 
	$bufãr_ä“
(
bufãr_poŞ_t
 *
poŞ
, 
bufãr_desc_t
 *
bufãr
) {

425 ià(!
poŞ
 || !
bufãr
 || !poŞ->
š™Ÿlized
) {

426 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

430 ià(!
	`bufãr_is_v®id
(
bufãr
)) {

431 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_BUFFER
);

436 ià(
bufãr
->
´ev
) {

437 
bufãr
->
´ev
->
Ãxt
 = buffer->next;

439 
poŞ
->
u£d_li¡
 = 
bufãr
->
Ãxt
;

442 ià(
bufãr
->
Ãxt
) {

443 
bufãr
->
Ãxt
->
´ev
 = buffer->prev;

445 
poŞ
->
u£d_couÁ
--;

448 
bufãr
->
Ãxt
 = 
poŞ
->
ä“_li¡
;

449 
bufãr
->
´ev
 = 
NULL
;

450 ià(
poŞ
->
ä“_li¡
) {

451 
poŞ
->
ä“_li¡
->
´ev
 = 
bufãr
;

453 
poŞ
->
ä“_li¡
 = 
bufãr
;

454 
poŞ
->
ä“_couÁ
++;

457 
bufãr
->
¡©e
 = 
BUFFER_STATE_FREE
;

458 
bufãr
->
magic
 = 
BUFFER_MAGIC_FREE
;

459 
bufãr
->
u£d
 = 0;

460 
bufãr
->
´iv©e_d©a
 = 
NULL
;

462 
	`bufãr_upd©e_¡©s_ä“
(
bufãr
->
size
);

463 
	}
}

465 
bufãr_desc_t
* 
	$bufãr_®loc_ty³
(
bufãr_ty³_t
 
ty³
) {

466 
ty³
) {

467 
BUFFER_TYPE_TX
:

468 
BUFFER_TYPE_DMA_TX
:

469  
	`bufãr_®loc
(&
g_tx_bufãr_poŞ
);

470 
BUFFER_TYPE_RX
:

471 
BUFFER_TYPE_DMA_RX
:

472  
	`bufãr_®loc
(&
g_rx_bufãr_poŞ
);

473 
BUFFER_TYPE_DESCRIPTOR
:

474 
BUFFER_TYPE_TEMPORARY
:

475  
	`bufãr_®loc
(&
g_dma_bufãr_poŞ
);

477 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

478  
NULL
;

480 
	}
}

482 
	$bufãr_ä“_ªy
(
bufãr_desc_t
 *
bufãr
) {

483 ià(!
bufãr
) {

488 
bufãr
->
ty³
) {

489 
BUFFER_TYPE_TX
:

490 
BUFFER_TYPE_DMA_TX
:

491 
	`bufãr_ä“
(&
g_tx_bufãr_poŞ
, 
bufãr
);

493 
BUFFER_TYPE_RX
:

494 
BUFFER_TYPE_DMA_RX
:

495 
	`bufãr_ä“
(&
g_rx_bufãr_poŞ
, 
bufãr
);

497 
BUFFER_TYPE_DESCRIPTOR
:

498 
BUFFER_TYPE_TEMPORARY
:

499 
	`bufãr_ä“
(&
g_dma_bufãr_poŞ
, 
bufãr
);

502 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_BUFFER
);

505 
	}
}

508 
boŞ
 
	$bufãr_is_v®id
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

509 ià(!
bufãr
) {

510  
çl£
;

513  (
bufãr
->
magic
 =ğ
BUFFER_MAGIC_VALID
) &&

514 (
bufãr
->
¡©e
 !ğ
BUFFER_STATE_FREE
);

515 
	}
}

517 
boŞ
 
	$bufãr_v®id©e_magic
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

518 ià(!
bufãr
) {

519  
çl£
;

522  (
bufãr
->
magic
 =ğ
BUFFER_MAGIC_VALID
 ||

523 
bufãr
->
magic
 =ğ
BUFFER_MAGIC_FREE
);

524 
	}
}

527 
	$bufãr_£t_¡©e
(
bufãr_desc_t
 *
bufãr
, 
bufãr_¡©e_t
 
¡©e
) {

528 ià(!
bufãr
 || !
	`bufãr_is_v®id
(buffer)) {

532 
bufãr
->
¡©e
 = state;

533 
	}
}

535 
bufãr_¡©e_t
 
	$bufãr_g‘_¡©e
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

536 ià(!
bufãr
 || !
	`bufãr_is_v®id
(buffer)) {

537  
BUFFER_STATE_ERROR
;

540  
bufãr
->
¡©e
;

541 
	}
}

543 
boŞ
 
	$bufãr_is_ä“
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

544  
bufãr
 && (bufãr->
¡©e
 =ğ
BUFFER_STATE_FREE
);

545 
	}
}

547 
boŞ
 
	$bufãr_is_®loÿ‹d
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

548  
bufãr
 && (bufãr->
¡©e
 =ğ
BUFFER_STATE_ALLOCATED
);

549 
	}
}

551 
boŞ
 
	$bufãr_is_š_u£
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

552  
bufãr
 && (bufãr->
¡©e
 =ğ
BUFFER_STATE_IN_USE
);

553 
	}
}

556 
	$bufãr_£t_d©a
(
bufãr_desc_t
 *
bufãr
, cÚ¡ *
d©a
, 
ušt32_t
 
size
) {

557 ià(!
bufãr
 || !
	`bufãr_is_v®id
(bufãrè|| !
d©a
) {

558 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

559  
ERROR_INVALID_PARAM
;

562 ià(
size
 > 
bufãr
->size) {

563 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_SIZE_MISMATCH
);

564  
ERROR_INVALID_PARAM
;

567 
	`memÜy_cİy_İtimized
(
bufãr
->
d©a
, d©a, 
size
);

568 
bufãr
->
u£d
 = 
size
;

570  
SUCCESS
;

571 
	}
}

573 
	$bufãr_­³nd_d©a
(
bufãr_desc_t
 *
bufãr
, cÚ¡ *
d©a
, 
ušt32_t
 
size
) {

574 ià(!
bufãr
 || !
	`bufãr_is_v®id
(bufãrè|| !
d©a
) {

575 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

576  
ERROR_INVALID_PARAM
;

579 ià(
bufãr
->
u£d
 + 
size
 > buffer->size) {

580 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_SIZE_MISMATCH
);

581  
ERROR_INVALID_PARAM
;

584 
	`memÜy_cİy_İtimized
((
ušt8_t
*)
bufãr
->
d©a
 + bufãr->
u£d
, d©a, 
size
);

585 
bufãr
->
u£d
 +ğ
size
;

587  
SUCCESS
;

588 
	}
}

591 
ušt32_t
 
	$bufãr_g‘_size
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

592  
bufãr
 ? bufãr->
size
 : 0;

593 
	}
}

595 
ušt32_t
 
	$bufãr_g‘_u£d_size
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

596  
bufãr
 ? bufãr->
u£d
 : 0;

597 
	}
}

599 
ušt32_t
 
	$bufãr_g‘_ä“_size
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

600  
bufãr
 ? (bufãr->
size
 - bufãr->
u£d
) : 0;

601 
	}
}

603 * 
	$bufãr_g‘_d©a_±r
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

604  
bufãr
 ? bufãr->
d©a
 : 
NULL
;

605 
	}
}

607 
bufãr_ty³_t
 
	$bufãr_g‘_ty³
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

608  
bufãr
 ? bufãr->
ty³
 : 
BUFFER_TYPE_TEMPORARY
;

609 
	}
}

612 
ušt32_t
 
	$bufãr_poŞ_g‘_ä“_couÁ
(cÚ¡ 
bufãr_poŞ_t
 *
poŞ
) {

613  
poŞ
 ?…oŞ->
ä“_couÁ
 : 0;

614 
	}
}

616 
ušt32_t
 
	$bufãr_poŞ_g‘_u£d_couÁ
(cÚ¡ 
bufãr_poŞ_t
 *
poŞ
) {

617  
poŞ
 ?…oŞ->
u£d_couÁ
 : 0;

618 
	}
}

620 
ušt32_t
 
	$bufãr_poŞ_g‘_tÙ®_couÁ
(cÚ¡ 
bufãr_poŞ_t
 *
poŞ
) {

621  
poŞ
 ?…oŞ->
bufãr_couÁ
 : 0;

622 
	}
}

624 
boŞ
 
	$bufãr_poŞ_is_em±y
(cÚ¡ 
bufãr_poŞ_t
 *
poŞ
) {

625  
poŞ
 ? (poŞ->
u£d_couÁ
 =ğ0è: 
Œue
;

626 
	}
}

628 
boŞ
 
	$bufãr_poŞ_is_fuÎ
(cÚ¡ 
bufãr_poŞ_t
 *
poŞ
) {

629  
poŞ
 ? (poŞ->
ä“_couÁ
 =ğ0è: 
Œue
;

630 
	}
}

633 
	$bufãr_¡©s_š™
(
bufãr_¡©s_t
 *
¡©s
) {

634 ià(!
¡©s
) {

638 
	`memÜy_z”o
(
¡©s
, (
bufãr_¡©s_t
));

639 
	}
}

641 cÚ¡ 
bufãr_¡©s_t
* 
	$bufãr_g‘_¡©s
() {

642  &
g_bufãr_¡©s
;

643 
	}
}

645 
	$bufãr_ş—r_¡©s
() {

646 
	`bufãr_¡©s_š™
(&
g_bufãr_¡©s
);

647 
	}
}

650 
bufãr_”rÜ_t
 
	$bufãr_g‘_Ï¡_”rÜ
() {

651  
g_Ï¡_”rÜ
;

652 
	}
}

654 cÚ¡ * 
	$bufãr_”rÜ_to_¡ršg
(
bufãr_”rÜ_t
 
”rÜ
) {

655 
”rÜ
) {

656 
BUFFER_ERROR_NONE
:  "Noƒrror";

657 
BUFFER_ERROR_INVALID_PARAM
:  "Invalid…arameter";

658 
BUFFER_ERROR_OUT_OF_MEMORY
:  "Out of memory";

659 
BUFFER_ERROR_POOL_FULL
:  "Buffer…ool full";

660 
BUFFER_ERROR_INVALID_BUFFER
:  "Invalid buffer";

661 
BUFFER_ERROR_BUFFER_IN_USE
:  "Buffer in use";

662 
BUFFER_ERROR_SIZE_MISMATCH
:  "Size mismatch";

663 
BUFFER_ERROR_ALIGNMENT
:  "Alignmentƒrror";

664 
BUFFER_ERROR_CORRUPTION
:  "Buffer corruption";

667 
	}
}

669 
bufãr_£t_”rÜ_hªdËr
((*
hªdËr
)(
bufãr_”rÜ_t
 
”rÜ
, cÚ¡ * 
mes§ge
)) {

670 
g_”rÜ_hªdËr
 = 
hªdËr
;

671 
	}
}

674 
	$bufãr_£t_Ï¡_”rÜ
(
bufãr_”rÜ_t
 
”rÜ
) {

675 
g_Ï¡_”rÜ
 = 
”rÜ
;

677 ià(
g_”rÜ_hªdËr
) {

678 
	`g_”rÜ_hªdËr
(
”rÜ
, 
	`bufãr_”rÜ_to_¡ršg
(error));

680 
	}
}

682 
	$bufãr_upd©e_¡©s_®loc
(
ušt32_t
 
size
) {

683 
g_bufãr_¡©s
.
tÙ®_®loÿtiÚs
++;

684 
g_bufãr_¡©s
.
cu¼’t_®loÿ‹d
++;

685 
g_bufãr_¡©s
.
by‹s_®loÿ‹d
 +ğ
size
;

687 ià(
g_bufãr_¡©s
.
cu¼’t_®loÿ‹d
 > g_bufãr_¡©s.
³ak_®loÿ‹d
) {

688 
g_bufãr_¡©s
.
³ak_®loÿ‹d
 = g_bufãr_¡©s.
cu¼’t_®loÿ‹d
;

690 
	}
}

692 
	$bufãr_upd©e_¡©s_ä“
(
ušt32_t
 
size
) {

693 
g_bufãr_¡©s
.
tÙ®_ä“s
++;

694 ià(
g_bufãr_¡©s
.
cu¼’t_®loÿ‹d
 > 0) {

695 
g_bufãr_¡©s
.
cu¼’t_®loÿ‹d
--;

697 
g_bufãr_¡©s
.
by‹s_ä“d
 +ğ
size
;

698 
	}
}

708 
	$rx_cİyb»ak_š™
(
ušt32_t
 
sm®l_couÁ
, ušt32_ˆ
Ïrge_couÁ
) {

709 
»suÉ
;

710 
ıu_šfo_t
 
g_ıu_šfo
;

713 ià(
sm®l_couÁ
 =ğ0 || 
Ïrge_couÁ
 == 0) {

714 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

715  
ERROR_INVALID_PARAM
;

719 ià(
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
š™Ÿlized
 || g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.initialized) {

720 
	`log_w¬nšg
("RX_COPYBREAK…ool‡lready initialized, cleaning up first");

721 
	`rx_cİyb»ak_ş—nup
();

725 
g_rx_cİyb»ak_poŞ
.
sm®l_bufãr_couÁ
 = 
sm®l_couÁ
;

726 
g_rx_cİyb»ak_poŞ
.
Ïrge_bufãr_couÁ
 = 
Ïrge_couÁ
;

727 
g_rx_cİyb»ak_poŞ
.
cİyb»ak_th»shŞd
 = 
RX_COPYBREAK_THRESHOLD
;

730 
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
 = 0;

731 
g_rx_cİyb»ak_poŞ
.
Ïrge_®loÿtiÚs
 = 0;

732 
g_rx_cİyb»ak_poŞ
.
cİy_İ”©iÚs
 = 0;

733 
g_rx_cİyb»ak_poŞ
.
memÜy_§ved
 = 0;

736 
ušt32_t
 
poŞ_æags
 = 
BUFFER_FLAG_ALIGNED
;

737 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

738 
poŞ_æags
 |ğ
BUFFER_FLAG_ZERO_INIT
;

742 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
, 
BUFFER_TYPE_RX
,

743 
SMALL_BUFFER_SIZE
, 
sm®l_couÁ
, 
poŞ_æags
);

744 ià(
»suÉ
 !ğ
SUCCESS
) {

745 
	`log_”rÜ
("Failedo initialize RX_COPYBREAK small buffer…ool: %s",

746 
	`bufãr_”rÜ_to_¡ršg
(
	`bufãr_g‘_Ï¡_”rÜ
()));

747 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

748  
»suÉ
;

752 
»suÉ
 = 
	`bufãr_poŞ_š™
(&
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
, 
BUFFER_TYPE_RX
,

753 
LARGE_BUFFER_SIZE
, 
Ïrge_couÁ
, 
poŞ_æags
);

754 ià(
»suÉ
 !ğ
SUCCESS
) {

755 
	`log_”rÜ
("Failedo initialize RX_COPYBREAK†arge buffer…ool: %s",

756 
	`bufãr_”rÜ_to_¡ršg
(
	`bufãr_g‘_Ï¡_”rÜ
()));

757 
	`bufãr_poŞ_ş—nup
(&
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
);

758 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

759  
»suÉ
;

762 
	`log_šfo
("RX_COPYBREAK optimization initialized: small=%u (%u bytes),†arge=%u (%u bytes),hreshold=%u",

763 
sm®l_couÁ
, 
SMALL_BUFFER_SIZE
, 
Ïrge_couÁ
, 
LARGE_BUFFER_SIZE
, 
RX_COPYBREAK_THRESHOLD
);

765  
SUCCESS
;

766 
	}
}

771 
	$rx_cİyb»ak_ş—nup
() {

773 ià(
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
š™Ÿlized
 || g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.initialized) {

774 
	`log_šfo
("RX_COPYBREAK statistics: small_allocs=%lu,†arge_allocs=%lu, copy_ops=%lu, memory_saved=%lu bytes",

775 
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
,

776 
g_rx_cİyb»ak_poŞ
.
Ïrge_®loÿtiÚs
,

777 
g_rx_cİyb»ak_poŞ
.
cİy_İ”©iÚs
,

778 
g_rx_cİyb»ak_poŞ
.
memÜy_§ved
);

782 
	`bufãr_poŞ_ş—nup
(&
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
);

783 
	`bufãr_poŞ_ş—nup
(&
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
);

786 
	`memÜy_z”o
(&
g_rx_cİyb»ak_poŞ
, (
rx_cİyb»ak_poŞ_t
));

787 
	}
}

794 
bufãr_desc_t
* 
	$rx_cİyb»ak_®loc
(
ušt32_t
 
·ck‘_size
) {

795 
bufãr_desc_t
 *
bufãr
 = 
NULL
;

796 
bufãr_poŞ_t
 *
£Ëùed_poŞ
 = 
NULL
;

797 
ušt32_t
 
memÜy_§ved
 = 0;

800 ià(
·ck‘_size
 == 0) {

801 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

802  
NULL
;

806 ià(!
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
š™Ÿlized
 || !g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.initialized) {

807 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

808 
	`log_”rÜ
("RX_COPYBREAK‚ot initialized, call„x_copybreak_init() first");

809  
NULL
;

813 ià(
·ck‘_size
 < 
g_rx_cİyb»ak_poŞ
.
cİyb»ak_th»shŞd
) {

815 
£Ëùed_poŞ
 = &
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
;

818 
memÜy_§ved
 = 
LARGE_BUFFER_SIZE
 - 
SMALL_BUFFER_SIZE
;

821 
bufãr
 = 
	`bufãr_®loc
(
£Ëùed_poŞ
);

822 ià(
bufãr
) {

823 
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
++;

824 
g_rx_cİyb»ak_poŞ
.
memÜy_§ved
 += memory_saved;

829 
	`log_debug
("RX_COPYBREAK:‡llocated small buffer (%u bytes) for…acket size %u, saved %u bytes",

830 
SMALL_BUFFER_SIZE
, 
·ck‘_size
, 
memÜy_§ved
);

831  
bufãr
;

833 
	`log_debug
("RX_COPYBREAK: small…oolƒxhausted for…acket size %u, falling backo†arge…ool",

834 
·ck‘_size
);

839 
£Ëùed_poŞ
 = &
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
;

840 
bufãr
 = 
	`bufãr_®loc
(
£Ëùed_poŞ
);

842 ià(
bufãr
) {

843 
g_rx_cİyb»ak_poŞ
.
Ïrge_®loÿtiÚs
++;

845 
	`log_debug
("RX_COPYBREAK:‡llocated†arge buffer (%u bytes) for…acket size %u",

846 
LARGE_BUFFER_SIZE
, 
·ck‘_size
);

847  
bufãr
;

851 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_POOL_FULL
);

852 
	`log_w¬nšg
("RX_COPYBREAK:‡Î…oŞ exhau¡ed fÜ…ack‘ siz%u", 
·ck‘_size
);

853  
NULL
;

854 
	}
}

860 
	$rx_cİyb»ak_ä“
(
bufãr_desc_t
* 
bufãr
) {

861 ià(!
bufãr
) {

862 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

866 ià(!
	`bufãr_is_v®id
(
bufãr
)) {

867 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_BUFFER
);

868 
	`log_”rÜ
("RX_COPYBREAK:‡ttemptingo free invalid buffer");

873 ià(!
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
š™Ÿlized
 || !g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.initialized) {

874 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

875 
	`log_”rÜ
("RX_COPYBREAK‚ot initialized, cannot determine which…ool buffer belongso");

880 ià(
bufãr
->
size
 =ğ
SMALL_BUFFER_SIZE
) {

882 
	`bufãr_ä“
(&
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
, 
bufãr
);

883 
	`log_debug
("RX_COPYBREAK: f»ed sm®Èbufã¸(%u by‹s)", 
bufãr
->
size
);

884 } ià(
bufãr
->
size
 =ğ
LARGE_BUFFER_SIZE
) {

886 
	`bufãr_ä“
(&
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
, 
bufãr
);

887 
	`log_debug
("RX_COPYBREAK: f»ed†¬gbufã¸(%u by‹s)", 
bufãr
->
size
);

890 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_BUFFER
);

891 
	`log_”rÜ
("RX_COPYBREAK: bufã¸siz%u dÛ¢'ˆm©ch‡ny RX_COPYBREAK…oŞ", 
bufãr
->
size
);

894 
	}
}

900 
	$rx_cİyb»ak_g‘_¡©s
(
rx_cİyb»ak_poŞ_t
* 
¡©s
) {

902 ià(!
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
š™Ÿlized
 || !g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.initialized) {

903 
	`log_w¬nšg
("RX_COPYBREAK‚ot initialized, statistics‚ot‡vailable");

904 ià(
¡©s
) {

905 
	`memÜy_z”o
(
¡©s
, (
rx_cİyb»ak_poŞ_t
));

911 ià(
¡©s
) {

912 
	`memÜy_cİy_İtimized
(
¡©s
, &
g_rx_cİyb»ak_poŞ
, (
rx_cİyb»ak_poŞ_t
));

916 
	`log_šfo
("RX_COPYBREAK Statistics:");

917 
	`log_šfo
(" Th»shŞd: %u by‹s", 
g_rx_cİyb»ak_poŞ
.
cİyb»ak_th»shŞd
);

918 
	`log_šfo
(" Small…ool: %u buffers (%u bytesƒach), %u free, %u used,…eak: %u",

919 
g_rx_cİyb»ak_poŞ
.
sm®l_bufãr_couÁ
, 
SMALL_BUFFER_SIZE
,

920 
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
ä“_couÁ
,

921 
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
u£d_couÁ
,

922 
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
³ak_u§ge
);

923 
	`log_šfo
(" Large…ool: %u buffers (%u bytesƒach), %u free, %u used,…eak: %u",

924 
g_rx_cİyb»ak_poŞ
.
Ïrge_bufãr_couÁ
, 
LARGE_BUFFER_SIZE
,

925 
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
.
ä“_couÁ
,

926 
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
.
u£d_couÁ
,

927 
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
.
³ak_u§ge
);

928 
	`log_šfo
(" Allocations: %lu small, %lu†arge",

929 
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
,

930 
g_rx_cİyb»ak_poŞ
.
Ïrge_®loÿtiÚs
);

931 
	`log_šfo
(" Cİy o³¿tiÚs: %lu", 
g_rx_cİyb»ak_poŞ
.
cİy_İ”©iÚs
);

932 
	`log_šfo
(" MemÜy saved: %lu by‹s", 
g_rx_cİyb»ak_poŞ
.
memÜy_§ved
);

935 
ušt32_t
 
tÙ®_®loÿtiÚs
 = 
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
 + g_rx_cİyb»ak_poŞ.
Ïrge_®loÿtiÚs
;

936 ià(
tÙ®_®loÿtiÚs
 > 0) {

937 
ušt32_t
 
sm®l_³rûÁage
 = (
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
 * 100è/ 
tÙ®_®loÿtiÚs
;

938 
	`log_šfo
(" Efficiency: %u%% small buffer usage, %lu bytes‡verage saved…er‡llocation",

939 
sm®l_³rûÁage
,

940 
tÙ®_®loÿtiÚs
 > 0 ? 
g_rx_cİyb»ak_poŞ
.
memÜy_§ved
 /otal_allocations : 0);

942 
	}
}

950 
	$rx_cİyb»ak_»size_poŞs
(
ušt32_t
 
Ãw_sm®l_couÁ
, ušt32_ˆ
Ãw_Ïrge_couÁ
) {

952 ià(!
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
š™Ÿlized
 || !g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.initialized) {

953 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

954 
	`log_”rÜ
("RX_COPYBREAK‚ot initialized, cannot„esize…ools");

955  
ERROR_INVALID_PARAM
;

959 ià(
Ãw_sm®l_couÁ
 =ğ0 || 
Ãw_Ïrge_couÁ
 == 0) {

960 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

961 
	`log_”rÜ
("Inv®id…oŞ sizes: sm®l=%u,†¬ge=%u", 
Ãw_sm®l_couÁ
, 
Ãw_Ïrge_couÁ
);

962  
ERROR_INVALID_PARAM
;

966 ià(
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
u£d_couÁ
 > 0 || g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.used_count > 0) {

967 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_BUFFER_IN_USE
);

968 
	`log_”rÜ
("Cannot„esize RX_COPYBREAK…ools while buffers‡re in use (small: %u,†arge: %u)",

969 
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
u£d_couÁ
,

970 
g_rx_cİyb»ak_poŞ
.
Ïrge_poŞ
.
u£d_couÁ
);

971  
ERROR_INVALID_PARAM
;

975 
ušt32_t
 
Şd_sm®l_®locs
 = 
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
;

976 
ušt32_t
 
Şd_Ïrge_®locs
 = 
g_rx_cİyb»ak_poŞ
.
Ïrge_®loÿtiÚs
;

977 
ušt32_t
 
Şd_cİy_İs
 = 
g_rx_cİyb»ak_poŞ
.
cİy_İ”©iÚs
;

978 
ušt32_t
 
Şd_memÜy_§ved
 = 
g_rx_cİyb»ak_poŞ
.
memÜy_§ved
;

980 
	`log_šfo
("Resizing RX_COPYBREAK…ools from small=%u,†arge=%uo small=%u,†arge=%u",

981 
g_rx_cİyb»ak_poŞ
.
sm®l_bufãr_couÁ
, g_rx_cİyb»ak_poŞ.
Ïrge_bufãr_couÁ
,

982 
Ãw_sm®l_couÁ
, 
Ãw_Ïrge_couÁ
);

985 
	`rx_cİyb»ak_ş—nup
();

988 
»suÉ
 = 
	`rx_cİyb»ak_š™
(
Ãw_sm®l_couÁ
, 
Ãw_Ïrge_couÁ
);

989 ià(
»suÉ
 !ğ
SUCCESS
) {

990 
	`log_”rÜ
("Failedo„einitialize RX_COPYBREAK with‚ew sizes");

991  
»suÉ
;

995 
g_rx_cİyb»ak_poŞ
.
sm®l_®loÿtiÚs
 = 
Şd_sm®l_®locs
;

996 
g_rx_cİyb»ak_poŞ
.
Ïrge_®loÿtiÚs
 = 
Şd_Ïrge_®locs
;

997 
g_rx_cİyb»ak_poŞ
.
cİy_İ”©iÚs
 = 
Şd_cİy_İs
;

998 
g_rx_cİyb»ak_poŞ
.
memÜy_§ved
 = 
Şd_memÜy_§ved
;

1000 
	`log_šfo
("RX_COPYBREAK…ools„esized successfully");

1001  
SUCCESS
;

1002 
	}
}

1010 
	$rx_cİyb»ak_»cÜd_cİy
() {

1012 ià(
g_rx_cİyb»ak_poŞ
.
sm®l_poŞ
.
š™Ÿlized
 || g_rx_cİyb»ak_poŞ.
Ïrge_poŞ
.initialized) {

1013 
g_rx_cİyb»ak_poŞ
.
cİy_İ”©iÚs
++;

1015 
	}
}

1025 
šlše
 
ušt16_t
 
	$œq_§ve_di§bË
() {

1026 
ušt16_t
 
æags
;

1027 
__asm__
 
	`__vŞ©e__
(

1031 : "ô"(
æags
)

1035  
æags
;

1036 
	}
}

1042 
šlše
 
	$œq_»¡Üe
(
ušt16_t
 
æags
) {

1043 
__asm__
 
	`__vŞ©e__
(

1047 : "r"(
æags
)

1050 
	}
}

1056 
	~"../šşude/xms_d‘eù.h
"

1059 
xms_bufãr_poŞ_t
 
	gg_xms_poŞ
 = {0};

1060 
¡agšg_bufãr_t
 *
	gg_¡agšg_bufãrs
 = 
NULL
;

1061 
¡agšg_bufãr_t
 *
	gg_¡agšg_ä“li¡
 = 
NULL
;

1062 
ušt32_t
 
	gg_¡agšg_couÁ
 = 0;

1063 
ušt32_t
 
	gg_¡agšg_size
 = 0;

1064 
¥sc_queue_t
 
	gg_deã¼ed_queue
 = {0};

1073 
	$xms_bufãr_poŞ_š™
(
xms_bufãr_poŞ_t
 *
poŞ
, 
ušt32_t
 
bufãr_size
, ušt32_ˆ
bufãr_couÁ
) {

1074 
»suÉ
;

1075 
ušt32_t
 
tÙ®_size_kb
;

1077 ià(!
poŞ
 || 
bufãr_size
 =ğ0 || 
bufãr_couÁ
 == 0 || buffer_count > 32) {

1078 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1079  
ERROR_INVALID_PARAM
;

1083 ià(!
	`xms_is_avaabË
()) {

1084 
	`log_w¬nšg
("XMS‚ot‡vailable, cannot initialize XMS buffer…ool");

1085 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

1086  
ERROR_NOT_SUPPORTED
;

1090 
tÙ®_size_kb
 = ((
bufãr_size
 * 
bufãr_couÁ
) + 1023) / 1024;

1093 
»suÉ
 = 
	`xms_®loÿ‹
(
tÙ®_size_kb
, &
poŞ
->
xms_hªdË
);

1094 ià(
»suÉ
 !ğ
XMS_SUCCESS
) {

1095 
	`log_”rÜ
("FaedØ®loÿ‹ %u KB oàXMS memÜy: %d", 
tÙ®_size_kb
, 
»suÉ
);

1096 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

1097  
»suÉ
;

1101 
poŞ
->
tÙ®_size
 = 
tÙ®_size_kb
 * 1024;

1102 
poŞ
->
bufãr_size
 = buffer_size;

1103 
poŞ
->
bufãr_couÁ
 = buffer_count;

1104 
poŞ
->
ä“_m­
 = (1UL << 
bufãr_couÁ
) - 1;

1105 
poŞ
->
¡agšg_off£t
 = 0;

1108 
poŞ
->
xms_®loÿtiÚs
 = 0;

1109 
poŞ
->
xms_ä“s
 = 0;

1110 
poŞ
->
xms_cİ›s_to
 = 0;

1111 
poŞ
->
xms_cİ›s_äom
 = 0;

1112 
poŞ
->
³ak_u§ge
 = 0;

1114 
	`log_šfo
("Initialized XMS buffer…ool: %u buffers of %u bytes (%u KBotal)",

1115 
bufãr_couÁ
, 
bufãr_size
, 
tÙ®_size_kb
);

1117  
SUCCESS
;

1118 
	}
}

1124 
	$xms_bufãr_poŞ_ş—nup
(
xms_bufãr_poŞ_t
 *
poŞ
) {

1125 ià(!
poŞ
 ||…oŞ->
xms_hªdË
 == 0) {

1130 
	`log_šfo
("XMS…ool statistics:‡llocs=%lu, frees=%lu, copies_to=%lu, copies_from=%lu,…eak=%lu",

1131 
poŞ
->
xms_®loÿtiÚs
,…oŞ->
xms_ä“s
,

1132 
poŞ
->
xms_cİ›s_to
,…oŞ->
xms_cİ›s_äom
,…oŞ->
³ak_u§ge
);

1135 
	`xms_ä“
(
poŞ
->
xms_hªdË
);

1138 
	`memÜy_z”o
(
poŞ
, (
xms_bufãr_poŞ_t
));

1139 
	}
}

1147 
	$xms_bufãr_®loc
(
xms_bufãr_poŞ_t
 *
poŞ
, 
ušt32_t
 *
bufãr_off£t
) {

1148 
ušt32_t
 
i
;

1149 
ušt32_t
 
u£d_couÁ
;

1151 ià(!
poŞ
 || !
bufãr_off£t
 ||…oŞ->
xms_hªdË
 == 0) {

1152 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1153  
ERROR_INVALID_PARAM
;

1157 
i
 = 0; i < 
poŞ
->
bufãr_couÁ
; i++) {

1158 ià(
poŞ
->
ä“_m­
 & (1UL << 
i
)) {

1160 
poŞ
->
ä“_m­
 &ğ~(1UL << 
i
);

1163 *
bufãr_off£t
 = 
i
 * 
poŞ
->
bufãr_size
;

1166 
poŞ
->
xms_®loÿtiÚs
++;

1168 
u£d_couÁ
 = 0;

1169 
ušt32_t
 
j
 = 0; j < 
poŞ
->
bufãr_couÁ
; j++) {

1170 ià(!(
poŞ
->
ä“_m­
 & (1UL << 
j
))) {

1171 
u£d_couÁ
++;

1174 ià(
u£d_couÁ
 > 
poŞ
->
³ak_u§ge
) {

1175 
poŞ
->
³ak_u§ge
 = 
u£d_couÁ
;

1178 
	`log_debug
("AÎoÿ‹d XMS bufã¸%u‡ˆoff£ˆ%u", 
i
, *
bufãr_off£t
);

1179  
SUCCESS
;

1184 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_POOL_FULL
);

1185 
	`log_w¬nšg
("XMS buffer…oolƒxhausted");

1186  
ERROR_NO_MEMORY
;

1187 
	}
}

1194 
	$xms_bufãr_ä“
(
xms_bufãr_poŞ_t
 *
poŞ
, 
ušt32_t
 
bufãr_off£t
) {

1195 
ušt32_t
 
bufãr_šdex
;

1197 ià(!
poŞ
 ||…oŞ->
xms_hªdË
 == 0) {

1198 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1203 
bufãr_šdex
 = 
bufãr_off£t
 / 
poŞ
->
bufãr_size
;

1204 ià(
bufãr_šdex
 >ğ
poŞ
->
bufãr_couÁ
) {

1205 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_BUFFER
);

1206 
	`log_”rÜ
("Inv®id XMS bufã¸off£ˆ%u", 
bufãr_off£t
);

1211 ià(
poŞ
->
ä“_m­
 & (1UL << 
bufãr_šdex
)) {

1212 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_BUFFER
);

1213 
	`log_”rÜ
("XMS bufã¸%u‡Ì—dy f»e", 
bufãr_šdex
);

1218 
poŞ
->
ä“_m­
 |ğ(1UL << 
bufãr_šdex
);

1219 
poŞ
->
xms_ä“s
++;

1221 
	`log_debug
("F»ed XMS bufã¸%u‡ˆoff£ˆ%u", 
bufãr_šdex
, 
bufãr_off£t
);

1222 
	}
}

1232 
	$xms_cİy_to_bufãr
(
xms_bufãr_poŞ_t
 *
poŞ
, 
ušt32_t
 
off£t
, *
¤c
, ušt32_ˆ
size
) {

1233 
»suÉ
;

1235 ià(!
poŞ
 || !
¤c
 || 
size
 =ğ0 ||…oŞ->
xms_hªdË
 == 0) {

1236 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1237  
ERROR_INVALID_PARAM
;

1241 ià(
off£t
 + 
size
 > 
poŞ
->
tÙ®_size
) {

1242 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_SIZE_MISMATCH
);

1243  
ERROR_INVALID_PARAM
;

1248 
ušt32_t
 
¤c_addr
 = ((ušt32_t)
	`FP_SEG
(
¤c
è<< 16è| 
	`FP_OFF
(src);

1251 
»suÉ
 = 
	`xms_move_memÜy
(
poŞ
->
xms_hªdË
, 
off£t
, 0, 
¤c_addr
, 
size
);

1252 ià(
»suÉ
 !ğ
XMS_SUCCESS
) {

1253 
	`log_”rÜ
("FaedØcİy %u by‹ tØXMS‡ˆoff£ˆ%u: %d", 
size
, 
off£t
, 
»suÉ
);

1254 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

1255  
»suÉ
;

1258 
poŞ
->
xms_cİ›s_to
++;

1259 
	`log_debug
("Cİ›d %u by‹ tØXMS‡ˆoff£ˆ%u", 
size
, 
off£t
);

1260  
SUCCESS
;

1261 
	}
}

1271 
	$xms_cİy_äom_bufãr
(
xms_bufãr_poŞ_t
 *
poŞ
, *
de¡
, 
ušt32_t
 
off£t
, ušt32_ˆ
size
) {

1272 
»suÉ
;

1274 ià(!
poŞ
 || !
de¡
 || 
size
 =ğ0 ||…oŞ->
xms_hªdË
 == 0) {

1275 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1276  
ERROR_INVALID_PARAM
;

1280 ià(
off£t
 + 
size
 > 
poŞ
->
tÙ®_size
) {

1281 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_SIZE_MISMATCH
);

1282  
ERROR_INVALID_PARAM
;

1287 
ušt32_t
 
de¡_addr
 = ((ušt32_t)
	`FP_SEG
(
de¡
è<< 16è| 
	`FP_OFF
(dest);

1290 
»suÉ
 = 
	`xms_move_memÜy
(0, 
de¡_addr
, 
poŞ
->
xms_hªdË
, 
off£t
, 
size
);

1291 ià(
»suÉ
 !ğ
XMS_SUCCESS
) {

1292 
	`log_”rÜ
("FaedØcİy %u by‹ äom XMS‡ˆoff£ˆ%u: %d", 
size
, 
off£t
, 
»suÉ
);

1293 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

1294  
»suÉ
;

1297 
poŞ
->
xms_cİ›s_äom
++;

1298 
	`log_debug
("Cİ›d %u by‹ äom XMS‡ˆoff£ˆ%u", 
size
, 
off£t
);

1299  
SUCCESS
;

1300 
	}
}

1312 
	$¡agšg_bufãr_š™
(
ušt32_t
 
couÁ
, ušt32_ˆ
size
) {

1313 
ušt32_t
 
i
;

1314 
ušt8_t
 *
bufãr_d©a
;

1316 ià(
couÁ
 =ğ0 || 
size
 == 0) {

1317 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1318  
ERROR_INVALID_PARAM
;

1322 ià(
g_¡agšg_bufãrs
) {

1323 
	`¡agšg_bufãr_ş—nup
();

1327 
g_¡agšg_bufãrs
 = (
¡agšg_bufãr_t
*)
	`memÜy_®loÿ‹
(

1328 
couÁ
 * (
¡agšg_bufãr_t
), 
MEMORY_FLAG_ZERO
);

1329 ià(!
g_¡agšg_bufãrs
) {

1330 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

1331  
ERROR_NO_MEMORY
;

1335 
bufãr_d©a
 = (
ušt8_t
*)
	`memÜy_®loÿ‹
(
couÁ
 * 
size
, 
MEMORY_FLAG_ZERO
);

1336 ià(!
bufãr_d©a
) {

1337 
	`memÜy_ä“
(
g_¡agšg_bufãrs
);

1338 
g_¡agšg_bufãrs
 = 
NULL
;

1339 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_OUT_OF_MEMORY
);

1340  
ERROR_NO_MEMORY
;

1344 
i
 = 0; i < 
couÁ
; i++) {

1345 
g_¡agšg_bufãrs
[
i
].
magic
 = 
STAGING_BUFFER_MAGIC
;

1346 
g_¡agšg_bufãrs
[
i
].
d©a
 = 
bufãr_d©a
 + (˜* 
size
);

1347 
g_¡agšg_bufãrs
[
i
].
size
 = size;

1348 
g_¡agšg_bufãrs
[
i
].
u£d
 = 0;

1349 
g_¡agšg_bufãrs
[
i
].
š_u£
 = 0;

1350 
g_¡agšg_bufãrs
[
i
].
nic_šdex
 = 0;

1351 
g_¡agšg_bufãrs
[
i
].
·ck‘_size
 = 0;

1353 
g_¡agšg_bufãrs
[
i
].
Ãxt
 = (˜< 
couÁ
 - 1è? &g_¡agšg_bufãrs[˜+ 1] : 
NULL
;

1355 
g_¡agšg_ä“li¡
 = &
g_¡agšg_bufãrs
[0];

1357 
g_¡agšg_couÁ
 = 
couÁ
;

1358 
g_¡agšg_size
 = 
size
;

1360 
	`log_šfo
("In™Ÿlized %u sgšg bufãr oà%u by‹ —ch", 
couÁ
, 
size
);

1361  
SUCCESS
;

1362 
	}
}

1367 
	$¡agšg_bufãr_ş—nup
() {

1368 ià(
g_¡agšg_bufãrs
) {

1370 ià(
g_¡agšg_bufãrs
[0].
d©a
) {

1371 
	`memÜy_ä“
(
g_¡agšg_bufãrs
[0].
d©a
);

1375 
	`memÜy_ä“
(
g_¡agšg_bufãrs
);

1376 
g_¡agšg_bufãrs
 = 
NULL
;

1379 
g_¡agšg_couÁ
 = 0;

1380 
g_¡agšg_size
 = 0;

1381 
	}
}

1390 
¡agšg_bufãr_t
* 
	$¡agšg_bufãr_®loc
() {

1391 
¡agšg_bufãr_t
 *
bufãr
;

1393 ià(!
g_¡agšg_ä“li¡
) {

1394  
NULL
;

1398 
bufãr
 = 
g_¡agšg_ä“li¡
;

1399 
g_¡agšg_ä“li¡
 = 
bufãr
->
Ãxt
;

1402 
bufãr
->
š_u£
 = 1;

1403 
bufãr
->
u£d
 = 0;

1404 
bufãr
->
·ck‘_size
 = 0;

1405 
bufãr
->
nic_šdex
 = 0;

1406 
bufãr
->
Ãxt
 = 
NULL
;

1408  
bufãr
;

1409 
	}
}

1417 
	$¡agšg_bufãr_ä“
(
¡agšg_bufãr_t
 *
bufãr
) {

1418 
ušt16_t
 
æags
;

1420 ià(!
bufãr
) {

1425 ià(
bufãr
->
magic
 !ğ
STAGING_BUFFER_MAGIC
) {

1426 
	`log_”rÜ
("Buffer corruption detected! Magic=0x%04Xƒxpected=0x%04X",

1427 
bufãr
->
magic
, 
STAGING_BUFFER_MAGIC
);

1432 ià(
bufãr
 < 
g_¡agšg_bufãrs
 ||

1433 
bufãr
 >ğ
g_¡agšg_bufãrs
 + 
g_¡agšg_couÁ
) {

1434 
	`log_”rÜ
("Bufã¸%°outsidv®id„ªge", 
bufãr
);

1439 ià(!
bufãr
->
š_u£
) {

1440 
	`log_”rÜ
("DoubË-ä“ d‘eùed oÀ¡agšg bufã¸%p", 
bufãr
);

1445 
bufãr
->
š_u£
 = 0;

1446 
bufãr
->
u£d
 = 0;

1447 
bufãr
->
·ck‘_size
 = 0;

1448 
bufãr
->
nic_šdex
 = 0;

1451 
æags
 = 
	`œq_§ve_di§bË
();

1452 
bufãr
->
Ãxt
 = 
g_¡agšg_ä“li¡
;

1453 
g_¡agšg_ä“li¡
 = 
bufãr
;

1454 
	`œq_»¡Üe
(
æags
);

1455 
	}
}

1468 
	$¥sc_queue_š™
(
¥sc_queue_t
 *
queue
) {

1469 ià(!
queue
) {

1470  
ERROR_INVALID_PARAM
;

1474 
	`memÜy_z”o
(
queue
, (
¥sc_queue_t
));

1477 
queue
->
h—d
 = 0;

1478 
queue
->

 = 0;

1480 
	`log_debug
("SPSC queue initialized: size=%u, mask=0x%02X",

1481 
SPSC_QUEUE_SIZE
, 
SPSC_QUEUE_MASK
);

1483  
SUCCESS
;

1484 
	}
}

1490 
	$¥sc_queue_ş—nup
(
¥sc_queue_t
 *
queue
) {

1491 
¡agšg_bufãr_t
 *
bufãr
;

1493 ià(!
queue
) {

1498 (
bufãr
 = 
	`¥sc_queue_dequeue
(
queue
)è!ğ
NULL
) {

1499 
	`¡agšg_bufãr_ä“
(
bufãr
);

1503 
queue
->
h—d
 = 0;

1504 
queue
->

 = 0;

1505 
	}
}

1515 
	$¥sc_queue_’queue
(
¥sc_queue_t
 *
queue
, 
¡agšg_bufãr_t
 *
bufãr
) {

1516 
ušt8_t
 
Ãxt_
;

1518 ià(!
queue
 || !
bufãr
) {

1519  
ERROR_INVALID_PARAM
;

1523 
Ãxt_
 = (
queue
->

 + 1è& 
SPSC_QUEUE_MASK
;

1526 ià(
Ãxt_
 =ğ
queue
->
h—d
) {

1527 
queue
->
’queue_fuÎ
++;

1528  
ERROR_QUEUE_FULL
;

1532 
queue
->
bufãrs
[queue->

] = 
bufãr
;

1535 
	`comp”_b¬r›r
();

1538 
queue
->

 = 
Ãxt_
;

1540 
queue
->
’queue_sucûss
++;

1541  
SUCCESS
;

1542 
	}
}

1551 
¡agšg_bufãr_t
* 
	$¥sc_queue_dequeue
(
¥sc_queue_t
 *
queue
) {

1552 
¡agšg_bufãr_t
 *
bufãr
;

1553 
ušt8_t
 
cu¼’t_h—d
;

1555 ià(!
queue
) {

1556  
NULL
;

1559 
cu¼’t_h—d
 = 
queue
->
h—d
;

1562 ià(
cu¼’t_h—d
 =ğ
queue
->

) {

1563 
queue
->
dequeue_em±y
++;

1564  
NULL
;

1568 
bufãr
 = 
queue
->
bufãrs
[
cu¼’t_h—d
];

1571 
	`comp”_b¬r›r
();

1574 
queue
->
h—d
 = (
cu¼’t_h—d
 + 1è& 
SPSC_QUEUE_MASK
;

1576 
queue
->
dequeue_sucûss
++;

1577  
bufãr
;

1578 
	}
}

1584 
	$bufãr_poŞ_ex·nd
(
bufãr_poŞ_t
 *
poŞ
, 
ušt32_t
 
add™iÚ®_bufãrs
) {

1586  
ERROR_NOT_SUPPORTED
;

1587 
	}
}

1589 
	$bufãr_poŞ_shršk
(
bufãr_poŞ_t
 *
poŞ
, 
ušt32_t
 
»move_bufãrs
) {

1591  
ERROR_NOT_SUPPORTED
;

1592 
	}
}

1594 
	$bufãr_´•’d_d©a
(
bufãr_desc_t
 *
bufãr
, cÚ¡ *
d©a
, 
ušt32_t
 
size
) {

1596  
ERROR_NOT_SUPPORTED
;

1597 
	}
}

1599 
	$bufãr_cİy_d©a
(
bufãr_desc_t
 *
de¡
, cÚ¡ bufãr_desc_ˆ*
¤c
) {

1601  
ERROR_NOT_SUPPORTED
;

1602 
	}
}

1604 
	$bufãr_move_d©a
(
bufãr_desc_t
 *
de¡
, bufãr_desc_ˆ*
¤c
) {

1606  
ERROR_NOT_SUPPORTED
;

1607 
	}
}

1609 
	$bufãr_ş—r_d©a
(
bufãr_desc_t
 *
bufãr
) {

1610 ià(
bufãr
 && 
	`bufãr_is_v®id
(buffer)) {

1611 
	`memÜy_£t_İtimized
(
bufãr
->
d©a
, 0, bufãr->
size
);

1612 
bufãr
->
u£d
 = 0;

1614 
	}
}

1622 
bufãr_desc_t
* 
	$bufãr_®loc_‘h”Ãt_äame
(
ušt32_t
 
äame_size
, 
bufãr_ty³_t
 
ty³
) {

1623 
bufãr_poŞ_t
 *
poŞ
 = 
NULL
;

1624 
bufãr_desc_t
 *
bufãr
 = 
NULL
;

1625 
boŞ
 
u£d_ç¡_·th
 = 
çl£
;

1628 ià(
äame_size
 <ğ64 && 
g_bufãr_poŞ_64
.
š™Ÿlized
) {

1629 
poŞ
 = &
g_bufãr_poŞ_64
;

1630 
u£d_ç¡_·th
 = 
Œue
;

1631 } ià(
äame_size
 <ğ128 && 
g_bufãr_poŞ_128
.
š™Ÿlized
) {

1632 
poŞ
 = &
g_bufãr_poŞ_128
;

1633 
u£d_ç¡_·th
 = 
Œue
;

1634 } ià(
äame_size
 <ğ512 && 
g_bufãr_poŞ_512
.
š™Ÿlized
) {

1635 
poŞ
 = &
g_bufãr_poŞ_512
;

1636 
u£d_ç¡_·th
 = 
Œue
;

1637 } ià(
äame_size
 <ğ1518 && 
g_bufãr_poŞ_1518
.
š™Ÿlized
) {

1638 
poŞ
 = &
g_bufãr_poŞ_1518
;

1639 
u£d_ç¡_·th
 = 
Œue
;

1643 ià(
u£d_ç¡_·th
 && 
poŞ
) {

1644 
bufãr
 = 
	`bufãr_®loc
(
poŞ
);

1645 ià(
bufãr
) {

1646 
g_ç¡_·th_®loÿtiÚs
++;

1647 
g_ç¡_·th_ÿche_h™s
++;

1648 
	`log_debug
("Fa¡…©h‡ÎoÿtiÚ: %u by‹ äom size-¥ecifiøpoŞ", 
äame_size
);

1649  
bufãr
;

1652 
	`log_debug
("Fa¡…©h…oŞƒm±y fÜ siz%u, usšg f®lback", 
äame_size
);

1656 
g_çÎback_®loÿtiÚs
++;

1658 ià(
äame_size
 <= 1518) {

1660 ià(
ty³
 =ğ
BUFFER_TYPE_RX
) {

1661 
poŞ
 = &
g_rx_bufãr_poŞ
;

1662 } ià(
ty³
 =ğ
BUFFER_TYPE_DMA_TX
 ||y³ =ğ
BUFFER_TYPE_DMA_RX
) {

1663 
poŞ
 = &
g_dma_bufãr_poŞ
;

1665 
poŞ
 = &
g_tx_bufãr_poŞ
;

1668 
bufãr
 = 
	`bufãr_®loc
(
poŞ
);

1669 ià(
bufãr
) {

1670 
	`log_debug
("F®lback‡ÎoÿtiÚ: %u by‹ äom„eguÏ¸poŞ", 
äame_size
);

1671  
bufãr
;

1675 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_SIZE_MISMATCH
);

1676 
	`log_”rÜ
("JumbØäamsiz%u‚Ù suµÜ‹d (max 1518)", 
äame_size
);

1677  
NULL
;

1681 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_POOL_FULL
);

1682 
	`log_w¬nšg
("AÎ bufã¸poŞ exhau¡ed fÜ f¿msiz%u", 
äame_size
);

1683  
NULL
;

1684 
	}
}

1692 
bufãr_desc_t
* 
	$bufãr_®loc_dma
(
ušt32_t
 
size
, ušt32_ˆ
®ignm’t
) {

1693 
ıu_šfo_t
 
g_ıu_šfo
;

1696 ià(
®ignm’t
 == 0 || (alignment & (alignment - 1)) != 0) {

1697 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_ALIGNMENT
);

1698  
NULL
;

1702 ià(
size
 <ğ
DMA_BUFFER_SIZE
) {

1703 
bufãr_desc_t
 *
bufãr
 = 
	`bufãr_®loc
(&
g_dma_bufãr_poŞ
);

1704 ià(
bufãr
) {

1706 ià(!
	`IS_ALIGNED
((
ušt32_t
)
bufãr
->
d©a
, 
®ignm’t
)) {

1707 
	`log_w¬nšg
("DMA buffer‚ot…roperly‡ligned: %p (need %u-byte‡lignment)",

1708 
bufãr
->
d©a
, 
®ignm’t
);

1712 
bufãr
->
æags
 |ğ
BUFFER_FLAG_DMA_CAPABLE
;

1713  
bufãr
;

1718 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_POOL_FULL
);

1719  
NULL
;

1720 
	}
}

1727 
ušt32_t
 
	$bufãr_g‘_İtim®_size
(
ušt32_t
 
»que¡ed_size
) {

1728 
ıu_šfo_t
 
g_ıu_šfo
;

1729 
ušt32_t
 
®ignm’t
;

1732 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

1733 
®ignm’t
 = 4;

1735 
®ignm’t
 = 2;

1739  
	`ALIGN_UP
(
»que¡ed_size
, 
®ignm’t
);

1740 
	}
}

1746 
	$bufãr_sy¡em_š™_İtimized
() {

1747 
»suÉ
;

1748 
ıu_šfo_t
 
g_ıu_šfo
;

1751 
»suÉ
 = 
	`bufãr_sy¡em_š™
();

1752 ià(
»suÉ
 !ğ
SUCCESS
) {

1753  
»suÉ
;

1757 
	`log_šfo
("Optimizing buffer system for %s CPU",

1758 
	`ıu_ty³_to_¡ršg
(
g_ıu_šfo
.
ty³
));

1760 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

1761 
	`log_šfo
("Enabling 32-bit buffer optimizations");

1764 ià(
g_ıu_šfo
.
ã©u»s
 & 
CPU_FEATURE_TSC
) {

1765 
	`log_šfo
("TSC‡vailable for bufferiming measurements");

1768 
	`log_šfo
("Using 16-bit buffer operations for compatibility");

1772 ià(
	`memÜy_xms_avaabË
()) {

1773 
ušt32_t
 
xms_size
 = 
	`memÜy_g‘_xms_size
();

1774 
	`log_šfo
("XMS memÜy‡vaabË: %u KB fÜ†¬g·ck‘ bufãrs", 
xms_size
);

1777  
SUCCESS
;

1778 
	}
}

1786 
	$bufãr_cİy_·ck‘_d©a
(
bufãr_desc_t
 *
de¡
, cÚ¡ bufãr_desc_ˆ*
¤c
) {

1787 ià(!
de¡
 || !
¤c
 || !
	`bufãr_is_v®id
(dest) || !buffer_is_valid(src)) {

1788 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1789  
ERROR_INVALID_PARAM
;

1792 ià(
¤c
->
u£d
 > 
de¡
->
size
) {

1793 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_SIZE_MISMATCH
);

1794  
ERROR_INVALID_PARAM
;

1798 
	`memÜy_cİy_İtimized
(
de¡
->
d©a
, 
¤c
->d©a, src->
u£d
);

1799 
de¡
->
u£d
 = 
¤c
->used;

1801  
SUCCESS
;

1802 
	}
}

1808 
	$bufãr_´eãtch_d©a
(cÚ¡ 
bufãr_desc_t
 *
bufãr
) {

1809 
ıu_šfo_t
 
g_ıu_šfo
;

1811 ià(!
bufãr
 || !
	`bufãr_is_v®id
(buffer)) {

1816 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

1818 vŞ©
ušt8_t
 *
d©a
 = (vŞ©ušt8_t*)
bufãr
->data;

1819 
ušt32_t
 
size
 = 
bufãr
->
u£d
;

1820 
ušt32_t
 
ÿche_lše
 = 32;

1823 
ušt32_t
 
off£t
 = 0; off£ˆ< 
size
; off£ˆ+ğ
ÿche_lše
) {

1824 ()
d©a
[
off£t
];

1827 
	}
}

1838 
bufãr_desc_t
* 
	$bufãr_®loc_nic_aw¬e
(
nic_id_t
 
nic_id
, 
bufãr_ty³_t
 
ty³
, 
ušt32_t
 
size
) {

1839 
bufãr_desc_t
* 
bufãr
 = 
NULL
;

1842 ià(
nic_id
 !ğ
INVALID_NIC_ID
 && 
	`nic_bufãr_is_š™Ÿlized
(nic_id)) {

1843 
bufãr
 = 
	`nic_bufãr_®loc
(
nic_id
, 
ty³
, 
size
);

1844 ià(
bufãr
) {

1845 
	`log_debug
("AÎoÿ‹d bufã¸äom…”-NIC…oŞ fÜ NIC %d", 
nic_id
);

1846  
bufãr
;

1848 
	`log_debug
("P”-NIC‡ÎoÿtiÚ faed fÜ NIC %d,ryšg†egacy‡ÎoÿtiÚ", 
nic_id
);

1852 
ty³
) {

1853 
BUFFER_TYPE_TX
:

1854 
BUFFER_TYPE_DMA_TX
:

1855 
bufãr
 = 
	`bufãr_®loc
(&
g_tx_bufãr_poŞ
);

1857 
BUFFER_TYPE_RX
:

1858 
BUFFER_TYPE_DMA_RX
:

1859 
bufãr
 = 
	`bufãr_®loc
(&
g_rx_bufãr_poŞ
);

1861 
BUFFER_TYPE_DESCRIPTOR
:

1862 
BUFFER_TYPE_TEMPORARY
:

1863 
bufãr
 = 
	`bufãr_®loc
(&
g_dma_bufãr_poŞ
);

1866 
	`bufãr_£t_Ï¡_”rÜ
(
BUFFER_ERROR_INVALID_PARAM
);

1867  
NULL
;

1870 ià(
bufãr
) {

1871 
	`log_debug
("AÎoÿ‹d bufã¸äom†egacy glob®…oŞ (ty³ %d)", 
ty³
);

1873 
	`log_w¬nšg
("Both…er-NIC‡nd†egacy buffer‡llocation failed");

1876  
bufãr
;

1877 
	}
}

1884 
	$bufãr_ä“_nic_aw¬e
(
nic_id_t
 
nic_id
, 
bufãr_desc_t
* 
bufãr
) {

1885 ià(!
bufãr
) {

1890 ià(
nic_id
 !ğ
INVALID_NIC_ID
 && 
	`nic_bufãr_is_š™Ÿlized
(nic_id)) {

1891 
	`nic_bufãr_ä“
(
nic_id
, 
bufãr
);

1892 
	`log_debug
("F»ed bufã¸tØ³r-NIC…oŞ fÜ NIC %d", 
nic_id
);

1897 ià(
nic_id
 =ğ
INVALID_NIC_ID
) {

1899 
nic_id_t
 
‹¡_id
 = 0;e¡_id < 
MAX_NICS
;est_id++) {

1900 ià(
	`nic_bufãr_is_š™Ÿlized
(
‹¡_id
)) {

1902 
	`nic_bufãr_ä“
(
‹¡_id
, 
bufãr
);

1903 
	`log_debug
("Auto-d‘eùed‡nd f»ed bufã¸tØNIC %d…oŞ", 
‹¡_id
);

1910 
	`bufãr_ä“_ªy
(
bufãr
);

1911 
	`log_debug
("Freed buffer using†egacy method");

1912 
	}
}

1921 
	$bufãr_»gi¡”_nic
(
nic_id_t
 
nic_id
, 
nic_ty³_t
 
nic_ty³
, cÚ¡ * 
nic_Çme
) {

1922 ià(!
g_bufãr_sy¡em_š™Ÿlized
) {

1923 
	`log_”rÜ
("Buffer system‚ot initialized");

1924  
ERROR_INVALID_PARAM
;

1927 
	`log_šfo
("Regi¡”šg NIC %d (%sèw™h bufã¸sy¡em", 
nic_id
, 
nic_Çme
 ?‚ic_name : "Unknown");

1930 
»suÉ
 = 
	`nic_bufãr_poŞ_ü—‹
(
nic_id
, 
nic_ty³
, 
nic_Çme
);

1931 ià(
»suÉ
 !ğ
SUCCESS
) {

1932 
	`log_”rÜ
("FaedØü—‹ bufã¸poŞ fÜ NIC %d: %d", 
nic_id
, 
»suÉ
);

1933  
»suÉ
;

1937 
ušt32_t
 
sm®l_couÁ
 = 
DEFAULT_SMALL_BUFFERS_PER_NIC
;

1938 
ušt32_t
 
Ïrge_couÁ
 = 
DEFAULT_LARGE_BUFFERS_PER_NIC
;

1939 
ušt32_t
 
th»shŞd
 = 
RX_COPYBREAK_THRESHOLD
;

1942 ià(
nic_ty³
 =ğ
NIC_TYPE_3C515_TX
) {

1944 
sm®l_couÁ
 = 32;

1945 
Ïrge_couÁ
 = 16;

1946 
th»shŞd
 = 256;

1949 
»suÉ
 = 
	`nic_rx_cİyb»ak_š™
(
nic_id
, 
sm®l_couÁ
, 
Ïrge_couÁ
, 
th»shŞd
);

1950 ià(
»suÉ
 !ğ
SUCCESS
) {

1951 
	`log_w¬nšg
("FaedØš™ŸlizRX_COPYBREAK fÜ NIC %d: %d", 
nic_id
, 
»suÉ
);

1955 
	`log_šfo
("SucûssfuÎy„egi¡”ed NIC %d w™h bufã¸sy¡em", 
nic_id
);

1956  
SUCCESS
;

1957 
	}
}

1964 
	$bufãr_uÄegi¡”_nic
(
nic_id_t
 
nic_id
) {

1965 ià(!
g_bufãr_sy¡em_š™Ÿlized
) {

1966  
ERROR_INVALID_PARAM
;

1969 
	`log_šfo
("UÄegi¡”šg NIC %d from bufã¸sy¡em", 
nic_id
);

1972 
»suÉ
 = 
	`nic_bufãr_poŞ_de¡roy
(
nic_id
);

1973 ià(
»suÉ
 !ğ
SUCCESS
) {

1974 
	`log_w¬nšg
("FaedØde¡roy bufã¸poŞ fÜ NIC %d: %d", 
nic_id
, 
»suÉ
);

1977  
»suÉ
;

1978 
	}
}

1986 
	$bufãr_g‘_nic_¡©s
(
nic_id_t
 
nic_id
, 
bufãr_poŞ_¡©s_t
* 
¡©s
) {

1987 ià(!
¡©s
) {

1988  
ERROR_INVALID_PARAM
;

1991  
	`nic_bufãr_g‘_¡©s
(
nic_id
, 
¡©s
);

1992 
	}
}

1998 
	$bufãr_»b®ªû_»sourûs
() {

1999 ià(!
g_bufãr_sy¡em_š™Ÿlized
) {

2000  
ERROR_INVALID_PARAM
;

2003 
	`log_šfo
("Triggering buffer„esource„ebalancing");

2004  
	`b®ªû_bufãr_»sourûs
();

2005 
	}
}

2014 
bufãr_desc_t
* 
	$bufãr_®loc_‘h”Ãt_äame_nic
(
nic_id_t
 
nic_id
, 
ušt32_t
 
äame_size
, 
bufãr_ty³_t
 
ty³
) {

2016 ià(
nic_id
 !ğ
INVALID_NIC_ID
 && 
	`nic_bufãr_is_š™Ÿlized
(nic_id)) {

2017  
	`nic_bufãr_®loc_‘h”Ãt_äame
(
nic_id
, 
äame_size
, 
ty³
);

2021  
	`bufãr_®loc_‘h”Ãt_äame
(
äame_size
, 
ty³
);

2022 
	}
}

2030 
bufãr_desc_t
* 
	$bufãr_rx_cİyb»ak_®loc_nic
(
nic_id_t
 
nic_id
, 
ušt32_t
 
·ck‘_size
) {

2032 ià(
nic_id
 !ğ
INVALID_NIC_ID
 && 
	`nic_bufãr_is_š™Ÿlized
(nic_id)) {

2033 
bufãr_desc_t
* 
bufãr
 = 
	`nic_rx_cİyb»ak_®loc
(
nic_id
, 
·ck‘_size
);

2034 ià(
bufãr
) {

2035  
bufãr
;

2037 
	`log_debug
("P”-NIC RX_COPYBREAK‡ÎoÿtiÚ faed fÜ NIC %d, usšg†egacy", 
nic_id
);

2041  
	`rx_cİyb»ak_®loc
(
·ck‘_size
);

2042 
	}
}

2049 
	$bufãr_rx_cİyb»ak_ä“_nic
(
nic_id_t
 
nic_id
, 
bufãr_desc_t
* 
bufãr
) {

2050 ià(!
bufãr
) {

2055 ià(
nic_id
 !ğ
INVALID_NIC_ID
 && 
	`nic_bufãr_is_š™Ÿlized
(nic_id)) {

2056 
	`nic_rx_cİyb»ak_ä“
(
nic_id
, 
bufãr
);

2061 
	`rx_cİyb»ak_ä“
(
bufãr
);

2062 
	}
}

2067 
	$bufãr_´št_com´eh’sive_¡©s
() {

2069 
	`log_šfo
("=== Legacy Global Buffer Pool Statistics ===");

2071 
	`log_šfo
("TX Pool: %uotal, %u free, %u used,…eak %u",

2072 
	`bufãr_poŞ_g‘_tÙ®_couÁ
(&
g_tx_bufãr_poŞ
),

2073 
	`bufãr_poŞ_g‘_ä“_couÁ
(&
g_tx_bufãr_poŞ
),

2074 
	`bufãr_poŞ_g‘_u£d_couÁ
(&
g_tx_bufãr_poŞ
),

2075 
g_tx_bufãr_poŞ
.
³ak_u§ge
);

2077 
	`log_šfo
("RX Pool: %uotal, %u free, %u used,…eak %u",

2078 
	`bufãr_poŞ_g‘_tÙ®_couÁ
(&
g_rx_bufãr_poŞ
),

2079 
	`bufãr_poŞ_g‘_ä“_couÁ
(&
g_rx_bufãr_poŞ
),

2080 
	`bufãr_poŞ_g‘_u£d_couÁ
(&
g_rx_bufãr_poŞ
),

2081 
g_rx_bufãr_poŞ
.
³ak_u§ge
);

2083 
	`log_šfo
("DMA Pool: %uotal, %u free, %u used,…eak %u",

2084 
	`bufãr_poŞ_g‘_tÙ®_couÁ
(&
g_dma_bufãr_poŞ
),

2085 
	`bufãr_poŞ_g‘_ä“_couÁ
(&
g_dma_bufãr_poŞ
),

2086 
	`bufãr_poŞ_g‘_u£d_couÁ
(&
g_dma_bufãr_poŞ
),

2087 
g_dma_bufãr_poŞ
.
³ak_u§ge
);

2090 cÚ¡ 
bufãr_¡©s_t
* 
¡©s
 = 
	`bufãr_g‘_¡©s
();

2091 
	`log_šfo
("Global Stats: %luotal‡llocs, %lu failures, %lu current, %lu…eak",

2092 
¡©s
->
tÙ®_®loÿtiÚs
, sts->
®loÿtiÚ_çu»s
,

2093 
¡©s
->
cu¼’t_®loÿ‹d
, sts->
³ak_®loÿ‹d
);

2096 
	`nic_bufãr_´št_®l_¡©s
();

2099 
	`log_šfo
("Fast Path Stats: %lu fast‡llocs, %lu cache hits, %lu fallbacks",

2100 
g_ç¡_·th_®loÿtiÚs
, 
g_ç¡_·th_ÿche_h™s
, 
g_çÎback_®loÿtiÚs
);

2101 
	}
}

2106 
	$bufãr_mÚ™Ü_ªd_»b®ªû
() {

2107 ià(!
g_bufãr_sy¡em_š™Ÿlized
) {

2112 
	`mÚ™Ü_nic_bufãr_u§ge
();

2115 
ušt32_t
 
Ï¡_Ëgacy_mÚ™Ü
 = 0;

2116 
ušt32_t
 
cu¼’t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

2118 ià(
cu¼’t_time
 - 
Ï¡_Ëgacy_mÚ™Ü
 > 10000) {

2119 
ušt32_t
 
tx_u§ge
 = (
g_tx_bufãr_poŞ
.
u£d_couÁ
 * 100è/ g_tx_bufãr_poŞ.
bufãr_couÁ
;

2120 
ušt32_t
 
rx_u§ge
 = (
g_rx_bufãr_poŞ
.
u£d_couÁ
 * 100è/ g_rx_bufãr_poŞ.
bufãr_couÁ
;

2121 
ušt32_t
 
dma_u§ge
 = (
g_dma_bufãr_poŞ
.
u£d_couÁ
 * 100è/ g_dma_bufãr_poŞ.
bufãr_couÁ
;

2123 ià(
tx_u§ge
 > 85 || 
rx_u§ge
 > 85 || 
dma_u§ge
 > 85) {

2124 
	`log_w¬nšg
("High†egacy…ool usage: TX %u%%, RX %u%%, DMA %u%%",

2125 
tx_u§ge
, 
rx_u§ge
, 
dma_u§ge
);

2128 
Ï¡_Ëgacy_mÚ™Ü
 = 
cu¼’t_time
;

2130 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/config.c

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~<¡dlib.h
>

14 
	~<ùy³.h
>

15 
	~"../šşude/cÚfig.h
"

16 
	~"../šşude/¡©ic_routšg.h
"

17 
	~"../šşude/loggšg.h
"

18 
	~"../šşude/ıu_d‘eù.h
"

19 
	~"../šşude/busma¡”_‹¡.h
"

20 
	~"../šşude/´oduùiÚ.h
"

21 
	~"../šşude/bufãr_cÚfig.h
"

24 #´agm¨
code_£g
("COLD_TEXT", "CODE")

27 cÚ¡ 
cÚfig_t
 
	gdeçuÉ_cÚfig
 = {

42 
CONFIG_DEFAULT_IO1_BASE
,

43 
CONFIG_DEFAULT_IO2_BASE
,

44 
CONFIG_DEFAULT_IRQ1
,

45 
CONFIG_DEFAULT_IRQ2
,

46 
CONFIG_DEFAULT_SPEED
,

47 
CONFIG_DEFAULT_BUSMASTER
,

48 
CONFIG_DEFAULT_LOG_ENABLED
,

63 cÚ¡ *
	mÇme
;

64 (*
	mhªdËr
)(
cÚfig_t
 *
	mcÚfig
, cÚ¡ *
	mv®ue
);

65 cÚ¡ *
	mdesütiÚ
;

66 } 
	tcÚfig_·¿m_t
;

69 
hªdË_debug_Ëv–
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

70 
hªdË_u£_xms
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

71 
hªdË_’abË_routšg
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

72 
hªdË_’abË_¡©ic_routšg
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

73 
hªdË_bufãr_couÁ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

74 
hªdË_bufãr_size
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

75 
hªdË_š‹¼u±_veùÜ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

76 
hªdË_io_ba£
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

77 
hªdË_œq
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

78 
hªdË_’abË_¡©s
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

79 
hªdË_´omiscuous_mode
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

80 
hªdË_’abË_loggšg
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

81 
hªdË_‹¡_mode
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

84 
hªdË_io1_ba£
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

85 
hªdË_io2_ba£
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

86 
hªdË_œq1
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

87 
hªdË_œq2
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

88 
hªdË_¥“d
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

89 
hªdË_busma¡”
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

90 
hªdË_log
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

91 
hªdË_rou‹
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

94 
hªdË_bufãr_size_ov”ride
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

95 
hªdË_tx_ršg_couÁ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

96 
hªdË_rx_ršg_couÁ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

97 
hªdË_fÜû_pio
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

98 
hªdË_mšim®_bufãrs
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

99 
hªdË_İtim®_bufãrs
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

100 
hªdË_bufãr_cÚfig
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
);

103 * 
nÜm®ize_·¿m‘”_Çme
(cÚ¡ * 
·¿m
);

104 
·r£_hex_v®ue
(cÚ¡ * 
v®ue
, * 
»suÉ
);

105 
·r£_ÃtwÜk_add»ss
(cÚ¡ * 
addr_¡r
, 
ušt32_t
* 
ÃtwÜk
, ušt32_t* 
Ãtmask
);

106 
·r£__add»ss
(cÚ¡ * 
addr_¡r
, 
ušt32_t
* 
_addr
);

107 
¡ricmp
(cÚ¡ * 
s1
, cÚ¡ * 
s2
);

110 cÚ¡ 
cÚfig_·¿m_t
 
	gcÚfig_·¿ms
[] = {

112 {"DEBUG", 
hªdË_debug_Ëv–
, "Debug†evel (0-3)"},

113 {"XMS", 
hªdË_u£_xms
, "Use XMS memory (0/1)"},

114 {"ROUTING", 
hªdË_’abË_routšg
, "Enable„outing (0/1)"},

115 {"STATIC_ROUTING", 
hªdË_’abË_¡©ic_routšg
, "Enable static„outing (0/1)"},

116 {"BUFFERS", 
hªdË_bufãr_couÁ
, "Number of buffers (1-16)"},

117 {"BUFSIZE", 
hªdË_bufãr_size
, "Buffer size in bytes"},

118 {"INTVEC", 
hªdË_š‹¼u±_veùÜ
, "Interrupt vector (hex)"},

119 {"IOBASE", 
hªdË_io_ba£
, "I/O base‡ddress (hex)"},

120 {"IRQ", 
hªdË_œq
, "IRQ‚umber (2-15)"},

121 {"STATS", 
hªdË_’abË_¡©s
, "Enable statistics (0/1)"},

122 {"PROMISC", 
hªdË_´omiscuous_mode
, "Promiscuous mode (0/1)"},

123 {"LOGGING", 
hªdË_’abË_loggšg
, "Enable†ogging (0/1)"},

124 {"TEST", 
hªdË_‹¡_mode
, "Test mode (0/1)"},

127 {"IO1", 
hªdË_io1_ba£
, "First NIC I/O base‡ddress (0x200-0x3F0)"},

128 {"IO2", 
hªdË_io2_ba£
, "Second NIC I/O base‡ddress (0x200-0x3F0)"},

129 {"IRQ1", 
hªdË_œq1
, "First NIC IRQ (3,5,7,9,10,11,12,15)"},

130 {"IRQ2", 
hªdË_œq2
, "Second NIC IRQ (3,5,7,9,10,11,12,15)"},

131 {"SPEED", 
hªdË_¥“d
, "Network speed (10, 100, AUTO)"},

132 {"BUSMASTER", 
hªdË_busma¡”
, "Bus mastering (ON, OFF, AUTO)"},

133 {"LOG", 
hªdË_log
, "Diagnostic†ogging (ON, OFF)"},

134 {"ROUTE", 
hªdË_rou‹
, "Static„oute (network/mask,nic)"},

137 {"TXRING", 
hªdË_tx_ršg_couÁ
, "TX„ing size (4-32)"},

138 {"RXRING", 
hªdË_rx_ršg_couÁ
, "RX„ing size (8-32)"},

139 {"PIO", 
hªdË_fÜû_pio
, "Force PIO mode (no bus master)"},

140 {"MINIMAL", 
hªdË_mšim®_bufãrs
, "Minimal 3KB buffer config"},

141 {"OPTIMAL", 
hªdË_İtim®_bufãrs
, "Maximum…erformance config"},

142 {"BUFFERS", 
hªdË_bufãr_cÚfig
, "Buffer config (size,tx,rx)"}

145 
	#NUM_CONFIG_PARAMS
 ((
cÚfig_·¿ms
è/ (cÚfig_·¿ms[0]))

	)

153 
	$cÚfig_·r£_·¿ms
(cÚ¡ *
·¿ms
, 
cÚfig_t
 *
cÚfig
) {

154 *
·¿m_cİy
, *
tok’
, *
v®ue
;

155 *
§v•Œ
 = 
NULL
;

156 
i
, 
found
, 
»suÉ
 = 0;

158 ià(!
cÚfig
) {

159 
	`log_”rÜ
("config_parse_params: NULL config…arameter");

160  
CONFIG_ERR_INVALID_PARAM
;

164 *
cÚfig
 = 
deçuÉ_cÚfig
;

166 ià(!
·¿ms
 || 
	`¡¾’
(params) == 0) {

167 
	`log_šfo
("No configuration…arameters, using defaults");

171 
	`log_šfo
("P¬sšg cÚfigu¿tiÚ: %s", 
·¿ms
);

174 
·¿m_cİy
 = 
	`m®loc
(
	`¡¾’
(
·¿ms
) + 1);

175 ià(!
·¿m_cİy
) {

176 
	`log_”rÜ
("Failedo‡llocate memory for…arameter…arsing");

177  
CONFIG_ERR_MEMORY
;

179 
	`¡rıy
(
·¿m_cİy
, 
·¿ms
);

182 
tok’
 = 
	`¡¹ok
(
·¿m_cİy
, " \t");

183 
tok’
 !ğ
NULL
) {

184 * 
·¿m_Çme
;

187 ià(
tok’
[0] == '/') {

188 
·¿m_Çme
 = 
tok’
 + 1;

190 
·¿m_Çme
 = 
tok’
;

194 
v®ue
 = 
	`¡rchr
(
·¿m_Çme
, '=');

195 ià(
v®ue
) {

196 *
v®ue
 = '\0';

197 
v®ue
++;

199 
v®ue
 = "1";

203 * 
nÜm®ized_Çme
 = 
	`nÜm®ize_·¿m‘”_Çme
(
·¿m_Çme
);

204 ià(!
nÜm®ized_Çme
) {

205 
	`log_”rÜ
("Failedo‡llocate memory for…arameter‚ame");

206 
	`ä“
(
·¿m_cİy
);

207  
CONFIG_ERR_MEMORY
;

211 
found
 = 0;

212 
i
 = 0; i < 
NUM_CONFIG_PARAMS
; i++) {

213 ià(
	`¡rcmp
(
nÜm®ized_Çme
, 
cÚfig_·¿ms
[
i
].
Çme
) == 0) {

214 
»suÉ
 = 
cÚfig_·¿ms
[
i
].
	`hªdËr
(
cÚfig
, 
v®ue
);

215 ià(
»suÉ
 < 0) {

216 
	`log_”rÜ
("Error…rocessing…arameter %s=%s: %d",

217 
nÜm®ized_Çme
, 
v®ue
, 
»suÉ
);

218 
	`ä“
(
nÜm®ized_Çme
);

219 
	`ä“
(
·¿m_cİy
);

220  
»suÉ
;

222 
found
 = 1;

227 ià(!
found
) {

228 
	`log_w¬nšg
("UnknowÀcÚfigu¿tiÚ…¬am‘”: %s", 
nÜm®ized_Çme
);

231 
	`ä“
(
nÜm®ized_Çme
);

232 
tok’
 = 
	`¡¹ok
(
NULL
, " \t");

235 
	`ä“
(
·¿m_cİy
);

238 
»suÉ
 = 
	`cÚfig_v®id©e
(
cÚfig
);

239 ià(
»suÉ
 < 0) {

240 
	`log_”rÜ
("CÚfigu¿tiÚ v®id©iÚ faed: %d", 
»suÉ
);

241  
»suÉ
;

245 
»suÉ
 = 
	`cÚfig_v®id©e_üoss_·¿m‘”s
(
cÚfig
);

246 ià(
»suÉ
 < 0) {

247 
	`log_”rÜ
("Cross-·¿m‘” v®id©iÚ faed: %d", 
»suÉ
);

248  
»suÉ
;

251 
	`log_šfo
("Configuration…arsed successfully");

253 
	}
}

260 
	$cÚfig_v®id©e
(cÚ¡ 
cÚfig_t
 *
cÚfig
) {

261 ià(!
cÚfig
) {

262  
CONFIG_ERR_INVALID_PARAM
;

265 
	`log_debug
("Validating configuration");

268 ià(
cÚfig
->
debug_Ëv–
 > 3) {

269 
	`log_”rÜ
("Inv®id debug†ev–: %d (max 3)", 
cÚfig
->
debug_Ëv–
);

270  
CONFIG_ERR_INVALID_VALUE
;

274 ià(
cÚfig
->
bufãr_couÁ
 < 1 || config->buffer_count > 16) {

275 
	`log_”rÜ
("Inv®id bufã¸couÁ: %d (¿ng1-16)", 
cÚfig
->
bufãr_couÁ
);

276  
CONFIG_ERR_INVALID_VALUE
;

279 ià(
cÚfig
->
bufãr_size
 < 64 || config->buffer_size > 65536) {

280 
	`log_”rÜ
("Inv®id bufã¸size: %d (¿ng64-65536)", 
cÚfig
->
bufãr_size
);

281  
CONFIG_ERR_INVALID_VALUE
;

285 ià(
cÚfig
->
œq
 < 2 || config->irq > 15) {

286 
	`log_”rÜ
("Inv®id†egacy IRQ: %d (¿ng2-15)", 
cÚfig
->
œq
);

287  
CONFIG_ERR_INVALID_VALUE
;

291 ià(
cÚfig
->
io_ba£
 < 0x200 || config->io_base > 0x3FF) {

292 
	`log_w¬nšg
("Unusu®†egacy I/O ba£‡dd»ss: 0x%04X", 
cÚfig
->
io_ba£
);

298 ià(!
	`cÚfig_is_v®id_io_add»ss
(
cÚfig
->
io1_ba£
)) {

299 
	`log_”rÜ
("Invalid IO1 base‡ddress: 0x%04X (range 0x%04X-0x%04X)",

300 
cÚfig
->
io1_ba£
, 
CONFIG_MIN_IO_BASE
, 
CONFIG_MAX_IO_BASE
);

301  
CONFIG_ERR_INVALID_IO_RANGE
;

304 ià(!
	`cÚfig_is_v®id_io_add»ss
(
cÚfig
->
io2_ba£
)) {

305 
	`log_”rÜ
("Invalid IO2 base‡ddress: 0x%04X (range 0x%04X-0x%04X)",

306 
cÚfig
->
io2_ba£
, 
CONFIG_MIN_IO_BASE
, 
CONFIG_MAX_IO_BASE
);

307  
CONFIG_ERR_INVALID_IO_RANGE
;

311 ià(!
	`cÚfig_check_io_cÚæiù
(
cÚfig
->
io1_ba£
, cÚfig->
io2_ba£
)) {

312 
	`log_”rÜ
("I/O‡ddress conflict: IO1=0x%04X‡nd IO2=0x%04X overlap",

313 
cÚfig
->
io1_ba£
, cÚfig->
io2_ba£
);

314  
CONFIG_ERR_IO_CONFLICT
;

318 ià(!
	`cÚfig_is_v®id_œq_numb”
(
cÚfig
->
œq1
)) {

319 
	`log_”rÜ
("Inv®id IRQ1: %d (v®id: 3,5,7,9,10,11,12,15)", 
cÚfig
->
œq1
);

320  
CONFIG_ERR_INVALID_IRQ_RANGE
;

323 ià(!
	`cÚfig_is_v®id_œq_numb”
(
cÚfig
->
œq2
)) {

324 
	`log_”rÜ
("Inv®id IRQ2: %d (v®id: 3,5,7,9,10,11,12,15)", 
cÚfig
->
œq2
);

325  
CONFIG_ERR_INVALID_IRQ_RANGE
;

329 ià(!
	`cÚfig_check_œq_cÚæiù
(
cÚfig
->
œq1
, cÚfig->
œq2
)) {

330 
	`log_”rÜ
("IRQ conflict: IRQ1=%d‡nd IRQ2=%d‡rehe same",

331 
cÚfig
->
œq1
, cÚfig->
œq2
);

332  
CONFIG_ERR_IRQ_CONFLICT
;

336 ià(
cÚfig
->
¥“d
 !ğ
SPEED_AUTO
 && cÚfig->¥“d !ğ
SPEED_10
 && cÚfig->¥“d !ğ
SPEED_100
) {

337 
	`log_”rÜ
("Inv®id‚‘wÜk s³ed: %d (v®id: 10, 100, AUTO)", 
cÚfig
->
¥“d
);

338  
CONFIG_ERR_INVALID_SPEED
;

342 ià(
cÚfig
->
rou‹_couÁ
 > 
MAX_ROUTES
) {

343 
	`log_”rÜ
("ToØmªy„ou‹s: %d (max %d)", 
cÚfig
->
rou‹_couÁ
, 
MAX_ROUTES
);

344  
CONFIG_ERR_TOO_MANY_ROUTES
;

347 
	`log_debug
("Configuration validation…assed");

349 
	}
}

356 
	$cÚfig_g‘_deçuÉs
(
cÚfig_t
 *
cÚfig
) {

357 ià(!
cÚfig
) {

358  
CONFIG_ERR_INVALID_PARAM
;

361 *
cÚfig
 = 
deçuÉ_cÚfig
;

362 
	`log_debug
("Loaded default configuration");

365 
	}
}

372 
	$cÚfig_´št
(cÚ¡ 
cÚfig_t
 *
cÚfig
, 
Ëv–
) {

373 ià(!
cÚfig
) {

377 
	`log_©_Ëv–
(
Ëv–
, "Configuration:");

378 
	`log_©_Ëv–
(
Ëv–
, " Debug Lev–: %d", 
cÚfig
->
debug_Ëv–
);

379 
	`log_©_Ëv–
(
Ëv–
, " U£ XMS: %d", 
cÚfig
->
u£_xms
);

380 
	`log_©_Ëv–
(
Ëv–
, " EÇbË Routšg: %d", 
cÚfig
->
’abË_routšg
);

381 
	`log_©_Ëv–
(
Ëv–
, " EÇbË StiøRoutšg: %d", 
cÚfig
->
’abË_¡©ic_routšg
);

382 
	`log_©_Ëv–
(
Ëv–
, " Bufã¸CouÁ: %d", 
cÚfig
->
bufãr_couÁ
);

383 
	`log_©_Ëv–
(
Ëv–
, " Bufã¸Size: %d", 
cÚfig
->
bufãr_size
);

384 
	`log_©_Ëv–
(
Ëv–
, " IÁ”ru± VeùÜ: 0x%02X", 
cÚfig
->
š‹¼u±_veùÜ
);

385 
	`log_©_Ëv–
(
Ëv–
, " I/O Ba£ (Ëgacy): 0x%04X", 
cÚfig
->
io_ba£
);

386 
	`log_©_Ëv–
(
Ëv–
, " IRQ (Ëgacy): %d", 
cÚfig
->
œq
);

387 
	`log_©_Ëv–
(
Ëv–
, " EÇbË Sts: %d", 
cÚfig
->
’abË_¡©s
);

388 
	`log_©_Ëv–
(
Ëv–
, " Promiscuou Mode: %d", 
cÚfig
->
´omiscuous_mode
);

389 
	`log_©_Ëv–
(
Ëv–
, " EÇbË Loggšg: %d", 
cÚfig
->
’abË_loggšg
);

390 
	`log_©_Ëv–
(
Ëv–
, " Te¡ Mode: %d", 
cÚfig
->
‹¡_mode
);

393 
	`log_©_Ëv–
(
Ëv–
, " IO1 Ba£: 0x%04X", 
cÚfig
->
io1_ba£
);

394 
	`log_©_Ëv–
(
Ëv–
, " IO2 Ba£: 0x%04X", 
cÚfig
->
io2_ba£
);

395 
	`log_©_Ëv–
(
Ëv–
, " IRQ1: %d", 
cÚfig
->
œq1
);

396 
	`log_©_Ëv–
(
Ëv–
, " IRQ2: %d", 
cÚfig
->
œq2
);

398 cÚ¡ * 
¥“d_¡r
;

399 
cÚfig
->
¥“d
) {

400 
SPEED_AUTO
: 
¥“d_¡r
 = "AUTO"; ;

401 
SPEED_10
: 
¥“d_¡r
 = "10 Mbps"; ;

402 
SPEED_100
: 
¥“d_¡r
 = "100 Mbps"; ;

403 : 
¥“d_¡r
 = "Unknown"; ;

405 
	`log_©_Ëv–
(
Ëv–
, " N‘wÜk S³ed: %s", 
¥“d_¡r
);

407 cÚ¡ * 
busma¡”_¡r
;

408 
cÚfig
->
busma¡”
) {

409 
BUSMASTER_OFF
: 
busma¡”_¡r
 = "OFF"; ;

410 
BUSMASTER_ON
: 
busma¡”_¡r
 = "ON"; ;

411 
BUSMASTER_AUTO
: 
busma¡”_¡r
 = "AUTO"; ;

412 : 
busma¡”_¡r
 = "Unknown"; ;

414 
	`log_©_Ëv–
(
Ëv–
, " Bu Ma¡”šg: %s", 
busma¡”_¡r
);

415 
	`log_©_Ëv–
(
Ëv–
, " Loggšg: %s", 
cÚfig
->
log_’abËd
 ? "ON" : "OFF");

417 ià(
cÚfig
->
rou‹_couÁ
 > 0) {

418 
i
;

419 
	`log_©_Ëv–
(
Ëv–
, " StiøRou‹ (%d):", 
cÚfig
->
rou‹_couÁ
);

420 
i
 = 0; i < 
cÚfig
->
rou‹_couÁ
; i++) {

421 cÚ¡ 
rou‹_’Œy_t
* 
rou‹
 = &
cÚfig
->
rou‹s
[
i
];

422 ià(
rou‹
->
aùive
) {

423 
	`log_©_Ëv–
(
Ëv–
, " %d.%d.%d.%d/%d -> NIC %d",

424 (
rou‹
->
ÃtwÜk
 >> 24) & 0xFF,

425 (
rou‹
->
ÃtwÜk
 >> 16) & 0xFF,

426 (
rou‹
->
ÃtwÜk
 >> 8) & 0xFF,

427 
rou‹
->
ÃtwÜk
 & 0xFF,

428 
	`__butš_pİcouÁ
(
rou‹
->
Ãtmask
),

429 
rou‹
->
nic_id
);

433 
	}
}

437 
	$hªdË_debug_Ëv–
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

438 
Ëv–
 = 
	`©oi
(
v®ue
);

439 ià(
Ëv–
 < 0 ||†evel > 3) {

440  
CONFIG_ERR_INVALID_VALUE
;

442 
cÚfig
->
debug_Ëv–
 = 
Ëv–
;

444 
	}
}

446 
	$hªdË_u£_xms
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

447 
cÚfig
->
u£_xms
 = (
	`©oi
(
v®ue
) != 0);

449 
	}
}

451 
	$hªdË_’abË_routšg
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

452 
cÚfig
->
’abË_routšg
 = (
	`©oi
(
v®ue
) != 0);

454 
	}
}

456 
	$hªdË_’abË_¡©ic_routšg
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

457 
cÚfig
->
’abË_¡©ic_routšg
 = (
	`©oi
(
v®ue
) != 0);

459 
	}
}

461 
	$hªdË_bufãr_couÁ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

462 
couÁ
 = 
	`©oi
(
v®ue
);

463 ià(
couÁ
 < 1 || count > 16) {

464  
CONFIG_ERR_INVALID_VALUE
;

466 
cÚfig
->
bufãr_couÁ
 = 
couÁ
;

468 
	}
}

470 
	$hªdË_bufãr_size
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

471 
size
 = 
	`©oi
(
v®ue
);

472 ià(
size
 < 64 || size > 65536) {

473  
CONFIG_ERR_INVALID_VALUE
;

475 
cÚfig
->
bufãr_size
 = 
size
;

477 
	}
}

479 
	$hªdË_š‹¼u±_veùÜ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

480 
veùÜ
;

481 ià(
	`ssÿnf
(
v®ue
, "%x", &
veùÜ
) != 1 || vector > 0xFF) {

482  
CONFIG_ERR_INVALID_VALUE
;

484 
cÚfig
->
š‹¼u±_veùÜ
 = (
ušt8_t
)
veùÜ
;

486 
	}
}

488 
	$hªdË_io_ba£
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

489 
ba£
;

490 ià(
	`ssÿnf
(
v®ue
, "%x", &
ba£
) != 1 || base > 0xFFFF) {

491  
CONFIG_ERR_INVALID_VALUE
;

493 
cÚfig
->
io_ba£
 = (
ušt16_t
)
ba£
;

495 
	}
}

497 
	$hªdË_œq
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

498 
œq
 = 
	`©oi
(
v®ue
);

499 ià(
œq
 < 2 || irq > 15) {

500  
CONFIG_ERR_INVALID_VALUE
;

502 
cÚfig
->
œq
 = irq;

504 
	}
}

506 
	$hªdË_’abË_¡©s
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

507 
cÚfig
->
’abË_¡©s
 = (
	`©oi
(
v®ue
) != 0);

509 
	}
}

511 
	$hªdË_´omiscuous_mode
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

512 
cÚfig
->
´omiscuous_mode
 = (
	`©oi
(
v®ue
) != 0);

514 
	}
}

516 
	$hªdË_’abË_loggšg
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

517 
cÚfig
->
’abË_loggšg
 = (
	`©oi
(
v®ue
) != 0);

519 
	}
}

521 
	$hªdË_‹¡_mode
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

522 
cÚfig
->
‹¡_mode
 = (
	`©oi
(
v®ue
) != 0);

524 
	}
}

528 
	$hªdË_io1_ba£
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

529 
ba£
;

530 ià(
	`·r£_hex_v®ue
(
v®ue
, &
ba£
è!ğ0 || !
	`cÚfig_is_v®id_io_add»ss
((
ušt16_t
)base)) {

531  
CONFIG_ERR_INVALID_VALUE
;

533 
cÚfig
->
io1_ba£
 = (
ušt16_t
)
ba£
;

534 
cÚfig
->
io_ba£
 = (
ušt16_t
)
ba£
;

536 
	}
}

538 
	$hªdË_io2_ba£
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

539 
ba£
;

540 ià(
	`·r£_hex_v®ue
(
v®ue
, &
ba£
è!ğ0 || !
	`cÚfig_is_v®id_io_add»ss
((
ušt16_t
)base)) {

541  
CONFIG_ERR_INVALID_VALUE
;

543 
cÚfig
->
io2_ba£
 = (
ušt16_t
)
ba£
;

545 
	}
}

547 
	$hªdË_œq1
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

548 
œq
 = 
	`©oi
(
v®ue
);

549 ià(!
	`cÚfig_is_v®id_œq_numb”
((
ušt8_t
)
œq
)) {

550  
CONFIG_ERR_INVALID_VALUE
;

552 
cÚfig
->
œq1
 = (
ušt8_t
)
œq
;

553 
cÚfig
->
œq
 = (
ušt8_t
)irq;

555 
	}
}

557 
	$hªdË_œq2
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

558 
œq
 = 
	`©oi
(
v®ue
);

559 ià(!
	`cÚfig_is_v®id_œq_numb”
((
ušt8_t
)
œq
)) {

560  
CONFIG_ERR_INVALID_VALUE
;

562 
cÚfig
->
œq2
 = (
ušt8_t
)
œq
;

564 
	}
}

566 
	$hªdË_¥“d
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

567 ià(
	`¡ricmp
(
v®ue
, "AUTO") == 0) {

568 
cÚfig
->
¥“d
 = 
SPEED_AUTO
;

569 } ià(
	`¡ricmp
(
v®ue
, "10") == 0) {

570 
cÚfig
->
¥“d
 = 
SPEED_10
;

571 } ià(
	`¡ricmp
(
v®ue
, "100") == 0) {

572 
cÚfig
->
¥“d
 = 
SPEED_100
;

574  
CONFIG_ERR_INVALID_VALUE
;

577 
	}
}

579 
	$hªdË_busma¡”
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

580 ià(
	`¡ricmp
(
v®ue
, "ON") == 0) {

581 
cÚfig
->
busma¡”
 = 
BUSMASTER_ON
;

582 } ià(
	`¡ricmp
(
v®ue
, "OFF") == 0) {

583 
cÚfig
->
busma¡”
 = 
BUSMASTER_OFF
;

584 } ià(
	`¡ricmp
(
v®ue
, "AUTO") == 0) {

585 
cÚfig
->
busma¡”
 = 
BUSMASTER_AUTO
;

587  
CONFIG_ERR_INVALID_VALUE
;

590 
	}
}

592 
	$hªdË_log
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

593 ià(
	`¡ricmp
(
v®ue
, "ON") == 0) {

594 
cÚfig
->
log_’abËd
 = 
Œue
;

595 
cÚfig
->
’abË_loggšg
 = 1;

596 } ià(
	`¡ricmp
(
v®ue
, "OFF") == 0) {

597 
cÚfig
->
log_’abËd
 = 
çl£
;

598 
cÚfig
->
’abË_loggšg
 = 0;

600  
CONFIG_ERR_INVALID_VALUE
;

603 
	}
}

605 
	$hªdË_rou‹
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

606 ià(
cÚfig
->
rou‹_couÁ
 >ğ
MAX_ROUTES
) {

607  
CONFIG_ERR_TOO_MANY_ROUTES
;

610 
rou‹_’Œy_t
* 
rou‹
 = &
cÚfig
->
rou‹s
[cÚfig->
rou‹_couÁ
];

611 
»suÉ
 = 
	`cÚfig_·r£_rou‹_’Œy
(
v®ue
, 
rou‹
);

612 ià(
»suÉ
 == 0) {

613 
cÚfig
->
rou‹_couÁ
++;

614 
cÚfig
->
’abË_¡©ic_routšg
 = 1;

616  
»suÉ
;

617 
	}
}

621 
	$hªdË_bufãr_size_ov”ride
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

622 
size
 = 
	`©oi
(
v®ue
);

623 ià(
size
 != 256 && size != 512 && size != 1024 && size != 1536) {

624 
	`log_”rÜ
("Buffer size must be 256, 512, 1024, or 1536");

625  
CONFIG_ERR_INVALID_VALUE
;

627 
cÚfig
->
ov”ride_bufãr_size
 = (
ušt16_t
)
size
;

630 
	}
}

632 
	$hªdË_tx_ršg_couÁ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

633 
couÁ
 = 
	`©oi
(
v®ue
);

634 ià(
couÁ
 < 4 || count > 32) {

635 
	`log_”rÜ
("TX„ing count must be between 4‡nd 32");

636  
CONFIG_ERR_INVALID_VALUE
;

638 
cÚfig
->
ov”ride_tx_ršg_couÁ
 = (
ušt8_t
)
couÁ
;

640 
	}
}

642 
	$hªdË_rx_ršg_couÁ
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

643 
couÁ
 = 
	`©oi
(
v®ue
);

644 ià(
couÁ
 < 8 || count > 32) {

645 
	`log_”rÜ
("RX„ing count must be between 8‡nd 32");

646  
CONFIG_ERR_INVALID_VALUE
;

648 
cÚfig
->
ov”ride_rx_ršg_couÁ
 = (
ušt8_t
)
couÁ
;

650 
	}
}

652 
	$hªdË_fÜû_pio
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

654 ià(!
v®ue
 || 
	`¡ricmp
(v®ue, "ON"è=ğ0 || 
	`¡rcmp
(value, "1") == 0) {

655 
cÚfig
->
fÜû_pio_mode
 = 1;

656 
	`log_šfo
("Forcing PIO mode (bus master disabled)");

657 } ià(
	`¡ricmp
(
v®ue
, "OFF"è=ğ0 || 
	`¡rcmp
(value, "0") == 0) {

658 
cÚfig
->
fÜû_pio_mode
 = 0;

660  
CONFIG_ERR_INVALID_VALUE
;

663 
	}
}

665 
	$hªdË_mšim®_bufãrs
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

667 ià(!
v®ue
 || 
	`¡ricmp
(v®ue, "ON"è=ğ0 || 
	`¡rcmp
(value, "1") == 0) {

668 
cÚfig
->
fÜû_mšim®_bufãrs
 = 1;

669 
	`log_šfo
("Forcing minimal 3KB buffer configuration");

670 } ià(
	`¡ricmp
(
v®ue
, "OFF"è=ğ0 || 
	`¡rcmp
(value, "0") == 0) {

671 
cÚfig
->
fÜû_mšim®_bufãrs
 = 0;

673  
CONFIG_ERR_INVALID_VALUE
;

676 
	}
}

678 
	$hªdË_İtim®_bufãrs
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

680 ià(!
v®ue
 || 
	`¡ricmp
(v®ue, "ON"è=ğ0 || 
	`¡rcmp
(value, "1") == 0) {

681 
cÚfig
->
fÜû_İtim®_bufãrs
 = 1;

682 
	`log_šfo
("Forcing optimal buffer configuration");

683 } ià(
	`¡ricmp
(
v®ue
, "OFF"è=ğ0 || 
	`¡rcmp
(value, "0") == 0) {

684 
cÚfig
->
fÜû_İtim®_bufãrs
 = 0;

686  
CONFIG_ERR_INVALID_VALUE
;

689 
	}
}

691 
	$hªdË_bufãr_cÚfig
(
cÚfig_t
 *
cÚfig
, cÚ¡ *
v®ue
) {

693 
size
, 
tx
, 
rx
;

695 ià(
	`ssÿnf
(
v®ue
, "%d,%d,%d", &
size
, &
tx
, &
rx
) != 3) {

696 
	`log_”rÜ
("BUFFERS format: size,tx,rx (e.g., 1024,16,16)");

697  
CONFIG_ERR_INVALID_VALUE
;

701 ià(
size
 != 256 && size != 512 && size != 1024 && size != 1536) {

702 
	`log_”rÜ
("Buffer size must be 256, 512, 1024, or 1536");

703  
CONFIG_ERR_INVALID_VALUE
;

707 ià(
tx
 < 4 ||x > 32) {

708 
	`log_”rÜ
("TX„ing count must be between 4‡nd 32");

709  
CONFIG_ERR_INVALID_VALUE
;

713 ià(
rx
 < 8 ||„x > 32) {

714 
	`log_”rÜ
("RX„ing count must be between 8‡nd 32");

715  
CONFIG_ERR_INVALID_VALUE
;

718 
cÚfig
->
ov”ride_bufãr_size
 = (
ušt16_t
)
size
;

719 
cÚfig
->
ov”ride_tx_ršg_couÁ
 = (
ušt8_t
)
tx
;

720 
cÚfig
->
ov”ride_rx_ršg_couÁ
 = (
ušt8_t
)
rx
;

722 
	`log_šfo
("Bufã¸cÚfig ov”ride: %dB x %d TX, %d RX", 
size
, 
tx
, 
rx
);

724 
	}
}

728 * 
	$nÜm®ize_·¿m‘”_Çme
(cÚ¡ * 
·¿m
) {

729 * 
nÜm®ized
 = 
	`m®loc
(
	`¡¾’
(
·¿m
) + 1);

730 ià(!
nÜm®ized
) {

731  
NULL
;

735 
i
;

736 
i
 = 0; 
·¿m
[i]; i++) {

737 
nÜm®ized
[
i
] = 
	`touµ”
(
·¿m
[i]);

739 
nÜm®ized
[
i
] = '\0';

741  
nÜm®ized
;

742 
	}
}

744 
	$·r£_hex_v®ue
(cÚ¡ * 
v®ue
, * 
»suÉ
) {

745 * 
’d±r
;

748 ià(
	`¡ºcmp
(
v®ue
, "0x", 2) == 0 || strncmp(value, "0X", 2) == 0) {

749 *
»suÉ
 = 
	`¡¹oul
(
v®ue
, &
’d±r
, 16);

752 *
»suÉ
 = 
	`¡¹oul
(
v®ue
, &
’d±r
, 16);

753 ià(*
’d±r
 != '\0') {

754 *
»suÉ
 = 
	`¡¹oul
(
v®ue
, &
’d±r
, 10);

758  (*
’d±r
 == '\0') ? 0 : -1;

759 
	}
}

761 
	$·r£_ÃtwÜk_add»ss
(cÚ¡ * 
addr_¡r
, 
ušt32_t
* 
ÃtwÜk
, ušt32_t* 
Ãtmask
) {

762 * 
addr_cİy
 = 
	`m®loc
(
	`¡¾’
(
addr_¡r
) + 1);

763 ià(!
addr_cİy
) {

764  
CONFIG_ERR_MEMORY
;

766 
	`¡rıy
(
addr_cİy
, 
addr_¡r
);

769 * 
mask_¡r
 = 
	`¡rchr
(
addr_cİy
, '/');

770 ià(!
mask_¡r
) {

771 
	`ä“
(
addr_cİy
);

772  
CONFIG_ERR_ROUTE_SYNTAX
;

774 *
mask_¡r
 = '\0';

775 
mask_¡r
++;

778 
a
, 
b
, 
c
, 
d
;

779 ià(
	`ssÿnf
(
addr_cİy
, "%u.%u.%u.%u", &
a
, &
b
, &
c
, &
d
) != 4 ||

780 
a
 > 255 || 
b
 > 255 || 
c
 > 255 || 
d
 > 255) {

781 
	`ä“
(
addr_cİy
);

782  
CONFIG_ERR_ROUTE_SYNTAX
;

784 *
ÃtwÜk
 = (
a
 << 24è| (
b
 << 16è| (
c
 << 8è| 
d
;

787 
cidr
 = 
	`©oi
(
mask_¡r
);

788 ià(
cidr
 < 0 || cidr > 32) {

789 
	`ä“
(
addr_cİy
);

790  
CONFIG_ERR_ROUTE_SYNTAX
;

793 ià(
cidr
 == 0) {

794 *
Ãtmask
 = 0;

796 *
Ãtmask
 = ~((1UL << (32 - 
cidr
)) - 1);

799 
	`ä“
(
addr_cİy
);

801 
	}
}

803 
	$·r£__add»ss
(cÚ¡ * 
addr_¡r
, 
ušt32_t
* 
_addr
) {

804 ià(!
addr_¡r
 || !
_addr
) {

805  
CONFIG_ERR_INVALID_PARAM
;

809 
a
, 
b
, 
c
, 
d
;

810 ià(
	`ssÿnf
(
addr_¡r
, "%u.%u.%u.%u", &
a
, &
b
, &
c
, &
d
) != 4 ||

811 
a
 > 255 || 
b
 > 255 || 
c
 > 255 || 
d
 > 255) {

812  
CONFIG_ERR_ROUTE_SYNTAX
;

815 *
_addr
 = (
a
 << 24è| (
b
 << 16è| (
c
 << 8è| 
d
;

817 
	}
}

821 
boŞ
 
	$cÚfig_is_v®id_io_add»ss
(
ušt16_t
 
io_ba£
) {

822  (
io_ba£
 >ğ
CONFIG_MIN_IO_BASE
 && io_ba£ <ğ
CONFIG_MAX_IO_BASE
 &&

823 (
io_ba£
 & 0x1F) == 0);

824 
	}
}

826 
boŞ
 
	$cÚfig_is_v®id_œq_numb”
(
ušt8_t
 
œq
) {

827  (
CONFIG_VALID_IRQS
 & (1 << 
œq
)) != 0;

828 
	}
}

830 
boŞ
 
	$cÚfig_check_io_cÚæiù
(
ušt16_t
 
io1
, ušt16_ˆ
io2
) {

831 ià(
io1
 =ğ
io2
) {

832  
çl£
;

836 
ušt16_t
 
io1_’d
 = 
io1
 + 
CONFIG_IO_RANGE_SIZE
 - 1;

837 
ušt16_t
 
io2_’d
 = 
io2
 + 
CONFIG_IO_RANGE_SIZE
 - 1;

839  !(
io1
 <ğ
io2_’d
 && 
io2
 <ğ
io1_’d
);

840 
	}
}

842 
boŞ
 
	$cÚfig_check_œq_cÚæiù
(
ušt8_t
 
œq1
, ušt8_ˆ
œq2
) {

843  
œq1
 !ğ
œq2
;

844 
	}
}

846 
boŞ
 
	$cÚfig_ıu_suµÜts_busma¡”
() {

848 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80286
) {

849  
Œue
;

851  
çl£
;

852 
	}
}

854 
	$cÚfig_·r£_rou‹_’Œy
(cÚ¡ * 
rou‹_¡r
, 
rou‹_’Œy_t
* 
rou‹
) {

855 ià(!
rou‹_¡r
 || !
rou‹
) {

856  
CONFIG_ERR_INVALID_PARAM
;

860 * 
rou‹_cİy
 = 
	`m®loc
(
	`¡¾’
(
rou‹_¡r
) + 1);

861 ià(!
rou‹_cİy
) {

862  
CONFIG_ERR_MEMORY
;

864 
	`¡rıy
(
rou‹_cİy
, 
rou‹_¡r
);

867 * 
nic_¡r
 = 
	`¡¼chr
(
rou‹_cİy
, ',');

868 ià(!
nic_¡r
) {

869 
	`ä“
(
rou‹_cİy
);

870  
CONFIG_ERR_ROUTE_SYNTAX
;

872 *
nic_¡r
 = '\0';

873 
nic_¡r
++;

876 * 
g©eway_¡r
 = 
	`¡rchr
(
nic_¡r
, ',');

877 ià(
g©eway_¡r
) {

878 *
g©eway_¡r
 = '\0';

879 
g©eway_¡r
++;

883 
»suÉ
 = 
	`·r£_ÃtwÜk_add»ss
(
rou‹_cİy
, &
rou‹
->
ÃtwÜk
, &rou‹->
Ãtmask
);

884 ià(
»suÉ
 != 0) {

885 
	`ä“
(
rou‹_cİy
);

886  
»suÉ
;

890 
nic_id
 = 
	`©oi
(
nic_¡r
);

891 ià(
nic_id
 < 0 ||‚ic_id >ğ
MAX_NICS
) {

892 
	`ä“
(
rou‹_cİy
);

893  
CONFIG_ERR_ROUTE_SYNTAX
;

895 
rou‹
->
nic_id
 = (
ušt8_t
)nic_id;

896 
rou‹
->
aùive
 = 
Œue
;

899 ià(
	`¡©ic_routšg_is_’abËd
()) {

900 
_addr_t
 
de¡_ÃtwÜk
, 
Ãtmask
, 
g©eway
;

903 
	`_addr_äom_ušt32
(&
de¡_ÃtwÜk
, 
rou‹
->
ÃtwÜk
);

904 
	`_addr_äom_ušt32
(&
Ãtmask
, 
rou‹
->netmask);

906 ià(
g©eway_¡r
) {

908 
ušt32_t
 
gw_addr
;

909 ià(
	`·r£__add»ss
(
g©eway_¡r
, &
gw_addr
) == 0) {

910 
	`_addr_äom_ušt32
(&
g©eway
, 
gw_addr
);

911 
»suÉ
 = 
	`¡©ic_rou‹_add
(&
de¡_ÃtwÜk
, &
Ãtmask
, &
g©eway
, 
nic_id
, 1);

913 
	`ä“
(
rou‹_cİy
);

914  
CONFIG_ERR_ROUTE_SYNTAX
;

918 
	`_addr_£t
(&
g©eway
, 0, 0, 0, 0);

919 
»suÉ
 = 
	`¡©ic_rou‹_add
(&
de¡_ÃtwÜk
, &
Ãtmask
, 
NULL
, 
nic_id
, 1);

922 ià(
»suÉ
 !ğ
SUCCESS
) {

923 
	`log_w¬nšg
("FaedØadd stiørou‹: %d", 
»suÉ
);

925 
	`log_šfo
("Added static„oute: %d.%d.%d.%d/%d.%d.%d.%d via NIC %d",

926 
de¡_ÃtwÜk
.
addr
[0], dest_network.addr[1], dest_network.addr[2], dest_network.addr[3],

927 
Ãtmask
.
addr
[0],‚etmask.addr[1],‚etmask.addr[2],‚etmask.addr[3],

928 
nic_id
);

932 
	`ä“
(
rou‹_cİy
);

934 
	}
}

936 
	$cÚfig_v®id©e_üoss_·¿m‘”s
(cÚ¡ 
cÚfig_t
* 
cÚfig
) {

937 ià(!
cÚfig
) {

938  
CONFIG_ERR_INVALID_PARAM
;

942 ià(
cÚfig
->
busma¡”
 =ğ
BUSMASTER_ON
 && !
	`cÚfig_ıu_suµÜts_busma¡”
()) {

943 
	`log_”rÜ
("Bus mastering„equires 386+ CPU, but %s detected",

944 
	`ıu_ty³_to_¡ršg
(
g_ıu_šfo
.
ty³
));

945  
CONFIG_ERR_CPU_REQUIRED
;

951 
	}
}

965 
	$cÚfig_³rfÜm_busma¡”_auto_‹¡
(
cÚfig_t
 *
cÚfig
, 
nic_cÚ‹xt_t
 *
ùx
, 
boŞ
 
quick_mode
) {

966 ià(!
cÚfig
 || !
ùx
) {

967 
	`log_”rÜ
("config_perform_busmaster_auto_test: NULL…arameters");

968  
CONFIG_ERR_INVALID_PARAM
;

972 ià(
ùx
->
nic_šfo
.
ty³
 !ğ
NIC_TYPE_3C515_TX
) {

973 
	`log_šfo
("Bus mastering‚ot supported on %s - using…rogrammed I/O",

974 (
ùx
->
nic_šfo
.
ty³
 =ğ
NIC_TYPE_3C509B
) ? "3C509B" : "Unknown NIC");

975 
cÚfig
->
busma¡”
 = 
BUSMASTER_OFF
;

980 ià(!
	`cÚfig_ıu_suµÜts_busma¡”
()) {

981 
	`log_šfo
("CPU does‚ot support bus mastering - using…rogrammed I/O");

982 
cÚfig
->
busma¡”
 = 
BUSMASTER_OFF
;

987 
boŞ
 
is_286_sy¡em
 = 
	`ıu_»quœes_cÚ£rv©ive_‹¡šg
();

988 
ušt16_t
 
ıu_th»shŞd
 = 
	`g‘_ıu_­´İrŸ‹_cÚfid’û_th»shŞd
();

990 
	`log_šfo
("=== CPU-Aware Bus Mastering Configuration ===");

991 
	`log_šfo
("Detected: %s CPU",

992 (
g_ıu_šfo
.
ty³
 =ğ
CPU_TYPE_80286
) ? "80286" :

993 (
g_ıu_šfo
.
ty³
 =ğ
CPU_TYPE_80386
) ? "80386" :

994 (
g_ıu_šfo
.
ty³
 =ğ
CPU_TYPE_80486
) ? "80486" :

995 (
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_PENTIUM
) ? "Pentium+" : "Unknown");

998 
busma¡”_‹¡_ÿche_t
 
ÿched_»suÉs
;

999 
ÿche_v®id©iÚ_šfo_t
 
v®id©iÚ
;

1000 
busma¡”_‹¡_»suÉs_t
 
‹¡_»suÉs
;

1002 ià(
	`lßd_busma¡”_‹¡_ÿche
(
ùx
, &
ÿched_»suÉs
) == 0) {

1004 ià(
	`v®id©e_busma¡”_‹¡_ÿche
(
ùx
, &
ÿched_»suÉs
, &
v®id©iÚ
) == 0) {

1006 
	`log_šfo
("Using cached bus masteringest„esults");

1007 
	`ÿche_to_‹¡_»suÉs
(&
ÿched_»suÉs
, &
‹¡_»suÉs
);

1010 
­¶y_»suÉ
 = 
	`­¶y_busma¡”_cÚfigu¿tiÚ
(
ùx
, &
‹¡_»suÉs
, 
cÚfig
);

1011 ià(
­¶y_»suÉ
 == 0) {

1012 
	`log_šfo
("Bus mastering configured from cache: %s",

1013 (
cÚfig
->
busma¡”
 =ğ
BUSMASTER_ON
) ? "ENABLED" : "DISABLED");

1015  
­¶y_»suÉ
;

1018 
	`log_šfo
("Cached„esuÉ šv®id: %s", 
v®id©iÚ
.
šv®id©iÚ_»asÚ
);

1021 
	`log_šfo
("No cachedest„esults found");

1025 ià(
is_286_sy¡em
) {

1027 
	`log_šfo
("80286 system detected - conservativeesting„equired for bus mastering");

1028 
	`log_šfo
("Quickest (10s) will„un first,ƒxhaustiveest (45s)„equired for bus mastering");

1031 ià(
	`³rfÜm_ıu_aw¬e_‹¡šg
(
ùx
, 
cÚfig
, &
‹¡_»suÉs
, 
Œue
) != 0) {

1032  
	`çÎback_to_´og¿mmed_io
(
ùx
, 
cÚfig
, "Quickest failed");

1036 ià(
‹¡_»suÉs
.
cÚfid’û_scÜe
 < 
ıu_th»shŞd
) {

1037 ià(!
quick_mode
 && 
	`´om±_u£r_fÜ_exhau¡ive_‹¡
()) {

1038 
	`log_šfo
("Runningƒxhaustive 45-secondest for 80286 bus mastering validation...");

1039 ià(
	`³rfÜm_ıu_aw¬e_‹¡šg
(
ùx
, 
cÚfig
, &
‹¡_»suÉs
, 
çl£
) != 0) {

1040  
	`çÎback_to_´og¿mmed_io
(
ùx
, 
cÚfig
, "Exhaustiveest failed");

1043 
	`log_šfo
("80286 system„equiresƒxhaustiveest for bus mastering - using PIO mode");

1044 
cÚfig
->
busma¡”
 = 
BUSMASTER_OFF
;

1045 
	`§ve_busma¡”_‹¡_ÿche
(
ùx
, &
‹¡_»suÉs
);

1052 
	`log_šfo
("80386+ system detected - quickest sufficient for bus mastering");

1055 
busma¡”_‹¡_mode_t
 
‹¡_mode
 = 
quick_mode
 ? 
BM_TEST_MODE_QUICK
 : 
BM_TEST_MODE_FULL
;

1056 
	`log_šfo
("Running %sest (user…reference)...",

1057 
quick_mode
 ? "quick 10-second" : "comprehensive 45-second");

1059 ià(
	`³rfÜm_ıu_aw¬e_‹¡šg
(
ùx
, 
cÚfig
, &
‹¡_»suÉs
, 
quick_mode
) != 0) {

1060  
	`çÎback_to_´og¿mmed_io
(
ùx
, 
cÚfig
, "Test failed");

1065 
­¶y_»suÉ
 = 
	`­¶y_busma¡”_cÚfigu¿tiÚ
(
ùx
, &
‹¡_»suÉs
, 
cÚfig
);

1066 ià(
­¶y_»suÉ
 != 0) {

1067 
	`log_”rÜ
("Failedo‡pply bus mastering configuration");

1068  
­¶y_»suÉ
;

1072 ià(
	`§ve_busma¡”_‹¡_ÿche
(
ùx
, &
‹¡_»suÉs
) == 0) {

1073 
	`log_šfo
("Test„esults cached - subsequent boots will be faster");

1076 
	`log_šfo
("=== Bus Mastering Auto-Configuration Complete ===");

1077 
	`log_šfo
("Final Configuration: %s (Confidence: %s, Score: %u/%u)",

1078 (
cÚfig
->
busma¡”
 =ğ
BUSMASTER_ON
) ? "Bus Mastering ENABLED" : "Programmed I/O MODE",

1079 (
‹¡_»suÉs
.
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_HIGH
) ? "HIGH" :

1080 (
‹¡_»suÉs
.
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_MEDIUM
) ? "MEDIUM" :

1081 (
‹¡_»suÉs
.
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_LOW
) ? "LOW" : "FAILED",

1082 
‹¡_»suÉs
.
cÚfid’û_scÜe
, 
BM_SCORE_TOTAL_MAX
);

1085 
	}
}

1090 
	$³rfÜm_ıu_aw¬e_‹¡šg
(
nic_cÚ‹xt_t
 *
ùx
, 
cÚfig_t
 *
cÚfig
,

1091 
busma¡”_‹¡_»suÉs_t
 *
»suÉs
, 
boŞ
 
quick_mode
) {

1093 ià(
	`busma¡”_‹¡_š™
(
ùx
) != 0) {

1094 
	`log_”rÜ
("Failedo initialize bus masteringest framework");

1099 
busma¡”_‹¡_mode_t
 
‹¡_mode
 = 
quick_mode
 ? 
BM_TEST_MODE_QUICK
 : 
BM_TEST_MODE_FULL
;

1100 
‹¡_»suÉ
 = 
	`³rfÜm_autom©ed_busma¡”_‹¡
(
ùx
, 
‹¡_mode
, 
»suÉs
);

1103 
	`log_šfo
("Bus masteringest completed:");

1104 
	`log_šfo
(" Total Score: %u/%u (%.1f%%)",

1105 
»suÉs
->
cÚfid’û_scÜe
, 
BM_SCORE_TOTAL_MAX
,

1106 (
»suÉs
->
cÚfid’û_scÜe
 * 100.0è/ 
BM_SCORE_TOTAL_MAX
);

1107 
	`log_šfo
(" Confidence Level: %s",

1108 (
»suÉs
->
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_HIGH
) ? "HIGH" :

1109 (
»suÉs
->
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_MEDIUM
) ? "MEDIUM" :

1110 (
»suÉs
->
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_LOW
) ? "LOW" : "FAILED");

1111 
	`log_šfo
(" Individual Scores: DMA=%u/70, Memory=%u/80, Timing=%u/100",

1112 
»suÉs
->
dma_cÚŒŞËr_scÜe
,„esuÉs->
memÜy_coh”’cy_scÜe
,

1113 
»suÉs
->
timšg_cÚ¡¿šts_scÜe
);

1114 
	`log_šfo
(" Pattern Tests: Data=%u/85, Burst=%u/82, Recovery=%u/85",

1115 
»suÉs
->
d©a_š‹gr™y_scÜe
,„esuÉs->
bur¡_Œªsãr_scÜe
,

1116 
»suÉs
->
”rÜ_»cov”y_scÜe
);

1117 ià(!
quick_mode
) {

1118 
	`log_šfo
(" Sb™y Te¡: %u/50", 
»suÉs
->
¡ab™y_scÜe
);

1122 
	`busma¡”_‹¡_ş—nup
(
ùx
);

1124  
‹¡_»suÉ
;

1125 
	}
}

1130 
boŞ
 
	$´om±_u£r_fÜ_exhau¡ive_‹¡
() {

1132 
	`´štf
("\n80286 system„equires 45-secondƒxhaustiveest for bus mastering.\n");

1133 
	`´štf
("[E]xhaustiveest (recommended) or [S]kip (use PIO): ");

1135 
»¥Ú£
 = 
	`g‘ch¬
();

1136 
	`g‘ch¬
();

1138  (
»¥Ú£
 == 'E' ||„esponse == 'e');

1139 
	}
}

1144 
	$­¶y_busma¡”_cÚfigu¿tiÚ
(
nic_cÚ‹xt_t
 *
ùx
,

1145 cÚ¡ 
busma¡”_‹¡_»suÉs_t
 *
»suÉs
,

1146 
cÚfig_t
 *
cÚfig
) {

1147 ià(!
ùx
 || !
»suÉs
 || !
cÚfig
) {

1148 
	`log_”rÜ
("apply_busmaster_configuration: NULL…arameters");

1149  
CONFIG_ERR_INVALID_PARAM
;

1153 
»suÉs
->
cÚfid’û_Ëv–
) {

1154 
BM_CONFIDENCE_HIGH
:

1155 
cÚfig
->
busma¡”
 = 
BUSMASTER_ON
;

1156 
	`log_šfo
("HIGH confidence - Bus mastering ENABLED");

1157 
	`log_šfo
("System showsƒxcellent compatibility for bus mastering");

1160 
BM_CONFIDENCE_MEDIUM
:

1161 
cÚfig
->
busma¡”
 = 
BUSMASTER_ON
;

1162 
	`log_šfo
("MEDIUM confidence - Bus mastering ENABLED with monitoring");

1163 
	`log_w¬nšg
("Monitor system for stability issues");

1166 
BM_CONFIDENCE_LOW
:

1167 
cÚfig
->
busma¡”
 = 
BUSMASTER_OFF
;

1168 
	`log_w¬nšg
("LOW confidence - Bus mastering DISABLED");

1169 
	`log_w¬nšg
("System compatibility questionable - using…rogrammed I/O for safety");

1170  
	`çÎback_to_´og¿mmed_io
(
ùx
, 
cÚfig
, "Low confidence score");

1172 
BM_CONFIDENCE_FAILED
:

1174 
cÚfig
->
busma¡”
 = 
BUSMASTER_OFF
;

1175 
	`log_”rÜ
("Test FAILED - Bus mastering DISABLED");

1176 
	`log_”rÜ
("System‚ot compatible with bus mastering - using…rogrammed I/O");

1177  
	`çÎback_to_´og¿mmed_io
(
ùx
, 
cÚfig
, 
»suÉs
->
çu»_»asÚ
);

1181 
	}
}

1186 
	$g’”©e_busma¡”_‹¡_»pÜt
(cÚ¡ 
busma¡”_‹¡_»suÉs_t
 *
»suÉs
,

1187 *
bufãr
, 
size_t
 
bufãr_size
) {

1188 ià(!
»suÉs
 || !
bufãr
 || 
bufãr_size
 == 0) {

1189  
CONFIG_ERR_INVALID_PARAM
;

1192 
wr™‹n
 = 
	`¢´štf
(
bufãr
, 
bufãr_size
,

1225 
»suÉs
->
cÚfid’û_scÜe
, 
BM_SCORE_TOTAL_MAX
,

1226 (
»suÉs
->
cÚfid’û_scÜe
 * 100.0è/ 
BM_SCORE_TOTAL_MAX
,

1227 (
»suÉs
->
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_HIGH
) ? "HIGH" :

1228 (
»suÉs
->
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_MEDIUM
) ? "MEDIUM" :

1229 (
»suÉs
->
cÚfid’û_Ëv–
 =ğ
BM_CONFIDENCE_LOW
) ? "LOW" : "FAILED",

1230 
»suÉs
->
‹¡_du¿tiÚ_ms
,

1231 
»suÉs
->
dma_cÚŒŞËr_scÜe
,

1232 
»suÉs
->
memÜy_coh”’cy_scÜe
,

1233 
»suÉs
->
timšg_cÚ¡¿šts_scÜe
,

1234 
»suÉs
->
d©a_š‹gr™y_scÜe
,

1235 
»suÉs
->
bur¡_Œªsãr_scÜe
,

1236 
»suÉs
->
”rÜ_»cov”y_scÜe
,

1237 
»suÉs
->
¡ab™y_scÜe
,

1238 
»suÉs
->
ıu_suµÜts_busma¡”
 ? "YES" : "NO",

1239 
»suÉs
->
ch£t_com·tibË
 ? "YES" : "NO",

1240 
»suÉs
->
dma_cÚŒŞËr_´e£Á
 ? "YES" : "NO",

1241 
»suÉs
->
memÜy_coh”’t
 ? "YES" : "NO",

1242 
»suÉs
->
Œªsãrs_com¶‘ed
,

1243 
»suÉs
->
by‹s_Œªsã¼ed
,

1244 
»suÉs
->
”rÜ_couÁ
,

1245 (
»suÉs
->
Œªsãrs_com¶‘ed
 > 0) ?

1246 ((
»suÉs
->
Œªsãrs_com¶‘ed
 * 100.0è/ (»suÉs->Œªsãrs_com¶‘ed +„esuÉs->
”rÜ_couÁ
)) : 0.0,

1247 
»suÉs
->
»comm’d©iÚs
,

1248 
»suÉs
->
§ã_fÜ_´oduùiÚ
 ? "YES" : "NO",

1249 
»suÉs
->
»quœes_çÎback
 ? "YES" : "NO"

1252  (
wr™‹n
 > 0 && wr™‹À< ()
bufãr_size
è? 0 : 
CONFIG_ERR_MEMORY
;

1253 
	}
}

1256 
	$¡ricmp
(cÚ¡ * 
s1
, cÚ¡ * 
s2
) {

1257 *
s1
 && *
s2
) {

1258 
c1
 = 
	`touµ”
(*
s1
);

1259 
c2
 = 
	`touµ”
(*
s2
);

1260 ià(
c1
 !ğ
c2
) {

1261  
c1
 - 
c2
;

1263 
s1
++;

1264 
s2
++;

1266  
	`touµ”
(*
s1
è-ouµ”(*
s2
);

1267 
	}
}

1270 #´agm¨
code_£g
()

	@/Users/jvindahl/Development/3com-packet-driver/src/c/hardware.c

11 
	~"../šşude/h¬dw¬e.h
"

12 
	~"../šşude/h¬dw¬e_h®.h
"

13 
	~"../šşude/nic_cÚ‹xt.h
"

14 
	~"../šşude/h®_”rÜs.h
"

15 
	~"../šşude/»gi¡”_acûss.h
"

16 
	~"../šşude/nic_š™.h
"

17 
	~"../šşude/loggšg.h
"

18 
	~"../šşude/memÜy.h
"

19 
	~"../šşude/dŸgno¡ics.h
"

20 
	~"../šşude/3c509b.h
"

21 
	~"../šşude/3c515.h
"

22 
	~"../šşude/”rÜ_hªdlšg.h
"

23 
	~"../šşude/bufãr_®loc.h
"

24 
	~"../šşude/nic_bufãr_poŞs.h
"

25 
	~<¡ršg.h
>

26 
	~<¡dlib.h
>

29 
nic_šfo_t
 
	gg_nic_šfos
[
MAX_NICS
];

30 
	gg_num_nics
 = 0;

31 
boŞ
 
	gg_h¬dw¬e_š™Ÿlized
 = 
çl£
;

34 
nic_İs_t
 
	gg_3c509b_İs
;

35 
nic_İs_t
 
	gg_3c515_İs
;

38 
h¬dw¬e_h®_vbË_t
 
	gg_3c509b_h®_vbË
;

39 
h¬dw¬e_h®_vbË_t
 
	gg_3c515_tx_h®_vbË
;

42 
h¬dw¬e_¡©s_t
 
	gg_h¬dw¬e_¡©s
;

45 
nic_d‘eù_šfo_t
 
	gg_²p_d‘eùiÚ_»suÉs
[
MAX_NICS
];

46 
	gg_²p_d‘eùiÚ_couÁ
 = 0;

50 
ušt32_t
 
	m”rÜ_couÁs
[
MAX_NICS
][12];

51 
ušt32_t
 
	mÏ¡_”rÜ_time
[
MAX_NICS
];

52 
ušt32_t
 
	mcÚ£cutive_”rÜs
[
MAX_NICS
];

53 
ušt32_t
 
	m»cov”y_©‹m±s
[
MAX_NICS
];

54 
ušt32_t
 
	mÏ¡_»cov”y_time
[
MAX_NICS
];

55 
boŞ
 
	mçov”_š_´og»ss
;

56 
	m´im¬y_nic
;

57 
	mbackup_nic
;

58 
ušt32_t
 
	mtÙ®_çu»s
;

59 
ušt32_t
 
	msucûssful_»cov”›s
;

60 } 
	gg_”rÜ_»cov”y_¡©e
 = {0};

63 
h¬dw¬e_»£t_¡©s
();

64 
boŞ
 
h¬dw¬e_v®id©e_nic_šdex
(
šdex
);

65 
h¬dw¬e_upd©e_·ck‘_¡©s
(
boŞ
 
£Á
, boŞ 
sucûss
);

66 
h¬dw¬e_»gi¡”_nic_w™h_bufãr_sy¡em
(
nic_šfo_t
* 
nic
, 
nic_šdex
);

67 
h¬dw¬e_uÄegi¡”_nic_äom_bufãr_sy¡em
(
nic_šdex
);

70 
h¬dw¬e_d‘eù_çu»
(
nic_šfo_t
 *
nic
);

71 
h¬dw¬e_»cov”_nic
(
nic_šfo_t
 *
nic
, 
çu»_ty³
);

72 
h¬dw¬e_©‹m±_çov”
(
çed_nic_šdex
);

73 
h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic_šfo_t
 *
nic
);

74 
h¬dw¬e_v®id©e_»cov”y
(
nic_šfo_t
 *
nic
);

75 
h¬dw¬e_log_çu»
(
nic_šfo_t
 *
nic
, 
çu»_ty³
, cÚ¡ * 
d‘as
);

76 
h¬dw¬e_em”g’cy_»£t
(
nic_šfo_t
 *
nic
);

77 
boŞ
 
h¬dw¬e_is_ü™iÿl_çu»
(
çu»_ty³
);

78 
h¬dw¬e_nÙify_­¶iÿtiÚ_”rÜ
(
nic_šdex
, 
”rÜ_ty³
);

79 
ušt32_t
 
h¬dw¬e_ÿlcuÏ‹_»cov”y_timeout
(
çu»_ty³
);

82 
	#HW_FAILURE_NONE
 0

	)

83 
	#HW_FAILURE_LINK_LOST
 1

	)

84 
	#HW_FAILURE_TX_TIMEOUT
 2

	)

85 
	#HW_FAILURE_RX_TIMEOUT
 3

	)

86 
	#HW_FAILURE_FIFO_OVERRUN
 4

	)

87 
	#HW_FAILURE_DMA_ERROR
 5

	)

88 
	#HW_FAILURE_REGISTER_CORRUPTION
 6

	)

89 
	#HW_FAILURE_INTERRUPT_STORM
 7

	)

90 
	#HW_FAILURE_MEMORY_ERROR
 8

	)

91 
	#HW_FAILURE_THERMAL
 9

	)

92 
	#HW_FAILURE_POWER
 10

	)

93 
	#HW_FAILURE_CRITICAL
 11

	)

96 
	#RECOVERY_SOFT_RESET
 1

	)

97 
	#RECOVERY_HARD_RESET
 2

	)

98 
	#RECOVERY_REINITIALIZE
 3

	)

99 
	#RECOVERY_FAILOVER
 4

	)

100 
	#RECOVERY_DISABLE
 5

	)

103 
	#MAX_CONSECUTIVE_ERRORS
 5

	)

104 
	#MAX_ERROR_RATE_PERCENT
 15

	)

105 
	#LINK_CHECK_INTERVAL_MS
 1000

	)

106 
	#TX_TIMEOUT_MS
 5000

	)

107 
	#RX_TIMEOUT_MS
 2000

	)

110 
	$h¬dw¬e_š™
() {

111 ià(
g_h¬dw¬e_š™Ÿlized
) {

112  
SUCCESS
;

115 
	`LOG_INFO
("Initializing hardware‡bstraction†ayer");

118 
	`memÜy_z”o
(
g_nic_šfos
, (g_nic_infos));

119 
g_num_nics
 = 0;

122 
	`h¬dw¬e_»£t_¡©s
();

125 
»suÉ
 = 
	`h®_š™_vbËs
();

126 ià(
»suÉ
 !ğ
HAL_SUCCESS
) {

127 
	`LOG_ERROR
("FaedØš™ŸlizHAL vbËs: %d", 
»suÉ
);

128  
ERROR_HARDWARE
;

132 
»suÉ
 = 
	`nic_š™_sy¡em
();

133 ià(
»suÉ
 !ğ
SUCCESS
) {

134 
	`LOG_ERROR
("FaedØš™ŸlizNIC sy¡em: %d", 
»suÉ
);

135  
»suÉ
;

139 
»suÉ
 = 
	`h¬dw¬e_š™_”rÜ_hªdlšg
();

140 ià(
»suÉ
 !ğ
SUCCESS
) {

141 
	`LOG_ERROR
("FaedØš™Ÿliz”rÜ hªdlšg sy¡em: %d", 
»suÉ
);

142  
»suÉ
;

146 
g_num_nics
 = 
	`nic_š™_®l_d‘eùed
();

147 ià(
g_num_nics
 < 0) {

148 
	`LOG_WARNING
("No NICs detected or initialized");

149 
g_num_nics
 = 0;

153 
i
 = 0; i < 
g_num_nics
; i++) {

154 
»suÉ
 = 
	`h¬dw¬e_ü—‹_”rÜ_cÚ‹xt
(&
g_nic_šfos
[
i
]);

155 ià(
»suÉ
 !ğ
SUCCESS
) {

156 
	`LOG_WARNING
("FaedØü—‹ƒ¼Ü cÚ‹xˆfÜ NIC %d: %d", 
i
, 
»suÉ
);

160 
»suÉ
 = 
	`h¬dw¬e_»gi¡”_nic_w™h_bufãr_sy¡em
(&
g_nic_šfos
[
i
], i);

161 ià(
»suÉ
 !ğ
SUCCESS
) {

162 
	`LOG_WARNING
("FaedØ»gi¡” NIC %d w™h bufã¸sy¡em: %d", 
i
, 
»suÉ
);

166 
g_h¬dw¬e_š™Ÿlized
 = 
Œue
;

168 
	`LOG_INFO
("H¬dw¬Ïy” in™Ÿlized w™h %d NIC ªdƒ¼Ü hªdlšg", 
g_num_nics
);

170  
SUCCESS
;

171 
	}
}

173 
	$h¬dw¬e_ş—nup
() {

174 ià(!
g_h¬dw¬e_š™Ÿlized
) {

178 
	`LOG_INFO
("Shutting down hardware†ayer");

181 
i
 = 0; i < 
g_num_nics
; i++) {

183 
	`h¬dw¬e_uÄegi¡”_nic_äom_bufãr_sy¡em
(
i
);

185 ià(
g_nic_šfos
[
i
].
İs
 && g_nic_šfos[i].İs->
ş—nup
) {

186 
g_nic_šfos
[
i
].
İs
->
	`ş—nup
(&g_nic_infos[i]);

191 
	`nic_š™_ş—nup
();

194 
	`h¬dw¬e_ş—nup_”rÜ_hªdlšg
();

196 
g_num_nics
 = 0;

197 
g_h¬dw¬e_š™Ÿlized
 = 
çl£
;

198 
	}
}

201 
nic_İs_t
* 
	$g‘_nic_İs
(
nic_ty³_t
 
ty³
) {

202 
boŞ
 
vbËs_š™Ÿlized
 = 
çl£
;

205 ià(!
vbËs_š™Ÿlized
) {

206 
	`š™_3c509b_İs
();

207 
	`š™_3c515_İs
();

208 
vbËs_š™Ÿlized
 = 
Œue
;

211 
ty³
) {

212 
NIC_TYPE_3C509B
:

213  &
g_3c509b_İs
;

214 
NIC_TYPE_3C515_TX
:

215  &
g_3c515_İs
;

217  
NULL
;

219 
	}
}

221 
nic_İs_t
* 
	$g‘_3c509b_İs
() {

222  
	`g‘_nic_İs
(
NIC_TYPE_3C509B
);

223 
	}
}

225 
nic_İs_t
* 
	$g‘_3c515_İs
() {

226  
	`g‘_nic_İs
(
NIC_TYPE_3C515_TX
);

227 
	}
}

229 
	$h¬dw¬e_»gi¡”_nic_İs
(
nic_ty³_t
 
ty³
, 
nic_İs_t
 *
İs
) {

230 ià(!
İs
) {

231  
ERROR_INVALID_PARAM
;

237  
SUCCESS
;

238 
	}
}

241 
	$h¬dw¬e_g‘_nic_couÁ
() {

242  
g_num_nics
;

243 
	}
}

245 
nic_šfo_t
* 
	$h¬dw¬e_g‘_nic
(
šdex
) {

246 ià(!
	`h¬dw¬e_v®id©e_nic_šdex
(
šdex
)) {

247  
NULL
;

250  &
g_nic_šfos
[
šdex
];

251 
	}
}

253 
nic_šfo_t
* 
	$h¬dw¬e_fšd_nic_by_ty³
(
nic_ty³_t
 
ty³
) {

254 
i
 = 0; i < 
g_num_nics
; i++) {

255 ià(
g_nic_šfos
[
i
].
ty³
 ==ype) {

256  &
g_nic_šfos
[
i
];

260  
NULL
;

261 
	}
}

263 
nic_šfo_t
* 
	$h¬dw¬e_fšd_nic_by_mac
(cÚ¡ 
ušt8_t
 *
mac
) {

264 ià(!
mac
) {

265  
NULL
;

268 
i
 = 0; i < 
g_num_nics
; i++) {

269 ià(
	`memÜy_com·»
(
g_nic_šfos
[
i
].
mac
, mac, 
ETH_ALEN
) == 0) {

270  &
g_nic_šfos
[
i
];

274  
NULL
;

275 
	}
}

277 
boŞ
 
	$h¬dw¬e_is_nic_´e£Á
(
šdex
) {

278 ià(!
	`h¬dw¬e_v®id©e_nic_šdex
(
šdex
)) {

279  
çl£
;

282  (
g_nic_šfos
[
šdex
].
¡©us
 & 
NIC_STATUS_PRESENT
) != 0;

283 
	}
}

285 
boŞ
 
	$h¬dw¬e_is_nic_aùive
(
šdex
) {

286 ià(!
	`h¬dw¬e_v®id©e_nic_šdex
(
šdex
)) {

287  
çl£
;

290  (
g_nic_šfos
[
šdex
].
¡©us
 & 
NIC_STATUS_ACTIVE
) != 0;

291 
	}
}

294 
	$h¬dw¬e_£nd_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

295 ià(!
nic
 || !
·ck‘
 || 
Ëngth
 == 0) {

296 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

297  
ERROR_INVALID_PARAM
;

300 ià(!
nic
->
İs
 || !nic->İs->
£nd_·ck‘
) {

301 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

302  
ERROR_NOT_SUPPORTED
;

305 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

306 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

307  
ERROR_BUSY
;

310 
»suÉ
 = 
nic
->
İs
->
	`£nd_·ck‘
Òic, 
·ck‘
, 
Ëngth
);

311 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
»suÉ
 =ğ
SUCCESS
);

313  
»suÉ
;

314 
	}
}

316 
	$h¬dw¬e_»ûive_·ck‘
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
ušt16_t
 *
Ëngth
) {

317 ià(!
nic
 || !
bufãr
 || !
Ëngth
) {

318 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

319  
ERROR_INVALID_PARAM
;

322 ià(!
nic
->
İs
 || !nic->İs->
»ûive_·ck‘
) {

323 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

324  
ERROR_NOT_SUPPORTED
;

327 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

328 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

329  
ERROR_BUSY
;

332 
»suÉ
 = 
nic
->
İs
->
	`»ûive_·ck‘
Òic, 
bufãr
, 
Ëngth
);

333 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, 
»suÉ
 =ğ
SUCCESS
);

335  
»suÉ
;

336 
	}
}

338 
	$h¬dw¬e_£nd_·ck‘_to_nic
(
nic_šdex
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

339 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_šdex
);

340 ià(!
nic
) {

341  
ERROR_INVALID_PARAM
;

344  
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
·ck‘
, 
Ëngth
);

345 
	}
}

347 
	$h¬dw¬e_»ûive_·ck‘_äom_nic
(
nic_šdex
, 
ušt8_t
 *
bufãr
, 
ušt16_t
 *
Ëngth
) {

348 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_šdex
);

349 ià(!
nic
) {

350  
ERROR_INVALID_PARAM
;

353  
	`h¬dw¬e_»ûive_·ck‘
(
nic
, 
bufãr
, 
Ëngth
);

354 
	}
}

357 
	$h¬dw¬e_š‹¼u±_hªdËr
() {

358 
i
 = 0; i < 
g_num_nics
; i++) {

359 
nic_šfo_t
 *
nic
 = &
g_nic_šfos
[
i
];

361 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
è|| !nic->
İs
) {

366 ià(
nic
->
İs
->
check_š‹¼u±
 &&‚ic->İs->
	`check_š‹¼u±
(nic)) {

368 ià(
nic
->
İs
->
hªdË_š‹¼u±
) {

369 
nic
->
İs
->
	`hªdË_š‹¼u±
(nic);

373 
	}
}

375 
	$h¬dw¬e_’abË_š‹¼u±s
(
nic_šfo_t
 *
nic
) {

376 ià(!
nic
 || !nic->
İs
) {

377  
ERROR_INVALID_PARAM
;

380 ià(
nic
->
İs
->
’abË_š‹¼u±s
) {

381  
nic
->
İs
->
	`’abË_š‹¼u±s
(nic);

384  
ERROR_NOT_SUPPORTED
;

385 
	}
}

387 
	$h¬dw¬e_di§bË_š‹¼u±s
(
nic_šfo_t
 *
nic
) {

388 ià(!
nic
 || !nic->
İs
) {

389  
ERROR_INVALID_PARAM
;

392 ià(
nic
->
İs
->
di§bË_š‹¼u±s
) {

393  
nic
->
İs
->
	`di§bË_š‹¼u±s
(nic);

396  
ERROR_NOT_SUPPORTED
;

397 
	}
}

400 
	$h¬dw¬e_cÚfigu»_nic
(
nic_šfo_t
 *
nic
, cÚ¡ 
nic_cÚfig_t
 *
cÚfig
) {

401 ià(!
nic
 || !
cÚfig
) {

402  
ERROR_INVALID_PARAM
;

405 ià(!
nic
->
İs
 || !nic->İs->
cÚfigu»
) {

406  
ERROR_NOT_SUPPORTED
;

409  
nic
->
İs
->
	`cÚfigu»
Òic, 
cÚfig
);

410 
	}
}

412 
	$h¬dw¬e_»£t_nic
(
nic_šfo_t
 *
nic
) {

413 ià(!
nic
) {

414  
ERROR_INVALID_PARAM
;

417 ià(!
nic
->
İs
 || !nic->İs->
»£t
) {

418  
ERROR_NOT_SUPPORTED
;

421  
nic
->
İs
->
	`»£t
(nic);

422 
	}
}

424 
	$h¬dw¬e_£lf_‹¡_nic
(
nic_šfo_t
 *
nic
) {

425 ià(!
nic
) {

426  
ERROR_INVALID_PARAM
;

429 ià(!
nic
->
İs
 || !nic->İs->
£lf_‹¡
) {

430  
ERROR_NOT_SUPPORTED
;

433  
nic
->
İs
->
	`£lf_‹¡
(nic);

434 
	}
}

437 
boŞ
 
	$h¬dw¬e_is_lšk_up
(
nic_šfo_t
 *
nic
) {

438 ià(!
nic
) {

439  
çl£
;

442 ià(
nic
->
İs
 &&‚ic->İs->
g‘_lšk_¡©us
) {

443  
nic
->
İs
->
	`g‘_lšk_¡©us
(nic);

446  
nic
->
lšk_up
;

447 
	}
}

449 
	$h¬dw¬e_g‘_lšk_¥“d
(
nic_šfo_t
 *
nic
) {

450 ià(!
nic
) {

454 ià(
nic
->
İs
 &&‚ic->İs->
g‘_lšk_¥“d
) {

455  
nic
->
İs
->
	`g‘_lšk_¥“d
(nic);

458  
nic
->
¥“d
;

459 
	}
}

462 cÚ¡ 
h¬dw¬e_¡©s_t
* 
	$h¬dw¬e_g‘_¡©s
() {

463  &
g_h¬dw¬e_¡©s
;

464 
	}
}

466 
	$h¬dw¬e_ş—r_¡©s
() {

467 
	`h¬dw¬e_»£t_¡©s
();

468 
	}
}

470 
	$h¬dw¬e_´št_nic_šfo
(
šdex
) {

471 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
šdex
);

472 ià(!
nic
) {

473 
	`LOG_ERROR
("Inv®id NIC index: %d", 
šdex
);

477 
	`LOG_INFO
("NIC %d: Type=%d, I/O=0x%X, IRQ=%d, MAC=%02X:%02X:%02X:%02X:%02X:%02X",

478 
šdex
, 
nic
->
ty³
,‚ic->
io_ba£
,‚ic->
œq
,

479 
nic
->
mac
[0],‚ic->mac[1],‚ic->mac[2],

480 
nic
->
mac
[3],‚ic->mac[4],‚ic->mac[5]);

481 
	}
}

483 cÚ¡ * 
	$h¬dw¬e_nic_ty³_to_¡ršg
(
nic_ty³_t
 
ty³
) {

484 
ty³
) {

485 
NIC_TYPE_3C509B
:  "3C509B";

486 
NIC_TYPE_3C515_TX
:  "3C515-TX";

489 
	}
}

491 cÚ¡ * 
	$h¬dw¬e_nic_¡©us_to_¡ršg
(
ušt32_t
 
¡©us
) {

492 
¡©us_¡r
[128];

493 
¡©us_¡r
[0] = '\0';

495 ià(
¡©us
 & 
NIC_STATUS_PRESENT
è
	`¡rÿt
(
¡©us_¡r
, "PRESENT ");

496 ià(
¡©us
 & 
NIC_STATUS_INITIALIZED
è
	`¡rÿt
(
¡©us_¡r
, "INIT ");

497 ià(
¡©us
 & 
NIC_STATUS_ACTIVE
è
	`¡rÿt
(
¡©us_¡r
, "ACTIVE ");

498 ià(
¡©us
 & 
NIC_STATUS_LINK_UP
è
	`¡rÿt
(
¡©us_¡r
, "LINK_UP ");

499 ià(
¡©us
 & 
NIC_STATUS_ERROR
è
	`¡rÿt
(
¡©us_¡r
, "ERROR ");

501 ià(
¡©us_¡r
[0] == '\0') {

502 
	`¡rıy
(
¡©us_¡r
, "NONE");

505  
¡©us_¡r
;

506 
	}
}

509 
	$h¬dw¬e_£t_´omiscuous_mode
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË
) {

510 ià(!
nic
 || !nic->
İs
) {

511  
ERROR_INVALID_PARAM
;

514 ià(
nic
->
İs
->
£t_´omiscuous
) {

515  
nic
->
İs
->
	`£t_´omiscuous
Òic, 
’abË
);

518  
ERROR_NOT_SUPPORTED
;

519 
	}
}

521 
	$h¬dw¬e_£t_muÉiÿ¡_f‹r
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
mc_li¡
, 
couÁ
) {

522 ià(!
nic
 || !nic->
İs
) {

523  
ERROR_INVALID_PARAM
;

526 ià(
nic
->
İs
->
£t_muÉiÿ¡
) {

527  
nic
->
İs
->
	`£t_muÉiÿ¡
Òic, 
mc_li¡
, 
couÁ
);

530  
ERROR_NOT_SUPPORTED
;

531 
	}
}

534 
	$h¬dw¬e_»£t_¡©s
() {

535 
	`memÜy_z”o
(&
g_h¬dw¬e_¡©s
, (
h¬dw¬e_¡©s_t
));

536 
	}
}

538 
boŞ
 
	$h¬dw¬e_v®id©e_nic_šdex
(
šdex
) {

539  (
šdex
 >ğ0 && index < 
g_num_nics
 && index < 
MAX_NICS
);

540 
	}
}

542 
	$h¬dw¬e_upd©e_·ck‘_¡©s
(
boŞ
 
£Á
, boŞ 
sucûss
) {

543 ià(
£Á
) {

544 
g_h¬dw¬e_¡©s
.
·ck‘s_£Á
++;

545 ià(!
sucûss
) {

546 
g_h¬dw¬e_¡©s
.
£nd_”rÜs
++;

549 
g_h¬dw¬e_¡©s
.
·ck‘s_»ûived
++;

550 ià(!
sucûss
) {

551 
g_h¬dw¬e_¡©s
.
»ûive_”rÜs
++;

554 
	}
}

559 
	$nic_3c509b_š™
(
nic_šfo
 *
nic
) {

560 ià(!
nic
è 
ERROR_INVALID_PARAM
;

562 
	`LOG_DEBUG
("In™Ÿlizšg 3C509B‡ˆI/O 0x%X", 
nic
->
io_ba£
);

565 
	`_3C509B_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C509B_WINDOW_0
);

566 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_TOTAL_RESET
);

567 
	`nic_d–ay_mli£cÚds
(100);

570 
»suÉ
 = 
	`nic_»ad_mac_add»ss_3c509b
(
nic
->
io_ba£
,‚ic->
mac
);

571 ià(
»suÉ
 !ğ
SUCCESS
) {

572 
	`LOG_ERROR
("Failedo„ead MAC‡ddress from 3C509B");

573  
»suÉ
;

577 
	`memıy
(
nic
->
³rm_mac
,‚ic->
mac
, 
ETH_ALEN
);

580 
nic
->
mtu
 = 
_3C509B_MAX_MTU
;

581 
nic
->
¥“d
 = 10;

582 
nic
->
fuÎ_du¶ex
 = 
çl£
;

583 
nic
->
ÿ·b™›s
 = 
HW_CAP_MULTICAST
 | 
HW_CAP_PROMISCUOUS
;

584 
nic
->
¡©us
 |ğ
NIC_STATUS_INITIALIZED
;

586 
	`LOG_INFO
("3C509B initialized‡t I/O 0x%X, MAC %02X:%02X:%02X:%02X:%02X:%02X",

587 
nic
->
io_ba£
,‚ic->
mac
[0],‚ic->mac[1],‚ic->mac[2],

588 
nic
->
mac
[3],‚ic->mac[4],‚ic->mac[5]);

590  
SUCCESS
;

591 
	}
}

593 
	$nic_3c509b_»£t
(
nic_šfo
 *
nic
) {

594 ià(!
nic
è 
ERROR_INVALID_PARAM
;

596 
	`LOG_DEBUG
("Re£‰šg 3C509B‡ˆI/O 0x%X", 
nic
->
io_ba£
);

599 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_TOTAL_RESET
);

600 
	`nic_d–ay_mli£cÚds
(100);

603 
timeout
 = 1000;

604 
timeout
-- > 0) {

605 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C509B_STATUS_REG
);

606 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

609 
	`nic_d–ay_mli£cÚds
(1);

612 ià(
timeout
 <= 0) {

613 
	`LOG_ERROR
("3C509B„esetimeout");

614  
ERROR_TIMEOUT
;

617  
SUCCESS
;

618 
	}
}

620 
	$nic_3c509b_’abË_š‹¼u±s
(
nic_šfo
 *
nic
) {

621 ià(!
nic
è 
ERROR_INVALID_PARAM
;

623 
	`_3C509B_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C509B_WINDOW_1
);

624 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
,

625 
_3C509B_CMD_SET_INTR_ENB
 | 
_3C509B_IMASK_ALL
);

627  
SUCCESS
;

628 
	}
}

630 
	$nic_3c509b_di§bË_š‹¼u±s
(
nic_šfo
 *
nic
) {

631 ià(!
nic
è 
ERROR_INVALID_PARAM
;

633 
	`_3C509B_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C509B_WINDOW_1
);

634 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_SET_INTR_ENB
 | 0);

636  
SUCCESS
;

637 
	}
}

640 
	$nic_3c515_š™
(
nic_šfo
 *
nic
) {

641 ià(!
nic
è 
ERROR_INVALID_PARAM
;

643 
	`LOG_DEBUG
("In™Ÿlizšg 3C515-TX‡ˆI/O 0x%X", 
nic
->
io_ba£
);

646 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_0
);

647 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TOTAL_RESET
);

648 
	`nic_d–ay_mli£cÚds
(100);

651 
»suÉ
 = 
	`nic_»ad_mac_add»ss_3c515
(
nic
->
io_ba£
,‚ic->
mac
);

652 ià(
»suÉ
 !ğ
SUCCESS
) {

653 
	`LOG_ERROR
("Failedo„ead MAC‡ddress from 3C515-TX");

654  
»suÉ
;

658 
	`memıy
(
nic
->
³rm_mac
,‚ic->
mac
, 
ETH_ALEN
);

661 
nic
->
mtu
 = 
_3C515_TX_MAX_MTU
;

662 
nic
->
¥“d
 = 100;

663 
nic
->
fuÎ_du¶ex
 = 
çl£
;

664 
nic
->
ÿ·b™›s
 = 
HW_CAP_DMA
 | 
HW_CAP_BUS_MASTER
 | 
HW_CAP_MULTICAST
 |

665 
HW_CAP_PROMISCUOUS
 | 
HW_CAP_FULL_DUPLEX
 | 
HW_CAP_AUTO_SPEED
;

666 
nic
->
¡©us
 |ğ
NIC_STATUS_INITIALIZED
;

668 
	`LOG_INFO
("3C515-TX initialized‡t I/O 0x%X, MAC %02X:%02X:%02X:%02X:%02X:%02X",

669 
nic
->
io_ba£
,‚ic->
mac
[0],‚ic->mac[1],‚ic->mac[2],

670 
nic
->
mac
[3],‚ic->mac[4],‚ic->mac[5]);

672  
SUCCESS
;

673 
	}
}

675 
	$nic_3c515_»£t
(
nic_šfo
 *
nic
) {

676 ià(!
nic
è 
ERROR_INVALID_PARAM
;

678 
	`LOG_DEBUG
("Re£‰šg 3C515-TX‡ˆI/O 0x%X", 
nic
->
io_ba£
);

681 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TOTAL_RESET
);

682 
	`nic_d–ay_mli£cÚds
(100);

685 
timeout
 = 1000;

686 
timeout
-- > 0) {

687 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

688 ià(!(
¡©us
 & 
_3C515_TX_STATUS_CMD_IN_PROGRESS
)) {

691 
	`nic_d–ay_mli£cÚds
(1);

694 ià(
timeout
 <= 0) {

695 
	`LOG_ERROR
("3C515-TX„esetimeout");

696  
ERROR_TIMEOUT
;

699  
SUCCESS
;

700 
	}
}

702 
	$nic_3c515_’abË_š‹¼u±s
(
nic_šfo
 *
nic
) {

703 ià(!
nic
è 
ERROR_INVALID_PARAM
;

705 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_1
);

706 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
,

707 
_3C515_TX_CMD_SET_INTR_ENB
 | (
_3C515_TX_IMASK_ADAPTER_FAILURE
 |

708 
_3C515_TX_IMASK_TX_COMPLETE
 |

709 
_3C515_TX_IMASK_RX_COMPLETE
 |

710 
_3C515_TX_IMASK_UP_COMPLETE
 |

711 
_3C515_TX_IMASK_DOWN_COMPLETE
));

713  
SUCCESS
;

714 
	}
}

716 
	$nic_3c515_di§bË_š‹¼u±s
(
nic_šfo
 *
nic
) {

717 ià(!
nic
è 
ERROR_INVALID_PARAM
;

719 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_1
);

720 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_SET_INTR_ENB
 | 0);

722  
SUCCESS
;

723 
	}
}

726 
_3c509b_š™
(
nic_šfo_t
 *
nic
);

727 
_3c509b_ş—nup
(
nic_šfo_t
 *
nic
);

728 
_3c509b_»£t
(
nic_šfo_t
 *
nic
);

729 
_3c509b_£nd_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
);

730 
_3c509b_»ûive_·ck‘
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ëngth
);

731 
boŞ
 
_3c509b_check_š‹¼u±
(
nic_šfo_t
 *
nic
);

732 
_3c509b_hªdË_š‹¼u±
(
nic_šfo_t
 *
nic
);

733 
_3c509b_£lf_‹¡
(
nic_šfo_t
 *
nic
);

734 
_3c509b_’abË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

735 
_3c509b_di§bË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

738 
_3c515_š™
(
nic_šfo_t
 *
nic
);

739 
_3c515_ş—nup
(
nic_šfo_t
 *
nic
);

740 
_3c515_»£t
(
nic_šfo_t
 *
nic
);

741 
_3c515_£nd_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
);

742 
_3c515_»ûive_·ck‘
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ëngth
);

743 
boŞ
 
_3c515_check_š‹¼u±
(
nic_šfo_t
 *
nic
);

744 
_3c515_hªdË_š‹¼u±
(
nic_šfo_t
 *
nic
);

745 
_3c515_£lf_‹¡
(
nic_šfo_t
 *
nic
);

746 
_3c515_’abË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

747 
_3c515_di§bË_š‹¼u±s
(
nic_šfo_t
 *
nic
);

750 
	$š™_3c509b_İs
() {

751 
g_3c509b_İs
.
š™
 = 
_3c509b_š™
;

752 
g_3c509b_İs
.
ş—nup
 = 
_3c509b_ş—nup
;

753 
g_3c509b_İs
.
»£t
 = 
_3c509b_»£t
;

754 
g_3c509b_İs
.
£lf_‹¡
 = 
_3c509b_£lf_‹¡
;

755 
g_3c509b_İs
.
£nd_·ck‘
 = 
_3c509b_£nd_·ck‘
;

756 
g_3c509b_İs
.
»ûive_·ck‘
 = 
_3c509b_»ûive_·ck‘
;

757 
g_3c509b_İs
.
check_tx_com¶‘e
 = 
_3c509b_check_tx_com¶‘e
;

758 
g_3c509b_İs
.
check_rx_avaabË
 = 
_3c509b_check_rx_avaabË
;

759 
g_3c509b_İs
.
hªdË_š‹¼u±
 = 
_3c509b_hªdË_š‹¼u±
;

760 
g_3c509b_İs
.
check_š‹¼u±
 = 
_3c509b_check_š‹¼u±
;

761 
g_3c509b_İs
.
’abË_š‹¼u±s
 = 
_3c509b_’abË_š‹¼u±s
;

762 
g_3c509b_İs
.
di§bË_š‹¼u±s
 = 
_3c509b_di§bË_š‹¼u±s
;

764 
	}
}

766 
	$š™_3c515_İs
() {

767 
g_3c515_İs
.
š™
 = 
_3c515_š™
;

768 
g_3c515_İs
.
ş—nup
 = 
_3c515_ş—nup
;

769 
g_3c515_İs
.
»£t
 = 
_3c515_»£t
;

770 
g_3c515_İs
.
£lf_‹¡
 = 
_3c515_£lf_‹¡
;

771 
g_3c515_İs
.
£nd_·ck‘
 = 
_3c515_£nd_·ck‘
;

772 
g_3c515_İs
.
»ûive_·ck‘
 = 
_3c515_»ûive_·ck‘
;

773 
g_3c515_İs
.
check_tx_com¶‘e
 = 
_3c515_check_tx_com¶‘e
;

774 
g_3c515_İs
.
check_rx_avaabË
 = 
_3c515_check_rx_avaabË
;

775 
g_3c515_İs
.
hªdË_š‹¼u±
 = 
_3c515_hªdË_š‹¼u±
;

776 
g_3c515_İs
.
check_š‹¼u±
 = 
_3c515_check_š‹¼u±
;

777 
g_3c515_İs
.
’abË_š‹¼u±s
 = 
_3c515_’abË_š‹¼u±s
;

778 
g_3c515_İs
.
di§bË_š‹¼u±s
 = 
_3c515_di§bË_š‹¼u±s
;

780 
	}
}

783 
	$h¬dw¬e_add_nic
(
nic_šfo_t
 *
nic
) {

784 ià(!
nic
 || 
g_num_nics
 >ğ
MAX_NICS
) {

785  
ERROR_INVALID_PARAM
;

789 
	`memıy
(&
g_nic_šfos
[
g_num_nics
], 
nic
, (
nic_šfo_t
));

790 
g_nic_šfos
[
g_num_nics
].
šdex
 = g_num_nics;

792 
g_num_nics
++;

794 
	`LOG_DEBUG
("Added NIC %dØh¬dw¬Ïy”", 
g_num_nics
 - 1);

796  
SUCCESS
;

797 
	}
}

799 
	$h¬dw¬e_»move_nic
(
šdex
) {

800 ià(
šdex
 < 0 || index >ğ
g_num_nics
) {

801  
ERROR_INVALID_PARAM
;

805 
nic_šfo_t
 *
nic
 = &
g_nic_šfos
[
šdex
];

806 ià(
nic
->
İs
 &&‚ic->İs->
ş—nup
) {

807 
nic
->
İs
->
	`ş—nup
(nic);

811 
i
 = 
šdex
; i < 
g_num_nics
 - 1; i++) {

812 
	`memıy
(&
g_nic_šfos
[
i
], &g_nic_šfos[˜+ 1], (
nic_šfo_t
));

813 
g_nic_šfos
[
i
].
šdex
 = i;

816 
g_num_nics
--;

818 
	`LOG_DEBUG
("Removed NIC %d from h¬dw¬Ïy”", 
šdex
);

820  
SUCCESS
;

821 
	}
}

828 
	$h¬dw¬e_d‘eù_çu»
(
nic_šfo_t
 *
nic
) {

829 
ušt32_t
 
cu¼’t_time
;

830 
ušt32_t
 
”rÜ_¿‹
;

832 ià(!
nic
) {

833  
HW_FAILURE_CRITICAL
;

836 
cu¼’t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

839 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_PRESENT
)) {

840  
HW_FAILURE_CRITICAL
;

844 ià(
nic
->
İs
 &&‚ic->İs->
g‘_lšk_¡©us
) {

845 
boŞ
 
lšk_up
 = 
nic
->
İs
->
	`g‘_lšk_¡©us
(nic);

846 ià(!
lšk_up
 && 
nic
->link_up) {

848 
nic
->
lšk_up
 = 
çl£
;

849  
HW_FAILURE_LINK_LOST
;

851 
nic
->
lšk_up
 =†ink_up;

855 ià(
nic
->
tx_·ck‘s
 > 100) {

856 
”rÜ_¿‹
 = (
nic
->
tx_”rÜs
 * 100è/‚ic->
tx_·ck‘s
;

857 ià(
”rÜ_¿‹
 > 
MAX_ERROR_RATE_PERCENT
) {

858  
HW_FAILURE_TX_TIMEOUT
;

862 ià(
nic
->
rx_·ck‘s
 > 100) {

863 
”rÜ_¿‹
 = (
nic
->
rx_”rÜs
 * 100è/‚ic->
rx_·ck‘s
;

864 ià(
”rÜ_¿‹
 > 
MAX_ERROR_RATE_PERCENT
) {

865  
HW_FAILURE_RX_TIMEOUT
;

870 ià(
nic
->
š‹¼u±s
 > 0) {

871 
ušt32_t
 
time_diff
 = 
cu¼’t_time
 - 
g_”rÜ_»cov”y_¡©e
.
Ï¡_”rÜ_time
[
nic
->
šdex
];

872 ià(
time_diff
 < 100 && 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] > 10) {

873  
HW_FAILURE_INTERRUPT_STORM
;

878 ià(
nic
->
İs
 &&‚ic->İs->
£lf_‹¡
) {

879 
‹¡_»suÉ
 = 
nic
->
İs
->
	`£lf_‹¡
(nic);

880 ià(
‹¡_»suÉ
 !ğ
SUCCESS
) {

881  
HW_FAILURE_REGISTER_CORRUPTION
;

885  
HW_FAILURE_NONE
;

886 
	}
}

894 
	$h¬dw¬e_»cov”_nic
(
nic_šfo_t
 *
nic
, 
çu»_ty³
) {

895 
»suÉ
;

896 
ušt32_t
 
timeout
;

897 
»cov”y_¡¿‹gy
;

899 ià(!
nic
) {

900  
ERROR_INVALID_PARAM
;

903 
	`LOG_INFO
("A‰em±šg„ecov”y oàNIC %d from fau»y³ %d", 
nic
->
šdex
, 
çu»_ty³
);

906 
g_”rÜ_»cov”y_¡©e
.
”rÜ_couÁs
[
nic
->
šdex
][
çu»_ty³
]++;

907 
g_”rÜ_»cov”y_¡©e
.
»cov”y_©‹m±s
[
nic
->
šdex
]++;

908 
g_”rÜ_»cov”y_¡©e
.
Ï¡_»cov”y_time
[
nic
->
šdex
] = 
	`g‘_sy¡em_time¡amp_ms
();

911 
çu»_ty³
) {

912 
HW_FAILURE_LINK_LOST
:

913 
»cov”y_¡¿‹gy
 = 
RECOVERY_SOFT_RESET
;

914 
timeout
 = 2000;

917 
HW_FAILURE_TX_TIMEOUT
:

918 
HW_FAILURE_RX_TIMEOUT
:

919 
»cov”y_¡¿‹gy
 = 
RECOVERY_SOFT_RESET
;

920 
timeout
 = 1000;

923 
HW_FAILURE_FIFO_OVERRUN
:

924 
»cov”y_¡¿‹gy
 = 
RECOVERY_REINITIALIZE
;

925 
timeout
 = 3000;

928 
HW_FAILURE_DMA_ERROR
:

929 
»cov”y_¡¿‹gy
 = 
RECOVERY_HARD_RESET
;

930 
timeout
 = 5000;

933 
HW_FAILURE_REGISTER_CORRUPTION
:

934 
»cov”y_¡¿‹gy
 = 
RECOVERY_HARD_RESET
;

935 
timeout
 = 5000;

938 
HW_FAILURE_INTERRUPT_STORM
:

939 
»cov”y_¡¿‹gy
 = 
RECOVERY_SOFT_RESET
;

940 
timeout
 = 1000;

943 
HW_FAILURE_CRITICAL
:

944 
HW_FAILURE_THERMAL
:

945 
HW_FAILURE_POWER
:

947 
»cov”y_¡¿‹gy
 = 
RECOVERY_DISABLE
;

948 
timeout
 = 0;

952 
»cov”y_¡¿‹gy
 = 
RECOVERY_SOFT_RESET
;

953 
timeout
 = 2000;

958 
»cov”y_¡¿‹gy
) {

959 
RECOVERY_SOFT_RESET
:

961 ià(
nic
->
İs
 &&‚ic->İs->
di§bË_š‹¼u±s
) {

962 
nic
->
İs
->
	`di§bË_š‹¼u±s
(nic);

966 
	`md–ay
(100);

969 ià(
nic
->
İs
 &&‚ic->İs->
’abË_š‹¼u±s
) {

970 
»suÉ
 = 
nic
->
İs
->
	`’abË_š‹¼u±s
(nic);

971 ià(
»suÉ
 !ğ
SUCCESS
) {

972 
	`LOG_ERROR
("FaedØ»-’abË iÁ”ru± Ú NIC %d", 
nic
->
šdex
);

973  
»suÉ
;

978 
RECOVERY_HARD_RESET
:

980 ià(
nic
->
İs
 &&‚ic->İs->
»£t
) {

981 
»suÉ
 = 
nic
->
İs
->
	`»£t
(nic);

982 ià(
»suÉ
 !ğ
SUCCESS
) {

983 
	`LOG_ERROR
("H¬d„e£ˆçed oÀNIC %d", 
nic
->
šdex
);

984  
»suÉ
;

988 
	`md–ay
(100);

992 
RECOVERY_REINITIALIZE
:

994 ià(
nic
->
İs
 &&‚ic->İs->
ş—nup
) {

995 
nic
->
İs
->
	`ş—nup
(nic);

998 ià(
nic
->
İs
 &&‚ic->İs->
š™
) {

999 
»suÉ
 = 
nic
->
İs
->
	`š™
(nic);

1000 ià(
»suÉ
 !ğ
SUCCESS
) {

1001 
	`LOG_ERROR
("Re-š™Ÿliz©iÚ faed oÀNIC %d", 
nic
->
šdex
);

1002  
»suÉ
;

1007 
RECOVERY_DISABLE
:

1009 
	`LOG_ERROR
("Di§blšg NIC %d dutØü™iÿÈçu»", 
nic
->
šdex
);

1010 
	`h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic
);

1011  
ERROR_HARDWARE
;

1014 
	`LOG_ERROR
("UnknowÀ»cov”y sŒ©egy %d", 
»cov”y_¡¿‹gy
);

1015  
ERROR_NOT_SUPPORTED
;

1019 
»suÉ
 = 
	`h¬dw¬e_v®id©e_»cov”y
(
nic
);

1020 ià(
»suÉ
 !ğ
SUCCESS
) {

1021 
	`LOG_ERROR
("Recov”y v®id©iÚ faed fÜ NIC %d", 
nic
->
šdex
);

1022  
»suÉ
;

1026 
g_”rÜ_»cov”y_¡©e
.
sucûssful_»cov”›s
++;

1028 
	`LOG_INFO
("SucûssfuÎy„ecov”ed NIC %d from fau»y³ %d", 
nic
->
šdex
, 
çu»_ty³
);

1030  
SUCCESS
;

1031 
	}
}

1038 
	$h¬dw¬e_©‹m±_çov”
(
çed_nic_šdex
) {

1039 
backup_nic_šdex
 = -1;

1040 
nic_šfo_t
 *
çed_nic
, *
backup_nic
;

1042 ià(
çed_nic_šdex
 < 0 || faed_nic_šdex >ğ
g_num_nics
) {

1043  
ERROR_INVALID_PARAM
;

1046 ià(
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
) {

1047 
	`LOG_WARNING
("Failover‡lready in…rogress,„ejecting‚ew failover„equest");

1048  
ERROR_BUSY
;

1051 
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
 = 
Œue
;

1052 
çed_nic
 = &
g_nic_šfos
[
çed_nic_šdex
];

1054 
	`LOG_WARNING
("In™Ÿtšg faov” from faed NIC %d", 
çed_nic_šdex
);

1057 
i
 = 0; i < 
g_num_nics
; i++) {

1058 ià(
i
 =ğ
çed_nic_šdex
) ;

1060 
nic_šfo_t
 *
ÿndid©e
 = &
g_nic_šfos
[
i
];

1061 ià((
ÿndid©e
->
¡©us
 & 
NIC_STATUS_ACTIVE
) &&

1062 (
ÿndid©e
->
¡©us
 & 
NIC_STATUS_LINK_UP
) &&

1063 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
i
] == 0) {

1065 
backup_nic_šdex
 = 
i
;

1070 ià(
backup_nic_šdex
 == -1) {

1071 
	`LOG_ERROR
("No suitable backup NIC found for failover");

1072 
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
 = 
çl£
;

1075 
	`h¬dw¬e_nÙify_­¶iÿtiÚ_”rÜ
(
çed_nic_šdex
, 
HW_FAILURE_CRITICAL
);

1076  
ERROR_NOT_FOUND
;

1079 
backup_nic
 = &
g_nic_šfos
[
backup_nic_šdex
];

1081 
	`LOG_INFO
("Fašg ov” from NIC %dØNIC %d", 
çed_nic_šdex
, 
backup_nic_šdex
);

1084 
g_”rÜ_»cov”y_¡©e
.
´im¬y_nic
 = 
backup_nic_šdex
;

1085 
g_”rÜ_»cov”y_¡©e
.
backup_nic
 = 
çed_nic_šdex
;

1088 
çed_nic
->
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

1089 
çed_nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

1092 ià(
backup_nic
->
İs
 && backup_nic->İs->
£lf_‹¡
) {

1093 
»suÉ
 = 
backup_nic
->
İs
->
	`£lf_‹¡
(backup_nic);

1094 ià(
»suÉ
 !ğ
SUCCESS
) {

1095 
	`LOG_ERROR
("Backu°NIC %d faed s–f-‹¡ duršg faov”", 
backup_nic_šdex
);

1096 
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
 = 
çl£
;

1097  
ERROR_HARDWARE
;

1102 
	`h¬dw¬e_nÙify_­¶iÿtiÚ_”rÜ
(
çed_nic_šdex
, 
HW_FAILURE_NONE
);

1104 
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
 = 
çl£
;

1106 
	`LOG_INFO
("Faov” com¶‘ed sucûssfuÎyØNIC %d", 
backup_nic_šdex
);

1108  
SUCCESS
;

1109 
	}
}

1115 
	$h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic_šfo_t
 *
nic
) {

1116 ià(!
nic
) ;

1118 
	`LOG_WARNING
("In™Ÿtšg g¿ûfuÈdeg¿d©iÚ fÜ NIC %d", 
nic
->
šdex
);

1121 ià(
nic
->
İs
 &&‚ic->İs->
di§bË_š‹¼u±s
) {

1122 
nic
->
İs
->
	`di§bË_š‹¼u±s
(nic);

1126 
nic
->
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

1127 
nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

1130 ià(
nic
->
İs
 &&‚ic->İs->
»£t
) {

1131 
nic
->
İs
->
	`»£t
(nic);

1134 
	`LOG_INFO
("G¿ûfuÈdeg¿d©iÚ com¶‘ed fÜ NIC %d", 
nic
->
šdex
);

1135 
	}
}

1142 
	$h¬dw¬e_v®id©e_»cov”y
(
nic_šfo_t
 *
nic
) {

1143 ià(!
nic
) {

1144  
ERROR_INVALID_PARAM
;

1148 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_PRESENT
)) {

1149  
ERROR_HARDWARE
;

1153 ià(
nic
->
İs
 &&‚ic->İs->
£lf_‹¡
) {

1154 
»suÉ
 = 
nic
->
İs
->
	`£lf_‹¡
(nic);

1155 ià(
»suÉ
 !ğ
SUCCESS
) {

1156  
»suÉ
;

1161 ià(
nic
->
İs
 &&‚ic->İs->
g‘_lšk_¡©us
) {

1162 
boŞ
 
lšk_up
 = 
nic
->
İs
->
	`g‘_lšk_¡©us
(nic);

1163 
nic
->
lšk_up
 =†ink_up;

1167 
nic
->
¡©us
 |ğ
NIC_STATUS_ACTIVE
;

1168 
nic
->
¡©us
 &ğ~
NIC_STATUS_ERROR
;

1170  
SUCCESS
;

1171 
	}
}

1179 
	$h¬dw¬e_log_çu»
(
nic_šfo_t
 *
nic
, 
çu»_ty³
, cÚ¡ * 
d‘as
) {

1180 cÚ¡ * 
çu»_Çmes
[] = {

1186 cÚ¡ * 
çu»_Çme
 = (
çu»_ty³
 >ğ0 && fau»_ty³ <ğ
HW_FAILURE_CRITICAL
) ?

1187 
çu»_Çmes
[
çu»_ty³
] : "Unknown";

1189 
	`LOG_ERROR
("Hardware Failure - NIC %d: %s (%d) - %s",

1190 
nic
 ?‚ic->
šdex
 : -1, 
çu»_Çme
, 
çu»_ty³
, 
d‘as
 ? details : "No details");

1193 
g_”rÜ_»cov”y_¡©e
.
tÙ®_çu»s
++;

1195 ià(
nic
) {

1196 
nic
->
”rÜ_couÁ
++;

1197 
nic
->
Ï¡_”rÜ
 = 
çu»_ty³
;

1199 
	}
}

1206 
boŞ
 
	$h¬dw¬e_is_ü™iÿl_çu»
(
çu»_ty³
) {

1207 
çu»_ty³
) {

1208 
HW_FAILURE_CRITICAL
:

1209 
HW_FAILURE_THERMAL
:

1210 
HW_FAILURE_POWER
:

1211 
HW_FAILURE_MEMORY_ERROR
:

1212  
Œue
;

1214  
çl£
;

1216 
	}
}

1223 
	$h¬dw¬e_nÙify_­¶iÿtiÚ_”rÜ
(
nic_šdex
, 
”rÜ_ty³
) {

1226 
	`LOG_INFO
("NÙifyšg‡µliÿtiÚ: NIC %dƒ¼Üy³ %d", 
nic_šdex
, 
”rÜ_ty³
);

1229 
	}
}

1236 
ušt32_t
 
	$h¬dw¬e_ÿlcuÏ‹_»cov”y_timeout
(
çu»_ty³
) {

1237 
çu»_ty³
) {

1238 
HW_FAILURE_LINK_LOST
:

1240 
HW_FAILURE_TX_TIMEOUT
:

1241 
HW_FAILURE_RX_TIMEOUT
:

1243 
HW_FAILURE_FIFO_OVERRUN
:

1245 
HW_FAILURE_DMA_ERROR
:

1247 
HW_FAILURE_REGISTER_CORRUPTION
:

1252 
	}
}

1259 
	$h¬dw¬e_em”g’cy_»£t
(
nic_šfo_t
 *
nic
) {

1260 ià(!
nic
) {

1261  
ERROR_INVALID_PARAM
;

1264 
	`LOG_WARNING
("P”fÜmšgƒm”g’cy„e£ˆÚ NIC %d", 
nic
->
šdex
);

1267 ià(
nic
->
İs
 &&‚ic->İs->
di§bË_š‹¼u±s
) {

1268 
nic
->
İs
->
	`di§bË_š‹¼u±s
(nic);

1272 ià(
nic
->
İs
 &&‚ic->İs->
»£t
) {

1273 
»suÉ
 = 
nic
->
İs
->
	`»£t
(nic);

1274 ià(
»suÉ
 !ğ
SUCCESS
) {

1275 
	`LOG_ERROR
("Em”g’cy„e£ˆçed oÀNIC %d", 
nic
->
šdex
);

1276  
»suÉ
;

1281 
	`md–ay
(500);

1284 ià(
nic
->
İs
 &&‚ic->İs->
š™
) {

1285 
»suÉ
 = 
nic
->
İs
->
	`š™
(nic);

1286 ià(
»suÉ
 !ğ
SUCCESS
) {

1287 
	`LOG_ERROR
("Po¡-em”g’cy in™Ÿliz©iÚ faed oÀNIC %d", 
nic
->
šdex
);

1288  
»suÉ
;

1292 
	`LOG_INFO
("Em”g’cy„e£ˆcom¶‘ed oÀNIC %d", 
nic
->
šdex
);

1293  
SUCCESS
;

1294 
	}
}

1303 
	$h¬dw¬e_£nd_·ck‘_w™h_»cov”y
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

1304 
»suÉ
;

1305 
»Œy_couÁ
 = 0;

1306 cÚ¡ 
max_»Œ›s
 = 3;

1307 
ušt32_t
 
¡¬t_time
;

1309 ià(!
nic
 || !
·ck‘
 || 
Ëngth
 == 0) {

1310 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

1311  
ERROR_INVALID_PARAM
;

1314 ià(!
nic
->
İs
 || !nic->İs->
£nd_·ck‘
) {

1315 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

1316  
ERROR_NOT_SUPPORTED
;

1319 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

1321 
»Œy_couÁ
 <ğ
max_»Œ›s
) {

1323 
çu»_ty³
 = 
	`h¬dw¬e_d‘eù_çu»
(
nic
);

1324 ià(
çu»_ty³
 !ğ
HW_FAILURE_NONE
) {

1325 
	`LOG_WARNING
("NIC %d fau» d‘eùed (ty³ %dèbefÜ£nd‡‰em±", 
nic
->
šdex
, 
çu»_ty³
);

1328 
»suÉ
 = 
	`h¬dw¬e_»cov”_nic
(
nic
, 
çu»_ty³
);

1329 ià(
»suÉ
 !ğ
SUCCESS
) {

1330 
	`LOG_ERROR
("NIC %d„ecov”y faed,‡‰em±šg faov”", 
nic
->
šdex
);

1331  
	`h¬dw¬e_©‹m±_çov”
(
nic
->
šdex
);

1336 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1337 
	`LOG_ERROR
("NIC %d‚Ù‡ùivfÜ…ack‘¿nsmissiÚ", 
nic
->
šdex
);

1338 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

1339  
ERROR_BUSY
;

1343 
»suÉ
 = 
nic
->
İs
->
	`£nd_·ck‘
Òic, 
·ck‘
, 
Ëngth
);

1345 ià(
»suÉ
 =ğ
SUCCESS
) {

1347 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
,rue);

1350 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] = 0;

1352  
SUCCESS
;

1356 
	`LOG_WARNING
("Packetransmission failed on NIC %d (attempt %d/%d): %d",

1357 
nic
->
šdex
, 
»Œy_couÁ
 + 1, 
max_»Œ›s
 + 1, 
»suÉ
);

1360 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
]++;

1361 
g_”rÜ_»cov”y_¡©e
.
Ï¡_”rÜ_time
[
nic
->
šdex
] = 
	`g‘_sy¡em_time¡amp_ms
();

1364 ià(
»suÉ
 =ğ
ERROR_TIMEOUT
 ||„esuÉ =ğ
ERROR_IO
 ||„esuÉ =ğ
ERROR_HARDWARE
) {

1366 
d‘eùed_çu»
 = (
»suÉ
 =ğ
ERROR_TIMEOUT
è? 
HW_FAILURE_TX_TIMEOUT
 :

1367 (
»suÉ
 =ğ
ERROR_IO
è? 
HW_FAILURE_REGISTER_CORRUPTION
 :

1368 
HW_FAILURE_CRITICAL
;

1371 ià(
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] < 
MAX_CONSECUTIVE_ERRORS
) {

1372 
»suÉ
 = 
	`h¬dw¬e_»cov”_nic
(
nic
, 
d‘eùed_çu»
);

1373 ià(
»suÉ
 =ğ
SUCCESS
) {

1381 ià(
	`h¬dw¬e_is_ü™iÿl_çu»
(
»suÉ
) ||

1382 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] >ğ
MAX_CONSECUTIVE_ERRORS
) {

1384 
	`LOG_ERROR
("Cr™iÿÈçu» oÀNIC %d, in™Ÿtšg faov”", 
nic
->
šdex
);

1385 
	`h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic
);

1386  
	`h¬dw¬e_©‹m±_çov”
(
nic
->
šdex
);

1389 
»Œy_couÁ
++;

1392 
	`md–ay
(10 * 
»Œy_couÁ
);

1395 ià(
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
 > 
TX_TIMEOUT_MS
) {

1396 
	`LOG_ERROR
("H¬dw¬£ndimeouˆexûeded fÜ NIC %d", 
nic
->
šdex
);

1402 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

1403 
	`h¬dw¬e_log_çu»
(
nic
, 
HW_FAILURE_TX_TIMEOUT
, "Packet send failed‡fter‡ll„etries");

1405  
»suÉ
;

1406 
	}
}

1415 
	$h¬dw¬e_»ûive_·ck‘_w™h_»cov”y
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
ušt16_t
 *
Ëngth
) {

1416 
»suÉ
;

1417 
»Œy_couÁ
 = 0;

1418 cÚ¡ 
max_»Œ›s
 = 2;

1419 
ušt32_t
 
¡¬t_time
;

1421 ià(!
nic
 || !
bufãr
 || !
Ëngth
) {

1422 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

1423  
ERROR_INVALID_PARAM
;

1426 ià(!
nic
->
İs
 || !nic->İs->
»ûive_·ck‘
) {

1427 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

1428  
ERROR_NOT_SUPPORTED
;

1431 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

1433 
»Œy_couÁ
 <ğ
max_»Œ›s
) {

1435 
çu»_ty³
 = 
	`h¬dw¬e_d‘eù_çu»
(
nic
);

1436 ià(
çu»_ty³
 !ğ
HW_FAILURE_NONE
) {

1437 
	`LOG_WARNING
("NIC %d fau» d‘eùed (ty³ %dèduršg„eûive", 
nic
->
šdex
, 
çu»_ty³
);

1440 ià(!
	`h¬dw¬e_is_ü™iÿl_çu»
(
çu»_ty³
)) {

1441 
»suÉ
 = 
	`h¬dw¬e_»cov”_nic
(
nic
, 
çu»_ty³
);

1442 ià(
»suÉ
 !ğ
SUCCESS
) {

1443 
	`LOG_ERROR
("NIC %d„ecov”y faed duršg„eûive", 
nic
->
šdex
);

1444 
	`h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic
);

1445  
ERROR_HARDWARE
;

1448 
	`h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic
);

1449  
ERROR_HARDWARE
;

1454 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1455 
	`LOG_ERROR
("NIC %d‚Ù‡ùivfÜ…ack‘„eû±iÚ", 
nic
->
šdex
);

1456 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

1457  
ERROR_BUSY
;

1461 
size_t
 
»cv_Ëngth
 = *
Ëngth
;

1462 
»suÉ
 = 
nic
->
İs
->
	`»ûive_·ck‘
Òic, 
bufãr
, &
»cv_Ëngth
);

1463 *
Ëngth
 = 
»cv_Ëngth
;

1465 ià(
»suÉ
 =ğ
SUCCESS
 ||„esuÉ =ğ
ERROR_NO_DATA
) {

1467 ià(
»suÉ
 =ğ
SUCCESS
) {

1468 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, 
Œue
);

1470 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] = 0;

1472  
»suÉ
;

1476 
	`LOG_WARNING
("Packet„eception failed on NIC %d (attempt %d/%d): %d",

1477 
nic
->
šdex
, 
»Œy_couÁ
 + 1, 
max_»Œ›s
 + 1, 
»suÉ
);

1480 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
]++;

1481 
g_”rÜ_»cov”y_¡©e
.
Ï¡_”rÜ_time
[
nic
->
šdex
] = 
	`g‘_sy¡em_time¡amp_ms
();

1484 ià(
»suÉ
 =ğ
ERROR_TIMEOUT
 ||„esuÉ =ğ
ERROR_IO
) {

1485 
d‘eùed_çu»
 = (
»suÉ
 =ğ
ERROR_TIMEOUT
è? 
HW_FAILURE_RX_TIMEOUT
 : 
HW_FAILURE_FIFO_OVERRUN
;

1488 ià(
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] < 
MAX_CONSECUTIVE_ERRORS
) {

1489 
»suÉ
 = 
	`h¬dw¬e_»cov”_nic
(
nic
, 
d‘eùed_çu»
);

1490 ià(
»suÉ
 =ğ
SUCCESS
) {

1498 ià(
	`h¬dw¬e_is_ü™iÿl_çu»
(
»suÉ
) ||

1499 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] >ğ
MAX_CONSECUTIVE_ERRORS
) {

1501 
	`LOG_ERROR
("Cr™iÿÈ»ûivçu» oÀNIC %d", 
nic
->
šdex
);

1502 
	`h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic
);

1503  
ERROR_HARDWARE
;

1506 
»Œy_couÁ
++;

1509 
	`md–ay
(5 * 
»Œy_couÁ
);

1512 ià(
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
 > 
RX_TIMEOUT_MS
) {

1513 
	`LOG_ERROR
("H¬dw¬»ûivtimeouˆexûeded fÜ NIC %d", 
nic
->
šdex
);

1519 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

1520 
	`h¬dw¬e_log_çu»
(
nic
, 
HW_FAILURE_RX_TIMEOUT
, "Packet„eceive failed‡fter‡ll„etries");

1522  
»suÉ
;

1523 
	}
}

1530 
	$h¬dw¬e_g‘_»cov”y_¡©s
(
h¬dw¬e_»cov”y_¡©s_t
 *
¡©s
) {

1531 ià(!
¡©s
) {

1532  
ERROR_INVALID_PARAM
;

1535 
	`mem£t
(
¡©s
, 0, (
h¬dw¬e_»cov”y_¡©s_t
));

1537 
¡©s
->
tÙ®_çu»s
 = 
g_”rÜ_»cov”y_¡©e
.total_failures;

1538 
¡©s
->
sucûssful_»cov”›s
 = 
g_”rÜ_»cov”y_¡©e
.successful_recoveries;

1539 
¡©s
->
çov”_aùive
 = 
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
;

1540 
¡©s
->
´im¬y_nic
 = 
g_”rÜ_»cov”y_¡©e
.primary_nic;

1541 
¡©s
->
backup_nic
 = 
g_”rÜ_»cov”y_¡©e
.backup_nic;

1544 
i
 = 0; i < 
g_num_nics
 && i < 
MAX_NICS
; i++) {

1545 
¡©s
->
nic_¡©s
[
i
].
cÚ£cutive_”rÜs
 = 
g_”rÜ_»cov”y_¡©e
.consecutive_errors[i];

1546 
¡©s
->
nic_¡©s
[
i
].
»cov”y_©‹m±s
 = 
g_”rÜ_»cov”y_¡©e
.recovery_attempts[i];

1547 
¡©s
->
nic_¡©s
[
i
].
Ï¡_”rÜ_time
 = 
g_”rÜ_»cov”y_¡©e
.last_error_time[i];

1548 
¡©s
->
nic_¡©s
[
i
].
Ï¡_»cov”y_time
 = 
g_”rÜ_»cov”y_¡©e
.last_recovery_time[i];

1551 
j
 = 0; j < 12; j++) {

1552 
¡©s
->
nic_¡©s
[
i
].
”rÜ_couÁs
[
j
] = 
g_”rÜ_»cov”y_¡©e
.error_counts[i][j];

1556  
SUCCESS
;

1557 
	}
}

1563 
	$h¬dw¬e_mÚ™Ü_h—Éh
() {

1564 
h—Éh_scÜe
 = 0;

1565 
aùive_nics
 = 0;

1567 ià(!
g_h¬dw¬e_š™Ÿlized
) {

1571 
i
 = 0; i < 
g_num_nics
; i++) {

1572 
nic_šfo_t
 *
nic
 = &
g_nic_šfos
[
i
];

1574 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_PRESENT
)) {

1579 
çu»_ty³
 = 
	`h¬dw¬e_d‘eù_çu»
(
nic
);

1580 ià(
çu»_ty³
 !ğ
HW_FAILURE_NONE
) {

1581 ià(
	`h¬dw¬e_is_ü™iÿl_çu»
(
çu»_ty³
)) {

1582 
	`LOG_ERROR
("Cr™iÿÈçu» d‘eùed oÀNIC %d:y³ %d", 
i
, 
çu»_ty³
);

1583 
h—Éh_scÜe
 -= 50;

1586 
	`h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic
);

1587 
	`h¬dw¬e_©‹m±_çov”
(
i
);

1589 
	`LOG_WARNING
("NÚ-ü™iÿÈçu» d‘eùed oÀNIC %d:y³ %d", 
i
, 
çu»_ty³
);

1590 
h—Éh_scÜe
 -= 10;

1593 ià(
	`h¬dw¬e_»cov”_nic
(
nic
, 
çu»_ty³
è=ğ
SUCCESS
) {

1594 
h—Éh_scÜe
 += 5;

1599 ià(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
) {

1600 
aùive_nics
++;

1603 ià(
nic
->
tx_·ck‘s
 > 0) {

1604 
ušt32_t
 
tx_”rÜ_¿‹
 = (
nic
->
tx_”rÜs
 * 100è/‚ic->
tx_·ck‘s
;

1605 ià(
tx_”rÜ_¿‹
 > 10) {

1606 
h—Éh_scÜe
 -= 15;

1607 } ià(
tx_”rÜ_¿‹
 > 5) {

1608 
h—Éh_scÜe
 -= 5;

1612 ià(
nic
->
rx_·ck‘s
 > 0) {

1613 
ušt32_t
 
rx_”rÜ_¿‹
 = (
nic
->
rx_”rÜs
 * 100è/‚ic->
rx_·ck‘s
;

1614 ià(
rx_”rÜ_¿‹
 > 10) {

1615 
h—Éh_scÜe
 -= 15;

1616 } ià(
rx_”rÜ_¿‹
 > 5) {

1617 
h—Éh_scÜe
 -= 5;

1622 ià(!
nic
->
lšk_up
) {

1623 
h—Éh_scÜe
 -= 20;

1628 ià(
aùive_nics
 == 0) {

1629 
	`LOG_ERROR
("No‡ctive NICs‡vailable - critical system failure");

1634 ià(
h—Éh_scÜe
 >= 0) {

1635 
	`LOG_DEBUG
("H¬dw¬h—Éh: EXCELLENT (scÜe: %d)", 
h—Éh_scÜe
);

1636 } ià(
h—Éh_scÜe
 >= -20) {

1637 
	`LOG_INFO
("H¬dw¬h—Éh: GOOD (scÜe: %d)", 
h—Éh_scÜe
);

1638 } ià(
h—Éh_scÜe
 >= -50) {

1639 
	`LOG_WARNING
("H¬dw¬h—Éh: FAIR (scÜe: %d)", 
h—Éh_scÜe
);

1641 
	`LOG_ERROR
("H¬dw¬h—Éh: POOR (scÜe: %d)", 
h—Éh_scÜe
);

1644  
h—Éh_scÜe
;

1645 
	}
}

1650 
	$h¬dw¬e_´št_»cov”y_¡©s
() {

1651 
	`LOG_INFO
("=== Hardware Recovery Statistics ===");

1652 
	`LOG_INFO
("TÙ® Fau»s: %lu", 
g_”rÜ_»cov”y_¡©e
.
tÙ®_çu»s
);

1653 
	`LOG_INFO
("SucûssfuÈRecov”›s: %lu", 
g_”rÜ_»cov”y_¡©e
.
sucûssful_»cov”›s
);

1654 
	`LOG_INFO
("Faov” Aùive: %s", 
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
 ? "YES" : "NO");

1656 ià(
g_”rÜ_»cov”y_¡©e
.
´im¬y_nic
 >= 0) {

1657 
	`LOG_INFO
("Prim¬y NIC: %d", 
g_”rÜ_»cov”y_¡©e
.
´im¬y_nic
);

1659 ià(
g_”rÜ_»cov”y_¡©e
.
backup_nic
 >= 0) {

1660 
	`LOG_INFO
("Backu°NIC: %d", 
g_”rÜ_»cov”y_¡©e
.
backup_nic
);

1663 
i
 = 0; i < 
g_num_nics
; i++) {

1664 ià(
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
i
] > 0 ||

1665 
g_”rÜ_»cov”y_¡©e
.
»cov”y_©‹m±s
[
i
] > 0) {

1667 
	`LOG_INFO
("NIC %d: Consecutive Errors=%lu, Recovery Attempts=%lu",

1668 
i
, 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[i],

1669 
g_”rÜ_»cov”y_¡©e
.
»cov”y_©‹m±s
[
i
]);

1673 
	`LOG_INFO
("=== End Recovery Statistics ===");

1674 
	}
}

1679 
	$h¬dw¬e_»£t_»cov”y_¡©s
() {

1680 
	`LOG_INFO
("Resetting hardware„ecovery statistics");

1681 
	`mem£t
(&
g_”rÜ_»cov”y_¡©e
, 0, (g_error_recovery_state));

1682 
g_”rÜ_»cov”y_¡©e
.
´im¬y_nic
 = -1;

1683 
g_”rÜ_»cov”y_¡©e
.
backup_nic
 = -1;

1684 
	}
}

1690 
boŞ
 
	$h¬dw¬e_is_çu»_»s›Á
() {

1691 
aùive_nics
 = 0;

1693 
i
 = 0; i < 
g_num_nics
; i++) {

1694 ià((
g_nic_šfos
[
i
].
¡©us
 & 
NIC_STATUS_ACTIVE
) &&

1695 (
g_nic_šfos
[
i
].
¡©us
 & 
NIC_STATUS_LINK_UP
)) {

1696 
aùive_nics
++;

1700  
aùive_nics
 >= 2;

1701 
	}
}

1713 
	$h¬dw¬e_‹¡_cÚcu¼’t_İ”©iÚs
(
ušt32_t
 
‹¡_du¿tiÚ_ms
) {

1714 
ušt8_t
 
‹¡_·ck‘
[] = {

1722 
ušt32_t
 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

1723 
ušt32_t
 
tx_couÁs
[
MAX_NICS
] = {0};

1724 
ušt32_t
 
rx_couÁs
[
MAX_NICS
] = {0};

1725 
ušt32_t
 
”rÜs
[
MAX_NICS
] = {0};

1726 
aùive_nics
 = 0;

1728 
	`LOG_INFO
("S¹šg cÚcu¼’ˆmuÉi-NIC o³¿tiÚ ‹¡ (du¿tiÚ: %lu ms)", 
‹¡_du¿tiÚ_ms
);

1731 
i
 = 0; i < 
g_num_nics
; i++) {

1732 ià(
	`h¬dw¬e_is_nic_aùive
(
i
)) {

1733 
aùive_nics
++;

1737 ià(
aùive_nics
 < 2) {

1738 
	`LOG_ERROR
("CÚcu¼’ˆ‹¡„equœe ©†—¡ 2‡ùivNIC (found %d)", 
aùive_nics
);

1739  
ERROR_INVALID_PARAM
;

1743 (
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
è< 
‹¡_du¿tiÚ_ms
) {

1744 
nic_idx
 = 0;‚ic_idx < 
g_num_nics
;‚ic_idx++) {

1745 ià(!
	`h¬dw¬e_is_nic_aùive
(
nic_idx
)) {

1749 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_idx
);

1750 ià(!
nic
) {

1755 ià((
tx_couÁs
[
nic_idx
] % 10) ==‚ic_idx % 10) {

1756 
tx_»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
‹¡_·ck‘
, (test_packet));

1757 ià(
tx_»suÉ
 =ğ
SUCCESS
) {

1758 
tx_couÁs
[
nic_idx
]++;

1760 
”rÜs
[
nic_idx
]++;

1765 
ušt8_t
 
rx_bufãr
[256];

1766 
ušt16_t
 
rx_Ëngth
 = (
rx_bufãr
);

1767 
rx_»suÉ
 = 
	`h¬dw¬e_»ûive_·ck‘
(
nic
, 
rx_bufãr
, &
rx_Ëngth
);

1768 ià(
rx_»suÉ
 =ğ
SUCCESS
) {

1769 
rx_couÁs
[
nic_idx
]++;

1770 } ià(
rx_»suÉ
 !ğ
ERROR_NO_DATA
) {

1771 
”rÜs
[
nic_idx
]++;

1775 vŞ©
i
 = 0; i < 100; i++);

1779 
i
 = 0; i < 
g_num_nics
; i++) {

1780 ià(
	`h¬dw¬e_is_nic_´e£Á
(
i
)) {

1781 
çu»
 = 
	`h¬dw¬e_d‘eù_çu»
(&
g_nic_šfos
[
i
]);

1782 ià(
çu»
 !ğ
HW_FAILURE_NONE
) {

1783 
	`LOG_WARNING
("Hardware failure detected on NIC %d during concurrentest:ype %d",

1784 
i
, 
çu»
);

1785 
”rÜs
[
i
]++;

1792 
	`LOG_INFO
("=== Concurrent Operations Test Results ===");

1793 
i
 = 0; i < 
g_num_nics
; i++) {

1794 ià(
	`h¬dw¬e_is_nic_´e£Á
(
i
)) {

1795 
	`LOG_INFO
("NIC %d: TX=%lu, RX=%lu, Errors=%lu",

1796 
i
, 
tx_couÁs
[i], 
rx_couÁs
[i], 
”rÜs
[i]);

1799 
ušt32_t
 
tÙ®_İs
 = 
tx_couÁs
[
i
] + 
rx_couÁs
[i];

1800 ià(
tÙ®_İs
 > 0) {

1801 
ušt32_t
 
”rÜ_¿‹
 = (
”rÜs
[
i
] * 100è/ 
tÙ®_İs
;

1802 ià(
”rÜ_¿‹
 > 5) {

1803 
	`LOG_WARNING
("Highƒ¼Ü„©Ú NIC %d: %lu%%", 
i
, 
”rÜ_¿‹
);

1809 
	`LOG_INFO
("Concurrent operationsest completed successfully");

1810  
SUCCESS
;

1811 
	}
}

1818 
	$h¬dw¬e_‹¡_lßd_b®ªcšg
(
ušt32_t
 
num_·ck‘s
) {

1819 
ušt8_t
 
‹¡_·ck‘
[] = {

1826 
ušt32_t
 
nic_·ck‘_couÁs
[
MAX_NICS
] = {0};

1827 
ušt32_t
 
nic_”rÜ_couÁs
[
MAX_NICS
] = {0};

1828 
aùive_nics
 = 0;

1829 
Ãxt_nic
 = 0;

1831 
	`LOG_INFO
("S¹šg†ßd b®ªcšge¡ w™h %lu…ack‘s", 
num_·ck‘s
);

1834 
i
 = 0; i < 
g_num_nics
; i++) {

1835 ià(
	`h¬dw¬e_is_nic_aùive
(
i
)) {

1836 
aùive_nics
++;

1840 ià(
aùive_nics
 < 2) {

1841 
	`LOG_ERROR
("Lßd b®ªcšge¡„equœe ©†—¡ 2‡ùivNIC (found %d)", 
aùive_nics
);

1842  
ERROR_INVALID_PARAM
;

1846 
ušt32_t
 
pkt
 = 0;…kˆ< 
num_·ck‘s
;…kt++) {

1848 
©‹m±s
 = 0;

1849 
©‹m±s
 < 
g_num_nics
) {

1850 ià(
	`h¬dw¬e_is_nic_aùive
(
Ãxt_nic
)) {

1853 
Ãxt_nic
 = (Ãxt_niø+ 1è% 
g_num_nics
;

1854 
©‹m±s
++;

1857 ià(
©‹m±s
 >ğ
g_num_nics
) {

1858 
	`LOG_ERROR
("No‡ctive NICs found during†oad balancingest");

1859  
ERROR_HARDWARE
;

1863 
‹¡_·ck‘
[Ñe¡_·ck‘è- 1] = (
ušt8_t
)(
pkt
 & 0xFF);

1866 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
Ãxt_nic
);

1867 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
‹¡_·ck‘
, (test_packet));

1869 ià(
»suÉ
 =ğ
SUCCESS
) {

1870 
nic_·ck‘_couÁs
[
Ãxt_nic
]++;

1872 
nic_”rÜ_couÁs
[
Ãxt_nic
]++;

1873 
	`LOG_DEBUG
("Pack‘ %lu faed oÀNIC %d: %d", 
pkt
, 
Ãxt_nic
, 
»suÉ
);

1877 
Ãxt_nic
 = (Ãxt_niø+ 1è% 
g_num_nics
;

1880 ià((
pkt
 % 100) == 0) {

1881 vŞ©
i
 = 0; i < 1000; i++);

1886 
	`LOG_INFO
("=== Load Balancing Test Results ===");

1887 
ušt32_t
 
tÙ®_£Á
 = 0;

1888 
ušt32_t
 
tÙ®_”rÜs
 = 0;

1889 
ušt32_t
 
mš_·ck‘s
 = 
UINT32_MAX
;

1890 
ušt32_t
 
max_·ck‘s
 = 0;

1892 
i
 = 0; i < 
g_num_nics
; i++) {

1893 ià(
	`h¬dw¬e_is_nic_´e£Á
(
i
)) {

1894 
	`LOG_INFO
("NIC %d: S’t=%lu, E¼Üs=%lu", 
i
, 
nic_·ck‘_couÁs
[i], 
nic_”rÜ_couÁs
[i]);

1896 
tÙ®_£Á
 +ğ
nic_·ck‘_couÁs
[
i
];

1897 
tÙ®_”rÜs
 +ğ
nic_”rÜ_couÁs
[
i
];

1899 ià(
	`h¬dw¬e_is_nic_aùive
(
i
)) {

1900 ià(
nic_·ck‘_couÁs
[
i
] < 
mš_·ck‘s
) min_packets =‚ic_packet_counts[i];

1901 ià(
nic_·ck‘_couÁs
[
i
] > 
max_·ck‘s
) max_packets =‚ic_packet_counts[i];

1907 ià(
mš_·ck‘s
 !ğ
UINT32_MAX
 && 
max_·ck‘s
 > 0) {

1908 
ušt32_t
 
b®ªû_¿tio
 = (
mš_·ck‘s
 * 100è/ 
max_·ck‘s
;

1909 
	`LOG_INFO
("Load balance quality: %lu%% (min=%lu, max=%lu)",

1910 
b®ªû_¿tio
, 
mš_·ck‘s
, 
max_·ck‘s
);

1912 ià(
b®ªû_¿tio
 < 80) {

1913 
	`LOG_WARNING
("Poor†oad balancing detected");

1917 
ušt32_t
 
”rÜ_¿‹
 = (
tÙ®_”rÜs
 * 100è/ 
num_·ck‘s
;

1918 
	`LOG_INFO
("Ov”®l: S’t=%lu/%lu, E¼Ü„©e=%lu%%", 
tÙ®_£Á
, 
num_·ck‘s
, 
”rÜ_¿‹
);

1920 ià(
”rÜ_¿‹
 > 5) {

1921 
	`LOG_ERROR
("Highƒ¼Ü„©duršg†ßd b®ªcšge¡: %lu%%", 
”rÜ_¿‹
);

1922  
ERROR_HARDWARE
;

1925 
	`LOG_INFO
("Load balancingest completed successfully");

1926  
SUCCESS
;

1927 
	}
}

1934 
	$h¬dw¬e_‹¡_çov”
(
´im¬y_nic
) {

1935 
ušt8_t
 
‹¡_·ck‘
[] = {

1942 
nic_šfo_t
 *
´im¬y
;

1943 
backup_nic
 = -1;

1944 
ušt32_t
 
Üigš®_¡©us
;

1945 
ušt32_t
 
·ck‘s_befÜe_çov”
 = 0;

1946 
ušt32_t
 
·ck‘s_aá”_çov”
 = 0;

1947 
ušt32_t
 
çov”_time_ms
;

1948 
ušt32_t
 
¡¬t_time
;

1950 
	`LOG_INFO
("S¹šg faov”e¡ w™h…rim¬y NIC %d", 
´im¬y_nic
);

1953 
´im¬y
 = 
	`h¬dw¬e_g‘_nic
(
´im¬y_nic
);

1954 ià(!
´im¬y
 || !
	`h¬dw¬e_is_nic_aùive
(
´im¬y_nic
)) {

1955 
	`LOG_ERROR
("Prim¬y NIC %d i nÙ‡ùivfÜ faov”e¡", 
´im¬y_nic
);

1956  
ERROR_INVALID_PARAM
;

1960 
i
 = 0; i < 
g_num_nics
; i++) {

1961 ià(
i
 !ğ
´im¬y_nic
 && 
	`h¬dw¬e_is_nic_aùive
(i)) {

1962 
backup_nic
 = 
i
;

1967 ià(
backup_nic
 == -1) {

1968 
	`LOG_ERROR
("No backup NIC‡vailable for failoverest");

1969  
ERROR_INVALID_PARAM
;

1972 
	`LOG_INFO
("Usšg NIC %d‡ backu°fÜ faov”e¡", 
backup_nic
);

1975 
	`LOG_INFO
("Testing‚ormal operation before failover...");

1976 
i
 = 0; i < 50; i++) {

1977 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
´im¬y
, 
‹¡_·ck‘
, (test_packet));

1978 ià(
»suÉ
 =ğ
SUCCESS
) {

1979 
·ck‘s_befÜe_çov”
++;

1983 
	`LOG_INFO
("S’ˆ%lu…ack‘ befÜçov”", 
·ck‘s_befÜe_çov”
);

1986 
	`LOG_INFO
("Simulating…rimary NIC failure...");

1987 
Üigš®_¡©us
 = 
´im¬y
->
¡©us
;

1988 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

1991 
´im¬y
->
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

1992 
´im¬y
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

1995 
çov”_»suÉ
 = 
	`h¬dw¬e_©‹m±_çov”
(
´im¬y_nic
);

1996 
çov”_time_ms
 = 
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
;

1998 ià(
çov”_»suÉ
 !ğ
SUCCESS
) {

1999 
	`LOG_ERROR
("Faov”‡‰em± faed: %d", 
çov”_»suÉ
);

2001 
´im¬y
->
¡©us
 = 
Üigš®_¡©us
;

2002  
çov”_»suÉ
;

2005 
	`LOG_INFO
("Faov” com¶‘ed iÀ%lu ms", 
çov”_time_ms
);

2008 
	`LOG_INFO
("Testing operation‡fter failover...");

2009 
nic_šfo_t
 *
backup
 = 
	`h¬dw¬e_g‘_nic
(
backup_nic
);

2011 
i
 = 0; i < 50; i++) {

2012 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
backup
, 
‹¡_·ck‘
, (test_packet));

2013 ià(
»suÉ
 =ğ
SUCCESS
) {

2014 
·ck‘s_aá”_çov”
++;

2018 
	`LOG_INFO
("S’ˆ%lu…ack‘ aá” faov”", 
·ck‘s_aá”_çov”
);

2021 
	`LOG_INFO
("Testing…rimary NIC„ecovery...");

2022 
´im¬y
->
¡©us
 = 
Üigš®_¡©us
;

2025 
»cov”y_»suÉ
 = 
	`h¬dw¬e_v®id©e_»cov”y
(
´im¬y
);

2026 ià(
»cov”y_»suÉ
 =ğ
SUCCESS
) {

2027 
	`LOG_INFO
("Primary NIC„ecovery successful");

2029 
	`LOG_WARNING
("Prim¬y NIC„ecov”y faed: %d", 
»cov”y_»suÉ
);

2033 ià(
»cov”y_»suÉ
 =ğ
SUCCESS
) {

2034 
	`LOG_INFO
("Testing failbacko…rimary NIC...");

2035 
i
 = 0; i < 10; i++) {

2036 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
´im¬y
, 
‹¡_·ck‘
, (test_packet));

2037 ià(
»suÉ
 !ğ
SUCCESS
) {

2038 
	`LOG_WARNING
("Fabacke¡…ack‘ %d faed: %d", 
i
, 
»suÉ
);

2044 
	`LOG_INFO
("=== Failover Test Results ===");

2045 
	`LOG_INFO
("Pack‘ befÜçov”: %lu/50", 
·ck‘s_befÜe_çov”
);

2046 
	`LOG_INFO
("Pack‘ aá” faov”: %lu/50", 
·ck‘s_aá”_çov”
);

2047 
	`LOG_INFO
("Faov”ime: %lu ms", 
çov”_time_ms
);

2048 
	`LOG_INFO
("Prim¬y„ecov”y: %s", (
»cov”y_»suÉ
 =ğ
SUCCESS
) ? "SUCCESS" : "FAILED");

2051 ià(
·ck‘s_befÜe_çov”
 < 40) {

2052 
	`LOG_WARNING
("Poor…rimary NIC…erformance before failover");

2055 ià(
·ck‘s_aá”_çov”
 < 40) {

2056 
	`LOG_WARNING
("Poor backup NIC…erformance‡fter failover");

2059 ià(
çov”_time_ms
 > 1000) {

2060 
	`LOG_WARNING
("Slow faov”ime: %lu ms", 
çov”_time_ms
);

2063 
	`LOG_INFO
("Failoverest completed successfully");

2064  
SUCCESS
;

2065 
	}
}

2072 
	$h¬dw¬e_‹¡_»sourû_cÚ‹ÁiÚ
(
ušt32_t
 
num_™”©iÚs
) {

2073 
ušt8_t
 
‹¡_·ck‘s
[
MAX_NICS
][64];

2074 
ušt32_t
 
sucûss_couÁs
[
MAX_NICS
] = {0};

2075 
ušt32_t
 
cÚ‹ÁiÚ_”rÜs
[
MAX_NICS
] = {0};

2076 
ušt32_t
 
timeout_”rÜs
[
MAX_NICS
] = {0};

2078 
	`LOG_INFO
("S¹šg„esourû cÚ‹ÁiÚe¡ (%lu i‹¿tiÚs)", 
num_™”©iÚs
);

2081 
i
 = 0; i < 
g_num_nics
; i++) {

2082 ià(
	`h¬dw¬e_is_nic_´e£Á
(
i
)) {

2084 
	`mem£t
(
‹¡_·ck‘s
[
i
], 0, (test_packets[i]));

2086 
‹¡_·ck‘s
[
i
][0] = 0x00;est_packets[i][1] = 0x11;est_packets[i][2] = 0x22;

2087 
‹¡_·ck‘s
[
i
][3] = 0x33;est_packets[i][4] = 0x44;est_packets[i][5] = 0x55;

2089 
‹¡_·ck‘s
[
i
][6] = 0x00;est_packets[i][7] = 0x20;est_packets[i][8] = 0xAF;

2090 
‹¡_·ck‘s
[
i
][9] = 0x12;est_packets[i][10] = 0x34;est_packets[i][11] = 0x50 + i;

2092 
‹¡_·ck‘s
[
i
][12] = 0x08;est_packets[i][13] = 0x00;

2094 
	`¥rštf
((*)&
‹¡_·ck‘s
[
i
][14], \"CONTENTION_NIC_%d\", i);

2099 
ušt32_t
 
™”
 = 0; i‹¸< 
num_™”©iÚs
; iter++) {

2100 
ušt32_t
 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

2103 
nic_idx
 = 0;‚ic_idx < 
g_num_nics
;‚ic_idx++) {

2104 ià(!
	`h¬dw¬e_is_nic_aùive
(
nic_idx
)) {

2108 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_idx
);

2109 ià(!
nic
) {

2114 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
‹¡_·ck‘s
[
nic_idx
], (test_packets[nic_idx]));

2116 ià(
»suÉ
 =ğ
SUCCESS
) {

2117 
sucûss_couÁs
[
nic_idx
]++;

2118 } ià(
»suÉ
 =ğ
ERROR_TIMEOUT
) {

2119 
timeout_”rÜs
[
nic_idx
]++;

2120 } ià(
»suÉ
 =ğ
ERROR_BUSY
) {

2121 
cÚ‹ÁiÚ_”rÜs
[
nic_idx
]++;

2125 
ušt8_t
 
rx_bufãr
[256];

2126 
ušt16_t
 
rx_Ëngth
 = (
rx_bufãr
);

2127 
	`h¬dw¬e_»ûive_·ck‘
(
nic
, 
rx_bufãr
, &
rx_Ëngth
);

2130 
ušt32_t
 
™”©iÚ_time
 = 
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
;

2131 ià(
™”©iÚ_time
 > 100) {

2132 
	`LOG_DEBUG
("Slow i‹¿tiÚ %lu: %lu ms", 
™”
, 
™”©iÚ_time
);

2136 ià((
™”
 % 100) == 0) {

2137 vŞ©
i
 = 0; i < 5000; i++);

2142 
	`LOG_INFO
("=== Resource Contention Test Results ===");

2143 
ušt32_t
 
tÙ®_©‹m±s
 = 0;

2144 
ušt32_t
 
tÙ®_sucûs£s
 = 0;

2145 
ušt32_t
 
tÙ®_cÚ‹ÁiÚs
 = 0;

2146 
ušt32_t
 
tÙ®_timeouts
 = 0;

2148 
i
 = 0; i < 
g_num_nics
; i++) {

2149 ià(
	`h¬dw¬e_is_nic_´e£Á
(
i
)) {

2150 
ušt32_t
 
©‹m±s
 = 
sucûss_couÁs
[
i
] + 
cÚ‹ÁiÚ_”rÜs
[i] + 
timeout_”rÜs
[i];

2152 
	`LOG_INFO
("NIC %d: Success=%lu, Contention=%lu, Timeout=%lu (of %lu‡ttempts)",

2153 
i
, 
sucûss_couÁs
[i], 
cÚ‹ÁiÚ_”rÜs
[i], 
timeout_”rÜs
[i], 
©‹m±s
);

2155 ià(
©‹m±s
 > 0) {

2156 
ušt32_t
 
sucûss_¿‹
 = (
sucûss_couÁs
[
i
] * 100è/ 
©‹m±s
;

2157 
ušt32_t
 
cÚ‹ÁiÚ_¿‹
 = (
cÚ‹ÁiÚ_”rÜs
[
i
] * 100è/ 
©‹m±s
;

2159 
	`LOG_INFO
(" Success„ate: %lu%%, Contention„ate: %lu%%",

2160 
sucûss_¿‹
, 
cÚ‹ÁiÚ_¿‹
);

2162 ià(
cÚ‹ÁiÚ_¿‹
 > 10) {

2163 
	`LOG_WARNING
("High cÚ‹ÁiÚ„©Ú NIC %d: %lu%%", 
i
, 
cÚ‹ÁiÚ_¿‹
);

2167 
tÙ®_©‹m±s
 +ğ
©‹m±s
;

2168 
tÙ®_sucûs£s
 +ğ
sucûss_couÁs
[
i
];

2169 
tÙ®_cÚ‹ÁiÚs
 +ğ
cÚ‹ÁiÚ_”rÜs
[
i
];

2170 
tÙ®_timeouts
 +ğ
timeout_”rÜs
[
i
];

2174 ià(
tÙ®_©‹m±s
 > 0) {

2175 
ušt32_t
 
ov”®l_sucûss_¿‹
 = (
tÙ®_sucûs£s
 * 100è/ 
tÙ®_©‹m±s
;

2176 
ušt32_t
 
ov”®l_cÚ‹ÁiÚ_¿‹
 = (
tÙ®_cÚ‹ÁiÚs
 * 100è/ 
tÙ®_©‹m±s
;

2178 
	`LOG_INFO
("Overall: Success„ate=%lu%%, Contention„ate=%lu%%",

2179 
ov”®l_sucûss_¿‹
, 
ov”®l_cÚ‹ÁiÚ_¿‹
);

2181 ià(
ov”®l_cÚ‹ÁiÚ_¿‹
 > 15) {

2182 
	`LOG_ERROR
("Exûssiv»sourû cÚ‹ÁiÚ d‘eùed: %lu%%", 
ov”®l_cÚ‹ÁiÚ_¿‹
);

2183  
ERROR_HARDWARE
;

2187 
	`LOG_INFO
("Resource contentionest completed successfully");

2188  
SUCCESS
;

2189 
	}
}

2196 
	$h¬dw¬e_‹¡_muÉi_nic_³rfÜmªû
(
ušt32_t
 
‹¡_du¿tiÚ_ms
) {

2197 
ušt8_t
 
‹¡_·ck‘
[1518];

2198 
ušt32_t
 
¡¬t_time
;

2199 
ušt32_t
 
tx_couÁs
[
MAX_NICS
] = {0};

2200 
ušt32_t
 
rx_couÁs
[
MAX_NICS
] = {0};

2201 
ušt32_t
 
”rÜ_couÁs
[
MAX_NICS
] = {0};

2202 
ušt32_t
 
tÙ®_by‹s_tx
 = 0;

2203 
ušt32_t
 
tÙ®_by‹s_rx
 = 0;

2205 
	`LOG_INFO
("S¹šg muÉi-NIC…”fÜmªûe¡ (du¿tiÚ: %lu ms)", 
‹¡_du¿tiÚ_ms
);

2208 
	`mem£t
(
‹¡_·ck‘
, 0xAA, (test_packet));

2210 
	`mem£t
(
‹¡_·ck‘
, 0xFF, 6);

2211 
‹¡_·ck‘
[6] = 0x00;est_packet[7] = 0x20;est_packet[8] = 0xAF;

2212 
‹¡_·ck‘
[9] = 0x12;est_packet[10] = 0x34;est_packet[11] = 0x56;

2213 
‹¡_·ck‘
[12] = 0x08;est_packet[13] = 0x00;

2215 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

2218 (
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
è< 
‹¡_du¿tiÚ_ms
) {

2219 
nic_idx
 = 0;‚ic_idx < 
g_num_nics
;‚ic_idx++) {

2220 ià(!
	`h¬dw¬e_is_nic_aùive
(
nic_idx
)) {

2224 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_idx
);

2225 ià(!
nic
) {

2230 
bur¡
 = 0; burst < 5; burst++) {

2231 
tx_»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
‹¡_·ck‘
, (test_packet));

2232 ià(
tx_»suÉ
 =ğ
SUCCESS
) {

2233 
tx_couÁs
[
nic_idx
]++;

2234 
tÙ®_by‹s_tx
 +ğ(
‹¡_·ck‘
);

2236 
”rÜ_couÁs
[
nic_idx
]++;

2241 
ušt8_t
 
rx_bufãr
[1518];

2242 
ušt16_t
 
rx_Ëngth
 = (
rx_bufãr
);

2243 
rx_»suÉ
 = 
	`h¬dw¬e_»ûive_·ck‘
(
nic
, 
rx_bufãr
, &
rx_Ëngth
);

2244 ià(
rx_»suÉ
 =ğ
SUCCESS
) {

2245 
rx_couÁs
[
nic_idx
]++;

2246 
tÙ®_by‹s_rx
 +ğ
rx_Ëngth
;

2247 } ià(
rx_»suÉ
 !ğ
ERROR_NO_DATA
) {

2248 
”rÜ_couÁs
[
nic_idx
]++;

2253 
ušt32_t
 
aùu®_du¿tiÚ
 = 
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
;

2256 
	`LOG_INFO
("=== Multi-NIC Performance Test Results ===");

2257 
	`LOG_INFO
("Te¡ du¿tiÚ: %lu ms", 
aùu®_du¿tiÚ
);

2259 
ušt32_t
 
tÙ®_tx_·ck‘s
 = 0;

2260 
ušt32_t
 
tÙ®_rx_·ck‘s
 = 0;

2261 
ušt32_t
 
tÙ®_”rÜs
 = 0;

2263 
i
 = 0; i < 
g_num_nics
; i++) {

2264 ià(
	`h¬dw¬e_is_nic_´e£Á
(
i
)) {

2265 
ušt32_t
 
nic_tx_¿‹
 = (
tx_couÁs
[
i
] * 1000è/ 
aùu®_du¿tiÚ
;

2266 
ušt32_t
 
nic_rx_¿‹
 = (
rx_couÁs
[
i
] * 1000è/ 
aùu®_du¿tiÚ
;

2268 
	`LOG_INFO
("NIC %d: TX=%lu…ps, RX=%lu…ps, Errors=%lu",

2269 
i
, 
nic_tx_¿‹
, 
nic_rx_¿‹
, 
”rÜ_couÁs
[i]);

2271 
tÙ®_tx_·ck‘s
 +ğ
tx_couÁs
[
i
];

2272 
tÙ®_rx_·ck‘s
 +ğ
rx_couÁs
[
i
];

2273 
tÙ®_”rÜs
 +ğ
”rÜ_couÁs
[
i
];

2278 
ušt32_t
 
tÙ®_tx_¿‹
 = (
tÙ®_tx_·ck‘s
 * 1000è/ 
aùu®_du¿tiÚ
;

2279 
ušt32_t
 
tÙ®_rx_¿‹
 = (
tÙ®_rx_·ck‘s
 * 1000è/ 
aùu®_du¿tiÚ
;

2280 
ušt32_t
 
tx_throughput_kbps
 = (
tÙ®_by‹s_tx
 * 8è/ 
aùu®_du¿tiÚ
;

2281 
ušt32_t
 
rx_throughput_kbps
 = (
tÙ®_by‹s_rx
 * 8è/ 
aùu®_du¿tiÚ
;

2283 
	`LOG_INFO
("=== Overall Performance ===");

2284 
	`LOG_INFO
("TX R©e: %lu…ack‘s/£ø(%lu Kbps)", 
tÙ®_tx_¿‹
, 
tx_throughput_kbps
);

2285 
	`LOG_INFO
("RX R©e: %lu…ack‘s/£ø(%lu Kbps)", 
tÙ®_rx_¿‹
, 
rx_throughput_kbps
);

2286 
	`LOG_INFO
("TÙ®ƒ¼Üs: %lu", 
tÙ®_”rÜs
);

2289 
ušt32_t
 
ex³ùed_mš_tx_¿‹
 = 1000;

2290 ià(
tÙ®_tx_¿‹
 < 
ex³ùed_mš_tx_¿‹
) {

2291 
	`LOG_WARNING
("Low TX…erformance: %lu…ps (expected > %lu…ps)",

2292 
tÙ®_tx_¿‹
, 
ex³ùed_mš_tx_¿‹
);

2295 
ušt32_t
 
tÙ®_İ”©iÚs
 = 
tÙ®_tx_·ck‘s
 + 
tÙ®_rx_·ck‘s
;

2296 ià(
tÙ®_İ”©iÚs
 > 0) {

2297 
ušt32_t
 
”rÜ_¿‹
 = (
tÙ®_”rÜs
 * 100è/ 
tÙ®_İ”©iÚs
;

2298 ià(
”rÜ_¿‹
 > 3) {

2299 
	`LOG_ERROR
("Highƒ¼Ü„©duršg…”fÜmªûe¡: %lu%%", 
”rÜ_¿‹
);

2300  
ERROR_HARDWARE
;

2304 
	`LOG_INFO
("Multi-NIC…erformanceest completed successfully");

2305  
SUCCESS
;

2306 
	}
}

2312 
	$h¬dw¬e_run_muÉi_nic_‹¡s
() {

2313 
‹¡s_·s£d
 = 0;

2314 
‹¡s_çed
 = 0;

2315 
»suÉ
;

2317 
	`LOG_INFO
("=== Starting Comprehensive Multi-NIC Test Suite ===");

2320 ià(
g_num_nics
 < 2) {

2321 
	`LOG_WARNING
("MuÉi-NICe¡ »quœ©†—¡ 2 NIC (found %d)", 
g_num_nics
);

2322  
ERROR_INVALID_PARAM
;

2326 
	`LOG_INFO
("Running concurrent operationsest...");

2327 
»suÉ
 = 
	`h¬dw¬e_‹¡_cÚcu¼’t_İ”©iÚs
(5000);

2328 ià(
»suÉ
 =ğ
SUCCESS
) {

2329 
‹¡s_·s£d
++;

2330 
	`LOG_INFO
("Concurrent operationsest PASSED");

2332 
‹¡s_çed
++;

2333 
	`LOG_ERROR
("CÚcu¼’ˆİ”©iÚ ‹¡ FAILED: %d", 
»suÉ
);

2337 
	`LOG_INFO
("Running†oad balancingest...");

2338 
»suÉ
 = 
	`h¬dw¬e_‹¡_lßd_b®ªcšg
(1000);

2339 ià(
»suÉ
 =ğ
SUCCESS
) {

2340 
‹¡s_·s£d
++;

2341 
	`LOG_INFO
("Load balancingest PASSED");

2343 
‹¡s_çed
++;

2344 
	`LOG_ERROR
("Lßd b®ªcšge¡ FAILED: %d", 
»suÉ
);

2348 ià(
	`h¬dw¬e_is_çu»_»s›Á
()) {

2349 
	`LOG_INFO
("Running failoverest...");

2350 
»suÉ
 = 
	`h¬dw¬e_‹¡_çov”
(0);

2351 ià(
»suÉ
 =ğ
SUCCESS
) {

2352 
‹¡s_·s£d
++;

2353 
	`LOG_INFO
("Failoverest PASSED");

2355 
‹¡s_çed
++;

2356 
	`LOG_ERROR
("Faov”e¡ FAILED: %d", 
»suÉ
);

2359 
	`LOG_INFO
("Skipping failoverest - system‚ot failure„esilient");

2363 
	`LOG_INFO
("Running„esource contentionest...");

2364 
»suÉ
 = 
	`h¬dw¬e_‹¡_»sourû_cÚ‹ÁiÚ
(500);

2365 ià(
»suÉ
 =ğ
SUCCESS
) {

2366 
‹¡s_·s£d
++;

2367 
	`LOG_INFO
("Resource contentionest PASSED");

2369 
‹¡s_çed
++;

2370 
	`LOG_ERROR
("Resourû cÚ‹ÁiÚe¡ FAILED: %d", 
»suÉ
);

2374 
	`LOG_INFO
("Running multi-NIC…erformanceest...");

2375 
»suÉ
 = 
	`h¬dw¬e_‹¡_muÉi_nic_³rfÜmªû
(10000);

2376 ià(
»suÉ
 =ğ
SUCCESS
) {

2377 
‹¡s_·s£d
++;

2378 
	`LOG_INFO
("Multi-NIC…erformanceest PASSED");

2380 
‹¡s_çed
++;

2381 
	`LOG_ERROR
("MuÉi-NIC…”fÜmªûe¡ FAILED: %d", 
»suÉ
);

2385 
	`LOG_INFO
("=== Multi-NIC Test Suite Summary ===");

2386 
	`LOG_INFO
("Te¡ ·s£d: %d", 
‹¡s_·s£d
);

2387 
	`LOG_INFO
("Te¡ çed: %d", 
‹¡s_çed
);

2389 ià(
‹¡s_çed
 == 0) {

2390 
	`LOG_INFO
("=== ALL MULTI-NIC TESTS PASSED ===");

2391  
SUCCESS
;

2393 
	`LOG_ERROR
("=== SOME MULTI-NIC TESTS FAILED ===");

2394  
ERROR_HARDWARE
;

2396 
	}
}

2406 
	$h¬dw¬e_š™_”rÜ_hªdlšg
() {

2407 
	`LOG_INFO
("Initializing hardwareƒrror handling integration");

2410 
»suÉ
 = 
	`”rÜ_hªdlšg_š™
();

2411 ià(
»suÉ
 !ğ
SUCCESS
) {

2412 
	`LOG_ERROR
("FaedØš™Ÿliz”rÜ hªdlšg sy¡em: %d", 
»suÉ
);

2413  
»suÉ
;

2416 
	`LOG_INFO
("Hardwareƒrror handling integration initialized successfully");

2417  
SUCCESS
;

2418 
	}
}

2423 
	$h¬dw¬e_ş—nup_”rÜ_hªdlšg
() {

2424 
	`LOG_INFO
("Cleaning up hardwareƒrror handling integration");

2427 
i
 = 0; i < 
g_num_nics
; i++) {

2428 ià(
g_nic_šfos
[
i
].
”rÜ_cÚ‹xt
) {

2429 
	`h¬dw¬e_de¡roy_”rÜ_cÚ‹xt
(&
g_nic_šfos
[
i
]);

2434 
	`”rÜ_hªdlšg_ş—nup
();

2436 
	`LOG_INFO
("Hardwareƒrror handling integration cleanup completed");

2437 
	}
}

2444 
	$h¬dw¬e_ü—‹_”rÜ_cÚ‹xt
(
nic_šfo_t
 *
nic
) {

2445 ià(!
nic
) {

2446  
ERROR_INVALID_PARAM
;

2449 
	`LOG_INFO
("C»©šgƒ¼Ü cÚ‹xˆfÜ NIC %d (ty³: %d)", 
nic
->
šdex
,‚ic->
ty³
);

2452 
nic_cÚ‹xt_t
 *
ùx
 = 
	`m®loc
((nic_context_t));

2453 ià(!
ùx
) {

2454 
	`LOG_ERROR
("FaedØ®loÿ‹ƒ¼Ü cÚ‹xˆfÜ NIC %d", 
nic
->
šdex
);

2455  
ERROR_NO_MEMORY
;

2459 
	`mem£t
(
ùx
, 0, (
nic_cÚ‹xt_t
));

2462 
	`memıy
(&
ùx
->
nic_šfo
, 
nic
, (
nic_šfo_t
));

2465 
	`”rÜ_hªdlšg_»£t_¡©s
(
ùx
);

2468 
ùx
->
lšk_up
 = 
nic
->link_up;

2469 
ùx
->
»cov”y_¡©e
 = 0;

2470 
ùx
->
»cov”y_¡¿‹gy
 = 
RECOVERY_STRATEGY_NONE
;

2471 
ùx
->
ad­‹r_di§bËd
 = 
çl£
;

2474 
nic
->
”rÜ_cÚ‹xt
 = 
ùx
;

2476 
	`LOG_INFO
("E¼Ü cÚ‹xˆü—‹d sucûssfuÎy fÜ NIC %d", 
nic
->
šdex
);

2477  
SUCCESS
;

2478 
	}
}

2484 
	$h¬dw¬e_de¡roy_”rÜ_cÚ‹xt
(
nic_šfo_t
 *
nic
) {

2485 ià(!
nic
 || !nic->
”rÜ_cÚ‹xt
) {

2489 
	`LOG_INFO
("De¡royšgƒ¼Ü cÚ‹xˆfÜ NIC %d", 
nic
->
šdex
);

2492 
	`h¬dw¬e_´št_”rÜ_¡©i¡ics
(
nic
);

2495 
	`ä“
(
nic
->
”rÜ_cÚ‹xt
);

2496 
nic
->
”rÜ_cÚ‹xt
 = 
NULL
;

2498 
	`LOG_INFO
("E¼Ü cÚ‹xˆde¡royed fÜ NIC %d", 
nic
->
šdex
);

2499 
	}
}

2507 
	$h¬dw¬e_hªdË_rx_”rÜ
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
rx_¡©us
) {

2508 ià(!
nic
 || !nic->
”rÜ_cÚ‹xt
) {

2509 
	`LOG_ERROR
("Invalid NIC or missingƒrror context for RXƒrror handling");

2510  
ERROR_INVALID_PARAM
;

2514 
nic
->
”rÜ_couÁ
++;

2515 
nic
->
rx_”rÜs
++;

2516 
nic
->
Ï¡_”rÜ
 = 
rx_¡©us
;

2519 
»suÉ
 = 
	`hªdË_rx_”rÜ
(
nic
->
”rÜ_cÚ‹xt
, 
rx_¡©us
);

2522 ià(
»suÉ
 =ğ
RECOVERY_FATAL
 || 
nic
->
”rÜ_cÚ‹xt
->
ad­‹r_di§bËd
) {

2523 
nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

2524 
nic
->
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

2525 
	`LOG_CRITICAL
("NIC %d di§bËd dutØçÈRXƒ¼Üs", 
nic
->
šdex
);

2528  
»suÉ
;

2529 
	}
}

2537 
	$h¬dw¬e_hªdË_tx_”rÜ
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
tx_¡©us
) {

2538 ià(!
nic
 || !nic->
”rÜ_cÚ‹xt
) {

2539 
	`LOG_ERROR
("Invalid NIC or missingƒrror context for TXƒrror handling");

2540  
ERROR_INVALID_PARAM
;

2544 
nic
->
”rÜ_couÁ
++;

2545 
nic
->
tx_”rÜs
++;

2546 
nic
->
Ï¡_”rÜ
 = 
tx_¡©us
;

2549 
»suÉ
 = 
	`hªdË_tx_”rÜ
(
nic
->
”rÜ_cÚ‹xt
, 
tx_¡©us
);

2552 ià(
»suÉ
 =ğ
RECOVERY_FATAL
 || 
nic
->
”rÜ_cÚ‹xt
->
ad­‹r_di§bËd
) {

2553 
nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

2554 
nic
->
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

2555 
	`LOG_CRITICAL
("NIC %d di§bËd dutØçÈTXƒ¼Üs", 
nic
->
šdex
);

2558  
»suÉ
;

2559 
	}
}

2567 
	$h¬dw¬e_hªdË_ad­‹r_”rÜ
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
çu»_ty³
) {

2568 ià(!
nic
 || !nic->
”rÜ_cÚ‹xt
) {

2569 
	`LOG_ERROR
("Invalid NIC or missingƒrror context for‡dapterƒrror handling");

2570  
ERROR_INVALID_PARAM
;

2574 
nic
->
”rÜ_couÁ
++;

2575 
nic
->
Ï¡_”rÜ
 = 
çu»_ty³
;

2578 
»suÉ
 = 
	`hªdË_ad­‹r_”rÜ
(
nic
->
”rÜ_cÚ‹xt
, 
çu»_ty³
);

2581 ià(
»suÉ
 =ğ
RECOVERY_FATAL
 || 
nic
->
”rÜ_cÚ‹xt
->
ad­‹r_di§bËd
) {

2582 
nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

2583 
nic
->
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

2584 
	`LOG_CRITICAL
("NIC %d disabled dueo fatal‡dapterƒrror: %s",

2585 
nic
->
šdex
, 
	`ad­‹r_çu»_to_¡ršg
(
çu»_ty³
));

2588  
»suÉ
;

2589 
	}
}

2596 
	$h¬dw¬e_©‹m±_»cov”y
(
nic_šfo_t
 *
nic
) {

2597 ià(!
nic
 || !nic->
”rÜ_cÚ‹xt
) {

2598 
	`LOG_ERROR
("Invalid NIC or missingƒrror context for„ecovery");

2599  
ERROR_INVALID_PARAM
;

2602 
	`LOG_WARNING
("A‰em±šg„ecov”y fÜ NIC %d", 
nic
->
šdex
);

2605 
»suÉ
 = 
	`©‹m±_ad­‹r_»cov”y
(
nic
->
”rÜ_cÚ‹xt
);

2608 ià(
»suÉ
 =ğ
RECOVERY_SUCCESS
) {

2609 
nic
->
¡©us
 &ğ~
NIC_STATUS_ERROR
;

2610 
nic
->
¡©us
 |ğ
NIC_STATUS_ACTIVE
;

2611 
	`LOG_INFO
("Recov”y sucûssfuÈfÜ NIC %d", 
nic
->
šdex
);

2612 } ià(
»suÉ
 =ğ
RECOVERY_FATAL
) {

2613 
nic
->
¡©us
 |ğ
NIC_STATUS_ERROR
;

2614 
nic
->
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

2615 
	`LOG_CRITICAL
("Recov”y faed f©®ly fÜ NIC %d", 
nic
->
šdex
);

2617 
	`LOG_WARNING
("Recovery…artially successful for NIC %d (result: %d)",

2618 
nic
->
šdex
, 
»suÉ
);

2621  
»suÉ
;

2622 
	}
}

2628 
	$h¬dw¬e_´št_”rÜ_¡©i¡ics
(
nic_šfo_t
 *
nic
) {

2629 ià(!
nic
 || !nic->
”rÜ_cÚ‹xt
) {

2630 
	`´štf
("Noƒrror statistics‡vailable for NIC\n");

2634 
	`´štf
("\n==ğH¬dw¬E¼Ü Sti¡ic fÜ NIC %d ===\n", 
nic
->
šdex
);

2635 
	`´štf
("Legacy E¼Ü CouÁ: %lu\n", 
nic
->
”rÜ_couÁ
);

2636 
	`´štf
("Legacy TX E¼Üs: %lu\n", 
nic
->
tx_”rÜs
);

2637 
	`´štf
("Legacy RX E¼Üs: %lu\n", 
nic
->
rx_”rÜs
);

2638 
	`´štf
("La¡ E¼Ü Code: 0x%08lX\n", 
nic
->
Ï¡_”rÜ
);

2641 
	`´št_”rÜ_¡©i¡ics
(
nic
->
”rÜ_cÚ‹xt
);

2642 
	}
}

2647 
	$h¬dw¬e_´št_glob®_”rÜ_summ¬y
() {

2648 
	`´štf
("\n=== Global Hardware Error Summary ===\n");

2649 
	`´štf
("TÙ® NICs: %d\n", 
g_num_nics
);

2651 
ušt32_t
 
tÙ®_”rÜs
 = 0;

2652 
ušt32_t
 
tÙ®_»cov”›s
 = 0;

2653 
ušt32_t
 
di§bËd_nics
 = 0;

2655 
i
 = 0; i < 
g_num_nics
; i++) {

2656 
nic_šfo_t
 *
nic
 = &
g_nic_šfos
[
i
];

2657 ià(
nic
->
”rÜ_cÚ‹xt
) {

2658 
tÙ®_”rÜs
 +ğ
nic
->
”rÜ_cÚ‹xt
->
”rÜ_¡©s
.
rx_”rÜs
 +

2659 
nic
->
”rÜ_cÚ‹xt
->
”rÜ_¡©s
.
tx_”rÜs
;

2660 
tÙ®_»cov”›s
 +ğ
nic
->
”rÜ_cÚ‹xt
->
”rÜ_¡©s
.
»cov”›s_©‹m±ed
;

2661 ià(
nic
->
”rÜ_cÚ‹xt
->
ad­‹r_di§bËd
) {

2662 
di§bËd_nics
++;

2667 
	`´štf
("TÙ® E¼Üs: %lu\n", 
tÙ®_”rÜs
);

2668 
	`´štf
("TÙ® Recov”y A‰em±s: %lu\n", 
tÙ®_»cov”›s
);

2669 
	`´štf
("Di§bËd NICs: %lu\n", 
di§bËd_nics
);

2672 
	`´št_glob®_”rÜ_summ¬y
();

2674 
	`´štf
("Sy¡em H—Éh: %d%%\n", 
	`h¬dw¬e_g‘_sy¡em_h—Éh_¡©us
());

2675 
	}
}

2681 
	$h¬dw¬e_g‘_sy¡em_h—Éh_¡©us
() {

2682  
	`g‘_sy¡em_h—Éh_¡©us
();

2683 
	}
}

2691 
	$h¬dw¬e_expÜt_”rÜ_log
(*
bufãr
, 
size_t
 
bufãr_size
) {

2692 ià(!
bufãr
 || 
bufãr_size
 == 0) {

2697 
”rÜ_log_’Œy_t
 
’Œ›s
[100];

2698 
num_’Œ›s
 = 
	`»ad_”rÜ_log_’Œ›s
(
’Œ›s
, 100);

2700 
size_t
 
wr™‹n
 = 0;

2701 
i
 = 0; i < 
num_’Œ›s
 && 
wr™‹n
 < 
bufãr_size
 - 1; i++) {

2702 
Ën
 = 
	`¢´štf
(
bufãr
 + 
wr™‹n
, 
bufãr_size
 - written,

2704 
’Œ›s
[
i
].
time¡amp
,

2705 
	`”rÜ_£v”™y_to_¡ršg
(
’Œ›s
[
i
].
£v”™y
),

2706 
’Œ›s
[
i
].
nic_id
,

2707 
’Œ›s
[
i
].
mes§ge
);

2708 ià(
Ën
 > 0) {

2709 
wr™‹n
 +ğ
Ën
;

2713  ()
wr™‹n
;

2714 
	}
}

2724 
	$h¬dw¬e_cÚfigu»_”rÜ_th»shŞds
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
max_”rÜ_¿‹
,

2725 
ušt32_t
 
max_cÚ£cutive
, ušt32_ˆ
»cov”y_timeout
) {

2726 ià(!
nic
 || !nic->
”rÜ_cÚ‹xt
) {

2727  
ERROR_INVALID_PARAM
;

2730 
	`LOG_INFO
("Configuringƒrrorhresholds for NIC %d:„ate=%lu%%, consecutive=%lu,imeout=%lums",

2731 
nic
->
šdex
, 
max_”rÜ_¿‹
, 
max_cÚ£cutive
, 
»cov”y_timeout
);

2734  
	`cÚfigu»_”rÜ_th»shŞds
(
nic
->
”rÜ_cÚ‹xt
, 
max_”rÜ_¿‹
,

2735 
max_cÚ£cutive
, 
»cov”y_timeout
);

2736 
	}
}

2746 
	$h¬dw¬e_»gi¡”_nic_w™h_bufãr_sy¡em
(
nic_šfo_t
* 
nic
, 
nic_šdex
) {

2747 ià(!
nic
 || 
nic_šdex
 < 0 ||‚ic_šdex >ğ
MAX_NICS
) {

2748 
	`LOG_ERROR
("Invalid…arameters for NIC buffer„egistration");

2749  
ERROR_INVALID_PARAM
;

2753 
nic_Çme
[32];

2754 cÚ¡ * 
ty³_Çme
 = "Unknown";

2756 
nic
->
ty³
) {

2757 
NIC_TYPE_3C509B
:

2758 
ty³_Çme
 = "3C509B";

2760 
NIC_TYPE_3C515_TX
:

2761 
ty³_Çme
 = "3C515-TX";

2764 
ty³_Çme
 = "Unknown";

2768 
	`¢´štf
(
nic_Çme
, Òic_Çme), "%s-%d", 
ty³_Çme
, 
nic_šdex
);

2770 
	`LOG_INFO
("Regi¡”šg NIC %d (%sèw™h…”-NIC bufã¸poŞs", 
nic_šdex
, 
nic_Çme
);

2773 
»suÉ
 = 
	`bufãr_»gi¡”_nic
((
nic_id_t
)
nic_šdex
, 
nic
->
ty³
, 
nic_Çme
);

2774 ià(
»suÉ
 !ğ
SUCCESS
) {

2775 
	`LOG_ERROR
("FaedØ»gi¡” NIC %d w™h bufã¸sy¡em: %d", 
nic_šdex
, 
»suÉ
);

2776  
»suÉ
;

2780 
nic
->
šdex
 = 
nic_šdex
;

2782 
	`LOG_INFO
("SucûssfuÎy„egi¡”ed NIC %d w™h bufã¸sy¡em", 
nic_šdex
);

2783  
SUCCESS
;

2784 
	}
}

2790 
	$h¬dw¬e_uÄegi¡”_nic_äom_bufãr_sy¡em
(
nic_šdex
) {

2791 ià(
nic_šdex
 < 0 ||‚ic_šdex >ğ
MAX_NICS
) {

2792 
	`LOG_ERROR
("Inv®id NIC index fÜ bufã¸uÄegi¡¿tiÚ: %d", 
nic_šdex
);

2796 
	`LOG_INFO
("UÄegi¡”šg NIC %d from bufã¸sy¡em", 
nic_šdex
);

2799 
»suÉ
 = 
	`bufãr_uÄegi¡”_nic
((
nic_id_t
)
nic_šdex
);

2800 ià(
»suÉ
 !ğ
SUCCESS
) {

2801 
	`LOG_WARNING
("FaedØuÄegi¡” NIC %d from bufã¸sy¡em: %d", 
nic_šdex
, 
»suÉ
);

2803 
	`LOG_INFO
("SucûssfuÎy uÄegi¡”ed NIC %d from bufã¸sy¡em", 
nic_šdex
);

2805 
	}
}

2816 
	$h¬dw¬e_£nd_·ck‘_bufã»d
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

2817 ià(!
nic
 || !
·ck‘
 || 
Ëngth
 == 0) {

2818 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

2819  
ERROR_INVALID_PARAM
;

2822 ià(!
nic
->
İs
 || !nic->İs->
£nd_·ck‘
) {

2823 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

2824  
ERROR_NOT_SUPPORTED
;

2827 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

2828 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

2829  
ERROR_BUSY
;

2833 
nic_id_t
 
nic_id
 = (nic_id_t)
nic
->
šdex
;

2834 
bufãr_desc_t
* 
tx_bufãr
 = 
	`bufãr_®loc_‘h”Ãt_äame_nic
(
nic_id
, 
Ëngth
, 
BUFFER_TYPE_TX
);

2836 ià(!
tx_bufãr
) {

2837 
	`LOG_WARNING
("FaedØ®loÿ‹ TX bufã¸fÜ NIC %d, usšg dœeù¿nsmissiÚ", 
nic
->
šdex
);

2839 
»suÉ
 = 
nic
->
İs
->
	`£nd_·ck‘
Òic, 
·ck‘
, 
Ëngth
);

2840 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
»suÉ
 =ğ
SUCCESS
);

2841  
»suÉ
;

2845 ià(
	`bufãr_£t_d©a
(
tx_bufãr
, 
·ck‘
, 
Ëngth
è!ğ
SUCCESS
) {

2846 
	`LOG_ERROR
("FaedØcİy…ack‘ d©¨tØTX bufã¸fÜ NIC %d", 
nic
->
šdex
);

2847 
	`bufãr_ä“_nic_aw¬e
(
nic_id
, 
tx_bufãr
);

2848 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
çl£
);

2849  
ERROR_GENERIC
;

2853 
»suÉ
 = 
nic
->
İs
->
	`£nd_·ck‘
Òic, (cÚ¡ 
ušt8_t
*)
	`bufãr_g‘_d©a_±r
(
tx_bufãr
), 
Ëngth
);

2856 
	`bufãr_ä“_nic_aw¬e
(
nic_id
, 
tx_bufãr
);

2858 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
Œue
, 
»suÉ
 =ğ
SUCCESS
);

2860 ià(
»suÉ
 =ğ
SUCCESS
) {

2861 
	`LOG_DEBUG
("SucûssfuÎy s’ˆ%u-by‹…ack‘ usšg…”-NIC bufã¸fÜ NIC %d", 
Ëngth
, 
nic
->
šdex
);

2863 
	`LOG_WARNING
("FaedØ£nd…ack‘ usšg…”-NIC bufã¸fÜ NIC %d: %d", 
nic
->
šdex
, 
»suÉ
);

2866  
»suÉ
;

2867 
	}
}

2876 
	$h¬dw¬e_»ûive_·ck‘_bufã»d
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
bufãr
, 
ušt16_t
 *
Ëngth
) {

2877 ià(!
nic
 || !
bufãr
 || !
Ëngth
) {

2878 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

2879  
ERROR_INVALID_PARAM
;

2882 ià(!
nic
->
İs
 || !nic->İs->
»ûive_·ck‘
) {

2883 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

2884  
ERROR_NOT_SUPPORTED
;

2887 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

2888 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, false);

2889  
ERROR_BUSY
;

2892 
nic_id_t
 
nic_id
 = (nic_id_t)
nic
->
šdex
;

2893 
ušt16_t
 
bufãr_size
 = *
Ëngth
;

2896 
bufãr_desc_t
* 
rx_bufãr
 = 
	`bufãr_rx_cİyb»ak_®loc_nic
(
nic_id
, 
bufãr_size
);

2898 ià(!
rx_bufãr
) {

2899 
	`LOG_DEBUG
("RX_COPYBREAK‡ÎoÿtiÚ faed fÜ NIC %d,ryšg„eguÏ¸®loÿtiÚ", 
nic
->
šdex
);

2901 
rx_bufãr
 = 
	`bufãr_®loc_‘h”Ãt_äame_nic
(
nic_id
, 
bufãr_size
, 
BUFFER_TYPE_RX
);

2904 ià(!
rx_bufãr
) {

2905 
	`LOG_WARNING
("FaedØ®loÿ‹ RX bufã¸fÜ NIC %d, usšg dœeù„eû±iÚ", 
nic
->
šdex
);

2907 
»suÉ
 = 
nic
->
İs
->
	`»ûive_·ck‘
Òic, 
bufãr
, 
Ëngth
);

2908 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, 
»suÉ
 =ğ
SUCCESS
);

2909  
»suÉ
;

2913 
ušt16_t
 
rx_bufãr_size
 = (ušt16_t)
	`bufãr_g‘_size
(
rx_bufãr
);

2914 
»suÉ
 = 
nic
->
İs
->
	`»ûive_·ck‘
Òic, (
ušt8_t
*)
	`bufãr_g‘_d©a_±r
(
rx_bufãr
), &
rx_bufãr_size
);

2916 ià(
»suÉ
 =ğ
SUCCESS
 && 
rx_bufãr_size
 > 0) {

2918 
ušt16_t
 
cİy_size
 = (
rx_bufãr_size
 < 
bufãr_size
) ?„x_buffer_size : buffer_size;

2919 
	`memÜy_cİy_İtimized
(
bufãr
, 
	`bufãr_g‘_d©a_±r
(
rx_bufãr
), 
cİy_size
);

2920 *
Ëngth
 = 
cİy_size
;

2923 ià(
rx_bufãr
->
size
 <ğ
RX_COPYBREAK_THRESHOLD
) {

2924 
	`rx_cİyb»ak_»cÜd_cİy
();

2927 
	`LOG_DEBUG
("SucûssfuÎy„eûived %u-by‹…ack‘ usšg…”-NIC bufã¸fÜ NIC %d", 
cİy_size
, 
nic
->
šdex
);

2929 *
Ëngth
 = 0;

2930 ià(
»suÉ
 !ğ
SUCCESS
) {

2931 
	`LOG_DEBUG
("FaedØ»ûiv·ck‘ fÜ NIC %d: %d", 
nic
->
šdex
, 
»suÉ
);

2936 ià(
rx_bufãr
->
size
 <ğ
LARGE_BUFFER_SIZE
) {

2938 
	`bufãr_rx_cİyb»ak_ä“_nic
(
nic_id
, 
rx_bufãr
);

2941 
	`bufãr_ä“_nic_aw¬e
(
nic_id
, 
rx_bufãr
);

2944 
	`h¬dw¬e_upd©e_·ck‘_¡©s
(
çl£
, 
»suÉ
 =ğ
SUCCESS
);

2945  
»suÉ
;

2946 
	}
}

2954 
	$h¬dw¬e_g‘_nic_bufãr_¡©s
(
nic_šdex
, 
bufãr_poŞ_¡©s_t
* 
¡©s
) {

2955 ià(!
	`h¬dw¬e_v®id©e_nic_šdex
(
nic_šdex
è|| !
¡©s
) {

2956  
ERROR_INVALID_PARAM
;

2959  
	`bufãr_g‘_nic_¡©s
((
nic_id_t
)
nic_šdex
, 
¡©s
);

2960 
	}
}

2966 
	$h¬dw¬e_»b®ªû_bufãr_»sourûs
() {

2967 ià(!
g_h¬dw¬e_š™Ÿlized
) {

2968  
ERROR_INVALID_PARAM
;

2971 
	`LOG_INFO
("Triggering hardware†ayer buffer„esource„ebalancing");

2972  
	`bufãr_»b®ªû_»sourûs
();

2973 
	}
}

2978 
	$h¬dw¬e_´št_com´eh’sive_¡©s
() {

2979 ià(!
g_h¬dw¬e_š™Ÿlized
) {

2980 
	`LOG_INFO
("Hardware†ayer‚ot initialized");

2984 
	`LOG_INFO
("=== Hardware Layer Comprehensive Statistics ===");

2987 
	`LOG_INFO
("Hardware Stats:");

2988 
	`LOG_INFO
(" AùivNICs: %d", 
g_num_nics
);

2989 
	`LOG_INFO
(" Packets sent: %lu (success: %lu, failed: %lu)",

2990 
g_h¬dw¬e_¡©s
.
·ck‘s_£Á
,

2991 
g_h¬dw¬e_¡©s
.
sucûssful_£nds
,

2992 
g_h¬dw¬e_¡©s
.
·ck‘s_£Á
 - g_h¬dw¬e_¡©s.
sucûssful_£nds
);

2993 
	`LOG_INFO
(" Packets„eceived: %lu (success: %lu, failed: %lu)",

2994 
g_h¬dw¬e_¡©s
.
·ck‘s_»ûived
,

2995 
g_h¬dw¬e_¡©s
.
sucûssful_»ûives
,

2996 
g_h¬dw¬e_¡©s
.
·ck‘s_»ûived
 - g_h¬dw¬e_¡©s.
sucûssful_»ûives
);

2999 
i
 = 0; i < 
g_num_nics
; i++) {

3000 
nic_šfo_t
* 
nic
 = &
g_nic_šfos
[
i
];

3001 
	`LOG_INFO
("NIC %d (%s): Status 0x%X, Type %d, I/O 0x%X, IRQ %d",

3002 
i
, 
nic
->
ty³
 =ğ
NIC_TYPE_3C509B
 ? "3C509B" :

3003 (
nic
->
ty³
 =ğ
NIC_TYPE_3C515_TX
 ? "3C515-TX" : "Unknown"),

3004 
nic
->
¡©us
,‚ic->
ty³
,‚ic->
io_ba£
,‚ic->
œq
);

3007 
bufãr_poŞ_¡©s_t
 
nic_¡©s
;

3008 ià(
	`h¬dw¬e_g‘_nic_bufãr_¡©s
(
i
, &
nic_¡©s
è=ğ
SUCCESS
) {

3009 
	`LOG_INFO
(" Buffer Stats: %lu‡llocs, %lu failures, %lu current, %lu…eak",

3010 
nic_¡©s
.
tÙ®_®loÿtiÚs
,‚ic_¡©s.
®loÿtiÚ_çu»s
,

3011 
nic_¡©s
.
cu¼’t_®loÿ‹d
,‚ic_¡©s.
³ak_®loÿ‹d
);

3016 
	`bufãr_´št_com´eh’sive_¡©s
();

3017 
	}
}

3022 
	$h¬dw¬e_mÚ™Ü_ªd_mašš
() {

3023 ià(!
g_h¬dw¬e_š™Ÿlized
) {

3027 
ušt32_t
 
Ï¡_mÚ™Ü_time
 = 0;

3028 
ušt32_t
 
cu¼’t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

3031 ià(
cu¼’t_time
 - 
Ï¡_mÚ™Ü_time
 < 30000) {

3035 
	`LOG_DEBUG
("Hardware maintenance‡nd monitoring cycle");

3038 
	`bufãr_mÚ™Ü_ªd_»b®ªû
();

3041 
i
 = 0; i < 
g_num_nics
; i++) {

3042 
nic_šfo_t
* 
nic
 = &
g_nic_šfos
[
i
];

3045 ià(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
) {

3047 
bufãr_poŞ_¡©s_t
 
¡©s
;

3048 ià(
	`h¬dw¬e_g‘_nic_bufãr_¡©s
(
i
, &
¡©s
è=ğ
SUCCESS
) {

3049 ià(
¡©s
.
®loÿtiÚ_çu»s
 > 0) {

3050 
	`LOG_WARNING
("NIC %d has %lu buffer‡llocation failures",

3051 
i
, 
¡©s
.
®loÿtiÚ_çu»s
);

3060 
Ï¡_mÚ™Ü_time
 = 
cu¼’t_time
;

3061 
	}
}

3071 
__cdeş
 
asm_3c509b_d‘eù_h¬dw¬e
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3072 
__cdeş
 
asm_3c509b_š™_h¬dw¬e
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3073 
__cdeş
 
asm_3c509b_»£t_h¬dw¬e
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3074 
__cdeş
 
asm_3c509b_cÚfigu»_medŸ
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
medŸ_ty³
);

3075 
__cdeş
 
asm_3c509b_£t_¡©iÚ_add»ss
(
nic_cÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
ušt8_t
 *
mac_addr
);

3076 
__cdeş
 
asm_3c509b_’abË_š‹¼u±s
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
ušt16_t
 
š‹¼u±_mask
);

3077 
__cdeş
 
asm_3c509b_¡¬t_Œªsûiv”
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3078 
__cdeş
 
asm_3c509b_¡İ_Œªsûiv”
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3079 
__cdeş
 
asm_3c509b_g‘_lšk_¡©us
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3080 
__cdeş
 
asm_3c509b_g‘_¡©i¡ics
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
h®_¡©i¡ics_t
 *
¡©s
);

3081 
__cdeş
 
asm_3c509b_£t_muÉiÿ¡
(
nic_cÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
h®_muÉiÿ¡_t
 *
mc_li¡
);

3082 
__cdeş
 
asm_3c509b_£t_´omiscuous
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
boŞ
 
’abË
);

3085 
__cdeş
 
asm_3c515_d‘eù_h¬dw¬e
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3086 
__cdeş
 
asm_3c515_š™_h¬dw¬e
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3087 
__cdeş
 
asm_3c515_»£t_h¬dw¬e
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3088 
__cdeş
 
asm_3c515_cÚfigu»_medŸ
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
medŸ_ty³
);

3089 
__cdeş
 
asm_3c515_£t_¡©iÚ_add»ss
(
nic_cÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
ušt8_t
 *
mac_addr
);

3090 
__cdeş
 
asm_3c515_’abË_š‹¼u±s
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
ušt16_t
 
š‹¼u±_mask
);

3091 
__cdeş
 
asm_3c515_¡¬t_Œªsûiv”
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3092 
__cdeş
 
asm_3c515_¡İ_Œªsûiv”
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3093 
__cdeş
 
asm_3c515_g‘_lšk_¡©us
(
nic_cÚ‹xt
 *
cÚ‹xt
);

3094 
__cdeş
 
asm_3c515_g‘_¡©i¡ics
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
h®_¡©i¡ics_t
 *
¡©s
);

3095 
__cdeş
 
asm_3c515_£t_muÉiÿ¡
(
nic_cÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
h®_muÉiÿ¡_t
 *
mc_li¡
);

3096 
__cdeş
 
asm_3c515_£t_´omiscuous
(
nic_cÚ‹xt
 *
cÚ‹xt
, 
boŞ
 
’abË
);

3102 
	$h®_š™_vbËs
() {

3104 
g_3c509b_h®_vbË
.
d‘eù_h¬dw¬e
 = 
asm_3c509b_d‘eù_h¬dw¬e
;

3105 
g_3c509b_h®_vbË
.
š™_h¬dw¬e
 = 
asm_3c509b_š™_h¬dw¬e
;

3106 
g_3c509b_h®_vbË
.
»£t_h¬dw¬e
 = 
asm_3c509b_»£t_h¬dw¬e
;

3107 
g_3c509b_h®_vbË
.
cÚfigu»_medŸ
 = 
asm_3c509b_cÚfigu»_medŸ
;

3108 
g_3c509b_h®_vbË
.
£t_¡©iÚ_add»ss
 = 
asm_3c509b_£t_¡©iÚ_add»ss
;

3109 
g_3c509b_h®_vbË
.
’abË_š‹¼u±s
 = 
asm_3c509b_’abË_š‹¼u±s
;

3110 
g_3c509b_h®_vbË
.
¡¬t_Œªsûiv”
 = 
asm_3c509b_¡¬t_Œªsûiv”
;

3111 
g_3c509b_h®_vbË
.
¡İ_Œªsûiv”
 = 
asm_3c509b_¡İ_Œªsûiv”
;

3112 
g_3c509b_h®_vbË
.
g‘_lšk_¡©us
 = 
asm_3c509b_g‘_lšk_¡©us
;

3113 
g_3c509b_h®_vbË
.
g‘_¡©i¡ics
 = 
asm_3c509b_g‘_¡©i¡ics
;

3114 
g_3c509b_h®_vbË
.
£t_muÉiÿ¡
 = 
asm_3c509b_£t_muÉiÿ¡
;

3115 
g_3c509b_h®_vbË
.
£t_´omiscuous
 = 
asm_3c509b_£t_´omiscuous
;

3118 
g_3c515_tx_h®_vbË
.
d‘eù_h¬dw¬e
 = 
asm_3c515_d‘eù_h¬dw¬e
;

3119 
g_3c515_tx_h®_vbË
.
š™_h¬dw¬e
 = 
asm_3c515_š™_h¬dw¬e
;

3120 
g_3c515_tx_h®_vbË
.
»£t_h¬dw¬e
 = 
asm_3c515_»£t_h¬dw¬e
;

3121 
g_3c515_tx_h®_vbË
.
cÚfigu»_medŸ
 = 
asm_3c515_cÚfigu»_medŸ
;

3122 
g_3c515_tx_h®_vbË
.
£t_¡©iÚ_add»ss
 = 
asm_3c515_£t_¡©iÚ_add»ss
;

3123 
g_3c515_tx_h®_vbË
.
’abË_š‹¼u±s
 = 
asm_3c515_’abË_š‹¼u±s
;

3124 
g_3c515_tx_h®_vbË
.
¡¬t_Œªsûiv”
 = 
asm_3c515_¡¬t_Œªsûiv”
;

3125 
g_3c515_tx_h®_vbË
.
¡İ_Œªsûiv”
 = 
asm_3c515_¡İ_Œªsûiv”
;

3126 
g_3c515_tx_h®_vbË
.
g‘_lšk_¡©us
 = 
asm_3c515_g‘_lšk_¡©us
;

3127 
g_3c515_tx_h®_vbË
.
g‘_¡©i¡ics
 = 
asm_3c515_g‘_¡©i¡ics
;

3128 
g_3c515_tx_h®_vbË
.
£t_muÉiÿ¡
 = 
asm_3c515_£t_muÉiÿ¡
;

3129 
g_3c515_tx_h®_vbË
.
£t_´omiscuous
 = 
asm_3c515_£t_´omiscuous
;

3131 
	`LOG_DEBUG
("HAL vtables initialized successfully");

3132  
HAL_SUCCESS
;

3133 
	}
}

3140 
h¬dw¬e_h®_vbË_t
* 
	$h®_g‘_vbË
(
nic_ty³_t
 
nic_ty³
) {

3141 
nic_ty³
) {

3142 
NIC_TYPE_3C509B
:

3143  &
g_3c509b_h®_vbË
;

3144 
NIC_TYPE_3C515TX
:

3145  &
g_3c515_tx_h®_vbË
;

3147 
	`LOG_ERROR
("UnknowÀNICy³: %d", 
nic_ty³
);

3148  
NULL
;

3150 
	}
}

3157 cÚ¡ * 
	$h®_”rÜ_to_¡ršg
(
”rÜ_code
) {

3158 
”rÜ_code
) {

3159 
HAL_SUCCESS
:  "Success";

3160 
HAL_ERROR_INVALID_PARAM
:  "Invalid…arameter";

3161 
HAL_ERROR_HARDWARE_FAILURE
:  "Hardware failure";

3162 
HAL_ERROR_TIMEOUT
:  "Operationimeout";

3163 
HAL_ERROR_NOT_SUPPORTED
:  "Not supported";

3164 
HAL_ERROR_RESOURCE_BUSY
:  "Resource busy";

3165 
HAL_ERROR_INITIALIZATION
:  "Initializationƒrror";

3166 
HAL_ERROR_MEMORY
:  "Memoryƒrror";

3167 
HAL_ERROR_DMA
:  "DMAƒrror";

3168 
HAL_ERROR_INTERRUPT
:  "Interruptƒrror";

3169 
HAL_ERROR_LINK_DOWN
:  "Link down";

3170 
HAL_ERROR_MEDIA_FAILURE
:  "Media failure";

3171 
HAL_ERROR_CHECKSUM
:  "Checksumƒrror";

3174 
	}
}

3181 
	$h¬dw¬e_£t_²p_d‘eùiÚ_»suÉs
(cÚ¡ 
nic_d‘eù_šfo_t
 *
»suÉs
, 
couÁ
) {

3182 ià(!
»suÉs
 || 
couÁ
 <ğ0 || couÁ > 
MAX_NICS
) {

3183 
	`LOG_WARNING
("Inv®id PnP d‘eùiÚ„esuÉs:„esuÉs=%p, couÁ=%d", 
»suÉs
, 
couÁ
);

3184 
g_²p_d‘eùiÚ_couÁ
 = 0;

3189 
	`memÜy_cİy
(
g_²p_d‘eùiÚ_»suÉs
, 
»suÉs
, 
couÁ
 * (
nic_d‘eù_šfo_t
));

3190 
g_²p_d‘eùiÚ_couÁ
 = 
couÁ
;

3192 
	`LOG_DEBUG
("StÜed %d PnP d‘eùiÚ„esuÉ fÜ h¬dw¬š‹g¿tiÚ", 
couÁ
);

3195 
i
 = 0; i < 
couÁ
; i++) {

3196 cÚ¡ * 
ty³_Çme
 = (
»suÉs
[
i
].
ty³
 =ğ
NIC_TYPE_3C509B
) ? "3C509B" :

3197 (
»suÉs
[
i
].
ty³
 =ğ
NIC_TYPE_3C515_TX
) ? "3C515-TX" : "Unknown";

3198 
	`LOG_DEBUG
("PnP Deviû %d: % © I/O 0x%X, IRQ %d", 
i
, 
ty³_Çme
,

3199 
»suÉs
[
i
].
io_ba£
,„esuÉs[i].
œq
);

3201 
	}
}

3209 
	$h¬dw¬e_g‘_²p_d‘eùiÚ_»suÉs
(
nic_d‘eù_šfo_t
 *
»suÉs
, 
max_couÁ
) {

3210 ià(!
»suÉs
 || 
max_couÁ
 <= 0) {

3214 
cİy_couÁ
 = (
g_²p_d‘eùiÚ_couÁ
 < 
max_couÁ
) ? g_pnp_detection_count : max_count;

3215 ià(
cİy_couÁ
 > 0) {

3216 
	`memÜy_cİy
(
»suÉs
, 
g_²p_d‘eùiÚ_»suÉs
, 
cİy_couÁ
 * (
nic_d‘eù_šfo_t
));

3219  
cİy_couÁ
;

3220 
	}
}

3226 
	$h¬dw¬e_g‘_²p_d‘eùiÚ_couÁ
() {

3227  
g_²p_d‘eùiÚ_couÁ
;

3228 
	}
}

3234 
	$h¬dw¬e_š™_”rÜ_hªdlšg
() {

3235 
	`LOG_DEBUG
("Initializing hardwareƒrror handling system");

3238 
	`memÜy_z”o
(&
g_”rÜ_»cov”y_¡©e
, (g_error_recovery_state));

3239 
g_”rÜ_»cov”y_¡©e
.
´im¬y_nic
 = -1;

3240 
g_”rÜ_»cov”y_¡©e
.
backup_nic
 = -1;

3243 
	`”rÜ_hªdlšg_š™
();

3244 
»suÉ
 = 
	`”rÜ_hªdlšg_š™
();

3245 ià(
»suÉ
 !ğ
SUCCESS
) {

3246 
	`LOG_ERROR
("FaedØš™Ÿliz”rÜ hªdlšg subsy¡em: %d", 
»suÉ
);

3247  
»suÉ
;

3250 
	`LOG_INFO
("Hardwareƒrror handling system initialized successfully");

3251  
SUCCESS
;

3252 
	}
}

3259 
	$h¬dw¬e_ü—‹_”rÜ_cÚ‹xt
(
nic_šfo_t
 *
nic
) {

3260 ià(!
nic
 ||‚ic->
šdex
 >ğ
MAX_NICS
) {

3261  
ERROR_INVALID_PARAM
;

3264 
	`LOG_DEBUG
("C»©šgƒ¼Ü hªdlšg cÚ‹xˆfÜ NIC %d", 
nic
->
šdex
);

3267 
	`memÜy_z”o
(
g_”rÜ_»cov”y_¡©e
.
”rÜ_couÁs
[
nic
->
šdex
],

3268 (
g_”rÜ_»cov”y_¡©e
.
”rÜ_couÁs
[
nic
->
šdex
]));

3269 
g_”rÜ_»cov”y_¡©e
.
Ï¡_”rÜ_time
[
nic
->
šdex
] = 0;

3270 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] = 0;

3271 
g_”rÜ_»cov”y_¡©e
.
»cov”y_©‹m±s
[
nic
->
šdex
] = 0;

3272 
g_”rÜ_»cov”y_¡©e
.
Ï¡_»cov”y_time
[
nic
->
šdex
] = 0;

3275 
	`ü—‹_ad­‹r_”rÜ_cÚ‹xt
(
nic_šfo_t
 *
nic
);

3276 
»suÉ
 = 
	`ü—‹_ad­‹r_”rÜ_cÚ‹xt
(
nic
);

3277 ià(
»suÉ
 !ğ
SUCCESS
) {

3278 
	`LOG_WARNING
("Failedo create‡dapterƒrror context for NIC %d: %d",

3279 
nic
->
šdex
, 
»suÉ
);

3283 
	`LOG_DEBUG
("E¼Ü hªdlšg cÚ‹xˆü—‹d fÜ NIC %d", 
nic
->
šdex
);

3284  
SUCCESS
;

3285 
	}
}

3294 
	$h¬dw¬e_hªdË_”rÜ
(
nic_šfo_t
 *
nic
, 
”rÜ_ty³
, 
ušt32_t
 
”rÜ_d©a
) {

3295 ià(!
nic
 ||‚ic->
šdex
 >ğ
MAX_NICS
) {

3296  
ERROR_INVALID_PARAM
;

3300 
ušt32_t
 
cu¼’t_time
 = 
	`h¬dw¬e_g‘_time¡amp
();

3301 
g_”rÜ_»cov”y_¡©e
.
”rÜ_couÁs
[
nic
->
šdex
][
”rÜ_ty³
]++;

3302 
g_”rÜ_»cov”y_¡©e
.
Ï¡_”rÜ_time
[
nic
->
šdex
] = 
cu¼’t_time
;

3303 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
]++;

3304 
g_”rÜ_»cov”y_¡©e
.
tÙ®_çu»s
++;

3307 
	`h¬dw¬e_log_çu»
(
nic
, 
”rÜ_ty³
, "Hardwareƒrror occurred");

3310 
boŞ
 
is_ü™iÿl
 = 
	`h¬dw¬e_is_ü™iÿl_çu»
(
”rÜ_ty³
);

3313 ià(
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] >ğ
MAX_CONSECUTIVE_ERRORS
 ||

3314 
is_ü™iÿl
) {

3316 
	`LOG_WARNING
("Initiatingƒrror„ecovery for NIC %d (errorype %d)",

3317 
nic
->
šdex
, 
”rÜ_ty³
);

3319 
»cov”y_»suÉ
 = 
	`h¬dw¬e_»cov”_nic
(
nic
, 
”rÜ_ty³
);

3320 ià(
»cov”y_»suÉ
 =ğ
SUCCESS
) {

3321 
g_”rÜ_»cov”y_¡©e
.
sucûssful_»cov”›s
++;

3322 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[
nic
->
šdex
] = 0;

3323 
	`LOG_INFO
("SucûssfuÎy„ecov”ed NIC %d fromƒ¼Ü", 
nic
->
šdex
);

3325 
	`LOG_ERROR
("FaedØ»cov” NIC %d fromƒ¼Ü: %d", 
nic
->
šdex
, 
»cov”y_»suÉ
);

3328 ià(
g_num_nics
 > 1) {

3329 
	`h¬dw¬e_©‹m±_çov”
(
nic
->
šdex
);

3331 
	`h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic
);

3335  
»cov”y_»suÉ
;

3339 
	`LOG_DEBUG
("Non-criticalƒrror %d on NIC %d (consecutive: %d)",

3340 
”rÜ_ty³
, 
nic
->
šdex
, 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[nic->index]);

3342  
SUCCESS
;

3343 
	}
}

3349 
ušt32_t
 
	$h¬dw¬e_g‘_time¡amp
() {

3351 
ušt32_t
 
tick_couÁ”
 = 0;

3352  ++
tick_couÁ”
;

3353 
	}
}

3365 
	$h¬dw¬e_»cov”_nic
(
nic_šfo_t
 *
nic
, 
çu»_ty³
) {

3366 ià(!
nic
) {

3367  
ERROR_INVALID_PARAM
;

3370 
	`LOG_INFO
("A‰em±šg„ecov”y oàNIC %d from fau»y³ %d", 
nic
->
šdex
, 
çu»_ty³
);

3372 
g_”rÜ_»cov”y_¡©e
.
»cov”y_©‹m±s
[
nic
->
šdex
]++;

3373 
g_”rÜ_»cov”y_¡©e
.
Ï¡_»cov”y_time
[
nic
->
šdex
] = 
	`h¬dw¬e_g‘_time¡amp
();

3376 
»cov”y_¡¿‹gy
 = 
RECOVERY_SOFT_RESET
;

3378 
çu»_ty³
) {

3379 
HW_FAILURE_LINK_LOST
:

3380 
»cov”y_¡¿‹gy
 = 
RECOVERY_SOFT_RESET
;

3382 
HW_FAILURE_TX_TIMEOUT
:

3383 
HW_FAILURE_RX_TIMEOUT
:

3384 
»cov”y_¡¿‹gy
 = 
RECOVERY_HARD_RESET
;

3386 
HW_FAILURE_FIFO_OVERRUN
:

3387 
HW_FAILURE_DMA_ERROR
:

3388 
»cov”y_¡¿‹gy
 = 
RECOVERY_REINITIALIZE
;

3390 
HW_FAILURE_REGISTER_CORRUPTION
:

3391 
HW_FAILURE_CRITICAL
:

3392 
»cov”y_¡¿‹gy
 = 
RECOVERY_REINITIALIZE
;

3395 
»cov”y_¡¿‹gy
 = 
RECOVERY_SOFT_RESET
;

3400 
»suÉ
 = 
ERROR_HARDWARE
;

3402 
»cov”y_¡¿‹gy
) {

3403 
RECOVERY_SOFT_RESET
:

3404 
	`LOG_DEBUG
("P”fÜmšg soá„e£ˆÚ NIC %d", 
nic
->
šdex
);

3405 ià(
nic
->
İs
 &&‚ic->İs->
»£t
) {

3406 
»suÉ
 = 
nic
->
İs
->
	`»£t
(nic);

3410 
RECOVERY_HARD_RESET
:

3411 
	`LOG_DEBUG
("P”fÜmšg h¬d„e£ˆÚ NIC %d", 
nic
->
šdex
);

3412 
»suÉ
 = 
	`h¬dw¬e_em”g’cy_»£t
(
nic
);

3415 
RECOVERY_REINITIALIZE
:

3416 
	`LOG_DEBUG
("Reš™Ÿlizšg NIC %d", 
nic
->
šdex
);

3417 ià(
nic
->
İs
 &&‚ic->İs->
ş—nup
) {

3418 
nic
->
İs
->
	`ş—nup
(nic);

3420 ià(
nic
->
İs
 &&‚ic->İs->
š™
) {

3421 
»suÉ
 = 
nic
->
İs
->
	`š™
(nic);

3426 
	`LOG_ERROR
("UnknowÀ»cov”y sŒ©egy: %d", 
»cov”y_¡¿‹gy
);

3431 ià(
»suÉ
 =ğ
SUCCESS
) {

3432 
»suÉ
 = 
	`h¬dw¬e_v®id©e_»cov”y
(
nic
);

3433 ià(
»suÉ
 =ğ
SUCCESS
) {

3434 
	`LOG_INFO
("SucûssfuÎy„ecov”ed NIC %d usšg sŒ©egy %d", 
nic
->
šdex
, 
»cov”y_¡¿‹gy
);

3438 ià(
»suÉ
 !ğ
SUCCESS
) {

3439 
	`LOG_ERROR
("Recov”y faed fÜ NIC %d (¡¿‹gy %d): %d", 
nic
->
šdex
, 
»cov”y_¡¿‹gy
, 
»suÉ
);

3442  
»suÉ
;

3443 
	}
}

3450 
	$h¬dw¬e_©‹m±_çov”
(
çed_nic_šdex
) {

3451 ià(
çed_nic_šdex
 >ğ
MAX_NICS
) {

3452  
ERROR_INVALID_PARAM
;

3455 
	`LOG_WARNING
("A‰em±šg faov” from NIC %d", 
çed_nic_šdex
);

3458 
backup_nic
 = -1;

3459 
i
 = 0; i < 
g_num_nics
; i++) {

3460 ià(
i
 !ğ
çed_nic_šdex
 &&

3461 (
g_nic_šfos
[
i
].
¡©us
 & 
NIC_STATUS_ACTIVE
) &&

3462 !(
g_nic_šfos
[
i
].
¡©us
 & 
NIC_STATUS_ERROR
)) {

3463 
backup_nic
 = 
i
;

3468 ià(
backup_nic
 == -1) {

3469 
	`LOG_ERROR
("No suitable backup NIC found for failover");

3470  
ERROR_NOT_FOUND
;

3474 
g_”rÜ_»cov”y_¡©e
.
çov”_š_´og»ss
 = 
Œue
;

3475 
g_”rÜ_»cov”y_¡©e
.
´im¬y_nic
 = 
backup_nic
;

3476 
g_”rÜ_»cov”y_¡©e
.
backup_nic
 = 
çed_nic_šdex
;

3477 
g_”rÜ_»cov”y_¡©e
.
çov”s
++;

3480 
g_nic_šfos
[
çed_nic_šdex
].
¡©us
 |ğ
NIC_STATUS_ERROR
;

3481 
g_nic_šfos
[
çed_nic_šdex
].
¡©us
 &ğ~
NIC_STATUS_ACTIVE
;

3484 
	`h¬dw¬e_nÙify_­¶iÿtiÚ_”rÜ
(
çed_nic_šdex
, 
ERROR_HARDWARE
);

3486 
	`LOG_INFO
("Faov” com¶‘ed: NIC %d -> NIC %d", 
çed_nic_šdex
, 
backup_nic
);

3488  
SUCCESS
;

3489 
	}
}

3495 
	$h¬dw¬e_g¿ûful_deg¿d©iÚ
(
nic_šfo_t
 *
nic
) {

3496 ià(!
nic
) {

3500 
	`LOG_WARNING
("In™Ÿtšg g¿ûfuÈdeg¿d©iÚ fÜ NIC %d", 
nic
->
šdex
);

3503 
nic
->
¡©us
 |ğ
NIC_STATUS_DEGRADED
;

3506 ià(
nic
->
ÿ·b™›s
 & 
HW_CAP_DMA
) {

3507 
	`LOG_DEBUG
("Di§blšg DMA fÜ NIC %d", 
nic
->
šdex
);

3511 ià(
nic
->
ÿ·b™›s
 & 
HW_CAP_FULL_DUPLEX
) {

3512 
	`LOG_DEBUG
("FÜcšg h®f-du¶ex fÜ NIC %d", 
nic
->
šdex
);

3517 ià(
nic
->
¥“d
 > 10) {

3518 
	`LOG_DEBUG
("Reducšg s³edØ10Mbp fÜ NIC %d", 
nic
->
šdex
);

3519 
nic
->
¥“d
 = 10;

3523 
nic
->
tx_timeout
 =‚ic->tx_timeout * 2;

3524 
nic
->
rx_timeout
 =‚ic->rx_timeout * 2;

3526 
	`LOG_INFO
("NIC %d o³¿tšg iÀdeg¿ded mode", 
nic
->
šdex
);

3527 
	}
}

3534 
	$h¬dw¬e_v®id©e_»cov”y
(
nic_šfo_t
 *
nic
) {

3535 ià(!
nic
) {

3536  
ERROR_INVALID_PARAM
;

3539 
	`LOG_DEBUG
("V®id©šg„ecov”y fÜ NIC %d", 
nic
->
šdex
);

3542 ià(
nic
->
İs
 &&‚ic->İs->
g‘_lšk_¡©us
) {

3543 
lšk_¡©us
 = 
nic
->
İs
->
	`g‘_lšk_¡©us
(nic);

3544 ià(
lšk_¡©us
 < 0) {

3545 
	`LOG_ERROR
("NIC %d‚Ù„e¥ÚdšgØlšk stu qu”y", 
nic
->
šdex
);

3546  
ERROR_HARDWARE
;

3554 
nic
->
¡©us
 &ğ~
NIC_STATUS_ERROR
;

3556 
	`LOG_DEBUG
("Recov”y v®id©iÚ sucûssfuÈfÜ NIC %d", 
nic
->
šdex
);

3557  
SUCCESS
;

3558 
	}
}

3566 
	$h¬dw¬e_log_çu»
(
nic_šfo_t
 *
nic
, 
çu»_ty³
, cÚ¡ * 
d‘as
) {

3567 ià(!
nic
 || !
d‘as
) {

3571 cÚ¡ * 
çu»_Çmes
[] = {

3577 cÚ¡ * 
çu»_Çme
 = (
çu»_ty³
 < 12è? 
çu»_Çmes
[failure_type] : "Unknown";

3579 
	`LOG_ERROR
("NIC %d Fau»: % (%dè- %s", 
nic
->
šdex
, 
çu»_Çme
, 
çu»_ty³
, 
d‘as
);

3582 
	`LOG_DEBUG
("NIC %d Status: 0x%X, Consecutive Errors: %d",

3583 
nic
->
šdex
,‚ic->
¡©us
, 
g_”rÜ_»cov”y_¡©e
.
cÚ£cutive_”rÜs
[nic->index]);

3584 
	}
}

3591 
	$h¬dw¬e_em”g’cy_»£t
(
nic_šfo_t
 *
nic
) {

3592 ià(!
nic
) {

3593  
ERROR_INVALID_PARAM
;

3596 
	`LOG_WARNING
("P”fÜmšgƒm”g’cy„e£ˆÚ NIC %d", 
nic
->
šdex
);

3602 
i
 = 0; i < 100; i++) {

3608 ià(
nic
->
İs
 &&‚ic->İs->
š™
) {

3609  
nic
->
İs
->
	`š™
(nic);

3612  
SUCCESS
;

3613 
	}
}

3620 
boŞ
 
	$h¬dw¬e_is_ü™iÿl_çu»
(
çu»_ty³
) {

3621 
çu»_ty³
) {

3622 
HW_FAILURE_REGISTER_CORRUPTION
:

3623 
HW_FAILURE_MEMORY_ERROR
:

3624 
HW_FAILURE_CRITICAL
:

3625 
HW_FAILURE_THERMAL
:

3626 
HW_FAILURE_POWER
:

3627  
Œue
;

3629  
çl£
;

3631 
	}
}

3638 
	$h¬dw¬e_nÙify_­¶iÿtiÚ_”rÜ
(
nic_šdex
, 
”rÜ_ty³
) {

3639 
	`LOG_INFO
("NÙifyšg‡µliÿtiÚ oà”rÜ oÀNIC %d (ty³ %d)", 
nic_šdex
, 
”rÜ_ty³
);

3641 
	}
}

3648 
ušt32_t
 
	$h¬dw¬e_ÿlcuÏ‹_»cov”y_timeout
(
çu»_ty³
) {

3649 
çu»_ty³
) {

3650 
HW_FAILURE_LINK_LOST
:

3652 
HW_FAILURE_TX_TIMEOUT
:

3653 
HW_FAILURE_RX_TIMEOUT
:

3655 
HW_FAILURE_DMA_ERROR
:

3656 
HW_FAILURE_FIFO_OVERRUN
:

3661 
	}
}

3668 cÚ¡ * 
	$h®_medŸ_ty³_to_¡ršg
(
medŸ_ty³
) {

3669 
medŸ_ty³
) {

3670 
HAL_MEDIA_AUTO
:  "Auto-negotiate";

3671 
HAL_MEDIA_10_HALF
:  "10 Mbps Half-duplex";

3672 
HAL_MEDIA_10_FULL
:  "10 Mbps Full-duplex";

3673 
HAL_MEDIA_100_HALF
:  "100 Mbps Half-duplex";

3674 
HAL_MEDIA_100_FULL
:  "100 Mbps Full-duplex";

3677 
	}
}

3684 
	$h¬dw¬e_check_tx_com¶‘e
(
nic_šfo_t
 *
nic
) {

3685 ià(!
nic
) {

3686  
ERROR_INVALID_PARAM
;

3689 ià(!
g_h¬dw¬e_š™Ÿlized
) {

3690  
ERROR_NOT_INITIALIZED
;

3693 ià(!
nic
->
İs
 || !nic->İs->
check_tx_com¶‘e
) {

3698  
nic
->
İs
->
	`check_tx_com¶‘e
(nic);

3699 
	}
}

3706 
	$h¬dw¬e_check_rx_avaabË
(
nic_šfo_t
 *
nic
) {

3707 ià(!
nic
) {

3708  
ERROR_INVALID_PARAM
;

3711 ià(!
g_h¬dw¬e_š™Ÿlized
) {

3712  
ERROR_NOT_INITIALIZED
;

3715 ià(!
nic
->
İs
 || !nic->İs->
check_rx_avaabË
) {

3720  
nic
->
İs
->
	`check_rx_avaabË
(nic);

3721 
	}
}

3724 
_3c509b_check_tx_com¶‘e
(
nic_šfo
 *
nic
);

3725 
_3c509b_check_rx_avaabË
(
nic_šfo
 *
nic
);

3726 
_3c515_check_tx_com¶‘e
(
nic_šfo
 *
nic
);

3727 
_3c515_check_rx_avaabË
(
nic_šfo
 *
nic
);

3730 
	$_3c509b_check_tx_com¶‘e
(
nic_šfo
 *
nic
) {

3731 ià(!
nic
è 
ERROR_INVALID_PARAM
;

3734 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
EL3_STATUS
);

3735 ià(
¡©us
 & 
TxCom¶‘e
) {

3737 
	`outw
(
AckIÁr
 | 
TxCom¶‘e
, 
nic
->
io_ba£
 + 
EL3_CMD
);

3741 
	}
}

3743 
	$_3c509b_check_rx_avaabË
(
nic_šfo
 *
nic
) {

3744 ià(!
nic
è 
ERROR_INVALID_PARAM
;

3747 
	`EL3WINDOW
(
nic
, 1);

3748 
ušt16_t
 
rx_¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 0x08);

3749  (
rx_¡©us
 > 0) ? 1 : 0;

3750 
	}
}

3753 
	$_3c515_check_tx_com¶‘e
(
nic_šfo
 *
nic
) {

3754 ià(!
nic
è 
ERROR_INVALID_PARAM
;

3757 
	`EL3WINDOW
(
nic
, 1);

3758 
ušt8_t
 
tx_¡©us
 = 
	`šb
(
nic
->
io_ba£
 + 0x1B);

3760 ià(
tx_¡©us
) {

3762 
	`outb
(
tx_¡©us
, 
nic
->
io_ba£
 + 0x1B);

3766 
	}
}

3768 
	$_3c515_check_rx_avaabË
(
nic_šfo
 *
nic
) {

3769 ià(!
nic
è 
ERROR_INVALID_PARAM
;

3772 
	`EL3WINDOW
(
nic
, 1);

3773 
ušt16_t
 
rx_¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 0x18);

3774  (
rx_¡©us
 > 0) ? 1 : 0;

3775 
	}
}

3782 
ušt32_t
 
	$h¬dw¬e_g‘_Ï¡_”rÜ_time
(
ušt8_t
 
nic_šdex
) {

3783 ià(
nic_šdex
 >ğ
MAX_NICS
) {

3786  
g_”rÜ_»cov”y_¡©e
.
Ï¡_”rÜ_time
[
nic_šdex
];

3787 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/media_control.c

22 
	~"../šşude/medŸ_cÚŒŞ.h
"

23 
	~"../šşude/3c509b.h
"

24 
	~"../šşude/nic_defs.h
"

25 
	~"../šşude/h¬dw¬e.h
"

26 
	~"../šşude/loggšg.h
"

27 
	~"../šşude/commÚ.h
"

28 
	~"../šşude/ıu_İtimized.h
"

29 
	~<¡ršg.h
>

33 
£Ëù_wšdow_§ã
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
wšdow
);

34 
wa™_fÜ_cmd_com¶‘iÚ
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
);

35 
ušt16_t
 
»ad_medŸ_cÚŒŞ_»gi¡”
(
nic_šfo_t
 *
nic
);

36 
wr™e_medŸ_cÚŒŞ_»gi¡”
(
nic_šfo_t
 *
nic
, 
ušt16_t
 
v®ue
);

37 
ušt16_t
 
»ad_ÃtwÜk_dŸgno¡ics_»gi¡”
(
nic_šfo_t
 *
nic
);

38 
‹¡_medŸ_lšk_qu®™y
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
,

39 
ušt32_t
 
‹¡_du¿tiÚ_ms
, 
lšk_‹¡_»suÉ_t
 *
»suÉ
);

40 
medŸ_ty³_t
 
d‘eù_be¡_medŸ_fÜ_v¬ŸÁ
(
nic_šfo_t
 *
nic
, cÚ¡ 
medŸ_d‘eù_cÚfig_t
 *
cÚfig
);

41 
cÚfigu»_medŸ_¥ecific_»gi¡”s
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
, 
boŞ
 
fuÎ_du¶ex
);

48 
	$§ã_£Ëù_wšdow
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
wšdow
, 
ušt32_t
 
timeout_ms
) {

49 ià(!
nic
 || 
wšdow
 > 7) {

50 
	`LOG_ERROR
("Invalid…arameters for window selection");

51  
ERROR_INVALID_PARAM
;

55 
»suÉ
 = 
	`wa™_fÜ_commªd_»ady
(
nic
, 
timeout_ms
);

56 ià(
»suÉ
 !ğ
SUCCESS
) {

57 
	`LOG_ERROR
("Command‚ot„eady before window selection");

58  
MEDIA_ERROR_WINDOW_TIMEOUT
;

62 
ušt16_t
 
cmd
 = 
_3C509B_CMD_SELECT_WINDOW
 | 
wšdow
;

63 
	`ıu_İt_outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
cmd
);

66 
»suÉ
 = 
	`wa™_fÜ_cmd_com¶‘iÚ
(
nic
, 
timeout_ms
);

67 ià(
»suÉ
 !ğ
SUCCESS
) {

68 
	`LOG_ERROR
("Wšdow %d s–eùiÚimeout", 
wšdow
);

69  
MEDIA_ERROR_WINDOW_TIMEOUT
;

72 
	`LOG_TRACE
("S–eùed wšdow %d", 
wšdow
);

73  
SUCCESS
;

74 
	}
}

79 
	$g‘_cu¼’t_wšdow
(
nic_šfo_t
 *
nic
) {

80 ià(!
nic
) {

86 
	`LOG_DEBUG
("Current window query -racking‚ot implemented");

88 
	}
}

93 
	$§ve_ªd_£Ëù_wšdow
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
Ãw_wšdow
, ušt8_ˆ*
§ved_wšdow
) {

94 ià(!
nic
 || !
§ved_wšdow
) {

95  
ERROR_INVALID_PARAM
;

100 *
§ved_wšdow
 = 1;

102  
	`§ã_£Ëù_wšdow
(
nic
, 
Ãw_wšdow
, 
WINDOW_SELECT_TIMEOUT_MS
);

103 
	}
}

108 
	$»¡Üe_wšdow
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
§ved_wšdow
) {

109 ià(!
nic
) {

110  
ERROR_INVALID_PARAM
;

113  
	`§ã_£Ëù_wšdow
(
nic
, 
§ved_wšdow
, 
WINDOW_SELECT_TIMEOUT_MS
);

114 
	}
}

119 
	$wa™_fÜ_commªd_»ady
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
) {

120 ià(!
nic
) {

121  
ERROR_INVALID_PARAM
;

124 
ušt32_t
 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

126 
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
 < 
timeout_ms
) {

127 
ušt16_t
 
¡©us
 = 
	`ıu_İt_šw
(
nic
->
io_ba£
 + 
_3C509B_STATUS_REG
);

129 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

130  
SUCCESS
;

133 
	`ıu_İt_ud–ay
(100);

136 
	`LOG_ERROR
("Commªd„—dyimeouˆaá” %u ms", 
timeout_ms
);

137  
ERROR_TIMEOUT
;

138 
	}
}

145 
	$£Ëù_medŸ_Œªsûiv”
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
, 
ušt8_t
 
æags
) {

146 ià(!
nic
) {

147 
	`LOG_ERROR
("Invalid NIC…ointer");

148  
ERROR_INVALID_PARAM
;

151 
	`LOG_INFO
("S–eùšg medŸ¿nsûiv”: %s", 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
));

154 ià(!(
æags
 & 
MEDIA_CTRL_FLAG_FORCE
)) {

155 
v®id©iÚ
 = 
	`v®id©e_medŸ_£ËùiÚ
(
nic
, 
medŸ_ty³
, 
NULL
, 0);

156 ià(
v®id©iÚ
 !ğ
SUCCESS
) {

157 
	`LOG_ERROR
("MedŸ v®id©iÚ faed: %d", 
v®id©iÚ
);

158  
v®id©iÚ
;

162 
ušt8_t
 
§ved_wšdow
;

163 
»suÉ
 = 
	`§ve_ªd_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_4
, &
§ved_wšdow
);

164 ià(
»suÉ
 !ğ
SUCCESS
) {

165 
	`LOG_ERROR
("FaedØ£Ëù Wšdow 4: %d", 
»suÉ
);

166  
»suÉ
;

170 
»suÉ
 = 
	`cÚfigu»_medŸ_»gi¡”s
(
nic
, 
medŸ_ty³
,

171 (
æags
 & 
MEDIA_CTRL_FLAG_PRESERVE_DUPLEX
) ?

172 
nic
->
fuÎ_du¶ex
 : 
çl£
);

174 ià(
»suÉ
 !ğ
SUCCESS
) {

175 
	`LOG_ERROR
("FaedØcÚfigu» medŸ„egi¡”s: %d", 
»suÉ
);

176 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

177  
»suÉ
;

181 
	`md–ay
(
MEDIA_SWITCH_DELAY_MS
);

184 ià(!(
æags
 & 
MEDIA_CTRL_FLAG_NO_AUTO_DETECT
)) {

185 
lšk_‹¡_»suÉ_t
 
‹¡_»suÉ
;

186 
»suÉ
 = 
	`‹¡_lšk_b—t
(
nic
, 
medŸ_ty³
, 
MEDIA_TEST_DURATION_10BASET_MS
, &
‹¡_»suÉ
);

188 ià(
»suÉ
 !ğ
SUCCESS
) {

189 
	`LOG_WARNING
("Lške¡ faed fÜ %s: %d", 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
), 
»suÉ
);

190 ià(!(
æags
 & 
MEDIA_CTRL_FLAG_FORCE
)) {

191 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

192  
MEDIA_ERROR_NO_LINK
;

195 
	`LOG_INFO
("Lške¡…as£d fÜ %s", 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
));

200 
nic
->
cu¼’t_medŸ
 = 
medŸ_ty³
;

201 
nic
->
medŸ_cÚfig_sourû
 = (
æags
 & 
MEDIA_CTRL_FLAG_FORCE
) ?

202 
MEDIA_CONFIG_USER_FORCED
 : 
MEDIA_CONFIG_AUTO_DETECT
;

204 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

206 
	`LOG_INFO
("SucûssfuÎy s–eùed medŸ: %s", 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
));

207  
SUCCESS
;

208 
	}
}

213 
medŸ_ty³_t
 
	$auto_d‘eù_medŸ
(
nic_šfo_t
 *
nic
, cÚ¡ 
medŸ_d‘eù_cÚfig_t
 *
cÚfig
) {

214 ià(!
nic
) {

215 
	`LOG_ERROR
("Invalid NIC…ointer");

216  
MEDIA_TYPE_UNKNOWN
;

220 
medŸ_d‘eù_cÚfig_t
 
deçuÉ_cÚfig
 = 
MEDIA_DETECT_CONFIG_DEFAULT
;

221 ià(!
cÚfig
) {

222 
cÚfig
 = &
deçuÉ_cÚfig
;

225 
	`LOG_INFO
("S¹šg‡uto-d‘eùiÚ fÜ medŸy³ Ñimeout: %u ms)", 
cÚfig
->
timeout_ms
);

228 ià(!(
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_AUTO_SELECT
)) {

229 
	`LOG_WARNING
("NIC does‚ot support‡uto-detection, using default media");

230  
	`g‘_deçuÉ_medŸ_fÜ_nic
(
nic
);

233 
ušt32_t
 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

234 
medŸ_ty³_t
 
d‘eùed_medŸ
 = 
MEDIA_TYPE_UNKNOWN
;

237 
ušt8_t
 
©‹m±
 = 0;‡‰em± < 
cÚfig
->
»Œy_couÁ
;‡ttempt++) {

238 ià(
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
 >ğ
cÚfig
->
timeout_ms
) {

239 
	`LOG_WARNING
("Auto-detectionimeout„eached");

243 
	`LOG_DEBUG
("Auto-d‘eùiÚ‡‰em± %d/%d", 
©‹m±
 + 1, 
cÚfig
->
»Œy_couÁ
);

245 
d‘eùed_medŸ
 = 
	`d‘eù_be¡_medŸ_fÜ_v¬ŸÁ
(
nic
, 
cÚfig
);

246 ià(
d‘eùed_medŸ
 !ğ
MEDIA_TYPE_UNKNOWN
) {

250 ià(
©‹m±
 < 
cÚfig
->
»Œy_couÁ
 - 1) {

251 
	`md–ay
(500);

255 ià(
d‘eùed_medŸ
 !ğ
MEDIA_TYPE_UNKNOWN
) {

256 
	`LOG_INFO
("Auto-d‘eùed medŸ: %s", 
	`medŸ_ty³_to_¡ršg
(
d‘eùed_medŸ
));

259 
»suÉ
 = 
	`£Ëù_medŸ_Œªsûiv”
(
nic
, 
d‘eùed_medŸ
, 0);

260 ià(
»suÉ
 !ğ
SUCCESS
) {

261 
	`LOG_ERROR
("FaedØcÚfigu»‡uto-d‘eùed medŸ: %d", 
»suÉ
);

262  
MEDIA_TYPE_UNKNOWN
;

265 
nic
->
d‘eùed_medŸ
 = detected_media;

266 
nic
->
medŸ_d‘eùiÚ_¡©e
 = 
MEDIA_DETECT_COMPLETED
;

268 
	`LOG_WARNING
("Auto-detection failed,‚o suitable media found");

269 
nic
->
medŸ_d‘eùiÚ_¡©e
 = 
MEDIA_DETECT_FAILED
;

272  
d‘eùed_medŸ
;

273 
	}
}

278 
	$‹¡_lšk_b—t
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
, 
ušt32_t
 
‹¡_du¿tiÚ_ms
,

279 
lšk_‹¡_»suÉ_t
 *
»suÉ
) {

280 ià(!
nic
 || !
»suÉ
) {

281  
ERROR_INVALID_PARAM
;

284 
	`LOG_DEBUG
("Testing†ink beat for %s (duration: %u ms)",

285 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
), 
‹¡_du¿tiÚ_ms
);

288 
	`ıu_İt_memz”o
(
»suÉ
, (
lšk_‹¡_»suÉ_t
));

289 
»suÉ
->
‹¡ed_medŸ
 = 
medŸ_ty³
;

291 
ušt8_t
 
§ved_wšdow
;

292 
»t
 = 
	`§ve_ªd_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_4
, &
§ved_wšdow
);

293 ià(
»t
 !ğ
SUCCESS
) {

294  
»t
;

298 
»t
 = 
	`cÚfigu»_medŸ_¥ecific_»gi¡”s
(
nic
, 
medŸ_ty³
, 
çl£
);

299 ià(
»t
 !ğ
SUCCESS
) {

300 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

301  
»t
;

305 
	`md–ay
(
MEDIA_STABILIZATION_DELAY_MS
);

307 
ušt32_t
 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

308 
ušt32_t
 
lšk_up_couÁ
 = 0;

309 
ušt32_t
 
tÙ®_checks
 = 0;

312 
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
 < 
‹¡_du¿tiÚ_ms
) {

313 
ušt16_t
 
ÃtdŸg
 = 
	`»ad_ÃtwÜk_dŸgno¡ics_»gi¡”
(
nic
);

314 
»suÉ
->
ÃtwÜk_dŸgno¡ics
 = 
ÃtdŸg
;

316 
boŞ
 
lšk_d‘eùed
 = 
çl£
;

319 
medŸ_ty³
) {

320 
MEDIA_TYPE_10BASE_T
:

322 
lšk_d‘eùed
 = (
ÃtdŸg
 & 0x0800) != 0;

323 ià(
lšk_d‘eùed
) {

324 
»suÉ
->
‹¡_æags
 |ğ
LINK_TEST_RESULT_LINK_UP
;

328 
MEDIA_TYPE_10BASE_2
:

330 
lšk_d‘eùed
 = 
Œue
;

331 
»suÉ
->
‹¡_æags
 |ğ
LINK_TEST_RESULT_CARRIER_DETECT
;

334 
MEDIA_TYPE_AUI
:

336 ià(
ÃtdŸg
 & 0x0200) {

337 
»suÉ
->
‹¡_æags
 |ğ
LINK_TEST_RESULT_SQE_TEST_PASSED
;

338 
lšk_d‘eùed
 = 
Œue
;

342 
MEDIA_TYPE_10BASE_FL
:

344 
lšk_d‘eùed
 = (
ÃtdŸg
 & 0x0800) != 0;

345 ià(
lšk_d‘eùed
) {

346 
»suÉ
->
‹¡_æags
 |ğ
LINK_TEST_RESULT_LINK_UP
;

351 
	`LOG_WARNING
("Lške¡‚Ù im¶em’‹d fÜ medŸy³ %d", 
medŸ_ty³
);

355 ià(
lšk_d‘eùed
) {

356 
lšk_up_couÁ
++;

359 
tÙ®_checks
++;

360 
	`ıu_İt_ud–ay
(
LINK_BEAT_CHECK_INTERVAL_MS
 * 1000);

363 
»suÉ
->
‹¡_du¿tiÚ_ms
 = 
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
;

364 
»suÉ
->
lšk_up_time_ms
 = (
lšk_up_couÁ
 * 
LINK_BEAT_CHECK_INTERVAL_MS
);

367 ià(
tÙ®_checks
 > 0) {

368 
»suÉ
->
sigÇl_qu®™y
 = (
ušt8_t
)((
lšk_up_couÁ
 * 100è/ 
tÙ®_checks
);

372 ià(
»suÉ
->
sigÇl_qu®™y
 > 80) {

373 
»suÉ
->
‹¡_æags
 |ğ
LINK_TEST_RESULT_LINK_STABLE
;

376 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

378 
	`LOG_DEBUG
("Linkest complete: quality=%d%%, up_time=%u ms",

379 
»suÉ
->
sigÇl_qu®™y
,„esuÉ->
lšk_up_time_ms
);

381  (
»suÉ
->
sigÇl_qu®™y
 > 50è? 
SUCCESS
 : 
MEDIA_ERROR_NO_LINK
;

382 
	}
}

387 
	$cÚfigu»_medŸ_»gi¡”s
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
, 
boŞ
 
’abË_fuÎ_du¶ex
) {

388 ià(!
nic
) {

389  
ERROR_INVALID_PARAM
;

392 
	`LOG_DEBUG
("Configuring media„egisters for %s (full_duplex=%d)",

393 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
), 
’abË_fuÎ_du¶ex
);

396 
»suÉ
 = 
	`§ã_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_4
, 
WINDOW_SELECT_TIMEOUT_MS
);

397 ià(
»suÉ
 !ğ
SUCCESS
) {

398  
»suÉ
;

401  
	`cÚfigu»_medŸ_¥ecific_»gi¡”s
(
nic
, 
medŸ_ty³
, 
’abË_fuÎ_du¶ex
);

402 
	}
}

407 
	$v®id©e_medŸ_£ËùiÚ
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
,

408 *
”rÜ_msg
, 
size_t
 
”rÜ_msg_size
) {

409 ià(!
nic
) {

410 ià(
”rÜ_msg
 && 
”rÜ_msg_size
 > 0) {

411 
	`¡ºıy
(
”rÜ_msg
, "Inv®id NIC…oš‹r", 
”rÜ_msg_size
 - 1);

412 
”rÜ_msg
[
”rÜ_msg_size
 - 1] = '\0';

414  
ERROR_INVALID_PARAM
;

418 ià(
medŸ_ty³
 =ğ
MEDIA_TYPE_UNKNOWN
) {

419 ià(
”rÜ_msg
 && 
”rÜ_msg_size
 > 0) {

420 
	`¡ºıy
(
”rÜ_msg
, "UnknowÀmedŸy³", 
”rÜ_msg_size
 - 1);

421 
”rÜ_msg
[
”rÜ_msg_size
 - 1] = '\0';

423  
MEDIA_ERROR_INVALID_MEDIA
;

427 ià(!
	`is_medŸ_suµÜ‹d_by_nic
(
nic
, 
medŸ_ty³
)) {

428 ià(
”rÜ_msg
 && 
”rÜ_msg_size
 > 0) {

429 
	`¢´štf
(
”rÜ_msg
, 
”rÜ_msg_size
, "Media %s‚ot supported byhis NIC variant",

430 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
));

432  
MEDIA_ERROR_MEDIA_NOT_SUPPORTED
;

436 ià(
nic
->
¡©us
 & 
NIC_STATUS_ERROR
) {

437 ià(
”rÜ_msg
 && 
”rÜ_msg_size
 > 0) {

438 
	`¡ºıy
(
”rÜ_msg
, "NIC i šƒ¼Ü s‹", 
”rÜ_msg_size
 - 1);

439 
”rÜ_msg
[
”rÜ_msg_size
 - 1] = '\0';

441  
MEDIA_ERROR_VALIDATION_FAILED
;

444 
	`LOG_DEBUG
("MedŸ v®id©iÚ…as£d fÜ %s", 
	`medŸ_ty³_to_¡ršg
(
medŸ_ty³
));

445  
SUCCESS
;

446 
	}
}

453 
	$medŸ_cÚŒŞ_š™
(
nic_šfo_t
 *
nic
) {

454 ià(!
nic
) {

455  
ERROR_INVALID_PARAM
;

458 
	`LOG_DEBUG
("In™Ÿlizšg medŸ cÚŒŞ fÜ NICy³ %d", 
nic
->
ty³
);

461 
nic
->
cu¼’t_medŸ
 = 
MEDIA_TYPE_UNKNOWN
;

462 
nic
->
d‘eùed_medŸ
 = 
MEDIA_TYPE_UNKNOWN
;

463 
nic
->
medŸ_d‘eùiÚ_¡©e
 = 
MEDIA_DETECT_NONE
;

466 ià(
nic
->
ty³
 =ğ
NIC_TYPE_3C509B
) {

469 
nic
->
medŸ_ÿ·b™›s
 = 
MEDIA_CAPS_3C509B_COMBO
;

472 
	`LOG_INFO
("Media control initialized for NIC");

473  
SUCCESS
;

474 
	}
}

479 
	$medŸ_cÚŒŞ_ş—nup
(
nic_šfo_t
 *
nic
) {

480 ià(!
nic
) {

481  
ERROR_INVALID_PARAM
;

484 
	`LOG_DEBUG
("Cleaning up media control");

487 
nic
->
cu¼’t_medŸ
 = 
MEDIA_TYPE_UNKNOWN
;

488 
nic
->
d‘eùed_medŸ
 = 
MEDIA_TYPE_UNKNOWN
;

489 
nic
->
medŸ_d‘eùiÚ_¡©e
 = 
MEDIA_DETECT_NONE
;

491  
SUCCESS
;

492 
	}
}

497 
	$g‘_medŸ_cÚfig_¡©e
(
nic_šfo_t
 *
nic
, 
medŸ_cÚfig_¡©e_t
 *
¡©e
) {

498 ià(!
nic
 || !
¡©e
) {

499  
ERROR_INVALID_PARAM
;

502 
	`ıu_İt_memz”o
(
¡©e
, (
medŸ_cÚfig_¡©e_t
));

504 
¡©e
->
cu¼’t_medŸ
 = 
nic
->current_media;

505 
¡©e
->
d‘eùed_medŸ
 = 
nic
->detected_media;

506 
¡©e
->
d‘eùiÚ_¡©e
 = 
nic
->
medŸ_d‘eùiÚ_¡©e
;

507 
¡©e
->
Ï¡_cÚfig_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

510 
ušt8_t
 
§ved_wšdow
;

511 ià(
	`§ve_ªd_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_4
, &
§ved_wšdow
è=ğ
SUCCESS
) {

512 
¡©e
->
medŸ_cÚŒŞ_»gi¡”
 = 
	`»ad_medŸ_cÚŒŞ_»gi¡”
(
nic
);

513 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

516  
SUCCESS
;

517 
	}
}

524 
	$£Ëù_wšdow_§ã
(
nic_šfo_t
 *
nic
, 
ušt8_t
 
wšdow
) {

525  
	`§ã_£Ëù_wšdow
(
nic
, 
wšdow
, 
WINDOW_SELECT_TIMEOUT_MS
);

526 
	}
}

531 
	$wa™_fÜ_cmd_com¶‘iÚ
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
) {

532  
	`wa™_fÜ_commªd_»ady
(
nic
, 
timeout_ms
);

533 
	}
}

538 
ušt16_t
 
	$»ad_medŸ_cÚŒŞ_»gi¡”
(
nic_šfo_t
 *
nic
) {

539  
	`ıu_İt_šw
(
nic
->
io_ba£
 + 
_3C509B_MEDIA_CTRL
);

540 
	}
}

545 
	$wr™e_medŸ_cÚŒŞ_»gi¡”
(
nic_šfo_t
 *
nic
, 
ušt16_t
 
v®ue
) {

546 
	`ıu_İt_outw
(
nic
->
io_ba£
 + 
_3C509B_MEDIA_CTRL
, 
v®ue
);

547  
SUCCESS
;

548 
	}
}

553 
ušt16_t
 
	$»ad_ÃtwÜk_dŸgno¡ics_»gi¡”
(
nic_šfo_t
 *
nic
) {

554  
	`ıu_İt_šw
(
nic
->
io_ba£
 + 
_3C509B_W4_NETDIAG
);

555 
	}
}

560 
	$cÚfigu»_medŸ_¥ecific_»gi¡”s
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
, 
boŞ
 
fuÎ_du¶ex
) {

561 
ušt16_t
 
medŸ_ù¾_v®ue
 = 0;

563 
medŸ_ty³
) {

564 
MEDIA_TYPE_10BASE_T
:

565 
medŸ_ù¾_v®ue
 = 
_3C509B_MEDIA_TP
;

566 ià(
fuÎ_du¶ex
 && (
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_FULL_DUPLEX
)) {

567 
medŸ_ù¾_v®ue
 |ğ
_3C509B_FD_ENABLE
;

571 
MEDIA_TYPE_10BASE_2
:

572 
medŸ_ù¾_v®ue
 = 
_3C509B_MEDIA_BNC
;

574 
	`ıu_İt_outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_START_COAX
);

575 
	`wa™_fÜ_cmd_com¶‘iÚ
(
nic
, 1000);

578 
MEDIA_TYPE_AUI
:

579 
medŸ_ù¾_v®ue
 = 
_3C509B_MEDIA_AUI
 | 
_3C509B_MEDIA_SQE
;

582 
MEDIA_TYPE_10BASE_FL
:

583 
medŸ_ù¾_v®ue
 = 
_3C509B_MEDIA_TP
;

584 ià(
fuÎ_du¶ex
) {

585 
medŸ_ù¾_v®ue
 |ğ
_3C509B_FD_ENABLE
;

590 
	`LOG_ERROR
("UnsuµÜ‹d medŸy³: %d", 
medŸ_ty³
);

591  
MEDIA_ERROR_MEDIA_NOT_SUPPORTED
;

595 
»suÉ
 = 
	`wr™e_medŸ_cÚŒŞ_»gi¡”
(
nic
, 
medŸ_ù¾_v®ue
);

596 ià(
»suÉ
 !ğ
SUCCESS
) {

597 
	`LOG_ERROR
("Failedo write media control„egister");

598  
MEDIA_ERROR_REGISTER_ACCESS
;

601 
	`LOG_DEBUG
("CÚfigu»d medŸ„egi¡”s: 0x%04X", 
medŸ_ù¾_v®ue
);

602  
SUCCESS
;

603 
	}
}

608 
medŸ_ty³_t
 
	$d‘eù_be¡_medŸ_fÜ_v¬ŸÁ
(
nic_šfo_t
 *
nic
, cÚ¡ 
medŸ_d‘eù_cÚfig_t
 *
cÚfig
) {

610 
medŸ_ty³_t
 
‹¡_Üd”
[] = {

611 
MEDIA_TYPE_10BASE_T
,

612 
MEDIA_TYPE_AUI
,

613 
MEDIA_TYPE_10BASE_2


616 
size_t
 
num_medŸ_ty³s
 = (
‹¡_Üd”
) / (test_order[0]);

618 
size_t
 
i
 = 0; i < 
num_medŸ_ty³s
; i++) {

619 
medŸ_ty³_t
 
medŸ
 = 
‹¡_Üd”
[
i
];

622 ià(!
	`is_medŸ_suµÜ‹d_by_nic
(
nic
, 
medŸ
)) {

626 
	`LOG_DEBUG
("Te¡šg medŸ: %s", 
	`medŸ_ty³_to_¡ršg
(
medŸ
));

628 
lšk_‹¡_»suÉ_t
 
‹¡_»suÉ
;

629 
»suÉ
 = 
	`‹¡_lšk_b—t
(
nic
, 
medŸ
, 
cÚfig
->
‹¡_du¿tiÚ_ms
, &
‹¡_»suÉ
);

631 ià(
»suÉ
 =ğ
SUCCESS
 && 
‹¡_»suÉ
.
sigÇl_qu®™y
 > 70) {

632 
	`LOG_INFO
("Detected working media: %s (quality: %d%%)",

633 
	`medŸ_ty³_to_¡ršg
(
medŸ
), 
‹¡_»suÉ
.
sigÇl_qu®™y
);

634  
medŸ
;

638 
	`LOG_WARNING
("No working media detected");

639  
MEDIA_TYPE_UNKNOWN
;

640 
	}
}

647 
	$is_medŸ_suµÜ‹d_by_nic
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
) {

648 ià(!
nic
) {

652 
medŸ_ty³
) {

653 
MEDIA_TYPE_10BASE_T
:

654  (
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_10BASE_T
) != 0;

655 
MEDIA_TYPE_10BASE_2
:

656  (
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_10BASE_2
) != 0;

657 
MEDIA_TYPE_AUI
:

658  (
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_AUI
) != 0;

659 
MEDIA_TYPE_10BASE_FL
:

660  (
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_10BASE_FL
) != 0;

664 
	}
}

669 
medŸ_ty³_t
 
	$g‘_deçuÉ_medŸ_fÜ_nic
(
nic_šfo_t
 *
nic
) {

670 ià(!
nic
) {

671  
MEDIA_TYPE_UNKNOWN
;

675 ià(
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_10BASE_T
) {

676  
MEDIA_TYPE_10BASE_T
;

678 ià(
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_AUI
) {

679  
MEDIA_TYPE_AUI
;

681 ià(
nic
->
medŸ_ÿ·b™›s
 & 
MEDIA_CAP_10BASE_2
) {

682  
MEDIA_TYPE_10BASE_2
;

685  
MEDIA_TYPE_UNKNOWN
;

686 
	}
}

691 cÚ¡ * 
	$medŸ_”rÜ_to_¡ršg
(
”rÜ_code
) {

692 
”rÜ_code
) {

693 
MEDIA_ERROR_NONE
:  "Noƒrror";

694 
MEDIA_ERROR_INVALID_MEDIA
:  "Invalid mediaype";

695 
MEDIA_ERROR_MEDIA_NOT_SUPPORTED
:  "Media‚ot supported";

696 
MEDIA_ERROR_NO_LINK
:  "No†ink detected";

697 
MEDIA_ERROR_LINK_TEST_FAILED
:  "Linkest failed";

698 
MEDIA_ERROR_AUTO_DETECT_FAILED
:  "Auto-detection failed";

699 
MEDIA_ERROR_REGISTER_ACCESS
:  "Register‡ccess failed";

700 
MEDIA_ERROR_WINDOW_TIMEOUT
:  "Window selectionimeout";

701 
MEDIA_ERROR_TRANSCEIVER_FAULT
:  "Transceiver fault";

702 
MEDIA_ERROR_MEDIA_CONFLICT
:  "Media configuration conflict";

703 
MEDIA_ERROR_VALIDATION_FAILED
:  "Media validation failed";

706 
	}
}

711 
ušt8_t
 
	$g‘_medŸ_d‘eùiÚ_´iÜ™y
(
medŸ_ty³_t
 
medŸ_ty³
, 
ušt8_t
 
nic_v¬ŸÁ
) {

713 
medŸ_ty³
) {

714 
MEDIA_TYPE_10BASE_T
:  1;

715 
MEDIA_TYPE_AUI
:  2;

716 
MEDIA_TYPE_10BASE_2
:  3;

717 
MEDIA_TYPE_10BASE_FL
:  4;

720 
	}
}

725 
	$check_medŸ_lšk_¡©us
(
nic_šfo_t
 *
nic
) {

726 ià(!
nic
) {

730 
ušt8_t
 
§ved_wšdow
;

731 
»suÉ
 = 
	`§ve_ªd_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_4
, &
§ved_wšdow
);

732 ià(
»suÉ
 !ğ
SUCCESS
) {

736 
ušt16_t
 
ÃtdŸg
 = 
	`»ad_ÃtwÜk_dŸgno¡ics_»gi¡”
(
nic
);

737 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

740 
nic
->
cu¼’t_medŸ
) {

741 
MEDIA_TYPE_10BASE_T
:

742 
MEDIA_TYPE_10BASE_FL
:

743  (
ÃtdŸg
 & 0x0800) ? 1 : 0;

744 
MEDIA_TYPE_AUI
:

745  (
ÃtdŸg
 & 0x0200) ? 1 : 0;

746 
MEDIA_TYPE_10BASE_2
:

751 
	}
}

756 
	$run_medŸ_dŸgno¡ics
(
nic_šfo_t
 *
nic
, 
boŞ
 
‹¡_®l_medŸ
) {

757 ià(!
nic
) {

758  
ERROR_INVALID_PARAM
;

761 
	`LOG_INFO
("RuÂšg medŸ dŸgno¡ic Ñe¡_®l=%d)", 
‹¡_®l_medŸ
);

763 
”rÜs
 = 0;

765 ià(
‹¡_®l_medŸ
) {

767 
medŸ_ty³_t
 
‹¡_medŸ
[] = {

768 
MEDIA_TYPE_10BASE_T
, 
MEDIA_TYPE_10BASE_2
,

769 
MEDIA_TYPE_AUI
, 
MEDIA_TYPE_10BASE_FL


772 
size_t
 
i
 = 0; i < (
‹¡_medŸ
) / (test_media[0]); i++) {

773 ià(
	`is_medŸ_suµÜ‹d_by_nic
(
nic
, 
‹¡_medŸ
[
i
])) {

774 
lšk_‹¡_»suÉ_t
 
»suÉ
;

775 
‹¡_»suÉ
 = 
	`‹¡_lšk_b—t
(
nic
, 
‹¡_medŸ
[
i
], 1000, &
»suÉ
);

777 
	`LOG_INFO
("Media %sest: %s (quality: %d%%)",

778 
	`medŸ_ty³_to_¡ršg
(
‹¡_medŸ
[
i
]),

779 (
‹¡_»suÉ
 =ğ
SUCCESS
) ? "PASS" : "FAIL",

780 
»suÉ
.
sigÇl_qu®™y
);

782 ià(
‹¡_»suÉ
 !ğ
SUCCESS
) {

783 
”rÜs
++;

789 ià(
nic
->
cu¼’t_medŸ
 !ğ
MEDIA_TYPE_UNKNOWN
) {

790 
lšk_‹¡_»suÉ_t
 
»suÉ
;

791 
‹¡_»suÉ
 = 
	`‹¡_lšk_b—t
(
nic
,‚ic->
cu¼’t_medŸ
, 2000, &
»suÉ
);

793 
	`LOG_INFO
("Current media %sest: %s (quality: %d%%)",

794 
	`medŸ_ty³_to_¡ršg
(
nic
->
cu¼’t_medŸ
),

795 (
‹¡_»suÉ
 =ğ
SUCCESS
) ? "PASS" : "FAIL",

796 
»suÉ
.
sigÇl_qu®™y
);

798 ià(
‹¡_»suÉ
 !ğ
SUCCESS
) {

799 
”rÜs
++;

802 
	`LOG_WARNING
("No current media configured foresting");

803 
”rÜs
++;

807 
	`LOG_INFO
("MedŸ dŸgno¡ic com¶‘e: %dƒ¼Üs", 
”rÜs
);

808  (
”rÜs
 =ğ0è? 
SUCCESS
 : 
ERROR_HARDWARE
;

809 
	}
}

816 
	$cÚfigu»_10ba£t_medŸ
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË_fuÎ_du¶ex
) {

817  
	`cÚfigu»_medŸ_»gi¡”s
(
nic
, 
MEDIA_TYPE_10BASE_T
, 
’abË_fuÎ_du¶ex
);

818 
	}
}

823 
	$cÚfigu»_10ba£2_medŸ
(
nic_šfo_t
 *
nic
) {

824  
	`cÚfigu»_medŸ_»gi¡”s
(
nic
, 
MEDIA_TYPE_10BASE_2
, 
çl£
);

825 
	}
}

830 
	$cÚfigu»_aui_medŸ
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË_sqe_‹¡
) {

832  
	`cÚfigu»_medŸ_»gi¡”s
(
nic
, 
MEDIA_TYPE_AUI
, 
çl£
);

833 
	}
}

838 
	$cÚfigu»_fib”_medŸ
(
nic_šfo_t
 *
nic
, 
boŞ
 
’abË_fuÎ_du¶ex
) {

839  
	`cÚfigu»_medŸ_»gi¡”s
(
nic
, 
MEDIA_TYPE_10BASE_FL
, 
’abË_fuÎ_du¶ex
);

840 
	}
}

845 
	$fÜû_medŸ_£ËùiÚ
(
nic_šfo_t
 *
nic
, 
medŸ_ty³_t
 
medŸ_ty³
) {

846  
	`£Ëù_medŸ_Œªsûiv”
(
nic
, 
medŸ_ty³
, 
MEDIA_CTRL_FLAG_FORCE
);

847 
	}
}

852 
	$»£t_medŸ_cÚfigu¿tiÚ
(
nic_šfo_t
 *
nic
) {

853 ià(!
nic
) {

854  
ERROR_INVALID_PARAM
;

857 
	`LOG_INFO
("Resetting media configurationo defaults");

860 
nic
->
cu¼’t_medŸ
 = 
MEDIA_TYPE_UNKNOWN
;

861 
nic
->
d‘eùed_medŸ
 = 
MEDIA_TYPE_UNKNOWN
;

862 
nic
->
medŸ_d‘eùiÚ_¡©e
 = 
MEDIA_DETECT_NONE
;

865 
medŸ_ty³_t
 
deçuÉ_medŸ
 = 
	`g‘_deçuÉ_medŸ_fÜ_nic
(
nic
);

866 ià(
deçuÉ_medŸ
 !ğ
MEDIA_TYPE_UNKNOWN
) {

867  
	`£Ëù_medŸ_Œªsûiv”
(
nic
, 
deçuÉ_medŸ
, 0);

870  
SUCCESS
;

871 
	}
}

876 
mÚ™Ü_lšk_chªges
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
mÚ™Ü_du¿tiÚ_ms
,

877 (*
ÿÎback
)(
nic_šfo_t
 *
nic
, 
boŞ
 
lšk_up
)) {

878 ià(!
nic
) {

879  
ERROR_INVALID_PARAM
;

882 
	`LOG_DEBUG
("MÚ™Üšg†šk chªge fÜ %u ms", 
mÚ™Ü_du¿tiÚ_ms
);

884 
ušt32_t
 
¡¬t_time
 = 
	`g‘_sy¡em_time¡amp_ms
();

885 
Ï¡_lšk_¡©us
 = 
	`check_medŸ_lšk_¡©us
(
nic
);

886 
chªge_couÁ
 = 0;

888 
	`g‘_sy¡em_time¡amp_ms
(è- 
¡¬t_time
 < 
mÚ™Ü_du¿tiÚ_ms
) {

889 
cu¼’t_lšk_¡©us
 = 
	`check_medŸ_lšk_¡©us
(
nic
);

891 ià(
cu¼’t_lšk_¡©us
 !ğ
Ï¡_lšk_¡©us
 && current_link_status >= 0) {

892 
chªge_couÁ
++;

893 
	`LOG_DEBUG
("Link status changed: %s",

894 
cu¼’t_lšk_¡©us
 ? "UP" : "DOWN");

896 ià(
ÿÎback
) {

897 
	`ÿÎback
(
nic
, 
cu¼’t_lšk_¡©us
 ? 
Œue
 : 
çl£
);

900 
Ï¡_lšk_¡©us
 = 
cu¼’t_lšk_¡©us
;

903 
	`md–ay
(100);

906 
	`LOG_DEBUG
("Lšk mÚ™Üšg com¶‘e: %d chªge d‘eùed", 
chªge_couÁ
);

907  
chªge_couÁ
;

908 
	}
}

913 
	$‹¡_sigÇl_qu®™y
(
nic_šfo_t
 *
nic
, 
ušt8_t
 *
qu®™y
) {

914 ià(!
nic
 || !
qu®™y
) {

915  
ERROR_INVALID_PARAM
;

918 
lšk_‹¡_»suÉ_t
 
‹¡_»suÉ
;

919 
»suÉ
 = 
	`‹¡_lšk_b—t
(
nic
,‚ic->
cu¼’t_medŸ
, 1000, &
‹¡_»suÉ
);

921 ià(
»suÉ
 =ğ
SUCCESS
) {

922 *
qu®™y
 = 
‹¡_»suÉ
.
sigÇl_qu®™y
;

924 *
qu®™y
 = 0;

927  
»suÉ
;

928 
	}
}

933 
	$dump_medŸ_»gi¡”s
(
nic_šfo_t
 *
nic
, *
bufãr
, 
size_t
 
bufãr_size
) {

934 ià(!
nic
 || !
bufãr
 || 
bufãr_size
 == 0) {

935  
ERROR_INVALID_PARAM
;

938 
ušt8_t
 
§ved_wšdow
;

939 
»suÉ
 = 
	`§ve_ªd_£Ëù_wšdow
(
nic
, 
_3C509B_WINDOW_4
, &
§ved_wšdow
);

940 ià(
»suÉ
 !ğ
SUCCESS
) {

941  
»suÉ
;

944 
ušt16_t
 
medŸ_ù¾
 = 
	`»ad_medŸ_cÚŒŞ_»gi¡”
(
nic
);

945 
ušt16_t
 
Ãt_dŸg
 = 
	`»ad_ÃtwÜk_dŸgno¡ics_»gi¡”
(
nic
);

947 
	`»¡Üe_wšdow
(
nic
, 
§ved_wšdow
);

949 
ch¬s_wr™‹n
 = 
	`¢´štf
(
bufãr
, 
bufãr_size
,

956 
medŸ_ù¾
, 
Ãt_dŸg
,

957 
	`medŸ_ty³_to_¡ršg
(
nic
->
cu¼’t_medŸ
),

958 
	`medŸ_ty³_to_¡ršg
(
nic
->
d‘eùed_medŸ
),

959 
nic
->
medŸ_d‘eùiÚ_¡©e
);

961  
ch¬s_wr™‹n
;

962 
	}
}

967 
	$g‘_medŸ_šfo_¡ršg
(
nic_šfo_t
 *
nic
, *
bufãr
, 
size_t
 
bufãr_size
) {

968 ià(!
nic
 || !
bufãr
 || 
bufãr_size
 == 0) {

969  
ERROR_INVALID_PARAM
;

972 cÚ¡ * 
cÚfig_sourû_¡r
 = "Unknown";

973 
nic
->
medŸ_cÚfig_sourû
) {

974 
MEDIA_CONFIG_DEFAULT
: 
cÚfig_sourû_¡r
 = "Default"; ;

975 
MEDIA_CONFIG_EEPROM
: 
cÚfig_sourû_¡r
 = "EEPROM"; ;

976 
MEDIA_CONFIG_AUTO_DETECT
: 
cÚfig_sourû_¡r
 = "Auto-Detect"; ;

977 
MEDIA_CONFIG_USER_FORCED
: 
cÚfig_sourû_¡r
 = "User-Forced"; ;

978 
MEDIA_CONFIG_DRIVER_FORCED
: 
cÚfig_sourû_¡r
 = "Driver-Forced"; ;

981 
lšk_¡©us
 = 
	`check_medŸ_lšk_¡©us
(
nic
);

983 
ch¬s_wr™‹n
 = 
	`¢´štf
(
bufãr
, 
bufãr_size
,

985 
	`medŸ_ty³_to_¡ršg
(
nic
->
cu¼’t_medŸ
),

986 (
lšk_¡©us
 > 0) ? "UP" : (link_status == 0) ? "DOWN" : "ERROR",

987 
cÚfig_sourû_¡r
,

988 
nic
->
medŸ_ÿ·b™›s
);

990  
ch¬s_wr™‹n
;

991 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/memory.c

13 
	~"../../šşude/memÜy.h
"

14 
	~"../../šşude/xms_d‘eù.h
"

15 
	~"../../šşude/ıu_d‘eù.h
"

16 
	~"../../šşude/loggšg.h
"

17 
	~<dos.h
>

18 
	~<¡ršg.h
>

19 
	~<¡dlib.h
>

22 
	#MEMORY_TIER_XMS
 1

	)

23 
	#MEMORY_TIER_UMB
 2

	)

24 
	#MEMORY_TIER_CONVENTIONAL
 3

	)

27 
	#UMB_ALLOCATE
 0x5800

	)

28 
	#UMB_FREE
 0x5801

	)

29 
	#UMB_GET_STRATEGY
 0x5802

	)

30 
	#UMB_SET_STRATEGY
 0x5803

	)

33 
	#MEM_MAGIC_ALLOCATED
 0xABCDEF00

	)

34 
	#MEM_MAGIC_FREE
 0xDEADBEEF

	)

37 
mem_poŞ_t
 
	gg_g’”®_poŞ
;

38 
mem_poŞ_t
 
	gg_·ck‘_poŞ
;

39 
mem_poŞ_t
 
	gg_dma_poŞ
;

40 
mem_¡©s_t
 
	gg_mem_¡©s
;

44 
boŞ
 
	mxms_avaabË
;

45 
boŞ
 
	mumb_avaabË
;

46 
boŞ
 
	mš™Ÿlized
;

47 
ušt8_t
 
	m®loÿtiÚ_¡¿‹gy
;

48 
mem_”rÜ_t
 
	mÏ¡_”rÜ
;

49 (*
	m”rÜ_hªdËr
)(
mem_”rÜ_t
 
	m”rÜ
, cÚ¡ * 
	mmes§ge
);

50 } 
	gg_memÜy_sy¡em
;

54 
ušt16_t
 
	mhªdËs
[
XMS_MAX_HANDLES
];

55 
ušt32_t
 
	msizes
[
XMS_MAX_HANDLES
];

56 
boŞ
 
	mhªdË_u£d
[
XMS_MAX_HANDLES
];

57 
ušt32_t
 
	mtÙ®_®loÿ‹d
;

58 
ušt32_t
 
	m³ak_®loÿ‹d
;

59 } 
	gg_xms_t›r
;

63 
ušt16_t
 
	m£gm’ts
[16];

64 
ušt16_t
 
	msizes
[16];

65 
boŞ
 
	m£gm’t_u£d
[16];

66 
ušt32_t
 
	mtÙ®_®loÿ‹d
;

67 
ušt32_t
 
	m³ak_®loÿ‹d
;

68 
ušt8_t
 
	mhªdË_couÁ
;

69 } 
	gg_umb_t›r
;

72 
memÜy_d‘eù_umb
();

73 * 
memÜy_®loc_xms_t›r
(
ušt32_t
 
size
, ušt32_ˆ
æags
);

74 * 
memÜy_®loc_umb_t›r
(
ušt32_t
 
size
, ušt32_ˆ
æags
);

75 * 
memÜy_®loc_cÚv’tiÚ®_t›r
(
ušt32_t
 
size
, ušt32_ˆ
æags
);

76 
memÜy_ä“_xms_t›r
(*
±r
);

77 
memÜy_ä“_umb_t›r
(*
±r
);

78 
memÜy_ä“_cÚv’tiÚ®_t›r
(*
±r
);

79 
memÜy_£t_Ï¡_”rÜ
(
mem_”rÜ_t
 
”rÜ
);

80 
mem_block_t
* 
memÜy_g‘_block_h—d”
(*
±r
);

81 
boŞ
 
memÜy_v®id©e_block
(
mem_block_t
 *
block
);

82 
memÜy_cİy_32b™
(*
de¡
, cÚ¡ *
¤c
, 
ušt32_t
 
size
);

83 
memÜy_cİy_16b™
(*
de¡
, cÚ¡ *
¤c
, 
ušt32_t
 
size
);

84 
memÜy_£t_32b™
(*
±r
, 
ušt8_t
 
v®ue
, 
ušt32_t
 
size
);

85 
memÜy_£t_16b™
(*
±r
, 
ušt8_t
 
v®ue
, 
ušt32_t
 
size
);

88 
memÜy_¡»ss_‹¡_®loÿtiÚ_·‰”ns
();

89 
memÜy_¡»ss_‹¡_äagm’tiÚ
();

90 
memÜy_¡»ss_‹¡_Ëak_d‘eùiÚ
();

91 
memÜy_¡»ss_‹¡_bound¬y_cÚd™iÚs
();

92 
memÜy_¡»ss_‹¡_cÚcu¼’t_İ”©iÚs
();

93 
memÜy_¡»ss_‹¡_t›r_sw™chšg
();

94 
memÜy_v®id©e_®l_®loÿtiÚs
();

95 
memÜy_³rfÜm_cÜru±iÚ_‹¡
();

96 
memÜy_‹¡_exŒeme_®loÿtiÚs
();

97 
memÜy_simuÏ‹_low_memÜy_cÚd™iÚs
();

102 
	$memÜy_š™
() {

103 ià(
g_memÜy_sy¡em
.
š™Ÿlized
) {

107 
	`log_šfo
("Initializinghree-tier memory management system");

110 
	`mem£t
(&
g_memÜy_sy¡em
, 0, (g_memory_system));

111 
	`mem£t
(&
g_xms_t›r
, 0, (g_xms_tier));

112 
	`mem£t
(&
g_umb_t›r
, 0, (g_umb_tier));

113 
	`mem£t
(&
g_mem_¡©s
, 0, (g_mem_stats));

116 ià(
	`xms_d‘eù_ªd_š™
() == 0) {

117 
g_memÜy_sy¡em
.
xms_avaabË
 = 
Œue
;

118 
	`log_šfo
("XMS Extended Memory (Tier 1)‡vailable");

120 
	`log_šfo
("XMS Extended Memory (Tier 1)‚ot‡vailable");

124 ià(
	`memÜy_d‘eù_umb
() == 0) {

125 
g_memÜy_sy¡em
.
umb_avaabË
 = 
Œue
;

126 
	`log_šfo
("UMB Upper Memory (Tier 2)‡vailable");

128 
	`log_šfo
("UMB Upper Memory (Tier 2)‚ot‡vailable");

132 
	`log_šfo
("Conventional Memory (Tier 3)‡vailable");

135 
	`memÜy_¡©s_š™
(&
g_mem_¡©s
);

138 
g_memÜy_sy¡em
.
®loÿtiÚ_¡¿‹gy
 = 1;

140 
g_memÜy_sy¡em
.
š™Ÿlized
 = 
Œue
;

142 
	`log_šfo
("Three-tier memory system initialized successfully");

144 
	}
}

149 
	$memÜy_ş—nup
() {

150 
i
;

152 ià(!
g_memÜy_sy¡em
.
š™Ÿlized
) {

156 
	`log_šfo
("Cleaning uphree-tier memory system");

159 ià(
g_memÜy_sy¡em
.
xms_avaabË
) {

160 
i
 = 0; i < 
XMS_MAX_HANDLES
; i++) {

161 ià(
g_xms_t›r
.
hªdË_u£d
[
i
]) {

162 
	`log_w¬nšg
("F»ešg uÄ–—£d XMS hªdË %04X", 
g_xms_t›r
.
hªdËs
[
i
]);

163 
	`xms_ä“
(
g_xms_t›r
.
hªdËs
[
i
]);

166 
	`xms_ş—nup
();

170 ià(
g_memÜy_sy¡em
.
umb_avaabË
) {

171 
i
 = 0; i < 16; i++) {

172 ià(
g_umb_t›r
.
£gm’t_u£d
[
i
]) {

173 
	`log_w¬nšg
("F»ešg uÄ–—£d UMB segm’ˆ%04X", 
g_umb_t›r
.
£gm’ts
[
i
]);

174 
	`memÜy_ä“_dos_memÜy
(
g_umb_t›r
.
£gm’ts
[
i
]);

180 
	`mem£t
(&
g_memÜy_sy¡em
, 0, (g_memory_system));

181 
	`mem£t
(&
g_xms_t›r
, 0, (g_xms_tier));

182 
	`mem£t
(&
g_umb_t›r
, 0, (g_umb_tier));

184 
	`log_šfo
("Three-tier memory system cleanup completed");

185 
	}
}

191 
	$memÜy_d‘eù_umb
() {

192 
REGS
 
»gs
;

195 
»gs
.
x
.
ax
 = 
UMB_GET_STRATEGY
;

196 
	`št86
(0x21, &
»gs
, &regs);

198 ià(
»gs
.
x
.
cæag
) {

199 
	`log_debug
("UMB‚ot supported by DOS");

204 
»gs
.
x
.
ax
 = 
UMB_SET_STRATEGY
;

205 
»gs
.
x
.
bx
 = 0x0080;

206 
	`št86
(0x21, &
»gs
, &regs);

208 ià(
»gs
.
x
.
cæag
) {

209 
	`log_debug
("Cannot set UMB‡llocation strategy");

213 
	`log_debug
("UMB support detected‡ndƒnabled");

215 
	}
}

224 * 
	$memÜy_®loc
(
ušt32_t
 
size
, 
mem_ty³_t
 
ty³
, ušt32_ˆ
æags
) {

225 *
±r
 = 
NULL
;

227 ià(!
g_memÜy_sy¡em
.
š™Ÿlized
) {

228 
	`memÜy_£t_Ï¡_”rÜ
(
MEM_ERROR_INVALID_POINTER
);

229  
NULL
;

232 ià(
size
 == 0) {

233 
	`memÜy_£t_Ï¡_”rÜ
(
MEM_ERROR_INVALID_SIZE
);

234  
NULL
;

237 
	`log_debug
("AÎoÿtšg %lu by‹s,y³ %d, fÏg 0x%lX", 
size
, 
ty³
, 
æags
);

240 
ušt32_t
 
tÙ®_size
 = 
size
 + (
mem_block_t
);

243 
g_memÜy_sy¡em
.
®loÿtiÚ_¡¿‹gy
) {

245 ià(
g_memÜy_sy¡em
.
xms_avaabË
 && 
size
 >= 4096) {

246 
±r
 = 
	`memÜy_®loc_xms_t›r
(
tÙ®_size
, 
æags
);

247 ià(
±r
) ;

249 ià(
g_memÜy_sy¡em
.
umb_avaabË
 && 
size
 >= 1024) {

250 
±r
 = 
	`memÜy_®loc_umb_t›r
(
tÙ®_size
, 
æags
);

251 ià(
±r
) ;

253 
±r
 = 
	`memÜy_®loc_cÚv’tiÚ®_t›r
(
tÙ®_size
, 
æags
);

257 ià(
g_memÜy_sy¡em
.
umb_avaabË
) {

258 
±r
 = 
	`memÜy_®loc_umb_t›r
(
tÙ®_size
, 
æags
);

259 ià(
±r
) ;

261 
±r
 = 
	`memÜy_®loc_cÚv’tiÚ®_t›r
(
tÙ®_size
, 
æags
);

262 ià(!
±r
 && 
g_memÜy_sy¡em
.
xms_avaabË
) {

263 
±r
 = 
	`memÜy_®loc_xms_t›r
(
tÙ®_size
, 
æags
);

269 
±r
 = 
	`memÜy_®loc_cÚv’tiÚ®_t›r
(
tÙ®_size
, 
æags
);

273 ià(
±r
) {

274 
	`memÜy_¡©s_upd©e_®loc
(&
g_mem_¡©s
, 
size
);

275 
	`log_debug
("AÎoÿ‹d %lu by‹ © %p", 
size
, 
±r
);

277 
	`memÜy_£t_Ï¡_”rÜ
(
MEM_ERROR_OUT_OF_MEMORY
);

278 
g_mem_¡©s
.
®loÿtiÚ_çu»s
++;

279 
	`log_”rÜ
("FaedØ®loÿ‹ %lu by‹s", 
size
);

282  
±r
;

283 
	}
}

289 
	$memÜy_ä“
(*
±r
) {

290 
mem_block_t
 *
block
;

292 ià(!
±r
) {

296 ià(!
g_memÜy_sy¡em
.
š™Ÿlized
) {

297 
	`memÜy_£t_Ï¡_”rÜ
(
MEM_ERROR_INVALID_POINTER
);

301 
block
 = 
	`memÜy_g‘_block_h—d”
(
±r
);

302 ià(!
	`memÜy_v®id©e_block
(
block
)) {

303 
	`memÜy_£t_Ï¡_”rÜ
(
MEM_ERROR_CORRUPTION
);

304 
	`log_”rÜ
("Inv®id memÜy block‡ˆ%p", 
±r
);

308 
	`log_debug
("F»ešg %lu by‹ © %p", 
block
->
size
, 
±r
);

311 ià(
block
->
æags
 & 
MEM_FLAG_DMA_CAPABLE
) {

313 
	`memÜy_ä“_xms_t›r
(
±r
);

314 } ià((
ušt32_t
)
±r
 > 0xA0000) {

316 
	`memÜy_ä“_umb_t›r
(
±r
);

319 
	`memÜy_ä“_cÚv’tiÚ®_t›r
(
±r
);

322 
	`memÜy_¡©s_upd©e_ä“
(&
g_mem_¡©s
, 
block
->
size
);

323 
	}
}

331 * 
	$memÜy_®loc_xms_t›r
(
ušt32_t
 
size
, ušt32_ˆ
æags
) {

332 
ušt16_t
 
hªdË
;

333 
ušt32_t
 
lš—r_addr
;

334 
size_kb
 = (
size
 + 1023) / 1024;

335 
i
;

336 
ıu_šfo_t
 
g_ıu_šfo
;

338 ià(!
g_memÜy_sy¡em
.
xms_avaabË
) {

339  
NULL
;

343 ià(
æags
 & 
MEM_FLAG_DMA_CAPABLE
) {

345 
ušt32_t
 
®ignm’t
 = (
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80486
) ? 32 : 4;

346 
size_kb
 = ((
size
 + 
®ignm’t
 + 1023) / 1024);

350 
i
 = 0; i < 
XMS_MAX_HANDLES
; i++) {

351 ià(!
g_xms_t›r
.
hªdË_u£d
[
i
]) {

356 ià(
i
 >ğ
XMS_MAX_HANDLES
) {

357 
	`log_debug
("No free XMS handle slots");

358  
NULL
;

362 ià(
	`xms_®loÿ‹
(
size_kb
, &
hªdË
) != 0) {

363  
NULL
;

367 ià(
	`xms_lock
(
hªdË
, &
lš—r_addr
) != 0) {

368 
	`xms_ä“
(
hªdË
);

369  
NULL
;

373 
ušt32_t
 
®igÃd_addr
 = 
lš—r_addr
;

374 ià(
æags
 & 
MEM_FLAG_DMA_CAPABLE
) {

375 
ušt32_t
 
®ignm’t
 = (
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80486
) ? 32 : 4;

376 
®igÃd_addr
 = 
	`ALIGN_UP
(
lš—r_addr
 + (
mem_block_t
), 
®ignm’t
);

379 
mem_block_t
 *
block
 = (mem_block_t*)(
®igÃd_addr
 - (mem_block_t));

380 
block
->
Üigš®_addr
 = 
lš—r_addr
;

382 
®igÃd_addr
 = 
lš—r_addr
;

386 
g_xms_t›r
.
hªdËs
[
i
] = 
hªdË
;

387 
g_xms_t›r
.
sizes
[
i
] = 
size
;

388 
g_xms_t›r
.
hªdË_u£d
[
i
] = 
Œue
;

389 
g_xms_t›r
.
tÙ®_®loÿ‹d
 +ğ
size
;

391 ià(
g_xms_t›r
.
tÙ®_®loÿ‹d
 > g_xms_t›r.
³ak_®loÿ‹d
) {

392 
g_xms_t›r
.
³ak_®loÿ‹d
 = g_xms_t›r.
tÙ®_®loÿ‹d
;

396 
mem_block_t
 *
block
 = (mem_block_t*)(
®igÃd_addr
 - (mem_block_t));

397 
block
->
size
 = siz- (
mem_block_t
);

398 
block
->
æags
 = fÏg | 
MEM_FLAG_DMA_CAPABLE
;

399 
block
->
ty³
 = 
MEM_TYPE_PACKET_BUFFER
;

400 
block
->
magic
 = 
MEM_MAGIC_ALLOCATED
;

401 
block
->
Ãxt
 = 
NULL
;

402 
block
->
´ev
 = 
NULL
;

405 ià(
æags
 & 
MEM_FLAG_DMA_CAPABLE
) {

406 
ušt32_t
 
ex³ùed_®ignm’t
 = (
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80486
) ? 32 : 4;

407 ià(!
	`IS_ALIGNED
(
®igÃd_addr
, 
ex³ùed_®ignm’t
)) {

408 
	`log_w¬nšg
("DMA buffer‡lignment suboptimal: %08lX (expected %u-byte‡lignment)",

409 
®igÃd_addr
, 
ex³ùed_®ignm’t
);

413 
	`log_debug
("XMS‡llocation: handle %04X, %d KB‡t†inear %08lX (aligned %08lX)",

414 
hªdË
, 
size_kb
, 
lš—r_addr
, 
®igÃd_addr
);

416  (*)
®igÃd_addr
;

417 
	}
}

425 * 
	$memÜy_®loc_umb_t›r
(
ušt32_t
 
size
, ušt32_ˆ
æags
) {

426 
ušt16_t
 
£gm’t
;

427 
ušt16_t
 
·¿g¿phs
 = (
size
 + 15) / 16;

428 
i
;

430 ià(!
g_memÜy_sy¡em
.
umb_avaabË
) {

431  
NULL
;

435 
i
 = 0; i < 16; i++) {

436 ià(!
g_umb_t›r
.
£gm’t_u£d
[
i
]) {

441 ià(
i
 >= 16) {

442 
	`log_debug
("No free UMB segment slots");

443  
NULL
;

447 ià(
	`memÜy_®loÿ‹_dos_memÜy
(
·¿g¿phs
, &
£gm’t
) != 0) {

448  
NULL
;

452 ià(
£gm’t
 < 0xA000) {

453 
	`memÜy_ä“_dos_memÜy
(
£gm’t
);

454  
NULL
;

458 
g_umb_t›r
.
£gm’ts
[
i
] = 
£gm’t
;

459 
g_umb_t›r
.
sizes
[
i
] = 
size
;

460 
g_umb_t›r
.
£gm’t_u£d
[
i
] = 
Œue
;

461 
g_umb_t›r
.
tÙ®_®loÿ‹d
 +ğ
size
;

462 
g_umb_t›r
.
hªdË_couÁ
++;

464 ià(
g_umb_t›r
.
tÙ®_®loÿ‹d
 > g_umb_t›r.
³ak_®loÿ‹d
) {

465 
g_umb_t›r
.
³ak_®loÿ‹d
 = g_umb_t›r.
tÙ®_®loÿ‹d
;

469 
mem_block_t
 *
block
 = (mem_block_t*)
	`MK_FP
(
£gm’t
, 0);

470 
block
->
size
 = siz- (
mem_block_t
);

471 
block
->
æags
 = flags;

472 
block
->
ty³
 = 
MEM_TYPE_PACKET_BUFFER
;

473 
block
->
magic
 = 
MEM_MAGIC_ALLOCATED
;

474 
block
->
Ãxt
 = 
NULL
;

475 
block
->
´ev
 = 
NULL
;

477 
	`log_debug
("UMB‡ÎoÿtiÚ: segm’ˆ%04X, %d…¬ag¿phs", 
£gm’t
, 
·¿g¿phs
);

479  (*)((
ušt8_t
*)
block
 + (
mem_block_t
));

480 
	}
}

488 * 
	$memÜy_®loc_cÚv’tiÚ®_t›r
(
ušt32_t
 
size
, ušt32_ˆ
æags
) {

489 
mem_block_t
 *
block
;

492 
block
 = (
mem_block_t
*)
	`m®loc
(
size
);

493 ià(!
block
) {

494  
NULL
;

498 
block
->
size
 = siz- (
mem_block_t
);

499 
block
->
æags
 = flags;

500 
block
->
ty³
 = 
MEM_TYPE_GENERAL
;

501 
block
->
magic
 = 
MEM_MAGIC_ALLOCATED
;

502 
block
->
Ãxt
 = 
NULL
;

503 
block
->
´ev
 = 
NULL
;

505 
	`log_debug
("CÚv’tiÚ®‡ÎoÿtiÚ: %lu by‹ © %p", 
size
, 
block
);

507  (*)((
ušt8_t
*)
block
 + (
mem_block_t
));

508 
	}
}

514 
	$memÜy_ä“_xms_t›r
(*
±r
) {

515 
mem_block_t
 *
block
 = 
	`memÜy_g‘_block_h—d”
(
±r
);

516 
ušt32_t
 
lš—r_addr
 = (ušt32_t)
block
;

517 
i
;

520 
i
 = 0; i < 
XMS_MAX_HANDLES
; i++) {

521 ià(
g_xms_t›r
.
hªdË_u£d
[
i
]) {

522 
ušt32_t
 
hªdË_addr
;

523 ià(
	`xms_lock
(
g_xms_t›r
.
hªdËs
[
i
], &
hªdË_addr
) == 0) {

524 ià(
hªdË_addr
 =ğ
lš—r_addr
) {

526 
	`xms_uÆock
(
g_xms_t›r
.
hªdËs
[
i
]);

527 
	`xms_ä“
(
g_xms_t›r
.
hªdËs
[
i
]);

529 
g_xms_t›r
.
tÙ®_®loÿ‹d
 -ğg_xms_t›r.
sizes
[
i
];

530 
g_xms_t›r
.
hªdË_u£d
[
i
] = 
çl£
;

532 
	`log_debug
("F»ed XMS hªdË %04X", 
g_xms_t›r
.
hªdËs
[
i
]);

535 
	`xms_uÆock
(
g_xms_t›r
.
hªdËs
[
i
]);

540 
	`log_”rÜ
("Could‚Ù fšd XMS hªdË fÜ‡dd»s %p", 
±r
);

541 
	}
}

547 
	$memÜy_ä“_umb_t›r
(*
±r
) {

548 
mem_block_t
 *
block
 = 
	`memÜy_g‘_block_h—d”
(
±r
);

549 
ušt16_t
 
£gm’t
 = 
	`FP_SEG
(
block
);

550 
i
;

553 
i
 = 0; i < 16; i++) {

554 ià(
g_umb_t›r
.
£gm’t_u£d
[
i
] && g_umb_t›r.
£gm’ts
[i] =ğ
£gm’t
) {

555 
	`memÜy_ä“_dos_memÜy
(
£gm’t
);

557 
g_umb_t›r
.
tÙ®_®loÿ‹d
 -ğg_umb_t›r.
sizes
[
i
];

558 
g_umb_t›r
.
£gm’t_u£d
[
i
] = 
çl£
;

559 
g_umb_t›r
.
hªdË_couÁ
--;

561 
	`log_debug
("F»ed UMB segm’ˆ%04X", 
£gm’t
);

566 
	`log_”rÜ
("Could‚Ù fšd UMB segm’ˆfÜ‡dd»s %p", 
±r
);

567 
	}
}

573 
	$memÜy_ä“_cÚv’tiÚ®_t›r
(*
±r
) {

574 
mem_block_t
 *
block
 = 
	`memÜy_g‘_block_h—d”
(
±r
);

576 
block
->
magic
 = 
MEM_MAGIC_FREE
;

577 
	`ä“
(
block
);

579 
	`log_debug
("F»ed cÚv’tiÚ® memÜy‡ˆ%p", 
±r
);

580 
	}
}

587 
mem_block_t
* 
	$memÜy_g‘_block_h—d”
(*
±r
) {

588  (
mem_block_t
*)((
ušt8_t
*)
±r
 - (mem_block_t));

589 
	}
}

596 
boŞ
 
	$memÜy_v®id©e_block
(
mem_block_t
 *
block
) {

597 ià(!
block
) {

598  
çl£
;

601  (
block
->
magic
 =ğ
MEM_MAGIC_ALLOCATED
);

602 
	}
}

608 
	$memÜy_£t_Ï¡_”rÜ
(
mem_”rÜ_t
 
”rÜ
) {

609 
g_memÜy_sy¡em
.
Ï¡_”rÜ
 = 
”rÜ
;

611 ià(
g_memÜy_sy¡em
.
”rÜ_hªdËr
) {

612 
g_memÜy_sy¡em
.
	`”rÜ_hªdËr
(
”rÜ
, 
	`memÜy_”rÜ_to_¡ršg
(error));

614 
	}
}

620 
mem_”rÜ_t
 
	$memÜy_g‘_Ï¡_”rÜ
() {

621  
g_memÜy_sy¡em
.
Ï¡_”rÜ
;

622 
	}
}

629 cÚ¡ * 
	$memÜy_”rÜ_to_¡ršg
(
mem_”rÜ_t
 
”rÜ
) {

630 
”rÜ
) {

631 
MEM_ERROR_NONE
:  "Noƒrror";

632 
MEM_ERROR_OUT_OF_MEMORY
:  "Out of memory";

633 
MEM_ERROR_INVALID_POINTER
:  "Invalid…ointer";

634 
MEM_ERROR_DOUBLE_FREE
:  "Double free detected";

635 
MEM_ERROR_CORRUPTION
:  "Memory corruption detected";

636 
MEM_ERROR_ALIGNMENT
:  "Alignmentƒrror";

637 
MEM_ERROR_POOL_FULL
:  "Memory…ool full";

638 
MEM_ERROR_INVALID_SIZE
:  "Invalid size";

641 
	}
}

647 
boŞ
 
	$memÜy_xms_avaabË
() {

648  
g_memÜy_sy¡em
.
xms_avaabË
;

649 
	}
}

655 
ušt32_t
 
	$memÜy_g‘_xms_size
() {

656 
xms_šfo_t
 
šfo
;

658 ià(!
g_memÜy_sy¡em
.
xms_avaabË
) {

662 ià(
	`xms_g‘_šfo
(&
šfo
) != 0) {

666  
šfo
.
ä“_kb
;

667 
	}
}

673 
	$memÜy_¡©s_š™
(
mem_¡©s_t
 *
¡©s
) {

674 ià(!
¡©s
) {

678 
	`mem£t
(
¡©s
, 0, (
mem_¡©s_t
));

679 
	}
}

686 
	$memÜy_¡©s_upd©e_®loc
(
mem_¡©s_t
 *
¡©s
, 
ušt32_t
 
size
) {

687 ià(!
¡©s
) {

691 
¡©s
->
tÙ®_®loÿtiÚs
++;

692 
¡©s
->
u£d_memÜy
 +ğ
size
;

694 ià(
¡©s
->
u£d_memÜy
 > sts->
³ak_u§ge
) {

695 
¡©s
->
³ak_u§ge
 = sts->
u£d_memÜy
;

698 ià(
size
 > 
¡©s
->
Ïrge¡_®loÿtiÚ
) {

699 
¡©s
->
Ïrge¡_®loÿtiÚ
 = 
size
;

702 ià(
¡©s
->
sm®Ë¡_®loÿtiÚ
 =ğ0 || 
size
 < stats->smallest_allocation) {

703 
¡©s
->
sm®Ë¡_®loÿtiÚ
 = 
size
;

705 
	}
}

712 
	$memÜy_¡©s_upd©e_ä“
(
mem_¡©s_t
 *
¡©s
, 
ušt32_t
 
size
) {

713 ià(!
¡©s
) {

717 
¡©s
->
tÙ®_ä“s
++;

718 ià(
¡©s
->
u£d_memÜy
 >ğ
size
) {

719 
¡©s
->
u£d_memÜy
 -ğ
size
;

721 
	}
}

727 cÚ¡ 
mem_¡©s_t
* 
	$memÜy_g‘_¡©s
() {

728  &
g_mem_¡©s
;

729 
	}
}

737 
	$memÜy_®loÿ‹_dos_memÜy
(
ušt16_t
 
·¿g¿phs
, ušt16_ˆ*
£gm’t
) {

738 
REGS
 
»gs
;

740 
»gs
.
h
.
ah
 = 0x48;

741 
»gs
.
x
.
bx
 = 
·¿g¿phs
;

742 
	`št86
(0x21, &
»gs
, &regs);

744 ià(
»gs
.
x
.
cæag
) {

748 *
£gm’t
 = 
»gs
.
x
.
ax
;

750 
	}
}

757 
	$memÜy_ä“_dos_memÜy
(
ušt16_t
 
£gm’t
) {

758 
REGS
 
»gs
;

759 
SREGS
 
¤egs
;

761 
¤egs
.
es
 = 
£gm’t
;

762 
»gs
.
h
.
ah
 = 0x49;

763 
	`št86x
(0x21, &
»gs
, &»gs, &
¤egs
);

765 ià(
»gs
.
x
.
cæag
) {

770 
	}
}

773 
	$memÜy_z”o
(*
±r
, 
ušt32_t
 
size
) {

774 ià(
±r
 && 
size
 > 0) {

775 
	`mem£t
(
±r
, 0, 
size
);

777 
	}
}

779 
	$memÜy_cİy
(*
de¡
, cÚ¡ *
¤c
, 
ušt32_t
 
size
) {

780 ià(
de¡
 && 
¤c
 && 
size
 > 0) {

781 
	`memıy
(
de¡
, 
¤c
, 
size
);

783 
	}
}

785 
	$memÜy_com·»
(cÚ¡ *
±r1
, cÚ¡ *
±r2
, 
ušt32_t
 
size
) {

786 ià(!
±r1
 || !
±r2
 || 
size
 == 0) {

789  
	`memcmp
(
±r1
, 
±r2
, 
size
);

790 
	}
}

798 
	$memÜy_cİy_İtimized
(*
de¡
, cÚ¡ *
¤c
, 
ušt32_t
 
size
) {

799 
ıu_šfo_t
 
g_ıu_šfo
;

801 ià(!
de¡
 || !
¤c
 || 
size
 == 0) {

806 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
 && 
	`ıu_suµÜts_32b™
()) {

808 
	`memÜy_cİy_32b™
(
de¡
, 
¤c
, 
size
);

811 
	`memÜy_cİy_16b™
(
de¡
, 
¤c
, 
size
);

813 
	}
}

821 
	$memÜy_cİy_32b™
(*
de¡
, cÚ¡ *
¤c
, 
ušt32_t
 
size
) {

822 
ušt32_t
 *
de¡32
 = (ušt32_t*)
de¡
;

823 cÚ¡ 
ušt32_t
 *
¤c32
 = (cÚ¡ ušt32_t*)
¤c
;

824 
ušt8_t
 *
de¡8
;

825 cÚ¡ 
ušt8_t
 *
¤c8
;

826 
ušt32_t
 
dwÜds
, 
»mašd”
;

829 ià(
	`IS_ALIGNED
((
ušt32_t
)
de¡
, 4è&& IS_ALIGNED((ušt32_t)
¤c
, 4)) {

831 
dwÜds
 = 
size
 / 4;

832 
»mašd”
 = 
size
 % 4;

835 
dwÜds
--) {

836 *
de¡32
++ = *
¤c32
++;

840 ià(
»mašd”
) {

841 
de¡8
 = (
ušt8_t
*)
de¡32
;

842 
¤c8
 = (cÚ¡ 
ušt8_t
*)
¤c32
;

843 
»mašd”
--) {

844 *
de¡8
++ = *
¤c8
++;

849 
	`memÜy_cİy_16b™
(
de¡
, 
¤c
, 
size
);

851 
	}
}

859 
	$memÜy_cİy_16b™
(*
de¡
, cÚ¡ *
¤c
, 
ušt32_t
 
size
) {

860 
ušt16_t
 *
de¡16
 = (ušt16_t*)
de¡
;

861 cÚ¡ 
ušt16_t
 *
¤c16
 = (cÚ¡ ušt16_t*)
¤c
;

862 
ušt8_t
 *
de¡8
;

863 cÚ¡ 
ušt8_t
 *
¤c8
;

864 
ušt32_t
 
wÜds
, 
»mašd”
;

867 ià(
	`IS_ALIGNED
((
ušt32_t
)
de¡
, 2è&& IS_ALIGNED((ušt32_t)
¤c
, 2)) {

869 
wÜds
 = 
size
 / 2;

870 
»mašd”
 = 
size
 % 2;

873 
wÜds
--) {

874 *
de¡16
++ = *
¤c16
++;

878 ià(
»mašd”
) {

879 
de¡8
 = (
ušt8_t
*)
de¡16
;

880 
¤c8
 = (cÚ¡ 
ušt8_t
*)
¤c16
;

881 *
de¡8
 = *
¤c8
;

885 
de¡8
 = (
ušt8_t
*)
de¡
;

886 
¤c8
 = (cÚ¡ 
ušt8_t
*)
¤c
;

887 
size
--) {

888 *
de¡8
++ = *
¤c8
++;

891 
	}
}

899 
	$memÜy_£t_İtimized
(*
±r
, 
ušt8_t
 
v®ue
, 
ušt32_t
 
size
) {

900 
ıu_šfo_t
 
g_ıu_šfo
;

902 ià(!
±r
 || 
size
 == 0) {

907 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
 && 
	`ıu_suµÜts_32b™
()) {

908 
	`memÜy_£t_32b™
(
±r
, 
v®ue
, 
size
);

910 
	`memÜy_£t_16b™
(
±r
, 
v®ue
, 
size
);

912 
	}
}

920 
	$memÜy_£t_32b™
(*
±r
, 
ušt8_t
 
v®ue
, 
ušt32_t
 
size
) {

921 
ušt32_t
 *
±r32
 = (ušt32_t*)
±r
;

922 
ušt8_t
 *
±r8
;

923 
ušt32_t
 
dwÜds
, 
»mašd”
;

924 
ušt32_t
 
v®ue32
;

927 
v®ue32
 = ((
ušt32_t
)
v®ue
 << 24) | ((uint32_t)value << 16) |

928 ((
ušt32_t
)
v®ue
 << 8) | value;

931 ià(
	`IS_ALIGNED
((
ušt32_t
)
±r
, 4)) {

933 
dwÜds
 = 
size
 / 4;

934 
»mašd”
 = 
size
 % 4;

937 
dwÜds
--) {

938 *
±r32
++ = 
v®ue32
;

942 ià(
»mašd”
) {

943 
±r8
 = (
ušt8_t
*)
±r32
;

944 
»mašd”
--) {

945 *
±r8
++ = 
v®ue
;

950 
	`memÜy_£t_16b™
(
±r
, 
v®ue
, 
size
);

952 
	}
}

960 
	$memÜy_£t_16b™
(*
±r
, 
ušt8_t
 
v®ue
, 
ušt32_t
 
size
) {

961 
ušt16_t
 *
±r16
 = (ušt16_t*)
±r
;

962 
ušt8_t
 *
±r8
;

963 
ušt32_t
 
wÜds
, 
»mašd”
;

964 
ušt16_t
 
v®ue16
;

967 
v®ue16
 = ((
ušt16_t
)
v®ue
 << 8) | value;

970 ià(
	`IS_ALIGNED
((
ušt32_t
)
±r
, 2)) {

972 
wÜds
 = 
size
 / 2;

973 
»mašd”
 = 
size
 % 2;

976 
wÜds
--) {

977 *
±r16
++ = 
v®ue16
;

981 ià(
»mašd”
) {

982 
±r8
 = (
ušt8_t
*)
±r16
;

983 *
±r8
 = 
v®ue
;

987 
±r8
 = (
ušt8_t
*)
±r
;

988 
size
--) {

989 *
±r8
++ = 
v®ue
;

992 
	}
}

1001 * 
	$memÜy_®loc_®igÃd
(
ušt32_t
 
size
, ušt32_ˆ
®ignm’t
, 
mem_ty³_t
 
ty³
) {

1002 
ıu_šfo_t
 
g_ıu_šfo
;

1003 *
±r
;

1004 
ušt32_t
 
æags
 = 
MEM_FLAG_ALIGNED
;

1007 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

1009 ià(
®ignm’t
 < 4) {

1010 
®ignm’t
 = 4;

1014 ià(
®ignm’t
 < 2) {

1015 
®ignm’t
 = 2;

1020 
ušt32_t
 
·dded_size
 = 
size
 + 
®ignm’t
 + (
mem_block_t
);

1021 
±r
 = 
	`memÜy_®loc
(
·dded_size
, 
ty³
, 
æags
);

1023 ià(!
±r
) {

1024  
NULL
;

1028 
ušt32_t
 
addr
 = (ušt32_t)
±r
;

1029 
ušt32_t
 
®igÃd_addr
 = 
	`ALIGN_UP
(
addr
, 
®ignm’t
);

1032 ià(
addr
 =ğ
®igÃd_addr
) {

1033  
±r
;

1037 **
Üig_±r_¡Üage
 = (**)(
®igÃd_addr
 - (*));

1038 *
Üig_±r_¡Üage
 = 
±r
;

1041  (*)
®igÃd_addr
;

1042 
	}
}

1048 
	$memÜy_ä“_®igÃd
(*
±r
) {

1049 *
Üigš®_±r
;

1051 ià(!
±r
) {

1056 
ušt32_t
 
addr
 = (ušt32_t)
±r
;

1057 ià(!
	`IS_ALIGNED
(
addr
, 4) && !IS_ALIGNED(addr, 2)) {

1059 
	`memÜy_ä“
(
±r
);

1064 **
Üig_±r_¡Üage
 = (**)(
addr
 - (*));

1065 
Üigš®_±r
 = *
Üig_±r_¡Üage
;

1068 ià(
Üigš®_±r
 && (
ušt32_t
)Üigš®_±¸< 
addr
 &&

1069 (
addr
 - (
ušt32_t
)
Üigš®_±r
) < 64) {

1070 
	`memÜy_ä“
(
Üigš®_±r
);

1073 
	`memÜy_ä“
(
±r
);

1075 
	}
}

1082 * 
	$memÜy_®loc_dma
(
ušt32_t
 
size
) {

1083 
ıu_šfo_t
 
g_ıu_šfo
;

1084 
ušt32_t
 
æags
 = 
MEM_FLAG_DMA_CAPABLE
 | 
MEM_FLAG_ALIGNED
;

1085 *
±r
;

1091 ià(
g_memÜy_sy¡em
.
xms_avaabË
) {

1092 
±r
 = 
	`memÜy_®loc_xms_t›r
(
size
 + (
mem_block_t
), 
æags
);

1093 ià(
±r
) {

1094 
	`log_debug
("AÎoÿ‹d %lu by‹ DMA bufã¸š XMS‡ˆ%p", 
size
, 
±r
);

1095  
±r
;

1100 
±r
 = 
	`memÜy_®loc
(
size
, 
MEM_TYPE_PACKET_BUFFER
, 
æags
);

1101 ià(
±r
) {

1102 
	`log_w¬nšg
("DMA buffer‡llocated in conventional memory - may‚ot be optimal");

1105 
ušt32_t
 
®ignm’t
 = (
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80486
) ? 32 : 4;

1106 ià(!
	`IS_ALIGNED
((
ušt32_t
)
±r
, 
®ignm’t
)) {

1107 
	`log_”rÜ
("DMA buffer‚ot…roperly‡ligned: %p (need %u-byte‡lignment)",

1108 
±r
, 
®ignm’t
);

1112  
±r
;

1113 
	}
}

1119 
	$memÜy_ä“_dma
(*
±r
) {

1120 ià(!
±r
) {

1125 
	`memÜy_ä“
(
±r
);

1126 
	`log_debug
("F»ed DMA bufã¸© %p", 
±r
);

1127 
	}
}

1135 * 
	$memÜy_®loc_ÿche_®igÃd
(
ušt32_t
 
size
, ušt32_ˆ
ÿche_lše_size
) {

1136 
ıu_šfo_t
 
g_ıu_šfo
;

1137 
ušt32_t
 
®ignm’t
;

1140 ià(
ÿche_lše_size
 != 16 && cache_line_size != 32 && cache_line_size != 64) {

1141 
	`log_”rÜ
("Inv®id cachlšsize: %u (mu¡ b16, 32, o¸64)", 
ÿche_lše_size
);

1142  
NULL
;

1146 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_PENTIUM
) {

1147 
®ignm’t
 = 
ÿche_lše_size
;

1148 } ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80486
) {

1149 
®ignm’t
 = 32;

1151 
®ignm’t
 = 4;

1154 *
±r
 = 
	`memÜy_®loc_®igÃd
(
size
, 
®ignm’t
, 
MEM_TYPE_PACKET_BUFFER
);

1155 ià(
±r
) {

1156 
	`log_debug
("Allocated %lu byte cache-aligned buffer (%u-byte‡lignment)‡t %p",

1157 
size
, 
®ignm’t
, 
±r
);

1160  
±r
;

1161 
	}
}

1167 
	$memÜy_š™_ıu_İtimized
() {

1168 
ıu_šfo_t
 
g_ıu_šfo
;

1170 ià(!
g_ıu_šfo
.
ty³
) {

1171 
	`log_w¬nšg
("CPU‚ot detected - using conservative memory operations");

1175 
	`log_šfo
("Initializing CPU-optimized memory operations for %s",

1176 
	`ıu_ty³_to_¡ršg
(
g_ıu_šfo
.
ty³
));

1179 ià(
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

1180 
	`log_šfo
("Enabling 32-bit memory operations for 386+ CPU");

1182 ià(
g_ıu_šfo
.
ã©u»s
 & 
CPU_FEATURE_TSC
) {

1183 
	`log_šfo
("TSC‡vailable for…erformance measurement");

1186 
	`log_šfo
("Using 16-bit memory operations for %s",

1187 
	`ıu_ty³_to_¡ršg
(
g_ıu_šfo
.
ty³
));

1191 ià(
g_memÜy_sy¡em
.
xms_avaabË
) {

1192 
ušt32_t
 
xms_size
 = 
	`memÜy_g‘_xms_size
();

1193 ià(
xms_size
 >= 1024) {

1194 
	`log_šfo
("Suffic›Á XMS memÜy (%u KBèfÜ o±imized DMA bufã¸®loÿtiÚ", 
xms_size
);

1196 
	`log_w¬nšg
("Lim™ed XMS memÜy (%u KBè- DMA…”fÜmªû may b»duûd", 
xms_size
);

1199 
	`log_w¬nšg
("No XMS memory - DMA buffers will use conventional memory");

1203 
	}
}

1212 
	$memÜy_poŞ_š™
(
mem_poŞ_t
 *
poŞ
, *
ba£
, 
ušt32_t
 
size
) {

1213 ià(!
poŞ
 || !
ba£
 || 
size
 < (
mem_block_t
)) {

1218 
poŞ
->
ba£
 = base;

1219 
poŞ
->
size
 = size;

1220 
poŞ
->
u£d
 = 0;

1221 
poŞ
->
ä“
 = 
size
;

1222 
poŞ
->
Ïrge¡_ä“
 = 
size
;

1223 
poŞ
->
block_couÁ
 = 0;

1224 
poŞ
->
®loc_couÁ
 = 0;

1225 
poŞ
->
ä“_couÁ
 = 0;

1226 
poŞ
->
š™Ÿlized
 = 
Œue
;

1229 
mem_block_t
 *
š™Ÿl_block
 = (mem_block_t*)
ba£
;

1230 
š™Ÿl_block
->
size
 = siz- (
mem_block_t
);

1231 
š™Ÿl_block
->
æags
 = 0;

1232 
š™Ÿl_block
->
ty³
 = 
MEM_TYPE_GENERAL
;

1233 
š™Ÿl_block
->
magic
 = 
MEM_MAGIC_FREE
;

1234 
š™Ÿl_block
->
Ãxt
 = 
NULL
;

1235 
š™Ÿl_block
->
´ev
 = 
NULL
;

1237 
poŞ
->
ä“_li¡
 = 
š™Ÿl_block
;

1238 
poŞ
->
block_couÁ
 = 1;

1241 
	}
}

1247 
	$memÜy_poŞ_ş—nup
(
mem_poŞ_t
 *
poŞ
) {

1248 ià(!
poŞ
 || !poŞ->
š™Ÿlized
) {

1253 
	`mem£t
(
poŞ
, 0, (
mem_poŞ_t
));

1254 
	}
}

1263 * 
	$memÜy_poŞ_®loc
(
mem_poŞ_t
 *
poŞ
, 
ušt32_t
 
size
, ušt32_ˆ
æags
) {

1264 
mem_block_t
 *
block
, *
Ãw_block
;

1265 
ušt32_t
 
tÙ®_size
 = 
size
 + (
mem_block_t
);

1267 ià(!
poŞ
 || !poŞ->
š™Ÿlized
 || 
size
 == 0) {

1268  
NULL
;

1272 
block
 = 
poŞ
->
ä“_li¡
; block; block = block->
Ãxt
) {

1273 ià(
block
->
magic
 =ğ
MEM_MAGIC_FREE
 && block->
size
 >= size) {

1278 ià(!
block
) {

1280  
NULL
;

1284 ià(
block
->
size
 > 
tÙ®_size
 + (
mem_block_t
)) {

1285 
Ãw_block
 = (
mem_block_t
*)((
ušt8_t
*)
block
 + 
tÙ®_size
);

1286 
Ãw_block
->
size
 = 
block
->siz- 
tÙ®_size
;

1287 
Ãw_block
->
æags
 = 0;

1288 
Ãw_block
->
ty³
 = 
MEM_TYPE_GENERAL
;

1289 
Ãw_block
->
magic
 = 
MEM_MAGIC_FREE
;

1290 
Ãw_block
->
Ãxt
 = 
block
->next;

1291 
Ãw_block
->
´ev
 = 
block
;

1293 ià(
block
->
Ãxt
) {

1294 
block
->
Ãxt
->
´ev
 = 
Ãw_block
;

1296 
block
->
Ãxt
 = 
Ãw_block
;

1298 
block
->
size
 = size;

1302 
block
->
magic
 = 
MEM_MAGIC_ALLOCATED
;

1303 
block
->
æags
 = flags;

1306 
poŞ
->
u£d
 +ğ
block
->
size
 + (
mem_block_t
);

1307 
poŞ
->
ä“
 -ğ
block
->
size
 + (
mem_block_t
);

1308 
poŞ
->
®loc_couÁ
++;

1310  (*)((
ušt8_t
*)
block
 + (
mem_block_t
));

1311 
	}
}

1318 
	$memÜy_poŞ_ä“
(
mem_poŞ_t
 *
poŞ
, *
±r
) {

1319 
mem_block_t
 *
block
;

1321 ià(!
poŞ
 || !
±r
) {

1325 
block
 = (
mem_block_t
*)((
ušt8_t
*)
±r
 - (mem_block_t));

1327 ià(
block
->
magic
 !ğ
MEM_MAGIC_ALLOCATED
) {

1332 
block
->
magic
 = 
MEM_MAGIC_FREE
;

1335 
poŞ
->
u£d
 -ğ
block
->
size
 + (
mem_block_t
);

1336 
poŞ
->
ä“
 +ğ
block
->
size
 + (
mem_block_t
);

1337 
poŞ
->
ä“_couÁ
++;

1342 
mem_block_t
 *
Ãxt_block
 = (mem_block_t*)((
ušt8_t
*)
block
 + (mem_block_tè+ block->
size
);

1343 ià((
ušt32_t
)
Ãxt_block
 < (ušt32_t)
poŞ
->
ba£
 +…oŞ->
size
 &&

1344 
Ãxt_block
->
magic
 =ğ
MEM_MAGIC_FREE
) {

1347 
block
->
size
 +ğ(
mem_block_t
è+ 
Ãxt_block
->size;

1350 ià(
Ãxt_block
->
Ãxt
) {

1351 
Ãxt_block
->
Ãxt
->
´ev
 = 
block
;

1353 
block
->
Ãxt
 = 
Ãxt_block
->next;

1356 
Ãxt_block
->
magic
 = 0;

1358 
poŞ
->
block_couÁ
--;

1362 ià(
block
->
´ev
 && block->´ev->
magic
 =ğ
MEM_MAGIC_FREE
) {

1363 
mem_block_t
 *
´ev_block
 = 
block
->
´ev
;

1366 
mem_block_t
 *
ex³ùed_Ãxt
 = (mem_block_t*)((
ušt8_t
*)
´ev_block
 + (mem_block_tè+…»v_block->
size
);

1367 ià(
ex³ùed_Ãxt
 =ğ
block
) {

1369 
´ev_block
->
size
 +ğ(
mem_block_t
è+ 
block
->size;

1372 ià(
block
->
Ãxt
) {

1373 
block
->
Ãxt
->
´ev
 = 
´ev_block
;

1375 
´ev_block
->
Ãxt
 = 
block
->next;

1378 
block
->
magic
 = 0;

1380 
poŞ
->
block_couÁ
--;

1383 
	}
}

1390 
ušt32_t
 
	$memÜy_poŞ_g‘_ä“_size
(cÚ¡ 
mem_poŞ_t
 *
poŞ
) {

1391  
poŞ
 ?…oŞ->
ä“
 : 0;

1392 
	}
}

1399 
ušt32_t
 
	$memÜy_poŞ_g‘_u£d_size
(cÚ¡ 
mem_poŞ_t
 *
poŞ
) {

1400  
poŞ
 ?…oŞ->
u£d
 : 0;

1401 
	}
}

1408 
ušt32_t
 
	$memÜy_poŞ_g‘_Ïrge¡_ä“
(cÚ¡ 
mem_poŞ_t
 *
poŞ
) {

1409 
mem_block_t
 *
block
;

1410 
ušt32_t
 
Ïrge¡
 = 0;

1412 ià(!
poŞ
 || !poŞ->
š™Ÿlized
) {

1416 
block
 = 
poŞ
->
ä“_li¡
; block; block = block->
Ãxt
) {

1417 ià(
block
->
magic
 =ğ
MEM_MAGIC_FREE
 && block->
size
 > 
Ïrge¡
) {

1418 
Ïrge¡
 = 
block
->
size
;

1422  
Ïrge¡
;

1423 
	}
}

1429 
memÜy_£t_”rÜ_hªdËr
((*
hªdËr
)(
mem_”rÜ_t
 
”rÜ
, cÚ¡ * 
mes§ge
)) {

1430 
g_memÜy_sy¡em
.
”rÜ_hªdËr
 = 
hªdËr
;

1431 
	}
}

1436 
	$memÜy_´št_¡©s
() {

1437 cÚ¡ 
mem_¡©s_t
 *
¡©s
 = &
g_mem_¡©s
;

1439 
	`log_šfo
("=== Memory Statistics ===");

1440 
	`log_šfo
("TÙ®‡ÎoÿtiÚs: %lu", 
¡©s
->
tÙ®_®loÿtiÚs
);

1441 
	`log_šfo
("TÙ® f»es: %lu", 
¡©s
->
tÙ®_ä“s
);

1442 
	`log_šfo
("Cu¼’ˆu£d: %lu by‹s", 
¡©s
->
u£d_memÜy
);

1443 
	`log_šfo
("P—k u§ge: %lu by‹s", 
¡©s
->
³ak_u§ge
);

1444 
	`log_šfo
("AÎoÿtiÚ fau»s: %lu", 
¡©s
->
®loÿtiÚ_çu»s
);

1445 
	`log_šfo
("L¬ge¡‡ÎoÿtiÚ: %lu by‹s", 
¡©s
->
Ïrge¡_®loÿtiÚ
);

1446 
	`log_šfo
("Sm®Ë¡‡ÎoÿtiÚ: %lu by‹s", 
¡©s
->
sm®Ë¡_®loÿtiÚ
);

1449 
	`log_šfo
("=== Three-Tier Memory Usage ===");

1450 ià(
g_memÜy_sy¡em
.
xms_avaabË
) {

1451 
	`log_šfo
("XMS Tier 1: %lu bytes‡llocated (peak: %lu)",

1452 
g_xms_t›r
.
tÙ®_®loÿ‹d
, g_xms_t›r.
³ak_®loÿ‹d
);

1454 ià(
g_memÜy_sy¡em
.
umb_avaabË
) {

1455 
	`log_šfo
("UMB Tier 2: %lu bytes‡llocated (peak: %lu), %d segments",

1456 
g_umb_t›r
.
tÙ®_®loÿ‹d
, g_umb_t›r.
³ak_®loÿ‹d
, g_umb_t›r.
hªdË_couÁ
);

1458 
	`log_šfo
("Conventional Tier 3: Available for fallback");

1459 
	}
}

1470 
	$memÜy_com´eh’sive_¡»ss_‹¡
() {

1471 
»suÉ
 = 0;

1472 
‹¡s_·s£d
 = 0;

1473 
‹¡s_çed
 = 0;

1475 
	`log_šfo
("=== Starting Comprehensive Memory Stress Test ===");

1478 
	`log_šfo
("Running‡llocation…atterns stressest...");

1479 ià(
	`memÜy_¡»ss_‹¡_®loÿtiÚ_·‰”ns
() == 0) {

1480 
‹¡s_·s£d
++;

1481 
	`log_šfo
("Allocation…atternsest PASSED");

1483 
‹¡s_çed
++;

1484 
	`log_”rÜ
("Allocation…atternsest FAILED");

1485 
»suÉ
 = -1;

1489 
	`log_šfo
("Running fragmentation stressest...");

1490 ià(
	`memÜy_¡»ss_‹¡_äagm’tiÚ
() == 0) {

1491 
‹¡s_·s£d
++;

1492 
	`log_šfo
("Fragmentationest PASSED");

1494 
‹¡s_çed
++;

1495 
	`log_”rÜ
("Fragmentationest FAILED");

1496 
»suÉ
 = -1;

1500 
	`log_šfo
("Running†eak detectionest...");

1501 ià(
	`memÜy_¡»ss_‹¡_Ëak_d‘eùiÚ
() == 0) {

1502 
‹¡s_·s£d
++;

1503 
	`log_šfo
("Leak detectionest PASSED");

1505 
‹¡s_çed
++;

1506 
	`log_”rÜ
("Leak detectionest FAILED");

1507 
»suÉ
 = -1;

1511 
	`log_šfo
("Running boundary conditionsest...");

1512 ià(
	`memÜy_¡»ss_‹¡_bound¬y_cÚd™iÚs
() == 0) {

1513 
‹¡s_·s£d
++;

1514 
	`log_šfo
("Boundary conditionsest PASSED");

1516 
‹¡s_çed
++;

1517 
	`log_”rÜ
("Boundary conditionsest FAILED");

1518 
»suÉ
 = -1;

1522 
	`log_šfo
("Running concurrent operationsest...");

1523 ià(
	`memÜy_¡»ss_‹¡_cÚcu¼’t_İ”©iÚs
() == 0) {

1524 
‹¡s_·s£d
++;

1525 
	`log_šfo
("Concurrent operationsest PASSED");

1527 
‹¡s_çed
++;

1528 
	`log_”rÜ
("Concurrent operationsest FAILED");

1529 
»suÉ
 = -1;

1533 
	`log_šfo
("Runningier switchingest...");

1534 ià(
	`memÜy_¡»ss_‹¡_t›r_sw™chšg
() == 0) {

1535 
‹¡s_·s£d
++;

1536 
	`log_šfo
("Tier switchingest PASSED");

1538 
‹¡s_çed
++;

1539 
	`log_”rÜ
("Tier switchingest FAILED");

1540 
»suÉ
 = -1;

1544 
	`log_šfo
("Running corruption detectionest...");

1545 ià(
	`memÜy_³rfÜm_cÜru±iÚ_‹¡
() == 0) {

1546 
‹¡s_·s£d
++;

1547 
	`log_šfo
("Corruption detectionest PASSED");

1549 
‹¡s_çed
++;

1550 
	`log_”rÜ
("Corruption detectionest FAILED");

1551 
»suÉ
 = -1;

1555 
	`log_šfo
("Runningƒxtreme‡llocationest...");

1556 ià(
	`memÜy_‹¡_exŒeme_®loÿtiÚs
() == 0) {

1557 
‹¡s_·s£d
++;

1558 
	`log_šfo
("Extreme‡llocationest PASSED");

1560 
‹¡s_çed
++;

1561 
	`log_”rÜ
("Extreme‡llocationest FAILED");

1562 
»suÉ
 = -1;

1566 
	`log_šfo
("Running†ow memory simulation...");

1567 
	`memÜy_simuÏ‹_low_memÜy_cÚd™iÚs
();

1568 
	`log_šfo
("Low memory simulation completed");

1569 
‹¡s_·s£d
++;

1572 ià(
	`memÜy_v®id©e_®l_®loÿtiÚs
() == 0) {

1573 
‹¡s_·s£d
++;

1574 
	`log_šfo
("Post-test validation PASSED");

1576 
‹¡s_çed
++;

1577 
	`log_”rÜ
("Post-test validation FAILED");

1578 
»suÉ
 = -1;

1581 
	`log_šfo
("=== Memory Stress Test Summary ===");

1582 
	`log_šfo
("Te¡ ·s£d: %d", 
‹¡s_·s£d
);

1583 
	`log_šfo
("Te¡ çed: %d", 
‹¡s_çed
);

1585 ià(
»suÉ
 == 0) {

1586 
	`log_šfo
("=== ALL MEMORY STRESS TESTS PASSED ===");

1588 
	`log_”rÜ
("=== SOME MEMORY STRESS TESTS FAILED ===");

1591  
»suÉ
;

1592 
	}
}

1598 
	$memÜy_¡»ss_‹¡_®loÿtiÚ_·‰”ns
() {

1599 *
±rs
[200];

1600 
ušt32_t
 
sizes
[] = {16, 32, 64, 128, 256, 512, 1024, 2048, 4096};

1601 
num_sizes
 = (
sizes
) / (sizes[0]);

1602 
®loÿ‹d
 = 0;

1603 
·‰”n
;

1606 
	`log_debug
("Testing sequential increasing‡llocation…attern");

1607 
·‰”n
 = 0;…attern < 3;…attern++) {

1608 
i
 = 0; i < 50 && 
®loÿ‹d
 < 200; i++) {

1609 
ušt32_t
 
size
 = 
sizes
[
i
 % 
num_sizes
];

1611 
·‰”n
) {

1613 
±rs
[
®loÿ‹d
] = 
	`memÜy_®loc
(
size
, 
MEM_TYPE_GENERAL
, 0);

1616 
±rs
[
®loÿ‹d
] = 
	`memÜy_®loc
(
size
, 
MEM_TYPE_PACKET_BUFFER
, 
MEM_FLAG_ALIGNED
);

1619 
±rs
[
®loÿ‹d
] = 
	`memÜy_®loc
(
size
, 
MEM_TYPE_PACKET_BUFFER
, 
MEM_FLAG_DMA_CAPABLE
);

1623 ià(
±rs
[
®loÿ‹d
]) {

1625 
	`mem£t
(
±rs
[
®loÿ‹d
], 0xAA + (
i
 % 4), 
size
);

1626 
®loÿ‹d
++;

1631 
	`log_debug
("AÎoÿ‹d %d block š…©‹ºe¡", 
®loÿ‹d
);

1634 
i
 = 0; i < 
®loÿ‹d
; i++) {

1635 ià(
±rs
[
i
]) {

1636 
mem_block_t
 *
block
 = 
	`memÜy_g‘_block_h—d”
(
±rs
[
i
]);

1637 ià(!
	`memÜy_v®id©e_block
(
block
)) {

1638 
	`log_”rÜ
("Block v®id©iÚ faed fÜ‡ÎoÿtiÚ %d", 
i
);

1645 
i
 = 0; i < 
®loÿ‹d
; i += 2) {

1646 ià(
±rs
[
i
]) {

1647 
	`memÜy_ä“
(
±rs
[
i
]);

1648 
±rs
[
i
] = 
NULL
;

1653 
»®loÿ‹d
 = 0;

1654 
i
 = 0; i < 
®loÿ‹d
; i += 2) {

1655 
±rs
[
i
] = 
	`memÜy_®loc
(
sizes
[(i/2è% 
num_sizes
], 
MEM_TYPE_GENERAL
, 0);

1656 ià(
±rs
[
i
]) {

1657 
»®loÿ‹d
++;

1661 
	`log_debug
("R—Îoÿ‹d %d block aá” f¿gm’tiÚ", 
»®loÿ‹d
);

1664 
i
 = 0; i < 
®loÿ‹d
; i++) {

1665 ià(
±rs
[
i
]) {

1666 
	`memÜy_ä“
(
±rs
[
i
]);

1671 
	}
}

1677 
	$memÜy_¡»ss_‹¡_äagm’tiÚ
() {

1678 *
Ïrge_blocks
[10];

1679 *
sm®l_blocks
[100];

1680 
Ïrge_couÁ
 = 0;

1681 
sm®l_couÁ
 = 0;

1683 
	`log_debug
("Testing memory fragmentation scenarios");

1686 
i
 = 0; i < 10; i++) {

1687 
Ïrge_blocks
[
i
] = 
	`memÜy_®loc
(4096, 
MEM_TYPE_PACKET_BUFFER
, 0);

1688 ià(
Ïrge_blocks
[
i
]) {

1689 
Ïrge_couÁ
++;

1694 
i
 = 0; i < 100; i++) {

1695 
sm®l_blocks
[
i
] = 
	`memÜy_®loc
(64, 
MEM_TYPE_GENERAL
, 0);

1696 ià(
sm®l_blocks
[
i
]) {

1697 
sm®l_couÁ
++;

1701 
	`log_debug
("AÎoÿ‹d %d†¬gblock ªd %d sm®Èblocks", 
Ïrge_couÁ
, 
sm®l_couÁ
);

1704 
i
 = 1; i < 10; i += 2) {

1705 ià(
Ïrge_blocks
[
i
]) {

1706 
	`memÜy_ä“
(
Ïrge_blocks
[
i
]);

1707 
Ïrge_blocks
[
i
] = 
NULL
;

1712 
medium_®loÿ‹d
 = 0;

1713 
i
 = 0; i < 5; i++) {

1714 *
medium_±r
 = 
	`memÜy_®loc
(2048, 
MEM_TYPE_PACKET_BUFFER
, 0);

1715 ià(
medium_±r
) {

1716 
medium_®loÿ‹d
++;

1717 
	`memÜy_ä“
(
medium_±r
);

1721 
	`log_debug
("SucûssfuÎy‡Îoÿ‹d %d medium block š g­s", 
medium_®loÿ‹d
);

1724 
i
 = 0; i < 10; i++) {

1725 ià(
Ïrge_blocks
[
i
]) {

1726 
	`memÜy_ä“
(
Ïrge_blocks
[
i
]);

1730 
i
 = 0; i < 100; i++) {

1731 ià(
sm®l_blocks
[
i
]) {

1732 
	`memÜy_ä“
(
sm®l_blocks
[
i
]);

1737 
	}
}

1743 
	$memÜy_¡»ss_‹¡_Ëak_d‘eùiÚ
() {

1744 
ušt32_t
 
š™Ÿl_®loÿtiÚs
 = 
g_mem_¡©s
.
tÙ®_®loÿtiÚs
;

1745 
ušt32_t
 
š™Ÿl_ä“s
 = 
g_mem_¡©s
.
tÙ®_ä“s
;

1746 
ušt32_t
 
š™Ÿl_u£d
 = 
g_mem_¡©s
.
u£d_memÜy
;

1748 
	`log_debug
("Testing†eak detection - initial state: %lu‡llocs, %lu frees, %lu used",

1749 
š™Ÿl_®loÿtiÚs
, 
š™Ÿl_ä“s
, 
š™Ÿl_u£d
);

1752 
cyşe
 = 0; cycle < 5; cycle++) {

1753 *
±rs
[50];

1754 
®loÿ‹d
 = 0;

1757 
i
 = 0; i < 50; i++) {

1758 
±rs
[
i
] = 
	`memÜy_®loc
(128 + (˜* 16), 
MEM_TYPE_GENERAL
, 0);

1759 ià(
±rs
[
i
]) {

1760 
®loÿ‹d
++;

1765 
i
 = 0; i < 
®loÿ‹d
 - 2; i++) {

1766 ià(
±rs
[
i
]) {

1767 
	`memÜy_ä“
(
±rs
[
i
]);

1768 
±rs
[
i
] = 
NULL
;

1773 
ušt32_t
 
cu¼’t_u£d
 = 
g_mem_¡©s
.
u£d_memÜy
;

1774 ià(
cu¼’t_u£d
 <ğ
š™Ÿl_u£d
 + (2 * (128 + 25 * 16))) {

1777 
	`log_w¬nšg
("PÙ’tŸÈmemÜy†—k d‘eùed iÀcyş%d", 
cyşe
);

1781 
i
 = 
®loÿ‹d
 - 2; i <‡llocated; i++) {

1782 ià(
±rs
[
i
]) {

1783 
	`memÜy_ä“
(
±rs
[
i
]);

1789 
ušt32_t
 
fš®_u£d
 = 
g_mem_¡©s
.
u£d_memÜy
;

1790 ià(
fš®_u£d
 <ğ
š™Ÿl_u£d
 + 1024) {

1791 
	`log_debug
("Leak detectionest…assed - memory usage„eturnedo baseline");

1794 
	`log_”rÜ
("PÙ’tŸÈmemÜy†—k: in™Ÿl=%lu, fš®=%lu", 
š™Ÿl_u£d
, 
fš®_u£d
);

1797 
	}
}

1803 
	$memÜy_¡»ss_‹¡_bound¬y_cÚd™iÚs
() {

1804 
	`log_debug
("Testing boundary conditions‡ndƒdge cases");

1807 *
z”o_±r
 = 
	`memÜy_®loc
(0, 
MEM_TYPE_GENERAL
, 0);

1808 ià(
z”o_±r
 !ğ
NULL
) {

1809 
	`log_”rÜ
("Zero-size‡llocation should have failed");

1810 
	`memÜy_ä“
(
z”o_±r
);

1815 *
Ïrge_±r
 = 
	`memÜy_®loc
(32768, 
MEM_TYPE_GENERAL
, 0);

1816 ià(
Ïrge_±r
) {

1818 
	`mem£t
(
Ïrge_±r
, 0x55, 32768);

1821 
ušt8_t
 *
d©a
 = (ušt8_t*)
Ïrge_±r
;

1822 
i
 = 0; i < 1000; i += 100) {

1823 ià(
d©a
[
i
] != 0x55) {

1824 
	`log_”rÜ
("Large‡llocation memory corruption detected");

1825 
	`memÜy_ä“
(
Ïrge_±r
);

1830 
	`memÜy_ä“
(
Ïrge_±r
);

1834 
	`memÜy_ä“
(
NULL
);

1837 *
‹¡_±r
 = 
	`memÜy_®loc
(256, 
MEM_TYPE_GENERAL
, 0);

1838 ià(
‹¡_±r
) {

1839 
	`memÜy_ä“
(
‹¡_±r
);

1841 
	`memÜy_ä“
(
‹¡_±r
);

1845 
®ign
 = 1;‡lign <= 16;‡lign *= 2) {

1846 *
®igÃd_±r
 = 
	`memÜy_®loc_®igÃd
(100, 
®ign
, 
MEM_TYPE_GENERAL
);

1847 ià(
®igÃd_±r
) {

1848 ià(((
ušt32_t
)
®igÃd_±r
 % 
®ign
) != 0) {

1849 
	`log_”rÜ
("Alignm’ˆçed fÜ bound¬y %d", 
®ign
);

1850 
	`memÜy_ä“
(
®igÃd_±r
);

1853 
	`memÜy_ä“
(
®igÃd_±r
);

1857 
	`log_debug
("Boundary conditionsest completed successfully");

1859 
	}
}

1865 
	$memÜy_¡»ss_‹¡_cÚcu¼’t_İ”©iÚs
() {

1866 *
±rs_a
[25];

1867 *
±rs_b
[25];

1868 
®loÿ‹d_a
 = 0;

1869 
®loÿ‹d_b
 = 0;

1871 
	`log_debug
("Simulating concurrent memory operations");

1874 
round
 = 0;„ound < 5;„ound++) {

1876 
i
 = 0; i < 5; i++) {

1877 ià(
®loÿ‹d_a
 < 25) {

1878 
±rs_a
[
®loÿ‹d_a
] = 
	`memÜy_®loc
(64 + (
i
 * 8), 
MEM_TYPE_GENERAL
, 0);

1879 ià(
±rs_a
[
®loÿ‹d_a
]) {

1880 
®loÿ‹d_a
++;

1886 
i
 = 0; i < 3; i++) {

1887 ià(
®loÿ‹d_b
 < 25) {

1888 
±rs_b
[
®loÿ‹d_b
] = 
	`memÜy_®loc
(512 + (
i
 * 64), 
MEM_TYPE_PACKET_BUFFER
, 0);

1889 ià(
±rs_b
[
®loÿ‹d_b
]) {

1890 
®loÿ‹d_b
++;

1896 ià(
®loÿ‹d_a
 >= 3) {

1897 
i
 = 0; i < 2; i++) {

1898 ià(
±rs_a
[
i
]) {

1899 
	`memÜy_ä“
(
±rs_a
[
i
]);

1900 
±rs_a
[
i
] = 
NULL
;

1906 ià(
®loÿ‹d_b
 >= 2) {

1907 ià(
±rs_b
[0]) {

1908 
	`memÜy_ä“
(
±rs_b
[0]);

1909 
±rs_b
[0] = 
NULL
;

1915 
i
 = 0; i < 25; i++) {

1916 ià(
±rs_a
[
i
]) {

1917 
	`memÜy_ä“
(
±rs_a
[
i
]);

1919 ià(
±rs_b
[
i
]) {

1920 
	`memÜy_ä“
(
±rs_b
[
i
]);

1924 
	`log_debug
("Concurrent operations simulation completed");

1926 
	}
}

1932 
	$memÜy_¡»ss_‹¡_t›r_sw™chšg
() {

1933 *
t›r_±rs
[50];

1934 
®loÿ‹d
 = 0;

1936 
	`log_debug
("Testing memoryier switching under…ressure");

1939 
i
 = 0; i < 50; i++) {

1940 
ušt32_t
 
size
;

1941 
mem_ty³_t
 
ty³
;

1942 
ušt32_t
 
æags
 = 0;

1945 ià(
i
 % 3 == 0) {

1946 
size
 = 8192;

1947 
ty³
 = 
MEM_TYPE_PACKET_BUFFER
;

1948 
æags
 = 
MEM_FLAG_DMA_CAPABLE
;

1949 } ià(
i
 % 3 == 1) {

1950 
size
 = 1024;

1951 
ty³
 = 
MEM_TYPE_PACKET_BUFFER
;

1952 
æags
 = 
MEM_FLAG_ALIGNED
;

1954 
size
 = 128;

1955 
ty³
 = 
MEM_TYPE_GENERAL
;

1956 
æags
 = 0;

1959 
t›r_±rs
[
i
] = 
	`memÜy_®loc
(
size
, 
ty³
, 
æags
);

1960 ià(
t›r_±rs
[
i
]) {

1961 
®loÿ‹d
++;

1964 
	`mem£t
(
t›r_±rs
[
i
], 0xCC + (˜% 4), 
size
 > 256 ? 256 : size);

1968 
	`log_debug
("AÎoÿ‹d %d block aüos memÜy›rs", 
®loÿ‹d
);

1971 
i
 = 0; i < 
®loÿ‹d
; i++) {

1972 ià(
t›r_±rs
[
i
]) {

1973 
ušt8_t
 *
d©a
 = (ušt8_t*)
t›r_±rs
[
i
];

1974 
ušt8_t
 
ex³ùed
 = 0xCC + (
i
 % 4);

1976 ià(
d©a
[0] !ğ
ex³ùed
 || data[10] !=ƒxpected) {

1977 
	`log_”rÜ
("Tier‡llocation %d corrupted (expected 0x%02X, got 0x%02X)",

1978 
i
, 
ex³ùed
, 
d©a
[0]);

1985 
i
 = 0; i < 50; i++) {

1986 ià(
t›r_±rs
[
i
]) {

1987 
	`memÜy_ä“
(
t›r_±rs
[
i
]);

1991 
	`log_debug
("Tier switchingest completed successfully");

1993 
	}
}

1999 
	$memÜy_v®id©e_®l_®loÿtiÚs
() {

2003 
	`log_debug
("Validating‡ll memory‡llocations for corruption");

2006 ià(
g_mem_¡©s
.
tÙ®_®loÿtiÚs
 < g_mem_¡©s.
tÙ®_ä“s
) {

2007 
	`log_”rÜ
("Memory statistics inconsistent:‡llocs=%lu < frees=%lu",

2008 
g_mem_¡©s
.
tÙ®_®loÿtiÚs
, g_mem_¡©s.
tÙ®_ä“s
);

2013 ià(
g_mem_¡©s
.
u£d_memÜy
 > 1024 * 1024) {

2014 
	`log_w¬nšg
("High memÜy u§gd‘eùed: %lu by‹s", 
g_mem_¡©s
.
u£d_memÜy
);

2018 ià(
g_xms_t›r
.
tÙ®_®loÿ‹d
 > g_xms_t›r.
³ak_®loÿ‹d
) {

2019 
	`log_”rÜ
("XMSier statistics inconsistent");

2023 ià(
g_umb_t›r
.
tÙ®_®loÿ‹d
 > g_umb_t›r.
³ak_®loÿ‹d
) {

2024 
	`log_”rÜ
("UMBier statistics inconsistent");

2028 
	`log_debug
("Memory validation completed -‚o corruption detected");

2030 
	}
}

2036 
	$memÜy_³rfÜm_cÜru±iÚ_‹¡
() {

2037 *
‹¡_±r
;

2038 
mem_block_t
 *
block
;

2040 
	`log_debug
("Testing memory corruption detection");

2043 
‹¡_±r
 = 
	`memÜy_®loc
(256, 
MEM_TYPE_GENERAL
, 0);

2044 ià(!
‹¡_±r
) {

2045 
	`log_”rÜ
("Failedo‡llocateest block for corruptionest");

2050 
block
 = 
	`memÜy_g‘_block_h—d”
(
‹¡_±r
);

2051 ià(!
	`memÜy_v®id©e_block
(
block
)) {

2052 
	`log_”rÜ
("Initial block validation failed");

2053 
	`memÜy_ä“
(
‹¡_±r
);

2058 
ušt32_t
 
Üigš®_magic
 = 
block
->
magic
;

2059 
block
->
magic
 = 0xDEADBEEF;

2062 ià(
	`memÜy_v®id©e_block
(
block
)) {

2063 
	`log_”rÜ
("Corruption detection failed - corrupted block…assed validation");

2064 
block
->
magic
 = 
Üigš®_magic
;

2065 
	`memÜy_ä“
(
‹¡_±r
);

2070 
block
->
magic
 = 
Üigš®_magic
;

2073 
	`memÜy_ä“
(
‹¡_±r
);

2075 
	`log_debug
("Memory corruption detectionest…assed");

2077 
	}
}

2083 
	$memÜy_‹¡_exŒeme_®loÿtiÚs
() {

2084 
	`log_debug
("Testingƒxtreme‡llocation scenarios");

2087 *
huge_±r
 = 
	`memÜy_®loc
(0x100000, 
MEM_TYPE_GENERAL
, 0);

2088 ià(
huge_±r
) {

2089 
	`log_w¬nšg
("Unexpectedly succeeded in‡llocating 1MB");

2090 
	`memÜy_ä“
(
huge_±r
);

2094 *
tšy_±rs
[1000];

2095 
tšy_®loÿ‹d
 = 0;

2097 
i
 = 0; i < 1000; i++) {

2098 
tšy_±rs
[
i
] = 
	`memÜy_®loc
(8, 
MEM_TYPE_GENERAL
, 0);

2099 ià(
tšy_±rs
[
i
]) {

2100 
tšy_®loÿ‹d
++;

2106 
	`log_debug
("SucûssfuÎy‡Îoÿ‹d %dšy (8-by‹èblocks", 
tšy_®loÿ‹d
);

2109 
i
 = 0; i < 
tšy_®loÿ‹d
; i++) {

2110 ià(
tšy_±rs
[
i
]) {

2111 
	`memÜy_ä“
(
tšy_±rs
[
i
]);

2116 *
šv®id_±r
 = 
	`memÜy_®loc
(100, 99, 0xFFFFFFFF);

2117 ià(
šv®id_±r
) {

2118 
	`log_w¬nšg
("Allocation with invalid…arameters unexpectedly succeeded");

2119 
	`memÜy_ä“
(
šv®id_±r
);

2122 
	`log_debug
("Extreme‡llocation scenariosest completed");

2124 
	}
}

2129 
	$memÜy_simuÏ‹_low_memÜy_cÚd™iÚs
() {

2130 *
exhau¡iÚ_±rs
[100];

2131 
®loÿ‹d
 = 0;

2133 
	`log_debug
("Simulating†ow memory conditions");

2136 
i
 = 0; i < 100; i++) {

2137 
exhau¡iÚ_±rs
[
i
] = 
	`memÜy_®loc
(4096, 
MEM_TYPE_GENERAL
, 0);

2138 ià(
exhau¡iÚ_±rs
[
i
]) {

2139 
®loÿ‹d
++;

2145 
	`log_debug
("AÎoÿ‹d %d†¬gblock befÜmemÜyƒxhau¡iÚ", 
®loÿ‹d
);

2148 
sm®l_®loÿ‹d
 = 0;

2149 
i
 = 0; i < 20; i++) {

2150 *
sm®l_±r
 = 
	`memÜy_®loc
(64, 
MEM_TYPE_GENERAL
, 0);

2151 ià(
sm®l_±r
) {

2152 
sm®l_®loÿ‹d
++;

2153 
	`memÜy_ä“
(
sm®l_±r
);

2159 
	`log_debug
("SucûssfuÎy‡Îoÿ‹d %d sm®Èblock und” memÜy…»ssu»", 
sm®l_®loÿ‹d
);

2162 
mem_”rÜ_t
 
Ï¡_”rÜ
 = 
	`memÜy_g‘_Ï¡_”rÜ
();

2163 ià(
Ï¡_”rÜ
 =ğ
MEM_ERROR_NO_MEMORY
 ||†a¡_”rÜ =ğ
MEM_ERROR_NONE
) {

2164 
	`log_debug
("Memoryƒrror handling working correctly");

2166 
	`log_w¬nšg
("UÃx³ùed memÜyƒ¼Ü: %d", 
Ï¡_”rÜ
);

2170 
i
 = 0; i < 
®loÿ‹d
; i++) {

2171 ià(
exhau¡iÚ_±rs
[
i
]) {

2172 
	`memÜy_ä“
(
exhau¡iÚ_±rs
[
i
]);

2176 
	`log_debug
("Low memory simulation completed");

2177 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/nic_init.c

11 
	~"../šşude/nic_š™.h
"

12 
	~"../šşude/loggšg.h
"

13 
	~"../šşude/memÜy.h
"

14 
	~"../šşude/dŸgno¡ics.h
"

15 
	~"../šşude/3c509b.h
"

16 
	~"../šşude/3c515.h
"

17 
	~"../šşude/commÚ.h
"

18 
	~"../šşude/nic_defs.h
"

19 
	~"../šşude/cÚfig.h
"

20 
	~"../šşude/ÿche_coh”’cy.h
"

21 
	~"../šşude/ÿche_mªagem’t.h
"

22 
	~"../šşude/ch£t_d‘eù.h
"

23 
	~"../šşude/ch£t_d©aba£.h
"

24 
	~"../šşude/³rfÜmªû_’abËr.h
"

25 
	~<¡ršg.h
>

28 
boŞ
 
	gg_nic_š™_sy¡em_»ady
 = 
çl£
;

29 
nic_š™_¡©s_t
 
	gg_nic_š™_¡©s
;

32 
boŞ
 
	gg_nic_š™_š™Ÿlized
 = 
çl£
;

35 
boŞ
 
	gg_ÿche_coh”’cy_š™Ÿlized
 = 
çl£
;

36 
coh”’cy_ª®ysis_t
 
	gg_sy¡em_coh”’cy_ª®ysis
;

37 
ch£t_d‘eùiÚ_»suÉ_t
 
	gg_sy¡em_ch£t_d‘eùiÚ
;

40 
nic_»£t_h¬dw¬e
(
nic_šfo_t
 *
nic
);

41 
nic_wa™_fÜ_»ady
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
);

42 
nic_š™_upd©e_¡©s
(
boŞ
 
sucûss
, boŞ 
d‘eùiÚ
);

43 
boŞ
 
is_z”o_mac
(cÚ¡ 
ušt8_t
 *
mac
);

44 
ušt32_t
 
g‘_nic_ÿ·b™›s_äom_ty³
(
nic_ty³_t
 
ty³
);

47 
nic_š™_ÿche_coh”’cy_sy¡em
();

48 
nic_š™_­¶y_coh”’cy_to_nic
(
nic_šfo_t
 *
nic
);

49 
nic_š™_di¥Ïy_sy¡em_ª®ysis
();

52 
ud–ay
(
ušt32_t
 
miüo£cÚds
);

53 
md–ay
(
ušt32_t
 
mli£cÚds
);

56 
	$nic_š™_sy¡em
() {

57 ià(
g_nic_š™_š™Ÿlized
) {

58  
SUCCESS
;

61 
	`LOG_INFO
("Initializing NIC system with cache coherency management...");

64 
	`nic_š™_¡©s_ş—r
();

67 
coh”’cy_»suÉ
 = 
	`nic_š™_ÿche_coh”’cy_sy¡em
();

68 ià(
coh”’cy_»suÉ
 !ğ
SUCCESS
) {

69 
	`LOG_ERROR
("Cachcoh”’cy sy¡em in™Ÿliz©iÚ faed: %d", 
coh”’cy_»suÉ
);

70  
coh”’cy_»suÉ
;

75 
	`²p_š™_sy¡em
();

76 
	`²p_d‘eù_nics
(
nic_d‘eù_šfo_t
 *
šfo_li¡
, 
max_nics
);

79 
²p_š™_»suÉ
 = 
	`²p_š™_sy¡em
();

80 ià(
²p_š™_»suÉ
 !ğ
SUCCESS
) {

81 
	`LOG_WARNING
("PnP sy¡em in™Ÿliz©iÚ faed: %d - cÚtšušg w™h ISA d‘eùiÚ oÆy", 
²p_š™_»suÉ
);

85 
nic_d‘eù_šfo_t
 
²p_d‘eùiÚ_»suÉs
[
MAX_NICS
];

86 
²p_d‘eùed_couÁ
 = 0;

88 ià(
²p_š™_»suÉ
 =ğ
SUCCESS
) {

89 
²p_d‘eùed_couÁ
 = 
	`²p_d‘eù_nics
(
²p_d‘eùiÚ_»suÉs
, 
MAX_NICS
);

90 ià(
²p_d‘eùed_couÁ
 > 0) {

91 
	`LOG_INFO
("PnP d‘eùiÚ found %d suµÜ‹d 3Com deviûs", 
²p_d‘eùed_couÁ
);

94 
i
 = 0; i < 
²p_d‘eùed_couÁ
 && i < 
MAX_NICS
; i++) {

95 
	`LOG_DEBUG
("PnP Deviû %d: Ty³=%d, I/O=0x%X, IRQ=%d", 
i
,

96 
²p_d‘eùiÚ_»suÉs
[
i
].
ty³
,

97 
²p_d‘eùiÚ_»suÉs
[
i
].
io_ba£
,

98 
²p_d‘eùiÚ_»suÉs
[
i
].
œq
);

101 
	`LOG_DEBUG
("No PnP devices detected, will use†egacy ISA detection");

106 
	`h¬dw¬e_£t_²p_d‘eùiÚ_»suÉs
(cÚ¡ 
nic_d‘eù_šfo_t
 *
»suÉs
, 
couÁ
);

107 ià(
²p_d‘eùed_couÁ
 > 0) {

108 
	`h¬dw¬e_£t_²p_d‘eùiÚ_»suÉs
(
²p_d‘eùiÚ_»suÉs
, 
²p_d‘eùed_couÁ
);

111 
g_nic_š™_š™Ÿlized
 = 
Œue
;

112 
g_nic_š™_sy¡em_»ady
 = 
Œue
;

115 
	`nic_š™_di¥Ïy_sy¡em_ª®ysis
();

117 
	`LOG_INFO
("NIC initialization system„eady with cache coherency management");

119  
SUCCESS
;

120 
	}
}

122 
	$nic_š™_ş—nup
() {

123 ià(!
g_nic_š™_š™Ÿlized
) {

127 
	`LOG_INFO
("Shutting down NIC initialization system");

129 
g_nic_š™_š™Ÿlized
 = 
çl£
;

130 
g_nic_š™_sy¡em_»ady
 = 
çl£
;

131 
	}
}

133 
	$nic_š™_®l_d‘eùed
() {

134 ià(!
g_nic_š™_sy¡em_»ady
) {

135  
ERROR_NOT_FOUND
;

139 
nic_d‘eù_šfo_t
 
d‘eù_li¡
[
MAX_NICS
];

140 
d‘eùed_couÁ
 = 
	`nic_d‘eù_®l
(
d‘eù_li¡
, 
MAX_NICS
);

142 ià(
d‘eùed_couÁ
 <= 0) {

143 
	`LOG_WARNING
("No NICs detected");

144  
ERROR_NOT_FOUND
;

147 
	`LOG_INFO
("D‘eùed %d NICs, in™Ÿlizšg...", 
d‘eùed_couÁ
);

150 
š™Ÿlized_couÁ
 = 0;

151 
i
 = 0; i < 
d‘eùed_couÁ
 && i < 
MAX_NICS
; i++) {

152 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
i
);

153 ià(
nic
) {

154 
»suÉ
 = 
	`nic_š™_äom_d‘eùiÚ
(
nic
, &
d‘eù_li¡
[
i
]);

155 ià(
»suÉ
 =ğ
SUCCESS
) {

156 
š™Ÿlized_couÁ
++;

157 
	`LOG_INFO
("SucûssfuÎy in™Ÿlized NIC %d", 
i
);

159 
	`LOG_ERROR
("FaedØš™ŸlizNIC %d: %d", 
i
, 
»suÉ
);

164 
	`LOG_INFO
("In™Ÿlized %d oà%d d‘eùed NICs", 
š™Ÿlized_couÁ
, 
d‘eùed_couÁ
);

166  
š™Ÿlized_couÁ
 > 0 ? 
SUCCESS
 : 
ERROR_HARDWARE
;

167 
	}
}

169 
	$nic_š™_couÁ_d‘eùed
() {

170 
nic_d‘eù_šfo_t
 
d‘eù_li¡
[
MAX_NICS
];

171  
	`nic_d‘eù_®l
(
d‘eù_li¡
, 
MAX_NICS
);

172 
	}
}

175 
	$nic_š™_sšgË
(
nic_šfo_t
 *
nic
, cÚ¡ 
nic_š™_cÚfig_t
 *
cÚfig
) {

176 ià(!
nic
 || !
cÚfig
) {

177  
ERROR_INVALID_PARAM
;

180 
g_nic_š™_¡©s
.
tÙ®_š™Ÿliz©iÚs
++;

182 
	`LOG_INFO
("In™Ÿlizšg NICy³ %d‡ˆI/O 0x%X", 
cÚfig
->
nic_ty³
, cÚfig->
io_ba£
);

185 
nic
->
ty³
 = 
cÚfig
->
nic_ty³
;

186 
nic
->
io_ba£
 = 
cÚfig
->io_base;

187 
nic
->
œq
 = 
cÚfig
->irq;

188 
nic
->
dma_chªÃl
 = 
cÚfig
->dma_channel;

191 ià(!(
cÚfig
->
æags
 & 
NIC_INIT_FLAG_NO_RESET
)) {

192 
»suÉ
 = 
	`nic_»£t_h¬dw¬e
(
nic
);

193 ià(
»suÉ
 !ğ
SUCCESS
) {

194 
	`LOG_ERROR
("H¬dw¬»£ˆçed: %d", 
»suÉ
);

195 
	`nic_š™_upd©e_¡©s
(
çl£
, false);

196  
»suÉ
;

201 
»suÉ
;

202 
cÚfig
->
nic_ty³
) {

203 
NIC_TYPE_3C509B
:

204 
»suÉ
 = 
	`nic_š™_3c509b
(
nic
, 
cÚfig
);

206 
NIC_TYPE_3C515_TX
:

207 
»suÉ
 = 
	`nic_š™_3c515
(
nic
, 
cÚfig
);

210 
	`LOG_ERROR
("UnsuµÜ‹d NICy³: %d", 
cÚfig
->
nic_ty³
);

211 
	`nic_š™_upd©e_¡©s
(
çl£
, false);

212  
ERROR_NOT_SUPPORTED
;

215 ià(
»suÉ
 !ğ
SUCCESS
) {

216 
	`LOG_ERROR
("H¬dw¬e-¥ecifiøš™Ÿliz©iÚ faed: %d", 
»suÉ
);

217 
	`nic_š™_upd©e_¡©s
(
çl£
, false);

218  
»suÉ
;

222 
»suÉ
 = 
	`nic_š™_bufãrs
(
nic
);

223 ià(
»suÉ
 !ğ
SUCCESS
) {

224 
	`LOG_ERROR
("Bufã¸š™Ÿliz©iÚ faed: %d", 
»suÉ
);

225 
	`nic_š™_upd©e_¡©s
(
çl£
, false);

226  
»suÉ
;

230 ià(!(
cÚfig
->
æags
 & 
NIC_INIT_FLAG_SKIP_TEST
)) {

231 
»suÉ
 = 
	`nic_run_£lf_‹¡
(
nic
);

232 ià(
»suÉ
 !ğ
SUCCESS
) {

233 
	`LOG_WARNING
("S–f-‹¡ faed: %d", 
»suÉ
);

239 
»suÉ
 = 
	`nic_š™_­¶y_coh”’cy_to_nic
(
nic
);

240 ià(
»suÉ
 !ğ
SUCCESS
) {

241 
	`LOG_ERROR
("Cachcoh”’cy‡µliÿtiÚ faed: %d", 
»suÉ
);

242 
	`nic_š™_upd©e_¡©s
(
çl£
, false);

243  
»suÉ
;

247 
nic
->
¡©us
 |ğ
NIC_STATUS_PRESENT
 | 
NIC_STATUS_INITIALIZED
 | 
NIC_STATUS_ACTIVE
;

249 
	`nic_š™_upd©e_¡©s
(
Œue
, 
çl£
);

251 
	`LOG_INFO
("NIC initialization completed successfully with cache coherency");

253  
SUCCESS
;

254 
	}
}

256 
	$nic_š™_äom_d‘eùiÚ
(
nic_šfo_t
 *
nic
, cÚ¡ 
nic_d‘eù_šfo_t
 *
d‘eù_šfo
) {

257 ià(!
nic
 || !
d‘eù_šfo
 || !d‘eù_šfo->
d‘eùed
) {

258  
ERROR_INVALID_PARAM
;

262 
nic_š™_cÚfig_t
 
cÚfig
;

263 
	`nic_š™_cÚfig_deçuÉs
(&
cÚfig
, 
d‘eù_šfo
->
ty³
);

265 
cÚfig
.
nic_ty³
 = 
d‘eù_šfo
->
ty³
;

266 
cÚfig
.
io_ba£
 = 
d‘eù_šfo
->io_base;

267 
cÚfig
.
œq
 = 
d‘eù_šfo
->irq;

268 
cÚfig
.
auto_d‘eù
 = 
çl£
;

271 
	`memÜy_cİy
(
nic
->
mac
, 
d‘eù_šfo
->mac, 
ETH_ALEN
);

272 
	`memÜy_cİy
(
nic
->
³rm_mac
, 
d‘eù_šfo
->
mac
, 
ETH_ALEN
);

274  
	`nic_š™_sšgË
(
nic
, &
cÚfig
);

275 
	}
}

278 
	$nic_d‘eù_®l
(
nic_d‘eù_šfo_t
 *
d‘eù_li¡
, 
max_nics
) {

279 ià(!
d‘eù_li¡
 || 
max_nics
 <= 0) {

280  
ERROR_INVALID_PARAM
;

283 
g_nic_š™_¡©s
.
tÙ®_d‘eùiÚs
++;

285 
tÙ®_d‘eùed
 = 0;

288 
d‘eùed_3c509b
 = 
	`nic_d‘eù_3c509b
(
d‘eù_li¡
 + 
tÙ®_d‘eùed
,

289 
max_nics
 - 
tÙ®_d‘eùed
);

290 ià(
d‘eùed_3c509b
 > 0) {

291 
tÙ®_d‘eùed
 +ğ
d‘eùed_3c509b
;

292 
	`LOG_INFO
("D‘eùed %d 3C509B NICs", 
d‘eùed_3c509b
);

296 ià(
tÙ®_d‘eùed
 < 
max_nics
) {

297 
d‘eùed_3c515
 = 
	`nic_d‘eù_3c515
(
d‘eù_li¡
 + 
tÙ®_d‘eùed
,

298 
max_nics
 - 
tÙ®_d‘eùed
);

299 ià(
d‘eùed_3c515
 > 0) {

300 
tÙ®_d‘eùed
 +ğ
d‘eùed_3c515
;

301 
	`LOG_INFO
("D‘eùed %d 3C515 NICs", 
d‘eùed_3c515
);

305 ià(
tÙ®_d‘eùed
 > 0) {

306 
g_nic_š™_¡©s
.
sucûssful_d‘eùiÚs
++;

309 
	`LOG_INFO
("TÙ® NIC d‘eùed: %d", 
tÙ®_d‘eùed
);

311  
tÙ®_d‘eùed
;

312 
	}
}

314 
	$nic_d‘eù_3c509b
(
nic_d‘eù_šfo_t
 *
šfo_li¡
, 
max_couÁ
) {

315 ià(!
šfo_li¡
 || 
max_couÁ
 <= 0) {

316  
ERROR_INVALID_PARAM
;

319 
d‘eùed_couÁ
 = 0;

322 
i
 = 0; i < 
NIC_3C509B_IO_COUNT
 && 
d‘eùed_couÁ
 < 
max_couÁ
; i++) {

323 
ušt16_t
 
io_ba£
 = 
NIC_3C509B_IO_BASES
[
i
];

325 ià(
	`nic_´obe_3c509b_©_add»ss
(
io_ba£
, &
šfo_li¡
[
d‘eùed_couÁ
])) {

326 
	`LOG_DEBUG
("Found 3C509B‡ˆI/O 0x%X", 
io_ba£
);

327 
d‘eùed_couÁ
++;

332 
²p_d‘eùed
 = 
	`nic_d‘eù_²p_3c509b
(
šfo_li¡
 + 
d‘eùed_couÁ
,

333 
max_couÁ
 - 
d‘eùed_couÁ
);

334 
d‘eùed_couÁ
 +ğ
²p_d‘eùed
;

336  
d‘eùed_couÁ
;

337 
	}
}

339 
	$nic_d‘eù_3c515
(
nic_d‘eù_šfo_t
 *
šfo_li¡
, 
max_couÁ
) {

340 ià(!
šfo_li¡
 || 
max_couÁ
 <= 0) {

341  
ERROR_INVALID_PARAM
;

344 
d‘eùed_couÁ
 = 0;

347 
i
 = 0; i < 
NIC_3C515_IO_COUNT
 && 
d‘eùed_couÁ
 < 
max_couÁ
; i++) {

348 
ušt16_t
 
io_ba£
 = 
NIC_3C515_IO_BASES
[
i
];

350 ià(
	`nic_´obe_3c515_©_add»ss
(
io_ba£
, &
šfo_li¡
[
d‘eùed_couÁ
])) {

351 
	`LOG_DEBUG
("Found 3C515‡ˆI/O 0x%X", 
io_ba£
);

352 
d‘eùed_couÁ
++;

356  
d‘eùed_couÁ
;

357 
	}
}

360 
	$nic_š™_3c509b
(
nic_šfo_t
 *
nic
, cÚ¡ 
nic_š™_cÚfig_t
 *
cÚfig
) {

361 ià(!
nic
 || !
cÚfig
) {

362  
ERROR_INVALID_PARAM
;

365 
	`LOG_DEBUG
("In™Ÿlizšg 3C509B‡ˆI/O 0x%X w™h‡dvªûd f—tu»s", 
cÚfig
->
io_ba£
);

368 
nic
->
İs
 = 
	`g‘_3c509b_İs
();

369 ià(!
nic
->
İs
) {

370  
ERROR_NOT_FOUND
;

374 
nic
->
mtu
 = 1514;

375 
nic
->
ÿ·b™›s
 = 
	`g‘_nic_ÿ·b™›s_äom_ty³
(
NIC_TYPE_3C509B
);

376 
nic
->
¥“d
 = 10;

377 
nic
->
fuÎ_du¶ex
 = 
çl£
;

382 
nic
->
tx_fifo_th»shŞd
 = 512;

383 
nic
->
rx_fifo_th»shŞd
 = 16;

386 
nic
->
medŸ_ty³
 = 
NIC_MEDIA_AUTO
;

389 
nic
->
´omiscuous_ÿ·bË
 = 
Œue
;

390 
nic
->
muÉiÿ¡_ÿ·bË
 = 
Œue
;

393 ià(
	`is_z”o_mac
(
nic
->
mac
)) {

394 
»suÉ
 = 
	`nic_»ad_mac_add»ss_3c509b
(
cÚfig
->
io_ba£
, 
nic
->
mac
);

395 ià(
»suÉ
 !ğ
SUCCESS
) {

396 
	`LOG_ERROR
("Failedo„ead MAC‡ddress");

397  
»suÉ
;

399 
	`memÜy_cİy
(
nic
->
³rm_mac
,‚ic->
mac
, 
ETH_ALEN
);

403 ià(
nic
->
ÿ·b™›s
 & 
HW_CAP_PROMISCUOUS
) {

405 
nic
->
š‹¼u±_cßËsû_couÁ
 = 4;

406 
nic
->
š‹¼u±_cßËsû_timeout
 = 50;

407 
	`LOG_DEBUG
("3C509B interrupt mitigation configured");

411 ià(
nic
->
İs
->
š™
) {

412 
»suÉ
 = 
nic
->
İs
->
	`š™
(nic);

413 ià(
»suÉ
 !ğ
SUCCESS
) {

414 
	`LOG_ERROR
("3C509B h¬dw¬š™Ÿliz©iÚ faed: %d", 
»suÉ
);

415  
»suÉ
;

419 
	`LOG_INFO
("3C509B initialized with‡dvanced features:…romiscuous=%s, interrupt_mitigation=%s",

420 
nic
->
´omiscuous_ÿ·bË
 ? "yes" : "no",

421 (
nic
->
ÿ·b™›s
 & 
HW_CAP_PROMISCUOUS
) ? "yes" : "no");

423  
SUCCESS
;

424 
	}
}

426 
	$nic_š™_3c515
(
nic_šfo_t
 *
nic
, cÚ¡ 
nic_š™_cÚfig_t
 *
cÚfig
) {

427 ià(!
nic
 || !
cÚfig
) {

428  
ERROR_INVALID_PARAM
;

431 
	`LOG_DEBUG
("In™Ÿlizšg 3C515-TX‡ˆI/O 0x%X w™h bu ma¡” saãtye¡šg", 
cÚfig
->
io_ba£
);

434 
nic
->
İs
 = 
	`g‘_3c515_İs
();

435 ià(!
nic
->
İs
) {

436  
ERROR_NOT_FOUND
;

440 
nic
->
mtu
 = 1514;

441 
nic
->
ÿ·b™›s
 = 
	`g‘_nic_ÿ·b™›s_äom_ty³
(
NIC_TYPE_3C515_TX
);

442 
nic
->
¥“d
 = 100;

443 
nic
->
fuÎ_du¶ex
 = 
Œue
;

449 
cÚfig_t
 
g_cÚfig
;

452 
nic
->
dma_ÿ·bË
 = 
çl£
;

453 
nic
->
bus_ma¡”_ÿ·bË
 = 
çl£
;

454 
nic
->
sÿ‰”_g©h”_ÿ·bË
 = 
çl£
;

457 ià(
g_cÚfig
.
busma¡”
 !ğ
BUSMASTER_OFF
) {

458 
	`LOG_INFO
("3C515-TX: Performing bus master capabilityesting...");

461 
nic_cÚ‹xt_t
 
‹¡_ùx
;

462 
	`mem£t
(&
‹¡_ùx
, 0, (test_ctx));

463 
‹¡_ùx
.
nic_šfo
 = 
nic
;

464 
‹¡_ùx
.
io_ba£
 = 
cÚfig
->io_base;

465 
‹¡_ùx
.
œq
 = 
cÚfig
->irq;

468 
boŞ
 
quick_mode
 = (
g_cÚfig
.
busma¡”
 =ğ
BUSMASTER_AUTO
);

469 
‹¡_»suÉ
 = 
	`cÚfig_³rfÜm_busma¡”_auto_‹¡
(&
g_cÚfig
, &
‹¡_ùx
, 
quick_mode
);

471 ià(
‹¡_»suÉ
 =ğ0 && 
g_cÚfig
.
busma¡”
 =ğ
BUSMASTER_ON
) {

473 
nic
->
dma_ÿ·bË
 = 
Œue
;

474 
nic
->
bus_ma¡”_ÿ·bË
 = 
Œue
;

475 
	`LOG_INFO
("3C515-TX: Bus masteresting PASSED - DMAƒnabled");

478 
nic
->
dma_ÿ·bË
 = 
çl£
;

479 
nic
->
bus_ma¡”_ÿ·bË
 = 
çl£
;

480 
	`LOG_INFO
("3C515-TX: Using Programmed I/O mode (bus master %s)",

481 (
‹¡_»suÉ
 != 0) ? "testing failed" : "disabled");

484 
	`LOG_INFO
("3C515-TX: Bus mastering disabled by configuration - using PIO mode");

488 
nic
->
tx_fifo_th»shŞd
 = 1024;

489 
nic
->
rx_fifo_th»shŞd
 = 32;

492 
nic
->
autÚeg_ÿ·bË
 = 
Œue
;

493 
nic
->
mii_ÿ·bË
 = 
Œue
;

494 
nic
->
phy_add»ss
 = 0x18;

497 
nic
->
š‹¼u±_cßËsû_ÿ·bË
 = 
Œue
;

498 
nic
->
š‹¼u±_cßËsû_couÁ
 = 8;

499 
nic
->
š‹¼u±_cßËsû_timeout
 = 25;

502 
nic
->
z”o_cİy_ÿ·bË
 = 
Œue
;

503 
nic
->
desütÜ_ršgs_ÿ·bË
 = 
Œue
;

506 
nic
->
´omiscuous_ÿ·bË
 = 
Œue
;

507 
nic
->
muÉiÿ¡_ÿ·bË
 = 
Œue
;

508 
nic
->
´omiscuous_dma_İtimized
 = 
Œue
;

511 ià(
	`is_z”o_mac
(
nic
->
mac
)) {

512 
»suÉ
 = 
	`nic_»ad_mac_add»ss_3c515
(
cÚfig
->
io_ba£
, 
nic
->
mac
);

513 ià(
»suÉ
 !ğ
SUCCESS
) {

514 
	`LOG_ERROR
("Failedo„ead MAC‡ddress");

515  
»suÉ
;

517 
	`memÜy_cİy
(
nic
->
³rm_mac
,‚ic->
mac
, 
ETH_ALEN
);

521 ià(
nic
->
dma_ÿ·bË
) {

522 
»suÉ
 = 
	`nic_š™_3c515_dma_ršgs
(
nic
);

523 ià(
»suÉ
 !ğ
SUCCESS
) {

524 
	`LOG_WARNING
("DMA„šg in™Ÿliz©iÚ faed: %d, f®lšg backØPIO", 
»suÉ
);

525 
nic
->
dma_ÿ·bË
 = 
çl£
;

527 
	`LOG_DEBUG
("3C515-TX DMA„ings initialized successfully");

532 ià(
nic
->
mii_ÿ·bË
) {

533 
»suÉ
 = 
	`nic_š™_3c515_mii
(
nic
);

534 ià(
»suÉ
 !ğ
SUCCESS
) {

535 
	`LOG_WARNING
("MII in™Ÿliz©iÚ faed: %d, usšg fixed medŸ", 
»suÉ
);

536 
nic
->
mii_ÿ·bË
 = 
çl£
;

537 
nic
->
autÚeg_ÿ·bË
 = 
çl£
;

539 
	`LOG_DEBUG
("3C515-TX MII interface initialized");

544 ià(
nic
->
İs
->
š™
) {

545 
»suÉ
 = 
nic
->
İs
->
	`š™
(nic);

546 ià(
»suÉ
 !ğ
SUCCESS
) {

547 
	`LOG_ERROR
("3C515-TX h¬dw¬š™Ÿliz©iÚ faed: %d", 
»suÉ
);

548  
»suÉ
;

552 
	`LOG_INFO
("3C515-TX initialized with‡dvanced features: DMA=%s, MII=%s, AutoNeg=%s, ZeroCopy=%s",

553 
nic
->
dma_ÿ·bË
 ? "yes" : "no",

554 
nic
->
mii_ÿ·bË
 ? "yes" : "no",

555 
nic
->
autÚeg_ÿ·bË
 ? "yes" : "no",

556 
nic
->
z”o_cİy_ÿ·bË
 ? "yes" : "no");

558  
SUCCESS
;

559 
	}
}

563 
boŞ
 
nic_´obe_3c509b_©_add»ss
(
ušt16_t
 
io_ba£
, 
nic_d‘eù_šfo_t
 *
šfo
);

564 
boŞ
 
nic_´obe_3c515_©_add»ss
(
ušt16_t
 
io_ba£
, 
nic_d‘eù_šfo_t
 *
šfo
);

567 
	$nic_š™_cÚfig_deçuÉs
(
nic_š™_cÚfig_t
 *
cÚfig
, 
nic_ty³_t
 
ty³
) {

568 ià(!
cÚfig
) {

572 
	`memÜy_z”o
(
cÚfig
, (
nic_š™_cÚfig_t
));

574 
cÚfig
->
nic_ty³
 = 
ty³
;

575 
cÚfig
->
io_ba£
 = 0;

576 
cÚfig
->
œq
 = 0;

577 
cÚfig
->
dma_chªÃl
 = 0;

578 
cÚfig
->
æags
 = 
NIC_INIT_FLAG_AUTO_IRQ
 | 
NIC_INIT_FLAG_AUTO_IO
;

579 
cÚfig
->
auto_d‘eù
 = 
Œue
;

580 
cÚfig
->
fÜû_£‰šgs
 = 
çl£
;

581 
	}
}

584 
	$nic_š™_bufãrs
(
nic_šfo_t
 *
nic
) {

585 
»suÉ
;

586 cÚ¡ * 
nic_Çme
;

588 ià(!
nic
) {

589  
ERROR_INVALID_PARAM
;

593 
nic_Çme
 = (
nic
->
ty³
 =ğ
NIC_TYPE_3C509B
) ? "3C509B" :

594 (
nic
->
ty³
 =ğ
NIC_TYPE_3C515_TX
) ? "3C515-TX" : "Unknown";

596 
»suÉ
 = 
	`bufãr_»gi¡”_nic
(
nic
->
šdex
,‚ic->
ty³
, 
nic_Çme
);

597 ià(
»suÉ
 !ğ
SUCCESS
) {

598 
	`LOG_WARNING
("FaedØ»gi¡” NIC %d fÜ bufã¸poŞs: %d", 
nic
->
šdex
, 
»suÉ
);

603 #ifdeà
INCLUDE_FLOW_CONTROL


605 
	`æow_cÚŒŞ_š™_nic
(
nic_id_t
 
nic_id
, cÚ¡ * 
nic_Çme
);

606 
»suÉ
 = 
	`æow_cÚŒŞ_š™_nic
(
nic
->
šdex
, 
nic_Çme
);

607 ià(
»suÉ
 !ğ
SUCCESS
) {

608 
	`LOG_WARNING
("FaedØš™Ÿlizæow cÚŒŞ fÜ NIC %d: %d", 
nic
->
šdex
, 
»suÉ
);

611 
	`LOG_DEBUG
("Flow cÚŒŞ in™Ÿlized fÜ NIC %d (%s)", 
nic
->
šdex
, 
nic_Çme
);

616 
nic
->
ty³
) {

617 
NIC_TYPE_3C509B
:

619 
nic
->
tx_bufãr_size
 = 
_3C509B_BUFFER_SIZE
;

620 
nic
->
rx_bufãr_size
 = 
_3C509B_BUFFER_SIZE
;

621 
nic
->
tx_fifo_th»shŞd
 = 512;

622 
nic
->
rx_fifo_th»shŞd
 = 8;

625 
NIC_TYPE_3C515_TX
:

627 
nic
->
tx_bufãr_size
 = 
_3C515_TX_MAX_MTU
;

628 
nic
->
rx_bufãr_size
 = 
_3C515_TX_MAX_MTU
;

629 
nic
->
tx_fifo_th»shŞd
 = 512;

630 
nic
->
rx_fifo_th»shŞd
 = 8;

633 ià(
nic
->
ÿ·b™›s
 & 
HW_CAP_DMA
) {

636 
	`LOG_DEBUG
("DMA descriptor„ings initialized for 3C515-TX");

641 
	`LOG_ERROR
("UnknowÀNICy³ fÜ bufã¸š™Ÿliz©iÚ: %d", 
nic
->
ty³
);

642  
ERROR_NOT_SUPPORTED
;

645 
	`LOG_DEBUG
("Initialized buffers for NIC‡t I/O 0x%X (TX: %d bytes, RX: %d bytes)",

646 
nic
->
io_ba£
,‚ic->
tx_bufãr_size
,‚ic->
rx_bufãr_size
);

648  
SUCCESS
;

649 
	}
}

652 
	$nic_run_£lf_‹¡
(
nic_šfo_t
 *
nic
) {

653 ià(!
nic
 || !nic->
İs
) {

654  
ERROR_INVALID_PARAM
;

657 
g_nic_š™_¡©s
.
£lf_‹¡s_run
++;

660 ià(
nic
->
İs
->
£lf_‹¡
) {

661 
»suÉ
 = 
nic
->
İs
->
	`£lf_‹¡
(nic);

662 ià(
»suÉ
 =ğ
SUCCESS
) {

663 
g_nic_š™_¡©s
.
£lf_‹¡s_·s£d
++;

665  
»suÉ
;

669 ià(
	`nic_is_lšk_up
(
nic
)) {

670 
g_nic_š™_¡©s
.
£lf_‹¡s_·s£d
++;

671  
SUCCESS
;

674  
ERROR_HARDWARE
;

675 
	}
}

678 cÚ¡ * 
	$nic_medŸ_ty³_to_¡ršg
(
nic_medŸ_ty³_t
 
medŸ
) {

679 
medŸ
) {

680 
NIC_MEDIA_AUTO
:  "Auto";

681 
NIC_MEDIA_10BASE_T
:  "10BASE-T";

682 
NIC_MEDIA_10BASE_2
:  "10BASE-2";

683 
NIC_MEDIA_AUI
:  "AUI";

684 
NIC_MEDIA_100BASE_TX
:  "100BASE-TX";

685 
NIC_MEDIA_100BASE_FX
:  "100BASE-FX";

688 
	}
}

690 cÚ¡ * 
	$nic_š™_”rÜ_to_¡ršg
(
”rÜ_code
) {

691 
”rÜ_code
) {

692 
SUCCESS
:  "Success";

693 
ERROR_INVALID_PARAM
:  "Invalid…arameter";

694 
ERROR_NO_MEMORY
:  "Out of memory";

695 
ERROR_NOT_FOUND
:  "Not found";

696 
ERROR_HARDWARE
:  "Hardwareƒrror";

697 
ERROR_TIMEOUT
:  "Timeout";

698 
ERROR_NOT_SUPPORTED
:  "Not supported";

701 
	}
}

704 
	$nic_š™_¡©s_ş—r
() {

705 
	`memÜy_z”o
(&
g_nic_š™_¡©s
, (
nic_š™_¡©s_t
));

706 
	}
}

708 cÚ¡ 
nic_š™_¡©s_t
* 
	$nic_š™_g‘_¡©s
() {

709  &
g_nic_š™_¡©s
;

710 
	}
}

713 
	$nic_»£t_h¬dw¬e
(
nic_šfo_t
 *
nic
) {

714 ià(!
nic
) {

715  
ERROR_INVALID_PARAM
;

718 
g_nic_š™_¡©s
.
»£ts_³rfÜmed
++;

721 ià(
nic
->
İs
 &&‚ic->İs->
»£t
) {

722  
nic
->
İs
->
	`»£t
(nic);

726 
nic
->
ty³
) {

727 
NIC_TYPE_3C509B
:

729 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_TOTAL_RESET
);

730 
	`nic_d–ay_mli£cÚds
(10);

733 
i
 = 0; i < 100; i++) {

734 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C509B_STATUS_REG
);

735 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

738 
	`nic_d–ay_mli£cÚds
(1);

742 
NIC_TYPE_3C515_TX
:

744 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_TOTAL_RESET
);

745 
	`nic_d–ay_mli£cÚds
(10);

748 
i
 = 0; i < 100; i++) {

749 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

750 ià(!(
¡©us
 & 
_3C515_TX_STATUS_CMD_IN_PROGRESS
)) {

753 
	`nic_d–ay_mli£cÚds
(1);

758 
	`LOG_WARNING
("UnknowÀNICy³ fÜ„e£t: %d", 
nic
->
ty³
);

762 
	`nic_d–ay_mli£cÚds
(100);

764  
SUCCESS
;

765 
	}
}

767 
	$nic_wa™_fÜ_»ady
(
nic_šfo_t
 *
nic
, 
ušt32_t
 
timeout_ms
) {

768 ià(!
nic
) {

769  
ERROR_INVALID_PARAM
;

773 
ušt32_t
 
¡¬t_time
 = 
	`nic_g‘_sy¡em_tick_couÁ
();

775 (
	`nic_g‘_sy¡em_tick_couÁ
(è- 
¡¬t_time
è< 
timeout_ms
) {

776 ià(
nic
->
İs
 &&‚ic->İs->
g‘_lšk_¡©us
) {

778 ià(
nic
->
İs
->
	`g‘_lšk_¡©us
Òicè!ğ
ERROR_HARDWARE
) {

779  
SUCCESS
;

783 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + (Òic->
ty³
 =ğ
NIC_TYPE_3C509B
) ?

784 
_3C509B_STATUS_REG
 : 
_3C515_TX_STATUS_REG
));

785 ià(
¡©us
 != 0xFFFF && !(status & 0x1000)) {

786  
SUCCESS
;

789 
	`nic_d–ay_mli£cÚds
(10);

792  
ERROR_TIMEOUT
;

793 
	}
}

795 
	$nic_š™_upd©e_¡©s
(
boŞ
 
sucûss
, boŞ 
d‘eùiÚ
) {

796 ià(
d‘eùiÚ
) {

797 ià(
sucûss
) {

798 
g_nic_š™_¡©s
.
sucûssful_d‘eùiÚs
++;

801 ià(
sucûss
) {

802 
g_nic_š™_¡©s
.
sucûssful_š™Ÿliz©iÚs
++;

804 
g_nic_š™_¡©s
.
çed_š™Ÿliz©iÚs
++;

807 
	}
}

810 
boŞ
 
	$is_z”o_mac
(cÚ¡ 
ušt8_t
 *
mac
) {

811 ià(!
mac
è 
Œue
;

812 
i
 = 0; i < 
ETH_ALEN
; i++) {

813 ià(
mac
[
i
] !ğ0è 
çl£
;

815  
Œue
;

816 
	}
}

819 
	$ud–ay
(
ušt32_t
 
miüo£cÚds
) {

821 vŞ©
ušt32_t
 
i
;

822 
i
 = 0; i < 
miüo£cÚds
 * 10; i++) {

825 
	}
}

827 
	$md–ay
(
ušt32_t
 
mli£cÚds
) {

828 
ušt32_t
 
i
 = 0; i < 
mli£cÚds
; i++) {

829 
	`ud–ay
(1000);

831 
	}
}

834 
	$nic_d–ay_miüo£cÚds
(
ušt32_t
 
miüo£cÚds
) {

835 
	`ud–ay
(
miüo£cÚds
);

836 
	}
}

838 
	$nic_d–ay_mli£cÚds
(
ušt32_t
 
mli£cÚds
) {

839 
	`md–ay
(
mli£cÚds
);

840 
	}
}

842 
ušt32_t
 
	$nic_g‘_sy¡em_tick_couÁ
() {

844 
ušt32_t
 
tick_couÁ”
 = 0;

845  ++
tick_couÁ”
;

846 
	}
}

850 
boŞ
 
	$nic_´obe_3c509b_©_add»ss
(
ušt16_t
 
io_ba£
, 
nic_d‘eù_šfo_t
 *
šfo
) {

851 ià(!
šfo
) {

852  
çl£
;

856 
	`mem£t
(
šfo
, 0, (
nic_d‘eù_šfo_t
));

857 
šfo
->
io_ba£
 = io_base;

858 
šfo
->
ty³
 = 
NIC_TYPE_3C509B
;

864 
	`outb
(
_3C509B_ID_PORT
, 
_3C509B_ID_GLOBAL_RESET
);

865 
	`nic_d–ay_mli£cÚds
(10);

870 
ušt16_t
 
aùiv©e_cmd
 = 
_3C509B_ACTIVATE_AND_SET_IO
 | ((
io_ba£
 >> 4) & 0x1F);

871 
	`outb
(
_3C509B_ID_PORT
, 
aùiv©e_cmd
);

872 
	`nic_d–ay_mli£cÚds
(10);

875 
ušt16_t
 
‹¡_»ad
 = 
	`šw
(
io_ba£
 + 
_3C509B_STATUS_REG
);

878 ià(
‹¡_»ad
 == 0xFFFF) {

879  
çl£
;

883 
ušt16_t
 
¡©us
 = 
	`šw
(
io_ba£
 + 
_3C509B_STATUS_REG
);

886 
	`_3C509B_SELECT_WINDOW
(
io_ba£
, 
_3C509B_WINDOW_0
);

887 
	`nic_d–ay_miüo£cÚds
(100);

890 
	`outw
(
io_ba£
 + 
_3C509B_EEPROM_CMD
, 
_3C509B_EEPROM_READ
 | 3);

891 
	`nic_d–ay_miüo£cÚds
(
_3C509B_EEPROM_READ_DELAY
);

892 
ušt16_t
 
´oduù_id
 = 
	`šw
(
io_ba£
 + 
_3C509B_EEPROM_DATA
);

895 ià((
´oduù_id
 & 
_3C509B_PRODUCT_ID_MASK
è!ğ
_3C509B_PRODUCT_ID
) {

896 
	`LOG_DEBUG
("NØ3C509B‡ˆI/O 0x%X (´oduù ID: 0x%X)", 
io_ba£
, 
´oduù_id
);

897  
çl£
;

901 
i
 = 0; i < 3; i++) {

902 
	`outw
(
io_ba£
 + 
_3C509B_EEPROM_CMD
, 
_3C509B_EEPROM_READ
 | 
i
);

903 
	`nic_d–ay_miüo£cÚds
(
_3C509B_EEPROM_READ_DELAY
);

904 
ušt16_t
 
mac_wÜd
 = 
	`šw
(
io_ba£
 + 
_3C509B_EEPROM_DATA
);

905 
šfo
->
mac
[
i
 * 2] = (
mac_wÜd
 >> 8) & 0xFF;

906 
šfo
->
mac
[
i
 * 2 + 1] = 
mac_wÜd
 & 0xFF;

910 
	`outw
(
io_ba£
 + 
_3C509B_EEPROM_CMD
, 
_3C509B_EEPROM_READ
 | 6);

911 
	`nic_d–ay_miüo£cÚds
(
_3C509B_EEPROM_READ_DELAY
);

912 
ušt16_t
 
œq_wÜd
 = 
	`šw
(
io_ba£
 + 
_3C509B_EEPROM_DATA
);

916 
ušt8_t
 
œq_’codšg
 = (
œq_wÜd
 >> 12) & 0x0F;

917 cÚ¡ 
ušt8_t
 
œq_m­
[] = {3, 5, 7, 9, 10, 11, 12, 15};

918 ià(
œq_’codšg
 < 8) {

919 
šfo
->
œq
 = 
œq_m­
[
œq_’codšg
];

921 
šfo
->
œq
 = 0;

925 
šfo
->
v’dÜ_id
 = 0x10B7;

926 
šfo
->
deviû_id
 = 
´oduù_id
;

927 
šfo
->
»visiÚ
 = 
´oduù_id
 & 0x0F;

928 
šfo
->
ÿ·b™›s
 = 
	`g‘_nic_ÿ·b™›s_äom_ty³
(
NIC_TYPE_3C509B
);

929 
šfo
->
²p_ÿ·bË
 = 
çl£
;

930 
šfo
->
d‘eùed
 = 
Œue
;

932 
	`LOG_DEBUG
("3C509B detected‡t I/O 0x%X, MAC %02X:%02X:%02X:%02X:%02X:%02X, IRQ %d",

933 
io_ba£
, 
šfo
->
mac
[0], info->mac[1], info->mac[2],

934 
šfo
->
mac
[3], info->mac[4], info->mac[5], info->
œq
);

936  
Œue
;

937 
	}
}

939 
boŞ
 
	$nic_´obe_3c515_©_add»ss
(
ušt16_t
 
io_ba£
, 
nic_d‘eù_šfo_t
 *
šfo
) {

940 ià(!
šfo
) {

941  
çl£
;

945 
	`mem£t
(
šfo
, 0, (
nic_d‘eù_šfo_t
));

946 
šfo
->
io_ba£
 = io_base;

947 
šfo
->
ty³
 = 
NIC_TYPE_3C515_TX
;

950 
ušt16_t
 
‹¡_»ad
 = 
	`šw
(
io_ba£
 + 
_3C515_TX_STATUS_REG
);

951 ià(
‹¡_»ad
 == 0xFFFF) {

952  
çl£
;

956 
	`_3C515_TX_SELECT_WINDOW
(
io_ba£
, 
_3C515_TX_WINDOW_0
);

957 
	`nic_d–ay_miüo£cÚds
(100);

960 
	`outw
(
io_ba£
 + 
_3C515_TX_W0_EEPROM_CMD
, 
_3C515_TX_EEPROM_READ
 | 3);

961 
	`nic_d–ay_miüo£cÚds
(
_3C515_TX_EEPROM_READ_DELAY
);

962 
ušt16_t
 
´oduù_id
 = 
	`šw
(
io_ba£
 + 
_3C515_TX_W0_EEPROM_DATA
);

965 ià((
´oduù_id
 & 
_3C515_TX_PRODUCT_ID_MASK
è!ğ
_3C515_TX_PRODUCT_ID
) {

966 
	`LOG_DEBUG
("NØ3C515-TX‡ˆI/O 0x%X (´oduù ID: 0x%X)", 
io_ba£
, 
´oduù_id
);

967  
çl£
;

971 
i
 = 0; i < 3; i++) {

972 
	`outw
(
io_ba£
 + 
_3C515_TX_W0_EEPROM_CMD
, 
_3C515_TX_EEPROM_READ
 | 
i
);

973 
	`nic_d–ay_miüo£cÚds
(
_3C515_TX_EEPROM_READ_DELAY
);

974 
ušt16_t
 
mac_wÜd
 = 
	`šw
(
io_ba£
 + 
_3C515_TX_W0_EEPROM_DATA
);

975 
šfo
->
mac
[
i
 * 2] = (
mac_wÜd
 >> 8) & 0xFF;

976 
šfo
->
mac
[
i
 * 2 + 1] = 
mac_wÜd
 & 0xFF;

981 
	`_3C515_TX_SELECT_WINDOW
(
io_ba£
, 
_3C515_TX_WINDOW_3
);

982 
	`nic_d–ay_miüo£cÚds
(100);

987 
šfo
->
œq
 = 0;

990 
šfo
->
v’dÜ_id
 = 0x10B7;

991 
šfo
->
deviû_id
 = 
´oduù_id
;

992 
šfo
->
»visiÚ
 = 
´oduù_id
 & 0x0F;

993 
šfo
->
ÿ·b™›s
 = 
	`g‘_nic_ÿ·b™›s_äom_ty³
(
NIC_TYPE_3C515_TX
);

994 
šfo
->
²p_ÿ·bË
 = 
çl£
;

995 
šfo
->
d‘eùed
 = 
Œue
;

997 
	`LOG_DEBUG
("3C515-TX detected‡t I/O 0x%X, MAC %02X:%02X:%02X:%02X:%02X:%02X",

998 
io_ba£
, 
šfo
->
mac
[0], info->mac[1], info->mac[2],

999 
šfo
->
mac
[3], info->mac[4], info->mac[5]);

1001  
Œue
;

1002 
	}
}

1004 
	$nic_»ad_mac_add»ss_3c509b
(
ušt16_t
 
io_ba£
, 
ušt8_t
 *
mac
) {

1005 ià(!
mac
) {

1006  
ERROR_INVALID_PARAM
;

1010 
	`_3C509B_SELECT_WINDOW
(
io_ba£
, 
_3C509B_WINDOW_0
);

1011 
	`nic_d–ay_miüo£cÚds
(100);

1014 
i
 = 0; i < 3; i++) {

1015 
	`outw
(
io_ba£
 + 
_3C509B_EEPROM_CMD
, 
_3C509B_EEPROM_READ
 | 
i
);

1016 
	`nic_d–ay_miüo£cÚds
(
_3C509B_EEPROM_READ_DELAY
);

1017 
ušt16_t
 
mac_wÜd
 = 
	`šw
(
io_ba£
 + 
_3C509B_EEPROM_DATA
);

1018 
mac
[
i
 * 2] = (
mac_wÜd
 >> 8) & 0xFF;

1019 
mac
[
i
 * 2 + 1] = 
mac_wÜd
 & 0xFF;

1022  
SUCCESS
;

1023 
	}
}

1025 
	$nic_»ad_mac_add»ss_3c515
(
ušt16_t
 
io_ba£
, 
ušt8_t
 *
mac
) {

1026 ià(!
mac
) {

1027  
ERROR_INVALID_PARAM
;

1031 
	`_3C515_TX_SELECT_WINDOW
(
io_ba£
, 
_3C515_TX_WINDOW_0
);

1032 
	`nic_d–ay_miüo£cÚds
(100);

1035 
i
 = 0; i < 3; i++) {

1036 
	`outw
(
io_ba£
 + 
_3C515_TX_W0_EEPROM_CMD
, 
_3C515_TX_EEPROM_READ
 | 
i
);

1037 
	`nic_d–ay_miüo£cÚds
(
_3C515_TX_EEPROM_READ_DELAY
);

1038 
ušt16_t
 
mac_wÜd
 = 
	`šw
(
io_ba£
 + 
_3C515_TX_W0_EEPROM_DATA
);

1039 
mac
[
i
 * 2] = (
mac_wÜd
 >> 8) & 0xFF;

1040 
mac
[
i
 * 2 + 1] = 
mac_wÜd
 & 0xFF;

1043  
SUCCESS
;

1044 
	}
}

1047 
	$nic_ş—nup_sšgË
(
nic_šfo_t
 *
nic
è{  
SUCCESS
; 
	}
}

1048 
	$nic_»£t_sšgË
(
nic_šfo_t
 *
nic
è{  
	`nic_»£t_h¬dw¬e
Òic); 
	}
}

1050 
boŞ
 
	$nic_is_´e£Á_©_add»ss
(
nic_ty³_t
 
ty³
, 
ušt16_t
 
io_ba£
) {

1051 
nic_d‘eù_šfo_t
 
šfo
;

1052 ià(
ty³
 =ğ
NIC_TYPE_3C509B
) {

1053  
	`nic_´obe_3c509b_©_add»ss
(
io_ba£
, &
šfo
);

1054 } ià(
ty³
 =ğ
NIC_TYPE_3C515_TX
) {

1055  
	`nic_´obe_3c515_©_add»ss
(
io_ba£
, &
šfo
);

1057  
çl£
;

1058 
	}
}

1060 
	$nic_d‘eù_²p_3c509b
(
nic_d‘eù_šfo_t
 *
šfo_li¡
, 
max_couÁ
) {

1061 ià(!
šfo_li¡
 || 
max_couÁ
 <= 0) {

1062  
ERROR_INVALID_PARAM
;

1066 
	`²p_d‘eù_nics
(
nic_d‘eù_šfo_t
 *
šfo_li¡
, 
max_nics
);

1067 
	`²p_f‹r_by_ty³
(
nic_d‘eù_šfo_t
 *
šfo_li¡
, 
couÁ
, 
nic_ty³_t
 
ty³
);

1070 
tÙ®_d‘eùed
 = 
	`²p_d‘eù_nics
(
šfo_li¡
, 
max_couÁ
);

1071 ià(
tÙ®_d‘eùed
 <= 0) {

1072 
	`LOG_DEBUG
("No PnP devices detected for 3C509B");

1077 
f‹»d_couÁ
 = 
	`²p_f‹r_by_ty³
(
šfo_li¡
, 
tÙ®_d‘eùed
, 
NIC_TYPE_3C509B
);

1079 
	`LOG_DEBUG
("PnP 3C509B d‘eùiÚ: %dÙ®, %d 3C509B deviûs", 
tÙ®_d‘eùed
, 
f‹»d_couÁ
);

1081  
f‹»d_couÁ
;

1082 
	}
}

1084 
	$nic_d‘eù_ei§_3c509b
(
nic_d‘eù_šfo_t
 *
šfo_li¡
, 
max_couÁ
) {

1087 
	}
}

1089 
boŞ
 
	$nic_is_²p_ÿ·bË
(
ušt16_t
 
io_ba£
) {

1091  
çl£
;

1092 
	}
}

1094 
boŞ
 
	$nic_is_lšk_up
(
nic_šfo_t
 *
nic
) {

1095  
nic
 ?‚ic->
lšk_up
 : 
çl£
;

1096 
	}
}

1098 
	$nic_ş—nup_bufãrs
(
nic_šfo_t
 *
nic
) {

1099  
SUCCESS
;

1100 
	}
}

1102 
	$nic_š™_´št_¡©s
() {

1103 
	`LOG_INFO
("NIC Init Stats: Detections=%d/%d, Initializations=%d/%d, Self-tests=%d/%d",

1104 
g_nic_š™_¡©s
.
sucûssful_d‘eùiÚs
, g_nic_š™_¡©s.
tÙ®_d‘eùiÚs
,

1105 
g_nic_š™_¡©s
.
sucûssful_š™Ÿliz©iÚs
, g_nic_š™_¡©s.
tÙ®_š™Ÿliz©iÚs
,

1106 
g_nic_š™_¡©s
.
£lf_‹¡s_·s£d
, g_nic_š™_¡©s.
£lf_‹¡s_run
);

1107 
	}
}

1109 
	$nic_´št_d‘eùiÚ_šfo
(cÚ¡ 
nic_d‘eù_šfo_t
 *
šfo
) {

1110 ià(!
šfo
) ;

1111 
	`LOG_INFO
("NIC: Type=%s, I/O=0x%X, IRQ=%d, MAC=%02X:%02X:%02X:%02X:%02X:%02X",

1112 (
šfo
->
ty³
 =ğ
NIC_TYPE_3C509B
) ? "3C509B" :

1113 (
šfo
->
ty³
 =ğ
NIC_TYPE_3C515_TX
) ? "3C515-TX" : "Unknown",

1114 
šfo
->
io_ba£
, info->
œq
, info->
mac
[0], info->mac[1], info->mac[2],

1115 
šfo
->
mac
[3], info->mac[4], info->mac[5]);

1116 
	}
}

1118 
	$nic_´št_š™Ÿliz©iÚ_¡©us
(cÚ¡ 
nic_šfo_t
 *
nic
) {

1119 ià(!
nic
) ;

1120 
	`LOG_INFO
("NIC Status: Type=%d, I/O=0x%X, Status=0x%X, Link=%s",

1121 
nic
->
ty³
,‚ic->
io_ba£
,‚ic->
¡©us
,‚ic->
lšk_up
 ? "Up" : "Down");

1122 
	}
}

1124 
	$nic_´št_ÿ·b™›s
(cÚ¡ 
nic_šfo_t
 *
nic
) {

1125 ià(!
nic
) ;

1126 
	`LOG_INFO
("NIC Capabilities: DMA=%s, BusMaster=%s, Multicast=%s, FullDuplex=%s",

1127 (
nic
->
ÿ·b™›s
 & 
HW_CAP_DMA
) ? "Yes" : "No",

1128 (
nic
->
ÿ·b™›s
 & 
HW_CAP_BUS_MASTER
) ? "Yes" : "No",

1129 (
nic
->
ÿ·b™›s
 & 
HW_CAP_MULTICAST
) ? "Yes" : "No",

1130 (
nic
->
ÿ·b™›s
 & 
HW_CAP_FULL_DUPLEX
) ? "Yes" : "No");

1131 
	}
}

1138 
ušt32_t
 
	$g‘_nic_ÿ·b™›s_äom_ty³
(
nic_ty³_t
 
ty³
) {

1140 
ty³
) {

1141 
NIC_TYPE_3C509B
:

1143  
HW_CAP_MULTICAST
 | 
HW_CAP_PROMISCUOUS
;

1145 
NIC_TYPE_3C515_TX
:

1147  
HW_CAP_DMA
 | 
HW_CAP_BUS_MASTER
 | 
HW_CAP_MULTICAST
 |

1148 
HW_CAP_PROMISCUOUS
 | 
HW_CAP_FULL_DUPLEX
 | 
HW_CAP_AUTO_SPEED
;

1151 
	`LOG_WARNING
("UnknowÀNICy³ %d, usšg mšim® c­ab™›s", 
ty³
);

1152  
HW_CAP_MULTICAST
 | 
HW_CAP_PROMISCUOUS
;

1154 
	}
}

1165 
	$nic_š™_ÿche_coh”’cy_sy¡em
() {

1166 ià(
g_ÿche_coh”’cy_š™Ÿlized
) {

1167 
	`LOG_DEBUG
("Cache coherency system‡lready initialized");

1168  
SUCCESS
;

1171 
	`LOG_INFO
("Initializing system-wide cache coherency management...");

1174 
g_sy¡em_coh”’cy_ª®ysis
 = 
	`³rfÜm_com¶‘e_coh”’cy_ª®ysis
();

1177 
g_sy¡em_ch£t_d‘eùiÚ
 = 
	`d‘eù_sy¡em_ch£t
();

1180 
boŞ
 
ÿche_š™_»suÉ
 = 
	`š™Ÿlize_ÿche_mªagem’t
(
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
);

1181 ià(!
ÿche_š™_»suÉ
) {

1182 
	`LOG_ERROR
("Failedo initialize global cache management system");

1183  
ERROR_HARDWARE
;

1187 
ch£t_d©aba£_cÚfig_t
 
db_cÚfig
 = {

1188 .
’abË_expÜt
 = 
Œue
,

1189 .
expÜt_csv
 = 
Œue
,

1190 .
expÜt_jsÚ
 = 
Œue
,

1191 .
csv_f’ame
 = "chipset_test_results.csv",

1192 .
jsÚ_f’ame
 = "chipset_test_results.json"

1195 
boŞ
 
db_š™_»suÉ
 = 
	`š™Ÿlize_ch£t_d©aba£
(&
db_cÚfig
);

1196 ià(!
db_š™_»suÉ
) {

1197 
	`LOG_WARNING
("Failedo initialize chipset database - continuing withoutƒxport");

1201 
boŞ
 
»cÜd_»suÉ
 = 
	`»cÜd_ch£t_‹¡_»suÉ
(&
g_sy¡em_coh”’cy_ª®ysis
, &
g_sy¡em_ch£t_d‘eùiÚ
);

1202 ià(!
»cÜd_»suÉ
) {

1203 
	`LOG_WARNING
("Failedo„ecord initialest„esults in chipset database");

1207 
boŞ
 
³rf_š™_»suÉ
 = 
	`š™Ÿlize_³rfÜmªû_’abËr
(&
g_sy¡em_coh”’cy_ª®ysis
);

1208 ià(!
³rf_š™_»suÉ
) {

1209 
	`LOG_WARNING
("Failedo initialize…erformanceƒnabler - continuing without optimization guidance");

1212 
g_ÿche_coh”’cy_š™Ÿlized
 = 
Œue
;

1214 
	`LOG_INFO
("Cache coherency system initialized:ier %d, confidence %d%%",

1215 
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
, g_sy¡em_coh”’cy_ª®ysis.
cÚfid’û
);

1217  
SUCCESS
;

1218 
	}
}

1225 
	$nic_š™_­¶y_coh”’cy_to_nic
(
nic_šfo_t
 *
nic
) {

1226 ià(!
nic
) {

1227 
	`LOG_ERROR
("Invalid NIC…ointer for cache coherency‡pplication");

1228  
ERROR_INVALID_PARAM
;

1231 ià(!
g_ÿche_coh”’cy_š™Ÿlized
) {

1232 
	`LOG_ERROR
("Cache coherency system‚ot initialized");

1233  
ERROR_NOT_INITIALIZED
;

1236 
	`LOG_DEBUG
("Aµlyšg cachcoh”’cy cÚfigu¿tiÚØNICy³ %d", 
nic
->
ty³
);

1239 
nic
->
ÿche_coh”’cy_t›r
 = 
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
;

1240 
nic
->
ÿche_mªagem’t_avaabË
 = 
Œue
;

1243 
nic
->
ty³
) {

1244 
NIC_TYPE_3C509B
:

1246 ià(
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
 =ğ
TIER_DISABLE_BUS_MASTER
) {

1247 
	`LOG_INFO
("3C509B: PIO-only operation optimal forhis system");

1248 
nic
->
¡©us
 |ğ
NIC_STATUS_CACHE_COHERENCY_OK
;

1250 
	`LOG_INFO
("3C509B: PIO operations with cache managementƒnabled");

1251 
nic
->
¡©us
 |ğ
NIC_STATUS_CACHE_COHERENCY_OK
;

1255 
NIC_TYPE_3C515_TX
:

1257 ià(
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
 =ğ
TIER_DISABLE_BUS_MASTER
) {

1258 
	`LOG_ERROR
("3C515-TX„equires DMA operation - system incompatible");

1259  
ERROR_HARDWARE
;

1261 
	`LOG_INFO
("3C515-TX: DMA operations withier %d cache management",

1262 
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
);

1263 
nic
->
¡©us
 |ğ
NIC_STATUS_CACHE_COHERENCY_OK
;

1268 
	`LOG_WARNING
("UnknowÀNICy³ %d fÜ cachcoh”’cy‡µliÿtiÚ", 
nic
->
ty³
);

1269 
nic
->
ÿche_mªagem’t_avaabË
 = 
çl£
;

1273 
	`LOG_DEBUG
("Cache coherency‡ppliedo NIC:ier %d,‡vailable %s",

1274 
nic
->
ÿche_coh”’cy_t›r
,‚ic->
ÿche_mªagem’t_avaabË
 ? "Yes" : "No");

1276  
SUCCESS
;

1277 
	}
}

1282 
	$nic_š™_di¥Ïy_sy¡em_ª®ysis
() {

1283 ià(!
g_ÿche_coh”’cy_š™Ÿlized
) {

1287 
	`LOG_INFO
("=== SYSTEM CACHE COHERENCY ANALYSIS ===");

1288 
	`LOG_INFO
("CPU: %s, Model: %d, Speed: %d MHz",

1289 
	`g‘_ıu_v’dÜ_¡ršg
(
g_sy¡em_coh”’cy_ª®ysis
.
ıu
.
v’dÜ
),

1290 
g_sy¡em_coh”’cy_ª®ysis
.
ıu
.
mod–
,

1291 
g_sy¡em_coh”’cy_ª®ysis
.
ıu
.
¥“d_mhz
);

1292 
	`LOG_INFO
("Cache: %s, Size: %d KB, Line Size: %d bytes",

1293 
g_sy¡em_coh”’cy_ª®ysis
.
wr™e_back_ÿche
 ? "Write-back" : "Write-through",

1294 
g_sy¡em_coh”’cy_ª®ysis
.
ıu
.
ÿche_size
,

1295 
g_sy¡em_coh”’cy_ª®ysis
.
ıu
.
ÿche_lše_size
);

1296 
	`LOG_INFO
("Ch£t: %s", 
g_sy¡em_ch£t_d‘eùiÚ
.
ch£t
.
Çme
);

1297 
	`LOG_INFO
("Detection Method: %s",

1298 
	`g‘_ch£t_d‘eùiÚ_m‘hod_desütiÚ
(
g_sy¡em_ch£t_d‘eùiÚ
.
d‘eùiÚ_m‘hod
));

1299 
	`LOG_INFO
("Test Results: Bus Master=%s, Coherency=%s, Snooping=%s",

1300 
	`g‘_bus_ma¡”_»suÉ_desütiÚ
(
g_sy¡em_coh”’cy_ª®ysis
.
bus_ma¡”
),

1301 
	`g‘_coh”’cy_»suÉ_desütiÚ
(
g_sy¡em_coh”’cy_ª®ysis
.
coh”’cy
),

1302 
	`g‘_¢oİšg_»suÉ_desütiÚ
(
g_sy¡em_coh”’cy_ª®ysis
.
¢oİšg
));

1303 
	`LOG_INFO
("Selected Tier: %d (%s)",

1304 
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
,

1305 
	`g‘_ÿche_t›r_desütiÚ
(
g_sy¡em_coh”’cy_ª®ysis
.
£Ëùed_t›r
));

1306 
	`LOG_INFO
("CÚfid’û Lev–: %d%%", 
g_sy¡em_coh”’cy_ª®ysis
.
cÚfid’û
);

1307 
	`LOG_INFO
("=====================================");

1310 ià(
	`should_ofãr_³rfÜmªû_guidªû
(&
g_sy¡em_coh”’cy_ª®ysis
)) {

1311 
	`di¥Ïy_³rfÜmªû_İpÜtun™y_ª®ysis
();

1315 
ch£t_‹¡_»cÜd_t
 
»cÜd
 = {

1316 .
submissiÚ_id
 = 
	`g’”©e_submissiÚ_id
(),

1317 .
ch£t_v’dÜ_id
 = 
g_sy¡em_ch£t_d‘eùiÚ
.
ch£t
.
v’dÜ_id
,

1318 .
ch£t_deviû_id
 = 
g_sy¡em_ch£t_d‘eùiÚ
.
ch£t
.
deviû_id
,

1319 .
£Ëùed_t›r
 = 
g_sy¡em_coh”’cy_ª®ysis
.selected_tier,

1320 .
‹¡_cÚfid’û
 = 
g_sy¡em_coh”’cy_ª®ysis
.
cÚfid’û


1322 
	`¡ºıy
(
»cÜd
.
ch£t_Çme
, 
g_sy¡em_ch£t_d‘eùiÚ
.
ch£t
.
Çme
, (record.chipset_name) - 1);

1324 
	`di¥Ïy_commun™y_cÚŒibutiÚ_mes§ge
(&
»cÜd
);

1325 
	}
}

1335 cÚ¡ 
coh”’cy_ª®ysis_t
* 
	$nic_š™_g‘_sy¡em_coh”’cy_ª®ysis
() {

1336 ià(!
g_ÿche_coh”’cy_š™Ÿlized
) {

1337  
NULL
;

1339  &
g_sy¡em_coh”’cy_ª®ysis
;

1340 
	}
}

1346 cÚ¡ 
ch£t_d‘eùiÚ_»suÉ_t
* 
	$nic_š™_g‘_sy¡em_ch£t_d‘eùiÚ
() {

1347 ià(!
g_ÿche_coh”’cy_š™Ÿlized
) {

1348  
NULL
;

1350  &
g_sy¡em_ch£t_d‘eùiÚ
;

1351 
	}
}

1357 
boŞ
 
	$nic_š™_is_ÿche_coh”’cy_avaabË
() {

1358  
g_ÿche_coh”’cy_š™Ÿlized
;

1359 
	}
}

1370 
	$nic_š™_3c515_dma_ršgs
(
nic_šfo_t
 *
nic
) {

1371 ià(!
nic
 ||‚ic->
ty³
 !ğ
NIC_TYPE_3C515_TX
) {

1372  
ERROR_INVALID_PARAM
;

1375 
	`LOG_DEBUG
("Initializing 3C515-TX DMA descriptor„ings");

1378 
nic
->
tx_desütÜ_ršg
 = 
	`memÜy_®loc_®igÃd
(16 * (
ušt32_t
) * 4, 16);

1379 ià(!
nic
->
tx_desütÜ_ršg
) {

1380 
	`LOG_ERROR
("Failedo‡llocate TX descriptor„ing");

1381  
ERROR_NO_MEMORY
;

1385 
nic
->
rx_desütÜ_ršg
 = 
	`memÜy_®loc_®igÃd
(16 * (
ušt32_t
) * 4, 16);

1386 ià(!
nic
->
rx_desütÜ_ršg
) {

1387 
	`LOG_ERROR
("Failedo‡llocate RX descriptor„ing");

1388 
	`memÜy_ä“
(
nic
->
tx_desütÜ_ršg
);

1389 
nic
->
tx_desütÜ_ršg
 = 
NULL
;

1390  
ERROR_NO_MEMORY
;

1394 
	`memÜy_z”o
(
nic
->
tx_desütÜ_ršg
, 16 * (
ušt32_t
) * 4);

1395 
	`memÜy_z”o
(
nic
->
rx_desütÜ_ršg
, 16 * (
ušt32_t
) * 4);

1398 
nic
->
tx_ršg_h—d
 = 0;

1399 
nic
->
tx_ršg_
 = 0;

1400 
nic
->
rx_ršg_h—d
 = 0;

1401 
nic
->
rx_ršg_
 = 0;

1405 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_7
);

1408 
ušt32_t
 
tx_ršg_phys
 = 
	`dma_vœt_to_phys
(
nic
->
tx_desütÜ_ršg
);

1409 
	`outw
(
nic
->
io_ba£
 + 0x00, 
tx_ršg_phys
 & 0xFFFF);

1410 
	`outw
(
nic
->
io_ba£
 + 0x02, (
tx_ršg_phys
 >> 16) & 0xFFFF);

1413 
ušt32_t
 
rx_ršg_phys
 = 
	`dma_vœt_to_phys
(
nic
->
rx_desütÜ_ršg
);

1414 
	`outw
(
nic
->
io_ba£
 + 0x04, 
rx_ršg_phys
 & 0xFFFF);

1415 
	`outw
(
nic
->
io_ba£
 + 0x06, (
rx_ršg_phys
 >> 16) & 0xFFFF);

1418 
	`outw
(
nic
->
io_ba£
 + 0x08, 0);

1419 
	`outw
(
nic
->
io_ba£
 + 0x0A, 0);

1421 
	`LOG_DEBUG
("DMA„šg š™Ÿlized: TX=0x%08lX, RX=0x%08lX", 
tx_ršg_phys
, 
rx_ršg_phys
);

1423  
SUCCESS
;

1424 
	}
}

1431 
	$nic_š™_3c515_mii
(
nic_šfo_t
 *
nic
) {

1432 ià(!
nic
 ||‚ic->
ty³
 !ğ
NIC_TYPE_3C515_TX
) {

1433  
ERROR_INVALID_PARAM
;

1436 
	`LOG_DEBUG
("Initializing 3C515-TX MII interface");

1439 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_4
);

1442 
ušt16_t
 
phy_id1
 = 0, 
phy_id2
 = 0;

1448 
phy_id1
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_W4_PHY_ID_HIGH
);

1449 
phy_id2
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_W4_PHY_ID_LOW
);

1451 ià(
phy_id1
 =ğ0xFFFF || (phy_id1 =ğ0 && 
phy_id2
 == 0)) {

1452 
	`LOG_WARNING
("MII PHY‚ot detected or‚ot„esponding\");

1453  
ERROR_HARDWARE
;

1457 
nic
->
phy_id
 = (
phy_id1
 << 16è| 
phy_id2
;

1458 
nic
->
phy_add»ss
 = 0x18;

1462 
nic
->
autÚeg_adv”ti£
 = 0x01E1;

1465 
nic
->
autÚeg_’abËd
 = 
Œue
;

1466 
nic
->
lšk_¡©us
 = 
NIC_LINK_DOWN
;

1468 
	`LOG_INFO
("MII iÁ”çû in™Ÿlized: PHY_ID=0x%08lX, AutoNegóÇbËd", 
nic
->
phy_id
);

1470  
SUCCESS
;

1471 
	}
}

1477 
	$ud–ay
(
ušt32_t
 
miüo£cÚds
) {

1482 vŞ©
ušt32_t
 
i
, 
loİs_³r_us
 = 10;

1484 
i
 = 0; i < 
miüo£cÚds
 * 
loİs_³r_us
; i++) {

1486 
__asm__
 volatile ("nop");

1488 
	}
}

1496 * 
	$memÜy_®loc_®igÃd
(
size_t
 
size
, size_ˆ
®ignm’t
) {

1497 ià(!
size
 || (
®ignm’t
 & (alignment - 1)) != 0) {

1498  
NULL
;

1502 
size_t
 
tÙ®_size
 = 
size
 + 
®ignm’t
 - 1 + (*);

1503 *
±r
 = 
	`memÜy_®loc
(
tÙ®_size
);

1504 ià(!
±r
) {

1505  
NULL
;

1509 
ušŒ_t
 
addr
 = (ušŒ_t)
±r
 + (*);

1510 
addr
 = (add¸+ 
®ignm’t
 - 1) & ~(alignment - 1);

1511 *
®igÃd_±r
 = (*)
addr
;

1514 *((**)
®igÃd_±r
 - 1èğ
±r
;

1516  
®igÃd_±r
;

1517 
	}
}

1523 
	$memÜy_ä“_®igÃd
(*
±r
) {

1524 ià(!
±r
) {

1529 *
Üigš®_±r
 = *((**)
±r
 - 1);

1530 
	`memÜy_ä“
(
Üigš®_±r
);

1531 
	}
}

1538 
ušt32_t
 
	$dma_vœt_to_phys
(*
vœtu®_addr
) {

1540 
ušt16_t
 
£gm’t
 = 
	`FP_SEG
(
vœtu®_addr
);

1541 
ušt16_t
 
off£t
 = 
	`FP_OFF
(
vœtu®_addr
);

1542  ((
ušt32_t
)
£gm’t
 << 4è+ 
off£t
;

1543 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/packet_ops.c

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~"../šşude/·ck‘_İs.h
"

14 
	~"../šşude/h¬dw¬e.h
"

15 
	~"../šşude/routšg.h
"

16 
	~"../šşude/¡©ic_routšg.h
"

17 
	~"../šşude/¬p.h
"

18 
	~"../šşude/bufãr_®loc.h
"

19 
	~"../šşude/loggšg.h
"

20 
	~"../šşude/¡©s.h
"

21 
	~"../šşude/­i.h
"

22 
	~"../šşude/æow_cÚŒŞ.h
"

23 
	~"../šşude/´oduùiÚ.h
"

26 
	#MAX_BOTTOM_HALF_TICKS
 100

	)

27 
	#g‘_tim”_ticks
(è0

	)

30 
	#PACKET_ERR_NOT_INITIALIZED
 -11

	)

31 
	#PACKET_ERR_NO_MEMORY
 -12

	)

34 #iâdeà
ERROR_NO_DATA


35 
	#ERROR_NO_DATA
 -10

	)

39 
	g·ck‘_İs_š™Ÿlized
 = 0;

40 
·ck‘_¡©s_t
 
	g·ck‘_¡©i¡ics
 = {0};

44 
·ck‘_queue_t
 
	mtx_queues
[4];

45 
·ck‘_queue_t
 
	mrx_queue
;

46 
ušt32_t
 
	mqueue_fuÎ_ev’ts
;

47 
ušt32_t
 
	mback´essu»_ev’ts
;

48 
ušt32_t
 
	m´iÜ™y_drİs
;

49 
ušt32_t
 
	mad­tive_»sizes
;

50 
boŞ
 
	mæow_cÚŒŞ_aùive
;

51 
ušt32_t
 
	mÏ¡_queue_check
;

52 } 
	gg_queue_¡©e
 = {0};

55 
	#TX_QUEUE_URGENT_SIZE
 32

	)

56 
	#TX_QUEUE_HIGH_SIZE
 64

	)

57 
	#TX_QUEUE_NORMAL_SIZE
 128

	)

58 
	#TX_QUEUE_LOW_SIZE
 64

	)

59 
	#RX_QUEUE_SIZE
 256

	)

60 
	#QUEUE_WATERMARK_HIGH
 80

	)

61 
	#QUEUE_WATERMARK_LOW
 20

	)

62 
	#FLOW_CONTROL_THRESHOLD
 90

	)

63 
	#QUEUE_CHECK_INTERVAL_MS
 100

	)

66 
rou‹_·ck‘_to_š‹rçû
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
, ušt8_ˆ
de¡_nic
);

69 
·ck‘_queue_š™_®l
();

70 
·ck‘_queue_ş—nup_®l
();

71 
·ck‘_’queue_w™h_´iÜ™y
(
·ck‘_bufãr_t
 *
bufãr
, 
´iÜ™y
);

72 
·ck‘_bufãr_t
* 
·ck‘_dequeue_by_´iÜ™y
();

73 
·ck‘_check_queue_h—Éh
();

74 
·ck‘_­¶y_æow_cÚŒŞ
();

75 
·ck‘_ad­tive_queue_»size
();

76 
·ck‘_hªdË_queue_ov”æow
(
´iÜ™y
);

77 
boŞ
 
·ck‘_should_drİ_Ú_fuÎ
(
´iÜ™y
, 
queue_u§ge
);

78 
ušt32_t
 
·ck‘_ÿlcuÏ‹_queue_u§ge
(
·ck‘_queue_t
 *
queue
);

79 
·ck‘_upd©e_queue_¡©s
();

80 
·ck‘_em”g’cy_queue_d¿š
();

83 #´agm¨
code_£g
("COLD_TEXT", "CODE")

90 
	$·ck‘_İs_š™
(cÚ¡ 
cÚfig_t
 *
cÚfig
) {

91 
»suÉ
;

93 ià(!
cÚfig
) {

94 
	`log_”rÜ
("packet_ops_init: NULL config…arameter");

95  
PACKET_ERR_INVALID_PARAM
;

98 
	`log_šfo
("Initializing…acket operations subsystem with…roduction queue management");

101 
	`mem£t
(&
·ck‘_¡©i¡ics
, 0, (packet_statistics));

104 
»suÉ
 = 
	`·ck‘_queue_š™_®l
();

105 ià(
»suÉ
 != 0) {

106 
	`log_”rÜ
("FaedØš™Ÿliz´oduùiÚ queumªagem’t: %d", 
»suÉ
);

107  
»suÉ
;

111 
g_queue_¡©e
.
æow_cÚŒŞ_aùive
 = 
çl£
;

112 
g_queue_¡©e
.
Ï¡_queue_check
 = 
	`¡©s_g‘_time¡amp
();

115 
»suÉ
 = 
	`æow_cÚŒŞ_š™
();

116 ià(
»suÉ
 != 0) {

117 
	`log_w¬nšg
("802.3x Flow CÚŒŞ in™Ÿliz©iÚ faed: %d, cÚtšušg w™houˆæow cÚŒŞ", 
»suÉ
);

120 
	`log_debug
("802.3x Flow Control initialized with CPU-efficient state management");

123 
·ck‘_İs_š™Ÿlized
 = 1;

125 
	`log_šfo
("Packet operations subsystem initialized with…roduction features");

127 
	}
}

138 
	$·ck‘_£nd_’hªûd
(
ušt8_t
 
š‹rçû_num
, cÚ¡ ušt8_ˆ*
·ck‘_d©a
,

139 
ušt16_t
 
Ëngth
, cÚ¡ 
ušt8_t
 *
de¡_addr
, ušt16_ˆ
hªdË
) {

140 
nic_šfo_t
 *
nic
;

141 
bufãr_desc_t
 *
bufãr
;

142 
ušt8_t
 *
äame_bufãr
;

143 
»suÉ
;

144 
ušt16_t
 
äame_Ëngth
;

145 
ıu_šfo_t
 
g_ıu_šfo
;

147 ià(!
·ck‘_d©a
 || 
Ëngth
 =ğ0 || !
de¡_addr
) {

148 
	`log_”rÜ
("packet_send_enhanced: Invalid…arameters");

149  
PACKET_ERR_INVALID_PARAM
;

152 ià(!
·ck‘_İs_š™Ÿlized
) {

153 
	`log_”rÜ
("Packet operations‚ot initialized");

154  
PACKET_ERR_NOT_INITIALIZED
;

157 
	`log_debug
("Sending…acket: interface=%d,†ength=%d, handle=%04X",

158 
š‹rçû_num
, 
Ëngth
, 
hªdË
);

161 ià(
Ëngth
 < 
ETH_MIN_DATA
 ||†’gth > 
ETH_MAX_DATA
) {

162 
	`log_”rÜ
("Invalid…acket data size: %d (must be %d-%d)",

163 
Ëngth
, 
ETH_MIN_DATA
, 
ETH_MAX_DATA
);

164 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

165  
PACKET_ERR_INVALID_SIZE
;

169 
äame_Ëngth
 = 
ETH_HEADER_LEN
 + 
Ëngth
;

170 ià(
äame_Ëngth
 < 
ETH_MIN_FRAME
) {

171 
äame_Ëngth
 = 
ETH_MIN_FRAME
;

175 
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

176 ià(!
nic
) {

177 
	`log_”rÜ
("Inv®id iÁ”çû‚umb”: %d", 
š‹rçû_num
);

178 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

179  
PACKET_ERR_INVALID_NIC
;

183 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

184 
	`log_”rÜ
("NIC %d i nÙ‡ùive", 
š‹rçû_num
);

185 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

186  
PACKET_ERR_INVALID_NIC
;

190 
bufãr
 = 
	`bufãr_®loc_nic_aw¬e
(
nic
->
šdex
, 
BUFFER_TYPE_TX
, 
äame_Ëngth
);

191 ià(!
bufãr
) {

192 
	`log_”rÜ
("Failedo‡llocateransmit buffer");

193 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

194  
PACKET_ERR_NO_BUFFERS
;

197 
äame_bufãr
 = (
ušt8_t
*)
	`bufãr_g‘_d©a_±r
(
bufãr
);

198 ià(!
äame_bufãr
) {

199 
	`bufãr_ä“_nic_aw¬e
(
nic
->
šdex
, 
bufãr
);

200  
PACKET_ERR_NO_BUFFERS
;

204 
»suÉ
 = 
	`·ck‘_bud_‘h”Ãt_äame_İtimized
(
äame_bufãr
, 
äame_Ëngth
,

205 
de¡_addr
, 
nic
->
mac
,

207 
·ck‘_d©a
, 
Ëngth
);

208 ià(
»suÉ
 < 0) {

209 
	`log_”rÜ
("FaedØbud Eth”Ãˆäame: %d", 
»suÉ
);

210 
	`bufãr_ä“_nic_aw¬e
(
nic
->
šdex
, 
bufãr
);

211 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

212  
»suÉ
;

216 ià(
	`æow_cÚŒŞ_should_·u£_ŒªsmissiÚ
(
nic
->
šdex
)) {

217 
ušt32_t
 
·u£_time
 = 
	`æow_cÚŒŞ_g‘_·u£_du¿tiÚ
(
nic
->
šdex
);

218 
	`log_debug
("T¿nsmissiÚ…au£d dutØ802.3x PAUSE f¿me, wa™šg %u ms", 
·u£_time
);

221 
	`æow_cÚŒŞ_wa™_fÜ_»sume
(
nic
->
šdex
, 
·u£_time
);

225 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
äame_bufãr
, 
äame_Ëngth
);

226 ià(
»suÉ
 < 0) {

227 
	`log_”rÜ
("H¬dw¬£nd faed oÀš‹rçû %d: %d", 
š‹rçû_num
, 
»suÉ
);

228 
	`bufãr_ä“_nic_aw¬e
(
nic
->
šdex
, 
bufãr
);

229 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

230  
»suÉ
;

234 
·ck‘_¡©i¡ics
.
tx_·ck‘s
++;

235 
·ck‘_¡©i¡ics
.
tx_by‹s
 +ğ
äame_Ëngth
;

238 
	`bufãr_ä“_nic_aw¬e
(
nic
->
šdex
, 
bufãr
);

240 
	`log_debug
("Pack‘ s’ˆsucûssfuÎy vŸ iÁ”çû %d (äame_size=%d)", 
š‹rçû_num
, 
äame_Ëngth
);

242 
	}
}

245 #´agm¨
code_£g
()

248 #´agm¨
code_£g
("_TEXT", "CODE")

257 
	$·ck‘_£nd
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
, 
ušt16_t
 
hªdË
) {

258 
nic_šfo_t
 *
nic
;

259 
»suÉ
;

261 ià(!
·ck‘
 || 
Ëngth
 == 0) {

262 
	`log_”rÜ
("packet_send: Invalid…arameters");

263  
PACKET_ERR_INVALID_PARAM
;

266 ià(!
·ck‘_İs_š™Ÿlized
) {

267 
	`log_”rÜ
("Packet operations‚ot initialized");

268  
PACKET_ERR_NOT_INITIALIZED
;

271 
	`log_debug
("S’dšg…ack‘:†’gth=%d, hªdË=%04X", 
Ëngth
, 
hªdË
);

274 ià(
Ëngth
 < 
PACKET_MIN_SIZE
 ||†’gth > 
PACKET_MAX_SIZE
) {

275 
	`log_”rÜ
("Inv®id…ack‘ size: %d", 
Ëngth
);

276 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

277  
PACKET_ERR_INVALID_SIZE
;

281 
nic
 = 
	`h¬dw¬e_g‘_nic
(0);

282 ià(!
nic
) {

283 
	`log_”rÜ
("No suitable NIC found for…acket");

284 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

285  
PACKET_ERR_INVALID_NIC
;

289 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
·ck‘
, 
Ëngth
);

290 ià(
»suÉ
 < 0) {

291 
	`log_”rÜ
("H¬dw¬£nd faed: %d", 
»suÉ
);

292 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

293  
»suÉ
;

297 
·ck‘_¡©i¡ics
.
tx_·ck‘s
++;

298 
·ck‘_¡©i¡ics
.
tx_by‹s
 +ğ
Ëngth
;

300 
	`log_debug
("Pack‘ s’ˆsucûssfuÎy vŸ NIC %d", 
nic
->
ty³
);

302 
	}
}

312 
	$·ck‘_»ûive
(
ušt8_t
 *
bufãr
, 
size_t
 
max_Ëngth
, size_ˆ*
aùu®_Ëngth
, 
nic_id
) {

313 
nic_šfo_t
 *
nic
;

314 
»suÉ
;

316 ià(!
bufãr
 || !
aùu®_Ëngth
 || 
max_Ëngth
 == 0) {

317 
	`log_”rÜ
("packet_receive: Invalid…arameters");

318  
PACKET_ERR_INVALID_PARAM
;

321 ià(!
·ck‘_İs_š™Ÿlized
) {

322 
	`log_”rÜ
("Packet operations‚ot initialized");

323  
PACKET_ERR_NOT_INITIALIZED
;

326 
	`log_debug
("Reûivšg…ack‘ from NIC %d, max_Ëngth=%d", 
nic_id
, 
max_Ëngth
);

329 
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_id
);

330 ià(!
nic
) {

331 
	`log_”rÜ
("Inv®id NIC ID: %d", 
nic_id
);

332  
PACKET_ERR_INVALID_NIC
;

336 
»suÉ
 = 
	`h¬dw¬e_»ûive_·ck‘
(
nic
, 
bufãr
, 
aùu®_Ëngth
);

337 ià(
»suÉ
 < 0) {

338 ià(
»suÉ
 !ğ
PACKET_ERR_NO_PACKET
) {

339 
	`log_”rÜ
("H¬dw¬»ûivçed: %d", 
»suÉ
);

340 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

342  
»suÉ
;

346 ià(*
aùu®_Ëngth
 < 
PACKET_MIN_SIZE
 || *aùu®_Ëngth > 
max_Ëngth
) {

347 
	`log_”rÜ
("Inv®id„eûived…ack‘ size: %d", *
aùu®_Ëngth
);

348 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

349  
PACKET_ERR_INVALID_SIZE
;

353 
·ck‘_¡©i¡ics
.
rx_·ck‘s
++;

354 
·ck‘_¡©i¡ics
.
rx_by‹s
 +ğ*
aùu®_Ëngth
;

356 
	`log_debug
("Pack‘„eûived:†’gth=%d", *
aùu®_Ëngth
);

359 
»suÉ
 = 
	`­i_´oûss_»ûived_·ck‘
(
bufãr
, *
aùu®_Ëngth
, 
nic_id
);

360 ià(
»suÉ
 < 0) {

361 
	`log_debug
("No handlers for„eceived…acket");

362 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

366 
	}
}

375 
	$·ck‘_»ûive_äom_nic
(
nic_šdex
, 
ušt8_t
 *
bufãr
, 
size_t
 *
Ëngth
) {

376 
nic_šfo_t
 *
nic
;

377 
bufãr_desc_t
 *
rx_bufãr
 = 
NULL
;

378 
‘h_h—d”_t
 
‘h_h—d”
;

379 
»suÉ
;

380 
size_t
 
Üigš®_bufãr_size
;

382 ià(!
bufãr
 || !
Ëngth
 || *length == 0) {

383 
	`log_”rÜ
("packet_receive_from_nic: Invalid…arameters");

384  
PACKET_ERR_INVALID_PARAM
;

387 ià(!
·ck‘_İs_š™Ÿlized
) {

388 
	`log_”rÜ
("Packet operations‚ot initialized");

389  
PACKET_ERR_NOT_INITIALIZED
;

392 
Üigš®_bufãr_size
 = *
Ëngth
;

393 
	`log_debug
("Reûivšg…ack‘ from NIC %d, max_Ëngth=%zu", 
nic_šdex
, 
Üigš®_bufãr_size
);

396 
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_šdex
);

397 ià(!
nic
) {

398 
	`log_”rÜ
("Inv®id NIC iÁ”çû: %d", 
nic_šdex
);

399 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

400  
PACKET_ERR_INVALID_NIC
;

404 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

405 
	`log_w¬nšg
("NIC %d i nÙ‡ùivfÜ„eû±iÚ", 
nic_šdex
);

406  
PACKET_ERR_INVALID_NIC
;

410 
rx_bufãr
 = 
	`rx_cİyb»ak_®loc
(
ETH_MAX_FRAME
);

411 ià(!
rx_bufãr
) {

412 
	`log_”rÜ
("Failedo‡llocate RX buffer for…acket„eception");

413 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

414  
PACKET_ERR_NO_BUFFERS
;

418 
size_t
 
·ck‘_Ëngth
 = 
rx_bufãr
->
size
;

419 
»suÉ
 = 
nic
->
İs
->
	`»ûive_·ck‘
Òic, (
ušt8_t
*)
	`bufãr_g‘_d©a_±r
(
rx_bufãr
), &
·ck‘_Ëngth
);

421 ià(
»suÉ
 < 0) {

422 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

423 ià(
»suÉ
 =ğ
ERROR_NO_DATA
) {

425 *
Ëngth
 = 0;

426  
PACKET_ERR_NO_PACKET
;

428 
	`log_”rÜ
("H¬dw¬»ûivçed oÀNIC %d: %d", 
nic_šdex
, 
»suÉ
);

429 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

430  
»suÉ
;

435 ià(
·ck‘_Ëngth
 < 
ETH_MIN_FRAME
) {

436 
	`log_w¬nšg
("Reûived„uÁ f¿me:†’gth=%zu", 
·ck‘_Ëngth
);

437 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

438 
·ck‘_¡©i¡ics
.
rx_ruÁ
++;

439  
PACKET_ERR_INVALID_SIZE
;

442 ià(
·ck‘_Ëngth
 > 
ETH_MAX_FRAME
) {

443 
	`log_w¬nšg
("Reûived ov”sized f¿me:†’gth=%zu", 
·ck‘_Ëngth
);

444 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

445 
·ck‘_¡©i¡ics
.
rx_ov”size
++;

446  
PACKET_ERR_INVALID_SIZE
;

450 
ušt8_t
 *
·ck‘_d©a
 = (ušt8_t*)
	`bufãr_g‘_d©a_±r
(
rx_bufãr
);

451 
»suÉ
 = 
	`·ck‘_·r£_‘h”Ãt_h—d”
(
·ck‘_d©a
, 
·ck‘_Ëngth
, &
‘h_h—d”
);

452 ià(
»suÉ
 < 0) {

453 
	`log_w¬nšg
("Invalid Ethernet header in„eceived…acket");

454 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

455 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

456  
»suÉ
;

460 ià(
‘h_h—d”
.
‘h”ty³
 =ğ
ETHERTYPE_FLOW_CONTROL
) {

461 
	`log_debug
("Processing 802.3x PAUSE frame");

462 
»suÉ
 = 
	`æow_cÚŒŞ_´oûss_»ûived_·ck‘
(
nic_šdex
, 
·ck‘_d©a
, 
·ck‘_Ëngth
);

463 ià(
»suÉ
 > 0) {

464 
	`log_debug
("PAUSE f¿m´oûs£d,¿nsmissiÚhrÙed fÜ %d ms", 
»suÉ
);

466 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

467  
PACKET_ERR_NO_PACKET
;

472 
ušt32_t
 
bufãr_u§ge
 = 
	`ÿlcuÏ‹_bufãr_u§ge_³rûÁage
(
nic_šdex
);

473 
	`æow_cÚŒŞ_upd©e_bufãr_¡©us
(
nic_šdex
, 
bufãr_u§ge
);

476 ià(!
	`·ck‘_is_fÜ_us
(
·ck‘_d©a
, 
nic
->
mac
) &&

477 !
	`·ck‘_is_brßdÿ¡
(
·ck‘_d©a
) &&

478 !
	`·ck‘_is_muÉiÿ¡
(
·ck‘_d©a
)) {

480 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_PROMISCUOUS
)) {

481 
	`log_debug
("Packet‚ot‡ddressedo us, dropping");

482 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

483 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

484  
PACKET_ERR_NO_PACKET
;

489 ià(
·ck‘_Ëngth
 > 
Üigš®_bufãr_size
) {

490 
	`log_”rÜ
("Reûived…ack‘oØÏrgfÜ bufãr:‚“d %zu, hav%zu", 
·ck‘_Ëngth
, 
Üigš®_bufãr_size
);

491 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

492 *
Ëngth
 = 
·ck‘_Ëngth
;

493  
PACKET_ERR_INVALID_SIZE
;

497 
	`memıy
(
bufãr
, 
·ck‘_d©a
, 
·ck‘_Ëngth
);

498 *
Ëngth
 = 
·ck‘_Ëngth
;

501 
·ck‘_¡©i¡ics
.
rx_·ck‘s
++;

502 
·ck‘_¡©i¡ics
.
rx_by‹s
 +ğ
·ck‘_Ëngth
;

505 
	`·ck‘_upd©e_d‘aed_¡©s
(
nic_šdex
, 1, 
·ck‘_Ëngth
, 0);

507 
	`log_debug
("Successfully„eceived %zu byte…acket from NIC %d (EtherType=0x%04X)",

508 
·ck‘_Ëngth
, 
nic_šdex
, 
	`Áohs
(
‘h_h—d”
.
‘h”ty³
));

511 
»suÉ
 = 
	`·ck‘_»ûive_´oûss
(
·ck‘_d©a
, 
·ck‘_Ëngth
, 
nic_šdex
);

512 ià(
»suÉ
 < 0) {

513 
	`log_debug
("Pack‘…roûssšg„‘uºed %d -…ack‘ d–iv”edØu£¸buˆnÙ…roûs£d†oÿÎy", 
»suÉ
);

517 
	`rx_cİyb»ak_ä“
(
rx_bufãr
);

520 
	}
}

527 
xms_bufãr_poŞ_t
 
g_xms_poŞ
;

528 
¥sc_queue_t
 
g_deã¼ed_queue
;

532 vŞ©
boŞ
 
	mxms_’abËd
;

533 vŞ©
boŞ
 
	mbÙtom_h®f_aùive
;

534 
ušt16_t
 
	mxms_th»shŞd
;

536 
ušt16_t
 
	m·ck‘s_deã¼ed
;

537 
ušt16_t
 
	m·ck‘s_´oûs£d
;

538 
ušt16_t
 
	mxms_cİ›s
;

539 
ušt16_t
 
	m¡agšg_exhau¡ed
;

540 
ušt16_t
 
	mqueue_fuÎ_drİs
;

541 
ušt16_t
 
	mov”size_drİs
;

542 
ušt16_t
 
	mxms_®loc_çu»s
;

543 
ušt16_t
 
	mxms_move_çu»s
;

544 } 
	gg_bÙtom_h®f_¡©e
 = {0};

553 
	$·ck‘_bÙtom_h®f_š™
(
boŞ
 
’abË_xms
, 
ušt32_t
 
¡agšg_couÁ
, ušt32_ˆ
xms_couÁ
) {

554 
»suÉ
;

556 
	`log_šfo
("Initializing bottom-half…rocessing: xms=%s, staging=%u, xms_buffers=%u",

557 
’abË_xms
 ? "’abËd" : "di§bËd", 
¡agšg_couÁ
, 
xms_couÁ
);

560 
»suÉ
 = 
	`¡agšg_bufãr_š™
(
¡agšg_couÁ
, 
ETH_MAX_FRAME
);

561 ià(
»suÉ
 !ğ
SUCCESS
) {

562 
	`log_”rÜ
("FaedØš™Ÿliz¡agšg bufãrs: %d", 
»suÉ
);

563  
»suÉ
;

567 
»suÉ
 = 
	`¥sc_queue_š™
(&
g_deã¼ed_queue
);

568 ià(
»suÉ
 !ğ
SUCCESS
) {

569 
	`log_”rÜ
("FaedØš™ŸlizSPSC queue: %d", 
»suÉ
);

570 
	`¡agšg_bufãr_ş—nup
();

571  
»suÉ
;

575 ià(
’abË_xms
 && 
xms_couÁ
 > 0) {

576 
»suÉ
 = 
	`xms_bufãr_poŞ_š™
(&
g_xms_poŞ
, 
ETH_MAX_FRAME
, 
xms_couÁ
);

577 ià(
»suÉ
 =ğ
SUCCESS
) {

578 
g_bÙtom_h®f_¡©e
.
xms_’abËd
 = 
Œue
;

579 
g_bÙtom_h®f_¡©e
.
xms_th»shŞd
 = 
RX_COPYBREAK_THRESHOLD
;

580 
	`log_šfo
("XMS bufã¸poŞ in™Ÿlized w™h %u bufãrs", 
xms_couÁ
);

582 
	`log_w¬nšg
("XMS…oŞ in™ faed (%d), usšg cÚv’tiÚ® memÜy oÆy", 
»suÉ
);

583 
g_bÙtom_h®f_¡©e
.
xms_’abËd
 = 
çl£
;

588 
g_bÙtom_h®f_¡©e
.
·ck‘s_deã¼ed
 = 0;

589 
g_bÙtom_h®f_¡©e
.
·ck‘s_´oûs£d
 = 0;

590 
g_bÙtom_h®f_¡©e
.
xms_cİ›s
 = 0;

591 
g_bÙtom_h®f_¡©e
.
¡agšg_exhau¡ed
 = 0;

592 
g_bÙtom_h®f_¡©e
.
queue_fuÎ_drİs
 = 0;

593 
g_bÙtom_h®f_¡©e
.
ov”size_drİs
 = 0;

594 
g_bÙtom_h®f_¡©e
.
xms_®loc_çu»s
 = 0;

595 
g_bÙtom_h®f_¡©e
.
xms_move_çu»s
 = 0;

596 
g_bÙtom_h®f_¡©e
.
bÙtom_h®f_aùive
 = 
Œue
;

598  
SUCCESS
;

599 
	}
}

604 
	$·ck‘_bÙtom_h®f_ş—nup
() {

605 
	`log_šfo
("Bottom-half statistics:");

606 
	`log_šfo
(" Packets: deferred=%u,…rocessed=%u",

607 ()
g_bÙtom_h®f_¡©e
.
·ck‘s_deã¼ed
,

608 ()
g_bÙtom_h®f_¡©e
.
·ck‘s_´oûs£d
);

609 
	`log_šfo
(" Drops: staging=%u, queue_full=%u, oversize=%u",

610 ()
g_bÙtom_h®f_¡©e
.
¡agšg_exhau¡ed
,

611 ()
g_bÙtom_h®f_¡©e
.
queue_fuÎ_drİs
,

612 ()
g_bÙtom_h®f_¡©e
.
ov”size_drİs
);

613 
	`log_šfo
(" XMS: copies=%u,‡lloc_fail=%u, move_fail=%u",

614 ()
g_bÙtom_h®f_¡©e
.
xms_cİ›s
,

615 ()
g_bÙtom_h®f_¡©e
.
xms_®loc_çu»s
,

616 ()
g_bÙtom_h®f_¡©e
.
xms_move_çu»s
);

619 ià(
g_bÙtom_h®f_¡©e
.
xms_’abËd
) {

620 
	`xms_bufãr_poŞ_ş—nup
(&
g_xms_poŞ
);

624 
	`¥sc_queue_ş—nup
(&
g_deã¼ed_queue
);

627 
	`¡agšg_bufãr_ş—nup
();

630 
	`memÜy_z”o
(&
g_bÙtom_h®f_¡©e
, (g_bottom_half_state));

631 
	}
}

643 
	$·ck‘_i¤_»ûive
(
ušt8_t
 *
·ck‘_d©a
, 
ušt16_t
 
·ck‘_size
, ušt8_ˆ
nic_šdex
) {

644 
¡agšg_bufãr_t
 *
¡agšg
;

645 
»suÉ
;

648 ià(!
g_bÙtom_h®f_¡©e
.
bÙtom_h®f_aùive
) {

650 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

651  
PACKET_ERR_NOT_INITIALIZED
;

655 
¡agšg
 = 
	`¡agšg_bufãr_®loc
();

656 ià(!
¡agšg
) {

657 
g_bÙtom_h®f_¡©e
.
¡agšg_exhau¡ed
++;

658 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

659  
PACKET_ERR_NO_BUFFER
;

663 ià(
·ck‘_size
 > 
¡agšg
->
size
) {

664 
g_bÙtom_h®f_¡©e
.
ov”size_drİs
++;

665 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

666 
	`¡agšg_bufãr_ä“
(
¡agšg
);

667  
PACKET_ERR_INVALID_SIZE
;

671 
	`memÜy_cİy_İtimized
(
¡agšg
->
d©a
, 
·ck‘_d©a
, 
·ck‘_size
);

672 
¡agšg
->
·ck‘_size
 =…acket_size;

673 
¡agšg
->
u£d
 = 
·ck‘_size
;

674 
¡agšg
->
nic_šdex
 =‚ic_index;

677 
	`comp”_b¬r›r
();

680 
»suÉ
 = 
	`¥sc_queue_’queue
(&
g_deã¼ed_queue
, 
¡agšg
);

681 ià(
»suÉ
 !ğ
SUCCESS
) {

682 
g_bÙtom_h®f_¡©e
.
queue_fuÎ_drİs
++;

683 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

684 
	`¡agšg_bufãr_ä“
(
¡agšg
);

685  
»suÉ
;

688 
g_bÙtom_h®f_¡©e
.
·ck‘s_deã¼ed
++;

689  
SUCCESS
;

690 
	}
}

698 
	$´oûss_deã¼ed_·ck‘s
() {

699 
¡agšg_bufãr_t
 *
¡agšg
;

700 
ušt32_t
 
xms_off£t
;

701 
xms_·ck‘_desc_t
 
xms_desc
;

702 
bufãr_desc_t
 *
cÚv_bufãr
;

703 
»suÉ
;

704 
ušt32_t
 
´oûs£d
 = 0;

705 
ušt32_t
 
´oûss_¡¬t_time
 = 
	`g‘_tim”_ticks
();

708 !
	`¥sc_queue_is_em±y
(&
g_deã¼ed_queue
)) {

709 
¡agšg
 = 
	`¥sc_queue_dequeue
(&
g_deã¼ed_queue
);

710 ià(!
¡agšg
) {

715 ià(
g_bÙtom_h®f_¡©e
.
xms_’abËd
 &&

716 
¡agšg
->
·ck‘_size
 >ğ
g_bÙtom_h®f_¡©e
.
xms_th»shŞd
) {

719 
»suÉ
 = 
	`xms_bufãr_®loc
(&
g_xms_poŞ
, &
xms_off£t
);

720 ià(
»suÉ
 =ğ
SUCCESS
) {

722 
»suÉ
 = 
	`xms_cİy_to_bufãr
(&
g_xms_poŞ
, 
xms_off£t
,

723 
¡agšg
->
d©a
, sgšg->
·ck‘_size
);

724 ià(
»suÉ
 =ğ
SUCCESS
) {

726 
xms_desc
.
xms_hªdË
 = 
g_xms_poŞ
.xms_handle;

727 
xms_desc
.
xms_off£t
 = xms_offset;

728 
xms_desc
.
·ck‘_size
 = 
¡agšg
->packet_size;

729 
xms_desc
.
nic_šdex
 = 
¡agšg
->nic_index;

732 
	`¡agšg_bufãr_ä“
(
¡agšg
);

733 
¡agšg
 = 
NULL
;

735 
g_bÙtom_h®f_¡©e
.
xms_cİ›s
++;

738 
	`·ck‘_´oûss_äom_xms
(&
xms_desc
);

741 
	`xms_bufãr_ä“
(&
g_xms_poŞ
, 
xms_off£t
);

744 
g_bÙtom_h®f_¡©e
.
xms_move_çu»s
++;

745 
	`xms_bufãr_ä“
(&
g_xms_poŞ
, 
xms_off£t
);

748 
	`·ck‘_»ûive_´oûss
(
¡agšg
->
d©a
, sgšg->
·ck‘_size
,

749 
¡agšg
->
nic_šdex
);

750 
	`¡agšg_bufãr_ä“
(
¡agšg
);

754 
g_bÙtom_h®f_¡©e
.
xms_®loc_çu»s
++;

757 
	`·ck‘_»ûive_´oûss
(
¡agšg
->
d©a
, sgšg->
·ck‘_size
,

758 
¡agšg
->
nic_šdex
);

759 
	`¡agšg_bufãr_ä“
(
¡agšg
);

763 
cÚv_bufãr
 = 
	`rx_cİyb»ak_®loc
(
¡agšg
->
·ck‘_size
);

764 ià(
cÚv_bufãr
) {

766 
	`memÜy_cİy_İtimized
(
cÚv_bufãr
->
d©a
, 
¡agšg
->d©a, sgšg->
·ck‘_size
);

767 
cÚv_bufãr
->
u£d
 = 
¡agšg
->
·ck‘_size
;

770 
ušt8_t
 
§ved_nic
 = 
¡agšg
->
nic_šdex
;

771 
	`¡agšg_bufãr_ä“
(
¡agšg
);

774 
	`·ck‘_»ûive_´oûss
(
cÚv_bufãr
->
d©a
, cÚv_bufãr->
u£d
, 
§ved_nic
);

777 
	`rx_cİyb»ak_ä“
(
cÚv_bufãr
);

778 
	`rx_cİyb»ak_»cÜd_cİy
();

781 
	`·ck‘_»ûive_´oûss
(
¡agšg
->
d©a
, sgšg->
·ck‘_size
,

782 
¡agšg
->
nic_šdex
);

783 
	`¡agšg_bufãr_ä“
(
¡agšg
);

787 
´oûs£d
++;

788 
g_bÙtom_h®f_¡©e
.
·ck‘s_´oûs£d
++;

791 ià(
	`g‘_tim”_ticks
(è- 
´oûss_¡¬t_time
 > 
MAX_BOTTOM_HALF_TICKS
) {

795 
	}
}

803 
	$·ck‘_¢­shÙ_¡©s
(*
¡©s
, 
size_t
 
size
) {

804 
ušt16_t
 
æags
;

806 ià(!
¡©s
 || 
size
 !ğ(
g_bÙtom_h®f_¡©e
)) {

811 
__asm__
 
	`__vŞ©e__
(

815 : "ô"(
æags
) :: "memory"

819 
	`memÜy_cİy_İtimized
(
¡©s
, &
g_bÙtom_h®f_¡©e
, 
size
);

822 
__asm__
 
	`__vŞ©e__
(

825 :: "r"(
æags
) : "memory"

827 
	}
}

836 
	$·ck‘_´oûss_äom_xms
(
xms_·ck‘_desc_t
 *
desc
) {

837 
ušt8_t
 *
‹mp_bufãr
;

838 
»suÉ
;

840 ià(!
desc
) {

841  
PACKET_ERR_INVALID_PARAM
;

845 
‹mp_bufãr
 = (
ušt8_t
*)
	`memÜy_®loÿ‹
(
desc
->
·ck‘_size
, 
MEMORY_FLAG_ZERO
);

846 ià(!
‹mp_bufãr
) {

847  
PACKET_ERR_NO_MEMORY
;

851 
»suÉ
 = 
	`xms_cİy_äom_bufãr
(&
g_xms_poŞ
, 
‹mp_bufãr
,

852 
desc
->
xms_off£t
, desc->
·ck‘_size
);

853 ià(
»suÉ
 !ğ
SUCCESS
) {

854 
	`memÜy_ä“
(
‹mp_bufãr
);

855  
»suÉ
;

859 
»suÉ
 = 
	`·ck‘_»ûive_´oûss
(
‹mp_bufãr
, 
desc
->
·ck‘_size
, desc->
nic_šdex
);

862 
	`memÜy_ä“
(
‹mp_bufãr
);

864  
»suÉ
;

865 
	}
}

874 
	$·ck‘_»ûive_´oûss
(
ušt8_t
 *
¿w_d©a
, 
ušt16_t
 
Ëngth
, ušt8_ˆ
nic_šdex
) {

875 
‘h_h—d”_t
 
‘h_h—d”
;

876 
ušt8_t
 *
·ylßd_d©a
;

877 
ušt16_t
 
·ylßd_Ëngth
;

878 
nic_šfo_t
 *
nic
;

879 
»suÉ
;

881 ià(!
¿w_d©a
 || 
Ëngth
 == 0) {

882  
PACKET_ERR_INVALID_PARAM
;

885 
	`log_debug
("Proûssšg„eûived…ack‘:†’gth=%d,‚ic=%d", 
Ëngth
, 
nic_šdex
);

888 ià(
Ëngth
 < 
ETH_MIN_FRAME
) {

889 
	`log_w¬nšg
("Reûived„uÁ f¿me:†’gth=%d", 
Ëngth
);

890 
·ck‘_¡©i¡ics
.
rx_ruÁ
++;

891  
PACKET_ERR_INVALID_SIZE
;

894 ià(
Ëngth
 > 
ETH_MAX_FRAME
) {

895 
	`log_w¬nšg
("Reûived ov”sized f¿me:†’gth=%d", 
Ëngth
);

896 
·ck‘_¡©i¡ics
.
rx_ov”size
++;

897  
PACKET_ERR_INVALID_SIZE
;

901 
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_šdex
);

902 ià(!
nic
) {

903 
	`log_”rÜ
("Inv®id NIC index: %d", 
nic_šdex
);

904  
PACKET_ERR_INVALID_NIC
;

908 
»suÉ
 = 
	`·ck‘_·r£_‘h”Ãt_h—d”
(
¿w_d©a
, 
Ëngth
, &
‘h_h—d”
);

909 ià(
»suÉ
 < 0) {

910 
	`log_w¬nšg
("Invalid Ethernet header in„eceived…acket");

911 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

912  
»suÉ
;

916 ià(!
	`·ck‘_is_fÜ_us
(
¿w_d©a
, 
nic
->
mac
) &&

917 !
	`·ck‘_is_brßdÿ¡
(
¿w_d©a
) &&

918 !
	`·ck‘_is_muÉiÿ¡
(
¿w_d©a
)) {

920 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_PROMISCUOUS
)) {

921 
	`log_debug
("Packet‚ot‡ddressedo us, dropping");

922 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

928 
·ylßd_d©a
 = 
¿w_d©a
 + 
ETH_HEADER_LEN
;

929 
·ylßd_Ëngth
 = 
Ëngth
 - 
ETH_HEADER_LEN
;

932 ià(
·ylßd_Ëngth
 < 
ETH_MIN_DATA
) {

934 ià(
·ylßd_Ëngth
 > 0) {

935 
	`log_debug
("Reûived…added f¿me,…aylßd=%d", 
·ylßd_Ëngth
);

940 
·ck‘_¡©i¡ics
.
rx_·ck‘s
++;

941 
·ck‘_¡©i¡ics
.
rx_by‹s
 +ğ
Ëngth
;

944 
ušt16_t
 
‘h”ty³
 = 
	`Áohs
(
‘h_h—d”
.ethertype);

946 
‘h”ty³
) {

947 
ETH_P_ARP
:

949 ià(
	`¬p_is_’abËd
()) {

950 
	`log_debug
("Processing ARP…acket");

951 
»suÉ
 = 
	`¬p_´oûss_»ûived_·ck‘
(
¿w_d©a
, 
Ëngth
, 
nic_šdex
);

952 ià(
»suÉ
 < 0) {

953 
	`log_w¬nšg
("ARP…roûssšg faed: %d", 
»suÉ
);

954 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

960 
ETH_P_IP
:

962 ià(
	`¡©ic_routšg_is_’abËd
()) {

963 
ušt8_t
 
de¡_nic
;

964 
»suÉ
 = 
	`¡©ic_routšg_´oûss__·ck‘
(
·ylßd_d©a
, 
·ylßd_Ëngth
,

965 
nic_šdex
, &
de¡_nic
);

966 ià(
»suÉ
 =ğ
SUCCESS
 && 
de¡_nic
 !ğ
nic_šdex
) {

968 
	`log_debug
("Routšg IP…ack‘ from NIC %dØNIC %d", 
nic_šdex
, 
de¡_nic
);

969 
»suÉ
 = 
	`rou‹_·ck‘_to_š‹rçû
(
¿w_d©a
, 
Ëngth
, 
de¡_nic
);

970 ià(
»suÉ
 =ğ
SUCCESS
) {

971 
·ck‘_¡©i¡ics
.
rou‹d_·ck‘s
++;

973 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

986 
»suÉ
 = 
	`routšg_´oûss_·ck‘
(
¿w_d©a
, 
Ëngth
, 
nic_šdex
);

987 ià(
»suÉ
 > 0) {

989 
	`log_debug
("Pack‘ bridgedØš‹rçû %d", 
»suÉ
);

990 
·ck‘_¡©i¡ics
.
rou‹d_·ck‘s
++;

995 
»suÉ
 = 
	`­i_´oûss_»ûived_·ck‘
(
¿w_d©a
, 
Ëngth
, 
nic_šdex
);

996 ià(
»suÉ
 < 0) {

997 
	`log_debug
("NØloÿÈhªdËr fÜƒth”ty³ 0x%04X", 
‘h”ty³
);

998 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

1002 
	}
}

1011 
	$·ck‘_´oûss_»ûived
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
, 
nic_id
) {

1012 
»suÉ
;

1014 ià(!
·ck‘
 || 
Ëngth
 == 0) {

1015  
PACKET_ERR_INVALID_PARAM
;

1018 
	`log_debug
("Proûssšg„eûived…ack‘:†’gth=%d,‚ic=%d", 
Ëngth
, 
nic_id
);

1021 ià(
Ëngth
 < 
PACKET_MIN_SIZE
) {

1022 
	`log_w¬nšg
("Reûived„uÁ…ack‘:†’gth=%d", 
Ëngth
);

1023 
·ck‘_¡©i¡ics
.
rx_ruÁ
++;

1024  
PACKET_ERR_INVALID_SIZE
;

1027 ià(
Ëngth
 > 
PACKET_MAX_SIZE
) {

1028 
	`log_w¬nšg
("Reûived ov”sized…ack‘:†’gth=%d", 
Ëngth
);

1029 
·ck‘_¡©i¡ics
.
rx_ov”size
++;

1030  
PACKET_ERR_INVALID_SIZE
;

1034 
»suÉ
 = 
	`routšg_´oûss_·ck‘
(
·ck‘
, 
Ëngth
, 
nic_id
);

1035 ià(
»suÉ
 > 0) {

1037 
	`log_debug
("Pack‘„ou‹dØš‹rçû %d", 
»suÉ
);

1038 
·ck‘_¡©i¡ics
.
rou‹d_·ck‘s
++;

1043 
»suÉ
 = 
	`­i_´oûss_»ûived_·ck‘
(
·ck‘
, 
Ëngth
, 
nic_id
);

1044 ià(
»suÉ
 < 0) {

1045 
	`log_debug
("No†ocal handlers for…acket");

1046 
·ck‘_¡©i¡ics
.
rx_drİ³d
++;

1050 
	}
}

1061 
	$·ck‘_£nd_w™h_»Œy
(cÚ¡ 
ušt8_t
 *
·ck‘_d©a
, 
ušt16_t
 
Ëngth
,

1062 cÚ¡ 
ušt8_t
 *
de¡_addr
, 
ušt16_t
 
hªdË
,

1063 
max_»Œ›s
) {

1064 
»suÉ
;

1065 
»Œy_couÁ
 = 0;

1066 
backoff_d–ay
 = 1;

1068 ià(!
·ck‘_d©a
 || !
de¡_addr
 || 
Ëngth
 == 0) {

1069  
PACKET_ERR_INVALID_PARAM
;

1072 ià(
max_»Œ›s
 < 0 || max_retries > 10) {

1073 
max_»Œ›s
 = 3;

1076 
»Œy_couÁ
 <ğ
max_»Œ›s
) {

1078 
nic_šdex
 = 
	`·ck‘_g‘_İtim®_nic
(
·ck‘_d©a
, 
Ëngth
);

1079 ià(
nic_šdex
 < 0) {

1081 
»suÉ
 = 
	`·ck‘_£nd_muÉi_nic
(
·ck‘_d©a
, 
Ëngth
, 
de¡_addr
, 
hªdË
);

1084 
»suÉ
 = 
	`·ck‘_£nd_’hªûd
(
nic_šdex
, 
·ck‘_d©a
, 
Ëngth
, 
de¡_addr
, 
hªdË
);

1088 ià(
»suÉ
 == 0) {

1089 ià(
»Œy_couÁ
 > 0) {

1090 
	`log_šfo
("Pack‘ s’ˆsucûssfuÎy‡á” %d„‘r›s", 
»Œy_couÁ
);

1096 
»suÉ
) {

1097 
PACKET_ERR_NO_BUFFERS
:

1099 
	`log_w¬nšg
("Bufferƒxhaustion,„etrying‡fter delay");

1100 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1103 
PACKET_ERR_INVALID_NIC
:

1105 
	`log_w¬nšg
("NIC failure detected,‡ttempting failover");

1106 ià(
nic_šdex
 >= 0) {

1107 
	`·ck‘_hªdË_nic_çov”
(
nic_šdex
);

1109 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1112 
PACKET_ERR_INVALID_SIZE
:

1114 
	`log_”rÜ
("Invalid…acket size,‡bortingransmission");

1115  
»suÉ
;

1118 
	`log_w¬nšg
("Transmission failed withƒrror %d,„etry %d/%d",

1119 
»suÉ
, 
»Œy_couÁ
, 
max_»Œ›s
);

1120 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1125 ià(
»Œy_couÁ
 >ğ
max_»Œ›s
) {

1126 
	`log_”rÜ
("Maximum„‘r› (%dèexûeded fÜ…ack‘¿nsmissiÚ", 
max_»Œ›s
);

1132 
	`log_debug
("Wa™šg %dm befÜ»Œy %d", 
backoff_d–ay
, 
»Œy_couÁ
 + 1);

1135 vŞ©
i
 = 0; i < 
backoff_d–ay
 * 1000; i++) {

1139 
»Œy_couÁ
++;

1140 
backoff_d–ay
 = (backoff_delay < 16) ? backoff_delay * 2 : 16;

1143  
»suÉ
;

1144 
	}
}

1155 
	$·ck‘_»ûive_w™h_»cov”y
(
ušt8_t
 *
bufãr
, 
size_t
 
max_Ëngth
,

1156 
size_t
 *
aùu®_Ëngth
, 
nic_id
,

1157 
ušt32_t
 
timeout_ms
) {

1158 
ušt32_t
 
¡¬t_time
;

1159 
»suÉ
;

1160 
nic_šfo_t
 *
nic
;

1162 ià(!
bufãr
 || !
aùu®_Ëngth
 || 
max_Ëngth
 == 0) {

1163  
PACKET_ERR_INVALID_PARAM
;

1166 ià(!
·ck‘_İs_š™Ÿlized
) {

1167  
PACKET_ERR_NOT_INITIALIZED
;

1171 
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_id
);

1172 ià(!
nic
) {

1173 
	`log_”rÜ
("Inv®id NIC ID: %d", 
nic_id
);

1174  
PACKET_ERR_INVALID_NIC
;

1178 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1179 
	`log_w¬nšg
("NIC %d i nÙ‡ùive", 
nic_id
);

1180  
PACKET_ERR_INVALID_NIC
;

1183 
¡¬t_time
 = 
	`¡©s_g‘_time¡amp
();

1187 
»suÉ
 = 
	`h¬dw¬e_»ûive_·ck‘
(
nic
, 
bufãr
, 
aùu®_Ëngth
);

1190 ià(
»suÉ
 == 0) {

1192 ià(*
aùu®_Ëngth
 < 
PACKET_MIN_SIZE
 || *aùu®_Ëngth > 
max_Ëngth
) {

1193 
	`log_w¬nšg
("Reûived inv®id…ack‘ size: %d", *
aùu®_Ëngth
);

1194 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

1199 
·ck‘_¡©i¡ics
.
rx_·ck‘s
++;

1200 
·ck‘_¡©i¡ics
.
rx_by‹s
 +ğ*
aùu®_Ëngth
;

1202 
	`log_debug
("Pack‘„eûived sucûssfuÎy:†’gth=%d", *
aùu®_Ëngth
);

1207 
»suÉ
) {

1208 
PACKET_ERR_NO_PACKET
:

1212 
PACKET_ERR_INVALID_SIZE
:

1213 
	`log_w¬nšg
("Received…acket with invalid size, discarding");

1214 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

1218 
	`log_w¬nšg
("H¬dw¬»ûiv”rÜ: %d", 
»suÉ
);

1219 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

1222 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1223 
	`log_”rÜ
("NIC %d beÿmšaùivduršg„eûive", 
nic_id
);

1224  
PACKET_ERR_INVALID_NIC
;

1230 ià(
timeout_ms
 > 0) {

1231 
ušt32_t
 
–­£d
 = 
	`¡©s_g‘_time¡amp
(è- 
¡¬t_time
;

1232 ià(
–­£d
 >ğ
timeout_ms
) {

1233 
	`log_debug
("Reûivtimeouˆaá” %lu ms", 
–­£d
);

1234  
PACKET_ERR_NO_PACKET
;

1239 vŞ©
i
 = 0; i < 100; i++) {

1243 
	}
}

1253 
	$·ck‘_queue_tx
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
, 
´iÜ™y
, 
ušt16_t
 
hªdË
) {

1254 
·ck‘_bufãr_t
 *
bufãr
;

1256 ià(!
·ck‘
 || 
Ëngth
 == 0) {

1257  
PACKET_ERR_INVALID_PARAM
;

1261 
	`log_debug
("Queuing…acket forransmission:†ength=%d,…riority=%d, handle=%04X",

1262 
Ëngth
, 
´iÜ™y
, 
hªdË
);

1265 
·ck‘_queue_t
 *
queue
 = &
g_·ck‘_queues
[
´iÜ™y
 % 
MAX_PRIORITY_LEVELS
];

1266 ià(
queue
->
couÁ
 >ğqueue->
max_size
) {

1267 
	`log_w¬nšg
("PriÜ™y %d queufuÎ, drİpšg…ack‘", 
´iÜ™y
);

1268  
PACKET_ERR_QUEUE_FULL
;

1272 
bufãr
 = 
	`bufãr_®loc_·ck‘_bufãr
(
Ëngth
);

1273 ià(!
bufãr
) {

1274 
	`log_”rÜ
("Failedo‡llocate…acket buffer");

1275 
·ck‘_¡©i¡ics
.
tx_bufãr_fuÎ
++;

1276  
PACKET_ERR_NO_BUFFERS
;

1280 
	`memıy
(
bufãr
->
d©a
, 
·ck‘
, 
Ëngth
);

1281 
bufãr
->
Ëngth
 =†ength;

1282 
bufãr
->
´iÜ™y
 =…riority;

1283 
bufãr
->
hªdË
 = handle;

1284 
bufãr
->
time¡amp
 = 
	`¡©s_g‘_time¡amp
();

1288 
»suÉ
 = 
	`·ck‘_£nd
(
bufãr
->
d©a
, bufãr->
Ëngth
, 
hªdË
);

1291 
	`bufãr_ä“_·ck‘_bufãr
(
bufãr
);

1293  
»suÉ
;

1294 
	}
}

1300 
	$·ck‘_æush_tx_queue
() {

1302 
	`log_debug
("Flushingransmission queue");

1304 
·ck‘s_£Á
 = 0;

1307 
´iÜ™y
 = 
MAX_PRIORITY_LEVELS
 - 1;…riority >= 0;…riority--) {

1308 
·ck‘_queue_t
 *
queue
 = &
g_·ck‘_queues
[
´iÜ™y
];

1310 
queue
->
couÁ
 > 0 && queue->
h—d
) {

1311 
·ck‘_bufãr_t
 *
bufãr
 = 
queue
->
h—d
;

1314 
»suÉ
 = 
	`·ck‘_£nd_immedŸ‹
(
bufãr
->
d©a
, bufãr->
Ëngth
, 0);

1315 ià(
»suÉ
 !ğ
SUCCESS
) {

1321 
__asm__
 
	`__vŞ©e__
("cli");

1322 
queue
->
h—d
 = 
bufãr
->
Ãxt
;

1323 ià(!
queue
->
h—d
) {

1324 
queue
->

 = 
NULL
;

1326 
queue
->
couÁ
--;

1327 
__asm__
 
	`__vŞ©e__
("sti");

1330 
	`bufãr_ä“_·ck‘_bufãr
(
bufãr
);

1331 
·ck‘s_£Á
++;

1335 
	`log_debug
("Flushed %d…ack‘ äom¿nsmissiÚ queues", 
·ck‘s_£Á
);

1336  
·ck‘s_£Á
;

1337 
	}
}

1344 
	$·ck‘_g‘_¡©i¡ics
(
·ck‘_¡©s_t
 *
¡©s
) {

1345 ià(!
¡©s
) {

1346  
PACKET_ERR_INVALID_PARAM
;

1349 *
¡©s
 = 
·ck‘_¡©i¡ics
;

1351 
	}
}

1360 
	$·ck‘_upd©e_d‘aed_¡©s
(
nic_šdex
, 
·ck‘_ty³
, 
ušt16_t
 
Ëngth
, 
»suÉ
) {

1361 
nic_šfo_t
 *
nic
;

1364 ià(
·ck‘_ty³
 == 0) {

1365 ià(
»suÉ
 == 0) {

1366 
·ck‘_¡©i¡ics
.
tx_·ck‘s
++;

1367 
·ck‘_¡©i¡ics
.
tx_by‹s
 +ğ
Ëngth
;

1369 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1372 ià(
»suÉ
 == 0) {

1373 
·ck‘_¡©i¡ics
.
rx_·ck‘s
++;

1374 
·ck‘_¡©i¡ics
.
rx_by‹s
 +ğ
Ëngth
;

1376 
·ck‘_¡©i¡ics
.
rx_”rÜs
++;

1381 
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_šdex
);

1382 ià(
nic
) {

1383 ià(
·ck‘_ty³
 == 0) {

1384 ià(
»suÉ
 == 0) {

1385 
nic
->
tx_·ck‘s
++;

1386 
nic
->
tx_by‹s
 +ğ
Ëngth
;

1388 
nic
->
tx_”rÜs
++;

1391 ià(
»suÉ
 == 0) {

1392 
nic
->
rx_·ck‘s
++;

1393 
nic
->
rx_by‹s
 +ğ
Ëngth
;

1395 
nic
->
rx_”rÜs
++;

1399 
	}
}

1406 
	$·ck‘_g‘_³rfÜmªû_m‘rics
(
·ck‘_³rfÜmªû_m‘rics_t
 *
m‘rics
) {

1407 
tÙ®_nics
;

1408 
nic_šfo_t
 *
nic
;

1409 
ušt32_t
 
tÙ®_tx_·ck‘s
 = 0;

1410 
ušt32_t
 
tÙ®_rx_·ck‘s
 = 0;

1411 
ušt32_t
 
tÙ®_”rÜs
 = 0;

1413 ià(!
m‘rics
) {

1414  
PACKET_ERR_INVALID_PARAM
;

1417 
	`mem£t
(
m‘rics
, 0, (
·ck‘_³rfÜmªû_m‘rics_t
));

1420 
m‘rics
->
tx_·ck‘s
 = 
·ck‘_¡©i¡ics
.tx_packets;

1421 
m‘rics
->
rx_·ck‘s
 = 
·ck‘_¡©i¡ics
.rx_packets;

1422 
m‘rics
->
tx_by‹s
 = 
·ck‘_¡©i¡ics
.tx_bytes;

1423 
m‘rics
->
rx_by‹s
 = 
·ck‘_¡©i¡ics
.rx_bytes;

1424 
m‘rics
->
tx_”rÜs
 = 
·ck‘_¡©i¡ics
.tx_errors;

1425 
m‘rics
->
rx_”rÜs
 = 
·ck‘_¡©i¡ics
.rx_errors;

1426 
m‘rics
->
rx_drİ³d
 = 
·ck‘_¡©i¡ics
.rx_dropped;

1429 
tÙ®_tx_·ck‘s
 = 
·ck‘_¡©i¡ics
.
tx_·ck‘s
;

1430 
tÙ®_rx_·ck‘s
 = 
·ck‘_¡©i¡ics
.
rx_·ck‘s
;

1431 
tÙ®_”rÜs
 = 
·ck‘_¡©i¡ics
.
tx_”rÜs
 +…ack‘_¡©i¡ics.
rx_”rÜs
;

1433 ià(
tÙ®_tx_·ck‘s
 > 0) {

1434 
m‘rics
->
tx_”rÜ_¿‹
 = (
·ck‘_¡©i¡ics
.
tx_”rÜs
 * 100è/ 
tÙ®_tx_·ck‘s
;

1437 ià(
tÙ®_rx_·ck‘s
 > 0) {

1438 
m‘rics
->
rx_”rÜ_¿‹
 = (
·ck‘_¡©i¡ics
.
rx_”rÜs
 * 100è/ 
tÙ®_rx_·ck‘s
;

1439 
m‘rics
->
rx_drİ_¿‹
 = (
·ck‘_¡©i¡ics
.
rx_drİ³d
 * 100è/ 
tÙ®_rx_·ck‘s
;

1444 
m‘rics
->
tx_throughput
 = 
tÙ®_tx_·ck‘s
;

1445 
m‘rics
->
rx_throughput
 = 
tÙ®_rx_·ck‘s
;

1448 
tÙ®_nics
 = 
	`h¬dw¬e_g‘_nic_couÁ
();

1449 
i
 = 0; i < 
tÙ®_nics
 && i < 
MAX_NICS
; i++) {

1450 
nic
 = 
	`h¬dw¬e_g‘_nic
(
i
);

1451 ià(
nic
) {

1452 
m‘rics
->
nic_¡©s
[
i
].
aùive
 = (
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
) ? 1 : 0;

1453 
m‘rics
->
nic_¡©s
[
i
].
lšk_up
 = (
nic
->
¡©us
 & 
NIC_STATUS_LINK_UP
) ? 1 : 0;

1454 
m‘rics
->
nic_¡©s
[
i
].
¥“d
 = (
nic
->
¡©us
 & 
NIC_STATUS_100MBPS
) ? 100 : 10;

1455 
m‘rics
->
nic_¡©s
[
i
].
fuÎ_du¶ex
 = (
nic
->
¡©us
 & 
NIC_STATUS_FULL_DUPLEX
) ? 1 : 0;

1456 
m‘rics
->
nic_¡©s
[
i
].
tx_·ck‘s
 = 
nic
->tx_packets;

1457 
m‘rics
->
nic_¡©s
[
i
].
rx_·ck‘s
 = 
nic
->rx_packets;

1458 
m‘rics
->
nic_¡©s
[
i
].
tx_”rÜs
 = 
nic
->tx_errors;

1459 
m‘rics
->
nic_¡©s
[
i
].
rx_”rÜs
 = 
nic
->rx_errors;

1463 
m‘rics
->
aùive_nics
 = 
tÙ®_nics
;

1464 
m‘rics
->
cŞËùiÚ_time
 = 
	`¡©s_g‘_time¡amp
();

1467 
	}
}

1473 
	$·ck‘_mÚ™Ü_h—Éh
() {

1474 
h—Éh_scÜe
 = 0;

1475 
tÙ®_nics
;

1476 
nic_šfo_t
 *
nic
;

1477 
ušt32_t
 
tÙ®_·ck‘s
;

1478 
ušt32_t
 
tÙ®_”rÜs
;

1481 ià(!
·ck‘_İs_š™Ÿlized
) {

1482 
	`log_w¬nšg
("Packet operations‚ot initialized");

1487 
tÙ®_nics
 = 
	`h¬dw¬e_g‘_nic_couÁ
();

1488 ià(
tÙ®_nics
 == 0) {

1489 
	`log_”rÜ
("No NICs‡vailable");

1493 
aùive_nics
 = 0;

1494 
i
 = 0; i < 
tÙ®_nics
; i++) {

1495 
nic
 = 
	`h¬dw¬e_g‘_nic
(
i
);

1496 ià(
nic
 && (nic->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1497 
aùive_nics
++;

1500 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_LINK_UP
)) {

1501 
	`log_w¬nšg
("NIC %d†šk i down", 
i
);

1502 
h—Éh_scÜe
 += 5;

1506 ià(
nic
->
tx_·ck‘s
 > 0) {

1507 
ušt32_t
 
tx_”rÜ_¿‹
 = (
nic
->
tx_”rÜs
 * 100è/‚ic->
tx_·ck‘s
;

1508 ià(
tx_”rÜ_¿‹
 > 10) {

1509 
	`log_w¬nšg
("NIC %d high TXƒ¼Ü„©e: %lu%%", 
i
, 
tx_”rÜ_¿‹
);

1510 
h—Éh_scÜe
 += 10;

1511 } ià(
tx_”rÜ_¿‹
 > 5) {

1512 
h—Éh_scÜe
 += 5;

1516 ià(
nic
->
rx_·ck‘s
 > 0) {

1517 
ušt32_t
 
rx_”rÜ_¿‹
 = (
nic
->
rx_”rÜs
 * 100è/‚ic->
rx_·ck‘s
;

1518 ià(
rx_”rÜ_¿‹
 > 10) {

1519 
	`log_w¬nšg
("NIC %d high RXƒ¼Ü„©e: %lu%%", 
i
, 
rx_”rÜ_¿‹
);

1520 
h—Éh_scÜe
 += 10;

1521 } ià(
rx_”rÜ_¿‹
 > 5) {

1522 
h—Éh_scÜe
 += 5;

1528 ià(
aùive_nics
 == 0) {

1529 
	`log_”rÜ
("No‡ctive NICs‡vailable");

1534 
tÙ®_·ck‘s
 = 
·ck‘_¡©i¡ics
.
tx_·ck‘s
 +…ack‘_¡©i¡ics.
rx_·ck‘s
;

1535 
tÙ®_”rÜs
 = 
·ck‘_¡©i¡ics
.
tx_”rÜs
 +…ack‘_¡©i¡ics.
rx_”rÜs
;

1537 ià(
tÙ®_·ck‘s
 > 0) {

1538 
ušt32_t
 
glob®_”rÜ_¿‹
 = (
tÙ®_”rÜs
 * 100è/ 
tÙ®_·ck‘s
;

1539 ià(
glob®_”rÜ_¿‹
 > 15) {

1540 
	`log_w¬nšg
("High glob®ƒ¼Ü„©e: %lu%%", 
glob®_”rÜ_¿‹
);

1541 
h—Éh_scÜe
 += 15;

1542 } ià(
glob®_”rÜ_¿‹
 > 10) {

1543 
h—Éh_scÜe
 += 10;

1544 } ià(
glob®_”rÜ_¿‹
 > 5) {

1545 
h—Éh_scÜe
 += 5;

1550 ià(
·ck‘_¡©i¡ics
.
tx_bufãr_fuÎ
 > 0) {

1551 
	`log_w¬nšg
("TX bufã¸exhau¡iÚƒv’ts: %lu", 
·ck‘_¡©i¡ics
.
tx_bufãr_fuÎ
);

1552 
h—Éh_scÜe
 += 5;

1556 ià(
h—Éh_scÜe
 == 0) {

1557 
	`log_debug
("Packet driver health: EXCELLENT");

1558 } ià(
h—Éh_scÜe
 < 10) {

1559 
	`log_šfo
("Pack‘ driv” h—Éh: GOOD (scÜe: %d)", 
h—Éh_scÜe
);

1560 } ià(
h—Éh_scÜe
 < 25) {

1561 
	`log_w¬nšg
("Pack‘ driv” h—Éh: FAIR (scÜe: %d)", 
h—Éh_scÜe
);

1563 
	`log_w¬nšg
("Pack‘ driv” h—Éh: POOR (scÜe: %d)", 
h—Éh_scÜe
);

1566  
h—Éh_scÜe
;

1567 
	}
}

1572 
	$·ck‘_´št_d‘aed_¡©s
() {

1573 
tÙ®_nics
;

1574 
nic_šfo_t
 *
nic
;

1576 
	`log_šfo
("=== Packet Driver Statistics ===");

1577 
	`log_šfo
("Global Counters:");

1578 
	`log_šfo
(" TX: %lu…ackets, %lu bytes, %luƒrrors",

1579 
·ck‘_¡©i¡ics
.
tx_·ck‘s
,

1580 
·ck‘_¡©i¡ics
.
tx_by‹s
,

1581 
·ck‘_¡©i¡ics
.
tx_”rÜs
);

1582 
	`log_šfo
(" RX: %lu…ackets, %lu bytes, %luƒrrors, %lu dropped",

1583 
·ck‘_¡©i¡ics
.
rx_·ck‘s
,

1584 
·ck‘_¡©i¡ics
.
rx_by‹s
,

1585 
·ck‘_¡©i¡ics
.
rx_”rÜs
,

1586 
·ck‘_¡©i¡ics
.
rx_drİ³d
);

1587 
	`log_šfo
(" Rou‹d: %lu…ack‘s", 
·ck‘_¡©i¡ics
.
rou‹d_·ck‘s
);

1588 
	`log_šfo
(" Bufã¸ev’ts: %lu TX fuÎ", 
·ck‘_¡©i¡ics
.
tx_bufãr_fuÎ
);

1591 
tÙ®_nics
 = 
	`h¬dw¬e_g‘_nic_couÁ
();

1592 
i
 = 0; i < 
tÙ®_nics
; i++) {

1593 
nic
 = 
	`h¬dw¬e_g‘_nic
(
i
);

1594 ià(
nic
) {

1595 
	`log_šfo
("NIC %d (%s):", 
i
,

1596 (
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
) ? "ACTIVE" : "INACTIVE");

1597 
	`log_šfo
(" Status: Link=%s, Speed=%dMbps, Duplex=%s",

1598 (
nic
->
¡©us
 & 
NIC_STATUS_LINK_UP
) ? "UP" : "DOWN",

1599 (
nic
->
¡©us
 & 
NIC_STATUS_100MBPS
) ? 100 : 10,

1600 (
nic
->
¡©us
 & 
NIC_STATUS_FULL_DUPLEX
) ? "FULL" : "HALF");

1601 
	`log_šfo
(" TX: %lu…ackets, %lu bytes, %luƒrrors",

1602 
nic
->
tx_·ck‘s
,‚ic->
tx_by‹s
,‚ic->
tx_”rÜs
);

1603 
	`log_šfo
(" RX: %lu…ackets, %lu bytes, %luƒrrors",

1604 
nic
->
rx_·ck‘s
,‚ic->
rx_by‹s
,‚ic->
rx_”rÜs
);

1608 
	`log_šfo
("=== End Statistics ===");

1609 
	}
}

1615 
	$·ck‘_»£t_¡©i¡ics
() {

1616 
tÙ®_nics
;

1617 
nic_šfo_t
 *
nic
;

1619 
	`log_šfo
("Resetting…acket statistics");

1620 
	`mem£t
(&
·ck‘_¡©i¡ics
, 0, (packet_statistics));

1623 
tÙ®_nics
 = 
	`h¬dw¬e_g‘_nic_couÁ
();

1624 
i
 = 0; i < 
tÙ®_nics
; i++) {

1625 
nic
 = 
	`h¬dw¬e_g‘_nic
(
i
);

1626 ià(
nic
) {

1627 
nic
->
tx_·ck‘s
 = 0;

1628 
nic
->
rx_·ck‘s
 = 0;

1629 
nic
->
tx_by‹s
 = 0;

1630 
nic
->
rx_by‹s
 = 0;

1631 
nic
->
tx_”rÜs
 = 0;

1632 
nic
->
rx_”rÜs
 = 0;

1633 
nic
->
tx_drİ³d
 = 0;

1634 
nic
->
rx_drİ³d
 = 0;

1639 
	}
}"

1645 
	$·ck‘_İs_is_š™Ÿlized
() {

1646  
·ck‘_İs_š™Ÿlized
;

1647 
	}
}

1659 
	$·ck‘_£nd_dœeù_pio_3c509b
(
ušt8_t
 
š‹rçû_num
, cÚ¡ ušt8_ˆ*
de¡_addr
,

1660 
ušt16_t
 
‘h”ty³
, cÚ¡ * 
·ylßd
, ušt16_ˆ
·ylßd_Ën
) {

1661 
nic_šfo_t
 *
nic
;

1662 
»suÉ
;

1665 ià(!
de¡_addr
 || !
·ylßd
 || 
·ylßd_Ën
 =ğ0 ||…aylßd_ËÀ> 
ETH_MAX_DATA
) {

1666 
	`log_”rÜ
("Invalid…arameters for direct PIO send");

1667 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1668  
PACKET_ERR_INVALID_PARAM
;

1672 
nic
 = 
	`h¬dw¬e_g‘_nic
(
š‹rçû_num
);

1673 ià(!
nic
) {

1674 
	`log_”rÜ
("Inv®id iÁ”çû‚umb”: %d", 
š‹rçû_num
);

1675 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1676  
PACKET_ERR_INVALID_NIC
;

1680 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1681 
	`log_”rÜ
("NIC %d i nÙ‡ùive", 
š‹rçû_num
);

1682 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1683  
PACKET_ERR_INVALID_NIC
;

1687 ià(
nic
->
ty³
 !ğ
NIC_TYPE_3C509B
) {

1688 
	`log_debug
("Direct PIO optimization only‡vailable for 3c509B, NIC %d isype %d",

1689 
š‹rçû_num
, 
nic
->
ty³
);

1690 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1691  
PACKET_ERR_NOT_SUPPORTED
;

1695 
»suÉ
 = 
	`£nd_·ck‘_dœeù_pio_w™h_h—d”
(
nic
, 
de¡_addr
, 
‘h”ty³
, 
·ylßd
, 
·ylßd_Ën
);

1696 ià(
»suÉ
 !ğ
SUCCESS
) {

1697 
	`log_”rÜ
("Dœeù PIO¿nsmissiÚ faed oÀš‹rçû %d: %d", 
š‹rçû_num
, 
»suÉ
);

1698 
·ck‘_¡©i¡ics
.
tx_”rÜs
++;

1699  
»suÉ
;

1703 
·ck‘_¡©i¡ics
.
tx_·ck‘s
++;

1704 
·ck‘_¡©i¡ics
.
tx_by‹s
 +ğ
ETH_HEADER_LEN
 + 
·ylßd_Ën
;

1706 
	`log_debug
("Successfully sent…acket via direct PIO on interface %d: %d bytes",

1707 
š‹rçû_num
, 
ETH_HEADER_LEN
 + 
·ylßd_Ën
);

1709  
SUCCESS
;

1710 
	}
}

1727 
	$·ck‘_bud_‘h”Ãt_äame
(
ušt8_t
 *
äame_bufãr
, 
ušt16_t
 
äame_size
,

1728 cÚ¡ 
ušt8_t
 *
de¡_mac
, cÚ¡ ušt8_ˆ*
¤c_mac
,

1729 
ušt16_t
 
‘h”ty³
, cÚ¡ 
ušt8_t
 *
·ylßd
,

1730 
ušt16_t
 
·ylßd_Ën
) {

1731 
ušt16_t
 
äame_Ën
;

1733 ià(!
äame_bufãr
 || !
de¡_mac
 || !
¤c_mac
 || !
·ylßd
) {

1734  
PACKET_ERR_INVALID_PARAM
;

1738 
äame_Ën
 = 
ETH_HEADER_LEN
 + 
·ylßd_Ën
;

1739 ià(
äame_Ën
 > 
äame_size
) {

1740  
PACKET_ERR_INVALID_SIZE
;

1744 
	`memıy
(
äame_bufãr
, 
de¡_mac
, 
ETH_ALEN
);

1745 
	`memıy
(
äame_bufãr
 + 
ETH_ALEN
, 
¤c_mac
, ETH_ALEN);

1746 *(
ušt16_t
*)(
äame_bufãr
 + 2 * 
ETH_ALEN
èğ
	`htÚs
(
‘h”ty³
);

1749 
	`memıy
(
äame_bufãr
 + 
ETH_HEADER_LEN
, 
·ylßd
, 
·ylßd_Ën
);

1752 ià(
äame_Ën
 < 
ETH_MIN_FRAME
) {

1753 
	`mem£t
(
äame_bufãr
 + 
äame_Ën
, 0, 
ETH_MIN_FRAME
 - frame_len);

1754 
äame_Ën
 = 
ETH_MIN_FRAME
;

1757 
	`log_debug
("BuˆEth”Ãˆäame:†’=%d,y³=0x%04X", 
äame_Ën
, 
‘h”ty³
);

1758  
äame_Ën
;

1759 
	}
}

1772 
	$·ck‘_bud_‘h”Ãt_äame_İtimized
(
ušt8_t
 *
äame_bufãr
, 
ušt16_t
 
äame_size
,

1773 cÚ¡ 
ušt8_t
 *
de¡_mac
, cÚ¡ ušt8_ˆ*
¤c_mac
,

1774 
ušt16_t
 
‘h”ty³
, cÚ¡ 
ušt8_t
 *
·ylßd
,

1775 
ušt16_t
 
·ylßd_Ën
) {

1776 
ušt16_t
 
äame_Ën
;

1777 
ıu_šfo_t
 
g_ıu_šfo
;

1779 ià(!
äame_bufãr
 || !
de¡_mac
 || !
¤c_mac
 || !
·ylßd
) {

1780  
PACKET_ERR_INVALID_PARAM
;

1784 
äame_Ën
 = 
ETH_HEADER_LEN
 + 
·ylßd_Ën
;

1785 ià(
äame_Ën
 > 
äame_size
) {

1786  
PACKET_ERR_INVALID_SIZE
;

1790 
	`memÜy_cİy_İtimized
(
äame_bufãr
, 
de¡_mac
, 
ETH_ALEN
);

1791 
	`memÜy_cİy_İtimized
(
äame_bufãr
 + 
ETH_ALEN
, 
¤c_mac
, ETH_ALEN);

1792 *(
ušt16_t
*)(
äame_bufãr
 + 2 * 
ETH_ALEN
èğ
	`htÚs
(
‘h”ty³
);

1795 ià(
·ylßd_Ën
 <ğ64 && 
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80286
) {

1797 
	`·ck‘_cİy_sm®l_·ylßd
(
äame_bufãr
 + 
ETH_HEADER_LEN
, 
·ylßd
, 
·ylßd_Ën
);

1798 } ià(
·ylßd_Ën
 <ğ512 && 
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

1800 
	`memÜy_cİy_İtimized
(
äame_bufãr
 + 
ETH_HEADER_LEN
, 
·ylßd
, 
·ylßd_Ën
);

1803 
	`memÜy_cİy_İtimized
(
äame_bufãr
 + 
ETH_HEADER_LEN
, 
·ylßd
, 
·ylßd_Ën
);

1807 ià(
äame_Ën
 < 
ETH_MIN_FRAME
) {

1808 
ušt16_t
 
·d_Ën
 = 
ETH_MIN_FRAME
 - 
äame_Ën
;

1809 
	`memÜy_£t_İtimized
(
äame_bufãr
 + 
äame_Ën
, 0, 
·d_Ën
);

1810 
äame_Ën
 = 
ETH_MIN_FRAME
;

1813 
	`log_debug
("Built optimized Ethernet frame:†en=%d,ype=0x%04X, CPU=%s",

1814 
äame_Ën
, 
‘h”ty³
, 
	`ıu_ty³_to_¡ršg
(
g_ıu_šfo
.
ty³
));

1815  
äame_Ën
;

1816 
	}
}

1824 
	$·ck‘_cİy_sm®l_·ylßd
(
ušt8_t
 *
de¡
, cÚ¡ ušt8_ˆ*
¤c
, 
ušt16_t
 
Ën
) {

1825 
ıu_šfo_t
 
g_ıu_šfo
;

1827 ià(
Ën
 <ğ64 && 
g_ıu_šfo
.
ty³
 >ğ
CPU_TYPE_80386
) {

1830 ià(
Ën
 == 64) {

1833 
	`memÜy_cİy_İtimized
(
de¡
, 
¤c
, 
Ën
);

1836 
	`memÜy_cİy_İtimized
(
de¡
, 
¤c
, 
Ën
);

1840 
	`memÜy_cİy_İtimized
(
de¡
, 
¤c
, 
Ën
);

1842 
	}
}

1851 
	$·ck‘_·r£_‘h”Ãt_h—d”
(cÚ¡ 
ušt8_t
 *
äame_d©a
, 
ušt16_t
 
äame_Ën
,

1852 
‘h_h—d”_t
 *
h—d”
) {

1853 ià(!
äame_d©a
 || !
h—d”
 || 
äame_Ën
 < 
ETH_HEADER_LEN
) {

1854  
PACKET_ERR_INVALID_PARAM
;

1858 
	`memıy
(
h—d”
->
de¡_mac
, 
äame_d©a
, 
ETH_ALEN
);

1859 
	`memıy
(
h—d”
->
¤c_mac
, 
äame_d©a
 + 
ETH_ALEN
, ETH_ALEN);

1860 
h—d”
->
‘h”ty³
 = 
	`Áohs
(*(
ušt16_t
*)(
äame_d©a
 + 2 * 
ETH_ALEN
));

1862 
	`log_debug
("P¬£d Eth”Ãˆh—d”:y³=0x%04X", 
h—d”
->
‘h”ty³
);

1864 
	}
}

1872 
boŞ
 
	$·ck‘_is_fÜ_us
(cÚ¡ 
ušt8_t
 *
äame_d©a
, cÚ¡ ušt8_ˆ*
our_mac
) {

1873 ià(!
äame_d©a
 || !
our_mac
) {

1874  
çl£
;

1877  
	`memcmp
(
äame_d©a
, 
our_mac
, 
ETH_ALEN
) == 0;

1878 
	}
}

1885 
boŞ
 
	$·ck‘_is_brßdÿ¡
(cÚ¡ 
ušt8_t
 *
äame_d©a
) {

1886 cÚ¡ 
ušt8_t
 
brßdÿ¡_mac
[
ETH_ALEN
] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

1888 ià(!
äame_d©a
) {

1889  
çl£
;

1892  
	`memcmp
(
äame_d©a
, 
brßdÿ¡_mac
, 
ETH_ALEN
) == 0;

1893 
	}
}

1900 
boŞ
 
	$·ck‘_is_muÉiÿ¡
(cÚ¡ 
ušt8_t
 *
äame_d©a
) {

1901 ià(!
äame_d©a
) {

1902  
çl£
;

1906  (
äame_d©a
[0] & 0x01) != 0;

1907 
	}
}

1914 
ušt16_t
 
	$·ck‘_g‘_‘h”ty³
(cÚ¡ 
ušt8_t
 *
äame_d©a
) {

1915 ià(!
äame_d©a
) {

1919  
	`Áohs
(*(
ušt16_t
*)(
äame_d©a
 + 2 * 
ETH_ALEN
));

1920 
	}
}

1922  \
nšt
 
	$·ck‘_rou‹_muÉi_nic
(cÚ¡ 
ušt8_t
 *
·ck‘_d©a
, 
ušt16_t
 
Ëngth
, 
¤c_nic_šdex
è{\
n
 
‘h_h—d”_t
 
‘h_h—d”
;\À
tÙ®_nics
;\À
rg‘_nic
 = -1;\À\Àià(!·ck‘_d©¨||†’gth < 
ETH_HEADER_LEN
è{\À -1;\À}\À\À \Àià(
	`·ck‘_·r£_‘h”Ãt_h—d”
Õack‘_d©a,†’gth, &‘h_h—d”è< 0è{\À -1;\À}\À\À \ÀtÙ®_nic ğ
	`h¬dw¬e_g‘_nic_couÁ
();\ÀiàÑÙ®_nic <ğ1è{\À \À -1;\À}\À\À \Àià(
	`·ck‘_is_brßdÿ¡
Õack‘_d©a)è{\À
	`log_debug
(\"Broadcast…acket - would forwardo‡ll NICsƒxcept source %d\", src_nic_index);\n /* For‚ow, deliver†ocally. Full implementation would queueo‡ll other NICs */\n„eturn -1;\n }\n \n /* Check if destination is on‡ different segment */\n /* This is‡ simplified„outing -„eal implementation would use„outingable */\n for (int i = 0; i <otal_nics; i++) {\n‚ic_info_t *nic = hardware_get_nic(i);\n if (!nic || i == src_nic_index) {\n continue;\n }\n \n /* Check if destination MAC matcheshis NIC's subnet */\n /* For‚ow, use simpleƒven/odd MAC‡ddress„outing‡sƒxample */\n if ((eth_header.dest_mac[5] & 1) == (i & 1)) {\narget_nic = i;\n†og_debug(\"Routing…acketo NIC %d based on MAC‡ddress\",arget_nic);\n break;\n }\n }\n \n„eturnarget_nic;\n}\n\n/**\n * @brief Coordinate…acket sending‡cross multiple NICs with†oad balancing\n * @param…acket_data Packet data\n * @param†ength Packet†ength\n * @param dest_addr Destination MAC‡ddress\n * @param handle Sender handle\n * @return 0 on success,‚egative onƒrror\n */\nint…acket_send_multi_nic(const uint8_t *packet_data, uint16_t†ength,\n const uint8_t *dest_addr, uint16_t handle) {\n static int‚ext_nic_index = 0; /* Simple„ound-robin counter */\n intotal_nics;\n int selected_nic;\n int„esult;\n‚ic_info_t *nic;\n \n if (!packet_data || !dest_addr ||†ength == 0) {\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \notal_nics = hardware_get_nic_count();\n if (total_nics == 0) {\n†og_error(\"No NICs‡vailable forransmission\");\n„eturn PACKET_ERR_INVALID_NIC;\n }\n \n /* For broadcast…ackets, send on…rimary NIC */\n if (packet_is_broadcast(packet_data)) {\n selected_nic = 0;\n†og_debug(\"Broadcast…acket - using…rimary NIC 0\");\n }\n /* For unicast, use†oad balancing or„outingable */\nƒlse {\n /* Simple„ound-robin†oad balancing for‚ow */\n /* Real implementation would use„outingable†ookup */\n selected_nic =‚ext_nic_index %otal_nics;\n‚ext_nic_index = (next_nic_index + 1) %otal_nics;\n \n /* Skip inactive NICs */\n for (int‡ttempts = 0;‡ttempts <otal_nics;‡ttempts++) {\n‚ic = hardware_get_nic(selected_nic);\n if (nic && (nic->status & NIC_STATUS_ACTIVE)) {\n break;\n }\n selected_nic = (selected_nic + 1) %otal_nics;\n }\n \n†og_debug(\"Load balancing: selected NIC %d forransmission\", selected_nic);\n }\n \n /* Send usingheƒnhanced…acket send function */\n„esult =…acket_send_enhanced(selected_nic,…acket_data,†ength, dest_addr, handle);\n if (result < 0) {\n†og_error(\"Failedo send…acket via NIC %d: %d\", selected_nic,„esult);\n„eturn„esult;\n }\n \n„eturn 0;\n}\n\n/**\n * @brief Check‡nd handle NIC failover\n * @param failed_nic_index Index of failed NIC\n * @return 0 on successful failover,‚egative onƒrror\n */\nint…acket_handle_nic_failover(int failed_nic_index) {\n intotal_nics;\n int‡ctive_nics = 0;\n‚ic_info_t *nic;\n \n†og_warning(\"Handling failover for failed NIC %d\", failed_nic_index);\n \notal_nics = hardware_get_nic_count();\n \n /* Count‡ctive NICs */\n for (int i = 0; i <otal_nics; i++) {\n‚ic = hardware_get_nic(i);\n if (nic && (nic->status & NIC_STATUS_ACTIVE) && i != failed_nic_index) {\n‡ctive_nics++;\n }\n }\n \n if (active_nics == 0) {\n†og_error(\"No‡ctive NICs‡vailable‡fter failover\");\n„eturn PACKET_ERR_INVALID_NIC;\n }\n \n†og_info(\"Failover completed: %d‡ctive NICs„emaining\",‡ctive_nics);\n \n /* Update„outingo‡void failed NIC */\n /* Real implementation would update„outingable */\n \n„eturn 0;\n}\n\n/**\n * @brief Get optimal NIC for…acketransmission based on†oad‡nd†ink status\n * @param…acket_data Packet data for„outing decisions\n * @param†ength Packet†ength\n * @return NIC index, or‚egative onƒrror\n */\nint…acket_get_optimal_nic(const uint8_t *packet_data, uint16_t†ength) {\n intotal_nics;\n int best_nic = -1;\n uint32_t best_score = 0;\n‚ic_info_t *nic;\n \notal_nics = hardware_get_nic_count();\n \n for (int i = 0; i <otal_nics; i++) {\n‚ic = hardware_get_nic(i);\n if (!nic || !(nic->status & NIC_STATUS_ACTIVE)) {\n continue;\n }\n \n /* Calculate score based on multiple factors */\n uint32_t score = 100; /* Base score */\n \n /* Link quality factor */\n if (nic->status & NIC_STATUS_LINK_UP) {\n score += 50;\n }\n \n /* Speed factor */\n if (nic->status & NIC_STATUS_100MBPS) {\n score += 30;\n }\n \n /* Load factor (inverse ofƒrror„ate) */\n if (nic->tx_packets > 0) {\n uint32_tƒrror_rate = (nic->tx_errors * 100) /‚ic->tx_packets;\n score += (100 -ƒrror_rate);\n }\n \n /* Duplex factor */\n if (nic->status & NIC_STATUS_FULL_DUPLEX) {\n score += 20;\n }\n \n if (score > best_score) {\n best_score = score;\n best_nic = i;\n }\n }\n \n if (best_nic >= 0) {\n†og_debug(\"Selected optimal NIC %d (score=%lu)\", best_nic, best_score);\n }\n \n„eturn best_nic;\n}\n\n/**

1923 * @
br›f
 
Com´eh’sive
 
loİback
 
‹¡šg
 
su™e


1924 * 
This
 
im¶em’ts
 
š‹º®
, 
ex‹º®
, 
ªd
 
üoss
-
NIC
 
loİback
 
‹¡šg


1934 
	`·ck‘_‹¡_š‹º®_loİback
(
nic_šdex
, cÚ¡ 
ušt8_t
 *
‹¡_·‰”n
, 
ušt16_t
 
·‰”n_size
) {

1935 
nic_šfo_t
 *
nic
;

1936 
ušt8_t
 
‹¡_äame
[
ETH_MAX_FRAME
];

1937 
ušt8_t
 
rx_bufãr
[
ETH_MAX_FRAME
];

1938 
ušt16_t
 
äame_Ëngth
;

1939 
size_t
 
rx_Ëngth
;

1940 
»suÉ
;

1941 
ušt32_t
 
timeout_ms
 = 1000;

1942 
ušt32_t
 
¡¬t_time
;

1944 ià(!
‹¡_·‰”n
 || 
·‰”n_size
 =ğ0 ||…©‹º_siz> 
ETH_MAX_DATA
) {

1945 
	`log_”rÜ
("Invalid†oopbackest…arameters");

1946  
PACKET_ERR_INVALID_PARAM
;

1949 
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_šdex
);

1950 ià(!
nic
) {

1951 
	`log_”rÜ
("Inv®id NIC index fÜ†oİbacke¡: %d", 
nic_šdex
);

1952  
PACKET_ERR_INVALID_NIC
;

1955 ià(!(
nic
->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1956 
	`log_”rÜ
("NIC %d‚Ù‡ùivfÜ†oİbacke¡", 
nic_šdex
);

1957  
PACKET_ERR_INVALID_NIC
;

1960 
	`log_šfo
("S¹šg iÁ”ÇÈloİbacke¡ oÀNIC %d", 
nic_šdex
);

1963 
ušt8_t
 
brßdÿ¡_mac
[
ETH_ALEN
] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};\
n
 
äame_Ëngth
 = 
	`·ck‘_bud_‘h”Ãt_äame
(
‹¡_äame
, Ñe¡_äame),\Àbrßdÿ¡_mac, 
nic
->
mac
,\À0x0800, \À
‹¡_·‰”n
, 
·‰”n_size
);\À\Àià(äame_Ëngth < 0è{\À
	`log_”rÜ
(\"Failedo build†oopbackest frame\");\n„eturn frame_length;\n }\n \n /* Enable internal†oopback mode */\n„esult =…acket_enable_loopback_mode(nic, LOOPBACK_INTERNAL);\n if (result != 0) {\n†og_error(\"Failedoƒnable internal†oopback mode: %d\",„esult);\n„eturn„esult;\n }\n \n /* Clear‡ny…ending RX…ackets */\n„x_length = sizeof(rx_buffer);\n while (packet_receive_from_nic(nic_index,„x_buffer, &rx_length) == 0) {\n„x_length = sizeof(rx_buffer);\n }\n \n /* Sendest frame */\n„esult =…acket_send_enhanced(nic_index,est_pattern,…attern_size, broadcast_mac, 0x1234);\n if (result != 0) {\n†og_error(\"Failedo send†oopbackest frame: %d\",„esult);\n…acket_disable_loopback_mode(nic);\n„eturn„esult;\n }\n \n†og_debug(\"Loopbackest frame sent, waiting for„eception...\");\n \n /* Wait for†oopback„eception */\n start_time = stats_get_timestamp();\n„x_length = sizeof(rx_buffer);\n \n while ((stats_get_timestamp() - start_time) <imeout_ms) {\n„esult =…acket_receive_from_nic(nic_index,„x_buffer, &rx_length);\n \n if (result == 0) {\n /* Verify„eceived frame */\n if (rx_length >= ETH_HEADER_LEN +…attern_size) {\n /* Extract…ayload from„eceived frame */\n uint8_t *rx_payload =„x_buffer + ETH_HEADER_LEN;\n \n if (memcmp(rx_payload,est_pattern,…attern_size) == 0) {\n†og_info(\"Internal†oopbackest PASSED on NIC %d\",‚ic_index);\n…acket_disable_loopback_mode(nic);\n„eturn 0;\n }ƒlse {\n†og_error(\"Loopback data mismatch on NIC %d\",‚ic_index);\n…acket_disable_loopback_mode(nic);\n„eturn PACKET_ERR_INVALID_DATA;\n }\n }\n }\n \n /* Brief delay before„etry */\n for (volatile int i = 0; i < 1000; i++);\n„x_length = sizeof(rx_buffer);\n }\n \n†og_error(\"Internal†oopbackest TIMEOUT on NIC %d\",‚ic_index);\n…acket_disable_loopback_mode(nic);\n„eturn PACKET_ERR_TIMEOUT;\n}\n\n/**\n * @brief Testƒxternal†oopback with…hysical connector\n * @param‚ic_index NICoest\n * @paramest_patterns Array ofest…atterns\n * @param‚um_patterns Number ofest…atterns\n * @return 0 on success,‚egative onƒrror\n */\nint…acket_test_external_loopback(int‚ic_index, const†oopback_test_pattern_t *test_patterns, int‚um_patterns) {\n‚ic_info_t *nic;\n int…assed_tests = 0;\n int failed_tests = 0;\n \n if (!test_patterns ||‚um_patterns <= 0) {\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \n‚ic = hardware_get_nic(nic_index);\n if (!nic) {\n„eturn PACKET_ERR_INVALID_NIC;\n }\n \n†og_info(\"Startingƒxternal†oopbackest on NIC %d (%d…atterns)\",‚ic_index,‚um_patterns);\n \n /* Disable internal†oopback,ƒnableƒxternal */\n int„esult =…acket_enable_loopback_mode(nic, LOOPBACK_EXTERNAL);\n if (result != 0) {\n†og_error(\"Failedoƒnableƒxternal†oopback mode: %d\",„esult);\n„eturn„esult;\n }\n \n /* Testƒach…attern */\n for (int i = 0; i <‚um_patterns; i++) {\n†og_debug(\"Testingƒxternal†oopback…attern %d: %s\", i,est_patterns[i].name);\n \n„esult =…acket_test_single_loopback_pattern(nic_index, &test_patterns[i]);\n if (result == 0) {\n…assed_tests++;\n†og_debug(\"Pattern %d PASSED\", i);\n }ƒlse {\n failed_tests++;\n†og_warning(\"Pattern %d FAILED: %d\", i,„esult);\n }\n }\n \n…acket_disable_loopback_mode(nic);\n \n†og_info(\"External†oopbackest completed: %d…assed, %d failed\",…assed_tests, failed_tests);\n \n„eturn (failed_tests == 0) ? 0 : PACKET_ERR_LOOPBACK_FAILED;\n}\n\n/**\n * @brief Test cross-NIC†oopback for multi-NIC validation\n * @param src_nic_index Source NIC\n * @param dest_nic_index Destination NIC \n * @paramest_data Test datao send\n * @param data_size Size ofest data\n * @return 0 on success,‚egative onƒrror\n */\nint…acket_test_cross_nic_loopback(int src_nic_index, int dest_nic_index, \n const uint8_t *test_data, uint16_t data_size) {\n‚ic_info_t *src_nic, *dest_nic;\n uint8_test_frame[ETH_MAX_FRAME];\n uint8_t„x_buffer[ETH_MAX_FRAME];\n uint16_t frame_length;\n size_t„x_length;\n int„esult;\n uint32_timeout_ms = 2000; /* Longerimeout for cross-NIC */\n uint32_t start_time;\n \n if (!test_data || data_size == 0 || src_nic_index == dest_nic_index) {\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \n src_nic = hardware_get_nic(src_nic_index);\n dest_nic = hardware_get_nic(dest_nic_index);\n \n if (!src_nic || !dest_nic) {\n†og_error(\"Invalid NIC indices for cross-NICest: src=%d, dest=%d\", \n src_nic_index, dest_nic_index);\n„eturn PACKET_ERR_INVALID_NIC;\n }\n \n if (!(src_nic->status & NIC_STATUS_ACTIVE) || !(dest_nic->status & NIC_STATUS_ACTIVE)) {\n†og_error(\"NICs‚ot‡ctive for cross-NICest\");\n„eturn PACKET_ERR_INVALID_NIC;\n }\n \n†og_info(\"Starting cross-NIC†oopbackest: NIC %d -> NIC %d\", src_nic_index, dest_nic_index);\n \n /* Buildest frame‡ddressedo destination NIC */\n frame_length =…acket_build_ethernet_frame(test_frame, sizeof(test_frame),\n dest_nic->mac, src_nic->mac,\n 0x0800, /* IPƒthertype */\nest_data, data_size);\n \n if (frame_length < 0) {\n†og_error(\"Failedo build cross-NICest frame\");\n„eturn frame_length;\n }\n \n /* Enable…romiscuous mode on destination NICo„eceive‡ll…ackets */\n„esult = hardware_set_promiscuous_mode(dest_nic,rue);\n if (result != 0) {\n†og_warning(\"Failedoƒnable…romiscuous mode on dest NIC %d\", dest_nic_index);\n }\n \n /* Clear‡ny…ending…ackets on destination NIC */\n„x_length = sizeof(rx_buffer);\n while (packet_receive_from_nic(dest_nic_index,„x_buffer, &rx_length) == 0) {\n„x_length = sizeof(rx_buffer);\n }\n \n /* Send…acket from source NIC */\n„esult =…acket_send_enhanced(src_nic_index,est_data, data_size, dest_nic->mac, 0x5678);\n if (result != 0) {\n†og_error(\"Failedo send cross-NICest…acket: %d\",„esult);\n hardware_set_promiscuous_mode(dest_nic, false);\n„eturn„esult;\n }\n \n†og_debug(\"Cross-NIC…acket sent, waiting for„eception on NIC %d...\", dest_nic_index);\n \n /* Wait for…acket on destination NIC */\n start_time = stats_get_timestamp();\n„x_length = sizeof(rx_buffer);\n \n while ((stats_get_timestamp() - start_time) <imeout_ms) {\n„esult =…acket_receive_from_nic(dest_nic_index,„x_buffer, &rx_length);\n \n if (result == 0) {\n /* Verify„eceived frame */\nƒth_header_tƒth_header;\n„esult =…acket_parse_ethernet_header(rx_buffer,„x_length, &eth_header);\n \n if (result == 0) {\n /* Check ifhis is ourest…acket */\n if (memcmp(eth_header.dest_mac, dest_nic->mac, ETH_ALEN) == 0 &&\n memcmp(eth_header.src_mac, src_nic->mac, ETH_ALEN) == 0) {\n \n /* Verify…ayload */\n uint8_t *rx_payload =„x_buffer + ETH_HEADER_LEN;\n uint16_t…ayload_length =„x_length - ETH_HEADER_LEN;\n \n if (payload_length >= data_size && \n memcmp(rx_payload,est_data, data_size) == 0) {\n†og_info(\"Cross-NIC†oopbackest PASSED: NIC %d -> NIC %d\", \n src_nic_index, dest_nic_index);\n hardware_set_promiscuous_mode(dest_nic, false);\n„eturn 0;\n }ƒlse {\n†og_error(\"Cross-NIC…ayload mismatch\");\n hardware_set_promiscuous_mode(dest_nic, false);\n„eturn PACKET_ERR_INVALID_DATA;\n }\n }\n }\n }\n \n /* Brief delay before„etry */\n for (volatile int i = 0; i < 1000; i++);\n„x_length = sizeof(rx_buffer);\n }\n \n†og_error(\"Cross-NIC†oopbackest TIMEOUT: NIC %d -> NIC %d\", src_nic_index, dest_nic_index);\n hardware_set_promiscuous_mode(dest_nic, false);\n„eturn PACKET_ERR_TIMEOUT;\n}\n\n/**\n * @brief Comprehensive…acket integrity verification during†oopback\n * @param original_data Original…acket data\n * @param„eceived_data Received…acket data\n * @param data_length Length of datao compare\n * @param integrity_result Pointero store detailed integrity„esult\n * @return 0 if integrity check…assed,‚egative onƒrror\n */\nint…acket_verify_loopback_integrity(const uint8_t *original_data, const uint8_t *received_data,\n uint16_t data_length,…acket_integrity_result_t *integrity_result) {\n if (!original_data || !received_data || !integrity_result || data_length == 0) {\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \n memset(integrity_result, 0, sizeof(packet_integrity_result_t));\n integrity_result->bytes_compared = data_length;\n \n /* Byte-by-byte comparison */\n for (uint16_t i = 0; i < data_length; i++) {\n if (original_data[i] !=„eceived_data[i]) {\n integrity_result->mismatch_count++;\n \n /* Store first few mismatches for debugging */\n if (integrity_result->mismatch_count <= MAX_MISMATCH_DETAILS) {\n…acket_mismatch_detail_t *detail = \n &integrity_result->mismatch_details[integrity_result->mismatch_count - 1];\n detail->offset = i;\n detail->expected = original_data[i];\n detail->actual =„eceived_data[i];\n }\n }\n }\n \n /* Calculateƒrror statistics */\n if (integrity_result->mismatch_count > 0) {\n integrity_result->error_rate_percent = \n (integrity_result->mismatch_count * 100) / data_length;\n \n /* Analyzeƒrror…atterns */\n…acket_analyze_error_patterns(integrity_result);\n \n†og_error(\"Packet integrity check FAILED: %d mismatches out of %d bytes (%.2f%%)\",\n integrity_result->mismatch_count, data_length, \n (float)integrity_result->error_rate_percent);\n \n„eturn PACKET_ERR_INTEGRITY_FAILED;\n }\n \n†og_debug(\"Packet integrity check PASSED: %d bytes verified\", data_length);\n„eturn 0;\n}\n\n/**\n * @brief Enable†oopback mode on‡ NIC\n * @param‚ic NICo configure\n * @param†oopback_type Type of†oopbackoƒnable\n * @return 0 on success,‚egative onƒrror\n */\nstatic int…acket_enable_loopback_mode(nic_info_t *nic,†oopback_type_t†oopback_type) {\n if (!nic) {\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \n†og_debug(\"Enabling†oopback mode %d on NIC %d\",†oopback_type,‚ic->index);\n \n if (nic->type == NIC_TYPE_3C509B) {\n„eturn…acket_enable_3c509b_loopback(nic,†oopback_type);\n }ƒlse if (nic->type == NIC_TYPE_3C515_TX) {\n„eturn…acket_enable_3c515_loopback(nic,†oopback_type);\n }\n \n„eturn PACKET_ERR_NOT_SUPPORTED;\n}\n\n/**\n * @brief Disable†oopback mode on‡ NIC\n * @param‚ic NICo configure\n * @return 0 on success,‚egative onƒrror\n */\nstatic int…acket_disable_loopback_mode(nic_info_t *nic) {\n if (!nic) {\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \n†og_debug(\"Disabling†oopback mode on NIC %d\",‚ic->index);\n \n if (nic->type == NIC_TYPE_3C509B) {\n„eturn…acket_disable_3c509b_loopback(nic);\n }ƒlse if (nic->type == NIC_TYPE_3C515_TX) {\n„eturn…acket_disable_3c515_loopback(nic);\n }\n \n„eturn PACKET_ERR_NOT_SUPPORTED;\n}\n\n/**\n * @brief Enable 3C509B†oopback mode\n * @param‚ic NICo configure\n * @param†oopback_type Type of†oopback\n * @return 0 on success,‚egative onƒrror\n */\nstatic int…acket_enable_3c509b_loopback(nic_info_t *nic,†oopback_type_t†oopback_type) {\n uint16_t„x_filter = 0x01; /* Individual‡ddress */\n \n _3C509B_SELECT_WINDOW(nic->io_base, _3C509B_WINDOW_0);\n \n switch (loopback_type) {\n case LOOPBACK_INTERNAL:\n /* Set internal†oopback in RX filter */\n„x_filter |= 0x08; /* Loopback mode */\n break;\n \n case LOOPBACK_EXTERNAL:\n /* External†oopback„equires…hysical connector */\n /* No special„egister settings‚eeded */\n break;\n \n default:\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \n /* Apply RX filter settings */\n outw(nic->io_base + _3C509B_COMMAND_REG, _3C509B_CMD_SET_RX_FILTER |„x_filter);\n \n /* Enable TX‡nd RX */\n outw(nic->io_base + _3C509B_COMMAND_REG, _3C509B_CMD_TX_ENABLE);\n outw(nic->io_base + _3C509B_COMMAND_REG, _3C509B_CMD_RX_ENABLE);\n \n„eturn 0;\n}\n\n/**\n * @brief Enable 3C515-TX†oopback mode\n * @param‚ic NICo configure\n * @param†oopback_type Type of†oopback\n * @return 0 on success,‚egative onƒrror\n */\nstatic int…acket_enable_3c515_loopback(nic_info_t *nic,†oopback_type_t†oopback_type) {\n _3C515_TX_SELECT_WINDOW(nic->io_base, _3C515_TX_WINDOW_4);\n \n uint16_t media_options = inw(nic->io_base + _3C515_TX_MEDIA_OPTIONS_REG);\n \n switch (loopback_type) {\n case LOOPBACK_INTERNAL:\n /* Enable internal†oopback */\n media_options |= 0x0008; /* Internal†oopback bit */\n break;\n \n case LOOPBACK_EXTERNAL:\n /* Disable internal†oopback forƒxternalesting */\n media_options &= ~0x0008;\n break;\n \n default:\n„eturn PACKET_ERR_INVALID_PARAM;\n }\n \n outw(nic->io_base + _3C515_TX_MEDIA_OPTIONS_REG, media_options);\n \n /* Enable TX‡nd RX */\n _3C515_TX_SELECT_WINDOW(nic->io_base, _3C515_TX_WINDOW_1);\n outw(nic->io_base + _3C515_TX_COMMAND_REG, _3C515_TX_CMD_TX_ENABLE);\n outw(nic->io_base + _3C515_TX_COMMAND_REG, _3C515_TX_CMD_RX_ENABLE);\n \n„eturn 0;\n}\n\n/**\n * @brief Disable 3C509B†oopback mode\n * @param‚ic NICo configure\n * @return 0 on success,‚egative onƒrror\n */\nstatic int…acket_disable_3c509b_loopback(nic_info_t *nic) {\n _3C509B_SELECT_WINDOW(nic->io_base, _3C509B_WINDOW_0);\n \n /* Reseto‚ormal RX filter (individual + broadcast) */\n uint16_t„x_filter = 0x01 | 0x02; /* Individual + broadcast */\n outw(nic->io_base + _3C509B_COMMAND_REG, _3C509B_CMD_SET_RX_FILTER |„x_filter);\n \n„eturn 0;\n}\n\n/**\n * @brief Disable 3C515-TX†oopback mode\n * @param‚ic NICo configure\n * @return 0 on success,‚egative onƒrror\n */\nstatic int…acket_disable_3c515_loopback(nic_info_t *nic) {\n _3C515_TX_SELECT_WINDOW(nic->io_base, _3C515_TX_WINDOW_4);\n \n /* Disable internal†oopback */\n uint16_t media_options = inw(nic->io_base + _3C515_TX_MEDIA_OPTIONS_REG);\n media_options &= ~0x0008; /* Clear internal†oopback bit */\n outw(nic->io_base + _3C515_TX_MEDIA_OPTIONS_REG, media_options);\n \n„eturn 0;\n}\n\n/**\n * @brief Test‡ single†oopback…attern\n * @param‚ic_index NICoest\n * @param…attern Test…atterno use\n * @return 0 on success,‚egative onƒrror\n */\nstatic int…acket_test_single_loopback_pattern(int‚ic_index, const†oopback_test_pattern_t *pattern) {\n uint8_t„x_buffer[ETH_MAX_FRAME];\n size_t„x_length;\n…acket_integrity_result_t integrity_result;\n int„esult;\n uint32_timeout_ms =…attern->timeout_ms ?…attern->timeout_ms : 1000;\n uint32_t start_time;\n \n /* Sendest…attern */\n„esult =…acket_test_internal_loopback(nic_index,…attern->data,…attern->size);\n if (result != 0) {\n„eturn„esult;\n }\n \n„eturn 0; /* Success if internal†oopback…assed */\n}\n\n/**\n * @brief Analyzeƒrror…atterns in„eceived data\n * @param integrity_result Integrity„esulto‡nalyze\n */\nstatic void…acket_analyze_error_patterns(packet_integrity_result_t *integrity_result) {\n if (!integrity_result || integrity_result->mismatch_count == 0) {\n„eturn;\n }\n \n /* Look for commonƒrror…atterns */\n int bit_errors = 0;\n int byte_shifts = 0;\n int burst_errors = 0;\n \n for (int i = 0; i < integrity_result->mismatch_count && i < MAX_MISMATCH_DETAILS; i++) {\n…acket_mismatch_detail_t *detail = &integrity_result->mismatch_details[i];\n uint8_t xor_result = detail->expected ^ detail->actual;\n \n /* Count bitƒrrors */\n int bits_different = 0;\n for (int bit = 0; bit < 8; bit++) {\n if (xor_result & (1 << bit)) {\n bits_different++;\n }\n }\n \n if (bits_different == 1) {\n bit_errors++;\n }\n \n /* Check for byte shift…atterns */\n if (i > 0) {\n…acket_mismatch_detail_t *prev = &integrity_result->mismatch_details[i - 1];\n if (detail->offset ==…rev->offset + 1) {\n burst_errors++;\n }\n }\n }\n \n /* Store…attern‡nalysis„esults */\n integrity_result->single_bit_errors = bit_errors;\n integrity_result->burst_errors = burst_errors;\n \n /* Determine†ikelyƒrror cause */\n if (bit_errors > burst_errors) {\n strcpy(integrity_result->error_pattern_description, \"Single-bitƒrrors (electrical‚oise)\");\n }ƒlse if (burst_errors > 0) {\n strcpy(integrity_result->error_pattern_description, \"Burstƒrrors (synchronization issue)\");\n }ƒlse {\n strcpy(integrity_result->error_pattern_description, \"Random data corruption\");\n }\n}\n\n/**\n * @brief Route…acketo‡nother interface\n * @param…acket Packet data\n * @param†ength Packet†ength\n * @param dest_nic Destination NIC index\n * @return 0 on success,‚egative onƒrror\n */\nstatic int„oute_packet_to_interface(const uint8_t *packet, uint16_t†ength, uint8_t dest_nic) {

1964 
nic_šfo_t
 *
nic
;

1965 
_addr_t
 
de¡_
;

1966 
ušt8_t
 
de¡_mac
[
ETH_ALEN
];

1967 
ušt8_t
 
nic_šdex
;

1968 
»suÉ
;

1970 ià(!
·ck‘
 || 
Ëngth
 == 0) {

1971  
ERROR_INVALID_PARAM
;

1975 
nic
 = 
	`h¬dw¬e_g‘_nic
(
de¡_nic
);

1976 ià(!
nic
 || !Òic->
¡©us
 & 
NIC_STATUS_ACTIVE
)) {

1977 
	`log_”rÜ
("De¡š©iÚ NIC %d‚Ù‡ùive", 
de¡_nic
);

1978  
ERROR_INVALID_PARAM
;

1982 ià(
	`·ck‘_g‘_‘h”ty³
(
·ck‘
è=ğ
ETH_P_IP
) {

1984 cÚ¡ 
ušt8_t
 *
_h—d”
 = 
·ck‘
 + 
ETH_HEADER_LEN
;

1985 
	`memÜy_cİy
(
de¡_
.
addr
, 
_h—d”
 + 16, 4);

1988 ià(
	`¬p_is_’abËd
()) {

1989 
»suÉ
 = 
	`¬p_»sŞve
(&
de¡_
, 
de¡_mac
, &
nic_šdex
);

1990 ià(
»suÉ
 =ğ
SUCCESS
) {

1992 
ušt8_t
 *
mubË_·ck‘
 = (ušt8_t*)
·ck‘
;

1993 
	`memÜy_cİy
(
mubË_·ck‘
, 
de¡_mac
, 
ETH_ALEN
);

1996 
	`memÜy_cİy
(
mubË_·ck‘
 + 
ETH_ALEN
, 
nic
->
mac
, ETH_ALEN);

1997 } ià(
»suÉ
 =ğ
ERROR_BUSY
) {

1999 
	`log_debug
("ARP„esolution…ending for„outing, dropping…acket");

2000  
ERROR_BUSY
;

2003 
	`log_w¬nšg
("ARP„esolution failed for„outing, dropping…acket");

2004  
ERROR_NOT_FOUND
;

2010 
»suÉ
 = 
	`h¬dw¬e_£nd_·ck‘
(
nic
, 
·ck‘
, 
Ëngth
);

2011 ià(
»suÉ
 < 0) {

2012 
	`log_”rÜ
("FaedØ£nd„ou‹d…ack‘ oÀNIC %d: %d", 
de¡_nic
, 
»suÉ
);

2013  
»suÉ
;

2016 
	`log_debug
("SucûssfuÎy„ou‹d…ack‘ØNIC %d", 
de¡_nic
);

2017  
SUCCESS
;

2020 
	`·ck‘_İs_ş—nup
() {

2021 ià(!
·ck‘_İs_š™Ÿlized
) {

2025 
	`log_šfo
("Cleaning up…acket operations subsystem");

2028 
	`·ck‘_queue_ş—nup_®l
();

2031 
	`log_šfo
("Final…acket statistics:");

2032 
	`log_šfo
(" TX: %lu…ackets, %lu bytes, %luƒrrors",

2033 
·ck‘_¡©i¡ics
.
tx_·ck‘s
,

2034 
·ck‘_¡©i¡ics
.
tx_by‹s
,

2035 
·ck‘_¡©i¡ics
.
tx_”rÜs
);

2036 
	`log_šfo
(" RX: %lu…ackets, %lu bytes, %luƒrrors, %lu dropped",

2037 
·ck‘_¡©i¡ics
.
rx_·ck‘s
,

2038 
·ck‘_¡©i¡ics
.
rx_by‹s
,

2039 
·ck‘_¡©i¡ics
.
rx_”rÜs
,

2040 
·ck‘_¡©i¡ics
.
rx_drİ³d
);

2043 
	`log_šfo
("Queue Statistics:");

2044 
	`log_šfo
(" QueufuÎƒv’ts: %lu", 
g_queue_¡©e
.
queue_fuÎ_ev’ts
);

2045 
	`log_šfo
(" Back´essu»ƒv’ts: %lu", 
g_queue_¡©e
.
back´essu»_ev’ts
);

2046 
	`log_šfo
(" PriÜ™y drİs: %lu", 
g_queue_¡©e
.
´iÜ™y_drİs
);

2047 
	`log_šfo
(" Ad­tiv»sizes: %lu", 
g_queue_¡©e
.
ad­tive_»sizes
);

2049 
·ck‘_İs_š™Ÿlized
 = 0;

2051 
	`log_šfo
("Packet operations cleanup completed");

2059 
	`·ck‘_queue_š™_®l
() {

2060 
»suÉ
;

2062 
	`log_šfo
("Initializing…roduction…acket queues");

2065 
»suÉ
 = 
	`·ck‘_queue_š™
(&
g_queue_¡©e
.
tx_queues
[
PACKET_PRIORITY_URGENT
],

2066 
TX_QUEUE_URGENT_SIZE
, TX_QUEUE_URGENT_SIZE * 1514);

2067 ià(
»suÉ
 != 0) {

2068 
	`log_”rÜ
("Failedo initialize urgent TX queue");

2069  
»suÉ
;

2072 
»suÉ
 = 
	`·ck‘_queue_š™
(&
g_queue_¡©e
.
tx_queues
[
PACKET_PRIORITY_HIGH
],

2073 
TX_QUEUE_HIGH_SIZE
, TX_QUEUE_HIGH_SIZE * 1514);

2074 ià(
»suÉ
 != 0) {

2075 
	`log_”rÜ
("Failedo initialize high…riority TX queue");

2076  
»suÉ
;

2079 
»suÉ
 = 
	`·ck‘_queue_š™
(&
g_queue_¡©e
.
tx_queues
[
PACKET_PRIORITY_NORMAL
],

2080 
TX_QUEUE_NORMAL_SIZE
, TX_QUEUE_NORMAL_SIZE * 1514);

2081 ià(
»suÉ
 != 0) {

2082 
	`log_”rÜ
("Failedo initialize‚ormal…riority TX queue");

2083  
»suÉ
;

2086 
»suÉ
 = 
	`·ck‘_queue_š™
(&
g_queue_¡©e
.
tx_queues
[
PACKET_PRIORITY_LOW
],

2087 
TX_QUEUE_LOW_SIZE
, TX_QUEUE_LOW_SIZE * 1514);

2088 ià(
»suÉ
 != 0) {

2089 
	`log_”rÜ
("Failedo initialize†ow…riority TX queue");

2090  
»suÉ
;

2094 
»suÉ
 = 
	`·ck‘_queue_š™
(&
g_queue_¡©e
.
rx_queue
,

2095 
RX_QUEUE_SIZE
, RX_QUEUE_SIZE * 1514);

2096 ià(
»suÉ
 != 0) {

2097 
	`log_”rÜ
("Failedo initialize RX queue");

2098  
»suÉ
;

2101 
	`log_šfo
("Production…acket queues initialized successfully");

2108 
	`·ck‘_queue_ş—nup_®l
() {

2109 
	`log_šfo
("Cleaning up…roduction…acket queues");

2112 
	`·ck‘_em”g’cy_queue_d¿š
();

2115 
i
 = 0; i < 4; i++) {

2116 
	`·ck‘_queue_ş—nup
(&
g_queue_¡©e
.
tx_queues
[
i
]);

2120 
	`·ck‘_queue_ş—nup
(&
g_queue_¡©e
.
rx_queue
);

2122 
	`log_šfo
("Production…acket queues cleaned up");

2131 
	`·ck‘_’queue_w™h_´iÜ™y
(
·ck‘_bufãr_t
 *
bufãr
, 
´iÜ™y
) {

2132 
·ck‘_queue_t
 *
queue
;

2133 
»suÉ
;

2134 
ušt32_t
 
queue_u§ge
;

2136 ià(!
bufãr
 || 
´iÜ™y
 < 0 ||…riority > 3) {

2137  
PACKET_ERR_INVALID_PARAM
;

2140 
queue
 = &
g_queue_¡©e
.
tx_queues
[
´iÜ™y
];

2141 
queue_u§ge
 = 
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(
queue
);

2144 ià(
	`·ck‘_queue_is_fuÎ
(
queue
)) {

2145 
	`log_debug
("Queu%d fuÎ, checkšg drİ…Şicy", 
´iÜ™y
);

2147 ià(
	`·ck‘_should_drİ_Ú_fuÎ
(
´iÜ™y
, 
queue_u§ge
)) {

2149 
	`·ck‘_hªdË_queue_ov”æow
(
´iÜ™y
);

2152 ià(
	`·ck‘_queue_is_fuÎ
(
queue
)) {

2153 
g_queue_¡©e
.
queue_fuÎ_ev’ts
++;

2154 
g_queue_¡©e
.
´iÜ™y_drİs
++;

2155 
	`log_w¬nšg
("Drİpšg…ack‘ dutØqueu%d ov”æow", 
´iÜ™y
);

2156  
PACKET_ERR_NO_BUFFERS
;

2159 
g_queue_¡©e
.
queue_fuÎ_ev’ts
++;

2160  
PACKET_ERR_NO_BUFFERS
;

2165 ià(
queue_u§ge
 > 
FLOW_CONTROL_THRESHOLD
) {

2166 ià(!
g_queue_¡©e
.
æow_cÚŒŞ_aùive
) {

2167 
	`log_šfo
("Aùiv©šg flow cÚŒŞ - queuu§g%d%%", 
queue_u§ge
);

2168 
g_queue_¡©e
.
æow_cÚŒŞ_aùive
 = 
Œue
;

2169 
g_queue_¡©e
.
back´essu»_ev’ts
++;

2171 
	`·ck‘_­¶y_æow_cÚŒŞ
();

2175 
__asm__
 
	`__vŞ©e__
("cli");

2176 
»suÉ
 = 
	`·ck‘_queue_’queue
(
queue
, 
bufãr
);

2177 
__asm__
 
	`__vŞ©e__
("sti");

2178 ià(
»suÉ
 != 0) {

2179 
	`log_”rÜ
("FaedØ’queu·ck‘Ø´iÜ™y queu%d", 
´iÜ™y
);

2180  
»suÉ
;

2183 
	`log_Œaû
("Enqueued…ack‘Ø´iÜ™y %d queu(u§ge: %d%%)", 
´iÜ™y
, 
queue_u§ge
);

2191 
·ck‘_bufãr_t
* 
	`·ck‘_dequeue_by_´iÜ™y
() {

2192 
·ck‘_bufãr_t
 *
bufãr
 = 
NULL
;

2195 
´iÜ™y
 = 
PACKET_PRIORITY_URGENT
;…riÜ™y >ğ
PACKET_PRIORITY_LOW
;…riority--) {

2196 ià(!
	`·ck‘_queue_is_em±y
(&
g_queue_¡©e
.
tx_queues
[
´iÜ™y
])) {

2198 
__asm__
 
	`__vŞ©e__
("cli");

2199 
bufãr
 = 
	`·ck‘_queue_dequeue
(&
g_queue_¡©e
.
tx_queues
[
´iÜ™y
]);

2200 
__asm__
 
	`__vŞ©e__
("sti");

2201 ià(
bufãr
) {

2202 
	`log_Œaû
("Dequeued…ack‘ from…riÜ™y %d queue", 
´iÜ™y
);

2205 
ušt32_t
 
tÙ®_u§ge
 = 0;

2206 
i
 = 0; i < 4; i++) {

2207 
tÙ®_u§ge
 +ğ
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(&
g_queue_¡©e
.
tx_queues
[
i
]);

2210 ià(
g_queue_¡©e
.
æow_cÚŒŞ_aùive
 && 
tÙ®_u§ge
 < 
QUEUE_WATERMARK_LOW
) {

2211 
	`log_šfo
("D—ùiv©šg flow cÚŒŞ -Ù® u§g%d%%", 
tÙ®_u§ge
 / 4);

2212 
g_queue_¡©e
.
æow_cÚŒŞ_aùive
 = 
çl£
;

2215  
bufãr
;

2220  
NULL
;

2227 
	`·ck‘_check_queue_h—Éh
() {

2228 
ušt32_t
 
cu¼’t_time
 = 
	`¡©s_g‘_time¡amp
();

2229 
boŞ
 
h—Éh_issues
 = 
çl£
;

2232 ià(
cu¼’t_time
 - 
g_queue_¡©e
.
Ï¡_queue_check
 < 
QUEUE_CHECK_INTERVAL_MS
) {

2236 
g_queue_¡©e
.
Ï¡_queue_check
 = 
cu¼’t_time
;

2239 
i
 = 0; i < 4; i++) {

2240 
·ck‘_queue_t
 *
queue
 = &
g_queue_¡©e
.
tx_queues
[
i
];

2241 
ušt32_t
 
u§ge
 = 
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(
queue
);

2243 ià(
u§ge
 > 
QUEUE_WATERMARK_HIGH
) {

2244 
	`log_w¬nšg
("Queu%d u§ghigh: %d%%", 
i
, 
u§ge
);

2245 
h—Éh_issues
 = 
Œue
;

2249 ià(
queue
->
couÁ
 > 0) {

2250 
·ck‘_bufãr_t
 *
h—d
 = 
	`·ck‘_queue_³ek
(
queue
);

2251 ià(
h—d
 && h—d->
time¡amp
 > 0) {

2252 
ušt32_t
 
age
 = 
cu¼’t_time
 - 
h—d
->
time¡amp
;

2253 ià(
age
 > 5000) {

2254 
	`log_w¬nšg
("SË…ack‘ d‘eùed iÀqueu%d (age: %dms)", 
i
, 
age
);

2255 
h—Éh_issues
 = 
Œue
;

2262 
ušt32_t
 
rx_u§ge
 = 
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(&
g_queue_¡©e
.
rx_queue
);

2263 ià(
rx_u§ge
 > 
QUEUE_WATERMARK_HIGH
) {

2264 
	`log_w¬nšg
("RX queuu§ghigh: %d%%", 
rx_u§ge
);

2265 
h—Éh_issues
 = 
Œue
;

2269 ià(
h—Éh_issues
) {

2270 
	`·ck‘_ad­tive_queue_»size
();

2273  
h—Éh_issues
 ? 1 : 0;

2279 
	`·ck‘_­¶y_æow_cÚŒŞ
() {

2287 
	`log_debug
("Applying flow control backpressure");

2290 vŞ©
i
 = 0; i < 100; i++) {

2298 
	`·ck‘_ad­tive_queue_»size
() {

2299 
ušt32_t
 
Ï¡_»size
 = 0;

2300 
ušt32_t
 
cu¼’t_time
 = 
	`¡©s_g‘_time¡amp
();

2303 ià(
cu¼’t_time
 - 
Ï¡_»size
 < 10000) {

2307 
Ï¡_»size
 = 
cu¼’t_time
;

2309 
	`log_šfo
("Performing‡daptive queue„esize‡nalysis");

2312 
i
 = 0; i < 4; i++) {

2313 
·ck‘_queue_t
 *
queue
 = &
g_queue_¡©e
.
tx_queues
[
i
];

2314 
ušt32_t
 
u§ge
 = 
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(
queue
);

2316 ià(
u§ge
 > 90 && 
queue
->
max_couÁ
 < 512) {

2318 
	`log_šfo
("Queu%d cÚsi¡’y fuÎ (%d%%), wouldƒx·nd iàpossibË", 
i
, 
u§ge
);

2320 
g_queue_¡©e
.
ad­tive_»sizes
++;

2321 } ià(
u§ge
 < 10 && 
queue
->
max_couÁ
 > 32) {

2323 
	`log_šfo
("Queu%d und”utized (%d%%), would shršk iàpossibË", 
i
, 
u§ge
);

2324 
g_queue_¡©e
.
ad­tive_»sizes
++;

2333 
	`·ck‘_hªdË_queue_ov”æow
(
´iÜ™y
) {

2334 
drİ³d
 = 0;

2337 
low”_´iÜ™y
 = 
PACKET_PRIORITY_LOW
;†ow”_´iÜ™y < 
´iÜ™y
;†ower_priority++) {

2338 
·ck‘_queue_t
 *
low”_queue
 = &
g_queue_¡©e
.
tx_queues
[
low”_´iÜ™y
];

2340 !
	`·ck‘_queue_is_em±y
(
low”_queue
è&& 
drİ³d
 < 5) {

2341 
·ck‘_bufãr_t
 *
drİ³d_bufãr
 = 
	`·ck‘_queue_dequeue
(
low”_queue
);

2342 ià(
drİ³d_bufãr
) {

2343 
	`·ck‘_bufãr_ä“
(
drİ³d_bufãr
);

2344 
drİ³d
++;

2345 
g_queue_¡©e
.
´iÜ™y_drİs
++;

2349 ià(
drİ³d
 >= 5) ;

2352 ià(
drİ³d
 > 0) {

2353 
	`log_šfo
("Drİ³d %d†ow”…riÜ™y…ack‘ tØmakroom fÜ…riÜ™y %d", 
drİ³d
, 
´iÜ™y
);

2363 
boŞ
 
	`·ck‘_should_drİ_Ú_fuÎ
(
´iÜ™y
, 
queue_u§ge
) {

2365 
´iÜ™y
) {

2366 
PACKET_PRIORITY_URGENT
:

2367  
Œue
;

2368 
PACKET_PRIORITY_HIGH
:

2369  
queue_u§ge
 > 95;

2370 
PACKET_PRIORITY_NORMAL
:

2371  
queue_u§ge
 > 90;

2372 
PACKET_PRIORITY_LOW
:

2373  
çl£
;

2375  
çl£
;

2384 
ušt32_t
 
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(
·ck‘_queue_t
 *
queue
) {

2385 ià(!
queue
 || queue->
max_couÁ
 == 0) {

2389  (
queue
->
couÁ
 * 100è/ queue->
max_couÁ
;

2395 
	`·ck‘_upd©e_queue_¡©s
() {

2404 
	`·ck‘_em”g’cy_queue_d¿š
() {

2405 
tÙ®_d¿šed
 = 0;

2407 
	`log_w¬nšg
("Emergency draining‡ll…acket queues");

2410 
i
 = 0; i < 4; i++) {

2411 
·ck‘_queue_t
 *
queue
 = &
g_queue_¡©e
.
tx_queues
[
i
];

2412 
d¿šed
 = 0;

2414 !
	`·ck‘_queue_is_em±y
(
queue
)) {

2415 
·ck‘_bufãr_t
 *
bufãr
 = 
	`·ck‘_queue_dequeue
(
queue
);

2416 ià(
bufãr
) {

2417 
	`·ck‘_bufãr_ä“
(
bufãr
);

2418 
d¿šed
++;

2422 ià(
d¿šed
 > 0) {

2423 
	`log_šfo
("D¿šed %d…ack‘ äom TX queu%d", 
d¿šed
, 
i
);

2424 
tÙ®_d¿šed
 +ğ
d¿šed
;

2429 
rx_d¿šed
 = 0;

2430 !
	`·ck‘_queue_is_em±y
(&
g_queue_¡©e
.
rx_queue
)) {

2431 
·ck‘_bufãr_t
 *
bufãr
 = 
	`·ck‘_queue_dequeue
(&
g_queue_¡©e
.
rx_queue
);

2432 ià(
bufãr
) {

2433 
	`·ck‘_bufãr_ä“
(
bufãr
);

2434 
rx_d¿šed
++;

2438 ià(
rx_d¿šed
 > 0) {

2439 
	`log_šfo
("D¿šed %d…ack‘ äom RX queue", 
rx_d¿šed
);

2440 
tÙ®_d¿šed
 +ğ
rx_d¿šed
;

2443 
	`log_šfo
("Em”g’cy d¿š com¶‘ed: %dÙ®…ack‘ d¿šed", 
tÙ®_d¿šed
);

2444  
tÙ®_d¿šed
;

2455 
	`·ck‘_queue_tx_’hªûd
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
size_t
 
Ëngth
, 
´iÜ™y
, 
ušt16_t
 
hªdË
) {

2456 
·ck‘_bufãr_t
 *
bufãr
;

2457 
»suÉ
;

2459 ià(!
·ck‘
 || 
Ëngth
 =ğ0 || 
´iÜ™y
 < 0 ||…riority > 3) {

2460  
PACKET_ERR_INVALID_PARAM
;

2463 ià(!
·ck‘_İs_š™Ÿlized
) {

2464  
PACKET_ERR_NOT_INITIALIZED
;

2468 
	`·ck‘_check_queue_h—Éh
();

2471 
bufãr
 = 
	`·ck‘_bufãr_®loc
(
Ëngth
);

2472 ià(!
bufãr
) {

2473 
	`log_”rÜ
("Failedo‡llocate…acket buffer for queuing");

2474  
PACKET_ERR_NO_BUFFERS
;

2478 
»suÉ
 = 
	`·ck‘_£t_d©a
(
bufãr
, 
·ck‘
, 
Ëngth
);

2479 ià(
»suÉ
 != 0) {

2480 
	`·ck‘_bufãr_ä“
(
bufãr
);

2481  
»suÉ
;

2484 
bufãr
->
´iÜ™y
 =…riority;

2485 
bufãr
->
hªdË
 = handle;

2486 
bufãr
->
time¡amp
 = 
	`¡©s_g‘_time¡amp
();

2489 
»suÉ
 = 
	`·ck‘_’queue_w™h_´iÜ™y
(
bufãr
, 
´iÜ™y
);

2490 ià(
»suÉ
 != 0) {

2491 
	`·ck‘_bufãr_ä“
(
bufãr
);

2492  
»suÉ
;

2495 
	`log_debug
("Queued…acket forransmission:…riority=%d,†ength=%zu, handle=%04X",

2496 
´iÜ™y
, 
Ëngth
, 
hªdË
);

2505 
	`·ck‘_æush_tx_queue_’hªûd
() {

2506 
·ck‘s_£Á
 = 0;

2507 
max_·ck‘s
 = 32;

2508 
·ck‘_bufãr_t
 *
bufãr
;

2509 
»suÉ
;

2511 ià(!
·ck‘_İs_š™Ÿlized
) {

2512  
PACKET_ERR_NOT_INITIALIZED
;

2516 
·ck‘s_£Á
 < 
max_·ck‘s
) {

2517 
bufãr
 = 
	`·ck‘_dequeue_by_´iÜ™y
();

2518 ià(!
bufãr
) {

2523 
»suÉ
 = 
	`·ck‘_£nd_w™h_»Œy
(
bufãr
->
d©a
, bufãr->
Ëngth
,

2524 
NULL
, 
bufãr
->
hªdË
, 3);

2526 ià(
»suÉ
 == 0) {

2527 
·ck‘s_£Á
++;

2528 
	`log_Œaû
("SucûssfuÎy s’ˆqueued…ack‘ (hªdË=%04X)", 
bufãr
->
hªdË
);

2530 
	`log_w¬nšg
("FaedØ£nd queued…ack‘: %d", 
»suÉ
);

2535 
	`·ck‘_bufãr_ä“
(
bufãr
);

2538 ià(
·ck‘s_£Á
 > 0) {

2539 
	`log_debug
("Flushed %d…ack‘ äom TX queues", 
·ck‘s_£Á
);

2542  
·ck‘s_£Á
;

2550 
	`·ck‘_g‘_queue_¡©s
(
·ck‘_queue_mªagem’t_¡©s_t
 *
¡©s
) {

2551 ià(!
¡©s
) {

2552  
PACKET_ERR_INVALID_PARAM
;

2555 
	`mem£t
(
¡©s
, 0, (
·ck‘_queue_mªagem’t_¡©s_t
));

2558 
i
 = 0; i < 4; i++) {

2559 
¡©s
->
tx_queue_couÁs
[
i
] = 
g_queue_¡©e
.
tx_queues
[i].
couÁ
;

2560 
¡©s
->
tx_queue_max
[
i
] = 
g_queue_¡©e
.
tx_queues
[i].
max_couÁ
;

2561 
¡©s
->
tx_queue_u§ge
[
i
] = 
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(&
g_queue_¡©e
.
tx_queues
[i]);

2562 
¡©s
->
tx_queue_drİ³d
[
i
] = 
g_queue_¡©e
.
tx_queues
[i].
drİ³d_·ck‘s
;

2565 
¡©s
->
rx_queue_couÁ
 = 
g_queue_¡©e
.
rx_queue
.
couÁ
;

2566 
¡©s
->
rx_queue_max
 = 
g_queue_¡©e
.
rx_queue
.
max_couÁ
;

2567 
¡©s
->
rx_queue_u§ge
 = 
	`·ck‘_ÿlcuÏ‹_queue_u§ge
(&
g_queue_¡©e
.
rx_queue
);

2568 
¡©s
->
rx_queue_drİ³d
 = 
g_queue_¡©e
.
rx_queue
.
drİ³d_·ck‘s
;

2571 
¡©s
->
queue_fuÎ_ev’ts
 = 
g_queue_¡©e
.queue_full_events;

2572 
¡©s
->
back´essu»_ev’ts
 = 
g_queue_¡©e
.backpressure_events;

2573 
¡©s
->
´iÜ™y_drİs
 = 
g_queue_¡©e
.priority_drops;

2574 
¡©s
->
ad­tive_»sizes
 = 
g_queue_¡©e
.adaptive_resizes;

2575 
¡©s
->
æow_cÚŒŞ_aùive
 = 
g_queue_¡©e
.flow_control_active;

2581 #´agm¨
	`code_£g
()

	@/Users/jvindahl/Development/3com-packet-driver/src/c/promisc.c

11 
	~"../šşude/´omisc.h
"

12 
	~"../šşude/3c509b.h
"

13 
	~"../šşude/3c515.h
"

14 
	~"../šşude/loggšg.h
"

15 
	~"../šşude/memÜy.h
"

16 
	~"../šşude/dŸgno¡ics.h
"

17 
	~"../šşude/routšg.h
"

18 
	~"../šşude/­i.h
"

19 
	~<¡ršg.h
>

22 
´omisc_cÚfig_t
 
	gg_´omisc_cÚfig
;

23 
´omiscuous_¡©s_t
 
	gg_´omisc_¡©s
;

24 
´omisc_·ck‘_bufãr_t
 
	gg_´omisc_bufãrs
[
PROMISC_BUFFER_COUNT
];

25 
´omisc_f‹r_t
 
	gg_´omisc_f‹rs
[
PROMISC_MAX_FILTERS
];

26 
´omisc_­p_hªdË_t
 
	gg_´omisc_­ps
[
PROMISC_MAX_APPLICATIONS
];

27 vŞ©
ušt32_t
 
	gg_´omisc_bufãr_h—d
 = 0;

28 vŞ©
ušt32_t
 
	gg_´omisc_bufãr_
 = 0;

31 
boŞ
 
	gg_´omisc_š™Ÿlized
 = 
çl£
;

32 
ušt16_t
 
	gg_Ãxt_hªdË_id
 = 1;

33 
ušt32_t
 
	gg_·ck‘_couÁ”
 = 0;

36 
ušt32_t
 
´omisc_g‘_time¡amp
();

37 
boŞ
 
´omisc_bufãr_is_fuÎ
();

38 
boŞ
 
´omisc_bufãr_is_em±y
();

39 
ušt32_t
 
´omisc_advªû_bufãr_šdex
(ušt32_ˆ
šdex
);

40 
´omisc_add_bufãr_·ck‘
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
,

41 
ušt8_t
 
nic_šdex
, ušt8_ˆ
f‹r_m©ched
);

42 
boŞ
 
´omisc_check_f‹r_m©ch
(cÚ¡ 
´omisc_f‹r_t
 *
f‹r
,

43 cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
);

44 
´omisc_şassify_ªd_upd©e_¡©s
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
);

47 
	$´omisc_š™
() {

48 ià(
g_´omisc_š™Ÿlized
) {

49  
SUCCESS
;

52 
	`LOG_INFO
("Initializing…romiscuous mode system");

55 
	`mem£t
(&
g_´omisc_cÚfig
, 0, (
´omisc_cÚfig_t
));

56 
g_´omisc_cÚfig
.
Ëv–
 = 
PROMISC_LEVEL_OFF
;

57 
g_´omisc_cÚfig
.
’abËd
 = 
çl£
;

58 
g_´omisc_cÚfig
.
bufãr_couÁ
 = 
PROMISC_BUFFER_COUNT
;

59 
g_´omisc_cÚfig
.
ÿ±u»_timeout_ms
 = 5000;

60 
g_´omisc_cÚfig
.
Ë¬nšg_mode
 = 
Œue
;

61 
g_´omisc_cÚfig
.
š‹g¿tiÚ_mode
 = 
Œue
;

64 
	`´omisc_ş—r_¡©s
();

67 
	`mem£t
(
g_´omisc_bufãrs
, 0, (g_promisc_buffers));

68 
g_´omisc_bufãr_h—d
 = 0;

69 
g_´omisc_bufãr_
 = 0;

72 
	`mem£t
(
g_´omisc_f‹rs
, 0, (g_promisc_filters));

75 
	`mem£t
(
g_´omisc_­ps
, 0, (g_promisc_apps));

77 
g_´omisc_š™Ÿlized
 = 
Œue
;

79 
	`LOG_INFO
("Promiscuous mode system initialized successfully");

81  
SUCCESS
;

82 
	}
}

84 
	$´omisc_ş—nup
() {

85 ià(!
g_´omisc_š™Ÿlized
) {

89 
	`LOG_INFO
("Cleaning up…romiscuous mode system");

92 
i
 = 0; i < 
	`h¬dw¬e_g‘_nic_couÁ
(); i++) {

93 
nic_šfo_t
 *
nic
 = 
	`h¬dw¬e_g‘_nic
(
i
);

94 ià(
nic
 && 
	`´omisc_is_’abËd
(nic)) {

95 
	`´omisc_di§bË
(
nic
);

100 
	`´omisc_ş—r_f‹rs
();

102 
i
 = 0; i < 
PROMISC_MAX_APPLICATIONS
; i++) {

103 ià(
g_´omisc_­ps
[
i
].
aùive
) {

104 
	`´omisc_uÄegi¡”_­¶iÿtiÚ
(
g_´omisc_­ps
[
i
].
hªdË_id
);

108 
g_´omisc_š™Ÿlized
 = 
çl£
;

110 
	`LOG_INFO
("Promiscuous mode system cleaned up");

111 
	}
}

113 
	$´omisc_’abË
(
nic_šfo_t
 *
nic
, 
´omisc_Ëv–_t
 
Ëv–
) {

114 ià(!
g_´omisc_š™Ÿlized
 || !
nic
) {

115  
ERROR_INVALID_PARAM
;

118 
	`LOG_INFO
("EÇblšg…romiscuou modËv– %d oÀNIC %d", 
Ëv–
, 
nic
->
šdex
);

121 ià(!(
nic
->
ÿ·b™›s
 & 
HW_CAP_PROMISCUOUS
)) {

122 
	`LOG_ERROR
("NIC %d dÛ nÙ suµÜˆ´omiscuou mode", 
nic
->
šdex
);

123  
ERROR_NOT_SUPPORTED
;

126 
»suÉ
 = 
ERROR_NOT_SUPPORTED
;

129 
nic
->
ty³
) {

130 
NIC_TYPE_3C509B
:

131 
»suÉ
 = 
	`´omisc_’abË_3c509b
(
nic
, 
Ëv–
);

133 
NIC_TYPE_3C515_TX
:

134 
»suÉ
 = 
	`´omisc_’abË_3c515
(
nic
, 
Ëv–
);

137 
	`LOG_ERROR
("UnsuµÜ‹d NICy³ %d fÜ…romiscuou mode", 
nic
->
ty³
);

138  
ERROR_NOT_SUPPORTED
;

141 ià(
»suÉ
 =ğ
SUCCESS
) {

143 
nic
->
¡©us
 |ğ
NIC_STATUS_PROMISCUOUS
;

146 
g_´omisc_cÚfig
.
’abËd
 = 
Œue
;

147 
g_´omisc_cÚfig
.
Ëv–
 =†evel;

148 
g_´omisc_cÚfig
.
aùive_nic_mask
 |ğ(1 << 
nic
->
šdex
);

151 ià(
g_´omisc_cÚfig
.
š‹g¿tiÚ_mode
) {

152 
	`´omisc_š‹g¿‹_routšg
();

153 
	`´omisc_š‹g¿‹_­i
();

154 
	`´omisc_š‹g¿‹_dŸgno¡ics
();

157 
	`LOG_INFO
("Promiscuou mod’abËd sucûssfuÎy oÀNIC %d", 
nic
->
šdex
);

159 
	`LOG_ERROR
("FaedØ’abË…romiscuou modÚ NIC %d: %d", 
nic
->
šdex
, 
»suÉ
);

162  
»suÉ
;

163 
	}
}

165 
	$´omisc_di§bË
(
nic_šfo_t
 *
nic
) {

166 ià(!
g_´omisc_š™Ÿlized
 || !
nic
) {

167  
ERROR_INVALID_PARAM
;

170 
	`LOG_INFO
("Di§blšg…romiscuou modÚ NIC %d", 
nic
->
šdex
);

172 
»suÉ
 = 
ERROR_NOT_SUPPORTED
;

175 
nic
->
ty³
) {

176 
NIC_TYPE_3C509B
:

177 
»suÉ
 = 
	`´omisc_di§bË_3c509b
(
nic
);

179 
NIC_TYPE_3C515_TX
:

180 
»suÉ
 = 
	`´omisc_di§bË_3c515
(
nic
);

183 
	`LOG_ERROR
("UnsuµÜ‹d NICy³ %d fÜ…romiscuou mode", 
nic
->
ty³
);

184  
ERROR_NOT_SUPPORTED
;

187 ià(
»suÉ
 =ğ
SUCCESS
) {

189 
nic
->
¡©us
 &ğ~
NIC_STATUS_PROMISCUOUS
;

192 
g_´omisc_cÚfig
.
aùive_nic_mask
 &ğ~(1 << 
nic
->
šdex
);

195 ià(
g_´omisc_cÚfig
.
aùive_nic_mask
 == 0) {

196 
g_´omisc_cÚfig
.
’abËd
 = 
çl£
;

197 
g_´omisc_cÚfig
.
Ëv–
 = 
PROMISC_LEVEL_OFF
;

200 
	`LOG_INFO
("Promiscuou moddi§bËd sucûssfuÎy oÀNIC %d", 
nic
->
šdex
);

202 
	`LOG_ERROR
("FaedØdi§bË…romiscuou modÚ NIC %d: %d", 
nic
->
šdex
, 
»suÉ
);

205  
»suÉ
;

206 
	}
}

208 
boŞ
 
	$´omisc_is_’abËd
(
nic_šfo_t
 *
nic
) {

209 ià(!
nic
) {

210  
çl£
;

213  (
nic
->
¡©us
 & 
NIC_STATUS_PROMISCUOUS
) != 0;

214 
	}
}

217 
	$´omisc_ÿ±u»_·ck‘
(
nic_šfo_t
 *
nic
, cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

218 ià(!
g_´omisc_š™Ÿlized
 || !
nic
 || !
·ck‘
 || 
Ëngth
 == 0) {

219  
ERROR_INVALID_PARAM
;

223 ià(!
	`´omisc_is_’abËd
(
nic
)) {

224  
ERROR_NOT_ENABLED
;

228 ià(
	`´omisc_bufãr_is_fuÎ
()) {

229 
g_´omisc_¡©s
.
bufãr_ov”æows
++;

230 
g_´omisc_¡©s
.
drİ³d_·ck‘s
++;

231  
ERROR_BUFFER_FULL
;

235 
ušt8_t
 
f‹r_m©ched
 = 0;

236 
boŞ
 
m©ches_f‹rs
 = 
çl£
;

238 ià(
g_´omisc_cÚfig
.
f‹r_couÁ
 > 0) {

239 
m©ches_f‹rs
 = 
	`´omisc_·ck‘_m©ches_f‹rs
(
·ck‘
, 
Ëngth
);

240 ià(
m©ches_f‹rs
) {

242 
i
 = 0; i < 
PROMISC_MAX_FILTERS
; i++) {

243 ià(
g_´omisc_f‹rs
[
i
].
’abËd
 &&

244 
	`´omisc_check_f‹r_m©ch
(&
g_´omisc_f‹rs
[
i
], 
·ck‘
, 
Ëngth
)) {

245 
f‹r_m©ched
 = 
i
 + 1;

252 
m©ches_f‹rs
 = 
Œue
;

256 ià(
m©ches_f‹rs
 || 
g_´omisc_cÚfig
.
Ëv–
 =ğ
PROMISC_LEVEL_FULL
) {

257 
	`´omisc_add_bufãr_·ck‘
(
·ck‘
, 
Ëngth
, 
nic
->
šdex
, 
f‹r_m©ched
);

260 
	`´omisc_şassify_ªd_upd©e_¡©s
(
·ck‘
, 
Ëngth
);

261 
	`´omisc_upd©e_¡©s
(
·ck‘
, 
Ëngth
, 
m©ches_f‹rs
);

264 
´omisc_·ck‘_bufãr_t
 *
bufãr
 = &
g_´omisc_bufãrs
[
g_´omisc_bufãr_
];

265 
	`´omisc_d–iv”_to_­¶iÿtiÚs
(
bufãr
);

267  
SUCCESS
;

270  
ERROR_FILTERED
;

271 
	}
}

273 
	$´omisc_g‘_·ck‘
(
´omisc_·ck‘_bufãr_t
 *
bufãr
) {

274 ià(!
g_´omisc_š™Ÿlized
 || !
bufãr
) {

275  
ERROR_INVALID_PARAM
;

278 ià(
	`´omisc_bufãr_is_em±y
()) {

279  
ERROR_NO_DATA
;

283 
	`memıy
(
bufãr
, &
g_´omisc_bufãrs
[
g_´omisc_bufãr_h—d
], (
´omisc_·ck‘_bufãr_t
));

286 
g_´omisc_bufãr_h—d
 = 
	`´omisc_advªû_bufãr_šdex
(g_promisc_buffer_head);

288  
SUCCESS
;

289 
	}
}

291 
	$´omisc_³ek_·ck‘
(
´omisc_·ck‘_bufãr_t
 *
bufãr
) {

292 ià(!
g_´omisc_š™Ÿlized
 || !
bufãr
) {

293  
ERROR_INVALID_PARAM
;

296 ià(
	`´omisc_bufãr_is_em±y
()) {

297  
ERROR_NO_DATA
;

301 
	`memıy
(
bufãr
, &
g_´omisc_bufãrs
[
g_´omisc_bufãr_h—d
], (
´omisc_·ck‘_bufãr_t
));

303  
SUCCESS
;

304 
	}
}

306 
	$´omisc_´oûss_ÿ±u»d_·ck‘s
() {

307 ià(!
g_´omisc_š™Ÿlized
) {

311 
´omisc_·ck‘_bufãr_t
 
·ck‘
;

314 
	`´omisc_g‘_·ck‘
(&
·ck‘
è=ğ
SUCCESS
) {

318 ià(
g_´omisc_cÚfig
.
Ëv–
 =ğ
PROMISC_LEVEL_FULL
) {

319 
	`LOG_DEBUG
("Processed…acket:†ength=%d,ype=%d, from NIC %d",

320 
·ck‘
.
Ëngth
,…ack‘.
·ck‘_ty³
,…ack‘.
nic_šdex
);

323 
	}
}

326 
	$´omisc_add_f‹r
(cÚ¡ 
´omisc_f‹r_t
 *
f‹r
) {

327 ià(!
g_´omisc_š™Ÿlized
 || !
f‹r
) {

328  
ERROR_INVALID_PARAM
;

332 
i
 = 0; i < 
PROMISC_MAX_FILTERS
; i++) {

333 ià(!
g_´omisc_f‹rs
[
i
].
’abËd
) {

334 
	`memıy
(&
g_´omisc_f‹rs
[
i
], 
f‹r
, (
´omisc_f‹r_t
));

335 
g_´omisc_f‹rs
[
i
].
’abËd
 = 
Œue
;

336 
g_´omisc_cÚfig
.
f‹r_couÁ
++;

338 
	`LOG_DEBUG
("Added f‹¸%d oàty³ %d", 
i
, 
f‹r
->
ty³
);

339  
i
;

343  
ERROR_NO_RESOURCES
;

344 
	}
}

346 
	$´omisc_»move_f‹r
(
f‹r_id
) {

347 ià(!
g_´omisc_š™Ÿlized
 || 
f‹r_id
 < 0 || f‹r_id >ğ
PROMISC_MAX_FILTERS
) {

348  
ERROR_INVALID_PARAM
;

351 ià(
g_´omisc_f‹rs
[
f‹r_id
].
’abËd
) {

352 
	`mem£t
(&
g_´omisc_f‹rs
[
f‹r_id
], 0, (
´omisc_f‹r_t
));

353 
g_´omisc_cÚfig
.
f‹r_couÁ
--;

355 
	`LOG_DEBUG
("Removed f‹¸%d", 
f‹r_id
);

356  
SUCCESS
;

359  
ERROR_NOT_FOUND
;

360 
	}
}

362 
	$´omisc_ş—r_f‹rs
() {

363 ià(!
g_´omisc_š™Ÿlized
) {

364  
ERROR_INVALID_PARAM
;

367 
	`mem£t
(
g_´omisc_f‹rs
, 0, (g_promisc_filters));

368 
g_´omisc_cÚfig
.
f‹r_couÁ
 = 0;

370 
	`LOG_INFO
("Cleared‡ll…romiscuous mode filters");

372  
SUCCESS
;

373 
	}
}

375 
boŞ
 
	$´omisc_·ck‘_m©ches_f‹rs
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

376 ià(!
·ck‘
 || 
Ëngth
 == 0) {

377  
çl£
;

381 ià(
g_´omisc_cÚfig
.
f‹r_couÁ
 == 0) {

382  
Œue
;

386 
i
 = 0; i < 
PROMISC_MAX_FILTERS
; i++) {

387 ià(
g_´omisc_f‹rs
[
i
].
’abËd
 &&

388 
	`´omisc_check_f‹r_m©ch
(&
g_´omisc_f‹rs
[
i
], 
·ck‘
, 
Ëngth
)) {

389 
g_´omisc_¡©s
.
f‹r_m©ches
++;

390  
Œue
;

394  
çl£
;

395 
	}
}

397 
	$´omisc_g‘_f‹r_couÁ
() {

398  
g_´omisc_cÚfig
.
f‹r_couÁ
;

399 
	}
}

402 
	$´omisc_»gi¡”_­¶iÿtiÚ
(
ušt32_t
 
pid
, 
´omisc_Ëv–_t
 
Ëv–
, 
çr
 *
ÿÎback
) {

403 ià(!
g_´omisc_š™Ÿlized
) {

404  
ERROR_INVALID_PARAM
;

408 
i
 = 0; i < 
PROMISC_MAX_APPLICATIONS
; i++) {

409 ià(!
g_´omisc_­ps
[
i
].
aùive
) {

410 
g_´omisc_­ps
[
i
].
hªdË_id
 = 
g_Ãxt_hªdË_id
++;

411 
g_´omisc_­ps
[
i
].
pid
 =…id;

412 
g_´omisc_­ps
[
i
].
Ëv–
 =†evel;

413 
g_´omisc_­ps
[
i
].
ÿÎback
 = callback;

414 
g_´omisc_­ps
[
i
].
f‹r_mask
 = 0;

415 
g_´omisc_­ps
[
i
].
·ck‘s_d–iv”ed
 = 0;

416 
g_´omisc_­ps
[
i
].
·ck‘s_drİ³d
 = 0;

417 
g_´omisc_­ps
[
i
].
aùive
 = 
Œue
;

419 
g_´omisc_cÚfig
.
­p_couÁ
++;

421 
	`LOG_INFO
("Registered…romiscuous mode‡pplication: handle=%d,…id=%lu,†evel=%d",

422 
g_´omisc_­ps
[
i
].
hªdË_id
, 
pid
, 
Ëv–
);

424  
g_´omisc_­ps
[
i
].
hªdË_id
;

428  
ERROR_NO_RESOURCES
;

429 
	}
}

431 
	$´omisc_uÄegi¡”_­¶iÿtiÚ
(
ušt16_t
 
hªdË
) {

432 ià(!
g_´omisc_š™Ÿlized
) {

433  
ERROR_INVALID_PARAM
;

437 
i
 = 0; i < 
PROMISC_MAX_APPLICATIONS
; i++) {

438 ià(
g_´omisc_­ps
[
i
].
aùive
 && g_´omisc_­ps[i].
hªdË_id
 =ğ
hªdË
) {

439 
	`LOG_INFO
("UÄegi¡”šg…romiscuou mod­¶iÿtiÚ: hªdË=%d", 
hªdË
);

441 
	`mem£t
(&
g_´omisc_­ps
[
i
], 0, (
´omisc_­p_hªdË_t
));

442 
g_´omisc_cÚfig
.
­p_couÁ
--;

444  
SUCCESS
;

448  
ERROR_NOT_FOUND
;

449 
	}
}

451 
	$´omisc_d–iv”_to_­¶iÿtiÚs
(cÚ¡ 
´omisc_·ck‘_bufãr_t
 *
·ck‘
) {

452 ià(!
g_´omisc_š™Ÿlized
 || !
·ck‘
) {

453  
ERROR_INVALID_PARAM
;

456 
d–iv”ed
 = 0;

459 
i
 = 0; i < 
PROMISC_MAX_APPLICATIONS
; i++) {

460 ià(
g_´omisc_­ps
[
i
].
aùive
) {

462 
boŞ
 
should_d–iv”
 = 
çl£
;

464 
g_´omisc_­ps
[
i
].
Ëv–
) {

465 
PROMISC_LEVEL_FULL
:

466 
should_d–iv”
 = 
Œue
;

468 
PROMISC_LEVEL_BASIC
:

469 
should_d–iv”
 = (
·ck‘
->
f‹r_m©ched
 > 0);

471 
PROMISC_LEVEL_SELECTIVE
:

472 
should_d–iv”
 = (
·ck‘
->
f‹r_m©ched
 > 0 &&

473 (
g_´omisc_­ps
[
i
].
f‹r_mask
 & (1 << 
·ck‘
->
f‹r_m©ched
)));

476 
should_d–iv”
 = 
çl£
;

480 ià(
should_d–iv”
 && 
g_´omisc_­ps
[
i
].
ÿÎback
) {

482 
	`çr
 (*
ÿÎback
)(cÚ¡ 
´omisc_·ck‘_bufãr_t
 
çr
 *èğ
g_´omisc_­ps
[
i
].callback;

483 
	`ÿÎback
(
·ck‘
);

485 
g_´omisc_­ps
[
i
].
·ck‘s_d–iv”ed
++;

486 
d–iv”ed
++;

488 
g_´omisc_­ps
[
i
].
·ck‘s_drİ³d
++;

493  
d–iv”ed
;

494 
	}
}

496 
	$´omisc_g‘_­¶iÿtiÚ_couÁ
() {

497  
g_´omisc_cÚfig
.
­p_couÁ
;

498 
	}
}

501 cÚ¡ 
´omiscuous_¡©s_t
* 
	$´omisc_g‘_¡©s
() {

502  &
g_´omisc_¡©s
;

503 
	}
}

505 
	$´omisc_ş—r_¡©s
() {

506 
	`mem£t
(&
g_´omisc_¡©s
, 0, (
´omiscuous_¡©s_t
));

507 
	`LOG_DEBUG
("Cleared…romiscuous mode statistics");

508 
	}
}

510 
	$´omisc_upd©e_¡©s
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
, 
boŞ
 
f‹»d
) {

511 ià(!
·ck‘
 || 
Ëngth
 == 0) {

515 
g_´omisc_¡©s
.
tÙ®_·ck‘s
++;

516 
g_´omisc_¡©s
.
by‹s_ÿ±u»d
 +ğ
Ëngth
;

518 ià(
f‹»d
) {

519 
g_´omisc_¡©s
.
f‹»d_·ck‘s
++;

523 ià(
	`´omisc_is_brßdÿ¡_·ck‘
(
·ck‘
)) {

524 
g_´omisc_¡©s
.
brßdÿ¡_·ck‘s
++;

525 } ià(
	`´omisc_is_muÉiÿ¡_·ck‘
(
·ck‘
)) {

526 
g_´omisc_¡©s
.
muÉiÿ¡_·ck‘s
++;

528 
g_´omisc_¡©s
.
uniÿ¡_·ck‘s
++;

532 ià(
Ëngth
 < 64) {

533 
g_´omisc_¡©s
.
und”sized_·ck‘s
++;

534 } ià(
Ëngth
 > 1514) {

535 
g_´omisc_¡©s
.
ov”sized_·ck‘s
++;

537 
	}
}

539 
	$´omisc_´št_¡©s
() {

540 
	`LOG_INFO
("Promiscuous Mode Statistics:");

541 
	`LOG_INFO
(" TÙ®…ack‘s: %lu", 
g_´omisc_¡©s
.
tÙ®_·ck‘s
);

542 
	`LOG_INFO
(" F‹»d…ack‘s: %lu", 
g_´omisc_¡©s
.
f‹»d_·ck‘s
);

543 
	`LOG_INFO
(" Drİ³d…ack‘s: %lu", 
g_´omisc_¡©s
.
drİ³d_·ck‘s
);

544 
	`LOG_INFO
(" Broadcast: %lu, Multicast: %lu, Unicast: %lu",

545 
g_´omisc_¡©s
.
brßdÿ¡_·ck‘s
,

546 
g_´omisc_¡©s
.
muÉiÿ¡_·ck‘s
,

547 
g_´omisc_¡©s
.
uniÿ¡_·ck‘s
);

548 
	`LOG_INFO
(" Bufã¸ov”æows: %lu", 
g_´omisc_¡©s
.
bufãr_ov”æows
);

549 
	`LOG_INFO
(" By‹ ÿ±u»d: %lu", 
g_´omisc_¡©s
.
by‹s_ÿ±u»d
);

550 
	}
}

553 
	$´omisc_£t_cÚfig
(cÚ¡ 
´omisc_cÚfig_t
 *
cÚfig
) {

554 ià(!
g_´omisc_š™Ÿlized
 || !
cÚfig
) {

555  
ERROR_INVALID_PARAM
;

558 
	`memıy
(&
g_´omisc_cÚfig
, 
cÚfig
, (
´omisc_cÚfig_t
));

560 
	`LOG_INFO
("Updated…romiscuous mode configuration");

562  
SUCCESS
;

563 
	}
}

565 cÚ¡ 
´omisc_cÚfig_t
* 
	$´omisc_g‘_cÚfig
() {

566  &
g_´omisc_cÚfig
;

567 
	}
}

569 
	$´omisc_£t_Ëv–
(
´omisc_Ëv–_t
 
Ëv–
) {

570 ià(!
g_´omisc_š™Ÿlized
) {

571  
ERROR_INVALID_PARAM
;

574 
g_´omisc_cÚfig
.
Ëv–
 =†evel;

576 
	`LOG_INFO
("S‘…romiscuou modËv–Ø%d", 
Ëv–
);

578  
SUCCESS
;

579 
	}
}

581 
´omisc_Ëv–_t
 
	$´omisc_g‘_Ëv–
() {

582  
g_´omisc_cÚfig
.
Ëv–
;

583 
	}
}

586 
	$´omisc_š‹g¿‹_routšg
() {

588 
	`LOG_DEBUG
("Integrating…romiscuous mode with„outing system");

593  
SUCCESS
;

594 
	}
}

596 
	$´omisc_š‹g¿‹_­i
() {

598 
	`LOG_DEBUG
("Integrating…romiscuous mode withƒxtended API system");

603  
SUCCESS
;

604 
	}
}

606 
	$´omisc_š‹g¿‹_dŸgno¡ics
() {

608 
	`LOG_DEBUG
("Integrating…romiscuous mode with diagnostics system");

613  
SUCCESS
;

614 
	}
}

617 
	$´omisc_’abË_3c509b
(
nic_šfo_t
 *
nic
, 
´omisc_Ëv–_t
 
Ëv–
) {

618 ià(!
nic
 ||‚ic->
ty³
 !ğ
NIC_TYPE_3C509B
) {

619  
ERROR_INVALID_PARAM
;

622 
	`LOG_DEBUG
("EÇblšg 3C509B…romiscuou mod©†ev– %d", 
Ëv–
);

627 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_RX_DISABLE
);

630 
i
 = 0; i < 100; i++) {

631 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C509B_STATUS_REG
);

632 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

635 
	`ud–ay
(10);

639 
	`_3C509B_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C509B_WINDOW_1
);

642 
ušt16_t
 
f‹r
 = 
_3C509B_RX_FILTER_STATION
 | 
_3C509B_RX_FILTER_BROADCAST
;

644 
Ëv–
) {

645 
PROMISC_LEVEL_BASIC
:

646 
f‹r
 |ğ
_3C509B_RX_FILTER_MULTICAST
;

648 
PROMISC_LEVEL_FULL
:

649 
f‹r
 |ğ
_3C509B_RX_FILTER_MULTICAST
 | 
_3C509B_RX_FILTER_PROM
;

651 
PROMISC_LEVEL_SELECTIVE
:

652 
f‹r
 |ğ
_3C509B_RX_FILTER_MULTICAST
 | 
_3C509B_RX_FILTER_PROM
;

656 
	`LOG_ERROR
("Inv®id…romiscuou Ëv– %d fÜ 3C509B", 
Ëv–
);

657  
ERROR_INVALID_PARAM
;

661 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_SET_RX_FILTER
 | 
f‹r
);

664 
i
 = 0; i < 100; i++) {

665 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C509B_STATUS_REG
);

666 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

669 
	`ud–ay
(10);

673 ià(
Ëv–
 >ğ
PROMISC_LEVEL_FULL
) {

675 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_SET_RX_THRESHOLD
 | 8);

676 
	`ud–ay
(100);

679 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_SET_TX_THRESHOLD
 | 1024);

680 
	`ud–ay
(100);

684 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_RX_ENABLE
);

687 
i
 = 0; i < 100; i++) {

688 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C509B_STATUS_REG
);

689 ià(!(
¡©us
 & 
_3C509B_STATUS_CMD_BUSY
)) {

692 
	`ud–ay
(10);

696 ià(
Ëv–
 >ğ
PROMISC_LEVEL_FULL
) {

698 
ušt16_t
 
št_mask
 = 
_3C509B_IMASK_RX_COMPLETE
 | 
_3C509B_IMASK_TX_COMPLETE
 |

699 
_3C509B_IMASK_ADAPTER_FAILURE
;

700 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_SET_INTR_ENB
 | 
št_mask
);

703 
	`LOG_DEBUG
("3C509B…romiscuou mod’abËd: f‹r=0x%X,†ev–=%d", 
f‹r
, 
Ëv–
);

705  
SUCCESS
;

706 
	}
}

708 
	$´omisc_di§bË_3c509b
(
nic_šfo_t
 *
nic
) {

709 ià(!
nic
 ||‚ic->
ty³
 !ğ
NIC_TYPE_3C509B
) {

710  
ERROR_INVALID_PARAM
;

713 
	`LOG_DEBUG
("Disabling 3C509B…romiscuous mode");

716 
	`_3C509B_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C509B_WINDOW_1
);

719 
ušt16_t
 
f‹r
 = 
_3C509B_RX_FILTER_STATION
 | 
_3C509B_RX_FILTER_BROADCAST
;

720 
	`outw
(
nic
->
io_ba£
 + 
_3C509B_COMMAND_REG
, 
_3C509B_CMD_SET_RX_FILTER
 | 
f‹r
);

722 
	`LOG_DEBUG
("3C509B…romiscuous mode disabled");

724  
SUCCESS
;

725 
	}
}

727 
	$´omisc_’abË_3c515
(
nic_šfo_t
 *
nic
, 
´omisc_Ëv–_t
 
Ëv–
) {

728 ià(!
nic
 ||‚ic->
ty³
 !ğ
NIC_TYPE_3C515_TX
) {

729  
ERROR_INVALID_PARAM
;

732 
	`LOG_DEBUG
("EÇblšg 3C515-TX…romiscuou mod©†ev– %d", 
Ëv–
);

737 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_UP_STALL
);

740 
i
 = 0; i < 1000; i++) {

741 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

742 ià(!(
¡©us
 & 
_3C515_TX_STATUS_DMA_IN_PROGRESS
)) {

745 
	`ud–ay
(10);

749 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_RX_DISABLE
);

752 
i
 = 0; i < 100; i++) {

753 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

754 ià(!(
¡©us
 & 
_3C515_TX_STATUS_CMD_IN_PROGRESS
)) {

757 
	`ud–ay
(10);

761 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_1
);

764 
ušt16_t
 
f‹r
 = 
_3C515_TX_RX_FILTER_STATION
 | 
_3C515_TX_RX_FILTER_BROADCAST
;

766 
Ëv–
) {

767 
PROMISC_LEVEL_BASIC
:

768 
f‹r
 |ğ
_3C515_TX_RX_FILTER_MULTICAST
;

770 
PROMISC_LEVEL_FULL
:

771 
f‹r
 |ğ
_3C515_TX_RX_FILTER_MULTICAST
 | 
_3C515_TX_RX_FILTER_PROM
;

773 
PROMISC_LEVEL_SELECTIVE
:

774 
f‹r
 |ğ
_3C515_TX_RX_FILTER_MULTICAST
 | 
_3C515_TX_RX_FILTER_PROM
;

777 
	`LOG_ERROR
("Inv®id…romiscuou Ëv– %d fÜ 3C515-TX", 
Ëv–
);

779 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_UP_UNSTALL
);

780  
ERROR_INVALID_PARAM
;

784 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_SET_RX_FILTER
 | 
f‹r
);

787 
i
 = 0; i < 100; i++) {

788 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

789 ià(!(
¡©us
 & 
_3C515_TX_STATUS_CMD_IN_PROGRESS
)) {

792 
	`ud–ay
(10);

796 ià(
Ëv–
 >ğ
PROMISC_LEVEL_FULL
) {

798 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_7
);

801 
	`outw
(
nic
->
io_ba£
 + 0x08, 0x0020);

802 
	`ud–ay
(10);

805 
	`outw
(
nic
->
io_ba£
 + 0x0A, 0x0008);

806 
	`ud–ay
(10);

809 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_1
);

813 ià(
Ëv–
 >ğ
PROMISC_LEVEL_FULL
) {

814 
ušt16_t
 
št_mask
 = 
_3C515_TX_IMASK_RX_COMPLETE
 | 
_3C515_TX_IMASK_UP_COMPLETE
 |

815 
_3C515_TX_IMASK_TX_COMPLETE
 | 
_3C515_TX_IMASK_ADAPTER_FAILURE
;

816 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_SET_INTR_ENB
 | 
št_mask
);

820 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_RX_ENABLE
);

823 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_UP_UNSTALL
);

826 
i
 = 0; i < 100; i++) {

827 
ušt16_t
 
¡©us
 = 
	`šw
(
nic
->
io_ba£
 + 
_3C515_TX_STATUS_REG
);

828 ià(!(
¡©us
 & 
_3C515_TX_STATUS_CMD_IN_PROGRESS
)) {

831 
	`ud–ay
(10);

834 
	`LOG_DEBUG
("3C515-TX…romiscuous modeƒnabled: filter=0x%X,†evel=%d, DMA optimized",

835 
f‹r
, 
Ëv–
);

837  
SUCCESS
;

838 
	}
}

840 
	$´omisc_di§bË_3c515
(
nic_šfo_t
 *
nic
) {

841 ià(!
nic
 ||‚ic->
ty³
 !ğ
NIC_TYPE_3C515_TX
) {

842  
ERROR_INVALID_PARAM
;

845 
	`LOG_DEBUG
("Disabling 3C515-TX…romiscuous mode");

848 
	`_3C515_TX_SELECT_WINDOW
(
nic
->
io_ba£
, 
_3C515_TX_WINDOW_1
);

851 
ušt16_t
 
f‹r
 = 
_3C515_TX_RX_FILTER_STATION
 | 
_3C515_TX_RX_FILTER_BROADCAST
;

852 
	`outw
(
nic
->
io_ba£
 + 
_3C515_TX_COMMAND_REG
, 
_3C515_TX_CMD_SET_RX_FILTER
 | 
f‹r
);

854 
	`LOG_DEBUG
("3C515-TX…romiscuous mode disabled");

856  
SUCCESS
;

857 
	}
}

860 cÚ¡ * 
	$´omisc_Ëv–_to_¡ršg
(
´omisc_Ëv–_t
 
Ëv–
) {

861 
Ëv–
) {

862 
PROMISC_LEVEL_OFF
:  "Off";

863 
PROMISC_LEVEL_BASIC
:  "Basic";

864 
PROMISC_LEVEL_FULL
:  "Full";

865 
PROMISC_LEVEL_SELECTIVE
:  "Selective";

868 
	}
}

870 cÚ¡ * 
	$´omisc_f‹r_ty³_to_¡ršg
(
´omisc_f‹r_ty³_t
 
ty³
) {

871 
ty³
) {

872 
PROMISC_FILTER_ALL
:  "All";

873 
PROMISC_FILTER_PROTOCOL
:  "Protocol";

874 
PROMISC_FILTER_MAC_SRC
:  "Source MAC";

875 
PROMISC_FILTER_MAC_DST
:  "Destination MAC";

876 
PROMISC_FILTER_LENGTH
:  "Length";

877 
PROMISC_FILTER_CONTENT
:  "Content";

880 
	}
}

882 
boŞ
 
	$´omisc_is_brßdÿ¡_·ck‘
(cÚ¡ 
ušt8_t
 *
·ck‘
) {

883 ià(!
·ck‘
) {

884  
çl£
;

888 
i
 = 0; i < 
ETH_ALEN
; i++) {

889 ià(
·ck‘
[
i
] != 0xFF) {

890  
çl£
;

894  
Œue
;

895 
	}
}

897 
boŞ
 
	$´omisc_is_muÉiÿ¡_·ck‘
(cÚ¡ 
ušt8_t
 *
·ck‘
) {

898 ià(!
·ck‘
) {

899  
çl£
;

903  (
·ck‘
[0] & 0x01) != 0;

904 
	}
}

906 
ušt16_t
 
	$´omisc_şassify_·ck‘
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

907 ià(!
·ck‘
 || 
Ëngth
 < 14) {

912 
ušt16_t
 
‘h”ty³
 = (
·ck‘
[12] << 8) |…acket[13];

915  
‘h”ty³
;

916 
	}
}

919 
ušt32_t
 
	$´omisc_g‘_time¡amp
() {

922  ++
g_·ck‘_couÁ”
;

923 
	}
}

925 
boŞ
 
	$´omisc_bufãr_is_fuÎ
() {

926  ((
g_´omisc_bufãr_
 + 1è% 
PROMISC_BUFFER_COUNT
è=ğ
g_´omisc_bufãr_h—d
;

927 
	}
}

929 
boŞ
 
	$´omisc_bufãr_is_em±y
() {

930  
g_´omisc_bufãr_h—d
 =ğ
g_´omisc_bufãr_
;

931 
	}
}

933 
ušt32_t
 
	$´omisc_advªû_bufãr_šdex
(
ušt32_t
 
šdex
) {

934  (
šdex
 + 1è% 
PROMISC_BUFFER_COUNT
;

935 
	}
}

937 
	$´omisc_add_bufãr_·ck‘
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
,

938 
ušt8_t
 
nic_šdex
, ušt8_ˆ
f‹r_m©ched
) {

939 
´omisc_·ck‘_bufãr_t
 *
bufãr
 = &
g_´omisc_bufãrs
[
g_´omisc_bufãr_
];

941 
bufãr
->
time¡amp
 = 
	`´omisc_g‘_time¡amp
();

942 
bufãr
->
Ëngth
 =†ength;

943 
bufãr
->
¡©us
 = 0;

944 
bufãr
->
nic_šdex
 =‚ic_index;

945 
bufãr
->
f‹r_m©ched
 = filter_matched;

946 
bufãr
->
·ck‘_ty³
 = 
	`´omisc_şassify_·ck‘
(
·ck‘
, 
Ëngth
);

947 
bufãr
->
»£rved
 = 0;

950 
ušt16_t
 
cİy_Ëngth
 = (
Ëngth
 > 
PROMISC_BUFFER_SIZE
) ? PROMISC_BUFFER_SIZE :†ength;

951 
	`memıy
(
bufãr
->
d©a
, 
·ck‘
, 
cİy_Ëngth
);

954 
g_´omisc_bufãr_
 = 
	`´omisc_advªû_bufãr_šdex
(g_promisc_buffer_tail);

955 
	}
}

957 
boŞ
 
	$´omisc_check_f‹r_m©ch
(cÚ¡ 
´omisc_f‹r_t
 *
f‹r
,

958 cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

959 ià(!
f‹r
 || !f‹r->
’abËd
 || !
·ck‘
) {

960  
çl£
;

963 
f‹r
->
ty³
) {

964 
PROMISC_FILTER_ALL
:

965  
Œue
;

967 
PROMISC_FILTER_PROTOCOL
: {

968 ià(
Ëngth
 < 14è 
çl£
;

969 
ušt16_t
 
‘h”ty³
 = (
·ck‘
[12] << 8) |…acket[13];

970  (
‘h”ty³
 & 
f‹r
->
mask
è=ğ(f‹r->
m©ch_v®ue
 & filter->mask);

973 
PROMISC_FILTER_MAC_SRC
:

974 ià(
Ëngth
 < 12è 
çl£
;

975  
	`memcmp
(
·ck‘
 + 6, 
f‹r
->
mac_addr
, 
ETH_ALEN
) == 0;

977 
PROMISC_FILTER_MAC_DST
:

978 ià(
Ëngth
 < 6è 
çl£
;

979  
	`memcmp
(
·ck‘
, 
f‹r
->
mac_addr
, 
ETH_ALEN
) == 0;

981 
PROMISC_FILTER_LENGTH
:

982  (
Ëngth
 >ğ
f‹r
->
mš_Ëngth
 &&†’gth <ğf‹r->
max_Ëngth
);

984 
PROMISC_FILTER_CONTENT
:

985 ià(
Ëngth
 < 
f‹r
->
·‰”n_Ëngth
è 
çl£
;

986 
i
 = 0; i <ğ
Ëngth
 - 
f‹r
->
·‰”n_Ëngth
; i++) {

987 ià(
	`memcmp
(
·ck‘
 + 
i
, 
f‹r
->
cÚ‹Á_·‰”n
, f‹r->
·‰”n_Ëngth
) == 0) {

988  
Œue
;

991  
çl£
;

994  
çl£
;

996 
	}
}

998 
	$´omisc_şassify_ªd_upd©e_¡©s
(cÚ¡ 
ušt8_t
 *
·ck‘
, 
ušt16_t
 
Ëngth
) {

1000 ià(
Ëngth
 < 64) {

1001 
g_´omisc_¡©s
.
und”sized_·ck‘s
++;

1002 } ià(
Ëngth
 > 1514) {

1003 
g_´omisc_¡©s
.
ov”sized_·ck‘s
++;

1007 ià(
Ëngth
 < 14) {

1008 
g_´omisc_¡©s
.
”rÜ_·ck‘s
++;

1010 
	}
}

	@/Users/jvindahl/Development/3com-packet-driver/src/c/stats.c

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~<dos.h
>

14 
	~"../šşude/¡©s.h
"

15 
	~"../šşude/loggšg.h
"

16 
	~"../šşude/h¬dw¬e.h
"

17 
	~"../šşude/commÚ.h
"

20 
driv”_¡©s_t
 
	gglob®_¡©s
 = {0};

21 
nic_¡©s_t
 
	gnic_¡©s
[
MAX_NICS
] = {0};

22 
	g¡©s_š™Ÿlized
 = 0;

23 
ušt32_t
 
	g¡©s_¡¬t_time
 = 0;

28 
ušt32_t
 
	m»gi¡”_»ad_couÁ
;

29 
ušt32_t
 
	m»gi¡”_»ad_”rÜs
;

30 
ušt32_t
 
	m»gi¡”_cÜru±iÚ_ev’ts
;

33 
ušt32_t
 
	mm‘rics_cŞËùiÚ_couÁ
;

34 
ušt32_t
 
	mm‘rics_cŞËùiÚ_”rÜs
;

35 
ušt32_t
 
	mÏ¡_m‘rics_time
;

38 
ušt32_t
 
	m”rÜ_·‰”ns
[
MAX_NICS
][16];

39 
ušt32_t
 
	m”rÜ_bur¡_ev’ts
;

40 
ušt32_t
 
	m”rÜ_Œ’d_chªges
;

43 
ušt32_t
 
	m³ak_memÜy_u§ge
;

44 
ušt32_t
 
	mcu¼’t_memÜy_u§ge
;

45 
ušt32_t
 
	mmemÜy_Ëak_ev’ts
;

48 
ušt32_t
 
	mh—Éh_checks_³rfÜmed
;

49 
ušt32_t
 
	mh—Éh_w¬nšgs_issued
;

50 
ušt32_t
 
	mh—Éh_ü™iÿl_ev’ts
;

53 
ušt32_t
 
	m´ediùiÚ_ÿlcuÏtiÚs
;

54 
ušt32_t
 
	m´ediùiÚ_accu¿cy
;

55 
ušt32_t
 
	m—¾y_w¬nšgs_issued
;

56 } 
	gg_´oduùiÚ_¡©s
 = {0};

62 
ušt32_t
 
	$¡©s_g‘_time¡amp
() {

64  
	`g‘_sy¡em_time¡amp_ms
();

65 
	}
}

72 
	$¡©s_subsy¡em_š™
(cÚ¡ 
cÚfig_t
 *
cÚfig
) {

73 ià(!
cÚfig
) {

74 
	`log_”rÜ
("stats_subsystem_init: NULL config…arameter");

75  
STATS_ERR_INVALID_PARAM
;

78 
	`log_šfo
("Initializing statistics subsystem with…roduction features");

81 
	`mem£t
(&
glob®_¡©s
, 0, (global_stats));

82 
	`mem£t
(
nic_¡©s
, 0, (nic_stats));

83 
	`mem£t
(&
g_´oduùiÚ_¡©s
, 0, (g_production_stats));

86 
¡©s_¡¬t_time
 = 
	`¡©s_g‘_time¡amp
();

87 
glob®_¡©s
.
¡¬t_time
 = 
¡©s_¡¬t_time
;

88 
g_´oduùiÚ_¡©s
.
Ï¡_m‘rics_time
 = 
¡©s_¡¬t_time
;

90 
¡©s_š™Ÿlized
 = 1;

92 
	`log_šfo
("Statistics subsystem initialized with…roduction monitoring");

94 
	}
}

99 
	$¡©s_šüem’t_tx_·ck‘s
() {

100 ià(
¡©s_š™Ÿlized
) {

101 
glob®_¡©s
.
tx_·ck‘s
++;

103 
	}
}

109 
	$¡©s_add_tx_by‹s
(
ušt32_t
 
by‹s
) {

110 ià(
¡©s_š™Ÿlized
) {

111 
glob®_¡©s
.
tx_by‹s
 +ğ
by‹s
;

113 
	}
}

118 
	$¡©s_šüem’t_tx_”rÜs
() {

119 ià(
¡©s_š™Ÿlized
) {

120 
glob®_¡©s
.
tx_”rÜs
++;

122 
	}
}

127 
	$¡©s_šüem’t_rx_·ck‘s
() {

128 ià(
¡©s_š™Ÿlized
) {

129 
glob®_¡©s
.
rx_·ck‘s
++;

131 
	}
}

137 
	$¡©s_add_rx_by‹s
(
ušt32_t
 
by‹s
) {

138 ià(
¡©s_š™Ÿlized
) {

139 
glob®_¡©s
.
rx_by‹s
 +ğ
by‹s
;

141 
	}
}

146 
	$¡©s_šüem’t_rx_”rÜs
() {

147 ià(
¡©s_š™Ÿlized
) {

148 
glob®_¡©s
.
rx_”rÜs
++;

150 
	}
}

155 
	$¡©s_šüem’t_drİ³d_·ck‘s
() {

156 ià(
¡©s_š™Ÿlized
) {

157 
glob®_¡©s
.
drİ³d_·ck‘s
++;

159 
	}
}

168 
	$¡©s_upd©e_nic
(
nic_id
, 
¡©_ty³
, 
ušt32_t
 
v®ue
) {

169 ià(!
¡©s_š™Ÿlized
) {

170  
STATS_ERR_NOT_INITIALIZED
;

173 ià(
nic_id
 < 0 ||‚ic_id >ğ
MAX_NICS
) {

174  
STATS_ERR_INVALID_NIC
;

178 
¡©_ty³
) {

179 
STAT_TYPE_TX_PACKETS
:

180 
nic_¡©s
[
nic_id
].
tx_·ck‘s
 +ğ
v®ue
;

182 
STAT_TYPE_TX_BYTES
:

183 
nic_¡©s
[
nic_id
].
tx_by‹s
 +ğ
v®ue
;

185 
STAT_TYPE_TX_ERRORS
:

186 
nic_¡©s
[
nic_id
].
tx_”rÜs
 +ğ
v®ue
;

188 
STAT_TYPE_RX_PACKETS
:

189 
nic_¡©s
[
nic_id
].
rx_·ck‘s
 +ğ
v®ue
;

191 
STAT_TYPE_RX_BYTES
:

192 
nic_¡©s
[
nic_id
].
rx_by‹s
 +ğ
v®ue
;

194 
STAT_TYPE_RX_ERRORS
:

195 
nic_¡©s
[
nic_id
].
rx_”rÜs
 +ğ
v®ue
;

197 
STAT_TYPE_COLLISIONS
:

198 
nic_¡©s
[
nic_id
].
cŞlisiÚs
 +ğ
v®ue
;

200 
STAT_TYPE_CRC_ERRORS
:

201 
nic_¡©s
[
nic_id
].
üc_”rÜs
 +ğ
v®ue
;

204 
	`log_w¬nšg
("UnknowÀ¡©i¡iøty³: %d", 
¡©_ty³
);

205  
STATS_ERR_INVALID_TYPE
;

209 
nic_¡©s
[
nic_id
].
Ï¡_aùiv™y
 = 
	`¡©s_g‘_time¡amp
();

212 
	}
}

219 
	$¡©s_g‘_glob®
(
driv”_¡©s_t
 *
¡©s
) {

220 ià(!
¡©s
) {

221  
STATS_ERR_INVALID_PARAM
;

224 ià(!
¡©s_š™Ÿlized
) {

225  
STATS_ERR_NOT_INITIALIZED
;

229 
glob®_¡©s
.
u±ime
 = 
	`¡©s_g‘_time¡amp
(è- 
¡©s_¡¬t_time
;

231 *
¡©s
 = 
glob®_¡©s
;

233 
	}
}

241 
	$¡©s_g‘_nic
(
nic_id
, 
nic_¡©s_t
 *
¡©s
) {

242 ià(!
¡©s
) {

243  
STATS_ERR_INVALID_PARAM
;

246 ià(!
¡©s_š™Ÿlized
) {

247  
STATS_ERR_NOT_INITIALIZED
;

250 ià(
nic_id
 < 0 ||‚ic_id >ğ
MAX_NICS
) {

251  
STATS_ERR_INVALID_NIC
;

254 *
¡©s
 = 
nic_¡©s
[
nic_id
];

256 
	}
}

262 
	$¡©s_»£t_®l
() {

263 ià(!
¡©s_š™Ÿlized
) {

264  
STATS_ERR_NOT_INITIALIZED
;

267 
	`log_šfo
("Resetting‡ll statistics");

270 
ušt32_t
 
¡¬t_time
 = 
glob®_¡©s
.start_time;

271 
	`mem£t
(&
glob®_¡©s
, 0, (global_stats));

272 
glob®_¡©s
.
¡¬t_time
 = start_time;

275 
	`mem£t
(
nic_¡©s
, 0, (nic_stats));

278 
	}
}

285 
	$¡©s_»£t_nic
(
nic_id
) {

286 ià(!
¡©s_š™Ÿlized
) {

287  
STATS_ERR_NOT_INITIALIZED
;

290 ià(
nic_id
 < 0 ||‚ic_id >ğ
MAX_NICS
) {

291  
STATS_ERR_INVALID_NIC
;

294 
	`log_debug
("Re£‰šg sti¡ic fÜ NIC %d", 
nic_id
);

295 
	`mem£t
(&
nic_¡©s
[
nic_id
], 0, (nic_stats[nic_id]));

298 
	}
}

303 
	$¡©s_´št_glob®
() {

304 
driv”_¡©s_t
 
¡©s
;

305 
ušt32_t
 
u±ime_£cÚds
;

307 ià(
	`¡©s_g‘_glob®
(&
¡©s
) < 0) {

308 
	`log_”rÜ
("Failedo get global statistics");

312 
u±ime_£cÚds
 = 
¡©s
.
u±ime
 / 18;

314 
	`log_šfo
("=== Global Driver Statistics ===");

315 
	`log_šfo
("U±ime: %lu secÚds", 
u±ime_£cÚds
);

316 
	`log_šfo
("TX: %lu…ackets, %lu bytes, %luƒrrors",

317 
¡©s
.
tx_·ck‘s
, sts.
tx_by‹s
, sts.
tx_”rÜs
);

318 
	`log_šfo
("RX: %lu…ackets, %lu bytes, %luƒrrors",

319 
¡©s
.
rx_·ck‘s
, sts.
rx_by‹s
, sts.
rx_”rÜs
);

320 
	`log_šfo
("Drİ³d: %lu…ack‘s", 
¡©s
.
drİ³d_·ck‘s
);

321 
	`log_šfo
("IÁ”ru±s: %lu", 
¡©s
.
š‹¼u±s_hªdËd
);

322 
	`log_šfo
("MemÜy‡Îoÿ‹d: %lu by‹s", 
¡©s
.
memÜy_®loÿ‹d
);

323 
	}
}

329 
	$¡©s_´št_nic
(
nic_id
) {

330 
nic_¡©s_t
 
¡©s
;

332 ià(
	`¡©s_g‘_nic
(
nic_id
, &
¡©s
) < 0) {

333 
	`log_”rÜ
("FaedØg‘ sti¡ic fÜ NIC %d", 
nic_id
);

337 
	`log_šfo
("==ğNIC %d Sti¡ic ===", 
nic_id
);

338 
	`log_šfo
("TX: %lu…ackets, %lu bytes, %luƒrrors",

339 
¡©s
.
tx_·ck‘s
, sts.
tx_by‹s
, sts.
tx_”rÜs
);

340 
	`log_šfo
("RX: %lu…ackets, %lu bytes, %luƒrrors",

341 
¡©s
.
rx_·ck‘s
, sts.
rx_by‹s
, sts.
rx_”rÜs
);

342 
	`log_šfo
("Collisions: %lu, CRCƒrrors: %lu",

343 
¡©s
.
cŞlisiÚs
, sts.
üc_”rÜs
);

344 
	`log_šfo
("Frameƒrrors: %lu, Overruns: %lu",

345 
¡©s
.
äame_”rÜs
, sts.
ov”run_”rÜs
);

346 
	`log_šfo
("La¡‡ùiv™y: %lu", 
¡©s
.
Ï¡_aùiv™y
);

347 
	}
}

352 
	$¡©s_´št_®l
() {

353 
i
, 
num_nics
;

355 ià(!
¡©s_š™Ÿlized
) {

356 
	`log_”rÜ
("Statistics‚ot initialized");

361 
	`¡©s_´št_glob®
();

364 
num_nics
 = 
	`h¬dw¬e_g‘_nic_couÁ
();

365 
i
 = 0; i < 
num_nics
 && i < 
MAX_NICS
; i++) {

366 
	`¡©s_´št_nic
(
i
);

368 
	}
}

374 
	$¡©s_is_š™Ÿlized
() {

375  
¡©s_š™Ÿlized
;

376 
	}
}

381 
	$¡©s_šüem’t_š‹¼u±s
() {

382 ià(
¡©s_š™Ÿlized
) {

383 
glob®_¡©s
.
š‹¼u±s_hªdËd
++;

385 
	}
}

391 
	$¡©s_upd©e_memÜy
(
št32_t
 
by‹s
) {

392 ià(
¡©s_š™Ÿlized
) {

393 ià(
by‹s
 > 0) {

394 
glob®_¡©s
.
memÜy_®loÿ‹d
 +ğ
by‹s
;

395 } ià(
by‹s
 < 0 && 
glob®_¡©s
.
memÜy_®loÿ‹d
 >ğ(
ušt32_t
)(-bytes)) {

396 
glob®_¡©s
.
memÜy_®loÿ‹d
 -ğ(
ušt32_t
)(-
by‹s
);

399 
	}
}

405 
	$¡©s_ş—nup
() {

406 ià(!
¡©s_š™Ÿlized
) {

411 
	`log_šfo
("Cleaning up statistics subsystem");

414 
	`¡©s_´št_®l
();

416 
¡©s_š™Ÿlized
 = 0;

418 
	`log_šfo
("Statistics cleanup completed");

420 
	}
}

428 
	$¡©s_»ad_h¬dw¬e_»gi¡”s
(
nic_id
, 
h¬dw¬e_»gi¡”_¡©s_t
 *
»g_¡©s
) {

429 
nic_šfo_t
 *
nic
;

430 
ušt32_t
 
»gi¡”s
[32];

431 
»g_couÁ
 = 0;

433 ià(!
»g_¡©s
 || 
nic_id
 < 0 ||‚ic_id >ğ
MAX_NICS
) {

434  
STATS_ERR_INVALID_PARAM
;

437 
nic
 = 
	`h¬dw¬e_g‘_nic
(
nic_id
);

438 ià(!
nic
 || !Òic->
¡©us
 & 
NIC_STATUS_PRESENT
)) {

439  
STATS_ERR_INVALID_NIC
;

442 
g_´oduùiÚ_¡©s
.
»gi¡”_»ad_couÁ
++;

444 
	`mem£t
(
»g_¡©s
, 0, (
h¬dw¬e_»gi¡”_¡©s_t
));

447 
nic
->
ty³
) {

448 
NIC_TYPE_3C509B
:

450 ià(
nic
->
İs
 &&‚ic->
io_ba£
) {

452 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x0E);

453 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x0C);

454 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x08);

455 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x04);

458 
	`outw
(
nic
->
io_ba£
 + 0x0C, 0x0800 | 1);

459 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x0A);

460 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x0B);

463 
	`outw
(
nic
->
io_ba£
 + 0x0C, 0x0800 | 6);

464 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x00);

465 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x01);

466 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x02);

467 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x03);

468 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x04);

469 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x05);

470 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x06);

471 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x07);

472 
»gi¡”s
[
»g_couÁ
++] = 
	`šb
(
nic
->
io_ba£
 + 0x08);

475 
	`outw
(
nic
->
io_ba£
 + 0x0C, 0x0800 | 1);

479 
NIC_TYPE_3C515_TX
:

481 ià(
nic
->
İs
 &&‚ic->
io_ba£
) {

482 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x0E);

483 
»gi¡”s
[
»g_couÁ
++] = 
	`šl
(
nic
->
io_ba£
 + 0x24);

484 
»gi¡”s
[
»g_couÁ
++] = 
	`šl
(
nic
->
io_ba£
 + 0x38);

485 
»gi¡”s
[
»g_couÁ
++] = 
	`šw
(
nic
->
io_ba£
 + 0x20);

490 
	`log_w¬nšg
("UnknowÀNICy³ fÜ„egi¡”„—dšg: %d", 
nic
->
ty³
);

491 
g_´oduùiÚ_¡©s
.
»gi¡”_»ad_”rÜs
++;

492  
STATS_ERR_INVALID_NIC
;

496 ià(!
	`¡©s_v®id©e_»gi¡”_d©a
(
»gi¡”s
, 
»g_couÁ
)) {

497 
g_´oduùiÚ_¡©s
.
»gi¡”_cÜru±iÚ_ev’ts
++;

498 
g_´oduùiÚ_¡©s
.
»gi¡”_»ad_”rÜs
++;

499 
	`log_w¬nšg
("Regi¡” cÜru±iÚ d‘eùed oÀNIC %d", 
nic_id
);

500  
STATS_ERR_INVALID_PARAM
;

504 
»g_¡©s
->
nic_id
 =‚ic_id;

505 
»g_¡©s
->
time¡amp
 = 
	`¡©s_g‘_time¡amp
();

506 
»g_¡©s
->
»gi¡”_couÁ
 = 
»g_couÁ
;

509 
cİy_couÁ
 = (
»g_couÁ
 < 32è?„eg_couÁ : 32;\
n
 
i
 = 0; i < cİy_couÁ; i++è{\À
»g_¡©s
->
»gi¡”_v®ues
[i] = 
»gi¡”s
[i];\À}\À\À \À»g_¡©s->
tx_aùive
 = (»gi¡”s[0] & 0x1000è!ğ0; \À»g_¡©s->
rx_aùive
 = (»gi¡”s[0] & 0x2000è!ğ0; \À»g_¡©s->
”rÜ_æags
 =„egi¡”s[0] & 0x00FF; \À\ÀiàÔeg_couÁ >ğ5è{\À»g_¡©s->
tx_by‹s_ok
 =„egi¡”s[4];\À»g_¡©s->
rx_by‹s_ok
 =„egi¡”s[5];\À}\À\À
	`log_Œaû
(\"Read %d hardware„egisters from NIC %d\",„eg_count,‚ic_id);\n„eturn STATS_SUCCESS;\n}\n\n/**\n * @brief Collect„eal-time…erformance metrics\n * @param‚ic_id NIC identifier\n * @param metrics Pointero store…erformance metrics\n * @return 0 on success,‚egative onƒrror\n */\nstatic int stats_collect_realtime_metrics(int‚ic_id,„ealtime_performance_metrics_t *metrics) {\n‚ic_info_t *nic;\n uint32_t current_time;\n hardware_register_stats_t„eg_stats;\n int„esult;\n \n if (!metrics ||‚ic_id < 0 ||‚ic_id >= MAX_NICS) {\n„eturn STATS_ERR_INVALID_PARAM;\n }\n \n‚ic = hardware_get_nic(nic_id);\n if (!nic) {\n„eturn STATS_ERR_INVALID_NIC;\n }\n \n current_time = stats_get_timestamp();\n g_production_stats.metrics_collection_count++;\n \n memset(metrics, 0, sizeof(realtime_performance_metrics_t));\n \n /* Read hardware„egisters first */\n„esult = stats_read_hardware_registers(nic_id, &reg_stats);\n if (result != STATS_SUCCESS) {\n g_production_stats.metrics_collection_errors++;\n†og_warning(\"Failedo„ead hardware„egisters for metrics collection\");\n„eturn„esult;\n }\n \n /* Fill basic information */\n metrics->nic_id =‚ic_id;\n metrics->timestamp = current_time;\n metrics->collection_interval = current_time - g_production_stats.last_metrics_time;\n \n /* Calculatehroughput metrics */\n if (nic->tx_packets > 0) {\n uint32_t uptime = current_time - stats_start_time;\n if (uptime > 0) {\n metrics->tx_packets_per_sec = (nic->tx_packets * 1000) / uptime;\n metrics->rx_packets_per_sec = (nic->rx_packets * 1000) / uptime;\n metrics->tx_bytes_per_sec = (nic->tx_bytes * 1000) / uptime;\n metrics->rx_bytes_per_sec = (nic->rx_bytes * 1000) / uptime;\n }\n }\n \n /* Calculateƒrror„ates */\n if (nic->tx_packets > 0) {\n metrics->tx_error_rate = (nic->tx_errors * 10000) /‚ic->tx_packets; /* Per 10k */\n }\n if (nic->rx_packets > 0) {\n metrics->rx_error_rate = (nic->rx_errors * 10000) /‚ic->rx_packets;\n }\n \n /* Network utilizationƒstimate */\n uint32_total_bits = (nic->tx_bytes +‚ic->rx_bytes) * 8;\n uint32_t uptime_sec = (current_time - stats_start_time) / 1000;\n if (uptime_sec > 0) {\n uint32_t max_bits = (nic->speed * 1000000UL) * uptime_sec;\n if (max_bits > 0) {\n metrics->network_utilization = (total_bits * 100) / max_bits;\n }\n }\n \n /* Link quality‡ssessment */\n metrics->link_quality = 100; /* Start with…erfect */\n if (!nic->link_up) {\n metrics->link_quality = 0;\n }ƒlse {\n /* Deduct forƒrrors */\n if (metrics->tx_error_rate > 100) metrics->link_quality -= 20;\n if (metrics->rx_error_rate > 100) metrics->link_quality -= 20;\n if (nic->interrupts > 1000) metrics->link_quality -= 10; /* High interrupt†oad */\n }\n \n /* Memory usage from hardware„egisters */\n if (reg_stats.register_count >= 3) {\n metrics->memory_usage =„eg_stats.register_values[2]; /* TX Free„egister */\n }\n \n /* Temperatureƒstimation (simplified) */\n metrics->temperature_estimate = 25 + (nic->error_count / 100); /* Roughƒstimate */\n \n /* Power consumptionƒstimate */\n metrics->power_consumption = 500; /* Base 500mW */\n if (nic->link_up) metrics->power_consumption += 200;\n if (nic->status & NIC_STATUS_100MBPS) metrics->power_consumption += 300;\n \n g_production_stats.last_metrics_time = current_time;\n \n†og_debug(\"Collected„eal-time metrics for NIC %d: util=%d%%, quality=%d%%\",\n‚ic_id, metrics->network_utilization, metrics->link_quality);\n \n„eturn STATS_SUCCESS;\n}\n\n/**\n * @brief Analyzeƒrror…atterns for…redictive maintenance\n * @param‚ic_id NIC identifier\n * @param‡nalysis Pointero storeƒrror‡nalysis\n * @return 0 on success,‚egative onƒrror\n */\nstatic int stats_analyze_error_patterns(int‚ic_id,ƒrror_pattern_analysis_t *analysis) {\n‚ic_info_t *nic;\n uint32_t *patterns;\n uint32_t current_time;\n \n if (!analysis ||‚ic_id < 0 ||‚ic_id >= MAX_NICS) {\n„eturn STATS_ERR_INVALID_PARAM;\n }\n \n‚ic = hardware_get_nic(nic_id);\n if (!nic) {\n„eturn STATS_ERR_INVALID_NIC;\n }\n \n current_time = stats_get_timestamp();\n…atterns = g_production_stats.error_patterns[nic_id];\n \n memset(analysis, 0, sizeof(error_pattern_analysis_t));\n \n‡nalysis->nic_id =‚ic_id;\n‡nalysis->timestamp = current_time;\n \n /* Analyzeƒrrorrends */\n‡nalysis->total_errors =‚ic->tx_errors +‚ic->rx_errors +‚ic->error_count;\n \n /* Check forƒrror bursts */\n‡nalysis->error_burst_detected = stats_detect_error_burst(nic_id);\n if (analysis->error_burst_detected) {\n g_production_stats.error_burst_events++;\n†og_warning(\"Error burst detected on NIC %d\",‚ic_id);\n }\n \n /* Calculateƒrrorrend */\n‡nalysis->error_trend = stats_calculate_trend(patterns, 16);\n \n /* Failure…robability‡ssessment */\n‡nalysis->failure_probability = 0;\n if (analysis->total_errors > 1000)‡nalysis->failure_probability += 20;\n if (analysis->error_burst_detected)‡nalysis->failure_probability += 30;\n if (!nic->link_up)‡nalysis->failure_probability += 40;\n if (nic->error_count > 50)‡nalysis->failure_probability += 25;\n \n /* Cap‡t 100% */\n if (analysis->failure_probability > 100) {\n‡nalysis->failure_probability = 100;\n }\n \n /* Timeo‚ext failureƒstimate (hours) */\n if (analysis->failure_probability > 80) {\n‡nalysis->time_to_failure_hours = 1;\n }ƒlse if (analysis->failure_probability > 50) {\n‡nalysis->time_to_failure_hours = 24;\n }ƒlse if (analysis->failure_probability > 20) {\n‡nalysis->time_to_failure_hours = 168; /* 1 week */\n }ƒlse {\n‡nalysis->time_to_failure_hours = 8760; /* 1 year */\n }\n \n /* Recommended‡ctions */\n if (analysis->failure_probability > 75) {\n snprintf(analysis->recommended_action, sizeof(analysis->recommended_action),\n \"URGENT: Replace NIC %d immediately\",‚ic_id);\n }ƒlse if (analysis->failure_probability > 50) {\n snprintf(analysis->recommended_action, sizeof(analysis->recommended_action),\n \"Schedule NIC %d„eplacement within 24 hours\",‚ic_id);\n }ƒlse if (analysis->failure_probability > 25) {\n snprintf(analysis->recommended_action, sizeof(analysis->recommended_action),\n \"Monitor NIC %d closely, schedule maintenance\",‚ic_id);\n }ƒlse {\n snprintf(analysis->recommended_action, sizeof(analysis->recommended_action),\n \"NIC %d operating‚ormally\",‚ic_id);\n }\n \n†og_debug(\"Error‡nalysis for NIC %d: failure_prob=%d%%,tf=%d hours\",\n‚ic_id,‡nalysis->failure_probability,‡nalysis->time_to_failure_hours);\n \n„eturn STATS_SUCCESS;\n}\n\n/**\n * @brief Track memory usage statistics\n * @param mem_stats Pointero store memory statistics\n * @return 0 on success,‚egative onƒrror\n */\nstatic int stats_track_memory_usage(memory_usage_stats_t *mem_stats) {\n uint32_t current_usage;\n \n if (!mem_stats) {\n„eturn STATS_ERR_INVALID_PARAM;\n }\n \n /* Get current memory usage from global stats */\n current_usage = global_stats.memory_allocated;\n g_production_stats.current_memory_usage = current_usage;\n \n /* Update…eak if‚ecessary */\n if (current_usage > g_production_stats.peak_memory_usage) {\n g_production_stats.peak_memory_usage = current_usage;\n }\n \n memset(mem_stats, 0, sizeof(memory_usage_stats_t));\n \n mem_stats->timestamp = stats_get_timestamp();\n mem_stats->current_usage = current_usage;\n mem_stats->peak_usage = g_production_stats.peak_memory_usage;\n mem_stats->leak_events = g_production_stats.memory_leak_events;\n \n /* Calculate fragmentationƒstimate */\n mem_stats->fragmentation_percent = 5; /* Simplifiedƒstimate */\n \n /* Memoryƒfficiency */\n if (g_production_stats.peak_memory_usage > 0) {\n mem_stats->efficiency_percent = \n (current_usage * 100) / g_production_stats.peak_memory_usage;\n }ƒlse {\n mem_stats->efficiency_percent = 100;\n }\n \n /* Available memoryƒstimate */\n mem_stats->available_memory = 65536 - current_usage; /* 64KB system‡ssumption */\n \n /* Memory health score */\n mem_stats->health_score = 100;\n if (mem_stats->fragmentation_percent > 20) mem_stats->health_score -= 20;\n if (mem_stats->efficiency_percent < 50) mem_stats->health_score -= 30;\n if (mem_stats->leak_events > 0) mem_stats->health_score -= 25;\n \n /* Memory…ressure†evel */\n if (current_usage > 50000) {\n mem_stats->pressure_level = 3; /* Critical */\n }ƒlse if (current_usage > 30000) {\n mem_stats->pressure_level = 2; /* High */\n }ƒlse if (current_usage > 15000) {\n mem_stats->pressure_level = 1; /* Medium */\n }ƒlse {\n mem_stats->pressure_level = 0; /* Low */\n }\n \n†og_trace(\"Memory usage: %lu bytes (peak: %lu),ƒfficiency: %d%%\",\n current_usage, g_production_stats.peak_memory_usage, \n mem_stats->efficiency_percent);\n \n„eturn STATS_SUCCESS;\n}\n\n/**\n * @brief Monitor overall‚etwork health\n * @param health Pointero store health statistics\n * @return 0 on success,‚egative onƒrror\n */\nstatic int stats_monitor_network_health(network_health_stats_t *health) {\n intotal_nics,‡ctive_nics, healthy_nics;\n uint32_total_errors,otal_packets;\n \n if (!health) {\n„eturn STATS_ERR_INVALID_PARAM;\n }\n \n g_production_stats.health_checks_performed++;\n \n memset(health, 0, sizeof(network_health_stats_t));\n \n health->timestamp = stats_get_timestamp();\n \n /* Count NICs‡nd‡ssess health */\notal_nics = hardware_get_nic_count();\n‡ctive_nics = 0;\n healthy_nics = 0;\notal_errors = 0;\notal_packets = 0;\n \n for (int i = 0; i <otal_nics && i < MAX_NICS; i++) {\n‚ic_info_t *nic = hardware_get_nic(i);\n if (nic && (nic->status & NIC_STATUS_PRESENT)) {\n if (nic->status & NIC_STATUS_ACTIVE) {\n‡ctive_nics++;\n \n /* Consider healthy ifƒrror„ate < 1% */\n uint32_t‚ic_errors =‚ic->tx_errors +‚ic->rx_errors;\n uint32_t‚ic_packets =‚ic->tx_packets +‚ic->rx_packets;\n \n if (nic_packets > 0) {\n uint32_tƒrror_rate = (nic_errors * 100) /‚ic_packets;\n if (error_rate < 1 &&‚ic->link_up) {\n healthy_nics++;\n }\n }\n \notal_errors +=‚ic_errors;\notal_packets +=‚ic_packets;\n }\n }\n }\n \n health->total_nics =otal_nics;\n health->active_nics =‡ctive_nics;\n health->healthy_nics = healthy_nics;\n \n /* Overall health score */\n health->overall_health_score = 0;\n if (total_nics > 0) {\n health->overall_health_score = (healthy_nics * 100) /otal_nics;\n }\n \n /* Network‡vailability */\n health->network_availability = 0;\n if (total_nics > 0) {\n health->network_availability = (active_nics * 100) /otal_nics;\n }\n \n /* Totalƒrror„ate */\n if (total_packets > 0) {\n health->total_error_rate = (total_errors * 10000) /otal_packets; /* Per 10k */\n }\n \n /* Issue warnings‡nd‡lerts */\n if (health->overall_health_score < 50) {\n g_production_stats.health_critical_events++;\n†og_error(\"CRITICAL: Network health below 50%% (score: %d%%)\",\n health->overall_health_score);\n health->alert_level = 3;\n }ƒlse if (health->overall_health_score < 75) {\n g_production_stats.health_warnings_issued++;\n†og_warning(\"WARNING: Network health degraded (score: %d%%)\",\n health->overall_health_score);\n health->alert_level = 2;\n }ƒlse if (health->overall_health_score < 90) {\n†og_info(\"NOTICE: Network health fair (score: %d%%)\",\n health->overall_health_score);\n health->alert_level = 1;\n }ƒlse {\n health->alert_level = 0;\n }\n \n /* Recovery„ecommendations */\n if (active_nics == 0) {\n snprintf(health->recommendation, sizeof(health->recommendation),\n \"CRITICAL: No‡ctive NICs - check hardware‡nd„estart driver\");\n }ƒlse if (healthy_nics <‡ctive_nics / 2) {\n snprintf(health->recommendation, sizeof(health->recommendation),\n \"Replace failing NICs‡nd check‚etwork infrastructure\");\n }ƒlse if (health->total_error_rate > 100) {\n snprintf(health->recommendation, sizeof(health->recommendation),\n \"Highƒrror„ate detected - check cables‡nd‚etworkƒquipment\");\n }ƒlse {\n snprintf(health->recommendation, sizeof(health->recommendation),\n \"Network operating‚ormally\");\n }\n \n†og_debug(\"Network health: %d%% (%d/%d NICs healthy, %d‡ctive)\",\n health->overall_health_score, healthy_nics,otal_nics,‡ctive_nics);\n \n„eturn STATS_SUCCESS;\n}\n\n/**\n * @brief Predict…otential failures using collected data\n * @param‚ic_id NIC identifier\n * @param…rediction Pointero store…rediction„esults\n * @return 0 on success,‚egative onƒrror\n */\nstatic int stats_predict_failures(int‚ic_id, failure_prediction_t *prediction) {\n‚ic_info_t *nic;\n„ealtime_performance_metrics_t metrics;\nƒrror_pattern_analysis_tƒrror_analysis;\n int„esult;\n \n if (!prediction ||‚ic_id < 0 ||‚ic_id >= MAX_NICS) {\n„eturn STATS_ERR_INVALID_PARAM;\n }\n \n‚ic = hardware_get_nic(nic_id);\n if (!nic) {\n„eturn STATS_ERR_INVALID_NIC;\n }\n \n g_production_stats.prediction_calculations++;\n \n /* Collect current metrics‡ndƒrror…atterns */\n„esult = stats_collect_realtime_metrics(nic_id, &metrics);\n if (result != STATS_SUCCESS) {\n„eturn„esult;\n }\n \n„esult = stats_analyze_error_patterns(nic_id, &error_analysis);\n if (result != STATS_SUCCESS) {\n„eturn„esult;\n }\n \n memset(prediction, 0, sizeof(failure_prediction_t));\n \n…rediction->nic_id =‚ic_id;\n…rediction->timestamp = stats_get_timestamp();\n \n /* Combine various factors for failure…rediction */\n…rediction->failure_probability =ƒrror_analysis.failure_probability;\n \n /* Adjust based on…erformance metrics */\n if (metrics.link_quality < 50) {\n…rediction->failure_probability += 20;\n }\n if (metrics.tx_error_rate > 1000) { /* >10%ƒrror„ate */\n…rediction->failure_probability += 25;\n }\n if (metrics.temperature_estimate > 70) {\n…rediction->failure_probability += 15;\n }\n \n /* Hardware‡ge factor (simplified) */\n uint32_t uptime_hours = (stats_get_timestamp() - stats_start_time) / 3600000;\n if (uptime_hours > 8760) { /* Morehan 1 year */\n…rediction->failure_probability += 10;\n }\n \n /* Cap‡t 100% */\n if (prediction->failure_probability > 100) {\n…rediction->failure_probability = 100;\n }\n \n /* Confidence†evel based on data quality */\n…rediction->confidence_level = 70; /* Base confidence */\n if (nic->tx_packets > 1000)…rediction->confidence_level += 10;\n if (g_production_stats.register_read_count > 100)…rediction->confidence_level += 10;\n if (g_production_stats.metrics_collection_count > 50)…rediction->confidence_level += 10;\n \n /* Timeo failureƒstimate */\n…rediction->time_to_failure_hours =ƒrror_analysis.time_to_failure_hours;\n \n /* Prediction‡ccuracyracking */\n if (prediction->failure_probability > 80) {\n /* High…robability…rediction -rack for‡ccuracy */\n g_production_stats.early_warnings_issued++;\n }\n \n /* Recommended‡ctions */\n if (prediction->failure_probability > 90) {\n snprintf(prediction->recommended_action, sizeof(prediction->recommended_action),\n \"IMMEDIATE: Replace NIC %d - failure imminent\",‚ic_id);\n }ƒlse if (prediction->failure_probability > 70) {\n snprintf(prediction->recommended_action, sizeof(prediction->recommended_action),\n \"URGENT: Schedule NIC %d„eplacement within 24 hours\",‚ic_id);\n }ƒlse if (prediction->failure_probability > 40) {\n snprintf(prediction->recommended_action, sizeof(prediction->recommended_action),\n \"PLANNED: Schedule NIC %d maintenance within 1 week\",‚ic_id);\n }ƒlse {\n snprintf(prediction->recommended_action, sizeof(prediction->recommended_action),\n \"NORMAL: NIC %d operating within…arameters\",‚ic_id);\n }\n \n†og_info(\"Failure…rediction for NIC %d: %d%%…robability (confidence: %d%%)\",\n‚ic_id,…rediction->failure_probability,…rediction->confidence_level);\n \n„eturn STATS_SUCCESS;\n}\n\n/**\n * @brief Updateƒrror…atternracking\n * @param‚ic_id NIC identifier\n * @paramƒrror_type Type ofƒrror\n */\nstatic void stats_update_error_patterns(int‚ic_id, intƒrror_type) {\n if (nic_id < 0 ||‚ic_id >= MAX_NICS ||ƒrror_type < 0 ||ƒrror_type >= 16) {\n„eturn;\n }\n \n g_production_stats.error_patterns[nic_id][error_type]++;\n \n /* Check forrend changes */\n static uint32_t†ast_check[MAX_NICS] = {0};\n uint32_t current_time = stats_get_timestamp();\n \n if (current_time -†ast_check[nic_id] > 60000) { /* Checkƒvery minute */\n uint32_trend = stats_calculate_trend(g_production_stats.error_patterns[nic_id], 16);\n static uint32_t†ast_trend[MAX_NICS] = {0};\n \n if (trend !=†ast_trend[nic_id]) {\n g_production_stats.error_trend_changes++;\n†ast_trend[nic_id] =rend;\n }\n \n†ast_check[nic_id] = current_time;\n }\n}\n\n/**\n * @brief Detectƒrror burst conditions\n * @param‚ic_id NIC identifier\n * @returnrue ifƒrror burst detected\n */\nstatic bool stats_detect_error_burst(int‚ic_id) {\n‚ic_info_t *nic;\n static uint32_t†ast_error_count[MAX_NICS] = {0};\n static uint32_t†ast_check_time[MAX_NICS] = {0};\n uint32_t current_time, current_errors;\n \n if (nic_id < 0 ||‚ic_id >= MAX_NICS) {\n„eturn false;\n }\n \n‚ic = hardware_get_nic(nic_id);\n if (!nic) {\n„eturn false;\n }\n \n current_time = stats_get_timestamp();\n current_errors =‚ic->tx_errors +‚ic->rx_errors +‚ic->error_count;\n \n /* Check if we've seen‡ significant increase inƒrrors in shortime */\n if (current_time -†ast_check_time[nic_id] > 5000) { /* 5 second window */\n uint32_tƒrror_increase = current_errors -†ast_error_count[nic_id];\n \n /* Burst if morehan 10ƒrrors in 5 seconds */\n if (error_increase > 10) {\n†ast_error_count[nic_id] = current_errors;\n†ast_check_time[nic_id] = current_time;\n„eturnrue;\n }\n \n†ast_error_count[nic_id] = current_errors;\n†ast_check_time[nic_id] = current_time;\n }\n \n„eturn false;\n}\n\n/**\n * @brief Validate„egister data for corruption\n * @param„egisters Array of„egister values\n * @param count Number of„egisters\n * @returnrue if data‡ppears valid\n */\nstatic bool stats_validate_register_data(uint32_t *registers, int count) {\n if (!registers || count <= 0) {\n„eturn false;\n }\n \n /* Basic validation - check for‡ll 0xFF or 0x00 (likely hardware failure) */\n bool‡ll_zeros =rue;\n bool‡ll_ones =rue;\n \n for (int i = 0; i < count; i++) {\n if (registers[i] != 0)‡ll_zeros = false;\n if (registers[i] != 0xFFFFFFFF)‡ll_ones = false;\n }\n \n /* If‡ll„egisters‡rehe same suspicious value,†ikely corruption */\n if (all_zeros ||‡ll_ones) {\n„eturn false;\n }\n \n„eturnrue;\n}\n\n/**\n * @brief Log…erformance‡nomaly\n * @param‚ic_id NIC identifier\n * @param description Anomaly description\n */\nstatic void stats_log_performance_anomaly(int‚ic_id, const char *description) {\n†og_warning(\"Performance‡nomaly on NIC %d: %s\",‚ic_id, description);\n \n /* Could beƒxtendedo maintain‡n‡nomaly†og */\n}\n\n/**\n * @brief Calculaterend from series of values\n * @param values Array of values\n * @param count Number of values\n * @return Trend indicator\n */\nstatic uint32_t stats_calculate_trend(uint32_t *values, int count) {\n if (!values || count < 2) {\n„eturn 0;\n }\n \n /* Simplerend calculation - compare„ecent vs older values */\n uint32_t„ecent_sum = 0;\n uint32_t older_sum = 0;\n int half = count / 2;\n \n for (int i = 0; i < half; i++) {\n older_sum += values[i];\n }\n \n for (int i = half; i < count; i++) {\n„ecent_sum += values[i];\n }\n \n /* Returnrend‡s…ercentage change */\n if (older_sum > 0) {\n„eturn (recent_sum * 100) / older_sum;\n }\n \n„eturn 100; /* No change */\n}\n\n/**\n * @brief Get comprehensive…roduction statistics\n * @param stats Pointero store…roduction statistics\n * @return 0 on success,‚egative onƒrror\n */\nint stats_get_production_stats(production_stats_summary_t *stats) {\n if (!stats) {\n„eturn STATS_ERR_INVALID_PARAM;\n }\n \n if (!stats_initialized) {\n„eturn STATS_ERR_NOT_INITIALIZED;\n }\n \n memset(stats, 0, sizeof(production_stats_summary_t));\n \n stats->timestamp = stats_get_timestamp();\n \n /* Copy…roduction statistics */\n stats->register_reads = g_production_stats.register_read_count;\n stats->register_errors = g_production_stats.register_read_errors;\n stats->metrics_collections = g_production_stats.metrics_collection_count;\n stats->health_checks = g_production_stats.health_checks_performed;\n stats->predictions_made = g_production_stats.prediction_calculations;\n stats->early_warnings = g_production_stats.early_warnings_issued;\n \n stats->error_bursts = g_production_stats.error_burst_events;\n stats->corruption_events = g_production_stats.register_corruption_events;\n stats->memory_leaks = g_production_stats.memory_leak_events;\n \n stats->peak_memory = g_production_stats.peak_memory_usage;\n stats->current_memory = g_production_stats.current_memory_usage;\n \n„eturn STATS_SUCCESS;\n}\n\n/**\n * @brief Enhanced NIC statistics update withƒrror…atternracking\n * @param‚ic_id NIC identifier\n * @param stat_type Type of statistic\n * @param value Valueo‡dd\n * @return 0 on success,‚egative onƒrror\n */\nint stats_update_nic_enhanced(int‚ic_id, int stat_type, uint32_t value) {\n int„esult = stats_update_nic(nic_id, stat_type, value);\n \n /* Updateƒrror…atternracking */\n if (stat_type == STAT_TYPE_TX_ERRORS || stat_type == STAT_TYPE_RX_ERRORS) {\n stats_update_error_patterns(nic_id, stat_type);\n }\n \n„eturn„esult;\n}\n\n/**\n * @brief Print comprehensive…roduction statistics\n */\nvoid stats_print_production_summary(void) {\n…roduction_stats_summary_t stats;\n \n if (stats_get_production_stats(&stats) != STATS_SUCCESS) {\n†og_error(\"Failedo get…roduction statistics\");\n„eturn;\n }\n \n†og_info(\"=== Production Statistics Summary ===\");\n†og_info(\"Register Operations: %lu„eads, %luƒrrors\", \n stats.register_reads, stats.register_errors);\n†og_info(\"Metrics Collections: %lu…erformed, %lu health checks\",\n stats.metrics_collections, stats.health_checks);\n†og_info(\"Predictions: %lu made, %luƒarly warnings issued\",\n stats.predictions_made, stats.early_warnings);\n†og_info(\"Error Events: %lu bursts, %lu corruptionƒvents\",\n stats.error_bursts, stats.corruption_events);\n†og_info(\"Memory: %lu current, %lu…eak, %lu†eaks\",\n stats.current_memory, stats.peak_memory, stats.memory_leaks);\n†og_info(\"======================================\");\n}\n\n/**\n * @brief Force health monitoring check on‡ll NICs\n * @return 0 on success,‚egative onƒrror\n */\nint stats_force_health_check(void) {\n‚etwork_health_stats_t health;\n int„esult;\n \n„esult = stats_monitor_network_health(&health);\n if (result == STATS_SUCCESS) {\n†og_info(\"Forced health check: %d%% health score, %d/%d NICs healthy\",\n health.overall_health_score, health.healthy_nics, health.total_nics);\n }\n \n„eturn„esult;\n}

	@
1
.
0
20
1291
/Users/jvindahl/Development/3com-packet-driver/include/3c509b.h
/Users/jvindahl/Development/3com-packet-driver/include/3c515.h
/Users/jvindahl/Development/3com-packet-driver/include/config.h
/Users/jvindahl/Development/3com-packet-driver/include/hardware.h
/Users/jvindahl/Development/3com-packet-driver/include/packet_api.h
/Users/jvindahl/Development/3com-packet-driver/src/asm/hardware.asm
/Users/jvindahl/Development/3com-packet-driver/src/asm/nic_irq.asm
/Users/jvindahl/Development/3com-packet-driver/src/asm/packet_api.asm
/Users/jvindahl/Development/3com-packet-driver/src/c/3c509b.c
/Users/jvindahl/Development/3com-packet-driver/src/c/3c515.c
/Users/jvindahl/Development/3com-packet-driver/src/c/api.c
/Users/jvindahl/Development/3com-packet-driver/src/c/buffer_alloc.c
/Users/jvindahl/Development/3com-packet-driver/src/c/config.c
/Users/jvindahl/Development/3com-packet-driver/src/c/hardware.c
/Users/jvindahl/Development/3com-packet-driver/src/c/media_control.c
/Users/jvindahl/Development/3com-packet-driver/src/c/memory.c
/Users/jvindahl/Development/3com-packet-driver/src/c/nic_init.c
/Users/jvindahl/Development/3com-packet-driver/src/c/packet_ops.c
/Users/jvindahl/Development/3com-packet-driver/src/c/promisc.c
/Users/jvindahl/Development/3com-packet-driver/src/c/stats.c
