# 3cpdinit.lnk - Watcom Linker Directives for Two-Stage Loader
# 3Com Packet Driver - Stage 1 Loader (3CPDINIT.EXE)
# Last Updated: 2026-02-01 21:30:00 CET
#
# Uses overlays to keep each segment under 64K.
# Stage 1 runs all init stages, builds JIT TSR image, installs it
# in an allocated DOS block, then exits normally (no TSR).

SYSTEM dos
NAME build/3cpdinit.exe

# Memory model library (large model)
LIBRARY /Users/johnfabienke/Development/macos-open-watcom/open-watcom-v2/rel/lib286/dos/clibl.lib

# Overlay runtime library
LIBRARY /Users/johnfabienke/Development/macos-open-watcom/open-watcom-v2/rel/lib286/dos/wovl.lib

# Linker options
OPTION map=build/3cpdinit.map
OPTION caseexact
OPTION stack=4096

# Enable overlay system
OPTION DYNAMIC
OPTION AREA=64K

# ============================================================================
# ROOT SEGMENT - Stage 1 entry, orchestrator, JIT engine, module templates
# ============================================================================

# Stage 1 entry point
FILE build/stage1_main.obj

# Init orchestrator (calls overlay stages)
FILE build/init_main.obj

# DOS I/O (custom printf/file I/O via INT 21h)
FILE build/dos_io.obj

# Core ASM modules (JIT templates - need module headers accessible)
FILE build/pktapi.obj
FILE build/nicirq.obj
FILE build/hwsmc.obj
FILE build/pcmisr.obj
FILE build/flowrt.obj
FILE build/dirpio.obj
FILE build/pktops.obj
FILE build/pktcopy.obj
FILE build/tsrcom.obj
FILE build/tsrwrap.obj
FILE build/pci_io.obj
FILE build/pciisr.obj
FILE build/linkasm.obj
FILE build/hwpkt.obj
FILE build/hwcfg.obj
FILE build/hwcoord.obj
FILE build/hwinit.obj
FILE build/hweep.obj
FILE build/hwdma.obj
FILE build/cacheops.obj

# Small ASM modules
FILE build/rt_stubs.obj
FILE build/dos_idle.obj
FILE build/irq_bind.obj
FILE build/rtcfg.obj

# HOT C modules - moved to OVL_FINAL for Stage 1 (no ISR needed)

# Stub implementations (LAST - so real implementations take precedence)
FILE build/linkstubs.obj

# ============================================================================
# OVERLAY AREA - Init stages + JIT engine + module templates
# ============================================================================

BEGIN
    # OVL_BOOT: Entry validation, CPU detection
    SECTION
    FILE build/main.obj
    FILE build/init.obj
    FILE build/entval.obj
    FILE build/cpudet.obj
    FILE build/loader/cpu_detect.obj

    # OVL_PLATFORM: Platform probe, logging init
    SECTION
    FILE build/pltprob.obj
    FILE build/loader/init_stubs.obj

    # OVL_CONFIG: Configuration parsing, chipset detection
    SECTION
    FILE build/config.obj
    FILE build/loader/patch_apply.obj
    FILE build/chipdet.obj
    FILE build/flowctl.obj

    # OVL_DETECT: VDS/DMA, memory, hardware detection
    SECTION
    FILE build/hwdet.obj
    FILE build/hwbus.obj
    FILE build/vds.obj
    FILE build/vds_core.obj
    FILE build/vdssafe.obj
    FILE build/vdsmgr.obj
    FILE build/dmacap.obj
    FILE build/memory.obj
    FILE build/xmsdet.obj
    FILE build/bufaloc.obj
    FILE build/bufauto.obj
    FILE build/pci_bios.obj
    FILE build/3cpcidet.obj
    FILE build/pciintg.obj
    FILE build/pcishme.obj
    FILE build/pnp.obj
    FILE build/eeprom.obj
    FILE build/3cvortex.obj
    FILE build/3cboom.obj
    FILE build/pcipwr.obj

    # OVL_NIC_INIT: NIC driver initialization
    SECTION
    FILE build/hardware_init.obj
    FILE build/3c509b_init.obj
    FILE build/3c515_init.obj
    FILE build/nic_init.obj
    FILE build/pcirst.obj

    # OVL_HOT_C: HOT C modules (init-time only in Stage 1)
    SECTION
    FILE build/api.obj
    FILE build/routing.obj
    FILE build/pci_shim.obj
    FILE build/pcimux.obj
    FILE build/dmamap.obj
    FILE build/dmabnd.obj
    FILE build/hwchksm.obj
    FILE build/irqmit.obj
    FILE build/rxbatch.obj
    FILE build/txlazy.obj
    FILE build/xms_core.obj
    FILE build/pktops_c.obj

    # OVL_FINAL: DMA buffers, TSR build, API install + JIT engine
    SECTION
    FILE build/mod_select.obj
    FILE build/jit_build.obj
    FILE build/jit_patch.obj
    FILE build/jit_reloc.obj
    FILE build/pktops_init.obj
    FILE build/dmamap_init.obj
    FILE build/api_init.obj
    FILE build/dmabnd_init.obj
    FILE build/pci_shim_init.obj
    FILE build/hwchksm_init.obj
    FILE build/logging_init.obj
    FILE build/xms_core_init.obj
    FILE build/irqmit_init.obj
    FILE build/rxbatch_init.obj
    FILE build/txlazy_init.obj
    FILE build/pcimux_init.obj
    FILE build/dmatest.obj
    FILE build/dmasafe.obj
    FILE build/dmapol.obj
    FILE build/tsrmgr.obj
    FILE build/umbldr.obj
    FILE build/quiesce.obj
    FILE build/safestub.obj
    FILE build/smcpat.obj
    FILE build/smcpat_c.obj
    FILE build/statrt.obj
    FILE build/arp.obj
    FILE build/stats.obj
    FILE build/diag.obj
    FILE build/pcmmgr.obj
    FILE build/pcmsnap.obj
    FILE build/pcmpebe.obj
    FILE build/pcmssbe.obj
    FILE build/extapi.obj
    FILE build/unwind.obj
    FILE build/promisc.obj
    FILE build/bmtest.obj
    FILE build/smcserl.obj
    FILE build/cachemgt.obj
END

# ============================================================================
# JIT Module Templates (ROOT - hot sections copied into TSR image)
# ============================================================================
FILE build/mod_isr.obj
FILE build/mod_irq.obj
FILE build/mod_pktbuf.obj
FILE build/mod_data.obj
FILE build/mod_3c509b_rt.obj
FILE build/mod_3c515_rt.obj
FILE build/mod_vortex_rt.obj
FILE build/mod_boom_rt.obj
FILE build/mod_cyclone_rt.obj
FILE build/mod_tornado_rt.obj
FILE build/mod_pio.obj
FILE build/mod_dma_isa.obj
FILE build/mod_dma_busmaster.obj
FILE build/mod_dma_descring.obj
FILE build/mod_dma_bounce.obj
FILE build/mod_cache_none.obj
FILE build/mod_cache_wbinvd.obj
FILE build/mod_cache_clflush.obj
FILE build/mod_cache_snoop.obj
FILE build/mod_copy_8086.obj
FILE build/mod_copy_286.obj
FILE build/mod_copy_386.obj
FILE build/mod_copy_pent.obj

# CRT replacement module
FILE build/tsr_crt.obj
