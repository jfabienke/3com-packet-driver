# 3cpd.lnk - Watcom Linker Directives for Overlay System
# 3Com Packet Driver - 16-bit DOS Memory Optimization
# Last Updated: 2026-01-28 11:20:00 UTC
# Phase 6: Expanded 6-overlay structure with split NIC drivers
#
# This file defines the Watcom overlay system structure:
# - ROOT SEGMENT: Always resident (ISR-safe code, ~60-80 KB)
# - OVERLAY AREA: Init stages (loaded/discarded, ~50 KB peak)
#
# After initialization completes, the overlay area is freed via
# DOS INT 21h/4Ah, leaving only the ROOT segment resident as a TSR.

SYSTEM dos
NAME build/3cpd.exe

# Memory model library (large model for code+data > 64KB)
LIBRARY /Users/johnfabienke/Development/macos-open-watcom/open-watcom-v2/rel/lib286/dos/clibl.lib

# Linker options
OPTION map=build/3cpd.map
OPTION caseexact
OPTION stack=1024

# Enable overlay system - Watcom dynamic overlay manager
OPTION DYNAMIC
OPTION AREA=64K

# ============================================================================
# ROOT SEGMENT - Always Resident (ISR-Safe Code)
# These files are NEVER overlaid - they must be available during interrupts
# ============================================================================

# TSR Loader (entry point)
FILE build/tsrldr.obj

# Core Packet API (INT 60h handler) - Split: init moved to OVL_FINAL
FILE build/api_rt.obj
FILE build/pktapi.obj

# Interrupt Handlers (must be resident for ISR)
FILE build/nicirq.obj
FILE build/pcmisr.obj
FILE build/pciisr.obj

# Runtime Packet Operations
FILE build/pktops.obj
FILE build/pktcopy.obj
FILE build/flowrt.obj
FILE build/dirpio.obj

# DMA Runtime (used during packet operations) - Split: init moved to OVL_FINAL
FILE build/dmamap_rt.obj
FILE build/dmabnd_rt.obj

# TSR Support
FILE build/tsrcom.obj
FILE build/tsrwrap.obj

# Resident I/O
FILE build/pci_io.obj
FILE build/hwsmc.obj

# Resident C modules - Split: init portions moved to OVL_FINAL
FILE build/pci_shim_rt.obj
FILE build/pcimux_rt.obj
FILE build/hwchksm_rt.obj
FILE build/dos_idle.obj
FILE build/irq_bind.obj
FILE build/rtcfg.obj
FILE build/irqmit_rt.obj
FILE build/rxbatch_rt.obj
FILE build/txlazy_rt.obj

# Init Orchestrator (ROOT - calls overlay stages)
FILE build/init_main.obj

# XMS Core runtime (init moved to OVL_FINAL)
FILE build/xms_core_rt.obj

# ASM stub symbols for linking (bridges ASM/C symbol naming)
FILE build/linkasm.obj

# Hardware low-level ASM modules (packet I/O, config, coordination)
FILE build/hwpkt.obj
FILE build/hwcfg.obj
FILE build/hwcoord.obj

# Cache operations (CPU cache control for DMA coherency)
FILE build/cacheops.obj

# Hardware init (3C515 init for recovery - nicirq.asm calls init_3c515)
FILE build/hwinit.obj

# Hardware EEPROM operations (read_3c509b_eeprom, read_3c515_eeprom)
FILE build/hweep.obj

# Hardware DMA operations (dma_stall_engines, dma_unstall_engines)
FILE build/hwdma.obj

# C packet operations - RUNTIME ONLY (packet_receive_process, packet_isr_receive)
# Called by pktops.asm for high-level packet processing
# Split: init functions moved to OVL_FINAL overlay
FILE build/pktops_rt.obj

# ============================================================================
# NIC DRIVERS - RUNTIME ONLY (vtables stored in nic->ops, called at runtime)
# Split drivers: *_rt.obj contains only runtime functions (send/receive/interrupt)
# Init functions moved to OVL_NIC_INIT overlay section
# ============================================================================
FILE build/hardware_rt.obj
FILE build/3c509b_rt.obj
FILE build/3c515_rt.obj
# Vortex/Boomerang moved to OVL_DETECT overlay (PCI detection code, not needed at runtime)

# Logging - Runtime logging functions (init moved to OVL_FINAL)
FILE build/logging_rt.obj

# ============================================================================
# OVERLAY AREA - 6 Init Stages (Expanded structure for reduced ROOT size)
# ============================================================================
# The overlay manager automatically loads/unloads these sections.
# Each SECTION defines a separate overlay that shares the same memory area.
# Having more granular overlays reduces peak memory usage during init.
#
# Structure:
#   OVL_BOOT (stages 0-1): Entry validation, CPU detection (~8 KB)
#   OVL_PLATFORM (stages 2-3): Platform probe, logging init (~6 KB)
#   OVL_CONFIG (stages 4-5): Config parse, chipset detect (~10 KB)
#   OVL_DETECT (stages 6-8): VDS/DMA refine, memory, hardware detect (~15 KB)
#   OVL_NIC_INIT (stage 9): NIC driver initialization functions (~12 KB)
#   OVL_FINAL (stages 10-14): DMA buffers, TSR relocate, API install (~15 KB)

BEGIN
    # OVL_BOOT: Stages 0-1
    # Entry validation, CPU detection
    # First overlay to load - validates environment and detects CPU capabilities
    SECTION
    FILE build/main.obj
    FILE build/init.obj
    FILE build/entval.obj
    FILE build/loader_cpudet.obj
    FILE build/cpudet.obj

    # OVL_PLATFORM: Stages 2-3
    # Platform probe, logging initialization
    # Detects chipset, DMA capabilities, and sets up logging
    SECTION
    FILE build/pltprob.obj
    FILE build/loader_init_stubs.obj

    # OVL_CONFIG: Stages 4-5
    # Configuration parsing, chipset detection
    # Parses command line, config files, and identifies chipset features
    SECTION
    FILE build/config.obj
    FILE build/loader_patch_apply.obj
    FILE build/chipdet.obj
    FILE build/flowctl.obj

    # OVL_DETECT: Stages 6-8
    # VDS/DMA refine, memory init, hardware detection
    # Initializes VDS, DMA subsystem, memory pools, and detects NICs
    SECTION
    FILE build/hwdet.obj
    FILE build/hwbus.obj
    FILE build/vds.obj
    FILE build/vds_core.obj
    FILE build/vdssafe.obj
    FILE build/vdsmgr.obj
    FILE build/dmacap.obj
    FILE build/memory.obj
    FILE build/xmsdet.obj
    FILE build/bufaloc.obj
    FILE build/bufauto.obj
    FILE build/pci_bios.obj
    FILE build/3cpcidet.obj
    FILE build/pciintg.obj
    FILE build/pcishme.obj
    FILE build/pnp.obj
    FILE build/eeprom.obj
    # Vortex/Boomerang PCI NIC detection (moved from ROOT)
    FILE build/3cvortex.obj
    FILE build/3cboom.obj

    # OVL_NIC_INIT: Stage 9
    # NIC driver initialization functions (split from runtime)
    # Contains init/cleanup/reset/EEPROM/media setup - discarded after init
    SECTION
    FILE build/hardware_init.obj
    FILE build/3c509b_init.obj
    FILE build/3c515_init.obj
    FILE build/nic_init.obj

    # OVL_FINAL: Stages 10-14
    # DMA buffer init, TSR relocate, API install, IRQ enable, API activate
    # Final setup and optional features (diagnostics, routing, promiscuous mode)
    # Also contains init portions of split modules
    SECTION
    FILE build/pktops_init.obj
    FILE build/dmamap_init.obj
    FILE build/api_init.obj
    FILE build/dmabnd_init.obj
    FILE build/pci_shim_init.obj
    FILE build/hwchksm_init.obj
    FILE build/logging_init.obj
    FILE build/xms_core_init.obj
    FILE build/irqmit_init.obj
    FILE build/rxbatch_init.obj
    FILE build/txlazy_init.obj
    FILE build/pcimux_init.obj
    FILE build/dmatest.obj
    FILE build/dmasafe.obj
    FILE build/dmapol.obj
    FILE build/tsrmgr.obj
    FILE build/umbldr.obj
    FILE build/quiesce.obj
    FILE build/safestub.obj
    FILE build/smcpat.obj
    FILE build/routing.obj
    FILE build/statrt.obj
    FILE build/arp.obj
    FILE build/stats.obj
    FILE build/diag.obj
    FILE build/pcmmgr.obj
    FILE build/pcmsnap.obj
    FILE build/pcmpebe.obj
    FILE build/pcmssbe.obj
    FILE build/extapi.obj
    FILE build/unwind.obj
    FILE build/promisc.obj
    FILE build/bmtest.obj
    FILE build/smcserl.obj
    FILE build/cachemgt.obj
END

# Stub implementations for undefined symbols (LAST - so real implementations take precedence)
FILE build/linkstubs.obj
