# 3cpd.lnk - Watcom Linker Directives for Overlay System
# 3Com Packet Driver - 16-bit DOS Memory Optimization
# Last Updated: 2026-02-01 16:00:00 CET
# Phase 7: JIT copy-down + SMC pure-ASM TSR architecture
# Phase 6: Replaced 15 *_rt.obj with consolidated rt_stubs.obj
#
# This file defines the Watcom overlay system structure:
# - ROOT SEGMENT: Always resident (ISR-safe code, ~60-80 KB)
# - OVERLAY AREA: Init stages (loaded/discarded, ~50 KB peak)
#
# After initialization completes, the overlay area is freed via
# DOS INT 21h/4Ah, leaving only the ROOT segment resident as a TSR.

SYSTEM dos
NAME build/3cpd.exe

# Memory model library (large model for code+data > 64KB)
LIBRARY /Users/johnfabienke/Development/macos-open-watcom/open-watcom-v2/rel/lib286/dos/clibl.lib

# Overlay runtime library (provides __NOVLINIT__, __NOVLLDR__)
LIBRARY /Users/johnfabienke/Development/macos-open-watcom/open-watcom-v2/rel/lib286/dos/wovl.lib

# Linker options
OPTION map=build/3cpd.map
OPTION caseexact
OPTION stack=512

# Enable overlay system - Watcom dynamic overlay manager
OPTION DYNAMIC
OPTION AREA=64K

# ============================================================================
# ROOT SEGMENT - Always Resident (ISR-Safe Code)
# These files are NEVER overlaid - they must be available during interrupts
# ============================================================================

# TSR Loader (entry point)
FILE build/tsrldr.obj

# Core Packet API (INT 60h handler)
FILE build/pktapi.obj

# Interrupt Handlers (must be resident for ISR)
FILE build/nicirq.obj
FILE build/pcmisr.obj
FILE build/pciisr.obj

# Runtime Packet Operations
FILE build/pktops.obj
FILE build/pktcopy.obj
FILE build/flowrt.obj
FILE build/dirpio.obj

# TSR Support
FILE build/tsrcom.obj
FILE build/tsrwrap.obj

# Resident I/O
FILE build/pci_io.obj
FILE build/hwsmc.obj

# Resident ASM modules (ported from C for size reduction)
FILE build/dos_idle.obj
FILE build/irq_bind.obj
FILE build/rtcfg.obj

# Init Orchestrator (ROOT - calls overlay stages)
FILE build/init_main.obj

# ASM stub symbols for linking (bridges ASM/C symbol naming)
FILE build/linkasm.obj

# Hardware low-level ASM modules (packet I/O, config, coordination)
FILE build/hwpkt.obj
FILE build/hwcfg.obj
FILE build/hwcoord.obj

# Cache operations (CPU cache control for DMA coherency)
FILE build/cacheops.obj

# Hardware init (3C515 init for recovery - nicirq.asm calls init_3c515)
FILE build/hwinit.obj

# Hardware EEPROM operations (read_3c509b_eeprom, read_3c515_eeprom)
FILE build/hweep.obj

# Hardware DMA operations (dma_stall_engines, dma_unstall_engines)
FILE build/hwdma.obj

# DOS I/O (custom printf/file I/O via INT 21h - used by ROOT modules)
FILE build/dos_io.obj

# Phase 6: Consolidated runtime stubs (replaces 15 individual *_rt.obj files)
FILE build/rt_stubs.obj

# ============================================================================
# OVERLAY AREA - 6 Init Stages (Expanded structure for reduced ROOT size)
# ============================================================================
# The overlay manager automatically loads/unloads these sections.
# Each SECTION defines a separate overlay that shares the same memory area.
# Having more granular overlays reduces peak memory usage during init.
#
# Structure:
#   OVL_BOOT (stages 0-1): Entry validation, CPU detection (~8 KB)
#   OVL_PLATFORM (stages 2-3): Platform probe, logging init (~6 KB)
#   OVL_CONFIG (stages 4-5): Config parse, chipset detect (~10 KB)
#   OVL_DETECT (stages 6-8): VDS/DMA refine, memory, hardware detect (~15 KB)
#   OVL_NIC_INIT (stage 9): NIC driver initialization functions (~12 KB)
#   OVL_FINAL (stages 10-14): DMA buffers, TSR relocate, API install (~15 KB)

BEGIN
    # OVL_BOOT: Stages 0-1
    # Entry validation, CPU detection
    # First overlay to load - validates environment and detects CPU capabilities
    SECTION
    FILE build/main.obj
    FILE build/init.obj
    FILE build/entval.obj
    FILE build/loader/cpu_detect.obj
    FILE build/cpudet.obj

    # OVL_PLATFORM: Stages 2-3
    # Platform probe, logging initialization
    # Detects chipset, DMA capabilities, and sets up logging
    SECTION
    FILE build/pltprob.obj
    FILE build/loader/init_stubs.obj

    # OVL_CONFIG: Stages 4-5
    # Configuration parsing, chipset detection
    # Parses command line, config files, and identifies chipset features
    SECTION
    FILE build/config.obj
    FILE build/loader/patch_apply.obj
    FILE build/chipdet.obj
    FILE build/flowctl.obj

    # OVL_DETECT: Stages 6-8
    # VDS/DMA refine, memory init, hardware detection
    # Initializes VDS, DMA subsystem, memory pools, and detects NICs
    SECTION
    FILE build/hwdet.obj
    FILE build/hwbus.obj
    FILE build/vds.obj
    FILE build/vds_core.obj
    FILE build/vdssafe.obj
    FILE build/vdsmgr.obj
    FILE build/dmacap.obj
    FILE build/memory.obj
    FILE build/xmsdet.obj
    FILE build/bufaloc.obj
    FILE build/bufauto.obj
    FILE build/pci_bios.obj
    FILE build/3cpcidet.obj
    FILE build/pciintg.obj
    FILE build/pcishme.obj
    FILE build/pnp.obj
    FILE build/eeprom.obj
    # Vortex/Boomerang PCI NIC detection (moved from ROOT)
    FILE build/3cvortex.obj
    FILE build/3cboom.obj
    FILE build/pcipwr.obj

    # OVL_NIC_INIT: Stage 9
    # NIC driver initialization functions (split from runtime)
    # Contains init/cleanup/reset/EEPROM/media setup - discarded after init
    SECTION
    FILE build/hardware_init.obj
    FILE build/3c509b_init.obj
    FILE build/3c515_init.obj
    FILE build/nic_init.obj
    FILE build/pcirst.obj

    # OVL_FINAL: Stages 10-14
    # DMA buffer init, TSR relocate, API install, IRQ enable, API activate
    # Final setup and optional features (diagnostics, routing, promiscuous mode)
    # Also contains init portions of split modules and JIT engine
    SECTION
    # Phase 7: JIT copy-down engine (overlay, discarded after init)
    FILE build/mod_select.obj
    FILE build/jit_build.obj
    FILE build/jit_patch.obj
    FILE build/jit_reloc.obj
    FILE build/pktops_init.obj
    FILE build/dmamap_init.obj
    FILE build/api_init.obj
    FILE build/dmabnd_init.obj
    FILE build/pci_shim_init.obj
    FILE build/hwchksm_init.obj
    FILE build/logging_init.obj
    FILE build/xms_core_init.obj
    FILE build/irqmit_init.obj
    FILE build/rxbatch_init.obj
    FILE build/txlazy_init.obj
    FILE build/pcimux_init.obj
    FILE build/dmatest.obj
    FILE build/dmasafe.obj
    FILE build/dmapol.obj
    FILE build/tsrmgr.obj
    FILE build/umbldr.obj
    FILE build/quiesce.obj
    FILE build/safestub.obj
    FILE build/smcpat.obj
    FILE build/smcpat_c.obj
    FILE build/routing.obj
    FILE build/statrt.obj
    FILE build/arp.obj
    FILE build/stats.obj
    FILE build/diag.obj
    FILE build/pcmmgr.obj
    FILE build/pcmsnap.obj
    FILE build/pcmpebe.obj
    FILE build/pcmssbe.obj
    FILE build/extapi.obj
    FILE build/unwind.obj
    FILE build/promisc.obj
    FILE build/bmtest.obj
    FILE build/smcserl.obj
    FILE build/cachemgt.obj
END

# ============================================================================
# JIT MODULE OBJECTS - Templates for copy-down (ROOT, contain module headers)
# These are linked into the EXE but their hot sections are copied into the
# JIT-built TSR image at init time. Only needed modules are copied.
# ============================================================================
FILE build/mod_isr.obj
FILE build/mod_irq.obj
FILE build/mod_pktbuf.obj
FILE build/mod_data.obj
FILE build/mod_3c509b_rt.obj
FILE build/mod_3c515_rt.obj
FILE build/mod_vortex_rt.obj
FILE build/mod_boom_rt.obj
FILE build/mod_cyclone_rt.obj
FILE build/mod_tornado_rt.obj
FILE build/mod_pio.obj
FILE build/mod_dma_isa.obj
FILE build/mod_dma_busmaster.obj
FILE build/mod_dma_descring.obj
FILE build/mod_dma_bounce.obj
FILE build/mod_cache_none.obj
FILE build/mod_cache_wbinvd.obj
FILE build/mod_cache_clflush.obj
FILE build/mod_cache_snoop.obj
FILE build/mod_copy_8086.obj
FILE build/mod_copy_286.obj
FILE build/mod_copy_386.obj
FILE build/mod_copy_pent.obj
# Phase 9: Runtime C-to-ASM ported module templates
FILE build/mod_pcimux_rt.obj
FILE build/mod_xms_rt.obj
FILE build/mod_txlazy_rt.obj
FILE build/mod_hwchksm_rt.obj
FILE build/mod_irqmit_rt.obj
FILE build/mod_rxbatch_rt.obj
FILE build/mod_dmabnd_rt.obj
FILE build/mod_dmamap_rt.obj
FILE build/mod_pcishim_rt.obj
FILE build/mod_routing_rt.obj
FILE build/mod_api_rt.obj
FILE build/mod_pktops_rt.obj

# CRT replacement module (Phase 8 - two-stage loader support)
FILE build/tsr_crt.obj

# Stub implementations for undefined symbols (LAST - so real implementations take precedence)
FILE build/linkstubs.obj
